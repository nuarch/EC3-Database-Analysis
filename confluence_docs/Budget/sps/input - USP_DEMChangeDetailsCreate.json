{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "input",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "USP_DEMChangeDetailsCreate",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "USP_DEMChangeDetailsCreate",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to insert records into the "
        },
        {
          "type": "text",
          "text": "input.DEMChangeDetail",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table from a user-defined table type parameter "
        },
        {
          "type": "text",
          "text": "@details",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ". It processes each row of the input table, assigns a new "
        },
        {
          "type": "text",
          "text": "DEMChangeDetailEntityID",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ", and updates related records in the "
        },
        {
          "type": "text",
          "text": "input.DEMChange",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " and "
        },
        {
          "type": "text",
          "text": "budget.Scenario",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " tables. The procedure is used to manage and update demand change details, likely in an energy management or billing system."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including cursor operations, data insertion, and updates to related tables. The use of a cursor adds complexity, as it requires careful management of resources and can impact performance. The logic is straightforward but involves multiple database operations, which elevates its complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@details AS input.UDT_DEMChangeDetail READONLY",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A table-valued parameter that contains the details to be inserted into the "
                },
                {
                  "type": "text",
                  "text": "DEMChangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table. This parameter is read-only and is expected to be a structured collection of data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@actionBy AS VARCHAR(25) = 'SYSTEM'",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An optional parameter that defaults to 'SYSTEM'. It records who performed the action, used in the update of the "
                },
                {
                  "type": "text",
                  "text": "input.DEMChange",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table to track modifications."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure starts by declaring several local variables to store data from the input table and to manage the cursor."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine New Entity ID",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates the next "
                },
                {
                  "type": "text",
                  "text": "DEMChangeDetailEntityID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " by finding the maximum existing ID in the "
                },
                {
                  "type": "text",
                  "text": "DEMChangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table and adding one."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Setup and Iteration",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A cursor is declared and opened to iterate over each row in the "
                },
                {
                  "type": "text",
                  "text": "@details",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table. For each row:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The data is fetched into local variables."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "An "
                        },
                        {
                          "type": "text",
                          "text": "INSERT",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " operation is performed to add the row into the "
                        },
                        {
                          "type": "text",
                          "text": "DEMChangeDetail",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table with the new "
                        },
                        {
                          "type": "text",
                          "text": "DEMChangeDetailEntityID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Cleanup",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": After processing all rows, the cursor is closed and deallocated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Update Operations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The "
                        },
                        {
                          "type": "text",
                          "text": "input.DEMChange",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table is updated to set the "
                        },
                        {
                          "type": "text",
                          "text": "ModifiedDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "ModifiedBy",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " fields for the relevant "
                        },
                        {
                          "type": "text",
                          "text": "DEMChangeID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The "
                        },
                        {
                          "type": "text",
                          "text": "budget.Scenario",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table is updated to change the status to 'REQUIRERECALC' for scenarios associated with the "
                        },
                        {
                          "type": "text",
                          "text": "DEMChangeID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " that are currently 'CALCULATED'."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a cursor can lead to performance bottlenecks, especially with large datasets, as it processes rows one at a time. Consider using set-based operations if possible."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Entity ID Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The calculation of "
                },
                {
                  "type": "text",
                  "text": "DEMChangeDetailEntityID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " using "
                },
                {
                  "type": "text",
                  "text": "Max",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can be a point of contention in a highly concurrent environment, potentially leading to race conditions or performance issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The updates to "
                },
                {
                  "type": "text",
                  "text": "input.DEMChange",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "budget.Scenario",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " are straightforward but should be monitored for locking and blocking issues, especially if these tables are large or frequently accessed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The method of calculating the next "
                },
                {
                  "type": "text",
                  "text": "DEMChangeDetailEntityID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is susceptible to race conditions in a concurrent environment, potentially leading to duplicate IDs."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Overhead",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Cursors can be resource-intensive and may degrade performance if the input dataset is large. Consider refactoring to use set-based operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which means any runtime errors could leave the database in an inconsistent state. Implementing try-catch blocks and transaction management could mitigate this risk."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of this procedure may degrade due to the cursor and the sequential processing of rows."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [input].[USP_DEMChangeDetailsCreate]\n(\r\n\t@details AS input.UDT_DEMChangeDetail READONLY\r\n\t,@actionBy AS VARCHAR(25) = 'SYSTEM'\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\r\n\tDECLARE @DEMChangeDetailEntityID INT\r\n\tDECLARE @DEMChangeID INT  \r\n\tDECLARE @AgencyCode VARCHAR(6) \r\n\tDECLARE @DistinctAccountCount INT = 0\r\n\tDECLARE @BudgetGroupID INT \r\n\tDECLARE @BillingPeriod INT\r\n\tDECLARE @DemandUsage DECIMAL(18, 5) = 0\r\n\tDECLARE @EnergyUsage DECIMAL(18, 5) = 0\r\n\tDECLARE @EnergyUsagePeakPercentage [decimal](10, 5) = 0\r\n\tDECLARE @EnergyUsageReactivePower DECIMAL(18, 5) = 0\r\n\tDECLARE @StreetLightingFacilityPoints DECIMAL(18, 5) = 0\r\n\tDECLARE @Notes VARCHAR(200)\r\n\r\n\tSELECT @DEMChangeDetailEntityID = Max(DEMChangeDetailEntityID) + 1\r\n\tFROM   input.DEMChangeDetail\r\n\r\n\tDECLARE @detailCursor CURSOR; \r\n\tSET @detailCursor =  CURSOR FOR\r\n\tSELECT  DEMChangeID,\r\n\t\tAgencyCode,\r\n\t\tDistinctAccountCount,\r\n\t\tBudgetGroupID,\r\n\t\tBillingPeriod,\r\n\t\tDemandUsage,\r\n\t\tEnergyUsage,\r\n\t\tEnergyUsagePeakPercentage,\r\n\t\tEnergyUsageReactivePower,\r\n\t\tStreetLightingFacilityPoints,\r\n\t\tNotes\r\n\t FROM @details\r\n\r\n\t OPEN @detailCursor; \r\n\t FETCH next \r\n\t FROM  @detailCursor\r\n\t INTO @DEMChangeID,\r\n\t\t  @AgencyCode,\r\n\t\t  @DistinctAccountCount,\r\n\t\t  @BudgetGroupID,\r\n\t\t  @BillingPeriod,\r\n\t\t  @DemandUsage,\r\n\t\t  @EnergyUsage,\r\n\t\t  @EnergyUsagePeakPercentage,\r\n\t\t  @EnergyUsageReactivePower,\r\n\t\t  @StreetLightingFacilityPoints,\r\n\t\t  @Notes\r\n\r\n\tWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tINSERT INTO [input].[DEMChangeDetail]\r\n\t\t   ([DEMChangeID]\r\n\t\t   ,[AgencyCode]\r\n\t\t   ,[BudgetGroupID]\r\n\t\t   ,[BillingPeriod]\r\n\t\t   ,[DistinctAccountCount]\r\n\t\t   ,[DemandUsage]\r\n\t\t   ,[EnergyUsage]\r\n\t\t   ,[EnergyUsagePeakPercentage]\r\n\t\t   ,[EnergyUsageReactivePower]\r\n\t\t   ,[StreetLightingFacilityPoints]\r\n\t\t   ,[DEMChangeDetailEntityID]\r\n\t\t   ,[Notes])\r\n\t\tVALUES\r\n\t\t   (@DEMChangeID,\r\n\t\t\t@AgencyCode,\r\n\t\t\t@BudgetGroupID,\r\n\t\t\t@BillingPeriod,\r\n\t\t\t@DistinctAccountCount,\r\n\t\t\t@DemandUsage,\r\n\t\t\t@EnergyUsage,\r\n\t\t\t@EnergyUsagePeakPercentage,\r\n\t\t\t@EnergyUsageReactivePower,\r\n\t\t\t@StreetLightingFacilityPoints,\r\n\t\t\t@DEMChangeDetailEntityID,\r\n\t\t\t@Notes)\r\n\r\n\t\t FETCH NEXT \r\n\t\t FROM  @detailCursor\r\n\t\t INTO @DEMChangeID,\r\n\t\t\t  @AgencyCode,\r\n\t\t\t  @DistinctAccountCount,\r\n\t\t\t  @BudgetGroupID,\r\n\t\t\t  @BillingPeriod,\r\n\t\t\t  @DemandUsage,\r\n\t\t\t  @EnergyUsage,\r\n\t\t\t  @EnergyUsagePeakPercentage,\r\n\t\t\t  @EnergyUsageReactivePower,\r\n\t\t\t  @StreetLightingFacilityPoints,\r\n\t\t\t  @Notes\t  \r\n\tEND;\r\n\r\n\tCLOSE @detailCursor;\r\n\tDEALLOCATE @detailCursor;\r\n\r\n\tUPDATE input.DEMChange\r\n\tSET ModifiedDate=GETDATE(), ModifiedBy=@actionBy\r\n\tWHERE id=@DEMChangeID;\r\n\r\n\tUPDATE budget.Scenario\r\n\tSET [Status] = 'REQUIRERECALC'\r\n\tWHERE DEMChangeID=@DEMChangeID AND [Status] IN ('CALCULATED');\r\nEND;\r"
        }
      ]
    }
  ]
}