{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "budget",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Report_BaseBudgetStagingByAgency_Updated",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Report_BaseBudgetStagingByAgency_Updated",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report on the base budget staging by agency, specifically focusing on energy usage and costs. It aggregates and organizes budget data by agency and energy type, and it provides a detailed breakdown of energy usage and costs across different time periods and organizational levels. The procedure uses temporary tables to manage and manipulate data before producing the final datasets for reporting."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is high due to several factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple temporary tables and Common Table Expressions (CTEs) for data manipulation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs complex data aggregation and pivoting operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes hierarchical data processing and grouping by different organizational levels."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It generates multiple datasets for reporting purposes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is used to identify the user or recipient of the report. It be used for filtering or logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the agency code(s) for which the report is generated. It is used to filter the data to include only relevant agencies."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting "
                },
                {
                  "type": "text",
                  "text": "NOCOUNT ON",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to prevent the message indicating the number of rows affected by a SQL statement. It initializes several variables and temporary tables to store intermediate data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scenario and Fiscal Year Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It retrieves the current scenario ID and fiscal year from the "
                },
                {
                  "type": "text",
                  "text": "budget.Scenario",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Agency Division Preparation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It uses CTEs to construct a hierarchy of agencies based on their division levels."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It filters agencies using a function "
                        },
                        {
                          "type": "text",
                          "text": "billing.uftn_TableGetAllAgencyChildrenByAgencyCodeOEC",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to get all child agencies of the specified agency code."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It populates the "
                        },
                        {
                          "type": "text",
                          "text": "@AgencyDivision",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table with hierarchical agency data."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Base Budget Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It inserts aggregated budget data into the "
                        },
                        {
                          "type": "text",
                          "text": "@BaseBudgetDataGroupByAgency",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table, grouping by agency and energy type."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It calculates sums for energy usage, facility points, and various dollar amounts."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parent Agency Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It further aggregates data for parent agencies at different levels (Level 1 and Level 2) to provide a consolidated view."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Total Cost Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It calculates total costs for each agency and inserts this data into the temporary table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dataset Generation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It generates three datasets: a report title, budget by energy type, and budget by utility company and service class."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It uses pivot operations to transform monthly data into a tabular format for reporting."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Volume",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure handles potentially large datasets, which can impact performance. The use of temporary tables and CTEs may lead to increased memory and CPU usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the underlying tables, especially those involved in joins and aggregations, are properly indexed to optimize query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporary tables may lead to contention if the procedure is executed concurrently by multiple users."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the performance of the procedure may degrade, especially during aggregation and pivot operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete data processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the procedure is executed with appropriate permissions to prevent unauthorized data access."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in the source tables is accurate and consistent. Any discrepancies could affect the accuracy of the report."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity of the procedure may make it challenging to maintain and update, especially if business requirements change."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [budget].[usp_Report_BaseBudgetStagingByAgency_Updated]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX)\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\r\n\tDECLARE @AnnualOrMonthly AS CHAR(1) = 'M';\r\n\r\n\tDECLARE @BaseBudgetDataGroupByAgency TABLE(BudgetStage VARCHAR(100) NULL\r\n\t\t,PublishedBillingPeriod VARCHAR(6) NULL\r\n\t\t,BillingPeriod VARCHAR(6) NULL\r\n\t\t,AgencyCodeOEC VARCHAR(6) NULL\r\n\t\t,AgencyName VARCHAR(75) NULL\r\n\t\t,EnergyDeliveryType VARCHAR(3) NULL\r\n\t\t,BudgetGroupDEM INT NULL\r\n\t\t,BudgetGroupDEMName VARCHAR(75) NULL\r\n\t\t,GenericEnergyDeliveryType VARCHAR(24) NULL\r\n\t\t,GenericEnergyDeliveryTypeUnit VARCHAR(24) NULL\r\n\t\t,EnergyUsage DECIMAL(18,2) NULL\r\n\t\t,StreetLightingFacilityPoints INT NULL\r\n\t\t,FacilityPointDollars MONEY NULL\r\n\t\t,EnergyDollars MONEY NULL\r\n\t\t,DemandDollars MONEY NULL\r\n\t\t,AgencyDivisionSeqId INT NULL\r\n\t\t,AgencyOECL1 VARCHAR(6) NULL\r\n\t\t,AgencyOECL2 VARCHAR(6) NULL\r\n\t\t,AgencyOECL3 VARCHAR(6) NULL\r\n\t\t,AgencyLevel INT NULL);\r\n\r\n\tDECLARE @AgencyDivision TABLE(AgencyCodeOEC VARCHAR(6) NOT NULL PRIMARY KEY\r\n\t\t,parentAgencyCode VARCHAR(6) NULL\r\n\t\t,grandParantAgencyCode VARCHAR(6) NULL\r\n\t\t,agencyLevel INT NULL\r\n\t\t,AgencyOECL1 VARCHAR(6) NULL\r\n\t\t,AgencyOECL2 VARCHAR(6) NULL\r\n\t\t,AgencyOECL3 VARCHAR(6) NULL\r\n\t\t,AgencyDivisionHierarchy HIERARCHYID NULL\r\n\t\t,AgencyShortDesc VARCHAR(75) NULL\r\n\t\t,AgencyDivisionSeqId INT NULL\r\n\t\t,IsHidden CHAR(1) NULL);\r\n\r\n\tDECLARE @fy AS INT, @publishedBillingPeriod AS VARCHAR(7), @currentScenarioId AS INT;\r\n\t\r\n\tSELECT @currentScenarioId = ISNULL(MAX(ID),0), @fy = MAX(FY)\r\n\tFROM budget.Scenario WHERE IsCurrentBudget = 1;\r\n\r\n\tSELECT @publishedBillingPeriod = CAST(@fy-2 AS VARCHAR(4)) + '01';\r\n\t--=========================================================================\r\n\t-- 1 parepare agency division\r\n\t--=========================================================================\r\n\r\n    WITH agencyRaw AS (SELECT a.AgencyID\r\n\t\t\t,b.ParentAgencyID\r\n\t\t\t,CAST(b.AgencyDivisionHierarchy AS VARCHAR(100)) AS hierarchy\r\n\t\t\t,LEN(CAST(b.AgencyDivisionHierarchy AS VARCHAR(100)))-LEN(REPLACE(CAST(b.AgencyDivisionHierarchy AS VARCHAR(100)), '/','')) AS times\r\n\t\t\t,b.AgencyDivisionHierarchy.GetLevel() AS agencyLevel\r\n\t\tFROM Preload.Agency AS a\r\n\t\t\tINNER JOIN Preload.AgencyByFY AS b ON a.AgencyId = b.AgencyId\r\n\t\tWHERE b.FY = @fy)\r\n    ,agencyHierarchy AS (SELECT AgencyID, agencyLevel, ParentAgencyId, NULL AS GrandParentAgencyId FROM agencyRaw WHERE times IN (2, 3)\r\n\t\tUNION\r\n\t\tSELECT AgencyID, agencyLevel, ParentAgencyId, SUBSTRING(hierarchy,2, CHARINDEX('/',hierarchy, 2)-2) AS GrandParentAgencyId FROM agencyRaw WHERE times = 4)\r\n    ,filteredAgencies AS (SELECT AgencyCodeOEC FROM billing.uftn_TableGetAllAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress))\r\n\r\n    INSERT INTO @AgencyDivision\r\n        (AgencyCodeOEC\r\n        ,parentAgencyCode\r\n        ,grandParantAgencyCode\r\n        ,agencyLevel\r\n        ,AgencyOECL1\r\n        ,AgencyOECL2\r\n        ,AgencyOECL3\r\n        ,AgencyDivisionHierarchy\r\n\t\t,AgencyShortDesc\r\n\t\t,AgencyDivisionSeqId\r\n\t\t,IsHidden)\r\n    SELECT DISTINCT child.AgencyCodeOEC\r\n\t\t,parent.AgencyCodeOEC AS parentAgencyCode\r\n\t\t,grandParent.AgencyCodeOEC AS grandParantAgencyCode\r\n\t\t,child.AgencyDivisionHierarchy.GetLevel() AS agencyLevel\r\n\t\t,IIF(a.agencyLevel = 3, grandParent.AgencyCodeOEC, IIF(a.agencyLevel = 2, parent.AgencyCodeOEC, child.AgencyCodeOEC)) AS AgencyOECL1\r\n\t\t,IIF(a.agencyLevel = 3, parent.AgencyCodeOEC, IIF(a.agencyLevel = 2, child.AgencyCodeOEC, '000000')) AS AgencyOECL2\r\n\t\t,IIF(a.agencyLevel = 3, child.AgencyCodeOEC, '000000') AS AgencyOECL3\r\n\t\t,child.AgencyDivisionHierarchy\r\n\t\t,child.AgencyName\r\n\t\t,a.agencyId AS AgencyDivisionSeqId\r\n\t\t,'N' AS IsHidden\r\n    FROM agencyHierarchy AS a\r\n        INNER JOIN Preload.vwAgencies AS child ON child.FY = @fy AND a.AgencyId = child.AgencyId\r\n        INNER JOIN filteredAgencies AS f ON child.AgencyCodeOEC = f.AgencyCodeOEC\r\n        LEFT JOIN Preload.Agency AS parent ON a.ParentAgencyId = parent.AgencyId\r\n        LEFT JOIN Preload.Agency AS grandParent ON a.GrandParentAgencyId = grandParent.AgencyId;\r\n\r\n    --=========================================================================\r\n    -- 2 Add base budget data\r\n    --=========================================================================\r\n    INSERT INTO @BaseBudgetDataGroupByAgency\r\n        (BudgetStage\r\n        ,PublishedBillingPeriod\r\n        ,BillingPeriod\r\n        ,AgencyCodeOEC\r\n        ,AgencyName\r\n        ,EnergyDeliveryType\r\n        ,BudgetGroupDEM\r\n        ,BudgetGroupDEMName\r\n        ,GenericEnergyDeliveryType\r\n        ,GenericEnergyDeliveryTypeUnit\r\n        ,EnergyUsage\r\n        ,StreetLightingFacilityPoints\r\n        ,FacilityPointDollars\r\n        ,EnergyDollars\r\n        ,DemandDollars\r\n        ,AgencyDivisionSeqId\r\n        ,AgencyOECL1\r\n\t\t,AgencyOECL2\r\n\t\t,AgencyOECL3\r\n\t\t,AgencyLevel)\r\n    SELECT B.BudgetStage\r\n        ,@publishedBillingPeriod AS PublishedBillingPeriod\r\n        ,CASE WHEN @AnnualOrMonthly = 'M' THEN MAX(B.BillingPeriod) ELSE '' END\r\n        ,B.AgencyCodeOEC\r\n        ,B.AgencyName\r\n        ,B.EnergyDeliveryType\r\n        ,B.BudgetGroupDEM\r\n        ,B.BudgetGroupDEMName\r\n        ,B.GenericEnergyDeliveryType\r\n        ,B.GenericEnergyDeliveryTypeUnit\r\n        ,SUM(B.EnergyUsage)\r\n        ,SUM(B.StreetLightingFacilityPoints)\r\n        ,SUM(B.FacilityPointDollars)\r\n        ,SUM(B.EnergyDollars)\r\n        ,SUM(B.DemandDollars)\r\n        ,A.AgencyDivisionSeqId\r\n        ,A.AgencyOECL1\r\n\t\t,A.AgencyOECL2\r\n\t\t,A.AgencyOECL3\r\n\t\t,A.agencyLevel\r\n    FROM budget.vwBaseBudgetByAgencySummaryByAgencyEnergyType AS B\r\n        INNER JOIN @AgencyDivision AS A ON B.AgencyCodeOEC = A.AgencyCodeOEC\r\n    WHERE B.scenarioid = @currentScenarioId\r\n    GROUP BY B.BudgetStage\r\n\t\t,CASE WHEN @AnnualOrMonthly = 'M' THEN B.BillingPeriod END\r\n\t\t,B.AgencyCodeOEC\r\n\t\t,B.AgencyName\r\n\t\t,B.EnergyDeliveryType\r\n\t\t,B.BudgetGroupDEM\r\n\t\t,B.BudgetGroupDEMName\r\n\t\t,B.GenericEnergyDeliveryType\r\n\t\t,B.GenericEnergyDeliveryTypeUnit\r\n\t\t,A.AgencyDivisionSeqId\r\n\t\t,A.AgencyOECL1\r\n\t\t,A.AgencyOECL2\r\n\t\t,A.AgencyOECL3\r\n\t\t,A.agencyLevel;\r\n\r\n    --=========================================================================\r\n    -- 3 group data for parent agencies\r\n    --=========================================================================\r\n    -- level 1 data\r\n    INSERT INTO @BaseBudgetDataGroupByAgency\r\n        (BudgetStage\r\n        ,PublishedBillingPeriod\r\n        ,BillingPeriod\r\n        ,AgencyCodeOEC\r\n        ,AgencyName\r\n        ,EnergyDeliveryType\r\n        ,BudgetGroupDEM\r\n        ,BudgetGroupDEMName\r\n        ,GenericEnergyDeliveryType\r\n        ,GenericEnergyDeliveryTypeUnit\r\n        ,EnergyUsage\r\n        ,StreetLightingFacilityPoints\r\n        ,FacilityPointDollars\r\n        ,EnergyDollars\r\n        ,DemandDollars\r\n        ,AgencyDivisionSeqId\r\n        ,AgencyOECL1\r\n\t\t,AgencyOECL2\r\n\t\t,AgencyOECL3\r\n\t\t,AgencyLevel)\r\n    SELECT B.BudgetStage\r\n        ,B.PublishedBillingPeriod\r\n        ,B.BillingPeriod\r\n        ,B.AgencyOECL1\r\n        ,MAX(A.AgencyShortDesc)\r\n        ,B.EnergyDeliveryType\r\n        ,B.BudgetGroupDEM\r\n        ,B.BudgetGroupDEMName\r\n        ,B.GenericEnergyDeliveryType\r\n        ,B.GenericEnergyDeliveryTypeUnit\r\n        ,SUM(B.EnergyUsage)\r\n        ,SUM(B.StreetLightingFacilityPoints)\r\n        ,SUM(B.FacilityPointDollars)\r\n        ,SUM(B.EnergyDollars)\r\n        ,SUM(B.DemandDollars)\r\n        ,MAX(A.AgencyDivisionSeqId)\r\n        ,B.AgencyOECL1\r\n\t\t,'000000' AS AgencyOECL2\r\n\t\t,'000000' AS AgencyOECL3\r\n\t\t,MAX(A.agencyLevel)\r\n    FROM @BaseBudgetDataGroupByAgency AS B\r\n\t    INNER JOIN @AgencyDivision AS A ON B.AgencyOECL1 = A.AgencyCodeOEC -- join for Level 1 data\r\n    WHERE B.AgencyCodeOEC <> B.AgencyOECL1\r\n\t      AND B.AgencyOECL1 <> '000000'\r\n    GROUP BY B.BudgetStage\r\n\t\t,B.AgencyOECL1\r\n\t\t,B.PublishedBillingPeriod\r\n\t\t,B.BillingPeriod\r\n\t\t,B.EnergyDeliveryType\r\n        ,B.BudgetGroupDEM\r\n        ,B.BudgetGroupDEMName\r\n        ,B.GenericEnergyDeliveryType\r\n        ,B.GenericEnergyDeliveryTypeUnit\r\n\r\n    -- level 2 data\r\n    INSERT INTO @BaseBudgetDataGroupByAgency\r\n        (BudgetStage\r\n        ,PublishedBillingPeriod\r\n        ,BillingPeriod\r\n        ,AgencyCodeOEC\r\n        ,AgencyName\r\n        ,EnergyDeliveryType\r\n        ,BudgetGroupDEM\r\n        ,BudgetGroupDEMName\r\n        ,GenericEnergyDeliveryType\r\n        ,GenericEnergyDeliveryTypeUnit\r\n        ,EnergyUsage\r\n        ,StreetLightingFacilityPoints\r\n        ,FacilityPointDollars\r\n        ,EnergyDollars\r\n        ,DemandDollars\r\n        ,AgencyDivisionSeqId\r\n        ,AgencyOECL1\r\n\t\t,AgencyOECL2\r\n\t\t,AgencyOECL3\r\n\t\t,AgencyLevel)\r\n    SELECT B.BudgetStage\r\n        ,B.PublishedBillingPeriod\r\n        ,B.BillingPeriod\r\n        ,B.AgencyOECL2\r\n        ,MAX(A.AgencyShortDesc)\r\n        ,B.EnergyDeliveryType\r\n        ,B.BudgetGroupDEM\r\n        ,B.BudgetGroupDEMName\r\n        ,B.GenericEnergyDeliveryType\r\n        ,B.GenericEnergyDeliveryTypeUnit\r\n        ,SUM(B.EnergyUsage)\r\n        ,SUM(B.StreetLightingFacilityPoints)\r\n        ,SUM(B.FacilityPointDollars)\r\n        ,SUM(B.EnergyDollars)\r\n        ,SUM(B.DemandDollars)\r\n        ,MAX(A.AgencyDivisionSeqId)\r\n        ,B.AgencyOECL1\r\n\t\t,B.AgencyOECL2\r\n\t\t,'000000' AS AgencyOECL3\r\n\t\t,MAX(A.agencyLevel)\r\n    FROM @BaseBudgetDataGroupByAgency AS B\r\n\t    INNER JOIN @AgencyDivision AS A ON B.AgencyOECL2 = A.AgencyCodeOEC -- join for Level 1 data\r\n    WHERE B.AgencyCodeOEC <> B.AgencyOECL2\r\n\t\tAND B.AgencyOECL2 <> '000000'\r\n    GROUP BY B.BudgetStage\r\n\t\t,B.AgencyOECL1\r\n\t\t,B.AgencyOECL2\r\n\t\t,B.PublishedBillingPeriod\r\n\t\t,B.BillingPeriod\r\n\t\t,B.EnergyDeliveryType\r\n        ,B.BudgetGroupDEM\r\n        ,B.BudgetGroupDEMName\r\n        ,B.GenericEnergyDeliveryType\r\n        ,B.GenericEnergyDeliveryTypeUnit;\r\n\r\n    --=========================================================================\r\n    -- 4 Group total cost\r\n    --=========================================================================\r\n    INSERT INTO @BaseBudgetDataGroupByAgency\r\n        (BudgetStage\r\n        ,PublishedBillingPeriod\r\n        ,BillingPeriod\r\n        ,AgencyCodeOEC\r\n        ,AgencyName\r\n        ,EnergyDeliveryType\r\n        ,BudgetGroupDEM\r\n        ,BudgetGroupDEMName\r\n        ,GenericEnergyDeliveryType\r\n        ,GenericEnergyDeliveryTypeUnit\r\n        ,EnergyUsage\r\n        ,StreetLightingFacilityPoints\r\n        ,FacilityPointDollars\r\n        ,EnergyDollars\r\n        ,DemandDollars\r\n        ,AgencyDivisionSeqId\r\n        ,AgencyOECL1\r\n\t\t,AgencyOECL2\r\n\t\t,AgencyOECL3\r\n\t\t,AgencyLevel)\r\n    SELECT B.BudgetStage\r\n        ,B.PublishedBillingPeriod\r\n        ,B.BillingPeriod\r\n        ,B.AgencyCodeOEC\r\n        ,MAX(B.AgencyName)\r\n        ,'N/A'\r\n        ,0\r\n        ,'N/A'\r\n        ,'N/A'\r\n        ,'Total Cost'\r\n        ,SUM(B.EnergyUsage)\r\n        ,SUM(B.StreetLightingFacilityPoints)\r\n        ,SUM(B.FacilityPointDollars)\r\n        ,SUM(B.EnergyDollars)\r\n        ,SUM(B.DemandDollars)\r\n        ,MAX(B.AgencyDivisionSeqId)\r\n        ,MAX(B.AgencyOECL1)\r\n\t\t,MAX(B.AgencyOECL2)\r\n\t\t,MAX(B.AgencyOECL3)\r\n\t\t,MAX(B.agencyLevel)\r\n    FROM @BaseBudgetDataGroupByAgency AS B\r\n    WHERE B.GenericEnergyDeliveryTypeUnit = 'Cost'\r\n    GROUP BY B.BudgetStage\r\n\t\t,B.AgencyCodeOEC\r\n\t\t,B.PublishedBillingPeriod\r\n\t\t,B.BillingPeriod;\r\n\r\n\t-- DATASETS\r\n\t-- dataset1\r\n\tSELECT 'FY' + SUBSTRING(CAST(@fy AS VARCHAR(4)),3,2)+' Heat, Light and Power Budget' AS reportTitle;\r\n\t--   maybe add billing period to the title\r\n\r\n\t-- dataset2 BudgetByEnergyType\r\n\tSELECT ds1.AgencyName\r\n\t\t,ds1.GenericEnergyDeliveryType AS EnergyType\r\n\t\t,ds1.GenericEnergyDeliveryTypeUnit AS [Type]\r\n\t\t,ISNULL(ds1.July,0) AS July\r\n\t\t,ISNULL(ds1.August,0) AS August\r\n\t\t,ISNULL(ds1.September,0) AS September\r\n\t\t,ISNULL(ds1.October,0) AS October\r\n\t\t,ISNULL(ds1.November,0) AS November\r\n\t\t,ISNULL(ds1.December,0) AS December\r\n\t\t,ISNULL(ds1.January,0) AS January\r\n\t\t,ISNULL(ds1.February,0) AS February\r\n\t\t,ISNULL(ds1.March,0) AS March\r\n\t\t,ISNULL(ds1.April,0) AS April\r\n\t\t,ISNULL(ds1.May,0) AS May\r\n\t\t,ISNULL(ds1.June,0) AS June\r\n\t\t,(ISNULL(ds1.July,0)\r\n\t\t\t+ISNULL(ds1.August,0)\r\n\t\t\t+ISNULL(ds1.September,0)\r\n\t\t\t+ISNULL(ds1.October,0)\r\n\t\t\t+ISNULL(ds1.November,0)\r\n\t\t\t+ISNULL(ds1.December,0)\r\n\t\t\t+ISNULL(ds1.January,0)\r\n\t\t\t+ISNULL(ds1.February,0)\r\n\t\t\t+ISNULL(ds1.March,0)\r\n\t\t\t+ISNULL(ds1.April,0)\r\n\t\t\t+ISNULL(ds1.May,0)\r\n\t\t\t+ISNULL(ds1.June,0)) AS Total\r\n\tFROM (SELECT * FROM (SELECT B.PublishedBillingPeriod\r\n\t\t\t,CASE SUBSTRING(B.BillingPeriod,5,2)\r\n\t\t\t\tWHEN 01 THEN 'January'\r\n\t\t\t\tWHEN 02 THEN 'February'\r\n\t\t\t\tWHEN 03 THEN 'March'\r\n\t\t\t\tWHEN 04 THEN 'April'\r\n\t\t\t\tWHEN 05 THEN 'May'\r\n\t\t\t\tWHEN 06 THEN 'June'\r\n\t\t\t\tWHEN 07 THEN 'July'\r\n\t\t\t\tWHEN 08 THEN 'August'\r\n\t\t\t\tWHEN 09 THEN 'September'\r\n\t\t\t\tWHEN 10 THEN 'October'\r\n\t\t\t\tWHEN 11 THEN 'November'\r\n\t\t\t\tWHEN 12 THEN 'December'\r\n\t\t\tEND MonthText\r\n\t\t\t,B.AgencyCodeOEC +' - '+AgencyName AgencyName\r\n\t\t\t,B.GenericEnergyDeliveryType\r\n\t\t\t,B.GenericEnergyDeliveryTypeUnit\r\n\t\t\t,SUM(B.EnergyUsage) AS EnergyUsage\r\n\t\t\t,B.AgencyDivisionSeqId\r\n\t\t\t,B.AgencyOECL1\r\n\t\tFROM @BaseBudgetDataGroupByAgency AS B\r\n\t\tGROUP BY B.BudgetStage\r\n\t\t\t,B.PublishedBillingPeriod\r\n\t\t\t,B.BillingPeriod\r\n\t\t\t,B.AgencyCodeOEC\r\n\t\t\t,B.AgencyName\r\n\t\t\t,B.GenericEnergyDeliveryType\r\n\t\t\t,B.GenericEnergyDeliveryTypeUnit\r\n\t\t\t,B.AgencyDivisionSeqId\r\n\t\t\t,B.AgencyOECL1\r\n\t\t\t,B.AgencyOECL2\r\n\t\t\t,B.AgencyOECL3\r\n\t\t\t,B.AgencyLevel\r\n\t\t\t,B.EnergyDeliveryType) AS datatable\r\n\t\t\tPIVOT (SUM(EnergyUsage) FOR MonthText IN ([July],[August],[September],[October],[November],[December],[January],[February],[March],[April],[May],[June])) AS pivottable\r\n\t\t) AS ds1\r\n\tORDER BY ds1.AgencyName, [Type];\r\n\r\n\t----dataset3 BudgetByUtilityCompany&ServiceClass\r\n\tSELECT ds2.AgencyName\r\n\t\t,ds2.GenericEnergyDeliveryType AS EnergyType\r\n\t\t,ds2.BudgetGroupDEMName AS UtilityAndServiceType\r\n\t\t,ds2.GenericEnergyDeliveryTypeUnit AS [Type]\r\n\t\t,ISNULL(ds2.July,0) AS July\r\n\t\t,ISNULL(ds2.August\t,0) AS August\r\n\t\t,ISNULL(ds2.September,0) AS September\r\n\t\t,ISNULL(ds2.October,0) AS October\r\n\t\t,ISNULL(ds2.November,0) AS November\r\n\t\t,ISNULL(ds2.December,0) AS December\r\n\t\t,ISNULL(ds2.January,0) AS January\r\n\t\t,ISNULL(ds2.February,0) AS February\r\n\t\t,ISNULL(ds2.March,0) AS March\r\n\t\t,ISNULL(ds2.April,0) AS April\r\n\t\t,ISNULL(ds2.May,0) AS May\r\n\t\t,ISNULL(ds2.June,0) AS June\r\n\t\t,(ISNULL(ds2.July,0)\r\n\t\t\t+ISNULL(ds2.August,0)\r\n\t\t\t+ISNULL(ds2.September,0)\r\n\t\t\t+ISNULL(ds2.October,0)\r\n\t\t\t+ISNULL(ds2.November,0)\r\n\t\t\t+ISNULL(ds2.December,0)\r\n\t\t\t+ISNULL(ds2.January,0)\r\n\t\t\t+ISNULL(ds2.February,0)\r\n\t\t\t+ISNULL(ds2.March,0)\r\n\t\t\t+ISNULL(ds2.April,0)\r\n\t\t\t+ISNULL(ds2.May,0)\r\n\t\t\t+ISNULL(ds2.June,0)) AS Total\r\n\tFROM (SELECT * FROM (SELECT PublishedBillingPeriod\r\n\t\t\t,CASE SUBSTRING(B.BillingPeriod,5,2)\r\n\t\t\t\tWHEN 01 THEN 'January'\r\n\t\t\t\tWHEN 02 THEN 'February'\r\n\t\t\t\tWHEN 03 THEN 'March'\r\n\t\t\t\tWHEN 04 THEN 'April'\r\n\t\t\t\tWHEN 05 THEN 'May'\r\n\t\t\t\tWHEN 06 THEN 'June'\r\n\t\t\t\tWHEN 07 THEN 'July'\r\n\t\t\t\tWHEN 08 THEN 'August'\r\n\t\t\t\tWHEN 09 THEN 'September'\r\n\t\t\t\tWHEN 10 THEN 'October'\r\n\t\t\t\tWHEN 11 THEN 'November'\r\n\t\t\t\tWHEN 12 THEN 'December'\r\n\t\t\tEND MonthText\r\n\t\t\t,B.AgencyCodeOEC +' - '+ B.AgencyName AS AgencyName\r\n\t\t\t,B.GenericEnergyDeliveryType\r\n\t\t\t,B.GenericEnergyDeliveryTypeUnit\r\n\t\t\t,B.BudgetGroupDEM\r\n\t\t\t,B.BudgetGroupDEMName\r\n\t\t\t,SUM(EnergyUsage) AS EnergyUsage\r\n\t\t\t,B.AgencyDivisionSeqId\r\n\t\t\t,B.AgencyOECL1\r\n\t\t\t,B.EnergyDeliveryType AS EnergyType\r\n\t\tFROM @BaseBudgetDataGroupByAgency AS B\r\n\t\tGROUP BY B.BudgetStage\r\n\t\t\t,B.PublishedBillingPeriod\r\n\t\t\t,B.BillingPeriod\r\n\t\t\t,B.AgencyCodeOEC\r\n\t\t\t,B.AgencyName\r\n\t\t\t,B.GenericEnergyDeliveryType\r\n\t\t\t,B.GenericEnergyDeliveryTypeUnit\r\n\t\t\t,B.BudgetGroupDEM\r\n\t\t\t,B.BudgetGroupDEMName\r\n\t\t\t,B.AgencyDivisionSeqId\r\n\t\t\t,B.AgencyOECL1\r\n\t\t\t,B.AgencyOECL2\r\n\t\t\t,B.AgencyOECL3\r\n\t\t\t,B.AgencyLevel\r\n\t\t\t,B.EnergyDeliveryType) AS datatable\r\n\t\t\tPIVOT (SUM(EnergyUsage) FOR MonthText IN ([July],[August],[September],[October],[November],[December],[January],[February],[March],[April],[May],[June])) AS pivottable\r\n\t\t) AS ds2\r\n\tORDER BY ds2.AgencyOECL1, [Type], ds2.BudgetGroupDEMName;\r\nEND;\r"
        }
      ]
    }
  ]
}