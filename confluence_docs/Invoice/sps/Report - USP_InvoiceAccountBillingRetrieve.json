{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "USP_InvoiceAccountBillingRetrieve",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "USP_InvoiceAccountBillingRetrieve",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve invoice account billing details from a SQL Server database. It accepts various parameters to filter the data and returns billing information based on the specified invoice ID or invoice number. The procedure also logs the operation details and handles exceptions by capturing error messages."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this stored procedure is medium. It involves conditional logic, dynamic SQL-like behavior with XML path, error handling, and logging mechanisms. The use of a common table expression (CTE) and conditional logic for different invoice types adds to its complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@invoiceId AS INT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; specifies the invoice ID to filter the results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@invoiceNumber AS VARCHAR(25) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; specifies the invoice number to filter the results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@correlationId AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; used for logging to correlate logs across systems."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@machineName AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; specifies the machine name for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@processName AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; specifies the process name for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@domain AS VARCHAR(25) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; specifies the domain for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@username AS VARCHAR(25) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; specifies the username for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@userId AS INT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional; specifies the user ID for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@exceptionDetails AS VARCHAR(MAX) = NULL OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Output; captures any exception details that occur during execution."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization and Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Sets default values for parameters using "
                        },
                        {
                          "type": "text",
                          "text": "NULLIF",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "ISNULL",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Generates a new correlation ID if not provided."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Validates that either "
                        },
                        {
                          "type": "text",
                          "text": "@invoiceId",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " or "
                        },
                        {
                          "type": "text",
                          "text": "@invoiceNumber",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is provided; raises an error if both are missing."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Main Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Determines if the invoice is a split fiscal year invoice using the function "
                        },
                        {
                          "type": "text",
                          "text": "Billing.UDF_IsSplitFYInvoice",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If not a split fiscal year invoice, retrieves data directly from "
                        },
                        {
                          "type": "text",
                          "text": "Invoice.vwInvoiceAccountBillings",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If it is a split fiscal year invoice, constructs a CTE to handle complex contract number concatenation and retrieves data accordingly."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses a "
                        },
                        {
                          "type": "text",
                          "text": "TRY...CATCH",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " block to handle exceptions."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Captures error messages and sets logging parameters for failed operations."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Logs the operation details using "
                        },
                        {
                          "type": "text",
                          "text": "dbo.USP_AppLogCreate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", including correlation ID, machine name, process name, action, severity, message, and elapsed time."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Uses "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which can improve performance by allowing dirty reads but may lead to inconsistent data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conditional Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of conditional logic and CTEs can impact performance, especially if the underlying views or functions are complex or involve large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Performance depends on the indexing of columns used in the "
                },
                {
                  "type": "text",
                  "text": "WHERE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " clause, such as "
                },
                {
                  "type": "text",
                  "text": "InvoiceID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "InvoiceNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Consistency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to reading uncommitted changes, resulting in potential data inconsistencies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While exceptions are caught, the procedure does not re-throw them, which might hide issues from the calling application."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Defaults",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Defaulting "
                },
                {
                  "type": "text",
                  "text": "@userId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to 0 and generating a new "
                },
                {
                  "type": "text",
                  "text": "@correlationId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " might lead to misleading logs if not properly managed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complexity in Contract Number Concatenation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of XML path for concatenating contract numbers can be complex and may not handle all edge cases, such as special characters."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure's performance may degrade with large datasets or complex views, especially if not properly indexed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[USP_InvoiceAccountBillingRetrieve]\n(\r\n\t@invoiceId AS INT = NULL\r\n\t,@invoiceNumber AS VARCHAR(25) = NULL\r\n\t,@correlationId AS VARCHAR(128) = NULL\r\n\t,@machineName AS VARCHAR(128) = NULL\r\n\t,@processName AS VARCHAR(128) = NULL\r\n\t,@domain AS VARCHAR(25) = NULL\r\n\t,@username AS VARCHAR(25) = NULL\r\n\t,@userId AS INT = NULL\r\n\t,@exceptionDetails AS VARCHAR(MAX) = NULL OUTPUT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tSELECT @invoiceId = NULLIF(@invoiceId, 0), @invoiceNumber = NULLIF(@invoiceNumber, ''), @userId = ISNULL(@userId, 0)\r\n\t\t,@correlationId = ISNULL(@correlationId, CONVERT(VARCHAR(128), NEWID())), @machineName = COALESCE(@machineName, @@SERVERNAME, 'NA')\r\n\t\t,@processName = COALESCE(@processName, QUOTENAME(OBJECT_SCHEMA_NAME(@@PROCID)) + '.' + QUOTENAME(OBJECT_NAME(@@PROCID)), 'NA');\r\n\r\n\tIF (ISNULL(@invoiceId, 0) <= 0 AND ISNULL(@invoiceNumber, '') = '')\r\n\tBEGIN\r\n\t    RAISERROR (N'Either the invoice identifier or the invoice number must be specified', 16, 1);\r\n\tEND;\r\n\r\n\tDECLARE @action AS VARCHAR(25) = 'RETRIEVE', @severity AS VARCHAR(25) = 'INFO'\r\n\t\t,@message AS VARCHAR(255) = 'Reports - Retrieved invoice accounts / billings', @messageDetails AS VARCHAR(MAX)\r\n\t\t,@startTime AS DATETIME = GETDATE(), @elapsedTime AS INT, @sendEmail AS BIT = 0;\r\n\t\r\n\tSELECT @messageDetails = CONVERT(VARCHAR(MAX), (SELECT @invoiceId AS INVID, @invoiceNumber AS INVNUM FOR XML PATH('INPUTS')));\r\n\t\r\n\tBEGIN TRY\r\n\t\tDECLARE @invoiceIsSplitFY AS BIT = Billing.UDF_IsSplitFYInvoice(@invoiceId);\r\n\r\n\t\tIF (@invoiceIsSplitFY = 0)\r\n\t\tBEGIN\r\n\t\t\tSELECT InvoiceBillingID\r\n\t\t\t\t,InvoiceGroupContractID\r\n\t\t\t\t,InvoiceID\r\n\t\t\t\t,InvoiceNumber\r\n\t\t\t\t,GroupID\r\n\t\t\t\t,GroupName\r\n\t\t\t\t,ContractID\r\n\t\t\t\t,ContractNumber\r\n\t\t\t\t,FiscalYear\r\n\t\t\t\t,AccountID\r\n\t\t\t\t,Billing.MaskAccountNumber(CASE WHEN ProviderID = 2 AND LEN(AccountNumber) = 15 AND AccountNumber LIKE '%0000' THEN SUBSTRING(AccountNumber, 2, 10)\r\n\t\t\t\t\tWHEN ProviderID = 7 AND LEN(AccountNumber) = 15 AND AccountNumber LIKE '%0000' THEN SUBSTRING(AccountNumber, 0, 12)\r\n\t\t\t\t\tWHEN ProviderID = 9 AND LEN(AccountNumber) = 15 AND AccountNumber LIKE '%0000' THEN SUBSTRING(AccountNumber, 0, 12)\r\n\t\t\t\t\tELSE AccountNumber END, ProviderID) AS AccountNumber\r\n\t\t\t\t,FormattedAccountNumber\r\n\t\t\t\t,BillingID\r\n\t\t\t\t,BillingPeriod\r\n\t\t\t\t,BillingPeriodDays\r\n\t\t\t\t,BillingPeriodDaysPriorFY\r\n\t\t\t\t,BillingPeriodDaysCurrentFY\r\n\t\t\t\t,IsEstimated\r\n\t\t\t\t,IsManualEntry\r\n\t\t\t\t,AmountBilled\r\n\t\t\t\t,AmountPaid\r\n\t\t\t\t,AmountPaidPriorFY\r\n\t\t\t\t,AmountPaidCurrentFY\r\n\t\t\t\t,EnergyUsage\r\n\t\t\t\t,EnergyUsagePriorFY\r\n\t\t\t\t,EnergyUsageCurrentFY\r\n\t\t\t\t,DemandUsage\r\n\t\t\t\t,DemandUsagePriorFY\r\n\t\t\t\t,DemandUsageCurrentFY\r\n\t\t\t\t,DateBilled\r\n\t\t\t\t,DateDue\r\n\t\t\t\t,FromDate\r\n\t\t\t\t,ToDate\r\n\t\t\t\t,SplitFY\r\n\t\t\t\t,CreatedDate\r\n\t\t\t\t,CreatedBy\r\n\t\t\t\t,ModifiedDate\r\n\t\t\t\t,ModifiedBy\r\n\t\t\t\t,Active\r\n\t\t\tFROM Invoice.vwInvoiceAccountBillings\r\n\t\t\tWHERE InvoiceID\t= ISNULL(@invoiceId, InvoiceID)\r\n\t\t\t\tAND InvoiceNumber = ISNULL(@invoiceNumber, InvoiceNumber)\r\n\t\t\tORDER BY GroupName ASC, ContractNumber ASC, FiscalYear DESC, AccountNumber ASC;\r\n\t\tEND;\r\n\t\tELSE\r\n\t\tBEGIN\r\n\t\t\tWITH fyTbl AS (SELECT GroupID, ContractNumber = STUFF((SELECT DISTINCT ' & ' + ContractNumber\r\n\t\t\t\t\tFROM Invoice.vwInvoiceGroupContracts AS b\r\n\t\t\t\t\tWHERE a.InvoiceID = b.InvoiceID AND b.GroupID = a.GroupID\r\n\t\t\t\t\tFOR XML PATH('')), 1, 7, '')\r\n\t\t\t\tFROM Invoice.vwInvoiceGroupContracts AS a\r\n\t\t\t\tWHERE InvoiceID\t= ISNULL(@invoiceId, a.InvoiceID)\r\n\t\t\t\t\tAND InvoiceNumber = ISNULL(@invoiceNumber, a.InvoiceNumber)\r\n\t\t\t\tGROUP BY InvoiceID, GroupID)\r\n\t\t\tSELECT IAB.InvoiceBillingID\r\n\t\t\t\t,IAB.InvoiceGroupContractID\r\n\t\t\t\t,IAB.InvoiceID\r\n\t\t\t\t,IAB.InvoiceNumber\r\n\t\t\t\t,IAB.GroupID\r\n\t\t\t\t,IAB.GroupName\r\n\t\t\t\t,IAB.ContractID, REPLACE(fyTbl.ContractNumber, '&amp;', '&') AS ContractNumber\r\n\t\t\t\t,IAB.FiscalYear\r\n\t\t\t\t,IAB.AccountID\r\n\t\t\t\t,Billing.MaskAccountNumber(CASE WHEN IAB.ProviderID = 2 AND LEN(IAB.AccountNumber) = 15 AND IAB.AccountNumber LIKE '%0000' THEN SUBSTRING(IAB.AccountNumber, 2, 10)\r\n\t\t\t\t\tWHEN IAB.ProviderID = 7 AND LEN(IAB.AccountNumber) = 15 AND IAB.AccountNumber LIKE '%0000' THEN SUBSTRING(IAB.AccountNumber, 0, 12)\r\n\t\t\t\t\tWHEN IAB.ProviderID = 9 AND LEN(IAB.AccountNumber) = 15 AND IAB.AccountNumber LIKE '%0000' THEN SUBSTRING(IAB.AccountNumber, 0, 12)\r\n\t\t\t\t\tELSE IAB.AccountNumber END, IAB.ProviderID) AS AccountNumber\r\n\t\t\t\t,IAB.FormattedAccountNumber\r\n\t\t\t\t,IAB.BillingID\r\n\t\t\t\t,IAB.BillingPeriod\r\n\t\t\t\t,IAB.BillingPeriodDays\r\n\t\t\t\t,IAB.BillingPeriodDaysPriorFY\r\n\t\t\t\t,IAB.BillingPeriodDaysCurrentFY\r\n\t\t\t\t,IAB.IsEstimated\r\n\t\t\t\t,IAB.IsManualEntry\r\n\t\t\t\t,IAB.AmountBilled\r\n\t\t\t\t,IAB.AmountPaid\r\n\t\t\t\t,IAB.AmountPaidPriorFY\r\n\t\t\t\t,IAB.AmountPaidCurrentFY\r\n\t\t\t\t,IAB.EnergyUsage\r\n\t\t\t\t,IAB.EnergyUsagePriorFY\r\n\t\t\t\t,IAB.EnergyUsageCurrentFY\r\n\t\t\t\t,IAB.DemandUsage\r\n\t\t\t\t,IAB.DemandUsagePriorFY\r\n\t\t\t\t,IAB.DemandUsageCurrentFY\r\n\t\t\t\t,IAB.DateBilled\r\n\t\t\t\t,IAB.DateDue\r\n\t\t\t\t,IAB.FromDate\r\n\t\t\t\t,IAB.ToDate\r\n\t\t\t\t,IAB.SplitFY\r\n\t\t\t\t,IAB.CreatedDate\r\n\t\t\t\t,IAB.CreatedBy\r\n\t\t\t\t,IAB.ModifiedDate\r\n\t\t\t\t,IAB.ModifiedBy\r\n\t\t\t\t,IAB.Active\r\n\t\t\tFROM Invoice.vwInvoiceAccountBillings AS IAB\r\n\t\t\t\tINNER JOIN fyTbl ON IAB.GroupID = fyTbl.GroupID\r\n\t\t\tWHERE IAB.InvoiceID = ISNULL(@invoiceId, IAB.InvoiceID)\r\n\t\t\t\tAND IAB.InvoiceNumber = ISNULL(@invoiceNumber, IAB.InvoiceNumber)\r\n\t\t\tORDER BY IAB.GroupName ASC, IAB.ContractNumber ASC, IAB.FiscalYear DESC, IAB.AccountNumber ASC;\r\n\t\tEND;\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n\t\tSELECT @exceptionDetails = ERROR_MESSAGE(), @severity = 'ERROR', @message = 'Reports - Failed to retrieve invoice accounts / billings'\r\n\t\t\t,@sendEmail = 1;\r\n\tEND CATCH;\r\n\r\n\tSET @elapsedTime = DATEDIFF(MILLISECOND, GETDATE(), @startTime);\r\n\r\n\tEXEC dbo.USP_AppLogCreate @correlationId = @correlationId\r\n\t\t,@machineName = @machineName\r\n\t\t,@processName = @processName\r\n\t\t,@action = @action\r\n\t\t,@severity = @severity\r\n\t\t,@message = @message\r\n\t\t,@messageDetails = @messageDetails\r\n\t\t,@exceptionDetails = @exceptionDetails\r\n\t\t,@domain = @domain\r\n\t\t,@username = @username\r\n\t\t,@userId = @userId\r\n\t\t,@sendEmail = @sendEmail\r\n\t\t,@elapsedTime = @elapsedTime;\r\nEND;\r"
        }
      ]
    }
  ]
}