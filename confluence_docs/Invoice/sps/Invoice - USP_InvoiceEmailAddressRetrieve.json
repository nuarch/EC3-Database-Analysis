{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Invoice",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "USP_InvoiceEmailAddressRetrieve",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "USP_InvoiceEmailAddressRetrieve",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve email addresses associated with a specific invoice or payment number. It uses various input parameters to determine the context of the request and logs the process, including any errors encountered. The procedure retrieves email addresses from a set of predefined notification profiles based on the provider associated with the invoice."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves conditional logic to handle different input scenarios."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses a PIVOT operation to transform data from rows to columns."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes error handling with a TRY-CATCH block."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It logs the operation details and handles multiple input parameters."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@invoiceID AS INT = 0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the invoice to retrieve email addresses for."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@paymentNumber AS VARCHAR(255) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The payment number associated with the invoice."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@applicationId AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An identifier for the application context."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@correlationId AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A unique identifier for correlating logs."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@machineName AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The name of the machine executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@processName AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The name of the process executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@domain AS VARCHAR(25) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The domain of the user executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@username AS VARCHAR(25) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The username of the user executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@userId AS INT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@exceptionDetails AS VARCHAR(MAX) = NULL OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter to capture exception details if an error occurs."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization and Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure initializes input parameters, setting defaults where necessary."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It checks if either "
                        },
                        {
                          "type": "text",
                          "text": "@invoiceID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " or "
                        },
                        {
                          "type": "text",
                          "text": "@paymentNumber",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is provided; otherwise, it raises an error."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Setup and Logging Preparation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Initializes variables for logging and sets up a temporary table "
                        },
                        {
                          "type": "text",
                          "text": "@providerList",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " with predefined provider IDs."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Sets the start time for the operation and prepares logging details."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses a PIVOT operation to retrieve profile IDs for various notification types from "
                        },
                        {
                          "type": "text",
                          "text": "Billing.EC3_Contact_MassDistributionProfile",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Determines the appropriate notification profile ID based on the provider ID and group ID."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Email Address Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieves email addresses from "
                        },
                        {
                          "type": "text",
                          "text": "Billing.EC3_Contact_MassDistributionProfile",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "Billing.EC3_Contact_MassDistributionListReportContext",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "Billing.EC3_Contact_ContactAddress",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " tables."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Filters out removed contacts and orders the results by profile ID, contact type, and name."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "A TRY-CATCH block captures any errors during execution, logs the error message, and sets a flag to send an email notification."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Calculates the elapsed time for the operation."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Calls "
                        },
                        {
                          "type": "text",
                          "text": "dbo.USP_AppLogCreate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to log the operation details, including any exceptions."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the tables involved in joins and filters have appropriate indexes to optimize query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "PIVOT Operation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The PIVOT operation can be resource-intensive; ensure that the dataset is not excessively large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging Overhead",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Frequent logging can introduce overhead; consider the impact on performance if the procedure is called frequently."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Input Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure raises an error if neither "
                },
                {
                  "type": "text",
                  "text": "@invoiceID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " nor "
                },
                {
                  "type": "text",
                  "text": "@paymentNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is provided, which is appropriate. However, additional validation on the format and range of these inputs could be beneficial."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure is executed concurrently by multiple users, ensure that the logging mechanism and temporary table usage do not lead to contention or locking issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While the TRY-CATCH block captures errors, it does not re-throw them, which might be necessary for some applications to handle exceptions appropriately."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded provider IDs and profile descriptions, which could lead to maintenance challenges if these values change. Consider externalizing these configurations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Invoice].[USP_InvoiceEmailAddressRetrieve]\n(\r\n\t@invoiceID AS INT = 0\r\n\t,@paymentNumber AS VARCHAR(255) = NULL\r\n\t,@applicationId AS VARCHAR(128) = NULL\r\n\t,@correlationId AS VARCHAR(128) = NULL\r\n\t,@machineName AS VARCHAR(128) = NULL\r\n\t,@processName AS VARCHAR(128) = NULL\r\n\t,@domain AS VARCHAR(25) = NULL\r\n\t,@username AS VARCHAR(25) = NULL\r\n\t,@userId AS INT = NULL\r\n\t,@exceptionDetails AS VARCHAR(MAX) = NULL OUTPUT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\t\r\n\tSELECT @invoiceID = NULLIF(@invoiceID, 0), @paymentNumber = NULLIF(@paymentNumber, '');\r\n\r\n\tIF (ISNULL(@invoiceId, 0) <= 0 AND @paymentNumber IS NULL)\r\n\tBEGIN\r\n\t\tRAISERROR (N'The invoiceId or paymentNumber must be specified', 16, 1);\r\n\tEND;\r\n\r\n\tDECLARE @action AS VARCHAR(25), @severity AS VARCHAR(25), @message AS VARCHAR(255), @messageDetails AS VARCHAR(MAX)\r\n\t\t,@startTime AS DATETIME, @elapsedTime AS INT, @sendEmail AS BIT, @ConEdSteamProfileId AS INT, @ConEdOtherProfileId AS INT\r\n\t\t,@LIPAProfileId AS INT, @NGridEastProfileId AS INT, @PAofNYNJProfileId AS INT, @MetroProfileId AS INT, @NavyYardProfileId AS INT\r\n\t\t,@GenerateHudson AS INT, @CentralHudson AS INT, @NYCEDC AS INT, @NYSOMH AS INT, @notificationProfileId AS INT = 0;\r\n\tDECLARE @providerList AS TABLE (providerID INT NOT NULL);\r\n\tSELECT @startTime = GETDATE(), @applicationId = ISNULL(@applicationId, 103), @correlationId = ISNULL(@correlationId, CONVERT(VARCHAR(128), NEWID()))\r\n\t\t,@machineName = COALESCE(@machineName, @@SERVERNAME, 'NA'), @processName = COALESCE(@processName, QUOTENAME(OBJECT_SCHEMA_NAME(@@PROCID)) + '.' + QUOTENAME(OBJECT_NAME(@@PROCID)), 'NA')\r\n\t\t,@action = 'RETRIEVE', @severity = 'INFO', @message = 'Invoices - Retrieved Provider Emails by InvoiceID', @messageDetails = CONVERT(VARCHAR(MAX), (SELECT @invoiceID AS InvoiceID FOR XML PATH('INPUTS')))\r\n\t\t,@sendEmail = 0, @userId = ISNULL(@userId, 0);\r\n\t\t\r\n\tINSERT INTO @providerList (providerID) VALUES (1), (2), (3), (7), (9), (12), (16), (18), (19), (43), (47), (69);\r\n\r\n\tBEGIN TRY\r\n\t\tSELECT @ConEdSteamProfileId = [Con Edison Steam Payment Notification],\r\n\t\t\t@ConEdOtherProfileId = [Con Edison Payment Notification],\r\n\t\t\t@LIPAProfileId = [PSEG Payment Notification],\r\n\t\t\t@NGridEastProfileId = [National Grid East Payment Notification],\r\n\t\t\t@PAofNYNJProfileId = [PAofNYNJ Payment Notification],\r\n\t\t\t@MetroProfileId = [Metro Energy Payment Notification],\r\n\t\t\t@NavyYardProfileId = [Brooklyn Navy Yard Payment Notification],\r\n\t\t\t@GenerateHudson = [Generate Hudson Payment Notification],\r\n\t\t\t@CentralHudson = [Central Hudson Payment Notification],\r\n\t\t\t@NYCEDC = [NYCEDC Payment Notification],\r\n\t\t\t@NYSOMH = [NYSOMH Payment Notification]\r\n\t\tFROM (SELECT [MassDistributionProfileSeqid], shortDesc\r\n\t\t\tFROM Billing.EC3_Contact_MassDistributionProfile\r\n\t\t\tWHERE shortDesc IN ('PSEG Payment Notification', 'Con Edison Steam Payment Notification', 'Con Edison Payment Notification', 'National Grid East Payment Notification',\r\n\t\t\t\t'PAofNYNJ Payment Notification', 'Metro Energy Payment Notification', 'Brooklyn Navy Yard Payment Notification', 'Generate Hudson Payment Notification',\r\n\t\t\t\t'Central Hudson Payment Notification', 'NYCEDC Payment Notification', 'NYSOMH Payment Notification')\r\n\t\t\t ) AS SourceTable\r\n\t\tPIVOT (MAX([MassDistributionProfileSeqid]) FOR shortDesc IN ([PSEG Payment Notification], [Con Edison Steam Payment Notification], [Con Edison Payment Notification],\r\n\t\t\t[National Grid East Payment Notification], [PAofNYNJ Payment Notification], [Metro Energy Payment Notification], [Brooklyn Navy Yard Payment Notification],\r\n\t\t\t[Generate Hudson Payment Notification], [Central Hudson Payment Notification], [NYCEDC Payment Notification], [NYSOMH Payment Notification])\r\n\t\t) AS pvt;\r\n\r\n  \t\tSELECT @notificationProfileId =\r\n\t\t\tCASE WHEN ProviderID = 3 THEN @LIPAProfileId\r\n\t\t\t\tWHEN ProviderID = 18 THEN @NGridEastProfileId\r\n\t\t\t\tWHEN ProviderID = 43 THEN @PAofNYNJProfileId\r\n\t\t\t\tWHEN ProviderID = 1 THEN @MetroProfileId\r\n\t\t\t\tWHEN ProviderID = 19 THEN @NavyYardProfileId\r\n\t\t\t\tWHEN ProviderID = 69 THEN @GenerateHudson\r\n\t\t\t\tWHEN ProviderID = 12 THEN @CentralHudson\r\n\t\t\t\tWHEN ProviderID = 47 THEN @NYCEDC\r\n\t\t\t\tWHEN ProviderID = 16 THEN @NYSOMH\r\n\t\t\t\tWHEN (ProviderID = 9 AND GroupID = 10) THEN @ConEdSteamProfileId \r\n\t\t\t\tELSE @ConEdOtherProfileId\r\n\t\t\tEND\r\n\t\tFROM (SELECT DISTINCT a.ProviderID, MIN(IIF(b.GroupID = 10, 10, 0)) AS groupid\r\n\t\t\tFROM Invoice.Invoice AS a\r\n\t\t\t\tINNER JOIN Invoice.InvoicePayment AS b ON a.InvoiceID = b.InvoiceID\r\n\t\t\tWHERE a.InvoiceID = ISNULL(@invoiceID, a.invoiceid) AND b.PaymentNumber = ISNULL(@paymentNumber, b.PaymentNumber)\r\n\t\t\t\tAND a.ProviderID IN (SELECT providerID FROM @providerList)\r\n\t\t\tGROUP BY a.ProviderID) AS tmp;\r\n\r\n\t\tSELECT a.MassDistributionProfileSeqid\r\n\t\t\t,c.ContactAddressSeqid\r\n\t\t\t,c.ContactName\r\n\t\t\t,c.ContactLastName\r\n\t\t\t,c.ContactFirstName\r\n\t\t\t,c.ContactMI\r\n\t\t\t,c.Curtsytitle\r\n\t\t\t,c.ContactTelephoneNumber\r\n\t\t\t,c.EmailAddress\r\n\t\t\t,CAST(IIF(c.UtilityCompanyContact IS NOT NULL, 1, 0) AS BIT) AS IsTo\r\n\t\t\t,CAST(IIF(c.AgencyContact IS NOT NULL, 1, 0) AS BIT) AS IsCc\r\n\t\tFROM Billing.EC3_Contact_MassDistributionProfile AS a\r\n\t\t\tINNER JOIN Billing.EC3_Contact_MassDistributionListReportContext AS b ON a.MassDistributionProfileSeqid = b.MassDistributionProfileSeqid\r\n\t\t\tINNER JOIN Billing.EC3_Contact_ContactAddress AS c ON b.ContactAddressSeqid = c.ContactAddressSeqid\r\n\t\tWHERE a.MassDistributionProfileSeqid = @notificationProfileId AND c.IsRemoved = 'N'\r\n\t\tORDER BY a.MassDistributionProfileSeqid, IsTo DESC, c.ContactLastName, c.ContactFirstName;\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n\t\tSELECT @exceptionDetails = ERROR_MESSAGE(), @severity = 'ERROR', @message = 'Invoices - Failed to retrieve Provider Emails by InvoiceID', @sendEmail = 1;\r\n\tEND CATCH;\r\n\r\n\tSET @elapsedTime = DATEDIFF(MILLISECOND, GETDATE(), @startTime);\r\n\r\n\tEXEC dbo.USP_AppLogCreate @correlationId = @correlationId\r\n\t\t,@machineName = @machineName\r\n\t\t,@processName = @processName\r\n\t\t,@action = @action\r\n\t\t,@severity = @severity\r\n\t\t,@message = @message\r\n\t\t,@messageDetails = @messageDetails\r\n\t\t,@exceptionDetails = @exceptionDetails\r\n\t\t,@domain = @domain\r\n\t\t,@username = @username\r\n\t\t,@userId = @userId\r\n\t\t,@sendEmail\t= @sendEmail\r\n\t\t,@elapsedTime = @elapsedTime\r\nEND;\r"
        }
      ]
    }
  ]
}