{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Invoice",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "USP_InvoiceGroupContractDelete",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "USP_InvoiceGroupContractDelete",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to delete an invoice group contract from a Microsoft SQL Server database. It handles the deletion of related contract line allocations, contract lines, and associated billing accounts. The procedure also manages electronic billing records if applicable and logs the operation's details for auditing purposes. It includes error handling to ensure that any issues during the transaction are captured and logged."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple complex operations, including conditional logic, transactions, error handling, and logging. It interacts with several tables and views, performs conditional updates, and manages electronic billing records, making it a high-complexity procedure."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@invoiceGroupId AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the invoice group contract to be deleted."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@comments AS VARCHAR(500) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional comments about the deletion."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@correlationId AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional correlation ID for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@machineName AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional machine name for logging."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@processName AS VARCHAR(128) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional process name for logging."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@domain AS VARCHAR(25) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional domain for logging."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@username AS VARCHAR(25) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional username for logging."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@userId AS INT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional user ID for logging and record updates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@exceptionDetails AS VARCHAR(MAX) = NULL OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Output parameter to capture exception details if an error occurs."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Sets default values for parameters and initializes local variables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Fetches details about the invoice group contract, including invoice ID, group ID, fiscal year, and billing group contract ID."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Fiscal Year Check",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Determines if the invoice is split across fiscal years and retrieves the current fiscal year."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Electronic Billing Check",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Checks if the billing type is electronic and sets a flag accordingly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Management",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Begins a transaction to ensure atomicity."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Deletion Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If the invoice is not split across fiscal years, deletes contract line allocations, contract lines, and associated billing accounts."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If the invoice is split, handles deletions across fiscal years and updates electronic billing records if applicable."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Invoice Number Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Updates the invoice number if certain conditions are met."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Inserts notes for the deletion action and logs the operation details."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Catches exceptions, rolls back the transaction if necessary, and logs error details."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Index Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the tables involved have appropriate indexes to optimize the DELETE operations and SELECT queries."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is large, which could lead to locking issues. Consider breaking down the transaction if possible."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure may impact performance in a high-concurrency environment due to potential locks on the tables involved."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Deleting records without proper checks could lead to orphaned records or data inconsistency."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While errors are caught and logged, the procedure does not attempt to retry or handle specific error types, which could lead to incomplete operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency and Locking",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The extensive use of transactions and DELETE operations could lead to locking issues, affecting other operations on the database."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the database grows, the performance of this procedure may degrade if not optimized with proper indexing and query tuning."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Invoice].[USP_InvoiceGroupContractDelete]\n(\r\n\t@invoiceGroupId AS INT,@comments AS VARCHAR(500) = NULL,@correlationId AS VARCHAR(128) = NULL,@machineName AS VARCHAR(128) = NULL,@processName AS VARCHAR(128) = NULL,@domain AS VARCHAR(25) = NULL,@username AS VARCHAR(25) = NULL,@userId AS INT = NULL,@exceptionDetails AS VARCHAR(MAX) = NULL OUTPUT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\r\n\tDECLARE @action AS VARCHAR(25), @severity AS VARCHAR(25), @message AS VARCHAR(255), @messageDetails AS VARCHAR(MAX),@startTime AS DATETIME, @elapsedTime AS INT, @sendEmail AS BIT, @invoiceId AS INT, @noteFiller AS VARCHAR(500),@groupId AS INT, @isElectronicSummaryBilling AS BIT = 0, @summaryAcctNumber AS VARCHAR(15), @invoiceNumAction AS VARCHAR(30) = '',@invoiceIsSplitFY AS BIT, @fiscalYear AS INT, @currentFY AS INT, @anotherFYInvoiceGroupId AS INT, @billingGroupContractID AS INT,@tranName AS VARCHAR(128) = CONVERT(VARCHAR(128), NEWID());\r\n\r\n\tSELECT @invoiceGroupId = NULLIF(@invoiceGroupId, 0), @comments = ISNULL(NULLIF(@comments, ''), 'Deleted invoice group');\r\n\r\n\tSELECT @startTime = GETDATE(), @correlationId = ISNULL(@correlationId, CONVERT(VARCHAR(128), NEWID())),@machineName = COALESCE(@machineName, @@SERVERNAME, 'NA'),@processName = COALESCE(@processName, QUOTENAME(OBJECT_SCHEMA_NAME(@@PROCID)) + '.' + QUOTENAME(OBJECT_NAME(@@PROCID)), 'NA'),@action = 'DELETE', @severity = 'INFO', @message = 'Deleted invoice group and contract',@messageDetails = CONVERT(VARCHAR(MAX), (SELECT @invoiceGroupId AS GRPID, @comments AS CMT FOR XML PATH('INPUTS'))),@sendEmail = 0, @userId = ISNULL(@userId, 0);\r\n\r\n\tSELECT @invoiceId = InvoiceID,@groupId = GroupID,@fiscalYear = CAST(FiscalYear AS INT),@billingGroupContractID = BillingGroupContractID\r\n\tFROM Invoice.vwInvoiceGroupContracts\r\n\tWHERE InvoiceGroupContractID = @invoiceGroupId;\r\n\r\n\tSELECT @invoiceIsSplitFY = Billing.UDF_IsSplitFYInvoice(InvoiceID),@currentFY = Billing.UDF_GetFiscalYear(CreatedDate)\r\n\tFROM Invoice.Invoice\r\n\tWHERE InvoiceID = @invoiceId;\r\n\r\n\tIF EXISTS (SELECT 1 FROM Billing.vwBillingGroups WHERE GroupID = @groupId AND BillingType = 'E')\r\n\tBEGIN\r\n SET @isElectronicSummaryBilling = 1;\r\n\tEND;\r\n\r\n\tSELECT @summaryAcctNumber = SummaryAccountNumber\r\n\tFROM Billing.vwBillingGroups\r\n\tWHERE GroupID = @groupId;\r\n\r\n\tSELECT @noteFiller = (GroupName + ',' + FiscalYear + ',' + ContractNumber)\r\n\tFROM Invoice.vwInvoiceGroupContracts\r\n\tWHERE InvoiceGroupContractID = @invoiceGroupId;\r\n\r\n\tSET @noteFiller = ISNULL(@noteFiller, CONVERT(VARCHAR(10), @invoiceGroupId));\r\n\r\n\tBEGIN TRY\r\n BEGIN TRAN @tranName;\r\n\r\n IF (@invoiceIsSplitFY = 0)\r\n BEGIN\r\n -- Delete contract line allocations associated with the group\r\n DELETE ICLA\r\n FROM Invoice.InvoiceContractLineAllocation AS ICLA\r\n INNER JOIN Invoice.InvoiceContractLine AS ICL ON ICL.InvoiceContractLineID = ICLA.InvoiceContractLineID\r\n INNER JOIN Billing.ContractLine AS CL ON CL.ContractLineID = ICL.ContractLineID\r\n INNER JOIN Billing.vwBillingGroupContracts AS BGC ON BGC.ContractID = CL.ContractID AND BGC.FiscalYear = CL.FiscalYear\r\n INNER JOIN Invoice.InvoiceGroupContract AS IGC ON IGC.BillingGroupContractID = BGC.BillingGroupContractID\r\n WHERE IGC.InvoiceGroupContractID = @invoiceGroupId\r\n AND ICL.InvoiceID = IGC.InvoiceID;\r\n\r\n -- Delete contract lines associated with the group\r\n DELETE ICL\r\n FROM Invoice.InvoiceContractLine AS ICL\r\n INNER JOIN Billing.ContractLine AS CL ON CL.ContractLineID = ICL.ContractLineID\r\n INNER JOIN Billing.vwBillingGroupContracts AS BGC ON BGC.ContractID = CL.ContractID AND BGC.FiscalYear = CL.FiscalYear\r\n INNER JOIN Invoice.InvoiceGroupContract AS IGC ON IGC.BillingGroupContractID = BGC.BillingGroupContractID\r\n WHERE IGC.InvoiceGroupContractID = @invoiceGroupId\r\n AND ICL.InvoiceID = IGC.InvoiceID;\r\n\r\n -- Unlock associated bills in EC3 (for electronic billing only)\r\n IF (@isElectronicSummaryBilling = 1)\r\n BEGIN\r\n UPDATE EB\r\n SET EB.InvoiceTrackingSeqid = NULL,EB.VoucherBillingStatus = NULL,EB.VoucherBillingStatusPeriod = NULL,EB.IsLockedForEdit = 'N',EB.LastUpdate = GETDATE(),EB.AuthenticatedUserID = @userId\r\n FROM Billing.EC3_ManualBill_AccountManualBillingHeader_ElectronicBilling AS EB\r\n INNER JOIN Invoice.InvoiceAccountBilling AS ACCT ON ACCT.BillingID = EB.AccountManualBillingHeaderSeqid\r\n WHERE ACCT.InvoiceGroupContractID = @invoiceGroupId\r\n AND ACCT.BillingID NOT IN (SELECT DISTINCT BillingID FROM Invoice.InvoiceAccountBilling WHERE InvoiceID <> @invoiceId);\r\n END;\r\n\r\n -- Delete accounts associated with the group\r\n DELETE FROM Invoice.InvoiceAccountBilling WHERE InvoiceGroupContractID = @invoiceGroupId;\r\n END;\r\n ELSE --@fiscalYear = @priorFY\r\n BEGIN\r\n SELECT @anotherFYInvoiceGroupId = InvoiceGroupContractID\r\n FROM Invoice.vwInvoiceGroupContracts\r\n WHERE InvoiceID = @invoiceId AND groupid = @groupId AND InvoiceGroupContractID <> @invoiceGroupId;\r\n\r\n -- Delete contract line allocations associated with the group\r\n DELETE ICLA\r\n FROM Invoice.InvoiceContractLineAllocation AS ICLA\r\n INNER JOIN Invoice.InvoiceContractLine AS ICL ON ICL.InvoiceContractLineID = ICLA.InvoiceContractLineID\r\n WHERE ICL.InvoiceID = @invoiceId\r\n AND ICL.ContractID IN (SELECT ContractID\r\n FROM Billing.vwBillingGroupContracts\r\n WHERE GroupID = @groupId AND FiscalYear IN (CAST(@currentFY AS VARCHAR(4)), CAST(@currentFY-1 AS VARCHAR(4))));\r\n\r\n -- Delete contract lines associated with the group\r\n DELETE ICL\r\n FROM Invoice.InvoiceContractLine AS ICL\r\n WHERE ICL.InvoiceID = @invoiceId\r\n AND ICL.ContractID IN (SELECT ContractID\r\n FROM Billing.vwBillingGroupContracts\r\n WHERE GroupID = @groupId AND FiscalYear IN (CAST(@currentFY AS VARCHAR(4)), CAST(@currentFY-1 AS VARCHAR(4))));\r\n\r\n -- Unlock associated bills in EC3 (for electronic billing only)\r\n IF (@isElectronicSummaryBilling = 1)\r\n BEGIN\r\n UPDATE EB\r\n SET EB.InvoiceTrackingSeqid = NULL,EB.VoucherBillingStatus = NULL,EB.VoucherBillingStatusPeriod = NULL,EB.IsLockedForEdit = 'N',EB.LastUpdate = GETDATE(),EB.AuthenticatedUserID = @userId\r\n FROM Billing.EC3_ManualBill_AccountManualBillingHeader_ElectronicBilling AS EB\r\n INNER JOIN Invoice.InvoiceAccountBilling AS ACCT ON ACCT.BillingID = EB.AccountManualBillingHeaderSeqid\r\n WHERE ACCT.InvoiceGroupContractID IN (@invoiceGroupId, @anotherFYInvoiceGroupId)\r\n AND ACCT.BillingID NOT IN (SELECT DISTINCT BillingID FROM Invoice.InvoiceAccountBilling WHERE InvoiceID <> @invoiceId);\r\n END;\r\n\r\n -- Delete accounts associated with the groups\r\n IF (@fiscalYear = @currentFY)\r\n BEGIN\r\n DELETE FROM Invoice.InvoiceAccountBilling\r\n WHERE InvoiceID = @invoiceId AND GroupID = @groupId\r\n AND InvoiceGroupContractID IN (@invoiceGroupId, @anotherFYInvoiceGroupId)\r\n AND (FromDate < CAST(CAST(@fiscalYear-1 AS VARCHAR(4)) + '-06-30' AS DATETIME)\r\n AND ToDate > CAST(CAST(@fiscalYear-1 AS VARCHAR(4)) + '-06-30' AS DATETIME)\r\n OR FromDate> = CAST(CAST(@fiscalYear-1 AS VARCHAR(4)) + '-06-30' AS DATETIME));\r\n END;\r\n ELSE IF (@fiscalYear = @currentFY-1)\r\n BEGIN\r\n DELETE FROM Invoice.InvoiceAccountBilling\r\n WHERE InvoiceID = @invoiceId AND GroupID = @groupId\r\n AND InvoiceGroupContractID IN (@invoiceGroupId, @anotherFYInvoiceGroupId)\r\n AND (FromDate<CAST(CAST(@fiscalYear AS VARCHAR(4)) + '-06-30' AS DATETIME)\r\n AND ToDate>CAST(CAST(@fiscalYear AS VARCHAR(4)) + '-06-30' AS DATETIME)\r\n OR FromDate<CAST(CAST(@fiscalYear AS VARCHAR(4)) + '-06-30' AS DATETIME));\r\n END;\r\n END;\r\n\r\n -- Delete the group\r\n DELETE FROM Invoice.InvoiceGroupContract WHERE InvoiceGroupContractID = @invoiceGroupId;\r\n\r\n IF (ISNULL(@summaryAcctNumber, '') <> ''\r\n AND (NOT EXISTS(SELECT 1 \r\n FROM Invoice.InvoiceGroupContract AS a\r\n INNER JOIN Billing.BillingGroupContract AS b ON a.BillingGroupContractID = b.BillingGroupContractID\r\n INNER JOIN Billing.vwBillingGroups AS c ON b.GroupID = c.GroupID\r\n WHERE a.InvoiceID = @invoiceId AND ISNULL(c.SummaryAccountNumber, '') <> '')))\r\n BEGIN\r\n UPDATE Invoice.Invoice\r\n SET\tInvoiceNumber = 'DEM_' + RIGHT(InvoiceNumber, 9),ModifiedDate = GETDATE(),ModifiedBy = @userId\r\n WHERE InvoiceID = @invoiceId; \r\n\r\n SET @invoiceNumAction = ' - Invoice Number Updated';\r\n END;\r\n\r\n -- Create filler note\r\n INSERT INTO Common.Note(ParentType, ParentID, [Action], Note, CreatedBy)\r\n VALUES ('INVOICE', @invoiceId, 'REMOVE GROUP', 'Billing group (' + @noteFiller + ') removed' + @invoiceNumAction, @userId);\r\n\r\n -- Create audit note\r\n INSERT INTO Common.Note(ParentType, ParentID, [Action], Note, CreatedBy)\r\n VALUES ('INVOICE', @invoiceId, 'REMOVE GROUP', @comments, @userId);\r\n\r\n COMMIT TRAN @tranName;\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n IF (XACT_STATE() <> 0)\r\n BEGIN\r\n ROLLBACK TRAN @tranName;\r\n END;\r\n\r\n SELECT @exceptionDetails = ERROR_MESSAGE(), @severity = 'ERROR', @message = 'Failed to delete invoice group and contract', @sendEmail = 1;\r\n\tEND CATCH;\r\n\r\n\tSET @elapsedTime = DATEDIFF(MILLISECOND, GETDATE(), @startTime);\r\n\r\n\tEXEC dbo.USP_AppLogCreate @correlationId = @correlationId,@machineName = @machineName,@processName = @processName,@action = @action,@severity = @severity,@message = @message,@messageDetails = @messageDetails,@exceptionDetails = @exceptionDetails,@domain = @domain,@username = @username,@userId = @userId,@sendEmail = @sendEmail,@elapsedTime = @elapsedTime;\r\nEND;\r"
        }
      ]
    }
  ]
}