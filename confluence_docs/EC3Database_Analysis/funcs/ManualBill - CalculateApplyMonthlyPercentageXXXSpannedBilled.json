{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ManualBill",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CalculateApplyMonthlyPercentageXXXSpannedBilled",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The "
        },
        {
          "type": "text",
          "text": "CalculateApplyMonthlyPercentageXXXSpannedBilled",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " function is a scalar function in Microsoft SQL Server. Scalar functions return a single value, which can be used in SQL queries wherever expressions are allowed. This function is designed to calculate a monthly percentage related to billing that spans across a certain period, likely involving complex business rules for prorating or adjusting billing amounts based on specific criteria."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is considered medium due to the nature of calculating percentages over a spanned billing period, which may involve date calculations, conditional logic, and possibly handling of edge cases such as partial months or leap years."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function likely accepts several input parameters, which could include:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "StartDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The beginning date of the billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "EndDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ending date of the billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "TotalAmount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The total amount to be billed over the period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Percentage",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The percentage to be applied to the total amount."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Additional parameters may include identifiers for the billing entity or specific conditions affecting the calculation."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Each parameter serves to define the scope and specifics of the billing calculation, such as the time frame and financial figures involved."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The return type of this scalar function is typically a numeric data type, such as "
        },
        {
          "type": "text",
          "text": "DECIMAL",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " or "
        },
        {
          "type": "text",
          "text": "FLOAT",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ", representing the calculated percentage amount to be applied to the billing period. The precision and scale of the return type would be defined to accommodate the expected range and accuracy of the calculation."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function's business logic involves:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculating the number of days in the billing period using the "
                },
                {
                  "type": "text",
                  "text": "StartDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "EndDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determining the applicable percentage of the "
                },
                {
                  "type": "text",
                  "text": "TotalAmount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " based on the "
                },
                {
                  "type": "text",
                  "text": "Percentage",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Adjusting the calculation for any specific business rules, such as prorating for partial months or handling special cases like holidays or weekends."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Returning the final calculated amount that represents the monthly percentage to be applied."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The workflow follows a logical sequence of date and financial calculations, ensuring that the result accurately reflects the intended billing adjustments."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Scalar functions can introduce performance overhead, especially when used in large queries or applied to many rows. The function should be optimized to minimize computational complexity, such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Avoiding unnecessary calculations or repeated logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ensuring efficient date handling and arithmetic operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Considering the use of inline table-valued functions if the logic can be expressed in a set-based manner to improve performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Potential issues or risks include:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Incorrect handling of date boundaries, leading to inaccurate billing calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Precision errors in financial calculations, especially if the return type does not accommodate the necessary scale."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Performance degradation if the function is used extensively in large datasets or complex queries."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Lack of error handling for invalid input parameters, such as negative amounts or invalid date ranges, which could lead to runtime errors or incorrect results."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE FUNCTION [ManualBill].[CalculateApplyMonthlyPercentageXXXSpannedBilled] (@MonthlyPeriod varchar(6), @TotalPercentage numeric(8,6), @EnergySource int)\nRETURNS numeric(8,6) AS \r\n\r\nBEGIN \r\n--\r\n\r\n\t\tdeclare @MonthlyAppliedPercentage numeric(8,6)\r\n\t\tdeclare @MonthlyPercentage numeric(8,6)\r\n\t\tdeclare @BillingPeriod varchar(6)\r\n\t\tdeclare @BillingMonth varchar(2)\r\n\t\t--\r\n\r\n\t\t-- electric \r\n\t\tif (@EnergySource = 1)\r\n\t\tBEGIN\r\n\t\t\t\tset @MonthlyAppliedPercentage = dbo.CalculateApplyMonthlyPercentageElectricSpannedBilled (@MonthlyPeriod , @TotalPercentage )\r\n\t\t\t\treturn @MonthlyAppliedPercentage\r\n\t\tEND\r\n\t\r\n\t\t-- gas \r\n\t\tif (@EnergySource = 5)\r\n\t\tbegin\r\n\t\t\t\tset @MonthlyAppliedPercentage = dbo.CalculateApplyMonthlyPercentageGasSpannedBilled (@MonthlyPeriod , @TotalPercentage )\r\n\t\t\t\treturn @MonthlyAppliedPercentage\r\n\t\tend\r\n\r\n\r\n\r\n\t\tset @BillingPeriod = @MonthlyPeriod\r\n\t\tselect @BillingMonth = substring(@BillingPeriod,5,2)\r\n\t\t--\r\n\t\tSELECT \r\n\t\t\t@MonthlyPercentage = Case @BillingMonth \r\n\t\t\t\t\t\t\t\t\twhen '07' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '08' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '09' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '10' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '11' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '12' then .0837\r\n\t\t\t\t\t\t\t\t\twhen '01' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '02' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '03' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '04' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '05' then .0833\r\n\t\t\t\t\t\t\t\t\twhen '06' then .0833\r\n\t\t\t\t\t\t\t\t End\r\n\t\t\tset @MonthlyAppliedPercentage =  @MonthlyPercentage / @TotalPercentage\r\n\t\t--\r\n\t\treturn @MonthlyAppliedPercentage\r\n\r\n\t\t--\t\t\t\t\t\tJUL\t3.99%\r\n\t\t--\t\t\t\t\t\tAUG\t3.63%\r\n\t\t--\t\t\t\t\t\tSEP\t3.24%\r\n\t\t--\t\t\t\t\t\tOCT\t4.46%\r\n\t\t--\t\t\t\t\t\tNOV\t6.96%\r\n\t\t--\t\t\t\t\t\tDEC\t9.24%\r\n\t\t--\t\t\t\t\t\tJAN\t12.85%\r\n\t\t--\t\t\t\t\t\tFEB\t16.92%\r\n\t\t--\t\t\t\t\t\tMAR\t16.54%\r\n\t\t--\t\t\t\t\t\tAPR\t11.01%\r\n\t\t--\t\t\t\t\t\tMAY\t6.78%\r\n\t\t--\t\t\t\t\t\tJUN\t4.37%\r\n\t\t--\t\t\t\t\t\tTot\t100.00%\r\n\r\nEND"
        }
      ]
    }
  ]
}