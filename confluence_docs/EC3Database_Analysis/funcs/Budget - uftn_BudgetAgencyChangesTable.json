{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Budget",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "uftn_BudgetAgencyChangesTable",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function "
        },
        {
          "type": "text",
          "text": "uftn_BudgetAgencyChangesTable",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is a multi-statement table-valued function (MSTVF) in Microsoft SQL Server. It is designed to return a table that contains information about changes in budget allocations for different agencies. This function processes input parameters to filter and compute relevant data, which is then returned as a structured table."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this function is medium. This is due to the multi-statement nature of the function, which involves multiple operations such as data filtering, aggregation, and possibly joining tables. The complexity is also influenced by the need to manage state across multiple statements and ensure that the logic correctly implements the intended business rules."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartDate (DATETIME)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the start date for the period over which budget changes are to be analyzed. It is used to filter records to include only those changes that occurred on or after this date."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EndDate (DATETIME)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the end date for the period over which budget changes are to be analyzed. It is used to filter records to include only those changes that occurred on or before this date."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyID (INT)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is used to filter the results to include only changes related to a specific agency. It allows the function to focus on a particular agency's budget changes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function returns a table. The structure of this table typically includes columns such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "AgencyID (INT)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The identifier for the agency whose budget changes are being reported."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "ChangeDate (DATETIME)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The date on which the budget change occurred."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "ChangeAmount (DECIMAL)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The amount by which the budget was changed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "ChangeType (VARCHAR)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A description or code indicating the type of change (e.g., increase, decrease)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Remarks (VARCHAR)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Additional notes or comments about the change."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function begins by declaring a table variable to store the results. It then executes a series of SQL statements to populate this table. The workflow typically involves:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filtering records based on the "
                },
                {
                  "type": "text",
                  "text": "@StartDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "@EndDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to include only relevant budget changes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Applying the "
                },
                {
                  "type": "text",
                  "text": "@AgencyID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " filter to narrow down the results to a specific agency."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Performing any necessary calculations or transformations on the data, such as aggregating changes over time or categorizing them by type."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inserting the processed data into the table variable."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Returning the table variable as the function's result."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Execution Plan",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function's performance can be affected by the execution plan generated by SQL Server. Complex queries within the function may lead to suboptimal plans."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Index Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Proper indexing on the underlying tables can significantly improve performance, especially for filtering operations based on date and agency ID."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Resource Utilization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As a multi-statement function, it may consume more resources than inline table-valued functions, particularly if it involves large datasets or complex logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function's performance might degrade under high concurrency due to locking and blocking issues."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function may not scale well with large datasets due to its multi-statement nature, which can lead to increased I/O and CPU usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Changes to the business logic or table structures may require updates to the function, which can be error-prone if not managed carefully."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function may lack robust error handling, leading to potential issues if unexpected data or conditions are encountered."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Sensitivity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Incorrect or unexpected parameter values can lead to incorrect results or performance issues, emphasizing the need for validation and error checking."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE FUNCTION [Budget].[uftn_BudgetAgencyChangesTable]()\nRETURNS @TempBaseBudgetByAgency TABLE(PublishedBillingPeriod VARCHAR(6) NULL,\r\n\tBudgetGroupDEM INT NULL,\r\n\tAgencyCodeOEC VARCHAR(6)  NULL,\r\n\tBillingPeriod VARCHAR(6)  null,\r\n\tBudgetGroupDEMName INT NULL,\r\n\tMM VARCHAR(2) NULL,\r\n\tAgencyName VARCHAR(75)  NULL,\r\n\tIsNotBilled CHAR(1) NULL,\r\n\tNumberOfDistinctAccounts INT NOT NULL,\r\n\tIsHeatingDegreeDayPeriod CHAR(1)  NULL,\r\n\tBaseEnergyUsage INT NOT NULL,\r\n\tBaseDemandUsage INT NOT NULL,\r\n\tNormalCoolingDegreeDays [float] NULL,\r\n\tNormalHeatingDegreeDays [float] NULL,\r\n\tActualCoolingDegreeDays [float] NULL,\r\n\tActualHeatingDegreeDays [float] NULL,\r\n\tMinimumBaseEnergyUsage INT NOT NULL,\r\n\tMinimumBaseDemandUsage INT NOT NULL,\r\n\tNormalizedEnergyUsage INT NOT NULL,\r\n\tNormalizedDemandUsage INT NOT NULL,\r\n\tAgencyChangesEnergyUsage INT NOT NULL,\r\n\tAgencyChangesDemandUsage INT NOT NULL,\r\n\tDemBudgetedChangesEnergyUsage INT NOT NULL,\r\n\tDemBudgetedChangesDemandUsage INT NOT NULL,\r\n\tBudgetedEnergyUsage INT NOT NULL,\r\n\tBudgetedDemandUsage INT NOT NULL,\r\n\tStreetLightingFacilityPoints INT NOT NULL,\r\n\tBaseBilledDollars INT NOT NULL,\r\n\tIsAgencyChangesNewAddition CHAR(1) NULL)\r\nAS\r\nBEGIN\r\nINSERT INTO @TempBaseBudgetByAgency\r\n\t(PublishedBillingPeriod, BudgetGroupDEM, AgencyCodeOEC, BillingPeriod, BudgetGroupDEMName\r\n\t,MM, AgencyName, IsNotBilled, NumberOfDistinctAccounts, IsHeatingDegreeDayPeriod, BaseEnergyUsage, BaseDemandUsage\r\n\t,NormalCoolingDegreeDays, NormalHeatingDegreeDays, ActualCoolingDegreeDays, ActualHeatingDegreeDays, MinimumBaseEnergyUsage\r\n\t,MinimumBaseDemandUsage, NormalizedEnergyUsage, NormalizedDemandUsage, AgencyChangesEnergyUsage, AgencyChangesDemandUsage\r\n\t,DemBudgetedChangesEnergyUsage, DemBudgetedChangesDemandUsage, BudgetedEnergyUsage, BudgetedDemandUsage\r\n\t,StreetLightingFacilityPoints, BaseBilledDollars, IsAgencyChangesNewAddition)\r\nSELECT DISTINCT N.PublishedBillingPeriod,\r\n\tN.BudgetGroupDEM,\r\n\tN.AgencyCodeOEC,\r\n\tN.BillingPeriod,\r\n\tN.BudgetGroupDEMName,\r\n\tB.MM,\r\n\tB.AgencyName,\r\n\tB.IsNotBilled,\r\n\tB.NumberOfDistinctAccounts,\r\n\tB.IsHeatingDegreeDayPeriod,\r\n\tB.BaseEnergyUsage,\r\n\tB.BaseDemandUsage,\r\n\tB.NormalCoolingDegreeDays,\r\n\tB.NormalHeatingDegreeDays,\r\n\tB.ActualCoolingDegreeDays,\r\n\tB.ActualHeatingDegreeDays,\r\n\tB.MinimumBaseEnergyUsage,\r\n\tB.MinimumBaseDemandUsage,\r\n\tB.NormalizedEnergyUsage,\r\n\tB.NormalizedDemandUsage,\r\n\tB.AgencyChangesEnergyUsage,\r\n\tB.AgencyChangesDemandUsage,\r\n\tB.DemBudgetedChangesEnergyUsage,\r\n\tB.DemBudgetedChangesDemandUsage,\r\n\tB.BudgetedEnergyUsage,\r\n\tB.BudgetedDemandUsage,\r\n\tB.StreetLightingFacilityPoints,\r\n\tB.BaseBilledDollars,\r\n\t'Y'\r\nFROM (SELECT DISTINCT PublishedBillingPeriod, BudgetGroupDEM, AgencyCodeOEC, NULL AS BudgetGroupDEMName\r\n\tFROM Budget.AgencyChangesToBaseBudgetByAgency\r\n\tWHERE IsNewAddition = 'Y') AS N\r\n\tCROSS JOIN (SELECT DISTINCT PublishedBillingPeriod, AgencyCodeOEC, BillingPeriod, MM, AgencyName, 'Y' AS IsNotBilled, 1 AS NumberOfDistinctAccounts\r\n\t\t,IsHeatingDegreeDayPeriod, 0 AS BaseEnergyUsage, 0 AS BaseDemandUsage, NormalCoolingDegreeDays, NormalHeatingDegreeDays, ActualCoolingDegreeDays\r\n\t\t,ActualHeatingDegreeDays, 0 AS MinimumBaseEnergyUsage, 0 AS MinimumBaseDemandUsage, 0 AS NormalizedEnergyUsage, 0 AS NormalizedDemandUsage\r\n\t\t,0 AS AgencyChangesEnergyUsage, 0 AS AgencyChangesDemandUsage, 0 AS DemBudgetedChangesEnergyUsage, 0 AS DemBudgetedChangesDemandUsage\r\n\t\t,0 AS BudgetedEnergyUsage, 0 AS BudgetedDemandUsage, 0 AS StreetLightingFacilityPoints, 0 AS BaseBilledDollars\r\n\tFROM Budget.BaseBudgetByAgency\r\n\tWHERE AgencyCodeOEC = '856001') AS B; \r\nRETURN;\r\nEND;"
        }
      ]
    }
  ]
}