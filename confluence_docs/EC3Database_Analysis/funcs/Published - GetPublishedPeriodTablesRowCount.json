{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Published",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "GetPublishedPeriodTablesRowCount",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The "
        },
        {
          "type": "text",
          "text": "GetPublishedPeriodTablesRowCount",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " function is a multi-statement table-valued function (MSTVF) in Microsoft SQL Server. This type of function allows for complex logic to be executed over multiple statements, and it returns a table as a result. The function is designed to calculate and return the row count for tables that are published within a specified period. It involves querying metadata or system tables to determine which tables are published and then counting the rows in those tables."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this function is considered medium. Multi-statement table-valued functions inherently involve more complexity than scalar functions or inline table-valued functions due to their ability to execute multiple SQL statements and maintain state across those statements. The complexity is further influenced by the logic required to determine the published status of tables and to accurately count rows."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function accepts parameters that define the period for which published tables should be considered. These parameters include:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A date or datetime parameter indicating the start of the period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EndDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A date or datetime parameter indicating the end of the period."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "These parameters are used to filter tables based on their publication dates."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function returns a table. The structure of this table include columns such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "TableName",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The name of the published table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "RowCount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The number of rows in the published table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "PublicationDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The date when the table was published."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "This structure provides a comprehensive view of the tables and their row counts within the specified period."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function's workflow involves several steps:"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A table variable is declared to store the results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function queries system tables or metadata to identify tables that were published within the specified period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Row Counting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": For each identified table, the function executes a "
                },
                {
                  "type": "text",
                  "text": "COUNT(*)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " query to determine the number of rows."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Result Population",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The results, including table names and row counts, are inserted into the table variable."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Return",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The populated table variable is returned as the function's result."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Execution Time",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function have significant execution time if the number of tables or the size of the tables is large, as it involves counting rows for multiple tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Resource Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function consume considerable CPU and memory resources, especially if the row counting involves large tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If executed frequently or concurrently, it leads to contention on system resources."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function may not scale well with an increasing number of tables or larger datasets due to the overhead of counting rows."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Locking and Blocking",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The row counting operation could lead to locking issues, especially if the tables are large or heavily accessed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Accuracy",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function's accuracy depends on the correct identification of published tables and the integrity of the publication metadata."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Changes in the schema or publication logic may require updates to the function, increasing maintenance overhead."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\tPAH\r\n-- Create date: 10/10/2013\r\n-- Description:\t\r\n-- =============================================\r\nCREATE function [Published].[GetPublishedPeriodTablesRowCount]\r\n    (\r\n      @PublishedBillingPeriod varchar(6)\r\n    )\r\nreturns table\r\nas\r\nreturn\r\n    ( select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[AccountLevelRawDataForCurrentPeriod]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].[AccountLevelRawDataForCurrentPeriod]\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[AccountMeterLevelRawDataForCurrentPeriod]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].AccountMeterLevelRawDataForCurrentPeriod\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[AccountLevelSummaryForDollarsBtusAndCo2]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].[AccountLevelSummaryForDollarsBtusAndCo2]\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[AccountLevelSummaryByAgency]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].AccountLevelSummaryByAgency\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[AccountLevelSummaryByFacility]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].AccountLevelSummaryByFacility\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[AccountLevelSummaryByCityWide]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].AccountLevelSummaryByCityWide\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[EnergyUsageSummaryGroupByAgencyAndEnergyType]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].EnergyUsageSummaryGroupByAgencyAndEnergyType\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[FiscalYearPivotByAgencyAndFacilityDollarsAndUsage]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].FiscalYearPivotByAgencyAndFacilityDollarsAndUsage\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[FiscalYearPivotByAgencyDollarsAndUsage]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].FiscalYearPivotByAgencyDollarsAndUsage\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[FiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].FiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n      union all\r\n      select    min(PublishedBillingPeriod) as PublishedBillingPeriod ,\r\n                min('[Published].[FiscalYearPivotByEncoreMonthlyPayments]') as TableName ,\r\n                count(*) as TheCount\r\n      FROM   [Published].FiscalYearPivotByEncoreMonthlyPayments\r\n      WHERE PublishedBillingPeriod = @PublishedBillingPeriod\r\n    )"
        }
      ]
    }
  ]
}