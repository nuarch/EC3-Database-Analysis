{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ManualBill",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CalculateTotalXXXSpannedBilledPercentage",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The "
        },
        {
          "type": "text",
          "text": "CalculateTotalXXXSpannedBilledPercentage",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " function is a scalar function in Microsoft SQL Server. Scalar functions return a single value, which can be used in SQL queries wherever an expression is valid. This function is designed to calculate a specific percentage related to billing, involving a span of time or a set of conditions denoted by \"XXX\". The function's purpose is to encapsulate this calculation logic for reuse across different queries or applications."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is assessed as Medium. Scalar functions can vary in complexity based on the logic they encapsulate. Given that this function calculates a percentage, it involves arithmetic operations and conditional logic. The complexity is increased if it involves multiple database lookups or intricate business rules."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The input parameters for this function are not provided, but, such a function would require:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "A date range or specific dates to define the span for billing calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Identifiers such as customer ID, project ID, or billing cycle ID to specify the context of the calculation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Additional parameters include flags or options to modify the calculation behavior."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Each parameter serves to narrow down the scope of the calculation to relevant data, ensuring the function returns an accurate percentage based on the specified criteria."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The return type of this function is a numeric data type, such as "
        },
        {
          "type": "text",
          "text": "DECIMAL",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " or "
        },
        {
          "type": "text",
          "text": "FLOAT",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ", representing the calculated percentage. The choice of data type would depend on the precision required for the percentage value. The structure is a single scalar value, which can be directly used in SELECT statements or other expressions."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The business logic involves calculating a billed percentage over a specified span. The workflow includes:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieving relevant billing data from one or more tables based on the input parameters."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Applying any necessary filters or conditions to isolate the data pertinent to the calculation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Performing arithmetic operations to compute the percentage, which involve summing billed amounts and dividing by a total or expected amount."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Returning the computed percentage as the function's result."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Scalar functions can introduce performance overhead, especially if they are used in SELECT statements that process large datasets. Each row processed by the query invoke the function, leading to repeated execution. To mitigate performance issues:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ensure the function logic is optimized and avoids unnecessary computations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Consider using inline table-valued functions if the logic can be expressed as a single query, as they can be more efficient."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Index the underlying tables appropriately to speed up data retrieval."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalar functions can lead to performance bottlenecks in large queries due to their row-by-row execution nature."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If the function involves complex logic or multiple database calls, it may increase execution time significantly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Changes to the underlying data structure or business rules may require updates to the function, necessitating thorough testing to ensure continued accuracy."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Precision and rounding issues may arise if the return type does not adequately capture the required decimal places for the percentage calculation."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE FUNCTION [ManualBill].[CalculateTotalXXXSpannedBilledPercentage] (@BillingCycle varchar(1),@NumberOfPeriod int, @StartingPeriod varchar(6),@EndingPeriod varchar(6), @EnergySource int)\nRETURNS numeric(8,6) AS \r\n\r\nBEGIN \r\n\t\t\r\n\t\t\t\t\r\n\t\r\n\r\n\t\t--\r\n\t\tdeclare @MonthlyPercentage numeric(8,6)\r\n\t\tdeclare @TotalPercentage numeric(8,6)\r\n\t\tdeclare @idx int\r\n\t\tdeclare @BillingPeriod varchar(6)\r\n\t\tdeclare @BillingMonth varchar(2)\r\n\t\t--\r\n\t\t\r\n\t\t-- electric \t\r\n\t\tif (@EnergySource = 1)\r\n\t\tbegin\r\n\t\t\tset @MonthlyPercentage = dbo.CalculateTotalElectricSpannedBilledPercentage(@BillingCycle ,@NumberOfPeriod , @StartingPeriod ,@EndingPeriod )\r\n\t\t\treturn @MonthlyPercentage\r\n\t\tend\r\n\t\t\r\n\t\t-- gas \r\n\t\tif (@EnergySource = 5)\r\n\t\tbegin\r\n\t\t\tset @MonthlyPercentage = dbo.CalculateTotalGasSpannedBilledPercentage(@BillingCycle ,@NumberOfPeriod , @StartingPeriod ,@EndingPeriod )\r\n\t\t\treturn @MonthlyPercentage\r\n\t\tend\r\n\t\t\r\n\t\t-- for the other energy types that dont expect any spanned adjustments\t\t\t\r\n\t\t\r\n\t\tset @BillingPeriod = @StartingPeriod\r\n\t\tselect @BillingMonth = substring(@BillingPeriod,5,2)\r\n\t\tset @idx = 0\r\n\t\tset @TotalPercentage = 0.00\r\n\t\t--\r\n\t\twhile (@idx < @NumberOfPeriod)\r\n\t\tBegin\r\n\t\tSELECT \r\n\t\t\t@MonthlyPercentage = Case @BillingMonth \r\n\t\t\t\t\t\t\t\t\twhen '01' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '02' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '03' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '04' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '05' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '06' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '07' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '08' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '09' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '10' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '11' then 0.0833\r\n\t\t\t\t\t\t\t\t\twhen '12' then 0.0837\r\n\t\t\t\t\t\t\t\t End\r\n\t\t\tset @idx = @idx + 1\r\n\t\t\tset @TotalPercentage = @TotalPercentage + @MonthlyPercentage\r\n\t\t\tselect @BillingPeriod = [dbo].[CalculateNextBillingPeriod]  (@BillingPeriod ,@BillingCycle)\r\n\t\t\tselect @BillingMonth = substring(@BillingPeriod,5,2)\r\n\t\tEnd\r\n\t\t--\r\n\t\treturn @TotalPercentage\r\n\r\n\t\t--\t\t\t\t\t\tJUL\t8.33%\r\n\t\t--\t\t\t\t\t\tAUG\t8.33%\r\n\t\t--\t\t\t\t\t\tSEP\t8.33%\r\n\t\t--\t\t\t\t\t\tOCT\t8.33%\r\n\t\t--\t\t\t\t\t\tNOV\t8.33%\r\n\t\t--\t\t\t\t\t\tDEC\t8.37%\r\n\t\t--\t\t\t\t\t\tJAN\t8.33%\r\n\t\t--\t\t\t\t\t\tFEB\t8.33%\r\n\t\t--\t\t\t\t\t\tMAR\t8.33%\r\n\t\t--\t\t\t\t\t\tAPR\t8.33%\r\n\t\t--\t\t\t\t\t\tMAY\t8.33%\r\n\t\t--\t\t\t\t\t\tJUN\t8.33%\r\n\t\t--\t\t\t\t\t\tTot\t100.00%\r\n\r\nEND"
        }
      ]
    }
  ]
}