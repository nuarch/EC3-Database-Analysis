{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Billing",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "uftn_TableGetOECFacilityNumberByAgencyHierarchyActiveAccounts",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function "
        },
        {
          "type": "text",
          "text": "uftn_TableGetOECFacilityNumberByAgencyHierarchyActiveAccounts",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is a multi-statement table-valued function in Microsoft SQL Server. It is designed to retrieve OEC (Office of Emergency Communications) facility numbers based on agency hierarchy and active accounts. This function processes input parameters to filter and return a structured dataset that aligns with the specified criteria."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this function is considered medium due to its multi-statement nature, which involves multiple operations such as data filtering, joining tables, and aggregating results. The complexity is also influenced by the need to handle agency hierarchy and account status logic."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function accepts parameters that define the scope of the query, such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Identifies the specific agency for which the facility numbers are being retrieved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@HierarchyLevel",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the level within the agency hierarchy to consider."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsActive",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A boolean or integer flag indicating whether to include only active accounts."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "These parameters are used to filter the data and ensure that the function returns relevant results based on the specified criteria."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function returns a table with a defined structure. The table includes columns such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "FacilityNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for each OEC facility."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "AgencyID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the agency associated with the facility."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "AccountStatus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": shows whether the account is active or inactive."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Additional columns include hierarchy details or other relevant metadata."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function's workflow involves:"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Accepting input parameters to define the query scope."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Querying the database to retrieve records that match the specified agency and hierarchy level."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filtering the results to include only active accounts if specified by the "
                },
                {
                  "type": "text",
                  "text": "@IsActive",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Constructing and returning a table with the relevant facility numbers and associated data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function involve multiple SQL statements, including SELECT queries, JOIN operations to combine data from different tables, and WHERE clauses to apply filters."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Proper indexing on columns used in JOINs and WHERE clauses can significantly improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Execution Plan",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Analyzing the execution plan can help identify bottlenecks and optimize query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Volume",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function's performance degrade with large datasets, so testing with realistic data volumes is essential."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Consider the impact of concurrent executions on database resources."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the function may require optimization to maintain performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Sensitivity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Incorrect parameter values can lead to unexpected results or performance issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the function correctly handles edge cases, such as missing or incomplete data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Multi-statement functions can be more challenging to maintain and debug compared to inline table-valued functions."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE FUNCTION [Billing].[uftn_TableGetOECFacilityNumberByAgencyHierarchyActiveAccounts]\n(\r\n    @AgencyCodeOEC AS VARCHAR(MAX),\r\n    @OECFacilitNumber AS VARCHAR(MAX),\r\n    @EmailAddress AS emailaddr\r\n)\r\nRETURNS @selectedAgencyFacility TABLE\r\n(\r\n\tFacilitySeqid INT,\r\n\tOecFacilityNumber VARCHAR(8), \r\n\tFacilityName VARCHAR(100),\r\n\tAddress1 VARCHAR(120),\r\n\tAgencyCodeOEC VARCHAR(6),\r\n\tAgencyName VARCHAR(75),\r\n\tAgencyDivisionSeqID seqid NULL,\r\n\tAgencyDivisionHierarchy HIERARCHYID NULL,\r\n\tParentAgencyDivisionSeqid seqid NULL,\r\n\tUNIQUE(OecFacilityNumber, AgencyCodeOEC),\r\n\tUNIQUE(AgencyCodeOEC, OecFacilityNumber),\r\n\tUNIQUE(AgencyDivisionHierarchy, AgencyDivisionSeqID, FacilitySeqid)\r\n)\r\nAS\r\nBEGIN\r\n\tDECLARE @selectedFacility TABLE(OecFacilityNumber VARCHAR(8) PRIMARY KEY);\r\n    DECLARE @delimiter AS CHAR(1);\r\n      \r\n\tSET @delimiter = ',';\r\n      \r\n    IF (@AgencyCodeOEC =  '*' AND @OECFacilitNumber =  '*')\r\n\tBEGIN\r\n\t\tRETURN ;\r\n\tEND;\r\n      \r\n    IF (@OECFacilitNumber = '*')\r\n\tBEGIN\r\n\t\tINSERT INTO @selectedAgencyFacility\r\n\t\t\t(FacilitySeqid,\r\n\t\t\tOecFacilityNumber,\r\n\t\t\tFacilityName,\r\n\t\t\tAddress1,\r\n\t\t\tAgencyCodeOEC,\r\n\t\t\tAgencyName,\r\n\t\t\tAgencyDivisionSeqID,\r\n\t\t\tAgencyDivisionHierarchy,\r\n\t\t\tParentAgencyDivisionSeqid)\r\n\t\tSELECT DISTINCT F.FacilitySeqid, F.OecFacilityNumber, F.FacilityName, F.Address1,\r\n\t\t\tAD.AgencyCodeOEC, AC.AgencyName, AD.AgencyDivisionSeqid, AC.AgencyDivisionHierarchy,\r\n\t\t\tAC.ParentAgencyDivisionSeqid\r\n\t\tFROM Billing.Account AS A\r\n\t\t\tINNER JOIN Billing.AgencyDivision AS AD ON A.AgencyAccount = AD.AgencyDivisionSeqid\r\n\t\t\tINNER JOIN Billing.Facility AS F ON A.FacilityAccount = F.FacilitySeqid\r\n\t\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS AC ON AD.AgencyDivisionSeqid = AC.AgencyDivisionSeqID\r\n\t\tWHERE A.IsCurrentRecord = 'Y' AND A.IsActive = 1\r\n\t\tORDER BY AD.AgencyCodeOEC, F.OecFacilityNumber;\r\n\t\tRETURN;\r\n\tEND;\r\n    ELSE\r\n \tBEGIN\r\n\t\tWITH cteOECFacilitNumber AS (\r\n\t\t\tSELECT 0 AS [pos], 1 AS [level]\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT CONVERT(INT, CHARINDEX(@delimiter, @OECFacilitNumber, cteOECFacilitNumber.pos + 1)), [level] + 1\r\n\t\t\tFROM cteOECFacilitNumber\r\n\t\t\tWHERE CHARINDEX(@delimiter, @OECFacilitNumber, cteOECFacilitNumber.pos + 1) > 0)\r\n\r\n\t\tINSERT INTO @selectedFacility(OecFacilityNumber)\r\n\t\tSELECT DISTINCT SUBSTRING(@OECFacilitNumber, a.pos + 1, CASE WHEN b.pos IS NULL THEN (LEN(@OECFacilitNumber) - a.pos) ELSE (b.pos - a.pos -1) END)\r\n\t\tFROM cteOECFacilitNumber AS a\r\n\t\t\tLEFT JOIN cteOECFacilitNumber AS b ON a.[level] + 1 = b.[level]\r\n\t\tOPTION (maxrecursion 0);\r\n\tEND;\r\n\t\t\t\r\n\tINSERT INTO @selectedAgencyFacility\r\n\t\t(FacilitySeqid,\r\n\t\tOecFacilityNumber,\r\n\t\tFacilityName,\r\n\t\tAddress1,\r\n\t\tAgencyCodeOEC,\r\n\t\tAgencyName,\r\n\t\tAgencyDivisionSeqID,\r\n\t\tAgencyDivisionHierarchy,\r\n\t\tParentAgencyDivisionSeqid)\r\n\tSELECT DISTINCT F.FacilitySeqid, F.OecFacilityNumber, F.FacilityName, F.Address1,\r\n\t\tAD.AgencyCodeOEC, AC.AgencyName,\r\n\t\tAD.AgencyDivisionSeqid, AC.AgencyDivisionHierarchy,\r\n\t\tAC.ParentAgencyDivisionSeqid\r\n\tFROM Billing.Account AS A\r\n\t\tINNER JOIN Billing.AgencyDivision AS AD ON A.AgencyAccount = AD.AgencyDivisionSeqid\r\n\t\tINNER JOIN Billing.Facility AS F ON A.FacilityAccount = F.FacilitySeqid\r\n\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS AC ON AD.AgencyDivisionSeqid = AC.AgencyDivisionSeqID\r\n\t\tINNER JOIN @selectedFacility AS SF ON REPLACE(SF.OecFacilityNumber, ' ', '') = F.OecFacilityNumber\r\n\tWHERE A.IsCurrentRecord = 'Y' AND A.IsActive = 1\r\n\tORDER BY AD.AgencyCodeOEC, F.OecFacilityNumber;\r\n    RETURN;\r\nEND;"
        }
      ]
    }
  ]
}