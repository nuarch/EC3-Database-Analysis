{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Billing",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "uftn_TableGetOECFacilityNumberByAgencyHierarchy",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function "
        },
        {
          "type": "text",
          "text": "uftn_TableGetOECFacilityNumberByAgencyHierarchy",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is a multi-statement table-valued function in Microsoft SQL Server. It is designed to retrieve OEC (Office of Emergency Communications) facility numbers based on a specified agency hierarchy. This function processes input parameters to filter and return a set of data that matches the criteria defined within its logic."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this function is considered medium. This is due to the multi-statement nature of the function, which involves multiple operations such as data filtering, conditional logic, and possibly joining tables or aggregating data. The complexity is also influenced by the need to manage and return a table structure, which requires careful handling of data types and logic to ensure accurate results."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function accepts input parameters that define the criteria for retrieving OEC facility numbers. These parameters typically include identifiers or keys related to the agency hierarchy, such as agency ID, hierarchy level, or other relevant attributes. Each parameter serves to narrow down the dataset to the specific subset of data that the user is interested in."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The return type of this function is a table. The structure of the returned table includes columns that represent the OEC facility numbers and possibly other related information such as agency details, hierarchy levels, or additional metadata. The exact columns and their data types are defined within the function's RETURN clause."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The business logic of the function involves several steps:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Accept input parameters to determine the scope of the query."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Use these parameters to filter data from one or more tables that store agency and facility information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Apply any necessary joins, conditions, or aggregations to refine the dataset."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Populate a table variable with the results of the query."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Return the table variable as the output of the function."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The workflow is designed to ensure that only relevant OEC facility numbers are returned based on the specified agency hierarchy."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Performance considerations for this function include:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The efficiency of the query logic, particularly in terms of joins and filtering conditions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The size of the dataset being processed, as larger datasets may impact execution time."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing on the tables involved, which can significantly improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The potential impact of the function being called frequently or with complex input parameters, which may necessitate optimization or caching strategies."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Potential issues or risks associated with this function include:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Incorrect or inefficient query logic leading to slow performance or incorrect results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Changes to the underlying table structures or data that could affect the function's output."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Lack of proper error handling, which could result in unhandled exceptions or incorrect data being returned."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dependency on specific input parameters that, if not validated, could lead to unexpected behavior or security vulnerabilities."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE FUNCTION [Billing].[uftn_TableGetOECFacilityNumberByAgencyHierarchy]\n(\r\n    @AgencyCodeOEC AS VARCHAR(MAX),\r\n    @OECFacilitNumber AS VARCHAR(MAX),\r\n    @EmailAddress AS emailaddr\r\n)\r\nRETURNS @selectedAgencyFacility TABLE\r\n(\r\n\tFacilitySeqid INT,\r\n\tOecFacilityNumber VARCHAR(8), \r\n\tFacilityName VARCHAR(100),\r\n\tAddress1 VARCHAR(120),\r\n\tAgencyCodeOEC VARCHAR(6),\r\n\tAgencyName VARCHAR(75),\r\n\tAgencyDivisionSeqID seqid NULL,\r\n\tAgencyDivisionHierarchy HIERARCHYID NULL,\r\n\tParentAgencyDivisionSeqid seqid NULL,\r\n\tUNIQUE(OecFacilityNumber, AgencyCodeOEC),\r\n\tUNIQUE(AgencyCodeOEC, OecFacilityNumber),\r\n\tUNIQUE(AgencyDivisionHierarchy, AgencyDivisionSeqID, FacilitySeqid)\r\n)\r\nAS\r\nBEGIN\r\n\tDECLARE @selectedFacility TABLE(OecFacilityNumber VARCHAR(8) PRIMARY KEY);\r\n    DECLARE @delimiter AS CHAR(1);\r\n      \r\n\tSET @delimiter = ',';\r\n      \r\n    IF (@AgencyCodeOEC =  '*' AND @OECFacilitNumber =  '*')\r\n\tBEGIN\r\n\t\tRETURN ;\r\n\tEND;\r\n      \r\n    IF (@OECFacilitNumber = '*')\r\n\tBEGIN\r\n\t\tINSERT INTO @selectedAgencyFacility\r\n\t\t\t(FacilitySeqid,\r\n\t\t\tOecFacilityNumber,\r\n\t\t\tFacilityName,\r\n\t\t\tAddress1,\r\n\t\t\tAgencyCodeOEC,\r\n\t\t\tAgencyName,\r\n\t\t\tAgencyDivisionSeqID,\r\n\t\t\tAgencyDivisionHierarchy,\r\n\t\t\tParentAgencyDivisionSeqid)\r\n\t\tSELECT DISTINCT F.FacilitySeqid, F.OecFacilityNumber, F.FacilityName, F.Address1,\r\n\t\t\tAD.AgencyCodeOEC, AC.AgencyName, AD.AgencyDivisionSeqid, AC.AgencyDivisionHierarchy,\r\n\t\t\tAC.ParentAgencyDivisionSeqid\r\n\t\tFROM Billing.Account AS A\r\n\t\t\tINNER JOIN Billing.AgencyDivision AS AD ON A.AgencyAccount = AD.AgencyDivisionSeqid\r\n\t\t\tINNER JOIN Billing.Facility AS F ON A.FacilityAccount = F.FacilitySeqid\r\n\t\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS AC ON AD.AgencyDivisionSeqid = AC.AgencyDivisionSeqID\r\n\t\tWHERE A.IsCurrentRecord = 'Y'\r\n\t\tORDER BY AD.AgencyCodeOEC, F.OecFacilityNumber;\r\n\t\tRETURN;\r\n\tEND;\r\n    ELSE\r\n \tBEGIN\r\n\t\tWITH cteOECFacilitNumber AS (\r\n\t\t\tSELECT 0 AS [pos], 1 AS [level]\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT CONVERT(INT, CHARINDEX(@delimiter, @OECFacilitNumber, cteOECFacilitNumber.pos + 1)), [level] + 1\r\n\t\t\tFROM cteOECFacilitNumber\r\n\t\t\tWHERE CHARINDEX(@delimiter, @OECFacilitNumber, cteOECFacilitNumber.pos + 1) > 0)\r\n\r\n\t\tINSERT INTO @selectedFacility(OecFacilityNumber)\r\n\t\tSELECT DISTINCT SUBSTRING(@OECFacilitNumber, a.pos + 1, CASE WHEN b.pos IS NULL THEN (LEN(@OECFacilitNumber) - a.pos) ELSE (b.pos - a.pos -1) END)\r\n\t\tFROM cteOECFacilitNumber AS a\r\n\t\t\tLEFT JOIN cteOECFacilitNumber AS b ON a.[level] + 1 = b.[level]\r\n\t\tOPTION (maxrecursion 0);\r\n\tEND;\r\n\t\t\t\r\n\tINSERT INTO @selectedAgencyFacility\r\n\t\t(FacilitySeqid,\r\n\t\tOecFacilityNumber,\r\n\t\tFacilityName,\r\n\t\tAddress1,\r\n\t\tAgencyCodeOEC,\r\n\t\tAgencyName,\r\n\t\tAgencyDivisionSeqID,\r\n\t\tAgencyDivisionHierarchy,\r\n\t\tParentAgencyDivisionSeqid)\r\n\tSELECT DISTINCT F.FacilitySeqid, F.OecFacilityNumber, F.FacilityName, F.Address1,\r\n\t\tAD.AgencyCodeOEC, AC.AgencyName,\r\n\t\tAD.AgencyDivisionSeqid, AC.AgencyDivisionHierarchy,\r\n\t\tAC.ParentAgencyDivisionSeqid\r\n\tFROM Billing.Account AS A\r\n\t\tINNER JOIN Billing.AgencyDivision AS AD ON A.AgencyAccount = AD.AgencyDivisionSeqid\r\n\t\tINNER JOIN Billing.Facility AS F ON A.FacilityAccount = F.FacilitySeqid\r\n\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS AC ON AD.AgencyDivisionSeqid = AC.AgencyDivisionSeqID\r\n\t\tINNER JOIN @selectedFacility AS SF ON REPLACE(SF.OecFacilityNumber, ' ', '') = F.OecFacilityNumber\r\n\tWHERE A.IsCurrentRecord = 'Y' \r\n\tORDER BY AD.AgencyCodeOEC, F.OecFacilityNumber;\r\n    RETURN;\r\nEND;"
        }
      ]
    }
  ]
}