{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Gas",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "uftn_TableVerifyAccountBillingSummaryInfo",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function "
        },
        {
          "type": "text",
          "text": "uftn_TableVerifyAccountBillingSummaryInfo",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is a multi-statement table-valued function in Microsoft SQL Server. This type of function allows for complex logic to be executed and returns a table as a result. The function is designed to verify and summarize billing information for accounts, likely aggregating or validating data related to account billing."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is considered medium due to the nature of multi-statement table-valued functions, which can involve multiple operations, conditional logic, and data manipulation steps. These functions are more complex than scalar or inline table-valued functions due to their ability to handle multiple statements and potentially complex business logic."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The input parameters for this function are not provided, but typically, such a function would include parameters like:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AccountId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An identifier for the account whose billing information is being verified."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The start date for the billing period to be verified."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EndDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The end date for the billing period to be verified."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "These parameters would be used to filter and process the relevant billing data for the specified account and time frame."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The return type of this function is a table. The structure of the returned table would likely include columns such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "AccountId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The account identifier."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The period for which billing is summarized."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "TotalAmount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The total billing amount for the period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Status",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The verification status of the billing information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Remarks",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Any additional notes or remarks regarding the billing summary."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The business logic within this function would involve:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieving billing data for the specified account and period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Performing calculations or aggregations to summarize the billing information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validating the billing data against business rules or criteria."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Populating the result table with the summarized and verified billing information, including any status or remarks."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The workflow would typically involve querying the relevant billing tables, applying any necessary transformations or validations, and then inserting the results into the return table."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Execution Time",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Multi-statement table-valued functions can be less performant than inline table-valued functions due to the overhead of handling multiple statements and potentially complex logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Resource Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function may consume significant resources if it processes large volumes of data or involves complex calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Proper indexing on the tables involved in the function's queries can improve performance by reducing data retrieval times."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the function may become a bottleneck if not optimized properly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Lack of robust error handling within the function could lead to incomplete or incorrect results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the function is called frequently or simultaneously by multiple users, it could lead to contention or locking issues, impacting performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity of the function may make it challenging to maintain or modify, especially if business rules change frequently."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE  FUNCTION [Gas].[uftn_TableVerifyAccountBillingSummaryInfo](@LastPeriodModified dbo.yyyymm,@UtilityCompanySeqid dbo.seqid,@CurrentInvoiceAccountBillingGroup dbo.seqid)\nRETURNS @AccountBillingSummaryInfo TABLE \r\n(\r\n\t\tUtilityCompanySeqid int, \r\n\t\tCurrentInvoiceAccountBillingGroup int, \r\n\t\tLastPeriodModified varchar(6), \r\n\t\tDescription varchar(75), \r\n\t\tNumberOfRows int, \r\n\t\tOriginalBilledAmount money, \r\n\t\tRevisedBilledAmount money,\r\n\t\tTotalAmountDue money, \r\n\t\tOriginalBilledAmountPaid money, \r\n\t\tRevisedTherms  int, \r\n\t\tPaidAdjustmentAmount money\r\n)\r\n\r\nAS\r\nBEGIN\r\n\r\ninsert into @AccountBillingSummaryInfo\r\n\t(\r\n\t\tUtilityCompanySeqid,\r\n\t\tCurrentInvoiceAccountBillingGroup, \r\n\t\tLastPeriodModified, \r\n\t\tDescription, \r\n\t\tNumberOfRows,\r\n\t\tOriginalBilledAmount,\r\n\t\tRevisedBilledAmount, \r\n\t\tTotalAmountDue, \r\n\t\tOriginalBilledAmountPaid, \r\n\t\tRevisedTherms,\r\n\t\tPaidAdjustmentAmount\r\n\t)\r\nSELECT \tUtilityCompanySeqid, \r\n\t\tCurrentInvoiceAccountBillingGroup, \r\n\t\tLastPeriodModified, \r\n\t\tCASE WHEN BillingPeriod = LastPeriodModified THEN '1) Gas billingAB Original' ELSE '2) Gas billingAB Adjustment' END AS description, \r\n\t\tCOUNT(*) AS NumberOfRows, \r\n\t\tSUM(CASE WHEN BillingPeriod = LastPeriodModified THEN OriginalBilledAmount ELSE 0 END) AS OriginalBilledAmount, \r\n\t\tSUM(RevisedBilledAmount) AS RevisedBilledAmount, \r\n\t\tSUM(CASE WHEN BillingPeriod = LastPeriodModified THEN TotalAmountDue ELSE 0 END) AS TotalAmountDue, \r\n\t\tSUM(CASE WHEN BillingPeriod = LastPeriodModified THEN OriginalBilledAmountPaid ELSE 0 END) AS OriginalBilledAmountPaid, \r\n\t\tSUM(AccountEnergyUsage) AS RevisedTherms, \r\n\t\tSUM(PaidAdjustmentAmount) AS PaidAdjustmentAmount\r\nFROM Billing.AccountBilling\r\nWHERE (LastPeriodModified = @LastPeriodModified) AND (UtilityCompanySeqid = @UtilityCompanySeqid) and (CurrentInvoiceAccountBillingGroup=@CurrentInvoiceAccountBillingGroup)\r\nGROUP by UtilityCompanySeqid,CurrentInvoiceAccountBillingGroup, LastPeriodModified, \r\n                      CASE WHEN BillingPeriod = LastPeriodModified THEN '1) Gas billingAB Original' ELSE '2) Gas billingAB Adjustment' end\r\n--                      \r\ninsert into @AccountBillingSummaryInfo\r\n\t(\r\n\t\tUtilityCompanySeqid,\r\n\t\tCurrentInvoiceAccountBillingGroup, \r\n\t\tLastPeriodModified, \r\n\t\tDescription, \r\n\t\tNumberOfRows,\r\n\t\tOriginalBilledAmount,\r\n\t\tRevisedBilledAmount, \r\n\t\tTotalAmountDue, \r\n\t\tOriginalBilledAmountPaid, \r\n\t\tRevisedTherms,\r\n\t\tPaidAdjustmentAmount\r\n\t)\r\nSELECT \r\n\t\tUtilityCompanySeqid,  \r\n\t\tCurrentInvoiceAccountBillingGroup,\r\n\t\tLastPeriodModified, \r\n\t\tCASE WHEN BillingPeriod = LastPeriodModified THEN '3) Gas billingAB Total' ELSE '3) Gas billingAB Total' END AS description,\r\n\t\tCOUNT(*) AS NumberOfRows, \r\n\t\tSUM(CASE WHEN BillingPeriod = LastPeriodModified THEN OriginalBilledAmount ELSE 0 END) AS OriginalBilledAmount, \r\n\t\tSUM(RevisedBilledAmount) AS RevisedBilledAmount, \r\n\t\tSUM(CASE WHEN BillingPeriod = LastPeriodModified THEN TotalAmountDue ELSE 0 END) AS TotalAmountDue, \r\n\t\tSUM(CASE WHEN BillingPeriod = LastPeriodModified THEN OriginalBilledAmountPaid ELSE 0 END) AS OriginalBilledAmountPaid, \r\n\t\tSUM(AccountEnergyUsage) AS RevisedTherms, \r\n\t\tSUM(PaidAdjustmentAmount) AS PaidAdjustmentAmount\r\nFROM Billing.AccountBilling\r\nGROUP BY UtilityCompanySeqid, CurrentInvoiceAccountBillingGroup,LastPeriodModified, CASE WHEN BillingPeriod = LastPeriodModified THEN '3) Gas billingAB Total' ELSE '3) Gas billingAB Total' END\r\nhaving     (LastPeriodModified = @LastPeriodModified) AND (UtilityCompanySeqid = @UtilityCompanySeqid) and (CurrentInvoiceAccountBillingGroup=@CurrentInvoiceAccountBillingGroup)\r\n\r\nreturn\r\nEND"
        }
      ]
    }
  ]
}