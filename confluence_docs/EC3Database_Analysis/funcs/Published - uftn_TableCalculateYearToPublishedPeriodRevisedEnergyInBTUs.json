{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Published",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "uftn_TableCalculateYearToPublishedPeriodRevisedEnergyInBTUs",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function "
        },
        {
          "type": "text",
          "text": "uftn_TableCalculateYearToPublishedPeriodRevisedEnergyInBTUs",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is a multi-statement table-valued function (MSTVF) in Microsoft SQL Server. It is designed to calculate and return a table of energy values in BTUs (British Thermal Units) for a specified period, likely from the beginning of a year to a published period. The function processes input parameters to compute revised energy values, which are then returned in a tabular format."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this function is considered medium. This is due to the nature of multi-statement table-valued functions, which involve multiple SQL statements and potentially complex logic to manipulate and return data. The complexity can also arise from the need to handle various input parameters and perform calculations or transformations on the data."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function accepts several input parameters, each serving a specific purpose:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartDate",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A date parameter indicating the beginning of the period for which energy calculations are to be performed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EndDate",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A date parameter specifying the end of the period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EnergyType",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A parameter that determines the type of energy to be calculated, which could influence the logic used in the function."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AdjustmentFactor",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A numeric parameter used to adjust the calculated energy values, possibly to account for revisions or corrections."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function returns a table with a defined structure. The table typically includes columns such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The time period for which the energy calculation is relevant."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "EnergyInBTUs",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The calculated energy value in BTUs for the specified period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "RevisedEnergyInBTUs",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The adjusted energy value after applying any necessary revisions or adjustments."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function's workflow involves the following steps:"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Set up any necessary variables or temporary tables to store intermediate results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Query relevant tables to fetch raw energy data for the specified period and energy type."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Perform calculations to convert raw energy data into BTUs, applying any necessary formulas or conversion factors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Adjustment",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Apply the "
                },
                {
                  "type": "text",
                  "text": "@AdjustmentFactor",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to revise the calculated energy values."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Result Compilation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Insert the calculated and revised energy values into the return table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Return",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Output the final table containing the period, energy in BTUs, and revised energy values."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Execution Time",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Multi-statement table-valued functions can be less efficient than inline table-valued functions due to the overhead of managing multiple statements and potential use of temporary tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that any tables queried within the function are properly indexed to optimize data retrieval."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The function's performance may degrade with large datasets, so consider optimizing the logic or breaking down complex operations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the function involves updates to shared resources or tables, it may lead to concurrency issues or locking."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the function includes error handling to manage unexpected input values or calculation errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity of multi-statement logic can make the function harder to maintain or modify, especially if business rules change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Verify that the adjustment factor and any conversion formulas are accurate to prevent incorrect energy calculations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Date       Tech Description of Change\r\n--* ---------- ---\t-------------------------------------------------------------\r\n--* 03/17/2016\tZD\tUpdate: Changed to use temporal tables \r\n--**************************************************************************************\r\n\r\n\r\n\r\nCREATE FUNCTION [Published].[uftn_TableCalculateYearToPublishedPeriodRevisedEnergyInBTUs](@PublishedBillingPeriod varchar(6))\r\nRETURNS @MeterResetAdjustments TABLE \r\n(\r\n\tPublishedBillingPeriod varchar(6),\r\n\tFiscalYear varchar(4),\r\n\tAgencyCodeOEC varchar(6),\r\n\tYearToPublishedPeriodRevisedEnergy bigint\r\n)\r\n\r\nAS\r\n \r\nBEGIN \r\n--\r\ndeclare @RevisedEnergyByType table (\r\n\tPublishedBillingPeriod varchar(6),\r\n\tFiscalYear varchar(4),\r\n\tAgencyCodeOEC varchar(6),\r\n\tRevisedEnergy int,\r\n\tEnergyType varchar(3),\r\n\tEnergyDeliveryUnit varchar(3),\r\n\tYearToPublishedPeriodRevisedEnergy bigint\r\n\r\n)\r\ndeclare @BTUs Bigint \r\ndeclare @YearToPublishedPeriodRevisedEnergy Bigint\r\ndeclare @EnergydeliveryUnit varchar(6)\r\ndeclare @mm int\r\nselect @mm=datepart(mm,@PublishedBillingPeriod+'01')\r\n--\r\ninsert into @RevisedEnergyByType\r\n        ( PublishedBillingPeriod ,\r\n          FiscalYear ,\r\n          AgencyCodeOEC ,\r\n          EnergyType ,\r\n          RevisedEnergy ,\r\n          EnergyDeliveryUnit \r\n        )\r\nselect @PublishedBillingPeriod AS PublishedBillingPeriod,FiscalYear,AgencyCodeOEC,EnergyType,\r\n\t\tcase \r\n\t\t\twhen @mm=6 then  [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]+[DecemberRevisedEnergy]\r\n\t\t\t\t\t\t\t\t\t\t   +[JanuaryRevisedEnergy]+[FebruaryRevisedEnergy]+[MarchRevisedEnergy]+[AprilRevisedEnergy]+[MayRevisedEnergy]+[JuneRevisedEnergy]\r\n\t\t\twhen @mm=5 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]+[DecemberRevisedEnergy]\r\n\t\t\t\t\t\t\t\t\t\t   +[JanuaryRevisedEnergy]+[FebruaryRevisedEnergy]+[MarchRevisedEnergy]+[AprilRevisedEnergy]+[MayRevisedEnergy]\r\n\t\t\twhen @mm=4 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]+[DecemberRevisedEnergy]\r\n\t\t\t\t\t\t\t\t\t\t   +[JanuaryRevisedEnergy]+[FebruaryRevisedEnergy]+[MarchRevisedEnergy]+[AprilRevisedEnergy]\r\n\t\t\twhen @mm=3 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]+[DecemberRevisedEnergy]\r\n\t\t\t\t\t\t\t\t\t\t   +[JanuaryRevisedEnergy]+[FebruaryRevisedEnergy]+[MarchRevisedEnergy]\r\n\t\t\twhen @mm=2 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]+[DecemberRevisedEnergy]\r\n\t\t\t\t\t\t\t\t\t\t   +[JanuaryRevisedEnergy]+[FebruaryRevisedEnergy]\r\n\t\t\twhen @mm=1 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]+[DecemberRevisedEnergy]\r\n\t\t\t\t\t\t\t\t\t\t   +[JanuaryRevisedEnergy]\r\n\t\t\twhen @mm=12 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]+[DecemberRevisedEnergy]\r\n\t\t\twhen @mm=11 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]+[NovemberRevisedEnergy]\r\n\t\t\twhen @mm=10 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]+[OctoberRevisedEnergy]\r\n\t\t\twhen @mm=9 then [JulyRevisedEnergy]+[AugustRevisedEnergy]+[SeptemberRevisedEnergy]\r\n\t\t\twhen @mm=8 then [JulyRevisedEnergy]+[AugustRevisedEnergy]\r\n\t\t\twhen @mm=7 then [JulyRevisedEnergy]\r\n\t\tend as RevisedEnergy,case \r\n\t\t\t\t\t\t\t\t\twhen  (EnergyType = 'ELE') then 'kWh'\r\n\t\t\t\t\t\t\t\t\twhen (EnergyType = 'GAS') then 'THE'\r\n\t\t\t\t\t\t\t\t\twhen (EnergyType = 'STM')  then 'MLB'\r\n\t\t\t\t\t\t\t\t\twhen (EnergyType = 'CHW') then  'GAL'\r\n\t\t\t\t\t\t\t\t\tend as EnergyDeliveryUnit\r\n\t\r\nFROM Published.TemporalFiscalYearPivotByAgencyDollarsAndUsage\r\nWHERE (EffectiveStartPeriod <= @PublishedBillingPeriod AND EffectiveEndPeriod > @PublishedBillingPeriod)\r\n\r\n--\r\ninsert into @MeterResetAdjustments\r\n        ( \r\n          PublishedBillingPeriod ,\r\n          FiscalYear ,\r\n          AgencyCodeOEC,\r\n          YearToPublishedPeriodRevisedEnergy\r\n        )\r\nselect PublishedBillingPeriod,FiscalYear,AgencyCodeOEC,sum(dbo.CalculateEnergySourceInBTUs(RevisedEnergy,EnergyDeliveryUnit))\tfrom @RevisedEnergyByType\r\ngroup by PublishedBillingPeriod,AgencyCodeOEC,FiscalYear\r\n--\r\nreturn \r\nEND"
        }
      ]
    }
  ]
}