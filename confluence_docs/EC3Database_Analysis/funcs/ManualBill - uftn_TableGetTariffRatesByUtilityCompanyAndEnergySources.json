{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ManualBill",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "uftn_TableGetTariffRatesByUtilityCompanyAndEnergySources",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function "
        },
        {
          "type": "text",
          "text": "uftn_TableGetTariffRatesByUtilityCompanyAndEnergySources",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is a multi-statement table-valued function (MSTVF) in Microsoft SQL Server. It is designed to retrieve tariff rates based on specified utility companies and energy sources. This function processes input parameters to filter and return a structured table of tariff rates, which can be used for further analysis or reporting."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is considered medium due to the multi-statement nature of the function, which involves multiple operations such as filtering, joining, or aggregating data. The complexity is also influenced by the need to manage and return a table structure, which requires careful handling of data types and logic to ensure accurate results."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityCompanyId (INT)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the ID of the utility company for which tariff rates are to be retrieved. It is used to filter the data to only include rates associated with the specified company."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EnergySourceId (INT)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the ID of the energy source. It is used to further filter the data to include only those tariff rates that are applicable to the specified energy source."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function returns a table with a predefined structure. The table typically includes columns such as:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "TariffRateId (INT)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A unique identifier for each tariff rate."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "UtilityCompanyId (INT)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the utility company associated with the tariff rate."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "EnergySourceId (INT)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the energy source associated with the tariff rate."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Rate (DECIMAL)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The actual tariff rate value."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "EffectiveDate (DATE)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The date from which the tariff rate is effective."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "ExpirationDate (DATE)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The date until which the tariff rate is valid."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function begins by declaring a table variable to store the results. It then executes a series of SQL statements to populate this table. The logic typically involves:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filtering records from a tariff rates table based on the input parameters "
                },
                {
                  "type": "text",
                  "text": "@UtilityCompanyId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "@EnergySourceId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Optionally joining with other tables to enrich the data with additional information such as company names or energy source descriptions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Applying any necessary business rules or calculations to determine the final tariff rates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inserting the filtered and processed data into the table variable."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Returning the table variable as the function's result."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Execution Plan",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As a multi-statement function, it may not benefit from certain optimizations available to inline table-valued functions. The execution plan can be more complex, potentially impacting performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Proper indexing on the underlying tables, especially on columns used in joins and filters, can significantly improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Resource Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Multi-statement functions can consume more resources due to the need to manage intermediate results in memory."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": High concurrency scenarios might lead to contention if the function involves updates or locks on shared resources."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Performance Bottlenecks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Due to its multi-statement nature, the function might become a performance bottleneck if not optimized properly, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complexity in Debugging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Debugging multi-statement functions can be more challenging compared to scalar or inline table-valued functions due to the multiple steps involved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensuring data integrity is crucial, especially if the function involves complex joins or calculations that might lead to incorrect results if not handled properly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Versioning and Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Changes to the underlying table structures or business rules may require updates to the function, necessitating careful version control and testing."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--================================================\n--  Create Inline Table-valued Function template\r\n-- modifed by MOH on 20100524 after the underlying tables changed\r\n--================================================\r\n\r\nCREATE FUNCTION [ManualBill].[uftn_TableGetTariffRatesByUtilityCompanyAndEnergySources](\t@utilitySeqid int,@energy int,@energy1 int)\r\nRETURNS @DropDownItemList TABLE \r\n(\r\n\t[DisplayText] varchar(80),\r\n\t[Value] int\r\n)\r\nAS\r\nBEGIN\r\nif ((@energy = 1 OR @energy = 3 OR @energy = 4) AND (@energy1 <> 5) )\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT @DropDownItemList\r\n\t\t\t\tSELECT EnergyDeliveryType + ' - ' + Description + ' (' + DeliveryTariffRate + ')' AS display, UtilityTariffRateInformationSeqid AS value \r\n\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\tWHERE\r\n\t\t\t\t(EnergyDeliveryType IN ('ELE', 'ESA', 'XXX')  AND (UtilityCompanyTariff = @utilitySeqid))\r\n\t\t\t\tORDER BY display\r\n\t\t\tEND\r\n\t\tELSE if (@energy = 2) -- street lighting\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT @DropDownItemList\r\n\t\t\t\tSELECT EnergyDeliveryType + ' - ' + Description + ' (' + DeliveryTariffRate + ')' AS display, UtilityTariffRateInformationSeqid AS value \r\n\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\tWHERE\r\n\t\t\t\t(EnergyDeliveryType IN ('ESL', 'XXX')  AND (UtilityCompanyTariff = @utilitySeqid))\r\n\t\t\t\tORDER BY display\r\n\t\t\tEND \r\n\t\tELSE if ((@energy = 5 OR @energy = 9 OR @energy = 10) AND (@energy1 <> 1 ) )\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT @DropDownItemList\r\n\t\t\t\tSELECT EnergyDeliveryType + ' - ' + Description + ' (' + DeliveryTariffRate + ')' AS display, UtilityTariffRateInformationSeqid AS value \r\n\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\tWHERE\r\n\t\t\t\t(EnergyDeliveryType IN ('GAF', 'GAI', 'GAS', 'XXX') AND (UtilityCompanyTariff = @utilitySeqid))\r\n\t\t\t\tORDER BY display\r\n\t\t\tEND \r\n\t\tELSE if (@energy = 6) -- steam\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT @DropDownItemList\r\n\t\t\t\tSELECT EnergyDeliveryType + ' - ' + Description + ' (' + DeliveryTariffRate + ')' AS display, UtilityTariffRateInformationSeqid AS value \r\n\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\tWHERE\r\n\t\t\t\t(EnergyDeliveryType IN ('STM', 'XXX') AND (UtilityCompanyTariff = @utilitySeqid))\r\n\t\t\t\tORDER BY display\r\n\t\t\tEND \r\n\t\tELSE if ((@energy = 6 AND @energy1 = 12) OR (@energy = 12 AND @energy1 = 6) ) -- steam chilled water\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT @DropDownItemList\r\n\t\t\t\tSELECT EnergyDeliveryType + ' - ' + Description + ' (' + DeliveryTariffRate + ')' AS display, UtilityTariffRateInformationSeqid AS value \r\n\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\tWHERE\r\n\t\t\t\t(EnergyDeliveryType IN ('STM', 'WAT', 'XXX') AND (UtilityCompanyTariff = @utilitySeqid))\r\n\t\t\t\tORDER BY display\r\n\t\t\tEND \r\n\t\tELSE if ((@energy = 1 AND @energy1 = 5) OR (@energy = 5 AND @energy1 = 1) )-- ELE/GAS\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT @DropDownItemList\r\n\t\t\t\tSELECT EnergyDeliveryType + ' - ' + Description + ' (' + DeliveryTariffRate + ')' AS display, UtilityTariffRateInformationSeqid AS value \r\n\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\tWHERE\r\n\t\t\t\t(EnergyDeliveryType IN ('ELE', 'ESA', 'GAF', 'GAS', 'GAI', 'XXX') AND (UtilityCompanyTariff = @utilitySeqid))\r\n\t\t\t\tORDER BY display\r\n\t\t\tEND \r\n\t\tELSE if (@energy = 12)\r\n\t\t\tBEGIN\r\n\t\t\t\tINSERT @DropDownItemList\r\n\t\t\t\tSELECT EnergyDeliveryType + ' - ' + Description + ' (' + DeliveryTariffRate + ')' AS display, UtilityTariffRateInformationSeqid AS value \r\n\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\tWHERE\r\n\t\t\t\t(EnergyDeliveryType IN ('WAT', 'XXX') AND (UtilityCompanyTariff = @utilitySeqid))\r\n\t\t\t\tORDER BY display\r\n\t\t\tEND \r\n\r\n\t\treturn \r\nEND"
        }
      ]
    }
  ]
}