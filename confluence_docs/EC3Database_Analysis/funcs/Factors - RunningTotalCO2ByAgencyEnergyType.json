{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Factors",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Function Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "RunningTotalCO2ByAgencyEnergyType",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function "
        },
        {
          "type": "text",
          "text": "RunningTotalCO2ByAgencyEnergyType",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is a scalar function in Microsoft SQL Server designed to calculate the running total of CO2 emissions for a specific agency and energy type. Scalar functions return a single value and are used in SELECT statements or as part of a larger query to perform calculations or transformations on data."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this function is considered medium. While scalar functions themselves are straightforward, the complexity arises from the logic required to accurately compute a running total, which involve aggregating data over a specific dimension (agency and energy type) and ensuring that the calculations are efficient and accurate."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function accepts the following input parameters:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An identifier for the agency for which the CO2 emissions are being calculated. This parameter is used to filter the data to a specific agency."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EnergyType",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A parameter that specifies the type of energy (e.g., electricity, gas) for which the CO2 emissions are being calculated. This helps in filtering the data to the relevant energy type."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Date",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A date parameter that be used to determine the time frame for the running total calculation, ensuring that the function considers emissions up to a specific point in time."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Return Type"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The return type of the function is a numeric data type, such as "
        },
        {
          "type": "text",
          "text": "FLOAT",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " or "
        },
        {
          "type": "text",
          "text": "DECIMAL",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ", which is suitable for representing CO2 emissions values. The function returns a single numeric value representing the running total of CO2 emissions for the specified agency and energy type."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The function's business logic involves:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filtering the dataset to include only records that match the specified "
                },
                {
                  "type": "text",
                  "text": "AgencyID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "EnergyType",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregating the CO2 emissions data up to the specified "
                },
                {
                  "type": "text",
                  "text": "Date",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to compute a running total."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Returning the computed running total as a single numeric value."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The workflow involves querying a table or view that contains CO2 emissions data, applying the necessary filters, and using an aggregate function like "
        },
        {
          "type": "text",
          "text": "SUM()",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " to calculate the running total."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Performance Considerations"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Scalar functions can have performance implications, especially when used in large datasets or within loops. The function's performance depends on:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The efficiency of the underlying query, including the use of indexes on columns like "
                },
                {
                  "type": "text",
                  "text": "AgencyID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "EnergyType",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "Date",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The volume of data being processed, as larger datasets leads to longer execution times."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The context in which the function is used, such as within a SELECT statement that processes many rows, which can lead to performance bottlenecks."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalar functions can lead to performance degradation when used in large queries or with large datasets due to their row-by-row execution nature."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If the function logic does not handle edge cases, such as missing data or incorrect parameter values, it may return inaccurate results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Changes in the underlying data structure, such as table schema changes, could affect the function's accuracy or performance if not properly managed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The function may not scale well with increasing data volume, necessitating optimization or refactoring to maintain performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "8. Function Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Date       Tech Description of Change\r\n--* ---------- ---\t-------------------------------------------------------------\r\n--* 03/17/2016\tZD\tUpdate: Changed to use temporal tables \r\n--* 03/29/2016\tZD\treverted back to use non-temporal since this function is part of publishing process.\r\n--**************************************************************************************\r\n\r\n\r\n\r\nCREATE FUNCTION [Factors].[RunningTotalCO2ByAgencyEnergyType] \r\n(\r\n\t@PublishedBillingPeriodOrYTD varchar(1),\r\n\t@PublishedBillingPeriod varchar(6),\r\n\t@FiscalYear varchar(4),\r\n\t@BillingPeriod varchar(6),\r\n\t@AgencyCode varchar(6),\r\n\t@EnergyType varchar(3)\r\n)\r\nRETURNS numeric(38,6)\r\nAS\r\nbegin\r\n\t----SELECT sum(CO2)\r\n\t----FROM    Published.AccountLevelSummaryByAgency  \r\n\t----WHERE (PublishedBillingPeriod = '201002') and\r\n\t----\t\t\t(AgencyCodeOEC = '002003') and\r\n\t----\t\t  ('200907' <= BillingPeriod and BillingPeriod<= '200907')\r\n\t----group by  PublishedBillingPeriod,AgencyCodeOEC\r\n\r\n\tdeclare @FiscalYearStartDate varchar(6)\r\n\tdeclare @EndDate varchar(6)\r\n\tdeclare @AggregatedCO2 numeric(38,6)\r\n\tdeclare @mm int\r\n\tdeclare @yyyy int\r\n\tdeclare @r int\r\n\t--\r\n\tselect @mm = cast(substring(@BillingPeriod,5,2) as int)\r\n\t--\r\n\tselect @yyyy = cast(@FiscalYear as int)\r\n\tselect @FiscalYearStartDate = cast(@yyyy-1 as varchar(4))+'07' \r\n\t--\r\n\tif (@PublishedBillingPeriodOrYTD = 'P') \r\n\tbegin\r\n\t\tselect\t@AggregatedCO2 =sum(CO2)\r\n\t\tFROM\tPublished.AccountLevelSummaryByAgency\t\r\n\t\tWHERE \r\n\t\t\t\t(PublishedBillingPeriod = @PublishedBillingPeriod) and\r\n\t\t\t\t(AgencyCodeOEC = @AgencyCode) and\r\n\t\t\t\t(EnergyType = @EnergyType) and\r\n\t\t\t\t(@FiscalYearStartDate <= BillingPeriod and BillingPeriod<= @BillingPeriod)\r\n\tend\r\n\telse\r\n\tbegin\r\n\t\tset @EndDate = @FiscalYear+'07'\r\n\t\tselect\t@AggregatedCO2 =sum(CO2)\r\n\t\tFROM\tPublished.AccountLevelSummaryByAgency\t\r\n\t\tWHERE \r\n\t\t\t\t(PublishedBillingPeriod = @PublishedBillingPeriod) and\r\n\t\t\t\t(AgencyCodeOEC = @AgencyCode) and\r\n\t\t\t\t(EnergyType = @EnergyType) and\r\n\t\t\t\t(@FiscalYearStartDate <= BillingPeriod and BillingPeriod< @EndDate)\r\n\t\r\n\tend\r\n\t--\r\n\t\r\n\t\t\t\t\r\n\treturn @AggregatedCO2\r\n\r\n\r\nEND"
        }
      ]
    }
  ]
}