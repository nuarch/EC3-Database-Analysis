{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchangeCode_MISC",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ProcessExchangeCode_MISC",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process exchange records for utility accounts, specifically focusing on updating account information based on exchange codes. It validates the existence and processing status of a record, retrieves account details, and updates account information in the "
        },
        {
          "type": "text",
          "text": "Billing.Account",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table based on specific transaction codes ('SC' for rate code changes and 'WD' for workday updates). The procedure also handles error logging and transaction management to ensure data integrity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple validation checks and conditional logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses transactions and error handling mechanisms."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It interacts with multiple tables and updates records based on specific conditions."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The sequence ID of the exchange record to be processed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeCode varchar(2)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The exchange code, expected to be 'DC' for this procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current billing period, used in error messages."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityCompanySeqid INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the utility company, used to verify tariff information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter indicating the execution status (0 for success, 1 for failure)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validation Checks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Verify if the exchange record exists in "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadExchangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Check if the record has already been processed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieve account details such as "
                },
                {
                  "type": "text",
                  "text": "AccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "GasRateCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "RateCodeChangeDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "WDNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "RecordExchangeCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "TransactionCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " from the exchange detail record."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Exchange Code Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ensure the "
                },
                {
                  "type": "text",
                  "text": "ExchangeCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'DC'. If not, raise an error and exit."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Account Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Verify the account exists in "
                },
                {
                  "type": "text",
                  "text": "Billing.Account",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with an active status."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Begin a transaction named "
                },
                {
                  "type": "text",
                  "text": "exchangeMISC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If "
                },
                {
                  "type": "text",
                  "text": "TransactionCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'SC', update the account's tariff rate information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If "
                },
                {
                  "type": "text",
                  "text": "TransactionCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'WD', update the account's workday number."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Mark the exchange record as processed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Use a TRY-CATCH block to handle errors, log detailed error messages, and rollback the transaction if an error occurs."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the columns used in WHERE clauses, such as "
                },
                {
                  "type": "text",
                  "text": "UploadExchangeDetailSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "AccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", are indexed to improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is limited to the necessary updates, which helps minimize locking and potential contention."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of TRY-CATCH blocks ensures that errors are managed gracefully, but excessive logging in high-volume environments impact performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple users attempt to process the same exchange record simultaneously, it could lead to race conditions or deadlocks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the "
                },
                {
                  "type": "text",
                  "text": "ExchangeCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is always 'DC' and does not handle other codes, which could lead to incorrect processing if the input is not validated beforehand."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure logs detailed error messages, which could expose sensitive information if not properly secured."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded values, such as "
                },
                {
                  "type": "text",
                  "text": "@RecordUtilitySeqid = 2",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which reduces flexibility and could lead to maintenance challenges."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output Parameter",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "@StatusCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " output parameter is used to indicate success or failure, but the procedure does not explicitly set it to 0 on successful completion, relying on the default behavior of the transaction block."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [CrisNationalGridWest].[usp_ProcessExchangeCode_MISC] @AuthenticatedUserID int , @ExchangeSeqid int , @ExchangeCode varchar(2) , @CurrentBillingPeriod VARCHAR(6), @UtilityCompanySeqid INT, @StatusCode int  OUTPUT\n   \r\nAS \r\n \r\nBegin  \r\n\t\t--**************************************************************************************\r\n\t\t--* Name:         \r\n\t\t--*\r\n\t\t--* Description:\tThis stored procedure changes some information on the account\r\n\t\t--*               \r\n\t\t--* Parameter(s):        \r\n\t\t--*\t\t\t\t\t@AuthenticatedUserID int\t\t- the seqid of the user that runs the stored procedure\t\r\n\t\t--*\t\t\t\t\t@ExchangeSeqid int\t\t\t\t- the seqid of the record to process\r\n\t\t--*                 @ExchangeCode int\t\t\t\t- the exchange code in this case 28\r\n\t\t--*\t\t\t\t\t@UtilityCompanySeqid\t\t\t- the utility company \r\n\t\t--*                 @StatusCode  int output\t\t\t- Execution Return Status \r\n\t\t--*\r\n\t\t--*\r\n\t\t--* Return:\t        0 Success\r\n\t\t--*                 1 Failure\r\n\t\t--*\r\n\t\t--* AUTHOR:       MOHAMMED BELARREM\r\n\t\t--* Created On:   05/17/2010\r\n\t\t--**************************************************************************************\r\n\t\t--* Date       Tech Description of Change\r\n\t\t--* ---------- ---\t-------------------------------------------------------------\r\n\t\t--* 05/17/2010 MOH  First Version \r\n\t\t--* 05/20/2010 MOH  Update:\tchanged the key check to ActivityCode instead of ExchangeCode\r\n\t\t--* 05/17/2011 MOH\tUpdate: modified the SC section to check for the rate in the rate table and insert the seqid in the account table \r\n\t\t--**************************************************************************************\r\n\r\n\r\n\t\t--************************************************************************************** \r\n\t\t--Declare Variables                                            \r\n\t\t--**************************************************************************************\r\n\t\t\r\n\t\tDECLARE @AccountNumber NVARCHAR(15)\r\n\t\tDECLARE @RecordExchangeCode VARCHAR(2)\r\n\t\tDECLARE @TransactionCode VARCHAR(2)\r\n\t\tDECLARE @GasRateCode dbo.ServiceClassification\r\n\t\tDECLARE @RateCodeChangeDate VARCHAR(8)\r\n\t\tDECLARE @WDNumber VARCHAR(2)\r\n\t\tDECLARE @RecordUtilitySeqid INT\r\n\t\tDECLARE @UtilityTariffRateInformationSeqid INT\r\n\r\n\t\t\r\n\t\tdeclare @crlf varchar(2)\r\n\t\tset @crlf = CHAR(13) + CHAR(10) \r\n\t\tSET @RecordUtilitySeqid = 2\r\n\t\t\r\n\t\t--**************************************************************************************  \r\n\t\t--Main Process                                      \r\n\t\t--**************************************************************************************\r\n\t\t-- CHECK IF THE record exists\r\n\t\tIF ( NOT EXISTS ( SELECT UploadExchangeDetailSeqid FROM CrisNationalGridWest.UploadExchangeDetail WHERE UploadExchangeDetailSeqid = @ExchangeSeqid ))\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The UploadExchangeDetailSeqid %i does not exist. Please verify. ', 12, 1, @ExchangeSeqid ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\t\t-- check if the record was processed\r\n\t\tIF ( 'Y' = ( SELECT IsProcessed FROM CrisNationalGridWest.UploadExchangeDetail WHERE UploadExchangeDetailSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('This exchange was already processed. exchangeseqid %i ', 12, 1, @ExchangeSeqid ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\t\t-- collect some basic information\r\n\t\tSELECT \r\n\t\t\t@AccountNumber\t\t\t= AccountNumber + '0000', \r\n\t\t\t@GasRateCode\t\t\t= GasRateCode,\r\n\t\t\t@RateCodeChangeDate\t\t= RateCodeChangeDate,\r\n\t\t\t@WDNumber\t\t\t\t= MeterReadWorkDay,\r\n\t\t\t@RecordExchangeCode\t\t= ExchangeCode,\r\n\t\t\t@TransactionCode\t\t= TransactionCode\r\n\t\tFROM CrisNationalGridWest.UploadExchangeDetail\r\n\t\tWHERE   (UploadExchangeDetailSeqid = @ExchangeSeqid)\r\n\r\n\t\t-- some validation\r\n\t\t-- check the obvious\r\n\t\tIF ( @RecordExchangeCode <> 'DC' )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The exchange code is not DC. Please verfiy: account number %s ', 12, 1, @AccountNumber) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\t\t\r\n\t\t-- verify the account exists under an active status\r\n\t\tIF ( NOT EXISTS (    \r\n\t\t\t\t\t\t\tSELECT * FROM Billing.Account \r\n\t\t\t\t\t\t\tWHERE OriginalAccountNumber = @AccountNumber AND CurrentAccountNumber = @AccountNumber AND AccountStatus IN ('AC' , '47', '46', 'UA') AND UtilityAccountProvider = 2\r\n\t\t   ) )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The account number %s does not exist in the system under an active status. Please verfiy: account number %s ', 12, 1, @AccountNumber ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\tbegin try\t\r\n\t\t\r\n\t\t\t\tbegin TRANSACTION exchangeMISC\r\n\t\t\t\tset @StatusCode  = 0\r\n\t\t\t\t\r\n\t\t\t\t-- update the GasRateCode\r\n\t\t\t\tIF ( @TransactionCode = 'SC')\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\t\t-- Update the tariff information  seqid in account record\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t-- verify that the tarrif exists in the UtilityTariffRateInformation table\r\n\t\t\t\t\t\tSELECT @UtilityTariffRateInformationSeqid = UtilityTariffRateInformationSeqid\r\n\t\t\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\t\t\tWHERE\tUtilityCompanyTariff = @RecordUtilitySeqid \r\n\t\t\t\t\t\t\t\tAND DeliveryTariffRate = @GasRateCode\r\n\t\t\t\t\t\t\t\tAND IsTod = 'N'  -- all gas accounts\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIF ( @UtilityTariffRateInformationSeqid IS NULL OR @UtilityTariffRateInformationSeqid = 0 )\r\n\t\t\t\t\t\tBEGIN\t\r\n\t\t\t\t\t\t\tPRINT 'the reported rate on account number ' + @AccountNumber +  ' does not exist in the system, please verify'\t\t\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tupdate Billing.Account\r\n\t\t\t\t\t\tSET  CommodityTariffRate\t\t\t\t= @GasRateCode\r\n\t\t\t\t\t\t\t,CommodityTariffEffectiveDate\t\t= @RateCodeChangeDate\r\n\t\t\t\t\t\t\t,DeliveryTariffRate\t\t\t\t\t= @GasRateCode\r\n\t\t\t\t\t\t\t,DeliveryTariffEffectiveDate\t\t= @RateCodeChangeDate\r\n\t\t\t\t\t\t\t,UtilityTariffRateInformationSeqid\t= @UtilityTariffRateInformationSeqid\r\n\t\t\t\t\t\t\t,FireAuditTrigger\t\t\t\t\t= 'Y'\r\n\t\t\t\t\t\t\t,AuthenticatedUserID\t\t\t\t= @AuthenticatedUserID\r\n\t\t\t\t\t\t\t,LastUpdate\t\t\t\t\t\t\t= GETDATE()\r\n\t\t\t\t\t\t\t \r\n\t\t\t\t\t\tFROM Billing.Account\t\t\r\n\t\t\t\t\t\tWHERE Billing.Account.OriginalAccountNumber = @AccountNumber \r\n\t\t\t\t\t\t\t AND Billing.Account.CurrentAccountNumber = @AccountNumber\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t-- mark as processed\t \r\n\t\t\t\t\t\tUPDATE CrisNationalGridWest.UploadExchangeDetail\r\n\t\t\t\t\t\tSET IsProcessed = 'Y'\r\n\t\t\t\t\t\tWHERE UploadExchangeDetailSeqid = @ExchangeSeqid\t \r\n\t\t\t\t\r\n\t\t\t\tend\r\n\t\t\t\t\r\n\t\t\t\t-- update the Work Day\r\n\t\t\t\tIF ( @TransactionCode = 'WD')\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tupdate Billing.Account\r\n\t\t\t\t\t\tSET  TripNumber\t\t\t\t= @WDNumber\r\n\t\t\t\t\t\t\t,FireAuditTrigger\t\t= 'Y'\r\n\t\t\t\t\t\t\t,AuthenticatedUserID\t= @AuthenticatedUserID\r\n\t\t\t\t\t\t\t,LastUpdate\t\t\t\t= GETDATE()\r\n\t\t\t\t\t\t\t \r\n\t\t\t\t\t\tFROM Billing.Account\t\t\r\n\t\t\t\t\t\tWHERE Billing.Account.OriginalAccountNumber = @AccountNumber \r\n\t\t\t\t\t\t\t AND Billing.Account.CurrentAccountNumber = @AccountNumber\r\n\t\t\t\t\t\t\t \r\n\t\t\t\t\t\t-- mark as processed\r\n\t\t\t\t\t\tUPDATE CrisNationalGridWest.UploadExchangeDetail\r\n\t\t\t\t\t\tSET IsProcessed = 'Y'\r\n\t\t\t\t\t\tWHERE UploadExchangeDetailSeqid = @ExchangeSeqid\t \r\n\r\n\t\t\t\t\r\n\t\t\t\tEND\r\n\t\t\t\t\r\n\r\n\t\t\t\tcommit TRANSACTION exchangeMISC\r\n\r\n\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\r\n\t\t\t\tDECLARE @ExchangeErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorSeverity INT;\r\n\t\t\t\tDECLARE @ErrorState INT;\r\n\t\t\t\tDECLARE @ErrorNumber INT;\r\n\t\t\t\tDECLARE @ErrorLine INT;\r\n\t\t\t\tDECLARE @ErrorProcedure NVARCHAR(126);\r\n\t\t\t\t--\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t@ExchangeErrorMessage ='Error in StoredProcedure %s at line number %d'+@crlf+'Billing Period: %s'+@crlf+'Exchange Sequence Id:%d'+@crlf+'Account:%s  '+@crlf,\r\n\t\t\t\t\t@ErrorMessage = ERROR_MESSAGE(),\r\n\t\t\t\t\t@ErrorSeverity = ERROR_SEVERITY(),\r\n\t\t\t\t\t@ErrorState = ERROR_STATE(),\r\n\t\t\t\t\t@ErrorNumber = ERROR_NUMBER(),\r\n\t\t\t\t\t@ErrorProcedure = ERROR_PROCEDURE(),\r\n\t\t\t\t\t@ErrorLine = ERROR_LINE();\t\t\t\r\n\t\t\t\t--\r\n\t\t\t\tset\t@ErrorMessage = @ExchangeErrorMessage + @ErrorMessage+@crlf+'@ErrorNumber: '+cast(@ErrorNumber as varchar(10))+@crlf\r\n\t\t\t\t--\r\n\t\t\t\tRAISERROR (@ErrorMessage, -- Message text.\r\n\t\t\t\t\t\t   @ErrorSeverity, -- Severity.\r\n\t\t\t\t\t\t   @ErrorState, -- State.\r\n\t\t\t\t\t\t   @ErrorProcedure,\r\n\t\t\t\t\t\t   @ErrorLine,\r\n\t\t\t\t\t\t   @CurrentBillingPeriod,\r\n\t\t\t\t\t\t   @ExchangeSeqid,\r\n\t\t\t\t\t\t   @AccountNumber\r\n\t\t\t\t\t\t   ) with log;\r\n\t\t\t\t\r\n\t\t\t\tset @StatusCode  = 1\r\n\t\t\t\t\t\t   \r\n\t\t\t\tROLLBACK TRANSACTION exchangeMISC\t\r\n\t\t\t\t\t\t   \r\n\t\tEND CATCH\r\nEnd"
        }
      ]
    }
  ]
}