{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_GetMonthlyAgencyFacilityData",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_GetMonthlyAgencyFacilityData",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve and compile energy usage and cost data for facilities associated with a specific agency over a specified billing period. It logs the report usage, fetches facility data, and then aggregates and formats the energy data for reporting purposes. The procedure handles different types of energy (electricity, gas, steam) and provides detailed and summarized views of the data."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. Used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsExternalUser AS dbo.yesnoWithDefaultNo",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Indicates if the user is external. This parameter is not directly used in the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExpandedDetail AS dbo.yesnoWithDefaultYes",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Indicates if expanded details are required. This parameter is not directly used in the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS dbo.yyyymm",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which data is requested. It is used to filter the data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS dbo.OECAgencyCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The code representing the agency for which data is requested. Used to filter and join data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OecFacilityNumber AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The facility number(s) for which data is requested. Used to filter and join data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure starts by logging the report usage using the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " stored procedure, capturing details like the report name, requested by, and parameters used."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Facility Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It retrieves facility data by calling a function "
                },
                {
                  "type": "text",
                  "text": "Billing.uftn_TableGetOECFacilityNumberByAgencyHierarchyActiveAccounts",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which returns active accounts for the specified agency and facility numbers. The results are stored in a table variable "
                },
                {
                  "type": "text",
                  "text": "@facilityData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Periods Compilation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It compiles a list of distinct billing periods from the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalAccountLevelRawDataForCurrentPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table that are greater than a cutoff period ("
                },
                {
                  "type": "text",
                  "text": "200907",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ")."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Selection and Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple "
                },
                {
                  "type": "text",
                  "text": "SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " operations with "
                },
                {
                  "type": "text",
                  "text": "UNION ALL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to compile detailed and aggregated data:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Detailed Cost Data",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Retrieves detailed cost data for each energy type (Electricity, Gas, Steam) and facility."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Total Cost Data",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Aggregates total costs for each facility."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Demand Usage Data",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Retrieves electricity demand usage data."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Energy Usage Data",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Retrieves detailed energy usage data for each energy type."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Total Usage in BTUs",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Aggregates total energy usage converted to mmBTUs."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Each data retrieval step filters records based on the effective start and end periods relative to the published billing period and ensures the billing period is after the cutoff."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which can improve performance by avoiding locks but may result in reading uncommitted data (dirty reads)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Variable Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a table variable ("
                },
                {
                  "type": "text",
                  "text": "@facilityData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") is efficient for small datasets but may not perform well with large datasets due to lack of statistics."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Multiple Joins and Unions",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple joins and unions, which can be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalAccountLevelRawDataForCurrentPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is properly indexed on columns used in joins and filters to optimize query performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to reading uncommitted or inconsistent data, which may not be suitable for all reporting scenarios."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure may face performance issues with large datasets due to the use of table variables and multiple unions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Some input parameters ("
                },
                {
                  "type": "text",
                  "text": "@IsExternalUser",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "@ExpandedDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") are not utilized within the procedure, which could lead to confusion or maintenance challenges."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or failures without proper logging or notification."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_GetMonthlyAgencyFacilityData]\n(\r\n    @EmailAddress AS VARCHAR(75),\r\n\t@IsExternalUser AS dbo.yesnoWithDefaultNo,\r\n    @ExpandedDetail AS dbo.yesnoWithDefaultYes,\r\n    @PublishedBillingPeriod AS dbo.yyyymm,\r\n    @AgencyCodeOEC AS dbo.OECAgencyCode,\r\n    @OecFacilityNumber AS VARCHAR(MAX)\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID),  @CutOffBillingPeriod AS VARCHAR(6) = '200907';\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName = @spname,\r\n\t\t@StoredProcName = @spname,\r\n\t\t@RequestedBy = @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod = @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod = NULL,\r\n\t\t@prmAgency_ies = @AgencyCodeOEC,\r\n\t\t@prmFacilityNumber_s = @OecFacilityNumber,\r\n\t\t@prmStartingBillingPeriod = 201806,\r\n\t\t@prmEndingBillingPeriod = NULL\r\n\r\n    DECLARE @facilityData TABLE (OecFacilityNumber OECBuildingNumber, AgencyCodeOEC AgencyCodeOEC)\r\n    \r\n\tINSERT INTO @facilityData(OecFacilityNumber, AgencyCodeOEC)\r\n    SELECT DISTINCT OecFacilityNumber, AgencyCodeOEC\r\n    FROM Billing.uftn_TableGetOECFacilityNumberByAgencyHierarchyActiveAccounts(@AgencyCodeOEC, @OecFacilityNumber, @EmailAddress);\r\n\r\n\tDECLARE @ClosedAccountInd VARCHAR(4) = ' (C)';\r\n\r\n\tDECLARE @BillingPeriods AS VARCHAR(MAX);\r\n\tSELECT @BillingPeriods = COALESCE(@BillingPeriods + ', ','') + QUOTENAME(BillingPeriod)\r\n\tFROM (SELECT DISTINCT BillingPeriod FROM Published.TemporalAccountLevelRawDataForCurrentPeriod WHERE BillingPeriod >@CutOffBillingPeriod) AS B\r\n\tORDER BY B.BillingPeriod DESC;\r\n   \r\n\tSELECT  @PublishedBillingPeriod AS PublishedBillingPeriod,\r\n        TA.BillingPeriod,\r\n        TA.FiscalYear,\r\n        TA.BillingMonth,\r\n        TA.AgencyCodeOEC,\r\n        TA.AgencyName,\r\n        TA.OecFacilityNumber,\r\n        TA.FacilityName,\r\n        TA.Address1,\r\n        TA.CityPlanningBIN,\r\n        TA.Borough,\r\n        TA.[Block],\r\n        TA.LotNumber,\r\n        TA.CurrentAccountNumber,\r\n        CASE WHEN TA.Energytype = 'ELE' THEN 'Electricity Cost ($)'\r\n            WHEN TA.Energytype = 'GAS' THEN 'Gas Cost ($)'\r\n            WHEN TA.Energytype = 'STM' THEN 'Steam Cost ($)' END AS Cost,\r\n        ISNULL( CAST(TA.RevisedBilledAmount AS NUMERIC(18, 2)), 0) AS RevisedBilledAmount,\r\n\t\t@ClosedAccountInd AS ClosedAccountInd\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS TA\r\n        INNER JOIN @facilityData AS FD ON TA.OecFacilityNumber = FD.OecFacilityNumber AND TA.AgencyCodeOEC = FD.AgencyCodeOEC\r\n\tWHERE TA.EffectiveStartPeriod <= @PublishedBillingPeriod AND TA.EffectiveEndPeriod > @PublishedBillingPeriod AND TA.BillingPeriod >= @CutOffBillingPeriod    \r\n\tUNION ALL    \r\n\tSELECT publishedBillingPeriod,\r\n        BillingPeriod,\r\n        FiscalYear,\r\n        BillingMonth,\r\n        Agencycodeoec,\r\n        AgencyName,\r\n        oecfacilitynumber,\r\n        FacilityName,\r\n        Address1,\r\n        CityPlanningBIN,\r\n        Borough,\r\n        Block,\r\n        LotNumber,\r\n        CAST(NULL AS VARCHAR(19)) AS CurrentAccountNumber,\r\n        'Total Cost ($)' AS Cost,\r\n        ISNULL(CAST(RevisedBilledAmount AS NUMERIC(18, 2)), 0) AS RevisedBilledAmount,\r\n\t\t@ClosedAccountInd AS ClosedAccountInd\r\n\tFROM (SELECT @PublishedBillingPeriod AS PublishedBillingPeriod,\r\n\t\t\tTA2.BillingPeriod,\r\n\t\t\tTA2.FiscalYear,\r\n\t\t\tTA2.BillingMonth,\r\n\t\t\tTA2.AgencyCodeOEC,\r\n\t\t\tTA2.AgencyName,\r\n\t\t\tTA2.OecFacilityNumber,\r\n\t\t\tTA2.FacilityName,\r\n\t\t\tTA2.Address1,\r\n\t\t\tTA2.CityPlanningBIN,\r\n\t\t\tTA2.Borough,\r\n\t\t\tTA2.[Block],\r\n\t\t\tTA2.LotNumber,\r\n\t\t\tSUM(ISNULL(TA2.RevisedBilledAmount, 0)) AS RevisedBilledAmount\r\n\t\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS TA2\r\n\t\t\tINNER JOIN @facilityData AS FD ON TA2.OecFacilityNumber = FD.OecFacilityNumber AND TA2.AgencyCodeOEC = FD.AgencyCodeOEC\r\n\t\tWHERE TA2.EffectiveStartPeriod <= @PublishedBillingPeriod AND TA2.EffectiveEndPeriod > @PublishedBillingPeriod AND TA2.BillingPeriod >= @CutOffBillingPeriod    \r\n\t\tGROUP BY TA2.BillingPeriod,\r\n\t\t\tTA2.FiscalYear,\r\n\t\t\tTA2.BillingMonth,\r\n\t\t\tTA2.AgencyCodeOEC,\r\n\t\t\tTA2.AgencyName,\r\n\t\t\tTA2.OecFacilityNumber,\r\n\t\t\tTA2.FacilityName,\r\n\t\t\tTA2.Address1,\r\n\t\t\tTA2.CityPlanningBIN,\r\n\t\t\tTA2.Borough,\r\n\t\t\tTA2.[Block],\r\n\t\t\tTA2.LotNumber) AS TotalCost\r\n\tUNION ALL\r\n\tSELECT  @PublishedBillingPeriod AS PublishedBillingPeriod,\r\n        TA3.BillingPeriod,\r\n        TA3.FiscalYear,\r\n        TA3.BillingMonth,\r\n        TA3.AgencyCodeOEC,\r\n        TA3.AgencyName,\r\n        TA3.OecFacilityNumber,\r\n        TA3.FacilityName,\r\n        TA3.Address1,\r\n        TA3.CityPlanningBIN,\r\n        TA3.Borough,\r\n        TA3.[Block],\r\n        TA3.LotNumber,\r\n        TA3.CurrentAccountNumber,\r\n        CASE WHEN TA3.Energytype = 'ELE' THEN 'Electricity Demand (kW)' ELSE '' END AS Cost,\r\n        ISNULL(CAST(TA3.AccountDemandUsage AS NUMERIC(18, 2)), 0) AS AccountDemandUsage,\r\n\t\t@ClosedAccountInd AS ClosedAccountInd\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS TA3\r\n        INNER JOIN @facilityData AS FD ON TA3.OecFacilityNumber = FD.OecFacilityNumber AND TA3.AgencyCodeOEC = FD.AgencyCodeOEC\r\n\tWHERE TA3.EffectiveStartPeriod <= @PublishedBillingPeriod AND TA3.EffectiveEndPeriod > @PublishedBillingPeriod AND TA3.BillingPeriod >= @CutOffBillingPeriod    \r\n\tUNION ALL\r\n\tSELECT @PublishedBillingPeriod AS PublishedBillingPeriod,\r\n        TA4.BillingPeriod,\r\n        TA4.FiscalYear,\r\n        TA4.BillingMonth,\r\n        TA4.AgencyCodeOEC,\r\n        TA4.AgencyName,\r\n        TA4.OecFacilityNumber,\r\n        TA4.FacilityName,\r\n        TA4.Address1,\r\n        TA4.CityPlanningBIN,\r\n        TA4.Borough,\r\n        TA4.[Block],\r\n        TA4.LotNumber,\r\n        TA4.CurrentAccountNumber,\r\n        CASE WHEN TA4.Energytype = 'ELE' THEN 'Electricity Usage (kWh)'\r\n            WHEN TA4.Energytype = 'GAS' THEN 'Gas (Therms)'\r\n            WHEN TA4.Energytype = 'STM' THEN 'Steam (MLbs)' END AS Cost,\r\n        ISNULL(CAST(TA4.AccountEnergyUsage AS NUMERIC(18, 2)), 0) AS AccountEnergyUsage,\r\n\t\t@ClosedAccountInd AS ClosedAccountInd\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS TA4\r\n        INNER JOIN @facilityData AS FD ON TA4.OecFacilityNumber = FD.OecFacilityNumber AND TA4.AgencyCodeOEC = FD.AgencyCodeOEC\r\n\tWHERE TA4.EffectiveStartPeriod <= @PublishedBillingPeriod AND TA4.EffectiveEndPeriod > @PublishedBillingPeriod AND TA4.BillingPeriod >= @CutOffBillingPeriod    \r\n\tUNION ALL\r\n\tSELECT publishedBillingPeriod,\r\n        BillingPeriod,\r\n        FiscalYear,\r\n        BillingMonth,\r\n        Agencycodeoec,\r\n        AgencyName,\r\n        oecfacilitynumber,\r\n        FacilityName,\r\n        Address1,\r\n        CityPlanningBIN,\r\n        Borough,\r\n        [Block],\r\n        LotNumber,\r\n        CAST(NULL AS VARCHAR(19)) AS CurrentAccountNumber,\r\n        'Total Usage (mmBTUs)' AS Cost,\r\n        ISNULL(AccountEnergyUsage,0) AS AccountEnergyUsage,\r\n\t\t@ClosedAccountInd AS ClosedAccountInd\r\n\tFROM (SELECT @PublishedBillingPeriod AS PublishedBillingPeriod,\r\n\t\t\tTA5.BillingPeriod,\r\n\t\t\tTA5.FiscalYear,\r\n\t\t\tTA5.BillingMonth,\r\n\t\t\tTA5.AgencyCodeOEC,\r\n\t\t\tTA5.AgencyName,\r\n\t\t\tTA5.OecFacilityNumber,\r\n\t\t\tTA5.FacilityName,\r\n\t\t\tTA5.Address1,\r\n\t\t\tTA5.CityPlanningBIN,\r\n\t\t\tTA5.Borough,\r\n\t\t\tTA5.[Block],\r\n\t\t\tTA5.LotNumber,\r\n\t\t\tCAST(ROUND(SUM(CASE WHEN TA5.Energytype = 'ELE' THEN TA5.AccountEnergyUsage * 0.00341297\r\n                WHEN TA5.Energytype = 'GAS' THEN AccountEnergyUsage * 0.1\r\n                WHEN TA5.Energytype = 'STM' THEN AccountEnergyUsage * 1.11718000\r\n            END), 18, 2) AS NUMERIC(18, 2)) AS AccountEnergyUsage\r\n        FROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS TA5\r\n\t\t\tINNER JOIN @facilityData AS FD ON TA5.OecFacilityNumber = FD.OecFacilityNumber AND TA5.AgencyCodeOEC = FD.AgencyCodeOEC\r\n        WHERE TA5.EffectiveStartPeriod <= @PublishedBillingPeriod AND TA5.EffectiveEndPeriod > @PublishedBillingPeriod AND TA5.BillingPeriod >= @CutOffBillingPeriod    \r\n        GROUP BY TA5.BillingPeriod,\r\n            TA5.FiscalYear,\r\n            TA5.BillingMonth,\r\n            TA5.AgencyCodeOEC,\r\n            TA5.AgencyName,\r\n            TA5.OecFacilityNumber,\r\n            TA5.FacilityName,\r\n            TA5.Address1,\r\n            TA5.CityPlanningBIN,\r\n            TA5.Borough,\r\n            TA5.[Block],\r\n            TA5.LotNumber\r\n        ) AS TotalUsageinBTUs;\r\nEND;"
        }
      ]
    }
  ]
}