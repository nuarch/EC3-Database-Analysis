{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_EnergyChangeReportExcelExport",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_EnergyChangeReportExcelExport",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate an energy change report for facilities associated with a specific agency. It calculates and returns energy usage metrics, such as BTUs, KWH, Therms, and MLBS, for the current and previous fiscal years, along with their changes and percentage changes. The results are formatted for export, to Excel, as indicated by the procedure name."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including data retrieval, calculations, and formatting. It uses temporary tables, joins, and aggregate functions, which add to its complexity. However, it does not involve advanced SQL features like dynamic SQL or complex error handling, keeping it at a medium complexity level."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Email AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. Used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the report is generated. It is used to filter and calculate energy usage data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCode AS VARCHAR(13)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The code representing the agency for which the report is generated. It is used to filter data specific to the agency."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsAgencyUser AS BIT = 0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A flag indicating whether the user is an agency user. If set to 1, the procedure retrieves the current processing period from the "
                },
                {
                  "type": "text",
                  "text": "ApplicationTimeFrame",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Setup",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to avoid locking issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It retrieves the procedure name for logging purposes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If "
                },
                {
                  "type": "text",
                  "text": "@IsAgencyUser",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is true, the current processing period is fetched from the "
                },
                {
                  "type": "text",
                  "text": "ApplicationTimeFrame",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure logs the report request using "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Fiscal Year Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It calculates the current and previous fiscal years and their corresponding billing periods using helper functions."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It populates temporary tables with agency and facility data using joins and filters based on the agency code and account status."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Energy Usage Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It calculates energy usage metrics for the current and previous fiscal years and months, storing results in the "
                },
                {
                  "type": "text",
                  "text": "@FacilitySummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Change Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It updates the "
                },
                {
                  "type": "text",
                  "text": "@FacilitySummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table to calculate changes and percentage changes in energy usage."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Result Formatting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The final result set is selected, with formatted columns for export."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but leads to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporary tables can impact performance, especially if the data volume is large. Indexing these tables improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Aggregations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple joins and aggregations, which can be resource-intensive. Ensuring that the joined columns are indexed can help."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of scalar functions like "
                },
                {
                  "type": "text",
                  "text": "CalculateFiscalYear",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "CalcBillingPeriodYearPrior",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can slow down performance if not optimized."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level may lead to reading uncommitted data, which could result in inaccurate reports."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data grows, the performance of joins and aggregations may degrade. Monitoring and optimizing queries and indexes will be necessary."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the helper functions and tables return valid and consistent data. Any changes to these dependencies could affect the procedure's output."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include any security checks or validations on input parameters, which could be a risk if inputs are not sanitized or validated elsewhere."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_EnergyChangeReportExcelExport]\n(\r\n\t@Email AS VARCHAR(75)\r\n\t,@PublishedBillingPeriod AS BillingPeriod\t\r\n\t,@AgencyCode AS VARCHAR(13)\r\n\t,@IsAgencyUser AS BIT = 0\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\r\n\tIF (@IsAgencyUser = 1)\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = PublishedBillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\tEND;\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName = @spname,\r\n\t\t@StoredProcName = @spname,\r\n\t\t@RequestedBy = @Email,\r\n\t\t@prmPublishedBillingPeriod = @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod = NULL,\r\n\t\t@prmAgency_ies = @AgencyCode,\r\n\t\t@prmFacilityNumber_s = NULL,\r\n\t\t@prmStartingBillingPeriod = NULL,\r\n\t\t@prmEndingBillingPeriod = NULL\r\n\r\n\tDECLARE @FiscalYear AS VARCHAR(4), @PreviousFiscalYear AS VARCHAR(4), @MonthCurrentFY AS VARCHAR(6), @MonthPreviousFY AS VARCHAR(6);\r\n\t\r\n\tSELECT @FiscalYear = [dbo].[CalculateFiscalYear](@PublishedBillingPeriod),  @MonthPreviousFY = [dbo].[CalcBillingPeriodYearPrior](@PublishedBillingPeriod);\r\n\tSELECT @PreviousFiscalYear = CAST(CAST(@FiscalYear AS INT)  - 1 AS VARCHAR(4)), @MonthCurrentFY = @PublishedBillingPeriod;\r\n\r\n\tDECLARE @SelectedAgencies TABLE (AgencyDivisionSeqID seqid, AgencyCodeOEC AgencyCodeOEC, AgencyName VARCHAR(75));\r\n\tDECLARE @Facility TABLE (AgencyName VARCHAR(75),\r\n\t\tFacilitySeqId INT,\r\n\t\tOECFacilityID VARCHAR(7),\r\n\t\tFacilityName VARCHAR(100),\r\n\t\tFacilityAddress LongAddress,\r\n\t\tTotalSquareFootage SquareFootage,\r\n\t\tAgencyCodeOEC AgencyCodeOEC);\r\n\tDECLARE @FacilitySummary TABLE (FacilitySeqId INT,\r\n\t\tAgencyCodeOEC AgencyCodeOEC,\r\n\t\tBTUMonthCurrentFY NUMERIC(38, 6),\r\n\t\tBTUMonthPreviousFY NUMERIC(38, 6),\r\n\t\tBTUMonthChange DECIMAL(38, 3),\r\n\t\tBTUMonthPercentageChange FLOAT,\r\n\t\tBTUYTDCurentFY NUMERIC(38, 6),\r\n\t\tBTUYTDPreviousFY NUMERIC(38, 6),\r\n\t\tBTUYTDChange DECIMAL(38, 3),\r\n\t\tBTUYTDPercentageChange FLOAT,\r\n\t\tKWHMonthCurrentFY INT,\r\n\t\tKWHMonthPreviousFY INT,\r\n\t\tKWHMonthChange INT,\r\n\t\tKWHYTDCurrentFY INT,\r\n\t\tKWHYTDPreviousFY INT,\r\n\t\tKWHYTDChange INT,\r\n\t\tThermsMonthCurrentFY INT,\r\n\t\tThermsMonthPreviousFY INT,\r\n\t\tThermsMonthChange INT,\r\n\t\tThermsYTDCurrentFY INT,\r\n\t\tThermsYTDPreviousFY INT,\r\n\t\tThermsYTDChange INT,\r\n\t\tMLBSMonthCurrentFY INT,\r\n\t\tMLBSMonthPreviousFY INT,\r\n\t\tMLBSMonthChange INT,\r\n\t\tMLBSYTDCurrentFY INT,\r\n\t\tMLBSYTDPreviousFY INT,\r\n\t\tMLBSYTDChange INT);\r\n\r\n\tINSERT INTO @SelectedAgencies(AgencyDivisionSeqID, AgencyCodeOEC, AgencyName)\r\n\tSELECT DISTINCT a.AgencyDivisionSeqID, A.AgencyCodeOEC, A.AgencyName\r\n\tFROM Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCode, @Email) AS A;\r\n\r\n\tINSERT INTO @Facility\r\n\t\t(AgencyName,\r\n\t\tFacilitySeqId,\r\n\t\tOECFacilityID,\r\n\t\tFacilityName,\r\n\t\tFacilityAddress,\r\n\t\tTotalSquareFootage,\r\n\t\tAgencyCodeOEC)\r\n\tSELECT DISTINCT SA.AgencyName,\r\n\t\tF.FacilitySeqid,\r\n\t\tF.OecFacilityNumber,\r\n\t\tF.FacilityName,\r\n\t\tF.Address1,\r\n\t\tF.TotalSquareFootage,\r\n\t\tSA.AgencyCodeOEC\r\n\tFROM @SelectedAgencies AS SA\r\n\t\tINNER JOIN Billing.Account AS A ON A.AgencyAccount = SA.AgencyDivisionSeqid\r\n\t\tINNER JOIN Billing.Facility AS F ON A.FacilityAccount = F.FacilitySeqid\r\n\tWHERE A.AccountStatus IN ('AC', '46', 'UA');\r\n\r\n\tINSERT INTO @FacilitySummary\r\n\t\t(FacilitySeqId,\r\n\t\tAgencyCodeOEC,\r\n\t\tBTUMonthCurrentFY,\r\n\t\tBTUMonthPreviousFY,\r\n\t\tBTUYTDCurentFY,\r\n\t\tBTUYTDPreviousFY,\r\n\t\tKWHMonthCurrentFY,\r\n\t\tKWHMonthPreviousFY,\r\n\t\tKWHYTDCurrentFY,\r\n\t\tKWHYTDPreviousFY,\r\n\t\tThermsMonthCurrentFY,\r\n\t\tThermsMonthPreviousFY,\r\n\t\tThermsYTDCurrentFY,\r\n\t\tThermsYTDPreviousFY,\r\n\t\tMLBSMonthCurrentFY,\r\n\t\tMLBSMonthPreviousFY,\r\n\t\tMLBSYTDCurrentFY,\r\n\t\tMLBSYTDPreviousFY)\r\n\tSELECT F.FacilitySeqId,\r\n\t\tF.AgencyCodeOEC,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY THEN TAS.BTU ELSE 0 END) AS BTUMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY THEN TAS.BTU ELSE 0 END) AS BTUMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear THEN TAS.BTU ELSE 0 END) AS BTUYTDCurentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY THEN TAS.BTU ELSE 0 END) AS BTUYTDPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY  AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHYTDCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHYTDPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsYTDCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsYTDPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSYTDCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSYTDPreviousFY\r\n\tFROM @Facility AS F INNER JOIN Published.TemporalAccountLevelSummaryByFacility AS TAS ON TAS.OecFacilityNumber = F.OECFacilityID AND TAS.AgencyCodeOEC = F.AgencyCodeOEC\r\n\tWHERE TAS.FiscalYear IN (@FiscalYear, @PreviousFiscalYear) AND TAS.EffectiveStartPeriod <= @PublishedBillingPeriod AND TAS.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\tGROUP BY F.FacilitySeqId, F.AgencyCodeOEC;\r\n\r\n\t-- calculate change column\r\n\tUPDATE  @FacilitySummary\r\n\tSET BTUMonthChange = BTUMonthCurrentFY - BTUMonthPreviousFY,\r\n\t\tBTUMonthPercentageChange = CAST(BTUMonthCurrentFY - BTUMonthPreviousFY AS FLOAT) / NULLIF(BTUMonthPreviousFY, 0),\r\n\t\tBTUYTDChange = BTUYTDCurentFY - BTUYTDPreviousFY,\r\n\t\tBTUYTDPercentageChange = CAST(BTUYTDCurentFY - BTUYTDPreviousFY AS FLOAT) / NULLIF(BTUYTDPreviousFY, 0),\r\n\t\tKWHMonthChange = KWHMonthCurrentFY - KWHMonthPreviousFY,\r\n\t\tKWHYTDChange = KWHYTDCurrentFY - KWHYTDPreviousFY,\r\n\t\tThermsMonthChange = ThermsMonthCurrentFY - ThermsMonthPreviousFY,\r\n\t\tThermsYTDChange =ThermsYTDCurrentFY - ThermsYTDPreviousFY,\r\n\t\tMLBSMonthChange = MLBSMonthCurrentFY - MLBSMonthPreviousFY,\r\n\t\tMLBSYTDChange = MLBSYTDCurrentFY - MLBSYTDPreviousFY;\r\n\r\n\tSELECT F.AgencyName,\r\n\t\tF.OECFacilityID AS [OEC ID],\r\n\t\tF.FacilityName AS [Facility Name],\r\n\t\tF.FacilityAddress AS [Facility Address],\r\n\t\tF.TotalSquareFootage,\r\n\t\tF.AgencyCodeOEC,\r\n\t\tFS.BTUMonthCurrentFY AS 'mmBTUs, [month] Current FY',\r\n\t\tFS.BTUMonthPreviousFY AS 'mmBTUs, [month] Previous FY',\r\n\t\tFS.BTUMonthChange AS [mmBTUs change, month],\r\n\t\tFORMAT(FS.BTUMonthPercentageChange, '0.000%') AS [mmBTUs % change, month],\r\n\t\tFS.BTUYTDCurentFY AS [mmBTUs, YTD Current FY],\r\n\t\tFS.BTUYTDPreviousFY AS [mmBTUs, YTD Previous FY],\r\n\t\tFS.BTUYTDChange AS [mmBTUs change, YTD],\r\n\t\tFORMAT(FS.BTUYTDPercentageChange, '0.000%') AS [mmBTUs % change, YTD],\r\n\t\tFS.KWHMonthCurrentFY AS 'KWH, [month] Current FY',\r\n\t\tFS.KWHMonthPreviousFY AS 'KWH, [month] Previous FY',\r\n\t\tFS.KWHMonthChange AS [KWH change, month],\r\n\t\tFS.KWHYTDCurrentFY AS [KWH, Fiscal YTD Current FY],\r\n\t\tFS.KWHYTDPreviousFY AS [KWH, YTD, PreviousFY],\r\n\t\tFS.KWHYTDChange AS [KWH change, YTD],\r\n\t\tFS.ThermsMonthCurrentFY AS 'THERMS, [month] Current FY',\r\n\t\tFS.ThermsMonthPreviousFY AS 'THERMS, [month] Previous FY',\r\n\t\tFS.ThermsMonthChange AS [THERMS change, month],\r\n\t\tFS.ThermsYTDCurrentFY AS [THERMS, Fiscal YTD Current FY],\r\n\t\tFS.ThermsYTDPreviousFY AS [THERMS, Fiscal YTD Previous FY],\r\n\t\tFS.ThermsYTDChange AS [THERMS change, Yr-to-Date],\r\n\t\tFS.MLBSMonthCurrentFY AS 'MLBS, [month] Current FY',\r\n\t\tFS.MLBSMonthPreviousFY AS 'MLBS, [month] Previous FY',\r\n\t\tFS.MLBSMonthChange AS [MLBS Month Change],\r\n\t\tFS.MLBSYTDCurrentFY AS [MLBS, Fiscal YTD Current FY],\r\n\t\tFS.MLBSYTDPreviousFY AS [MLBS, Fiscal YTD Previous FY],\r\n\t\tFS.MLBSYTDChange AS [MLBS Change, Fiscal YTD]\r\n\tFROM @FacilitySummary AS FS\r\n\t\tINNER JOIN @Facility AS F ON FS.FacilitySeqId = F.FacilitySeqId AND FS.AgencyCodeOEC = F.AgencyCodeOEC;\r\nEND;"
        }
      ]
    }
  ]
}