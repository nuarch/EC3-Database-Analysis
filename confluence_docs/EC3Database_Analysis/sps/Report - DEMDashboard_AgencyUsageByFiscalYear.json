{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "DEMDashboard_AgencyUsageByFiscalYear",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "DEMDashboard_AgencyUsageByFiscalYear",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report on energy usage by agency for a specific fiscal year, comparing it with the previous fiscal year. It retrieves data from the "
        },
        {
          "type": "text",
          "text": "Published.TemporalAccountLevelSummaryByAgency",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " and "
        },
        {
          "type": "text",
          "text": "Published.TemporalAccountLevelSummaryByCityWide",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " tables. The procedure calculates various metrics such as energy usage, CO2 emissions, and their changes from the previous year, as well as billing amounts and energy usage statistics."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple subqueries, joins, and calculations, which add to its complexity. It aggregates data, performs conditional calculations, and handles potential null values, making it moderately complex."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "This stored procedure does not take any input parameters. It relies on the internal logic to determine the latest billing period and uses hardcoded values (e.g., fiscal year 2008) for certain calculations."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Set Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", allowing it to read uncommitted data, which can improve performance but may lead to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine Latest Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates the latest billing period by selecting the maximum "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " from the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalAccountLevelSummaryByCityWide",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Main Query",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The core of the procedure is a query that:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Aggregates energy usage, CO2 emissions, and billing data by agency, fiscal year, and energy type."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Joins the current fiscal year's data ("
                        },
                        {
                          "type": "text",
                          "text": "IL",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ") with the previous fiscal year's data ("
                        },
                        {
                          "type": "text",
                          "text": "IR",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ") to calculate changes in energy usage and CO2 emissions."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses conditional logic to handle null values and prevent division by zero errors."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Orders the results by agency code and energy type."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking overhead but may result in reading uncommitted or inconsistent data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregations and Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple aggregations and joins, which can be resource-intensive, especially on large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexes",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensuring appropriate indexing on the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalAccountLevelSummaryByAgency",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalAccountLevelSummaryByCityWide",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " tables can help improve query performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to dirty reads, where the data read might not be committed and could change, leading to inaccurate reports."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses a hardcoded fiscal year (2008) for base agency calculations, which may not be flexible or applicable in all scenarios."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Null Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While the procedure handles null values, there is a risk of unexpected results if the data contains unexpected nulls or zeros."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data grows, the performance of the procedure may degrade due to the complexity of the joins and aggregations. Regular monitoring and optimization may be required."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[DEMDashboard_AgencyUsageByFiscalYear]\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @LatestBillingPeriod AS VARCHAR(6);\r\n\t\r\n\tSELECT\r\n\t\t@LatestBillingPeriod = MAX(BillingPeriod)\r\n\tFROM\r\n\t\tPublished.TemporalAccountLevelSummaryByCityWide;\r\n\r\n\tSELECT\r\n\t\tIL.AgencyCodeOEC,\r\n\t\tIL.FiscalYear,\r\n\t\tIL.EnergyUsage,\r\n\t\tISNULL(IR.EnergyUsage, 0) AS EnergyUsageLastYear,\r\n\t\tISNULL(CASE WHEN IL.EnergyUsage IS NULL OR IR.EnergyUsage = 0 THEN 0 ELSE (IL.EnergyUsage/IR.EnergyUsage)-1 END, 0) AS EnergyUsageChange,\r\n\t\tIL.MaxEnergyUsage,\r\n\t\tIL.AvgEnergyUsage,\r\n\t\tIL.BilledAmount,\r\n\t\tIL.CO2,\r\n\t\tISNULL(IR.CO2, 0) AS CO2LastYear,\r\n\t\tISNULL(CASE WHEN IL.CO2 IS NULL OR IR.CO2 = 0 THEN 0 ELSE (IL.CO2/IR.CO2) - 1 END, 0) AS CO2eChange,\r\n\t\tIL.EnergyType,\r\n\t\tIL.BaseAgencyEnergyUsage,\r\n\t\tIL.BaseAgencyCO2\r\n\tFROM\r\n\t\t(SELECT\r\n\t\t\tTA.AgencyCodeOEC, TA.FiscalYear,\r\n\t\t\tISNULL(SUM(CAST(TA.BTU AS DECIMAL)), 0) AS EnergyUsage,\r\n\t\t\tISNULL(SUM(CAST(TA.BTULastYear AS DECIMAL)), 0) AS EnergyUsageLastYear,\r\n\t\t\tISNULL(MAX(CAST(DemandUsage AS DECIMAL)), 0) * 0.001 AS MaxEnergyUsage,\r\n\t\t\tISNULL(AVG(CAST(DemandUsage AS DECIMAL)), 0) * 0.001 AS AvgEnergyUsage,\r\n\t\t\tISNULL(SUM(BilledAmount), 0) AS BilledAmount,\r\n\t\t\tISNULL(SUM(TA.CO2), 0) AS CO2,\r\n\t\t\tTA.EnergyType,\r\n\t\t\tMAX(CJ.BaseAgencyEnergyUsage) AS BaseAgencyEnergyUsage,\r\n\t\t\tMAX(CJ.BaseAgencyCO2) AS BaseAgencyCO2\r\n\t\tFROM\r\n\t\t\tPublished.TemporalAccountLevelSummaryByAgency AS TA\r\n\t\t\tINNER JOIN (SELECT\r\n\t\t\t\t\tISNULL(SUM(CAST(BTU AS DECIMAL)), 0) AS BaseAgencyEnergyUsage,\r\n\t\t\t\t\tISNULL(SUM(CO2), 0) AS BaseAgencyCO2,\r\n\t\t\t\t\tEnergyType,\r\n\t\t\t\t\tAgencyCodeOEC\r\n\t\t\t\tFROM\r\n\t\t\t\t\tPublished.TemporalAccountLevelSummaryByAgency\r\n\t\t\t\tWHERE\r\n\t\t\t\t\tEffectiveStartPeriod <= @LatestBillingPeriod\r\n\t\t\t\t\tAND EffectiveEndPeriod > @LatestBillingPeriod\r\n\t\t\t\t\tAND FiscalYear = 2008\r\n\t\t\t\tGROUP BY\r\n\t\t\t\t\tAgencyCodeOEC,\r\n\t\t\t\t\tFiscalYear,\r\n\t\t\t\t\tEnergyType) AS CJ\r\n\t\t\tON CJ.EnergyType = TA.EnergyType AND CJ.AgencyCodeOEC = TA.AgencyCodeOEC\r\n\t\tWHERE\r\n\t\t\tEffectiveStartPeriod <= @LatestBillingPeriod\r\n\t\t\tAND EffectiveEndPeriod > @LatestBillingPeriod\r\n\t\tGROUP BY\r\n\t\t\tTA.AgencyCodeOEC,\r\n\t\t\tTA.FiscalYear,\r\n\t\t\tTA.EnergyType) AS IL\r\n\t\tLEFT JOIN (SELECT\r\n\t\t\t\tISNULL(SUM(I.CO2), 0) AS CO2,\r\n\t\t\t\tISNULL(SUM(CAST(I.BTU AS DECIMAL)), 0) AS EnergyUsage,\r\n\t\t\t\tI.FiscalYear,\r\n\t\t\t\tI.EnergyType,\r\n\t\t\t\tI.AgencyCodeOEC\r\n\t\t\tFROM\r\n\t\t\t\tPublished.TemporalAccountLevelSummaryByAgency AS I\r\n\t\t\tWHERE\r\n\t\t\t\tI.EffectiveStartPeriod <= @LatestBillingPeriod\r\n\t\t\t\tAND I.EffectiveEndPeriod > @LatestBillingPeriod\r\n\t\t\tGROUP BY\r\n\t\t\t\tI.FiscalYear,\r\n\t\t\t\tI.EnergyType,\r\n\t\t\t\tI.AgencyCodeOEC) AS IR\r\n\t\t\tON IL.AgencyCodeOEC = IR.AgencyCodeOEC\r\n\t\t\t\tAND IL.EnergyType = IR.EnergyType\r\n\t\t\t\tAND CAST(IL.FiscalYear AS INT) = CAST(IR.FiscalYear AS INT) + 1\r\n\tORDER BY\r\n\t\tIL.AgencyCodeOEC,\r\n\t\tIL.EnergyType;\r\nEND;"
        }
      ]
    }
  ]
}