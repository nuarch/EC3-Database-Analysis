{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Budget",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Report_BudgetVersusUsageAndRateBreakDown",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Report_BudgetVersusUsageAndRateBreakDown",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report comparing budgeted versus actual energy usage and expenditures. It processes data at different levels of granularity (citywide, funding source, or agency) based on the input parameters. The procedure aggregates and calculates various financial metrics, such as budget rates, actual rates, and surpluses, and organizes the results into a structured format for reporting purposes."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure is complex due to its extensive use of conditional logic, multiple table variables, aggregation operations, and calculations. It also involves several updates and inserts, which require careful handling of data integrity and performance."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Used to filter data based on user-specific access or preferences."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the agency code for which the report is generated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod AS BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Defines the billing period for which the data is relevant."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@InformationGroupLevel AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Determines the level of detail in the report (1 for citywide, 2 for funding source, 3 for agency)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Two table variables, "
                },
                {
                  "type": "text",
                  "text": "@AgencyData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "@QueryResult",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", are declared to store intermediate and final results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Depending on the "
                },
                {
                  "type": "text",
                  "text": "@InformationGroupLevel",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", data is inserted into "
                },
                {
                  "type": "text",
                  "text": "@AgencyData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " either directly or with aggregation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Special Case Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Adjustments are made for specific agency codes (e.g., '856090' is excluded, and its budget is added to '856001')."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Various financial metrics are calculated, including budget and actual rates, total surplus, and different types of surpluses (rate, usage, combined)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Result Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Data is aggregated based on the "
                },
                {
                  "type": "text",
                  "text": "@InformationGroupLevel",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", with additional calculations for citywide or funding group levels."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hierarchy Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A loop updates the results to account for hierarchical relationships between expenditure types."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Selection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure concludes by selecting and ordering the results for output."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but may lead to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple aggregations and joins, which can be resource-intensive, especially on large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensuring appropriate indexing on the tables involved, particularly on join and group-by columns, can enhance performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Variables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Extensive use of table variables may impact memory usage and performance; consider using temporary tables if necessary."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " may lead to inconsistent data if concurrent transactions modify the data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity and number of operations may not scale well with large datasets or high concurrency."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or incomplete transactions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specific agency codes ('856090', '856001') are hardcoded, which reduces flexibility and may require updates if business rules change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity of the procedure makes it challenging to maintain and understand, increasing the risk of errors during modifications."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Budget].[usp_Report_BudgetVersusUsageAndRateBreakDown]\n(\r\n\t@EmailAddress AS emailaddr,\r\n\t@AgencyCodeOEC AS VARCHAR(MAX),\r\n\t@BillingPeriod AS BillingPeriod,\r\n\t@InformationGroupLevel AS INT -- 1:citywide;2:funding source;3:agency\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\t DECLARE @AgencyData TABLE\r\n\t\t(AgencyCodeOEC AgencyCodeOEC,\r\n\t\tAgencyName ldesc,\r\n\t\tCurrentMonthBudgetEnergyUsage FLOAT,\r\n\t\tCurrentMonthBudgetEnergyDollars MONEY,\r\n\t\tCurrentMonthActualDollars MONEY,\r\n\t\tCurrentMonthActualUsage FLOAT,\r\n\t\tIsSourceOfFundingGroupData VARCHAR(1),\r\n\t\tBudgetVersusExpenditureTypeSeqID INT,\r\n\t\tCurrentMonthPaidAdjustment MONEY,\r\n\t\tIsHidden VARCHAR(1),\r\n\t\tBudgetRate FLOAT,\r\n\t\tActualRate FLOAT,\r\n\t\tTotalSurplus MONEY,\r\n\t\tAdjustmentSurplus MONEY,\r\n\t\tCurrentMonthSurplus FLOAT,\r\n\t\tRateSurplus FLOAT,\r\n\t\tUsageSurplus FLOAT,\r\n\t\tCombinedSurplus FLOAT,\r\n\t\tAgencyFundingSeqID INT);\r\n\r\n\tDECLARE @QueryResult TABLE\r\n\t\t(GroupDescription VARCHAR(75),\r\n\t\texpenditureTypeID INT,\r\n\t\texpenditureType VARCHAR(75),\r\n\t\tCurrentMonthBudgetEnergyUsage INT,\r\n\t\tCurrentMonthBudgetEnergyDollars MONEY,\r\n\t\tCurrentMonthActualDollars MONEY,\r\n\t\tCurrentMonthActualUsage INT,\r\n\t\tBudgetRate FLOAT,\r\n\t\tActualRate FLOAT,\r\n\t\tTotalSurplus MONEY,\r\n\t\tAdjustmentSurplus MONEY,\r\n\t\tCurrentMonthSurplus FLOAT,\r\n\t\tRateSurplus FLOAT,\r\n\t\tUsageSurplus FLOAT,\r\n\t\tCombinedSurplus FLOAT,\r\n\t\tIngoreEnergySum VARCHAR(1),\r\n\t\tInformationLevel INT); -- 1:citywide;2:funding source;3:agency\r\n\t\r\n\t/*\r\n\t1. insert agency data into table variable\r\n\t2. handle special case\r\n\t3. insert data into final result table\r\n\t*/\r\n\t-- 1. insert agency data into table variable\r\n\tIF(@InformationGroupLevel <3)\r\n\tBEGIN\r\n\t\tINSERT INTO @AgencyData\r\n\t\t\t(AgencyCodeOEC,\r\n\t\t\tAgencyName,\r\n\t\t\tCurrentMonthBudgetEnergyUsage,\r\n\t\t\tCurrentMonthBudgetEnergyDollars,\r\n\t\t\tCurrentMonthActualDollars,\r\n\t\t\tCurrentMonthActualUsage,\r\n\t\t\tIsSourceOfFundingGroupData,\r\n\t\t\tBudgetVersusExpenditureTypeSeqID,\r\n\t\t\tCurrentMonthPaidAdjustment,\r\n\t\t\tIsHidden,\r\n\t\t\tAdjustmentSurplus,\r\n\t\t\tAgencyFundingSeqID)\r\n\t\tSELECT B.AgencyCodeOEC,\r\n\t\t\tB.AgencyName,\r\n\t\t\tB.CurrentMonthBudgetEnergyUsage,\r\n\t\t\tB.CurrentMonthBudgetEnergyDollars,\r\n\t\t\tB.CurrentMonthActualDollars,\r\n\t\t\tB.CurrentMonthActualUsage,\r\n\t\t\tB.IsSourceOfFundingGroupData,\r\n\t\t\tB.BudgetVersusExpenditureTypeSeqID,\r\n\t\t\tB.CurrentMonthPaidAdjustment,\r\n\t\t\tBD.IsHidden,\r\n\t\t\tB.AdjustmentSurplus,\r\n\t\t\tBD.AgencyFundingSeqid\r\n\t\tFROM Budget.BudgetVersusActualExpendituresByAgencyAndServiceClassification AS B\r\n\t\t\tLEFT JOIN Budget.uftn_BudgetAgencyDivision(@EmailAddress, @AgencyCodeOEC, 'N') AS BD\r\n\t\t\t\tON B.AgencyCodeOEC = BD.AgencyCodeOEC\r\n\t\tWHERE B.BillingPeriod = @BillingPeriod\r\n\t\t\tAND B.PublishedBillingPeriod = @BillingPeriod\r\n\t\tORDER BY BD.AgencyOECL1,\r\n\t\t\tBD.AgencyOECL2,\r\n\t\t\tBD.AgencyOECL3;\r\n\tEND;\r\n\tELSE\r\n\tBEGIN\r\n\t\tINSERT INTO @AgencyData\r\n\t\t\t(AgencyCodeOEC,\r\n\t\t\tAgencyName,\r\n\t\t\tCurrentMonthBudgetEnergyUsage,\r\n\t\t\tCurrentMonthBudgetEnergyDollars,\r\n\t\t\tCurrentMonthActualDollars,\r\n\t\t\tCurrentMonthActualUsage,\r\n\t\t\tIsSourceOfFundingGroupData,\r\n\t\t\tBudgetVersusExpenditureTypeSeqID,\r\n\t\t\tCurrentMonthPaidAdjustment,\r\n\t\t\tIsHidden,\r\n\t\t\tAdjustmentSurplus,\r\n\t\t\tAgencyFundingSeqID)\r\n\t\tSELECT B.AgencyCodeOEC,\r\n\t\t\tB.AgencyName,\r\n\t\t\tSUM(B.CurrentMonthBudgetEnergyUsage),\r\n\t\t\tSUM(B.CurrentMonthBudgetEnergyDollars),\r\n\t\t\tSUM(B.CurrentMonthActualDollars),\r\n\t\t\tSUM(B.CurrentMonthActualUsage),\r\n\t\t\tNULL,\r\n\t\t\tB.BudgetVersusExpenditureTypeSeqID,\r\n\t\t\tSUM(B.CurrentMonthPaidAdjustment),\r\n\t\t\tBD.IsHidden,\r\n\t\t\tSUM(B.AdjustmentSurplus),\r\n\t\t\tBD.AgencyFundingSeqid\r\n\t\tFROM Budget.BudgetVersusActualExpendituresByAgencyAndServiceClassification AS B\r\n\t\t\tLEFT JOIN Budget.uftn_BudgetAgencyDivision(@EmailAddress, @AgencyCodeOEC, 'N') AS BD ON B.AgencyCodeOEC = BD.AgencyCodeOEC\r\n\t\tWHERE B.BillingPeriod = @BillingPeriod\r\n\t\t\tAND B.PublishedBillingPeriod = @BillingPeriod\r\n\t\tGROUP BY B.AgencyCodeOEC,\r\n\t\t\tB.AgencyName,\r\n\t\t\tB.BudgetVersusExpenditureTypeSeqID,\r\n\t\t\tBD.IsHidden,\r\n\t\t\tBD.AgencyFundingSeqid;\r\n\tEND;\r\n\r\n\t-- 2. handle special case\r\n\t/*\r\n\tState Funds should be excluded from this report.\r\n\tThe budgeted quantities for State Funds should be added to 856001.\r\n\t*/\r\n\tUPDATE data856001\r\n\tSET CurrentMonthBudgetEnergyUsage = ISNULL(CurrentMonthBudgetEnergyUsage, 0)\r\n\t\t+ (SELECT ISNULL(SUM(CurrentMonthBudgetEnergyUsage), 0)\r\n\t\t\t\tFROM @AgencyData AS data856090\r\n\t\t\t\tWHERE AgencyCodeOEC = '856090' AND data856090.BudgetVersusExpenditureTypeSeqID = data856001.BudgetVersusExpenditureTypeSeqID\r\n\t\t\t  ),\r\n\t\t\tCurrentMonthBudgetEnergyDollars = ISNULL(CurrentMonthBudgetEnergyDollars, 0)\r\n\t\t\t+ ( SELECT  ISNULL(SUM(CurrentMonthBudgetEnergyDollars), 0)\r\n\t\t\t\tFROM @AgencyData AS data856090\r\n\t\t\t\tWHERE   AgencyCodeOEC = '856090'\r\n\t\t\t\t\t\tAND data856090.BudgetVersusExpenditureTypeSeqID = data856001.BudgetVersusExpenditureTypeSeqID\r\n\t\t\t  )\r\n\tFROM @AgencyData AS data856001\r\n\tWHERE data856001.AgencyCodeOEC = '856001';\r\n\t\r\n\tDELETE @AgencyData WHERE AgencyCodeOEC = '856090';\t\r\n\t\r\n\tUPDATE @AgencyData\r\n\tSET BudgetRate = budget.CalcBudgetRate(CurrentMonthBudgetEnergyDollars, CurrentMonthBudgetEnergyUsage),\r\n\t\tActualRate = budget.CalcActualRate(CurrentMonthActualDollars, CurrentMonthPaidAdjustment,  CurrentMonthActualUsage),\r\n\t\tTotalSurplus = ISNULL(CurrentMonthBudgetEnergyDollars, 0) - ISNULL(CurrentMonthActualDollars, 0)\r\n\t\r\n\tUPDATE @AgencyData\r\n\tSET CurrentMonthSurplus = TotalSurplus - AdjustmentSurplus\r\n\t\r\n\tUPDATE \t@AgencyData\r\n\tSET RateSurplus = budget.CalcBudgetRateSurplus(BudgetRate, ActualRate, CurrentMonthBudgetEnergyUsage),\r\n\t\tUsageSurplus = budget.CalcBudgetUsageSurplus(CurrentMonthBudgetEnergyUsage, CurrentMonthActualUsage, BudgetRate)\r\n\t\r\n\tUPDATE \t@AgencyData\r\n\tSET CombinedSurplus = CurrentMonthSurplus - (RateSurplus + UsageSurplus)\r\n\t\r\n\tIF(@InformationGroupLevel IN (1, 2)) \r\n\tBEGIN\r\n\t\t-- store funding group level information\r\n\t\tINSERT INTO @QueryResult\r\n\t\t\t(GroupDescription,\r\n\t\t\texpenditureTypeID,\r\n\t\t\texpenditureType,\r\n\t\t\tCurrentMonthBudgetEnergyUsage,\r\n\t\t\tCurrentMonthBudgetEnergyDollars,\r\n\t\t\tCurrentMonthActualDollars,\r\n\t\t\tCurrentMonthActualUsage,\r\n\t\t\tBudgetRate,\r\n\t\t\tActualRate,\r\n\t\t\tTotalSurplus,\r\n\t\t\tAdjustmentSurplus,\r\n\t\t\tCurrentMonthSurplus,\r\n\t\t\tIngoreEnergySum,\r\n\t\t\tInformationLevel)\t\r\n\t\tSELECT MAX(AF.fundingSourceDescription),\r\n\t\t\tB.BudgetVersusExpenditureTypeSeqid,\r\n\t\t\tMAX(B.[Description]) AS expenditureType,\r\n\t\t\tSUM(Q.CurrentMonthBudgetEnergyUsage),\r\n\t\t\tSUM(Q.CurrentMonthBudgetEnergyDollars),\r\n\t\t\tSUM(Q.CurrentMonthActualDollars),\r\n\t\t\tSUM(Q.CurrentMonthActualUsage),\r\n\t\t\tbudget.CalcBudgetRate(SUM(Q.CurrentMonthBudgetEnergyDollars), SUM(Q.CurrentMonthBudgetEnergyUsage)) AS budgetRate,\r\n\t\t\tbudget.CalcActualRate(SUM(Q.CurrentMonthActualDollars), SUM(Q.CurrentMonthPaidAdjustment), SUM(Q.CurrentMonthActualUsage)) AS actualRate,\r\n\t\t\tSUM(Q.TotalSurplus),\r\n\t\t\tSUM(Q.AdjustmentSurplus),\r\n\t\t\tSUM(Q.CurrentMonthSurplus),\r\n\t\t\tMAX(B.IngoreEnergySum),\r\n\t\t\t2\r\n\t\tFROM @AgencyData AS Q\r\n\t\t\tINNER JOIN Budget.BudgetVersusExpenditureType AS B\r\n\t\t\t\tON Q.BudgetVersusExpenditureTypeSeqID = B.BudgetVersusExpenditureTypeSeqid\r\n\t\t\tINNER JOIN Billing.AgencyFunding AS AF ON AF.AgencyFundingSeqid = Q.AgencyFundingSeqid\r\n\t\tWHERE Q.IsSourceOfFundingGroupData = 'Y' AND B.isHidden = 'N'\r\n\t\tGROUP BY AF.AgencyFundingSeqid, \r\n\t\t\tB.BudgetVersusExpenditureTypeSeqid, \r\n\t\t\tB.DisplayOrderIndex\r\n\t\tORDER BY AF.AgencyFundingSeqid, \r\n\t\t\tB.DisplayOrderIndex;\r\n\t\t\r\n\t\tUPDATE \t@QueryResult\r\n\t\tSET RateSurplus = budget.CalcBudgetRateSurplus(BudgetRate, ActualRate, CurrentMonthBudgetEnergyUsage),\r\n\t\t\tUsageSurplus = budget.CalcBudgetUsageSurplus(CurrentMonthBudgetEnergyUsage, CurrentMonthActualUsage, BudgetRate)\r\n\t\t\r\n\t\tUPDATE @QueryResult\r\n\t\tSET CurrentMonthSurplus = TotalSurplus - AdjustmentSurplus\r\n\t\t\r\n\t\tUPDATE \t@QueryResult\r\n\t\tSET CombinedSurplus = CurrentMonthSurplus - (RateSurplus + UsageSurplus)\r\n\t\t\r\n\t\tIF(@InformationGroupLevel = 1) -- citywide\r\n\t\tBEGIN\r\n\t\t\t-- method 1 aggregate \r\n\t\t\tINSERT INTO @QueryResult\r\n\t\t\t\t(GroupDescription,\r\n\t\t\t\texpenditureTypeID,\r\n\t\t\t\texpenditureType,\r\n\t\t\t\tCurrentMonthBudgetEnergyUsage,\r\n\t\t\t\tCurrentMonthBudgetEnergyDollars,\r\n\t\t\t\tCurrentMonthActualDollars,\r\n\t\t\t\tCurrentMonthActualUsage,\r\n\t\t\t\tBudgetRate,\r\n\t\t\t\tActualRate,\r\n\t\t\t\tTotalSurplus,\r\n\t\t\t\tAdjustmentSurplus,\r\n\t\t\t\tCurrentMonthSurplus,\r\n\t\t\t\tRateSurplus,\r\n\t\t\t\tUsageSurplus,\r\n\t\t\t\tCombinedSurplus,\r\n\t\t\t\tInformationLevel,\r\n\t\t\t\tIngoreEnergySum)\r\n\t\t\tSELECT 'Citywide',\r\n\t\t\t\tQ.expenditureTypeID,\r\n\t\t\t\tMAX(Q.expenditureType) expenditureType,\r\n\t\t\t\tSUM(Q.CurrentMonthBudgetEnergyUsage),\r\n\t\t\t\tSUM(Q.CurrentMonthBudgetEnergyDollars),\r\n\t\t\t\tSUM(Q.CurrentMonthActualDollars),\r\n\t\t\t\tSUM(Q.CurrentMonthActualUsage),\r\n\t\t\t\tbudget.CalcBudgetRate(SUM(Q.CurrentMonthBudgetEnergyDollars), SUM(Q.CurrentMonthBudgetEnergyUsage)) AS budgetRate,\r\n\t\t\t\tbudget.CalcActualRate(SUM(Q.CurrentMonthActualDollars), -1 * SUM(Q.AdjustmentSurplus), SUM(Q.CurrentMonthActualUsage)) AS actualRate,\r\n\t\t\t\tSUM(Q.TotalSurplus),\r\n\t\t\t\tSUM(Q.AdjustmentSurplus),\r\n\t\t\t\tSUM(Q.CurrentMonthSurplus),\r\n\t\t\t\tSUM(Q.RateSurplus),\r\n\t\t\t\tSUM(Q.UsageSurplus),\r\n\t\t\t\tSUM(Q.CombinedSurplus),\t\t\t\t\r\n\t\t\t\t1,\r\n\t\t\t\tMAX(Q.IngoreEnergySum)\r\n\t\t\tFROM @QueryResult AS Q\r\n\t\t\t\tINNER JOIN Budget.BudgetVersusExpenditureType B\r\n\t\t\t\t\tON Q.expenditureTypeID = B.BudgetVersusExpenditureTypeSeqid\r\n\t\t\tGROUP BY Q.expenditureTypeID, B.DisplayOrderIndex\r\n\t\t\tORDER BY B.DisplayOrderIndex;\r\n\t\t\t\t\r\n\t\t\tDELETE FROM @QueryResult WHERE InformationLevel = 2\r\n\t\tEND;\r\n\tEND;\r\n\t\r\n\t--/*\r\n\t--\tgroup by agency\r\n\t--*/\r\n\tIF(@InformationGroupLevel = 3)\r\n\tBEGIN\r\n\t\tINSERT INTO @QueryResult\r\n\t\t\t(GroupDescription,\r\n\t\t\texpenditureTypeID,\r\n\t\t\texpenditureType,\r\n\t\t\tCurrentMonthBudgetEnergyUsage,\r\n\t\t\tCurrentMonthBudgetEnergyDollars,\r\n\t\t\tCurrentMonthActualDollars,\r\n\t\t\tCurrentMonthActualUsage,\r\n\t\t\tBudgetRate,\r\n\t\t\tActualRate,\r\n\t\t\tTotalSurplus,\r\n\t\t\tAdjustmentSurplus,\r\n\t\t\tCurrentMonthSurplus,\r\n\t\t\tRateSurplus,\r\n\t\t\tUsageSurplus,\r\n\t\t\tCombinedSurplus,\r\n\t\t\tIngoreEnergySum,\r\n\t\t\tInformationLevel)\t\r\n\t\tSELECT Q.AgencyCodeOEC + '-' + Q.agencyname,\r\n\t\t\tB.BudgetVersusExpenditureTypeSeqid,\r\n\t\t\tB.[Description] AS expenditureType,\r\n\t\t\tQ.CurrentMonthBudgetEnergyUsage,\r\n\t\t\tQ.CurrentMonthBudgetEnergyDollars,\r\n\t\t\tQ.CurrentMonthActualDollars,\r\n\t\t\tQ.CurrentMonthActualUsage,\r\n\t\t\tQ.BudgetRate,\r\n\t\t\tQ.ActualRate,\r\n\t\t\tQ.TotalSurplus,\r\n\t\t\tQ.AdjustmentSurplus,\r\n\t\t\tQ.CurrentMonthSurplus,\r\n\t\t\tQ.RateSurplus,\r\n\t\t\tQ.UsageSurplus,\r\n\t\t\tQ.CombinedSurplus,\r\n\t\t\tB.IngoreEnergySum,\r\n\t\t\t3\r\n\t\tFROM @AgencyData AS Q\r\n\t\t\tINNER JOIN Budget.BudgetVersusExpenditureType AS B\r\n\t\t\t\tON Q.BudgetVersusExpenditureTypeSeqID = B.BudgetVersusExpenditureTypeSeqid\r\n\t\tWHERE Q.IsHidden = 'N' AND B.isHidden = 'N'\r\n\t\tORDER BY B.DisplayOrderIndex;\r\n\tEND;\r\n\r\n\tDECLARE @Level INT = 4\r\n\tWHILE(@Level > 1)\r\n\tBEGIN\r\n\t\tUPDATE BAData\r\n\t\tSET BAData.UsageSurplus = childTotal.UsageSurplus,\r\n\t\t\tBAData.RateSurplus = childTotal.RateSurplus,\r\n\t\t\tBAData.CombinedSurplus = childTotal.CombinedSurplus,\r\n\t\t\tBAData.AdjustmentSurplus = childTotal.AdjustmentSurplus,\r\n\t\t\tBAData.TotalSurplus = childTotal.TotalSurplus\r\n\t\tFROM @QueryResult AS BAData \r\n\t\t\tINNER JOIN Budget.BudgetVersusExpenditureType AS parentType\r\n\t\t\t\tON BAData.expenditureTypeID = parentType.BudgetVersusExpenditureTypeSeqID\r\n\t\t\tINNER JOIN (SELECT SUM(childData.UsageSurplus) UsageSurplus,\r\n\t\t\t\tSUM(childData.RateSurplus) RateSurplus,\r\n\t\t\t\tSUM(childData.CombinedSurplus) CombinedSurplus,\r\n\t\t\t\tSUM(childData.AdjustmentSurplus) AdjustmentSurplus,\r\n\t\t\t\tSUM(childData.TotalSurplus) TotalSurplus,\r\n\t\t\t\tchildData.GroupDescription,\r\n\t\t\t\tchildType.ParentExpenditureTypeID AS expenditureTypeID\r\n\t\t\tFROM @QueryResult AS childData \r\n\t\t\t\tINNER JOIN Budget.BudgetVersusExpenditureType AS childType\r\n\t\t\t\t\tON childData.expenditureTypeID = childType.BudgetVersusExpenditureTypeSeqID\r\n\t\t\t\t\tAND childType.HierarchyLevel = @Level\r\n\t\t\tGROUP BY childData.GroupDescription, childType.ParentExpenditureTypeID\r\n\t\t) AS childTotal ON BAData.GroupDescription = childTotal.GroupDescription\r\n\t\tAND  BADATa.expenditureTypeID = childTotal.expenditureTypeID\r\n\t\t\r\n\t\tSET @Level = @Level -1\r\n\tEND;\r\n\r\n\tSELECT Q.GroupDescription,\r\n        Q.expenditureTypeID,\r\n        Q.expenditureType,\r\n        Q.CurrentMonthBudgetEnergyUsage,\r\n        Q.CurrentMonthBudgetEnergyDollars,\r\n        Q.CurrentMonthActualDollars,\r\n        Q.CurrentMonthActualUsage,\r\n        Q.BudgetRate,\r\n        Q.ActualRate,\r\n        Q.TotalSurplus,\r\n        Q.AdjustmentSurplus,\r\n        Q.CurrentMonthSurplus,\r\n        Q.RateSurplus,\r\n        Q.UsageSurplus,\r\n        Q.CombinedSurplus,\r\n        Q.IngoreEnergySum,\r\n        Q.InformationLevel,\r\n        B.BudgetVersusExpenditureTypeSeqid,\r\n        B.ShortDesc,\r\n        B.[Description],\r\n        B.AuthenticatedUserID,\r\n        B.DateAdded,\r\n        B.LastUpdate,\r\n        B.DisplayOrderIndex,\r\n        B.ParentExpenditureTypeID,\r\n        B.HierarchyLevel,\r\n        B.IngoreEnergySum,\r\n        B.DataType,\r\n        B.IsHidden\r\n\tFROM @QueryResult AS Q\r\n\t\tINNER JOIN Budget.BudgetVersusExpenditureType AS B ON Q.expenditureTypeID = B.BudgetVersusExpenditureTypeSeqid\r\n\tORDER BY Q.GroupDescription, B.DisplayOrderIndex;\r\nEND;"
        }
      ]
    }
  ]
}