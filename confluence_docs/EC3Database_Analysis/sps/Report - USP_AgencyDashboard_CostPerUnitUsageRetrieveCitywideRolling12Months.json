{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "USP_AgencyDashboard_CostPerUnitUsageRetrieveCitywideRolling12Months",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "USP_AgencyDashboard_CostPerUnitUsageRetrieveCitywideRolling12Months",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve and calculate energy usage and cost metrics for a citywide agency dashboard over a rolling 12-month period. It aggregates data from a published summary table and calculates the cost per unit of energy usage. The procedure is intended to provide insights into energy consumption and costs for different energy types over the specified period."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@publishedBillingPeriod AS VARCHAR(6) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the billing period for which the data should be retrieved. It is expected to be in the format 'YYYYMM'. If not provided, the procedure defaults to the latest available billing period from the "
                },
                {
                  "type": "text",
                  "text": "Published.MonthlyPublishedSummaryData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@debugMode AS BIT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is intended for debugging purposes. However, it is not utilized within the procedure, suggesting it might be a placeholder for future debugging features."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization and Default Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure begins by setting the transaction isolation level to "
                        },
                        {
                          "type": "text",
                          "text": "READ UNCOMMITTED",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to avoid locking issues and ensure that it can read uncommitted data."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If "
                        },
                        {
                          "type": "text",
                          "text": "@publishedBillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is not provided, it defaults to the latest billing period available in the "
                        },
                        {
                          "type": "text",
                          "text": "Published.MonthlyPublishedSummaryData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Date Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The fiscal year is calculated using a user-defined function "
                        },
                        {
                          "type": "text",
                          "text": "CalculateFiscalYear",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure calculates the start date for the rolling 12-month period by subtracting 11 months from the current billing period date."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Table Creation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "A temporary table "
                        },
                        {
                          "type": "text",
                          "text": "@billingPeriodTable",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is created to store each billing period within the rolling 12-month window."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "A loop populates this table with each month from the start billing period to the current billing period."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation and Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure performs a left join between the "
                        },
                        {
                          "type": "text",
                          "text": "@billingPeriodTable",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and a subquery that aggregates energy usage data from the "
                        },
                        {
                          "type": "text",
                          "text": "Published.TemporalAccountLevelSummaryByAgency",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It calculates the total energy usage, demand usage, billed amount, and BTU for each billing period and energy type."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The cost per unit usage is calculated by dividing the total billed amount by the total energy usage, rounded to two decimal places."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Data Selection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The results are grouped by agency code, label, and energy type, and the maximum billing period and fiscal year are selected for each group."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure returns a dataset that includes the agency code, fiscal year, billing period, energy type, energy usage, demand usage, billed amount, cost per unit usage, and BTU."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While this level reduces locking overhead, it may lead to reading uncommitted or dirty data, which could affect data accuracy."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Loop for Billing Periods",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The loop that populates the "
                },
                {
                  "type": "text",
                  "text": "@billingPeriodTable",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " could be optimized or replaced with a set-based operation to improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "NOLOCK Hint",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Used in the subquery to avoid locking, but it may result in reading uncommitted data, similar to the isolation level setting."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Accuracy",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "NOLOCK",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " may lead to inaccurate data if the underlying tables are being updated concurrently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Unused Parameter",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "@debugMode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is not used, which could lead to confusion or maintenance issues if not documented properly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Date Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that billing periods are continuous and formatted correctly, which may not always be the case if there are gaps or format inconsistencies in the data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the performance of the loop and the aggregation queries may degrade, necessitating further optimization or indexing strategies."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[USP_AgencyDashboard_CostPerUnitUsageRetrieveCitywideRolling12Months]\n(\r\n\t@publishedBillingPeriod AS VARCHAR(6) = NULL\r\n    ,@debugMode AS BIT = NULL\r\n)\r\nAS\r\nBEGIN\r\n    SET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n \r\n\tDECLARE @startBillingPeriod AS VARCHAR(6), @FiscalYear AS VARCHAR(4);\r\n\r\n\t\r\n\tIF (ISNULL(@publishedBillingPeriod, '') = '')\r\n\tBEGIN\r\n\t\tSELECT @publishedBillingPeriod = MAX(PublishedBillingPeriod) FROM Published.MonthlyPublishedSummaryData WITH (NOLOCK);\r\n\tEND;\r\n\r\n\tSELECT @FiscalYear = [dbo].[CalculateFiscalYear](@publishedBillingPeriod)\r\n    DECLARE @currentBPDate AS DATETIME, @startBPDate AS DATETIME;\r\n    SET @currentBPDate = CONVERT(DATETIME, LEFT(@publishedBillingPeriod, 4) + '-' + RIGHT(@publishedBillingPeriod, 2) + '-01');\r\n    SET @startBPDate = DATEADD(MM, 0 - (12 - 1), @currentBPDate);\r\n    SET @startBillingPeriod = CONVERT(VARCHAR(12), @startBPDate, 112);\r\n\r\n \r\n    DECLARE @billingPeriodTable TABLE (BillingPeriod VARCHAR(6), CurrentPeriod BIT NOT NULL DEFAULT(0));\r\n\r\n    WHILE (@startBillingPeriod <= @publishedBillingPeriod)\r\n    BEGIN\r\n        INSERT INTO @billingPeriodTable (BillingPeriod, CurrentPeriod) VALUES (@startBillingPeriod, 1);\r\n\r\n        IF (RIGHT(@startBillingPeriod, 2) = 12)\r\n\t\tBEGIN\r\n                SET @startBillingPeriod = CONVERT(VARCHAR(4), (CONVERT(INT, LEFT(@startBillingPeriod, 4)) + 1)) + '01';\r\n\t\tEND;\r\n        ELSE\r\n        BEGIN\r\n\t\t\tSET @startBillingPeriod = CONVERT(VARCHAR(6), CONVERT(INT, @startBillingPeriod) + 1);\r\n\t\tEND;\r\n    END;\r\n       \r\n    SELECT T.AgencyCodeOEC\r\n\t\t,MAX(T.FiscalYear) AS FiscalYear\r\n        ,MAX(T.BillingPeriod) AS BillingPeriod\r\n        ,T.[Label]\r\n        ,SUBSTRING(MAX(T.BillingPeriod), 1, 4) AS CalendarYear\r\n        ,LEFT(DATENAME(MM, CONVERT(DATETIME, SUBSTRING(MAX(T.BillingPeriod), 1, 4) + '-' + SUBSTRING(MAX(T.BillingPeriod), 5, 2) + '-01')), 3) AS [MonthName]\r\n        ,LEFT(DATENAME(MM, CONVERT(DATETIME, SUBSTRING(MAX(T.BillingPeriod), 1, 4) + '-' + SUBSTRING(MAX(T.BillingPeriod), 5, 2) + '-01')), 3) + ' ' + SUBSTRING(MAX(T.BillingPeriod), 1, 4) AS MonthYear\r\n        ,T.EnergyType\r\n        ,SUM(T.EnergyUsage) AS EnergyUsage\r\n        ,SUM(T.DemandUsage) AS DemandUsage\r\n        ,SUM(T.BilledAmount) AS BilledAmount\r\n        ,ROUND(ISNULL((CASE WHEN ISNULL(SUM(T.EnergyUsage), 0.00) > 0.00 THEN (ISNULL(SUM(T.BilledAmount), 0.00) / SUM(T.EnergyUsage)) ELSE 0.00 END), 0.00), 2) AS CostPerUnitUsage\r\n        ,SUM(T.BTU) AS BTU\r\n        ,CONVERT(BIT, 1) AS CurrentPeriod\r\n    FROM (SELECT 'CITY' AS AgencyCodeOEC\r\n\t\t\t,@FiscalYear AS FiscalYear\r\n\t\t\t,TBP.BillingPeriod\r\n\t\t\t,'Cost per unit usage' AS [Label]\r\n\t\t\t,A1.EnergyType\r\n\t\t\t,ISNULL(A1.EnergyUsage, 0.00) AS EnergyUsage\r\n\t\t\t,ISNULL(A1.DemandUsage, 0.00) AS DemandUsage\r\n\t\t\t,ISNULL(A1.BilledAmount, 0.00) AS BilledAmount\r\n\t\t\t,ISNULL(A1.BTU, 0.00) AS BTU\r\n\t\t\t,TBP.CurrentPeriod\r\n        FROM @billingPeriodTable AS TBP\r\n\t\t\tLEFT JOIN (\r\n                SELECT ALSA.BillingPeriod\r\n                    ,ALSA.EnergyType\r\n                    ,SUM(CONVERT(DECIMAL(36, 2), ALSA.EnergyUsage)) AS EnergyUsage\r\n                    ,SUM(CONVERT(DECIMAL(36, 2), ALSA.DemandUsage)) AS DemandUsage\r\n                    ,ROUND(SUM(CONVERT(DECIMAL(36, 2), ALSA.BilledAmount)), 2) AS BilledAmount\r\n                    ,SUM(CONVERT(DECIMAL(36, 2), ALSA.BTU)) AS BTU\r\n                FROM [Published].[TemporalAccountLevelSummaryByAgency] AS ALSA WITH (NOLOCK)\r\n                WHERE ALSA.EffectiveStartPeriod <= @PublishedBillingPeriod AND ALSA.EffectiveEndPeriod > @PublishedBillingPeriod\r\n                GROUP BY ALSA.BillingPeriod, ALSA.EnergyType) AS A1 ON A1.BillingPeriod = TBP.BillingPeriod) AS T\r\n       GROUP BY T.AgencyCodeOEC, T.[Label], T.EnergyType;\r\nEND;"
        }
      ]
    }
  ]
}