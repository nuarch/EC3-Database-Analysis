{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_LoadFactor_GetAccountLoadFactorInformation_Upgrade",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_LoadFactor_GetAccountLoadFactorInformation_Upgrade",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve account load factor information for a specified billing period. It filters and sorts data based on various criteria, including agency user status, search text, and load factor conditions. The procedure logs its usage and supports pagination and dynamic sorting of the results."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple conditional logic branches, dynamic filtering, and sorting mechanisms. It also includes logging and pagination, which adds to its complexity. However, it does not involve complex joins or subqueries, keeping it at a medium complexity level."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the billing period for which data is retrieved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsLoadFactorFilterApplied AS yesnoWithDefaultNo",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Determines if the load factor filter should be applied ('Y' for filtering records with a load factor greater than 1)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartIndex AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The starting index for pagination."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PageSize AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The number of records to fetch for pagination."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Email AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the data, used for logging and filtering."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SearchText AS VARCHAR(150)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Text used to filter records based on various fields."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SortColumn AS VARCHAR(100)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The column by which to sort the results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SortOrder AS VARCHAR(100)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The order of sorting ('ASC' or 'DESC')."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsAgencyUser AS BIT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Indicates if the user is an agency user, affecting the billing period selection."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Sets transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to avoid locking issues and initializes variables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Selection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If the user is an agency user, it selects the current processing period from "
                        },
                        {
                          "type": "text",
                          "text": "Billing.ApplicationTimeFrame",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Otherwise, it selects the maximum published billing period from "
                        },
                        {
                          "type": "text",
                          "text": "Published.MonthlyPublishedSummaryData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Calls "
                },
                {
                  "type": "text",
                  "text": "Audit.usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to log the usage of the report."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Search Text Preparation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Formats the search text for use in "
                },
                {
                  "type": "text",
                  "text": "LIKE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " clauses."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Agency Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Inserts active agency IDs associated with the user's email into a temporary table "
                },
                {
                  "type": "text",
                  "text": "@Agency",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts filtered data from "
                        },
                        {
                          "type": "text",
                          "text": "Published.TemporalAccountLevelRawDataForCurrentPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " into "
                        },
                        {
                          "type": "text",
                          "text": "@PublishedData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Applies search text filtering and checks for effective periods and billing period matches."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Applies load factor filtering if specified."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Record Count",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Counts the number of records in "
                },
                {
                  "type": "text",
                  "text": "@PublishedData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Selection and Sorting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Selects data from "
                        },
                        {
                          "type": "text",
                          "text": "@PublishedData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " with dynamic sorting based on "
                        },
                        {
                          "type": "text",
                          "text": "@SortColumn",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "@SortOrder",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Implements pagination using "
                        },
                        {
                          "type": "text",
                          "text": "OFFSET",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "FETCH NEXT",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but may lead to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dynamic Sorting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of dynamic sorting can impact performance, especially if the dataset is large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Pagination",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Efficiently handles large datasets by fetching only the required number of rows."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Use of temporary tables ("
                },
                {
                  "type": "text",
                  "text": "@PublishedData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "@Agency",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") can consume memory, especially if the dataset is large."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level may lead to reading uncommitted data, which can be inconsistent."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "SQL Injection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of dynamic SQL for sorting without proper sanitization can be vulnerable to SQL injection."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Load Factor Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Division by zero is handled using "
                },
                {
                  "type": "text",
                  "text": "NULLIF",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", but incorrect data can still lead to unexpected results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Email Dependency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure relies on the email parameter for filtering, which may not always be accurate or available."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded values for certain conditions, which can reduce flexibility and adaptability to changes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_LoadFactor_GetAccountLoadFactorInformation_Upgrade]\n(\r\n\t@BillingPeriod AS VARCHAR(6)\r\n\t,@IsLoadFactorFilterApplied AS yesnoWithDefaultNo -- 'Y' return record with factor > 1\r\n\t,@StartIndex AS INT\r\n\t,@PageSize AS INT\r\n\t,@Email AS VARCHAR(75)\r\n\t,@SearchText AS VARCHAR(150)\r\n\t,@SortColumn AS VARCHAR(100) = ''\r\n\t,@SortOrder AS VARCHAR(100) = 'ASC'\r\n\t,@IsAgencyUser AS BIT = 0\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID), @PublishedBillingPeriod AS VARCHAR(6), @ElectricityDeliveryTypeSeqId AS INT = 1\r\n\t\t,@NumberOfRecord AS INT, @SQL AS VARCHAR(MAX);\r\n\r\n\tIF (@IsAgencyUser = 1)\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = PublishedBillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\tEND;\r\n\tELSE\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = MAX(PublishedBillingPeriod) FROM Published.MonthlyPublishedSummaryData;\r\n\tEND;\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName = @spname,\r\n\t\t@StoredProcName = @spname,\r\n\t\t@RequestedBy = @Email,\r\n\t\t@prmPublishedBillingPeriod = NULL,\r\n\t\t@prmBillingPeriod = @BillingPeriod,\r\n\t\t@prmAgency_ies = null,\r\n\t\t@prmFacilityNumber_s = NULL,\r\n\t\t@prmStartingBillingPeriod = NULL,\r\n\t\t@prmEndingBillingPeriod = NULL;\r\n\t\r\n\tSET @SearchText = '%' + ISNULL(@SearchText, '') + '%';\r\n\r\n\tDECLARE @PublishedData TABLE\r\n\t\t(UtilityCompany VARCHAR(20),\r\n\t\tCurrentAccountNumber VARCHAR(15),\r\n\t\tUtilityServiceAddress VARCHAR(40),\r\n\t\tFacilityName VARCHAR(100),\r\n\t\tFacilityAddress VARCHAR(120),\r\n\t\tOecFacilityNumber VARCHAR(7),\r\n\t\tAgencyCodeOEC VARCHAR(6),\r\n\t\tAgencyName VARCHAR(75),\r\n\t\tActualOrEstimated VARCHAR(3),\r\n\t\tEnergyUsage INT,\r\n\t\tDemandUsage NUMERIC(12, 2),\r\n\t\tNumberOfDays INT,\r\n\t\tLoadFactor DECIMAL(10,2),\r\n\t\tAgencyDivisionSeqID INT,\r\n\t\tFacilitySeqID INT);\r\n\tDECLARE @Agency AS TABLE(AgencyDivisionSeqID seqid NULL);\r\n\r\n\tINSERT INTO @Agency (AgencyDivisionSeqID)\r\n\tSELECT AgencyDivisionSeqID FROM dbo.uftn_TableGetActiveAgenciesByEmailAddress(@Email);\r\n\r\n\tINSERT INTO @PublishedData\r\n\t\t(UtilityCompany,\r\n\t\tCurrentAccountNumber,\r\n\t\tUtilityServiceAddress,\r\n\t\tFacilityName,\r\n\t\tFacilityAddress,\r\n\t\tOecFacilityNumber,\r\n\t\tAgencyCodeOEC,\r\n\t\tAgencyName,\r\n\t\tActualOrEstimated,\r\n\t\tEnergyUsage,\r\n\t\tDemandUsage,\r\n\t\tNumberOfDays,\r\n\t\tLoadFactor,\r\n\t\tAgencyDivisionSeqID,\r\n\t\tFacilitySeqID)\r\n\tSELECT AR.UtilityCompany,\r\n\t\tAR.CurrentAccountNumber,\r\n\t\tAR.UtilityServiceAddress,\r\n\t\tAR.FacilityName,\r\n\t\tAR.Address1 AS facilityAddress,\r\n\t\tAR.OecFacilityNumber,\r\n\t\tAR.AgencyCodeOEC,\r\n\t\tAR.AgencyName,\r\n\t\tAR.ActualOrEstimated,\r\n\t\tAR.AccountEnergyUsage,\r\n\t\tAR.AccountDemandUsage,\r\n\t\tAR.BillingPeriodDays NumberOfDays,\r\n\t\tAR.OriginalEnergyUsage / NULLIF((AR.OriginalDemandUsage * AR.BillingPeriodDays * 24), 0),\r\n\t\tAR.AgencyDivisionSeqid,\r\n\t\tAR.FacilitySeqid\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS AR\r\n\t\tINNER JOIN @Agency AS A ON AR.AgencyDivisionSeqid = A.AgencyDivisionSeqID\r\n\tWHERE (AR.OecFacilityNumber LIKE @SearchText\r\n\t\t\tOR AR.FacilityName LIKE @SearchText\r\n\t\t\tOR AR.UtilityCompany LIKE @SearchText\r\n\t\t\tOR AR.CurrentAccountNumber LIKE @SearchText\r\n\t\t\tOR AR.UtilityServiceAddress LIKE @SearchText\r\n\t\t\tOR AR.Address1 LIKE @SearchText\r\n\t\t\tOR AR.AgencyCodeOEC LIKE @SearchText\r\n\t\t\tOR AR.AgencyName LIKE @SearchText\r\n\t\t\tOR AR.ActualOrEstimated LIKE @SearchText)\r\n\t\tAND AR.EffectiveStartPeriod <= @PublishedBillingPeriod AND AR.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND AR.BillingPeriod = @BillingPeriod\r\n\t\tAND AR.EnergyDeliveryType = @ElectricityDeliveryTypeSeqId\r\n\t\tAND 1 < CASE WHEN @IsLoadFactorFilterApplied = 'Y' THEN\r\n\t\t\tAR.OriginalEnergyUsage / NULLIF((AR.OriginalDemandUsage * [dbo].[CalculateNumberOfBillingDays](AR.FromDate, AR.ToDate) * 24), 0)\r\n\t\t\tELSE 2 END\r\n\tORDER BY AR.OecFacilityNumber, AR.CurrentAccountNumber;\r\n\r\n\tSELECT @NumberOfRecord = COUNT(*) FROM @PublishedData;\t\r\n\t\r\n\tSELECT UtilityCompany,\r\n\t\tCurrentAccountNumber,\r\n\t\tUtilityServiceAddress,\r\n\t\tFacilityName,\r\n\t\tfacilityAddress,\r\n\t\tOecFacilityNumber,\r\n\t\tAgencyCodeOEC,\r\n\t\tAgencyName,\r\n\t\tActualOrEstimated,\r\n\t\tEnergyUsage,\r\n\t\tDemandUsage,\r\n\t\tNumberOfDays,\r\n\t\tLoadFactor,\r\n\t\tAgencyDivisionSeqID,\r\n\t\tFacilitySeqID,\r\n\t\tCAST(@NumberOfRecord AS VARCHAR(10)) As RecordCount\r\n\tFROM @PublishedData\r\n\tORDER BY CASE WHEN(@SortColumn = '') THEN OecFacilityNumber END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Oec Facility#' AND @SortOrder = 'ASC') THEN OecFacilityNumber END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Oec Facility#' AND @SortOrder = 'DESC') THEN OecFacilityNumber END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Utility Company' AND @SortOrder = 'ASC') THEN UtilityCompany END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Utility Company' AND @SortOrder = 'DESC') THEN UtilityCompany END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Account #' AND @SortOrder = 'ASC') THEN CurrentAccountNumber END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Account #' AND @SortOrder = 'DESC') THEN CurrentAccountNumber END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Address' AND @SortOrder = 'ASC') THEN UtilityServiceAddress END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Address' AND @SortOrder = 'DESC') THEN UtilityServiceAddress END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Facility Name' AND @SortOrder = 'ASC') THEN FacilityName END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Facility Name' AND @SortOrder = 'DESC') THEN FacilityName END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Facility Address' AND @SortOrder = 'ASC') THEN FacilityAddress END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Facility Address' AND @SortOrder = 'DESC') THEN FacilityAddress END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Agency Code' AND @SortOrder = 'ASC') THEN AgencyCodeOEC END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Agency Code' AND @SortOrder = 'DESC') THEN AgencyCodeOEC END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Agency Name' AND @SortOrder = 'ASC') THEN AgencyName END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Agency Name' AND @SortOrder = 'DESC') THEN AgencyName END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Act or Est' AND @SortOrder = 'ASC') THEN ActualOrEstimated END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Act or Est' AND @SortOrder = 'DESC') THEN ActualOrEstimated END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Usage' AND @SortOrder = 'ASC') THEN EnergyUsage END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Usage' AND @SortOrder = 'DESC') THEN EnergyUsage END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Demand' AND @SortOrder = 'ASC') THEN DemandUsage END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Demand' AND @SortOrder = 'DESC') THEN DemandUsage END DESC\r\n\t\t,CASE WHEN(@SortColumn = '# of Days' AND @SortOrder = 'ASC') THEN NumberOfDays END ASC\r\n\t\t,CASE WHEN(@SortColumn = '# of Days' AND @SortOrder = 'DESC') THEN NumberOfDays END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'Load Factor' AND @SortOrder = 'ASC') THEN LoadFactor END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'Load Factor' AND @SortOrder = 'DESC') THEN LoadFactor END DESC\r\n\t\tOFFSET CASE WHEN @PageSize = -1 THEN 0 ELSE @StartIndex END ROWS\r\n\t\tFETCH NEXT CASE WHEN @PageSize = -1 THEN IIF(@NumberOfRecord > 0, @NumberOfRecord, 1) ELSE @PageSize END ROWS ONLY;\r\nEND;"
        }
      ]
    }
  ]
}