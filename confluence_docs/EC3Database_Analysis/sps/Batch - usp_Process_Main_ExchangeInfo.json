{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Batch",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Process_Main_ExchangeInfo",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Process_Main_ExchangeInfo",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process and update exchange data related to meter and account exchanges for a specific billing period, in this case, '202305'. It performs a series of updates on the "
        },
        {
          "type": "text",
          "text": "Common.ExchangeData",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table to exclude certain records based on various conditions. The procedure also includes commented-out sections that suggest additional operations or checks that be performed under different circumstances. The procedure is part of a larger system that handles meter and account exchanges, for a utility company."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this stored procedure is medium. It involves multiple conditional updates, joins, and subqueries to manipulate data based on specific business rules. The presence of numerous commented-out sections and specific hard-coded values adds to the complexity, as it shows the procedure is tailored for specific scenarios and require frequent updates or modifications."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "This stored procedure does not take any input parameters. It operates on hard-coded values, particularly the billing period '202305', and specific meter and account numbers."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Setup and Comments",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins with comments explaining the purpose of the procedure and the related stored procedures that handle different types of exchanges."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Exclusion Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The main body of the procedure consists of several "
                },
                {
                  "type": "text",
                  "text": "UPDATE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statements that set the "
                },
                {
                  "type": "text",
                  "text": "Exclude",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " field to 'Y' for records in the "
                },
                {
                  "type": "text",
                  "text": "Common.ExchangeData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table. These updates are based on:"
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Exchange codes and their relationships (e.g., '27' for meter turn-off and '45' for meter exchange)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The status of meters and accounts (e.g., active or inactive)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Specific meter and account numbers that are hard-coded."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Self-Exchange Check",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An update excludes records where the current meter number is the same as the original meter number for exchange code '45'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hard-Coded Exclusions",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Several updates exclude specific meter numbers and account numbers for the billing period '202305'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Execution of Other Procedures",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure includes a call to another stored procedure, "
                },
                {
                  "type": "text",
                  "text": "usp_ProcessExchange_Code45",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", with hard-coded parameters, indicating further processing of exchange data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented-Out Sections",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": These sections suggest additional logic that be applied under different conditions, such as handling previously sent exchange codes or updating meter statuses."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hard-Coded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of hard-coded values for billing periods and specific meter/account numbers can limit the procedure's flexibility and require frequent updates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Subqueries",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses several joins and subqueries, which impact performance, especially if the "
                },
                {
                  "type": "text",
                  "text": "Common.ExchangeData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Lack of Indexing Information",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no information about indexing on the tables involved, which affect the efficiency of the updates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure processes data in batches based on specific conditions, which can be efficient if the conditions are well-optimized."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hard-Coded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The reliance on hard-coded values makes the procedure less adaptable to changes in business requirements or data structures."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented-Out Code",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The presence of extensive commented-out code suggests that the procedure is still under development or frequently modified, which can lead to maintenance challenges."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Lack of Input Parameters",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The absence of input parameters limits the procedure's reusability and flexibility."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs updates that exclude records from processing, which could lead to data integrity issues if not carefully managed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the procedure is tailored for specific scenarios, scaling it to handle different billing periods or larger datasets may require significant modifications."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE   PROC [Batch].[usp_Process_Main_ExchangeInfo]\nAS\r\nBEGIN\r\n\t\r\n\t--14.\t“usp_ProcessExchangeInfo” calls the one of the four stored procedures below based upon the NYPA exchange code.\r\n--\r\n--\t\t\t\t\tAccount exchanges (“usp_ProcessExchangeCode_AX”)\r\n--\t\t\t\t\tNew Account and first Meter (“usp_ProcessExchangeCode_47”) - ************  Needs modification\r\n--\t\t\t\t\tExisting Account and new Meter (“usp_ProcessExchangeCode_46”)\r\n--\t\t\t\t\tMeter Exchange (“usp_ProcessExchangeCode_45”)\r\n--\t\t\t\t\tAccount Turn Off (“usp_ProcessExchangeCode_28”) - ************  Needs modification\r\n--\t\t\t\t\tMeter Turn Off on Active Account (“usp_ProcessExchangeCode_27”)\r\n--\r\n--\r\n--\r\n--SELECT * FROM Nypa.UploadNYPAExchangeData as uned\r\n--\r\n-- Converts original status of 47 to 74. \r\n-- Grab the first 46 associated with the 47 turned 74 and then convert to 47.\r\n-- Where an account turnoff is present then set the associated meters to 'R' to indicate ignore/do not process.\r\n------------------------------------------------------------------------------------------------------------------------------\r\n-------------------------------------------------------------------------------------------------------------------------------\r\n-- EXCHANGE RECORD PROCESS PREP\r\n-- Exchange data Validation check / data clean up start\r\n-- process update\r\n\r\n-- if the 27 exchange code is sent for exchanged meter\r\nUPDATE ed\r\nSET ed.Exclude = 'Y' \r\n--SELECT *  \r\nFROM Common.ExchangeData AS ed\r\nINNER JOIN\r\n(\r\n\tSELECT tom.ExchangeDataSeqid FROM (SELECT ed.ExchangeDataSeqid, ed.CurrentMeterNumber FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod = '202305' AND ed.ExchangeCode = '27' ) tom\r\n\tINNER JOIN\r\n\t(SELECT ed.ExchangeDataSeqid, ed.OriginalMeterNumber FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod = '202305' AND ed.ExchangeCode = '45' ) exch\r\n\tON exch.OriginalMeterNumber = tom.CurrentMeterNumber\r\n) updateexh\r\nON updateexh.ExchangeDataSeqid = ed.ExchangeDataSeqid\r\n\r\n-- excludes 46 new meters which is already active in the ststem\r\n-- make sure the account numbers are same\r\nUPDATE ed\r\nSET ed.Exclude = 'Y'\r\nFROM Common.ExchangeData AS ed\r\nINNER JOIN\r\n(\r\n\tSELECT m.OriginalAccountNumber metertblAccountnumber,ech.* FROM Billing.Meter AS m \r\n\tINNER JOIN \r\n\t(SELECT ed.ExchangeDataSeqid, ed.CurrentMeterNumber, ed.CurrentAccountNumber exchAccountNumber FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod = '202305' AND ed.ExchangeCode = '46' AND ed.IsProcessed ='N') ech\r\n\tON ech.CurrentMeterNumber = m.CurrentMeterNumber  AND ech.exchAccountNumber = m.OriginalAccountNumber\r\n\tWHERE m.MeterStatus = 'AC'\r\n) updateexh\r\nON updateexh.ExchangeDataSeqid = ed.ExchangeDataSeqid\r\n\r\n-------- Meter is already turned off and there is an exchange 27 code to turn off\r\nUPDATE ed\r\nSET ed.Exclude = 'Y' \r\n--SELECT * FROM \r\nFROM Common.ExchangeData AS ed\r\nINNER JOIN\r\n(\r\n\tSELECT DISTINCT ech.* FROM Billing.Meter AS m \r\n\tINNER JOIN \r\n\t(SELECT ed.ExchangeDataSeqid, ed.CurrentMeterNumber FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod = '202305' AND ed.ExchangeCode = '27' AND ed.IsProcessed ='N') ech\r\n\tON ech.CurrentMeterNumber = m.CurrentMeterNumber\r\n\tWHERE m.IsActive = 0\r\n) updateexh\r\nON updateexh.ExchangeDataSeqid = ed.ExchangeDataSeqid\r\nWHERE ed.BillingPeriod='202305'\r\n\r\n\r\n\r\n-- self exchange\r\nUPDATE ed\r\nSET ed.Exclude = 'Y' \r\n--SELECT * FROM \r\nFROM Common.ExchangeData AS ed\r\nWHERE ed.ExchangeCode ='45'\r\nAND ed.BillingPeriod ='202305'\r\nAND ed.CurrentMeterNumber = ed.OriginalMeterNumber\r\n\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000001S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000009S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000000S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000003S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000008S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000002S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000005S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000004S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000006S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000007S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000007S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000001S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000009S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000000S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000003S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000008S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000002S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000005S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000004S' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE OriginalMeterNumber ='000006S' AND BillingPeriod = '202305'\r\n\r\n-- Exchange data Validation check / data clean up End\r\n\r\n\r\n\r\n-- 202305 start fix\r\n\r\n\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000002S' AND BillingPeriod = '202305'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000008S' AND BillingPeriod = '202305'\r\n\r\n\r\n-- exchange code sent again which was sent last month\r\n-- 2\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE ExchangeDataSeqid IN\r\n--(\r\n--\tSELECT c.ExchangeDataSeqid FROM \r\n--\t(SELECT * FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod='202108' AND ed.ExchangeCode ='45') p\r\n--\tINNER JOIN \r\n--\t(SELECT * FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod='202305' AND ed.ExchangeCode ='45') c\r\n--\tON c.CurrentMeterNumber = p. CurrentMeterNumber AND p.CurrentAccountNumber = c.CurrentAccountNumber AND c.OriginalMeterNumber = p.OriginalMeterNumber\r\n--)\r\n\r\n\r\n\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118039110001' AND CurrentMeterNumber='4497515' AND BillingPeriod = '202305' AND ExchangeCode = '45'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118138110001' AND CurrentMeterNumber='1783907' AND BillingPeriod = '202305' AND ExchangeCode = '45'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='390118182500007' AND CurrentMeterNumber='2776619' AND BillingPeriod = '202305' AND ExchangeCode = '45'\r\n\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='390118182500007' AND CurrentMeterNumber='1156827' AND BillingPeriod = '202305' AND ExchangeCode = '27'\r\n\r\n\r\n\r\n--UPDATE Common.ExchangeData SET OriginalMeterNumber ='9864117' WHERE CurrentMeterNumber ='9864177' AND CurrentAccountNumber ='690118094100000' and  BillingPeriod ='202010'\r\n\r\n--SELECT * FROM Billing.Account AS a WHERE a.OriginalAccountNumber ='790118050450000' AND a.IsCurrentRecord='Y'\r\n--UPDATE a SET a.IsCurrentRecord='N' FROM Billing.Account AS a WHERE a.AccountSeqid =10453 --a.OriginalAccountNumber ='790118050450000' AND a.IsCurrentRecord='Y'\r\n---- AFTER PROCESSING EXCHANGES COMEBACK AND EXECUTE BELOW line of CODE\r\n----UPDATE a SET a.IsCurrentRecord='Y' FROM Billing.Account AS a WHERE a.AccountSeqid =10453\r\n\r\n\r\n\r\n------ excluding already turned off accounts\r\n--UPDATE ed\r\n--SET ed.Exclude = 'Y' \r\n----SELECT * FROM \r\n--FROM Common.ExchangeData AS ed\r\n--INNER JOIN\r\n--(\r\n--\tSELECT edx.ExchangeDataSeqid FROM Common.ExchangeData AS edx \r\n--\tWHERE edx.ExchangeCode ='28' \r\n--\tAND edx.BillingPeriod ='202305'\r\n--\tAND edx.CurrentAccountNumber IN (SELECT a.CurrentAccountNumber FROM Billing.Account AS a WHERE a.IsActive =0 AND a.IsCurrentRecord ='Y')\r\n--) updateexh\r\n--ON updateexh.ExchangeDataSeqid = ed.ExchangeDataSeqid\r\n--WHERE ed.BillingPeriod='202305'\r\n--AND ed.ExchangeCode ='28'\r\n\r\n--SELECT * FROM Billing.AccountMeterStatus AS ams\r\n\r\n------  if the meter is exchanged its inactive so we dont need 27 for those meters as well\r\n--UPDATE ed\r\n--SET ed.Exclude = 'Y' \r\n----SELECT * FROM \r\n--FROM Common.ExchangeData AS ed\r\n--INNER JOIN\r\n--(\r\n--\tSELECT DISTINCT ech.* FROM Billing.Meter AS m \r\n--\tINNER JOIN \r\n--\t(SELECT ed.ExchangeDataSeqid, ed.CurrentMeterNumber FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod = '202305' AND ed.ExchangeCode = '27' AND ed.IsProcessed ='N') ech\r\n--\tON ech.CurrentMeterNumber = m.OriginalMeterNumber\r\n--\tWHERE m.IsActive = 0\r\n--) updateexh\r\n--ON updateexh.ExchangeDataSeqid = ed.ExchangeDataSeqid\r\n\r\n\r\n--\t\t\tUPDATE Billing.Meter\r\n--\t\t\t\tSET MeterPreviousStatus = MeterStatus\r\n--\t\t\t\t,MeterStatus = 'AC'\r\n--\t\t\t\t,MeterStatusCodePeriod = '202001'\r\n--\t\t\t\t,MeterEffectiveOffDate = '99991231'\r\n--\t\t\t\t,TurnOffDate = '999912'\r\n--\t\t\t\t,LastUpdate = GETDATE()\r\n--\t\t\t\t,Notes = 'Meter turned back on, we received billing and meter exchange'\r\n--\t\t\t\t,FireAuditTrigger = 'Y'\r\n--\t\t\t\t,AuthenticatedUserID = 1\r\n--\t\t\tWHERE MeterSeqid = 5511;\r\n\r\n------\r\n--\t\t\tUPDATE Billing.AccountExchangeMeterTrack\r\n--\t\t\tSET MeterEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tAccountEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tFireAuditTrigger = 'Y',\r\n--\t\t\t\tLastUpdate = GETDATE(),\r\n--\t\t\t\tNotes = 'Meter turned back on, we received billing and meter exchange',\r\n--\t\t\t\tAuthenticatedUserID = 1\r\n--\t\t\tWHERE OriginalMeterSeqid = 5511 AND OriginalAccountSeqid = 15285 ;\r\n\r\n\r\n\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber = '290118057500000' AND OriginalMeterNumber ='1087660' AND BillingPeriod = '201911'\r\n--UPDATE m SET m.CurrentMeterNumber = '1809872', m.FireAuditTrigger='Y' FROM Billing.Meter AS m WHERE m.CurrentMeterNumber='1087660'\r\n--UPDATE m SET m.MeterStatus = 'AC',m.MeterStatusCodePeriod='201911', m.TurnOffDate='999912', m.MeterEffectiveOffDate='99991231', m.LastUpdate=GETDATE(),m.IsCurrentRecord='Y',m.FireAuditTrigger='Y' FROM Billing.Meter AS m WHERE m.MeterSeqid=28121\r\n--UPDATE m SET m.MeterStatus='45', m.MeterStatusCodePeriod='201911', m.TurnOffDate='201911', m.MeterEffectiveOffDate='20190228', m.LastUpdate=GETDATE(),m.IsCurrentRecord='N',m.FireAuditTrigger='Y' FROM Billing.Meter AS m WHERE m.MeterSeqid=29254\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber = '490118268061006' AND CurrentMeterNumber ='5878998' AND BillingPeriod = '201911'  AND ExchangeCode ='27'\r\n\r\n\r\n---- circliign back to same meter, \r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118026300003' AND CurrentMeterNumber='1788390' AND BillingPeriod = '202305'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='690118186510009' AND CurrentMeterNumber='2792931' AND BillingPeriod = '202305'\r\n\r\n---- THEey sent a 46 last month now they are trying to exchage another number to last months number\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118603030007' AND CurrentMeterNumber='1792507' AND BillingPeriod = '202305'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118603030007' AND CurrentMeterNumber='1792508' AND BillingPeriod = '202305'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118603030007' AND CurrentMeterNumber='1792509' AND BillingPeriod = '202305'\r\n\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118163400004' AND CurrentMeterNumber='14401336' AND BillingPeriod = '202305'\r\n\r\n\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000003S' AND BillingPeriod = '202305'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000005S' AND BillingPeriod = '202305'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000003S' AND BillingPeriod = '202305'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentMeterNumber ='000002S' AND BillingPeriod = '202305'\r\n\r\n\r\n\r\n--DECLARE @StatusCode INT\r\n--      , @Message    VARCHAR(1000);\r\n--EXECUTE [Billing].[usp_TurnONAccountandRelatedMeters] @AccountSeqID = 2807                -- int\r\n--                                                    , @MeterSeqIDs = '24565'                -- varchar(100)\r\n--                                                    , @AuthenticatedUserID = 1         -- int\r\n--                                                    , @Notes = 'NYPA sent meter transaction for tuned off meter'                    -- notes\r\n--                                                    , @StatusCode = @StatusCode OUTPUT -- int\r\n--                                                    , @Message = @Message OUTPUT       -- varchar(1000)\r\n\r\n--------------------------------\r\n--SELECT * FROM Billing.Meter AS m WHERE m.MeterSeqid=22852\r\n--\t-- Meter Turn On -- Richard might have turned this meter on already\r\n--\t\t\tUPDATE Billing.Meter\r\n--\t\t\t\tSET MeterPreviousStatus = MeterStatus\r\n--\t\t\t\t,MeterStatus = 'AC'\r\n--\t\t\t\t,MeterStatusCodePeriod = '202305'\r\n--\t\t\t\t,MeterEffectiveOffDate = '99991231'\r\n--\t\t\t\t,TurnOffDate = '999912'\r\n--\t\t\t\t,LastUpdate = GETDATE()\r\n--\t\t\t\t,Notes = 'NYPA sent an exchange for a turned off meter'\r\n--\t\t\t\t,FireAuditTrigger = 'Y'\r\n--\t\t\t\t,AuthenticatedUserID = 1\r\n--\t\t\tWHERE MeterSeqid = 27829;\r\n\r\n--\t\t\t-- AccountExchangeMeterTrack update\r\n--\t\t\tUPDATE Billing.AccountExchangeMeterTrack\r\n--\t\t\tSET MeterEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tAccountEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tFireAuditTrigger = 'Y',\r\n--\t\t\t\tLastUpdate = GETDATE(),\r\n--\t\t\t\tNotes = 'NYPA sent an exchange for a turned off meter',\r\n--\t\t\t\tAuthenticatedUserID = 1\r\n--\t\t\tWHERE OriginalMeterSeqid = 27829 AND OriginalAccountSeqid = 16083;\r\n\r\n--\t\t\tUPDATE Billing.Meter\r\n--\t\t\t\tSET MeterPreviousStatus = MeterStatus\r\n--\t\t\t\t,MeterStatus = 'AC'\r\n--\t\t\t\t,MeterStatusCodePeriod = '202305'\r\n--\t\t\t\t,MeterEffectiveOffDate = '99991231'\r\n--\t\t\t\t,TurnOffDate = '999912'\r\n--\t\t\t\t,LastUpdate = GETDATE()\r\n--\t\t\t\t,Notes = 'NYPA sent an exchange for a turned off meter'\r\n--\t\t\t\t,FireAuditTrigger = 'Y'\r\n--\t\t\t\t,AuthenticatedUserID = 1\r\n--\t\t\tWHERE MeterSeqid = 22851;\r\n\r\n--\t\t\t-- AccountExchangeMeterTrack update\r\n--\t\t\tUPDATE Billing.AccountExchangeMeterTrack\r\n--\t\t\tSET MeterEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tAccountEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tFireAuditTrigger = 'Y',\r\n--\t\t\t\tLastUpdate = GETDATE(),\r\n--\t\t\t\tNotes = 'NYPA sent an exchange for a turned off meter',\r\n--\t\t\t\tAuthenticatedUserID = 1\r\n--\t\t\tWHERE OriginalMeterSeqid = 22851 AND OriginalAccountSeqid = 14546;\r\n\r\n--\t\t\tUPDATE Billing.Meter\r\n--\t\t\t\tSET MeterPreviousStatus = MeterStatus\r\n--\t\t\t\t,MeterStatus = 'AC'\r\n--\t\t\t\t,MeterStatusCodePeriod = '202305'\r\n--\t\t\t\t,MeterEffectiveOffDate = '99991231'\r\n--\t\t\t\t,TurnOffDate = '999912'\r\n--\t\t\t\t,LastUpdate = GETDATE()\r\n--\t\t\t\t,Notes = 'NYPA sent an exchange for a turned off meter'\r\n--\t\t\t\t,FireAuditTrigger = 'Y'\r\n--\t\t\t\t,AuthenticatedUserID = 1\r\n--\t\t\tWHERE MeterSeqid = 22852;\r\n\r\n--\t\t\t-- AccountExchangeMeterTrack update\r\n--\t\t\tUPDATE Billing.AccountExchangeMeterTrack\r\n--\t\t\tSET MeterEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tAccountEffectiveBillingEndDate = '99991231',\r\n--\t\t\t\tFireAuditTrigger = 'Y',\r\n--\t\t\t\tLastUpdate = GETDATE(),\r\n--\t\t\t\tNotes = 'NYPA sent an exchange for a turned off meter',\r\n--\t\t\t\tAuthenticatedUserID = 1\r\n--\t\t\tWHERE OriginalMeterSeqid = 22852 AND OriginalAccountSeqid = 14546;\r\n\r\n\r\n-- exchange code sent again which was sent last month\r\n-- 1\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE ExchangeDataSeqid IN\r\n--(\r\n--\tSELECT c.ExchangeDataSeqid FROM \r\n--\t(SELECT * FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod='202108' AND ed.ExchangeCode ='45') p\r\n--\tINNER JOIN \r\n--\t(SELECT * FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod='202305' AND ed.ExchangeCode ='45') c\r\n--\tON c.CurrentMeterNumber = p. CurrentMeterNumber AND p.CurrentAccountNumber = c.CurrentAccountNumber\r\n--)\r\n\r\n\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118059050004' AND CurrentMeterNumber='1785386' AND BillingPeriod = '202305' AND ExchangeCode = '45'\r\n\r\n\r\n----UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='490118164400001' AND CurrentMeterNumber='8196660' AND BillingPeriod = '202305' AND ExchangeCode = '27'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE BillingPeriod = '202305' AND ExchangeCode = '27' AND CurrentMeterNumber ='5943133'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118057500000' AND OriginalMeterNumber='1087660' AND BillingPeriod = '202305' AND ExchangeCode = '45'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='690118021500009' AND CurrentMeterNumber='1661377' AND BillingPeriod = '202305' AND ExchangeCode = '27'\r\n--SELECT * FROM Billing.AccountMeterStatus AS ams\r\n\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='490118226010004' AND OriginalMeterNumber='8319557' AND BillingPeriod = '202305' AND ExchangeCode = '45'\r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='690118021500009'  AND  BillingPeriod = '202305' AND ExchangeCode = '45'\r\n\r\n--  exchange code sent again which was sent last month\r\n-- -- 6 \r\n--UPDATE Common.ExchangeData SET Exclude='Y' WHERE ExchangeDataSeqid IN\r\n--(\r\n--\tSELECT c.ExchangeDataSeqid FROM \r\n--\t(SELECT * FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod='202205' AND ed.ExchangeCode ='45') p\r\n--\tINNER JOIN \r\n--\t(SELECT * FROM Common.ExchangeData AS ed WHERE ed.BillingPeriod='202305' AND ed.ExchangeCode ='45') c\r\n--\tON c.CurrentMeterNumber = p. CurrentMeterNumber AND p.CurrentAccountNumber = c.CurrentAccountNumber AND c.OriginalMeterNumber = p.OriginalMeterNumber AND c.ExchangeCode = p.ExchangeCode\r\n--)\r\n\r\n\r\n--  Please ALTER PROCEDURE [Common].[usp_ProcessExchange_Code47] SP\r\n-- disable the block starting at line  72\r\n-- ALSO MAKE SURE YOU GET THE CORRECT exchangedataSeqID and pass it to the following SP\r\n\r\n----\r\n--delete FROM Nypa.UploadNYPAMeterBilling WHERE CurrentMeter ='4495462' AND RevisedBillingPeriod IN  ('202110','202111','202112')\r\n\r\nUPDATE ED SET ED.OriginalMeterNumber ='13714797' FROM Common.ExchangeData AS ED WHERE ED.OriginalMeterNumber ='3714797' AND ED.BillingPeriod ='202305'\r\nUPDATE ED SET ED.OriginalMeterNumber ='11014352' FROM Common.ExchangeData AS ED WHERE ED.OriginalMeterNumber ='1014352' AND ED.BillingPeriod ='202305'\r\nUPDATE ED SET ED.OriginalMeterNumber ='14353769' FROM Common.ExchangeData AS ED WHERE ED.OriginalMeterNumber ='4353769' AND ED.BillingPeriod ='202305'\r\nUPDATE ED SET ED.OriginalMeterNumber ='14401336' FROM Common.ExchangeData AS ED WHERE ED.OriginalMeterNumber ='4401336' AND ED.BillingPeriod ='202305'\r\nUPDATE ED SET ED.OriginalMeterNumber ='12760148' FROM Common.ExchangeData AS ED WHERE ED.OriginalMeterNumber ='2760148' AND ED.BillingPeriod ='202305'\r\n\r\n\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='290118163400004' AND CurrentMeterNumber='14401336' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='490118054800005' AND CurrentMeterNumber='2789787' AND BillingPeriod = '202305'\r\nUPDATE Common.ExchangeData SET Exclude='Y' WHERE CurrentAccountNumber='490118054800005' AND CurrentMeterNumber='2789789' AND BillingPeriod = '202305'\r\n\r\n\r\nSELECT * FROM Common.ExchangeData AS ED WHERE ED.BillingPeriod ='202305' AND ED.CurrentAccountNumber ='290118163400004' AND ED.CurrentMeterNumber ='4237027'\r\n\r\nDECLARE\t@return_value int,\r\n\t\t@StatusCode int,\r\n\t\t@Message varchar(1000)\r\n\tEXECUTE [Common].[usp_ProcessExchange_Code45] 19539,1,@StatusCode OUTPUT,@Message OUTPUT\r\n\r\n-- 202305 end fix\r\n\r\nEND"
        }
      ]
    }
  ]
}