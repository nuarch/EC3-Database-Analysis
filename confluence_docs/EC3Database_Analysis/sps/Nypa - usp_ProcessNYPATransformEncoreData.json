{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Nypa",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessNYPATransformEncoreData",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ProcessNYPATransformEncoreData",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process and transform billing data for the New York Power Authority (NYPA). It primarily deals with inserting data from a preload table ("
        },
        {
          "type": "text",
          "text": "NYPA.UploadNYPAEncoreMonthlyBillingPreload",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ") into a main billing table ("
        },
        {
          "type": "text",
          "text": "NYPA.UploadNYPAEncoreMonthlyBilling",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": "). The procedure includes logic to handle billing periods and updates specific account numbers for certain projects. The procedure is executed with an authenticated user ID and returns a status code indicating success or failure."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure involves data transformation and conditional logic based on billing periods."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes hard-coded updates for specific projects, which adds a layer of complexity."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure uses data type casting and date functions, which require careful handling."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter represents the ID of the user executing the procedure. It is used to track who performed the data transformation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode int output",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This is an output parameter intended to return the execution status of the procedure. A value of 0 indicates success, while 9 indicates failure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Variable Declaration",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure declares variables for billing periods, although they are not actively used in the current logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Truncation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by truncating the "
                },
                {
                  "type": "text",
                  "text": "NYPA.UploadNYPAEncoreMonthlyBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, effectively clearing it of all existing data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure inserts data from "
                        },
                        {
                          "type": "text",
                          "text": "NYPA.UploadNYPAEncoreMonthlyBillingPreload",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " into "
                        },
                        {
                          "type": "text",
                          "text": "NYPA.UploadNYPAEncoreMonthlyBilling",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It casts several fields to appropriate data types (e.g., "
                        },
                        {
                          "type": "text",
                          "text": "int",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "money",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "numeric",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ")."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The "
                        },
                        {
                          "type": "text",
                          "text": "@AuthenticatedUserID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and current date ("
                        },
                        {
                          "type": "text",
                          "text": "GetDate()",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ") are inserted into the "
                        },
                        {
                          "type": "text",
                          "text": "AuthenticatedUserID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "DateAdded",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "LastUpdate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " columns."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hard-Coded Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure updates the "
                        },
                        {
                          "type": "text",
                          "text": "AccountNumber",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for specific projects identified by "
                        },
                        {
                          "type": "text",
                          "text": "NypaProjectNumber",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "These updates are hard-coded for three specific projects."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is commented-out logic that suggests a conditional check on billing periods, but it is not active in the current implementation."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating the table can be efficient for clearing data but may not be suitable if the table is large or if data needs to be retained."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Casting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Frequent casting of data types can impact performance, especially if the dataset is large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hard-Coded Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The hard-coded updates can lead to maintenance challenges and should be reviewed for potential optimization or parameterization."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Loss",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating the table without backup or archiving can lead to data loss."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hard-Coded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of hard-coded project numbers and account numbers can lead to errors if project details change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented-Out Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The commented-out logic for billing period comparison suggests incomplete or untested functionality, which could lead to incorrect data processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Lack of Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could result in unhandled exceptions and unclear status reporting."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple users execute this procedure simultaneously, it could lead to race conditions or data integrity issues."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE     PROCEDURE [Nypa].[usp_ProcessNYPATransformEncoreData] (@AuthenticatedUserID int,@StatusCode  int output)\nAS\r\n\r\n--**************************************************************************************\r\n--* Name:         \r\n--*\r\n--* Description:  \r\n--* The data is one billing period ahead of the current reporting period.  Compare the current billing period\r\n--*\tNextBillingPeriodOneMonth to the EncoreBillingPeriod.  If they are equal then use the current billing period for the insert.\r\n--*               \r\n--* Exec:         usp_ProcessNYPATransformEncoreData \r\n--*\r\n--* Parameter(s):         \r\n--*                            @AuthenticatedUserID   \t   - Current billing period\r\n--*                            StatusCode  int output       \t   -  Execution Return Status \r\n--*\r\n--* Database:     OEC\r\n--*\r\n--* Return:\t    0 Success\r\n--*                   9 Failure\r\n--*\r\n--* AUTHOR:       Peter Heller (PAH)\r\n--* Created On:   10/26/2005\r\n--**************************************************************************************\r\n--* Date         Tech Description of Change\r\n--* ---------- ----  -------------------------------------------------------------\r\n--* 05/16/2006 PAH  First Version  \r\n--* 08/18/2011 PAH  Hard coded account number for these three specific encore projects for budgeting purposes \r\n--***************************************************************************************\r\nBegin \r\n--************************************************************************************** \r\n--Declare Variables  \r\ndeclare @BillingPeriod varchar(6)\r\ndeclare @NextBillingPeriod varchar(6)\r\ndeclare @EncoreBillingPeriod varchar(6)\r\n                                         \r\n--**************************************************************************************\r\n\r\n--************************************************************************************** \r\n--\tDeclare Cursor\r\n--**************************************************************************************\r\n--\r\n--************************************************************************************** \r\n--\tMain Processing\r\n--**************************************************************************************\r\n--\r\nTruncate table  NYPA.UploadNYPAEncoreMonthlyBilling\r\n--DBCC CHECKIDENT ('NYPA.UploadNYPAEncoreMonthlyBilling', RESEED,1)\r\n--\r\n--\tThe data is one billing period ahead of the current reporting period.  Compare the current billing period\r\n--\tNextBillingPeriodOneMonth to the EncoreBillingPeriod.  If they are equal then use the current billing period for the insert.\r\n--\r\n--SELECT @BillingPeriod = BillingPeriod, @NextBillingPeriod = NextBillingPeriodOneMonth\r\n--FROM Billing.ApplicationTimeFrame\r\n--WHERE (CurrentProcessingPeriod = 'Y')\r\n----\r\n--select top 1 @EncoreBillingPeriod = BillingPeriod FROM NYPA.UploadNYPAEncoreMonthlyBillingPreload\r\n------\r\n--if (@NextBillingPeriod = @EncoreBillingPeriod)\r\n--\tbegin\r\n\t\tINSERT INTO NYPA.UploadNYPAEncoreMonthlyBilling\r\n\t\t\t\t(\tUtilityCompanyId, \r\n\t\t\t\t\tAccountBillingInvoiceGroup, \r\n\t\t\t\t\tBillingPeriod, \r\n\t\t\t\t\tCICNumber, \r\n\t\t\t\t\tProjectPaymentType, \r\n\t\t\t\t\tProgramCode, \r\n\t\t\t\t\tProgramCodeDescription, \r\n\t\t\t\t\tFinanceCode, \r\n\t\t\t\t\tFinanceCodeDescription, \r\n\t\t\t\t\tAccountNumber, \r\n\t\t\t\t\tAccountName, \r\n\t\t\t\t\tAccountAddress,\r\n\t\t\t\t\tTotalNumberOfPayments, \r\n\t\t\t\t\tTotalPaymentsRemainingAfterPayment, \r\n\t\t\t\t\tFinalCICInstalledCost , \r\n\t\t\t\t\tFinalCICInstalledInterest, \r\n\t\t\t\t\tRateAsOfPeriod, \r\n\t\t\t\t\tAnnualInterestRate, \r\n\t\t\t\t\tRemainderLoanInterest, \r\n\t\t\t\t\tMonthlyPaymentAmount, \r\n\t\t\t\t\tRemainingPrincipalAmountAfterPayment, \r\n\t\t\t\t\tFinalCicAmortizedProjectCost, \r\n\t\t\t\t\tCICProjectDescription,\r\n\t\t\t\t\tProjectPeriodFirstBilled, \r\n\t\t\t\t\tPreviousCICNumber,\r\n\t\t\t\t\tNypaProjectNumber,\r\n\t\t\t\t\tNypaSAPLoanNumber,  \r\n\t\t\t\t\tAuthenticatedUserID, \r\n\t\t\t\t\tDateAdded, \r\n\t\t\t\t\tLastUpdate)\r\n\r\n\t\tSELECT   \r\n\t\t\t\t\tCast([UtilityCompanyId ] as int), \r\n\t\t\t\t\tCast([AccountBillingInvoiceGroup ]as int), \r\n\t\t\t\t\tBillingPeriod, --@BillingPeriod,\r\n\t\t\t\t\t[CICNumber ], \r\n\t\t\t\t\tProjectPaymentType, \r\n\t\t\t\t\tProgramCode, \r\n\t\t\t\t\tProgramCodeDescription, \r\n\t\t\t\t\t[FinanceCode ], \r\n\t\t\t\t\tFinanceCodeDescription, \r\n\t\t\t\t\t[AccountNumber ], \r\n\t\t\t\t\t[AccountName ], \r\n\t\t\t\t\t[AccountAddress ],\r\n\t\t\t\t\t[TotalNumberOfPayments ], \r\n\t\t\t\t\tTotalPaymentsRemainingAfterPayment, \r\n\t\t\t\t\tCast([FinalCICInstalledCost ] as  money),\r\n\t\t\t\t\tCast([FinalCICInstalledInterest ]as  money),\r\n\t\t\t\t\t[RateAsOfPeriod ], \r\n\t\t\t\t\tCast(AnnualInterestRate as  numeric(8,6)  ), \r\n\t\t\t\t\tCast([RemainderLoanInterest] as  money),\r\n\t\t\t\t\tCast([MonthlyPaymentAmount] as  money), \r\n\t\t\t\t\tCast([RemainingPrincipalAmountAfterPayment] as  money), \r\n\t\t\t\t\tCast([FinalCicAmortizedProjectCost] as  money), \r\n\t\t\t\t\tCICProjectDescription,\r\n\t\t\t\t\tProjectPeriodFirstBilled, \r\n\t\t\t\t\tPreviousCICNumber,\r\n\t\t\t\t\tNypaProjectNumber,\r\n\t\t\t\t\tNypaSAPLoanNumber,\r\n\t\t\t\t\t@AuthenticatedUserID,\r\n\t\t\t\t\tGetDate(),\r\n\t\t\t\t\tGetDate()\r\n\t\tFROM     NYPA.UploadNYPAEncoreMonthlyBillingPreload\r\n\t\twhere [UtilityCompanyId ] = N'7'\r\n--\r\n--\t\tHard coded account number for these three specific encore projects\r\n--\r\n\t\tUPDATE    Nypa.UploadNYPAEncoreMonthlyBilling\r\n\t\tSET              AccountNumber ='490016000014004'\r\n\t\tWHERE (NypaProjectNumber = 'ES-GSN-0035')\r\n\r\n\r\n\t\tUPDATE    Nypa.UploadNYPAEncoreMonthlyBilling\r\n\t\tSET              AccountNumber ='008905195100000'\r\n\t\tWHERE (NypaProjectNumber = 'ES-ESN-0122')\r\n\r\n\r\n\t\tUPDATE    Nypa.UploadNYPAEncoreMonthlyBilling\r\n\t\tSET              AccountNumber ='490118224600004'\r\n\t\tWHERE (NypaProjectNumber = 'ES-GSN-0082')\r\n\t\t\r\n--\tend\r\nend"
        }
      ]
    }
  ]
}