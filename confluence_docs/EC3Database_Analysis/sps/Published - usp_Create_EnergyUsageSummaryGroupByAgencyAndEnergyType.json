{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Published",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Create_EnergyUsageSummaryGroupByAgencyAndEnergyType",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Create_EnergyUsageSummaryGroupByAgencyAndEnergyType",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a summary of energy usage data, grouped by agency and energy type, for a specified billing period. It processes data from the "
        },
        {
          "type": "text",
          "text": "Published.AccountLevelRawDataForCurrentPeriod",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table and aggregates it into the "
        },
        {
          "type": "text",
          "text": "Published.EnergyUsageSummaryGroupByAgencyAndEnergyType",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table. The procedure handles both yearly and monthly data, ensuring that the energy usage is summarized at the highest level of the agency hierarchy."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including data filtering, hierarchical data processing, and aggregation. It uses temporary tables, joins, and conditional logic, which adds to its complexity. However, it does not involve highly complex algorithms or recursive operations, keeping it at a medium complexity level."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@publishedPeriod VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the billing period for which the energy usage summary is to be generated. It is expected to be in the format 'YYYYMM', representing the year and month."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Creation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A temporary table "
                },
                {
                  "type": "text",
                  "text": "@agencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is created to store agency division data, including agency codes and their hierarchical relationships."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion and Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure inserts data into "
                },
                {
                  "type": "text",
                  "text": "@agencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " from "
                },
                {
                  "type": "text",
                  "text": "Billing.AgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", excluding specific agency codes ('126000', '042000')."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hierarchy Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure updates the "
                        },
                        {
                          "type": "text",
                          "text": "AncestorAgencyCodeOEC",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for the highest level agencies (those without a parent or specific codes)."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It then propagates the ancestor agency code to child and grandchild records using self-joins on the temporary table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure aggregates energy usage data from "
                        },
                        {
                          "type": "text",
                          "text": "Published.AccountLevelRawDataForCurrentPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for both yearly and monthly periods."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It calculates total usage and BTU, grouping by fiscal year or billing period, energy type, and ancestor agency code."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The results are inserted into "
                        },
                        {
                          "type": "text",
                          "text": "Published.EnergyUsageSummaryGroupByAgencyAndEnergyType",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conditional Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The agency name is modified for certain agency codes to include a prefix ('Cultural - ')."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ordering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The final result set is ordered by ancestor agency code, period span, and energy type."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses multiple joins and updates on the temporary table, which could be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The aggregation operations (SUM, MAX) are performed on potentially large datasets, which could impact performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensuring that the underlying tables have appropriate indexes on columns used in joins and where clauses can improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a temporary table can consume memory and affect performance if not managed properly."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the hierarchy relationships in "
                },
                {
                  "type": "text",
                  "text": "Billing.AgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " are correctly defined. Any discrepancies could lead to incorrect ancestor assignments."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the performance of the procedure may degrade due to the complexity of joins and updates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The exclusion of specific agency codes ('126000', '042000') is hardcoded, which may require updates if business rules change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple instances of this procedure run simultaneously, there could be contention on the temporary table or the target summary table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete data processing."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Published].[usp_Create_EnergyUsageSummaryGroupByAgencyAndEnergyType]\n      @publishedPeriod VARCHAR(6)\r\nAS\r\nBEGIN\r\n\r\nDECLARE @agencyDivision TABLE\r\n(\r\n      AgencyDivisionSeqid seqid,\r\n      AgencyCodeOEC OECAgencyCode,\r\n      ParentAgencyDivisionSeqid seqid null,\r\n      AncestorAgencyCodeOEC OECAgencyCode NULL\r\n)\r\n\r\n-- ignore 12600 and 042000. Data for children of these two divisions will be shown on the report.\r\nINSERT INTO @agencyDivision (AgencyDivisionSeqid,\r\nAgencyCodeOEC,\r\nParentAgencyDivisionSeqid, AncestorAgencyCodeOEC) \r\nSELECT AgencyDivisionSeqid, AgencyCodeOEC, ParentAgencyDivisionSeqid, NULL AS Expr1\r\nFROM Billing.AgencyDivision\r\nWHERE AgencyCodeOEC NOT IN ('126000', '042000')\r\n\r\n\r\n-- self. Highest level of the tree. \r\nUPDATE @agencyDivision\r\nSET AncestorAgencyCodeOEC= AgencyCodeOEC\r\nWHERE \r\nParentAgencyDivisionSeqid IS NULL\r\nOR \r\n(AgencyCodeOEC LIKE '126%' /*AND AgencyCodeOEC <> '126028'*/) \r\nOR\r\n(AgencyCodeOEC IN ('042001', '042002'))\r\n\r\n-- child\r\nUPDATE adChild\r\nSET adChild.AncestorAgencyCodeOEC = adParent.AncestorAgencyCodeOEC\r\nFROM @agencyDivision AS adChild\r\nINNER JOIN @agencyDivision AS adParent\r\nON adChild.ParentAgencyDivisionSeqid = adParent.AgencyDivisionSeqid\r\nWHERE adChild.AncestorAgencyCodeOEC IS NULL\r\n\r\n-- grandchild\r\nUPDATE adChild\r\nSET adChild.AncestorAgencyCodeOEC = adParent.AncestorAgencyCodeOEC\r\nFROM @agencyDivision AS adChild\r\nINNER JOIN @agencyDivision AS adParent\r\nON adChild.ParentAgencyDivisionSeqid = adParent.AgencyDivisionSeqid\r\nWHERE adChild.AncestorAgencyCodeOEC IS NULL\r\n\r\n\r\nINSERT INTO [Published].[EnergyUsageSummaryGroupByAgencyAndEnergyType]\r\n           ([PeriodSpan]\r\n           ,[TypeOfCalculation]\r\n           ,[PublishedBillingPeriod]\r\n           ,[TotalUsage]\r\n           ,[TotalBTU]\r\n           ,[EnergyType]\r\n           ,[AgencyCodeOEC]\r\n           ,[AgencyName])\r\nSELECT \r\n      SummaryData.PeriodSpan,\r\n      SummaryData.TypeOfCalculation,\r\n      SummaryData.PublishedBillingPeriod,\r\n      SummaryData.totalUsage,\r\n      SummaryData.totalBTU,\r\n      SummaryData.EnergyType,\r\n      SummaryData.AncestorAgencyCodeOEC,\r\n       case when SummaryData.AncestorAgencyCodeOEC LIKE '126%' then 'Cultural - '+SummaryData.AgencyName else SummaryData.AgencyName end\r\n\r\nFROM\r\n(\r\n      ( -- yearly data group by highest possible level of the tree \r\n            SELECT  MAX(rawData.FiscalYear) as PeriodSpan,\r\n                              'YTD' AS 'TypeOfCalculation',\r\n                              @publishedPeriod AS 'PublishedBillingPeriod',\r\n                    SUM(CAST(rawData.AccountEnergyUsage AS BIGINT)) totalUsage ,\r\n                    SUM(CAST(rawData.BTU AS NUMERIC(38, 6))) AS totalBTU ,\r\n                    rawData.EnergyType ,\r\n                    ad.AncestorAgencyCodeOEC ,\r\n                    MAX(bad.AgencyName) AS AgencyName\r\n            FROM Published.AccountLevelRawDataForCurrentPeriod AS rawData\r\n                        INNER JOIN @agencyDivision AS ad ON rawData.AgencyCodeOEC = ad.AgencyCodeOEC\r\n                        INNER JOIN Billing.AgencyDivision AS bad ON ad.AncestorAgencyCodeOEC = bad.AgencyCodeOEC\r\n            WHERE   \r\n                        (\r\n                              rawData.FiscalYear = dbo.CalculateFiscalYear(@publishedPeriod) -- current year\r\n                              OR\r\n                              (\r\n                                                CAST(rawData.FiscalYear AS INT) = CAST(dbo.CalculateFiscalYear(@publishedPeriod) AS INT) - 1 -- last fiscal year\r\n                                                AND   \r\n                                                CAST(rawData.BillingPeriod AS INT) <= (CAST(LEFT(@publishedPeriod, 4) AS INT) -1) * 100 + CAST(RIGHT(@publishedPeriod, 2) AS INT)                           \r\n                                          )                                   \r\n                        )\r\n                        AND rawData.PublishedBillingPeriod = @publishedPeriod        \r\n              \r\n            GROUP BY rawData.FiscalYear ,\r\n                        EnergyType ,\r\n                        ad.AncestorAgencyCodeOEC\r\n      )\r\n      UNION\r\n      ( -- monthly data group by highest level of the tree\r\n            SELECT  rawData.BillingPeriod AS PeriodSpan,\r\n                              'MTH' AS 'TypeOfCalculation',\r\n                              @publishedPeriod AS 'PublishedBillingPeriod',\r\n                    SUM(CAST(rawData.AccountEnergyUsage AS BIGINT)) totalUsage ,\r\n                    SUM(CAST(rawData.BTU AS NUMERIC(38, 6))) AS totalBTU ,\r\n                    rawData.EnergyType ,\r\n                    ad.AncestorAgencyCodeOEC ,\r\n                    MAX(bad.AgencyName) AS AgencyName\r\n            FROM Published.AccountLevelRawDataForCurrentPeriod AS rawData\r\n                        INNER JOIN @agencyDivision AS ad ON rawData.AgencyCodeOEC = ad.AgencyCodeOEC\r\n                        INNER JOIN Billing.AgencyDivision AS bad ON ad.AncestorAgencyCodeOEC = bad.AgencyCodeOEC\r\n            WHERE   \r\n                        (\r\n                              rawData.BillingPeriod = @publishedPeriod -- current period\r\n                              OR \r\n                              rawData.BillingPeriod = \r\n                                    CAST(CAST(left(@publishedPeriod, 4) AS INT) - 1 AS VARCHAR) + RIGHT(@publishedPeriod, 2) -- same period last fiscal year\r\n                        )                 \r\n                        AND rawData.PublishedBillingPeriod = @publishedPeriod\r\n            GROUP BY \r\n                  rawData.BillingPeriod, EnergyType, ad.AncestorAgencyCodeOEC\r\n      )\r\n) AS SummaryData\r\nORDER BY AncestorAgencyCodeOEC, periodSpan, EnergyType\r\n\r\nEND"
        }
      ]
    }
  ]
}