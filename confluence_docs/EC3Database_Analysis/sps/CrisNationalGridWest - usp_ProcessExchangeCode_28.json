{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchangeCode_28",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ProcessExchangeCode_28",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to deactivate an account and its associated meters within a utility billing system. It processes records from the "
        },
        {
          "type": "text",
          "text": "UploadExchangeDetail",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table, specifically those with an exchange code of '28'. The procedure checks if the record exists and has not been processed, validates the account's active status, and then updates the account and meter statuses to reflect deactivation. It also logs the process and handles errors using a TRY-CATCH block."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple validation checks, updates across several tables, and error handling, which adds to its complexity. However, it follows a straightforward sequence of operations, making it manageable for those familiar with SQL and transaction handling."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The sequence ID of the record to process."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeCode varchar(2)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The exchange code, expected to be '28'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current billing period in 'YYYYMM' format."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityCompanySeqid INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the utility company."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter indicating the execution status (0 for success, 1 for failure)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validation Checks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Confirms the existence of the record in "
                },
                {
                  "type": "text",
                  "text": "UploadExchangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ensures the record has not been processed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validates that the exchange code is '28'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Checks if the account is active in the "
                },
                {
                  "type": "text",
                  "text": "Billing.Account",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Begins a transaction named "
                },
                {
                  "type": "text",
                  "text": "exchange28",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates the account status to '28' (deactivated) and logs the change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates the "
                },
                {
                  "type": "text",
                  "text": "Billing.AccountExchangeMeterTrack",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to reflect the account and meter deactivation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates the meter status to '27' (turned off) in the "
                },
                {
                  "type": "text",
                  "text": "Billing.Meter",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Marks the record as processed in "
                },
                {
                  "type": "text",
                  "text": "UploadExchangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Uses a TRY-CATCH block to handle errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logs detailed error information and rolls back the transaction if an error occurs."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the "
                },
                {
                  "type": "text",
                  "text": "UploadExchangeDetailSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "CurrentAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " columns are indexed to optimize the SELECT and UPDATE operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is well-defined, but the procedure be optimized by minimizing the number of operations within the transaction to reduce lock contention."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If processing a large number of records, consider batching updates to reduce transaction size and improve performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure could face concurrency issues if multiple instances attempt to update the same records simultaneously. Implementing row-level locking or using isolation levels could mitigate this."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While the procedure logs errors, it could benefit from more granular error handling to differentiate between types of errors (e.g., validation vs. database errors)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that all related tables maintain referential integrity, especially when updating statuses across multiple tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded values for statuses ('28', '27') and utility company ID (2), which could lead to maintenance challenges if these values change. Consider using configuration tables or parameters for flexibility."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [CrisNationalGridWest].[usp_ProcessExchangeCode_28] @AuthenticatedUserID int , @ExchangeSeqid int , @ExchangeCode varchar(2) , @CurrentBillingPeriod VARCHAR(6), @UtilityCompanySeqid INT, @StatusCode int  OUTPUT\n   \r\nAS \r\n \r\nBegin  \r\n\t\t--**************************************************************************************\r\n\t\t--* Name:         \r\n\t\t--*\r\n\t\t--* Description:\tThis stored procedure turns off an active account and all the associated meters\r\n\t\t--*               \r\n\t\t--* Parameter(s):        \r\n\t\t--*\t\t\t\t\t@AuthenticatedUserID int\t\t- the seqid of the user that runs the stored procedure\t\r\n\t\t--*\t\t\t\t\t@ExchangeSeqid int\t\t\t\t- the seqid of the record to process\r\n\t\t--*                 @ExchangeCode int\t\t\t\t- the exchange code in this case 28\r\n\t\t--*\t\t\t\t\t@UtilityCompanySeqid\t\t\t- the utility company \r\n\t\t--*                 @StatusCode  int output\t\t\t- Execution Return Status \r\n\t\t--*\r\n\t\t--*\r\n\t\t--* Return:\t        0 Success\r\n\t\t--*                 1 Failure\r\n\t\t--*\r\n\t\t--* AUTHOR:       MOHAMMED BELARREM\r\n\t\t--* Created On:   04/26/2010\r\n\t\t--**************************************************************************************\r\n\t\t--* Date       Tech Description of Change\r\n\t\t--* ---------- ---\t-------------------------------------------------------------\r\n\t\t--* 04/26/2010 MOH  First Version \r\n\t\t--* 05/10/2010 MOH\tRevised the entire procedure \r\n\t\t--* 05/12/2010 MOH\tUpdate: added the account exchange track account and meter turn on and off \r\n\t\t--**************************************************************************************\r\n\r\n\r\n\t\t--************************************************************************************** \r\n\t\t--Declare Variables                                            \r\n\t\t--**************************************************************************************\r\n\t\t\r\n\t\tDECLARE @AccountNumber NVARCHAR(15)\r\n\t\tDECLARE @MeterNumber NVARCHAR(12)\r\n\t\tDECLARE @AccountTerminationDate VARCHAR(8)\r\n\t\tDECLARE @TurnOffBillingPeriod VARCHAR(6)\r\n\t\tDECLARE @RecordExchangeCode VARCHAR(2)\r\n\r\n\t\t\r\n\t\tdeclare @crlf varchar(2)\r\n\t\tset @crlf = CHAR(13) + CHAR(10) \r\n\t\t\r\n\t\t--**************************************************************************************  \r\n\t\t--Main Process                                      \r\n\t\t--**************************************************************************************\r\n\t\t-- CHECK IF THE record exists\r\n\t\tIF ( NOT EXISTS ( SELECT UploadExchangeDetailSeqid FROM CrisNationalGridWest.UploadExchangeDetail WHERE UploadExchangeDetailSeqid = @ExchangeSeqid ))\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The UploadExchangeDetailSeqid %i does not exist. Please verify. ', 12, 1, @ExchangeSeqid ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\t\t-- check if the record was processed\r\n\t\tIF ( 'Y' = ( SELECT IsProcessed FROM CrisNationalGridWest.UploadExchangeDetail WHERE UploadExchangeDetailSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('This exchange was already processed. exchangeseqid %i ', 12, 1, @ExchangeSeqid ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\t\t-- collect some basic information\r\n\t\tSELECT \r\n\t\t\t@AccountNumber\t\t\t= AccountNumber + '0000', \r\n\t\t\t@MeterNumber\t\t\t= MeterNumber,\t\t\t\t\r\n\t\t\t@AccountTerminationDate = AccountTerminationDate,\r\n\t\t\t@TurnOffBillingPeriod   = BillingPeriod,\r\n\t\t\t@RecordExchangeCode\t\t= ExchangeCode\r\n\t\tFROM CrisNationalGridWest.UploadExchangeDetail\r\n\t\tWHERE   (UploadExchangeDetailSeqid = @ExchangeSeqid)\r\n\r\n\t\t-- some validation\r\n\t\t-- check the obvious\r\n\t\tIF ( @ExchangeCode <> '28' or @ExchangeCode <> @RecordExchangeCode )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The exchange code is not 28. Please verfiy: account number %s and meter number %s ', 12, 1, @AccountNumber, @MeterNumber ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\t\t\r\n\t\t-- verify the account exists under an active status\r\n\t\tIF ( NOT EXISTS (    \r\n\t\t\t\t\t\t\tSELECT * FROM Billing.Account \r\n\t\t\t\t\t\t\tWHERE OriginalAccountNumber = @AccountNumber AND CurrentAccountNumber = @AccountNumber AND AccountStatus IN ('AC' , '47', '46', 'UA') AND UtilityAccountProvider = 2\r\n\t\t   ) )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The account number %s does not exist in the system under an active status. Please verfiy: account number %s ', 12, 1, @AccountNumber ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\tbegin try\t\r\n\t\t\r\n\t\t\t\tbegin TRANSACTION exchange28\r\n\t\t\t\tset @StatusCode  = 0\r\n\t\t\t\t\r\n\r\n\t\t\t\t\r\n\t\t\t\t-- turn off the account\r\n\t\t\t\tupdate Billing.Account\r\n\t\t\t\tSET  AccountPreviousStatus\t = Billing.Account.AccountStatus\r\n\t\t\t\t\t,AccountStatus\t\t\t = '28'\r\n\t\t\t\t\t,AccountStatusCodePeriod = @CurrentBillingPeriod\r\n\t\t\t\t\t,AccountEffectiveTurnOff = @AccountTerminationDate\r\n\t\t\t\t\t,TurnOffDate\t\t\t = @TurnOffBillingPeriod\r\n\t\t\t\t\t,FireAuditTrigger\t\t = 'Y'\r\n\t\t\t\t\t,AuthenticatedUserID     = @AuthenticatedUserID\r\n\t\t\t\t\t,LastUpdate\t\t\t\t = GETDATE()\r\n\t\t\t\t\t \r\n\t\t\t\tFROM Billing.Account\t\t\r\n\t\t\t\tWHERE Billing.Account.OriginalAccountNumber = @AccountNumber \r\n\t\t\t\t\t AND Billing.Account.CurrentAccountNumber = @AccountNumber\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t-- need to do this first before turning off the meters\t \r\n\t\t\t\t-- update the account meter exchange track to reflec the turn off\r\n\t\t\t\tUPDATE  Billing.AccountExchangeMeterTrack\r\n\t\t\t\tSET     AccountEffectiveBillingEndDate  = @AccountTerminationDate\r\n\t\t\t\t\t  , MeterEffectiveBillingEndDate\t= @AccountTerminationDate\r\n\t\t\t\t\t  ,FireAuditTrigger\t\t\t\t\t= 'Y'\r\n\t\t\t\t\t  ,AuthenticatedUserID\t\t\t\t= @AuthenticatedUserID\r\n\t\t\t\t\t  ,LastUpdate\t\t\t\t\t\t= GETDATE()\r\n\r\n\t\t\t\tFROM Billing.AccountExchangeMeterTrack INNER JOIN\r\n\t\t\t\t\t  Billing.Meter ON Billing.AccountExchangeMeterTrack.OriginalMeterSeqid = Billing.Meter.MeterSeqid\r\n\t\t\t\tWHERE Billing.AccountExchangeMeterTrack.OriginalAccountNumber = @AccountNumber \r\n\t\t\t\t\t  AND UtilityCompanySeqid = 2\r\n\t\t\t\t\t  AND Billing.Meter.CurrentMeterNumber = Billing.Meter.OriginalMeterNumber \r\n\t\t\t\t\t  AND Billing.Meter.MeterStatus <> '27'\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t--\tUpdate Meter turn Off 27\r\n\t\t\t\tUPDATE  Billing.Meter\r\n\t\t\t\tSET   \tMeterPreviousStatus\t\t\t= Meter.MeterStatus\r\n\t\t\t\t\t\t,MeterStatus\t\t\t\t= '27'\r\n\t\t\t\t\t\t,MeterStatusCodePeriod\t\t= @CurrentBillingPeriod\r\n\t\t\t\t\t\t,MeterEffectiveOffDate\t\t= @AccountTerminationDate\r\n\t\t\t\t\t\t,TurnOffDate\t\t\t\t= @TurnOffBillingPeriod\r\n\t\t\t\t\t\t,FireAuditTrigger\t\t\t= 'Y'\r\n\t\t\t\t\t\t,AuthenticatedUserID\t\t= @AuthenticatedUserID\r\n\t\t\t\t\t\t,LastUpdate\t\t\t\t\t= GETDATE()\r\n\t\t\t\tFROM Billing.AccountExchangeMeterTrack INNER JOIN\r\n\t\t\t\t\t  Billing.Meter ON Billing.AccountExchangeMeterTrack.OriginalMeterSeqid = Billing.Meter.MeterSeqid\r\n\t\t\t\tWHERE Billing.AccountExchangeMeterTrack.OriginalAccountNumber = @AccountNumber \r\n\t\t\t\t\t  AND UtilityCompanySeqid = 2\r\n\t\t\t\t\t  AND Billing.Meter.CurrentMeterNumber = Billing.Meter.OriginalMeterNumber \r\n\t\t\t\t\t  AND Billing.Meter.MeterStatus <> '27'\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t-- update the account meter exchange track to reflec the turn off on the active meters\r\n\t\t\t\tUPDATE  Billing.AccountExchangeMeterTrack\r\n\t\t\t\tSET     AccountEffectiveBillingEndDate  = @AccountTerminationDate\r\n\t\t\t\t\t  ,FireAuditTrigger\t\t\t\t\t= 'Y'\r\n\t\t\t\t\t  ,AuthenticatedUserID\t\t\t\t= @AuthenticatedUserID\r\n\t\t\t\t\t  ,LastUpdate\t\t\t\t\t\t= GETDATE()\r\n\t\t\t\tWHERE OriginalAccountNumber = @AccountNumber \r\n\t\t\t\t\t  AND UtilityCompanySeqid = 2\r\n\t\t\t\t\r\n\t\t\t\t-- we made it this far \r\n\t\t\t\tUPDATE  CrisNationalGridWest.UploadExchangeDetail\r\n\t\t\t\tSET\t\tIsProcessed = 'Y'\r\n\t\t\t\tWHERE   (UploadExchangeDetailSeqid = @ExchangeSeqid)\r\n\r\n\t\t\t\tcommit TRANSACTION exchange28\r\n\r\n\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\r\n\t\t\t\tDECLARE @ExchangeErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorSeverity INT;\r\n\t\t\t\tDECLARE @ErrorState INT;\r\n\t\t\t\tDECLARE @ErrorNumber INT;\r\n\t\t\t\tDECLARE @ErrorLine INT;\r\n\t\t\t\tDECLARE @ErrorProcedure NVARCHAR(126);\r\n\t\t\t\t--\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t@ExchangeErrorMessage ='Error in StoredProcedure %s at line number %d'+@crlf+'Billing Period: %s'+@crlf+'Exchange Sequence Id:%d'+@crlf+'Account:Meter (%s : %s)  '+@crlf,\r\n\t\t\t\t\t@ErrorMessage = ERROR_MESSAGE(),\r\n\t\t\t\t\t@ErrorSeverity = ERROR_SEVERITY(),\r\n\t\t\t\t\t@ErrorState = ERROR_STATE(),\r\n\t\t\t\t\t@ErrorNumber = ERROR_NUMBER(),\r\n\t\t\t\t\t@ErrorProcedure = ERROR_PROCEDURE(),\r\n\t\t\t\t\t@ErrorLine = ERROR_LINE();\t\t\t\r\n\t\t\t\t--\r\n\t\t\t\tset\t@ErrorMessage = @ExchangeErrorMessage + @ErrorMessage+@crlf+'@ErrorNumber: '+cast(@ErrorNumber as varchar(10))+@crlf\r\n\t\t\t\t--\r\n\t\t\t\tRAISERROR (@ErrorMessage, -- Message text.\r\n\t\t\t\t\t\t   @ErrorSeverity, -- Severity.\r\n\t\t\t\t\t\t   @ErrorState, -- State.\r\n\t\t\t\t\t\t   @ErrorProcedure,\r\n\t\t\t\t\t\t   @ErrorLine,\r\n\t\t\t\t\t\t   @CurrentBillingPeriod,\r\n\t\t\t\t\t\t   @ExchangeSeqid,\r\n\t\t\t\t\t\t   @AccountNumber,\r\n\t\t\t\t\t\t   @MeterNumber\r\n\t\t\t\t\t\t   ) with log;\r\n\t\t\t\t\r\n\t\t\t\tset @StatusCode  = 1\r\n\t\t\t\t\t\t   \r\n\t\t\t\tROLLBACK TRANSACTION exchange28\t\r\n\t\t\t\t\t\t   \r\n\t\tEND CATCH\r\nEnd"
        }
      ]
    }
  ]
}