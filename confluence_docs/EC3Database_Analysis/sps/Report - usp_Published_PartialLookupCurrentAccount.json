{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_PartialLookupCurrentAccount",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_PartialLookupCurrentAccount",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to perform a lookup on current account data based on various criteria. It retrieves detailed account information from a temporal table, "
        },
        {
          "type": "text",
          "text": "Published.TemporalAccountLevelRawDataForCurrentPeriod",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ", and joins it with agency and utility tariff rate information. The procedure supports multiple lookup criteria, such as facility address, account utility service address, service classification, partial account number, facility, and agency. It also logs the usage of the report for auditing purposes."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is medium due to the following reasons:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple conditional branches based on the "
                },
                {
                  "type": "text",
                  "text": "@LookupCriteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs several joins with other tables and functions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes a logging mechanism for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses temporal tables, which adds a layer of complexity in terms of understanding the data's time-based nature."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress NVARCHAR(256)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. It is used for logging and determining agency access."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@LookupCriteria VARCHAR(2)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the type of lookup to perform. Possible values include 'FA', 'AA', 'SC', 'PA', 'FL', and 'AL'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Criteria VARCHAR(100)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The search criteria used in the lookup. This is a partial string that will be matched against specific fields in the database."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by logging the report usage using the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " stored procedure. This includes details such as the report name, stored procedure name, and the requester's email address."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine Current Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It retrieves the current billing period from the "
                },
                {
                  "type": "text",
                  "text": "Billing.ApplicationTimeFrame",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table where "
                },
                {
                  "type": "text",
                  "text": "CurrentProcessingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'Y'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conditional Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Based on the "
                },
                {
                  "type": "text",
                  "text": "@LookupCriteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter, the procedure executes one of several SELECT queries:"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "'FA' (Facility Address)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Searches for records where the address matches the "
                },
                {
                  "type": "text",
                  "text": "@Criteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "'AA' (Account Utility Service Address)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Searches for records where the utility service address matches the "
                },
                {
                  "type": "text",
                  "text": "@Criteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "'SC' (Service Classification)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Searches for records where the delivery tariff rate matches the "
                },
                {
                  "type": "text",
                  "text": "@Criteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "'PA' (Partial Account Number)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Searches for records where the current account number matches the "
                },
                {
                  "type": "text",
                  "text": "@Criteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "'FL' (Facility)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Searches for records where the facility number matches the "
                },
                {
                  "type": "text",
                  "text": "@Criteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "'AL' (Agency)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Searches for records where the agency code matches the "
                },
                {
                  "type": "text",
                  "text": "@Criteria",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Each SELECT query retrieves a comprehensive set of account-related fields, including billing period, utility company, energy type, account numbers, facility details, and tariff rate information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ordering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The results are ordered by account number and billing period in descending order."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the columns used in the WHERE clauses and JOIN conditions are indexed to improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "String Operations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "LIKE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with leading wildcards ('%') can lead to full table scans, which degrade performance on large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporal Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporal tables can impact performance due to the additional overhead of managing historical data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging Overhead",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The logging mechanism adds some overhead, but it is necessary for auditing purposes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the procedure is protected against SQL injection, especially since it uses dynamic criteria in the WHERE clause."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the "
                },
                {
                  "type": "text",
                  "text": "Billing.ApplicationTimeFrame",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table always has a row with "
                },
                {
                  "type": "text",
                  "text": "CurrentProcessingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " set to 'Y'. If this assumption fails, it could lead to errors or incorrect results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the performance of the procedure may degrade, particularly due to the use of "
                },
                {
                  "type": "text",
                  "text": "LIKE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with leading wildcards."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions in case of failures during execution."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Description:  \r\n--*\r\n--* AUTHOR:            \r\n--* Created On :  \r\n--**************************************************************************************\r\n--* Date       Tech Description of Change\r\n--* ---------- ---\t-------------------------------------------------------------\r\n--* 2015-11-13  ZD  Added Report log SP block\r\n--* 03/17/2016\tZD\tUpdate: Changed to use temporal tables \r\n--**************************************************************************************\r\n\r\n\r\n\r\nCREATE    PROCEDURE [Report].[usp_Published_PartialLookupCurrentAccount]\r\n    (\r\n      @EmailAddress NVARCHAR(256) ,\r\n      @LookupCriteria VARCHAR(2) ,\r\n      @Criteria VARCHAR(100)\r\n    )\r\nAS \r\n    BEGIN\r\n\r\n\r\n--------------------------------------------------------------------------\r\n-- This block is added to track report log -------------------------------\r\n DECLARE @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID)\r\nEXEC [Audit].usp_AddReportUsageLog\r\n\t@ReportName\t\t\t\t\t= @spname,\r\n    @StoredProcName\t\t\t\t= @spname,\r\n    @RequestedBy\t\t\t\t= @EmailAddress,\r\n    \r\n    @prmPublishedBillingPeriod\t= NULL,\r\n    @prmBillingPeriod\t\t\t= NULL,\r\n    @prmAgency_ies\t\t\t\t= NULL,\r\n    @prmFacilityNumber_s\t\t= NULL,\r\n    @prmStartingBillingPeriod\t= NULL,\r\n    @prmEndingBillingPeriod\t\t= NULL\r\n\r\n--------------------------------------------------------------------------\r\n        DECLARE @AgencyCode VARCHAR(7)\r\n        DECLARE @PublishedBillingPeriod VARCHAR(6)\r\n--\r\n        SELECT  @PublishedBillingPeriod = PublishedBillingPeriod\r\n        FROM Billing.ApplicationTimeFrame\r\n        WHERE   ( CurrentProcessingPeriod = 'Y' )\r\n--\r\n        IF ( @LookupCriteria = 'FA' ) -- Facility Address look up\r\n            BEGIN\r\n                SELECT  talrdfcp.Seqid AS RawDataForCurrentPeriodSeqid ,\r\n                        @PublishedBillingPeriod AS PublishedBillingPeriod ,\r\n                        talrdfcp.BillingPeriod ,\r\n                        talrdfcp.UtilityCompany ,\r\n                        talrdfcp.EnergyType ,\r\n                        talrdfcp.CurrentInvoiceAccountBillingGroup ,\r\n                        talrdfcp.InvoiceAccountBillingGroupDesc ,\r\n                        talrdfcp.OecFacilityNumber ,\r\n                        talrdfcp.AgencyCodeOEC ,\r\n                        talrdfcp.AgencyName ,\r\n                        talrdfcp.Address1 ,\r\n                        talrdfcp.CurrentAccountNumber ,\r\n                        talrdfcp.OriginalAccountNumber ,\r\n                        talrdfcp.FacilityName ,\r\n                        talrdfcp.Borough ,\r\n                        talrdfcp.Block ,\r\n                        talrdfcp.LotNumber ,\r\n                        talrdfcp.CityPlanningBIN ,\r\n                        talrdfcp.EnergyUnit ,\r\n                        talrdfcp.AccountStatus ,\r\n                        talrdfcp.AccountPreviousStatus ,\r\n                        talrdfcp.AccountStatusCodePeriod ,\r\n                        talrdfcp.IsTimeOfDayAccount ,\r\n                        talrdfcp.SalesType ,\r\n                        talrdfcp.DeliveryTariffRate ,\r\n                        talrdfcp.CommodityTariffRate ,\r\n                        talrdfcp.BudgetGroupDEM ,\r\n                        --talrdfcp.BudgetaryUnitRateDEM ,\r\n                        NULL AS BudgetaryGroupSEPTS, --talrdfcp.BudgetaryGroupSEPTS ,\r\n                        --talrdfcp.BudgetaryUnitRateSEPTS ,\r\n                        talrdfcp.BillingCycle ,\r\n                        talrdfcp.UtilityServiceAddress ,\r\n                        talrdfcp.EnergyDeliveryType ,\r\n                        talrdfcp.AccountEffectiveTurnOn ,\r\n                        talrdfcp.AccountEffectiveTurnOff ,\r\n                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup1) AS RateGroup1 ,\r\n                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup2) AS RateGroup2 ,\r\n                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup3) AS RateGroup3 ,\r\n                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup4) AS RateGroup4 ,\r\n                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup5) AS RateGroup5 ,\r\n                        Billing.UtilityTariffRateInformation.Description ,\r\n                        Billing.UtilityTariffRateInformation.BudgetGroupDEM ,\r\n                        Billing.UtilityTariffRateInformation.BudgetRateClassDescription\r\n                FROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS talrdfcp\r\n                        INNER JOIN dbo.uftn_TableGetAgencyByEmailAddressAgencyAccessAction(@EmailAddress)\r\n                       AS uftn_TableGetAgencyByMemberAgencyAccessAction_1 ON talrdfcp.AgencyCodeOEC = uftn_TableGetAgencyByMemberAgencyAccessAction_1.AgencyCodeOEC\r\n                        INNER JOIN Billing.UtilityTariffRateInformation ON talrdfcp.UtilityTariffRateInformationSeqid = Billing.UtilityTariffRateInformation.UtilityTariffRateInformationSeqid\r\n                WHERE   (talrdfcp.EffectiveStartPeriod <= @PublishedBillingPeriod AND talrdfcp.EffectiveEndPeriod > @PublishedBillingPeriod)\r\n                        AND Address1 LIKE '%' + RTRIM(LTRIM(@Criteria)) + '%'\r\n                ORDER BY OecFacilityNumber ,\r\n                        talrdfcp.CurrentAccountNumber ,\r\n                        talrdfcp.BillingPeriod DESC\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n            END\r\n        ELSE \r\n            IF ( @LookupCriteria = 'AA' ) -- Account Utility Service Address look up\r\n                BEGIN\r\n                    SELECT  talrdfcp.seqid AS RawDataForCurrentPeriodSeqid ,\r\n                            @PublishedBillingPeriod AS PublishedBillingPeriod ,\r\n                            talrdfcp.BillingPeriod ,\r\n                            talrdfcp.UtilityCompany ,\r\n                            talrdfcp.EnergyType ,\r\n                            talrdfcp.CurrentInvoiceAccountBillingGroup ,\r\n                            talrdfcp.InvoiceAccountBillingGroupDesc ,\r\n                            talrdfcp.OecFacilityNumber ,\r\n                            talrdfcp.AgencyCodeOEC ,\r\n                            talrdfcp.AgencyName ,\r\n                            talrdfcp.Address1 ,\r\n                            talrdfcp.CurrentAccountNumber ,\r\n                            talrdfcp.OriginalAccountNumber ,\r\n                            talrdfcp.FacilityName ,\r\n                            talrdfcp.Borough ,\r\n                            talrdfcp.Block ,\r\n                            talrdfcp.LotNumber ,\r\n                            talrdfcp.CityPlanningBIN ,\r\n                            talrdfcp.EnergyUnit ,\r\n                            talrdfcp.AccountStatus ,\r\n                            talrdfcp.AccountPreviousStatus ,\r\n                            talrdfcp.AccountStatusCodePeriod ,\r\n                            talrdfcp.IsTimeOfDayAccount ,\r\n                            talrdfcp.SalesType ,\r\n                            talrdfcp.DeliveryTariffRate ,\r\n                            talrdfcp.CommodityTariffRate ,\r\n                            talrdfcp.BudgetGroupDEM ,\r\n                            --talrdfcp.BudgetaryUnitRateDEM ,\r\n                            NULL AS BudgetaryGroupSEPTS,--talrdfcp.BudgetaryGroupSEPTS ,\r\n                            --talrdfcp.BudgetaryUnitRateSEPTS ,\r\n                            talrdfcp.BillingCycle ,\r\n                            talrdfcp.UtilityServiceAddress ,\r\n                            talrdfcp.EnergyDeliveryType ,\r\n                            talrdfcp.AccountEffectiveTurnOn ,\r\n                            talrdfcp.AccountEffectiveTurnOff ,\r\n                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup1) AS RateGroup1 ,\r\n                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup2) AS RateGroup2 ,\r\n                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup3) AS RateGroup3 ,\r\n                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup4) AS RateGroup4 ,\r\n                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup5) AS RateGroup5 ,\r\n                            Billing.UtilityTariffRateInformation.Description ,\r\n                            Billing.UtilityTariffRateInformation.BudgetGroupDEM ,\r\n                            Billing.UtilityTariffRateInformation.BudgetRateClassDescription\r\n                    FROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS talrdfcp\r\n                            INNER JOIN dbo.uftn_TableGetAgencyByEmailAddressAgencyAccessAction(@EmailAddress)\r\n                           AS uftn_TableGetAgencyByMemberAgencyAccessAction_1 ON talrdfcp.AgencyCodeOEC = uftn_TableGetAgencyByMemberAgencyAccessAction_1.AgencyCodeOEC\r\n                            INNER JOIN Billing.UtilityTariffRateInformation ON talrdfcp.UtilityTariffRateInformationSeqid = Billing.UtilityTariffRateInformation.UtilityTariffRateInformationSeqid\r\n                    WHERE   (talrdfcp.EffectiveStartPeriod <= @PublishedBillingPeriod AND talrdfcp.EffectiveEndPeriod > @PublishedBillingPeriod)\r\n\t\t\t\t\t        AND UtilityServiceAddress LIKE '%'\r\n                            + RTRIM(LTRIM(@Criteria)) + '%'\r\n                    ORDER BY talrdfcp.CurrentAccountNumber ,\r\n                            talrdfcp.BillingPeriod DESC\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n                END\r\n            ELSE \r\n                IF ( @LookupCriteria = 'SC' ) -- Service Classification look up\r\n                    BEGIN\r\n                        SELECT  talrdfcp.seqid AS RawDataForCurrentPeriodSeqid ,\r\n                                @PublishedBillingPeriod AS PublishedBillingPeriod ,\r\n                                talrdfcp.BillingPeriod ,\r\n                                talrdfcp.UtilityCompany ,\r\n                                talrdfcp.EnergyType ,\r\n                                talrdfcp.CurrentInvoiceAccountBillingGroup ,\r\n                                talrdfcp.InvoiceAccountBillingGroupDesc ,\r\n                                talrdfcp.OecFacilityNumber ,\r\n                                talrdfcp.AgencyCodeOEC ,\r\n                                talrdfcp.AgencyName ,\r\n                                talrdfcp.Address1 ,\r\n                                talrdfcp.CurrentAccountNumber ,\r\n                                talrdfcp.OriginalAccountNumber ,\r\n                                talrdfcp.FacilityName ,\r\n                                talrdfcp.Borough ,\r\n                                talrdfcp.Block ,\r\n                                talrdfcp.LotNumber ,\r\n                                talrdfcp.CityPlanningBIN ,\r\n                                talrdfcp.EnergyUnit ,\r\n                                talrdfcp.AccountStatus ,\r\n                                talrdfcp.AccountPreviousStatus ,\r\n                                talrdfcp.AccountStatusCodePeriod ,\r\n                                talrdfcp.IsTimeOfDayAccount ,\r\n                                talrdfcp.SalesType ,\r\n                                talrdfcp.DeliveryTariffRate ,\r\n                                talrdfcp.CommodityTariffRate ,\r\n                                talrdfcp.BudgetGroupDEM ,\r\n                                --talrdfcp.BudgetaryUnitRateDEM ,\r\n                                NULL AS BudgetaryGroupSEPTS,--talrdfcp.BudgetaryGroupSEPTS ,\r\n                                --talrdfcp.BudgetaryUnitRateSEPTS ,\r\n                                talrdfcp.BillingCycle ,\r\n                                talrdfcp.UtilityServiceAddress ,\r\n                                talrdfcp.EnergyDeliveryType ,\r\n                                talrdfcp.AccountEffectiveTurnOn ,\r\n                                talrdfcp.AccountEffectiveTurnOff ,\r\n                                Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup1) AS RateGroup1 ,\r\n                                Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup2) AS RateGroup2 ,\r\n                                Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup3) AS RateGroup3 ,\r\n                                Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup4) AS RateGroup4 ,\r\n                                Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup5) AS RateGroup5 ,\r\n                                Billing.UtilityTariffRateInformation.Description ,\r\n                                Billing.UtilityTariffRateInformation.BudgetGroupDEM ,\r\n                                Billing.UtilityTariffRateInformation.BudgetRateClassDescription\r\n                        FROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS talrdfcp\r\n                                INNER JOIN dbo.uftn_TableGetAgencyByEmailAddressAgencyAccessAction(@EmailAddress)\r\n                               AS uftn_TableGetAgencyByMemberAgencyAccessAction_1 ON talrdfcp.AgencyCodeOEC = uftn_TableGetAgencyByMemberAgencyAccessAction_1.AgencyCodeOEC\r\n                                INNER JOIN Billing.UtilityTariffRateInformation ON talrdfcp.UtilityTariffRateInformationSeqid = Billing.UtilityTariffRateInformation.UtilityTariffRateInformationSeqid\r\n                        WHERE   (talrdfcp.EffectiveStartPeriod <= @PublishedBillingPeriod AND talrdfcp.EffectiveEndPeriod > @PublishedBillingPeriod)\r\n                                AND talrdfcp.DeliveryTariffRate LIKE '%'\r\n                                + RTRIM(LTRIM(@Criteria)) + '%'\r\n                        ORDER BY talrdfcp.CurrentAccountNumber ,\r\n                                talrdfcp.BillingPeriod DESC\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n                    END\r\n                ELSE \r\n                    IF ( @LookupCriteria = 'PA' ) -- Partial Account Number look up\r\n                        BEGIN\r\n                            SELECT  talrdfcp.seqid AS RawDataForCurrentPeriodSeqid ,\r\n                                    @PublishedBillingPeriod AS PublishedBillingPeriod ,\r\n                                    talrdfcp.BillingPeriod ,\r\n                                    talrdfcp.UtilityCompany ,\r\n                                    talrdfcp.EnergyType ,\r\n                                    talrdfcp.CurrentInvoiceAccountBillingGroup ,\r\n                                    talrdfcp.InvoiceAccountBillingGroupDesc ,\r\n                                    talrdfcp.OecFacilityNumber ,\r\n                                    talrdfcp.AgencyCodeOEC ,\r\n                                    talrdfcp.AgencyName ,\r\n                                    talrdfcp.Address1 ,\r\n                                    talrdfcp.CurrentAccountNumber ,\r\n                                    talrdfcp.OriginalAccountNumber ,\r\n                                    talrdfcp.FacilityName ,\r\n                                    talrdfcp.Borough ,\r\n                                    talrdfcp.Block ,\r\n                                    talrdfcp.LotNumber ,\r\n                                    talrdfcp.CityPlanningBIN ,\r\n                                    talrdfcp.EnergyUnit ,\r\n                                    talrdfcp.AccountStatus ,\r\n                                    talrdfcp.AccountPreviousStatus ,\r\n                                    talrdfcp.AccountStatusCodePeriod ,\r\n                                    talrdfcp.IsTimeOfDayAccount ,\r\n                                    talrdfcp.SalesType ,\r\n                                    talrdfcp.DeliveryTariffRate ,\r\n                                    talrdfcp.CommodityTariffRate ,\r\n                                    talrdfcp.BudgetGroupDEM ,\r\n                                    --talrdfcp.BudgetaryUnitRateDEM ,\r\n                                    NULL AS BudgetaryGroupSEPTS,--talrdfcp.BudgetaryGroupSEPTS ,\r\n                                    --talrdfcp.BudgetaryUnitRateSEPTS ,\r\n                                    talrdfcp.BillingCycle ,\r\n                                    talrdfcp.UtilityServiceAddress ,\r\n                                    talrdfcp.EnergyDeliveryType ,\r\n                                    talrdfcp.AccountEffectiveTurnOn ,\r\n                                    talrdfcp.AccountEffectiveTurnOff ,\r\n                                    Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup1) AS RateGroup1 ,\r\n                                    Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup2) AS RateGroup2 ,\r\n                                    Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup3) AS RateGroup3 ,\r\n                                    Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup4) AS RateGroup4 ,\r\n                                    Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup5) AS RateGroup5 ,\r\n                                    Billing.UtilityTariffRateInformation.Description ,\r\n                                    Billing.UtilityTariffRateInformation.BudgetGroupDEM ,\r\n                                    Billing.UtilityTariffRateInformation.BudgetRateClassDescription\r\n                            FROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS talrdfcp\r\n                                    INNER JOIN dbo.uftn_TableGetAgencyByEmailAddressAgencyAccessAction(@EmailAddress)\r\n                                   AS uftn_TableGetAgencyByMemberAgencyAccessAction_1 ON talrdfcp.AgencyCodeOEC = uftn_TableGetAgencyByMemberAgencyAccessAction_1.AgencyCodeOEC\r\n                                    INNER JOIN Billing.UtilityTariffRateInformation ON talrdfcp.UtilityTariffRateInformationSeqid = Billing.UtilityTariffRateInformation.UtilityTariffRateInformationSeqid\r\n                            WHERE   (talrdfcp.EffectiveStartPeriod <= @PublishedBillingPeriod AND talrdfcp.EffectiveEndPeriod > @PublishedBillingPeriod)\r\n                                    AND CurrentAccountNumber LIKE '%'\r\n                                    + RTRIM(LTRIM(@Criteria)) + '%'\r\n                            ORDER BY talrdfcp.CurrentAccountNumber ,\r\n                                    talrdfcp.BillingPeriod DESC\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n                        END\r\n                    ELSE \r\n                        IF ( @LookupCriteria = 'FL' ) -- Facility look up\r\n                            BEGIN\r\n                                SELECT  talrdfcp.seqid AS RawDataForCurrentPeriodSeqid ,\r\n                                        @PublishedBillingPeriod AS PublishedBillingPeriod ,\r\n                                        talrdfcp.BillingPeriod ,\r\n                                        talrdfcp.UtilityCompany ,\r\n                                        talrdfcp.EnergyType ,\r\n                                        talrdfcp.CurrentInvoiceAccountBillingGroup ,\r\n                                        talrdfcp.InvoiceAccountBillingGroupDesc ,\r\n                                        talrdfcp.OecFacilityNumber ,\r\n                                        talrdfcp.AgencyCodeOEC ,\r\n                                        talrdfcp.AgencyName ,\r\n                                        talrdfcp.Address1 ,\r\n                                        talrdfcp.CurrentAccountNumber ,\r\n                                        talrdfcp.OriginalAccountNumber ,\r\n                                        talrdfcp.FacilityName ,\r\n                                        talrdfcp.Borough ,\r\n                                        talrdfcp.Block ,\r\n                                        talrdfcp.LotNumber ,\r\n                                        talrdfcp.CityPlanningBIN ,\r\n                                        talrdfcp.EnergyUnit ,\r\n                                        talrdfcp.AccountStatus ,\r\n                                        talrdfcp.AccountPreviousStatus ,\r\n                                        talrdfcp.AccountStatusCodePeriod ,\r\n                                        talrdfcp.IsTimeOfDayAccount ,\r\n                                        talrdfcp.SalesType ,\r\n                                        talrdfcp.DeliveryTariffRate ,\r\n                                        talrdfcp.CommodityTariffRate ,\r\n                                        talrdfcp.BudgetGroupDEM ,\r\n                                        --talrdfcp.BudgetaryUnitRateDEM ,\r\n                                        NULL AS BudgetaryGroupSEPTS,--talrdfcp.BudgetaryGroupSEPTS ,\r\n                                        --talrdfcp.BudgetaryUnitRateSEPTS ,\r\n                                        talrdfcp.BillingCycle ,\r\n                                        talrdfcp.UtilityServiceAddress ,\r\n                                        talrdfcp.EnergyDeliveryType ,\r\n                                        talrdfcp.AccountEffectiveTurnOn ,\r\n                                        talrdfcp.AccountEffectiveTurnOff ,\r\n                                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup1) AS RateGroup1 ,\r\n                                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup2) AS RateGroup2 ,\r\n                                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup3) AS RateGroup3 ,\r\n                                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup4) AS RateGroup4 ,\r\n                                        Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup5) AS RateGroup5 ,\r\n                                        Billing.UtilityTariffRateInformation.Description ,\r\n                                        Billing.UtilityTariffRateInformation.BudgetGroupDEM ,\r\n                                        Billing.UtilityTariffRateInformation.BudgetRateClassDescription\r\n                                FROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS talrdfcp\r\n                                        INNER JOIN dbo.uftn_TableGetAgencyByEmailAddressAgencyAccessAction(@EmailAddress)\r\n                                       AS uftn_TableGetAgencyByMemberAgencyAccessAction_1 ON talrdfcp.AgencyCodeOEC = uftn_TableGetAgencyByMemberAgencyAccessAction_1.AgencyCodeOEC\r\n                                        INNER JOIN Billing.UtilityTariffRateInformation ON talrdfcp.UtilityTariffRateInformationSeqid = Billing.UtilityTariffRateInformation.UtilityTariffRateInformationSeqid\r\n                                WHERE   (talrdfcp.EffectiveStartPeriod <= @PublishedBillingPeriod AND talrdfcp.EffectiveEndPeriod > @PublishedBillingPeriod)\r\n                                        AND OecFacilityNumber LIKE '%'\r\n                                        + RTRIM(LTRIM(@Criteria)) + '%'\r\n                                ORDER BY talrdfcp.CurrentAccountNumber ,\r\n                                        talrdfcp.BillingPeriod DESC\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n                            END\r\n                        ELSE \r\n                            IF ( @LookupCriteria = 'AL' ) -- Agency look up\r\n                                BEGIN\r\n                                    SELECT  talrdfcp.seqid AS RawDataForCurrentPeriodSeqid ,\r\n                                            @PublishedBillingPeriod AS PublishedBillingPeriod ,\r\n                                            talrdfcp.BillingPeriod ,\r\n                                            talrdfcp.UtilityCompany ,\r\n                                            talrdfcp.EnergyType ,\r\n                                            talrdfcp.CurrentInvoiceAccountBillingGroup ,\r\n                                            talrdfcp.InvoiceAccountBillingGroupDesc ,\r\n                                            talrdfcp.OecFacilityNumber ,\r\n                                            talrdfcp.AgencyCodeOEC ,\r\n                                            talrdfcp.AgencyName ,\r\n                                            talrdfcp.Address1 ,\r\n                                            talrdfcp.CurrentAccountNumber ,\r\n                                            talrdfcp.OriginalAccountNumber ,\r\n                                            talrdfcp.FacilityName ,\r\n                                            talrdfcp.Borough ,\r\n                                            talrdfcp.Block ,\r\n                                            talrdfcp.LotNumber ,\r\n                                            talrdfcp.CityPlanningBIN ,\r\n                                            talrdfcp.EnergyUnit ,\r\n                                            talrdfcp.AccountStatus ,\r\n                                            talrdfcp.AccountPreviousStatus ,\r\n                                            talrdfcp.AccountStatusCodePeriod ,\r\n                                            talrdfcp.IsTimeOfDayAccount ,\r\n                                            talrdfcp.SalesType ,\r\n                                            talrdfcp.DeliveryTariffRate ,\r\n                                            talrdfcp.CommodityTariffRate ,\r\n                                            talrdfcp.BudgetGroupDEM ,\r\n                                            --talrdfcp.BudgetaryUnitRateDEM ,\r\n                                            NULL AS BudgetaryGroupSEPTS,--talrdfcp.BudgetaryGroupSEPTS ,\r\n                                            --talrdfcp.BudgetaryUnitRateSEPTS ,\r\n                                            talrdfcp.BillingCycle ,\r\n                                            talrdfcp.UtilityServiceAddress ,\r\n                                            talrdfcp.EnergyDeliveryType ,\r\n                                            talrdfcp.AccountEffectiveTurnOn ,\r\n                                            talrdfcp.AccountEffectiveTurnOff ,\r\n                                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup1) AS RateGroup1 ,\r\n                                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup2) AS RateGroup2 ,\r\n                                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup3) AS RateGroup3 ,\r\n                                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup4) AS RateGroup4 ,\r\n                                            Report.DetermineRateGroupLongDescription(Billing.UtilityTariffRateInformation.RateGroup5) AS RateGroup5 ,\r\n                                            Billing.UtilityTariffRateInformation.Description ,\r\n                                            Billing.UtilityTariffRateInformation.BudgetGroupDEM ,\r\n                                            Billing.UtilityTariffRateInformation.BudgetRateClassDescription\r\n                                    FROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS talrdfcp\r\n                                            INNER JOIN dbo.uftn_TableGetAgencyByEmailAddressAgencyAccessAction(@EmailAddress)\r\n                                           AS uftn_TableGetAgencyByMemberAgencyAccessAction_1 ON talrdfcp.AgencyCodeOEC = uftn_TableGetAgencyByMemberAgencyAccessAction_1.AgencyCodeOEC\r\n                                            INNER JOIN Billing.UtilityTariffRateInformation ON talrdfcp.UtilityTariffRateInformationSeqid = Billing.UtilityTariffRateInformation.UtilityTariffRateInformationSeqid\r\n                                    WHERE   (talrdfcp.EffectiveStartPeriod <= @PublishedBillingPeriod AND talrdfcp.EffectiveEndPeriod > @PublishedBillingPeriod)\r\n                                            AND talrdfcp.AgencyCodeOEC LIKE '%'\r\n                                            + RTRIM(LTRIM(@Criteria)) + '%'\r\n                                    ORDER BY talrdfcp.CurrentAccountNumber ,\r\n                                            talrdfcp.BillingPeriod DESC\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n                                END\r\n\t\t\t\r\n    END"
        }
      ]
    }
  ]
}