{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "SBMR",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_SBMR_TerminatedAccounts",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_SBMR_TerminatedAccounts",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve information about terminated accounts from a database. It primarily focuses on accounts that have been marked with specific actions (between 4 and 6) and have a non-zero revised billed amount. The procedure joins multiple tables from two schemas, "
        },
        {
          "type": "text",
          "text": "SBMR",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " and "
        },
        {
          "type": "text",
          "text": "Billing",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ", to compile a comprehensive dataset that includes account numbers, utility company details, billing periods, and account statuses. The procedure also contains a commented-out section that suggests an additional query for accounts that have been turned off and belong to SBMR, but this part is not executed."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this stored procedure is medium. It involves multiple table joins, conditional filtering, and ordering of results. The commented-out section indicates potential additional complexity if it were to be included. The procedure does not use any input parameters, which simplifies its execution but limits its flexibility."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure does not have any input parameters. It operates on the entire dataset available in the referenced tables, which means it cannot be dynamically filtered or customized at runtime without modifying the procedure itself."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure joins several tables from the "
                },
                {
                  "type": "text",
                  "text": "SBMR",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "Billing",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " schemas. These joins are based on foreign key relationships, such as "
                },
                {
                  "type": "text",
                  "text": "SBMRHeaderSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "UtilityCompanySeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The main query filters records where the "
                },
                {
                  "type": "text",
                  "text": "SBMRAction",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is between 4 and 6 and where the "
                },
                {
                  "type": "text",
                  "text": "RevisedBilledAmount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is not zero. This suggests a focus on accounts that have undergone specific actions and have financial transactions associated with them."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ordering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The results are ordered by "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " in descending order and then by "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which helps in organizing the data chronologically and by account."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented-out Section",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The commented-out section suggests an additional query for accounts that have been turned off, with conditions on "
                },
                {
                  "type": "text",
                  "text": "AccountEffectiveTurnOff",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "AccountStatus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ". This section is not executed but indicates potential additional functionality."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple inner joins, which can be resource-intensive, especially if the tables are large. Ensuring that the joined columns are indexed can help improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filtering and Ordering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of filters and ordering can impact performance. Indexes on "
                },
                {
                  "type": "text",
                  "text": "SBMRAction",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "RevisedBilledAmount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " would be beneficial."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented-out Code",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The presence of commented-out code suggests potential additional logic that could increase complexity and resource usage if activated."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Lack of Input Parameters",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The absence of input parameters limits the procedure's flexibility and requires modification for any changes in filtering criteria."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Filters",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The hardcoded filters (e.g., "
                },
                {
                  "type": "text",
                  "text": "SBMRAction",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " between 4 and 6) may not be adaptable to changing business requirements without altering the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented-out Code",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The commented-out section, if uncommented, could introduce additional complexity and performance overhead. It should be reviewed and tested thoroughly before activation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that all joins will succeed, which may not be the case if there are data integrity issues in the database. Proper error handling and validation should be considered."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "Overall, while the procedure is functional for its intended purpose, it could benefit from enhancements in flexibility, performance optimization, and error handling."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Mubarak,Abdella>\r\n-- Create date: <04-15-2010>\r\n-- Description:\t<Terminated Accounts>\r\n\r\n-- Modified Date: <04-28-2011>\r\n-- Author: Chakradhar Cheemarla\r\n---- =============================================\r\nCREATE PROCEDURE [SBMR].[usp_SBMR_TerminatedAccounts]\r\n\r\nAS\r\nBEGIN\r\nSELECT  SBMR.SBMRAccount.OriginalAccountNumber ,\r\n        SBMR.SBMRHeader.ELOAddress ,\r\n        Billing.AgencyDivision.AgencyName ,\r\n        SBMR.SBMRHeader.SbmrReferenceNumber ,\r\n        Billing.Facility.OecFacilityNumber ,\r\n        Billing.AccountBilling.BillingPeriod ,\r\n        Billing.UtilityCompany.ShortDesc AS SBMRUtilityCompany ,\r\n        SBMR.SBMRHeader.RequestedAccountEffectiveDate ,\r\n        SBMR.SBMRHeader.DateSentToUtilityCompany ,\r\n        SBMR.SBMRHeader.DateUtilityCompanyConfirmedReceipt ,\r\n        Billing.AccountBilling.RevisedBilledAmount ,\r\n        Billing.Account.AccountStatus ,\r\n        Billing.Account.AccountEffectiveTurnOff ,\r\n        Billing.EnergyDeliveryType.ShortDesc ,\r\n        Billing.EnergyDeliveryType.EnergyType ,\r\n        billing.accountbilling.ToDate ,\r\n        AccountUtilityCompany.ShortDesc AS AccountUtilityCompany\r\nFROM SBMR.SBMRHeader\r\n        INNER JOIN SBMR.SBMRAccount ON SBMR.SBMRHeader.SBMRHeaderSeqid = SBMR.SBMRAccount.SBMRHeaderSeqid\r\n        INNER JOIN Billing.AccountBilling ON SBMR.SBMRAccount.OriginalAccountNumber = Billing.AccountBilling.OriginalAccountNumber\r\n                                             AND SBMR.SBMRHeader.RequestedAccountEffectiveDate < Billing.AccountBilling.ToDate\r\n        INNER JOIN Billing.UtilityCompany ON SBMR.SBMRHeader.CommodityUtilityCompanySeqid = UtilityCompany.UtilityCompanySeqid\r\n                                             AND SBMR.SBMRHeader.DeliveryUtilityCompanySeqid = UtilityCompany.UtilityCompanySeqid\r\n        INNER JOIN Billing.Facility ON SBMR.SBMRHeader.FacilitySeqid = Facility.FacilitySeqid\r\n        INNER JOIN Billing.AgencyDivision ON SBMR.SBMRHeader.AgencyDivisionSeqid = Billing.AgencyDivision.AgencyDivisionSeqid\r\n        INNER JOIN Billing.Account ON Billing.AccountBilling.AccountSeqid = Billing.Account.AccountSeqid\r\n        INNER JOIN Billing.EnergyDeliveryType ON EnergyDeliveryType.EnergyDeliveryType = Billing.AccountBilling.EnergySource\r\n        INNER JOIN Billing.UtilityCompany AS AccountUtilityCompany ON Account.UtilityAccountProvider = AccountUtilityCompany.UtilityCompanySeqid\r\nWHERE   ( SBMR.SBMRHeader.SBMRAction BETWEEN 4 AND 6 )\r\n        AND ( Billing.AccountBilling.RevisedBilledAmount <> 0 )\r\nORDER BY BillingPeriod DESC, Billing.Account.OriginalAccountNumber\r\n        \r\n--\r\n/*\r\nUNION\r\n(\r\n /*Accounts that are turned off, and belong to SBMR. */ \r\n SELECT\r\n          Billing.Account.OriginalAccountNumber ,\r\n          Billing.Account.UtilityServiceAddress ,\r\n          Billing.AgencyDivision.AgencyName ,\r\n          dbo.ConvertYYYYMMDDToDatetime(Billing.Account.AccountEffectiveTurnOff) AS ActionEffectiveDate ,\r\n          NULL AS SbmrReferenceNumber ,\r\n          NULL AS DateUtilityConfirmed ,\r\n          Billing.AccountMeterStatus.Description AS AccountStatus ,\r\n          SUM(Billing.AccountBilling.RevisedBilledAmount) AS RevisedBilledAmount ,\r\n          Billing.Facility.OecFacilityNumber ,\r\n          COUNT(1) AS NumberofBillingPriodAfterActionEffectiveDate ,\r\n          Billing.UtilityCompany.Description AS UtilityCompany\r\n    FROM Billing.Account\r\n          INNER JOIN Billing.AccountBilling ON Billing.Account.OriginalAccountNumber = Billing.AccountBilling.OriginalAccountNumber\r\n          AND Billing.Account.AccountEffectiveTurnOff < Billing.AccountBilling.ToDate\r\n          INNER JOIN Billing.UtilityCompany ON Billing.Account.UtilityAccountProvider = Billing.UtilityCompany.UtilityCompanySeqid\r\n          INNER JOIN Billing.Facility ON Billing.Account.FacilityAccount = Billing.Facility.FacilitySeqid\r\n          INNER JOIN Billing.AgencyDivision ON Billing.Account.AgencyAccount = Billing.AgencyDivision.AgencyDivisionSeqid\r\n          INNER JOIN Billing.AccountMeterStatus ON Billing.Account.AccountStatus = Billing.AccountMeterStatus.AccountMeterStatus\r\n    WHERE ( Billing.AccountBilling.RevisedBilledAmount > 0.00 )\r\n          AND ( Billing.Account.AccountEffectiveTurnOff > 20091231 )\r\n          AND ( Billing.Account.AccountStatus = '28'\r\n          OR Billing.Account.AccountStatus = '27'\r\n          )\r\n    GROUP BY Billing.Account.OriginalAccountNumber ,\r\n          Billing.Account.AccountEffectiveTurnOff ,\r\n          Billing.Facility.OecFacilityNumber ,\r\n          Billing.Account.UtilityServiceAddress ,\r\n          Billing.UtilityCompany.Description ,\r\n          Billing.AgencyDivision.AgencyName ,\r\n          Billing.Account.AccountStatus ,\r\n          Billing.AccountMeterStatus.Description\r\n)\r\n*/\r\nEND"
        }
      ]
    }
  ]
}