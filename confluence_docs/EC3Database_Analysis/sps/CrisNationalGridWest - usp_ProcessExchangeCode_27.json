{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchangeCode_27",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ProcessExchangeCode_27",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process an exchange code operation for a utility billing system. Specifically, it handles the exchange code '27', which is related to turning off a meter. The procedure performs several validation checks, updates the status of a meter, and logs the operation as processed. It also includes error handling to manage any issues that arise during execution."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple validation checks, conditional logic, and transactional updates, which contribute to its medium complexity. It also includes error handling with detailed logging, which adds to the complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The sequence ID of the exchange record to be processed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeCode AS VARCHAR(2)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The exchange code to be processed, expected to be '27'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current billing period, used for updating meter status."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityCompanySeqid AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the utility company, used in validation checks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode AS INT OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter that shows the status of the procedure execution (0 for success, 1 for failure)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Checks if the exchange record exists in "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadExchangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Verifies if the record has already been processed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieves account and meter details from "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadExchangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validation Checks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Confirms that the exchange code is '27'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ensures the account exists with an active status in "
                },
                {
                  "type": "text",
                  "text": "Billing.Account",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Verifies the meter exists and is not already turned off in "
                },
                {
                  "type": "text",
                  "text": "Billing.Meter",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction and Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Begins a transaction named "
                },
                {
                  "type": "text",
                  "text": "exchange27",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates the meter status to '27' (turned off) in "
                },
                {
                  "type": "text",
                  "text": "Billing.Meter",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates the exchange record with the turn-off date in "
                },
                {
                  "type": "text",
                  "text": "Billing.AccountExchangeMeterTrack",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Marks the exchange record as processed in "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadExchangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commits the transaction if all operations succeed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Catches any errors during the transaction."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logs detailed error information using "
                },
                {
                  "type": "text",
                  "text": "RAISERROR",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Rolls back the transaction if an error occurs."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the columns used in "
                },
                {
                  "type": "text",
                  "text": "WHERE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " clauses, such as "
                },
                {
                  "type": "text",
                  "text": "UploadExchangeDetailSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "OriginalMeterNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", are indexed to improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is limited to necessary updates, which helps minimize locking and potential contention."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "SET NOCOUNT ON",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This setting reduces network traffic by preventing the sending of DONE_IN_PROC messages for each statement."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple processes attempt to update the same records simultaneously, it could lead to deadlocks or data inconsistencies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While errors are logged, the procedure does not provide a mechanism for retrying failed operations, which could be necessary in some business contexts."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadExchangeDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is accurate and complete. Any discrepancies could lead to incorrect processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded values (e.g., "
                },
                {
                  "type": "text",
                  "text": "UtilityAccountProvider = 2",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "), which could limit flexibility and require updates if business rules change."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [CrisNationalGridWest].[usp_ProcessExchangeCode_27]\n(\r\n\t@AuthenticatedUserID AS INT,\r\n\t@ExchangeSeqid AS INT,\r\n\t@ExchangeCode AS VARCHAR(2),\r\n\t@CurrentBillingPeriod AS VARCHAR(6),\r\n\t@UtilityCompanySeqid AS INT,\r\n\t@StatusCode AS INT  OUTPUT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\t\r\n\tDECLARE @AccountNumber AS NVARCHAR(15), @MeterNumber AS NVARCHAR(12), @MeterTerminationDate AS VARCHAR(8), @TurnOffBillingPeriod AS VARCHAR(6)\r\n\t\t,@RecordExchangeCode AS VARCHAR(2), @crlf AS VARCHAR(2) = CHAR(13) + CHAR(10);\r\n\t\t\r\n\t-- CHECK IF THE record exists\r\n\tIF (NOT EXISTS (SELECT UploadExchangeDetailSeqid FROM CrisNationalGridWest.UploadExchangeDetail WHERE UploadExchangeDetailSeqid = @ExchangeSeqid))\r\n\tBEGIN\r\n\t\tRAISERROR ('The UploadExchangeDetailSeqid %i does not exist. Please verify. ', 12, 1, @ExchangeSeqid);\r\n\t\tSET @StatusCode = 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\t-- check if the record was processed\r\n\tIF (EXISTS(SELECT IsProcessed FROM CrisNationalGridWest.UploadExchangeDetail WHERE UploadExchangeDetailSeqid = @ExchangeSeqid AND IsProcessed = 'Y'))\r\n\tBEGIN\r\n\t\tRAISERROR ('This exchange was already processed. exchangeseqid %i ', 12, 1, @ExchangeSeqid);\r\n\t\tSET @StatusCode = 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\tSELECT @AccountNumber = AccountNumber + '0000', @MeterNumber = MeterNumber,\t@MeterTerminationDate = MeterEffectiveActionDate,\r\n\t\t@TurnOffBillingPeriod = BillingPeriod, @RecordExchangeCode = ExchangeCode\r\n\tFROM CrisNationalGridWest.UploadExchangeDetail;\r\n\r\n\t-- some validation\r\n\t-- check the obvious\r\n\tIF (@ExchangeCode <> '27' OR @ExchangeCode <> @RecordExchangeCode)\r\n\tBEGIN\r\n\t\tRAISERROR ('The exchange code is not 27. Please verfiy: account number %s and meter number %s ', 12, 1, @AccountNumber, @MeterNumber);\r\n\t\tSET @StatusCode = 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\t-- verify the account exists under an active status\r\n\tIF (NOT EXISTS(SELECT * FROM Billing.Account WHERE OriginalAccountNumber = @AccountNumber AND CurrentAccountNumber = @AccountNumber\r\n\t\tAND AccountStatus IN ('AC' , '47', '46', 'UA') AND UtilityAccountProvider = 2))\r\n\tBEGIN\r\n\t\tRAISERROR ('The account number %s does not exist in the system under an active status. Please verfiy: account number %s ', 12, 1, @AccountNumber);\r\n\t\tSET @StatusCode = 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\t-- verify the meter exists under an active status\r\n\tIF (NOT EXISTS(SELECT * FROM Billing.Meter WHERE OriginalMeterNumber = @MeterNumber AND CurrentMeterNumber = @MeterNumber AND MeterStatus <> '27'))\r\n\tBEGIN\r\n\t\tRAISERROR ('The meter number %s does not exist in the system under an active status. Please verfiy: Account number %s ', 12, 1, @MeterNumber, @AccountNumber);\r\n\t\tSET @StatusCode = 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\t-- verify the meter status\r\n\tIF (EXISTS(SELECT MeterStatus FROM Billing.Meter WHERE OriginalMeterNumber = @MeterNumber AND CurrentMeterNumber = @MeterNumber AND MeterStatus = '27'))\r\n\tBEGIN\r\n\t\tRAISERROR ('The meter number %s is already turned off. Please verfiy ', 12, 1, @MeterNumber);\r\n\t\tSET @StatusCode = 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\tBEGIN TRY\t\r\n\t\tBEGIN TRANSACTION exchange27;\r\n\t\tSET @StatusCode = 0;\r\n\t\t\t\t\r\n\t\t--\tUpdate Meter turn Off 27\r\n\t\tUPDATE M\r\n\t\tSET MeterPreviousStatus = M.MeterStatus\r\n\t\t\t,MeterStatus = '27'\r\n\t\t\t,MeterStatusCodePeriod = @CurrentBillingPeriod\r\n\t\t\t,MeterEffectiveOffDate = @MeterTerminationDate\r\n\t\t\t,TurnOffDate = @TurnOffBillingPeriod\r\n\t\t\t,FireAuditTrigger = 'Y'\r\n\t\t\t,AuthenticatedUserID = @AuthenticatedUserID\r\n\t\t\t,LastUpdate = GETDATE()\r\n\t\tFROM Billing.AccountExchangeMeterTrack AS AE INNER JOIN Billing.Meter AS M ON AE.OriginalMeterSeqid = M.MeterSeqid\r\n\t\tWHERE AE.OriginalAccountNumber = @AccountNumber AND AE.OriginalMeterNumber = @MeterNumber AND AE.UtilityCompanySeqid = 2;\r\n \r\n\t\t-- update the meter exchange with the turn off date on the meter\r\n\t\tUPDATE AE\r\n\t\tSET MeterEffectiveBillingEndDate = M.MeterEffectiveOffDate\r\n\t\t\t,FireAuditTrigger = 'Y'\r\n\t\t\t,AuthenticatedUserID = @AuthenticatedUserID\r\n\t\t\t,LastUpdate = GETDATE()\r\n\t\tFROM Billing.AccountExchangeMeterTrack AS AE INNER JOIN Billing.Meter AS M ON AE.OriginalMeterSeqid = M.MeterSeqid\r\n\t\tWHERE AE.OriginalAccountNumber = @AccountNumber AND AE.OriginalMeterNumber = @MeterNumber AND AE.UtilityCompanySeqid = 2;\r\n\t\t\t\t\r\n\t\t-- we made it this far \r\n\t\tUPDATE CrisNationalGridWest.UploadExchangeDetail\r\n\t\tSET IsProcessed = 'Y'\r\n\t\tWHERE UploadExchangeDetailSeqid = @ExchangeSeqid;\r\n\r\n\t\tCOMMIT TRANSACTION exchange27;\r\n\tEND TRY\r\n\tBEGIN CATCH\t\t\r\n\t\tDECLARE @ExchangeErrorMessage AS NVARCHAR(4000), @ErrorMessage AS NVARCHAR(4000), @ErrorSeverity AS INT, @ErrorState AS INT\r\n\t\t\t,@ErrorNumber AS INT, @ErrorLine AS INT, @ErrorProcedure AS NVARCHAR(126);\r\n\t\t\t\t\r\n\t\tSELECT @ExchangeErrorMessage ='Error in StoredProcedure %s at line number %d' + @crlf + 'Billing Period: %s' + @crlf + 'Exchange Sequence Id:%d '+ @crlf + 'Account:Meter (%s : %s)  ' + @crlf,\r\n\t\t\t@ErrorMessage = ERROR_MESSAGE(), @ErrorSeverity = ERROR_SEVERITY(), @ErrorState = ERROR_STATE(), @ErrorNumber = ERROR_NUMBER(),\r\n\t\t\t@ErrorProcedure = ERROR_PROCEDURE(), @ErrorLine = ERROR_LINE();\r\n\t\t\t\t\r\n\t\tSET\t@ErrorMessage = @ExchangeErrorMessage + @ErrorMessage + @crlf + '@ErrorNumber: ' + CAST(@ErrorNumber AS VARCHAR(10)) + @crlf;\r\n\r\n\t\tRAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState, @ErrorProcedure, @ErrorLine, @CurrentBillingPeriod, @ExchangeSeqid,\r\n\t\t\t@AccountNumber, @MeterNumber) WITH LOG;\r\n\t\t\t\t\r\n\t\tSET @StatusCode  = 1;\r\n\r\n\t\tROLLBACK TRANSACTION exchange27;\r\n\tEND CATCH;\r\nEND;"
        }
      ]
    }
  ]
}