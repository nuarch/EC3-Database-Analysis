{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Published",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Utility_CountRowsPublishedDataByPublishedBillingPeriod",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Utility_CountRowsPublishedDataByPublishedBillingPeriod",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to count the number of rows in various published tables within a database for a specified billing period. It returns a list of table names along with the count of rows that match the given "
        },
        {
          "type": "text",
          "text": "PublishedBillingPeriod",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ". The procedure uses a series of "
        },
        {
          "type": "text",
          "text": "SELECT",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " statements combined with "
        },
        {
          "type": "text",
          "text": "UNION ALL",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " to aggregate results from multiple tables, each filtered by the "
        },
        {
          "type": "text",
          "text": "PublishedBillingPeriod",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " parameter."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium. While the logic is straightforward, involving multiple "
        },
        {
          "type": "text",
          "text": "SELECT",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " statements with "
        },
        {
          "type": "text",
          "text": "UNION ALL",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ", the number of tables involved and the repetitive nature of the queries add to its complexity. Additionally, the use of "
        },
        {
          "type": "text",
          "text": "TOP 1",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " and "
        },
        {
          "type": "text",
          "text": "MIN",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " functions in each query, although not necessary for the intended functionality, introduces unnecessary complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter specifies the billing period for which the row counts are to be retrieved. It is expected to be a string of six characters, representing a year and month (e.g., '202301' for January 2023)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by executing a series of "
                },
                {
                  "type": "text",
                  "text": "SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statements, each targeting a different table within the "
                },
                {
                  "type": "text",
                  "text": "Published",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " schema."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Each "
                },
                {
                  "type": "text",
                  "text": "SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statement retrieves the table name (using "
                },
                {
                  "type": "text",
                  "text": "MIN",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to ensure a single value is returned), the "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and the count of rows where the "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " matches the input parameter."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The results from each "
                },
                {
                  "type": "text",
                  "text": "SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " are combined using "
                },
                {
                  "type": "text",
                  "text": "UNION ALL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which allows for the aggregation of results from multiple tables into a single result set."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The final result set is ordered by "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " in descending order, although this ordering is redundant since all rows will have the same "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The use of "
                },
                {
                  "type": "text",
                  "text": "TOP 1",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "MIN",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " in each "
                },
                {
                  "type": "text",
                  "text": "SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statement is unnecessary and be removed to simplify the queries. These functions do not affect the row count but add overhead."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure performs a full scan of each table for the specified "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which be inefficient if the tables are large and not indexed on "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The "
                },
                {
                  "type": "text",
                  "text": "UNION ALL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " operation is efficient in this context since it does not attempt to eliminate duplicates, which is appropriate given the distinct nature of each table's data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If any of the tables are missing or have been renamed, the procedure will fail. There is no error handling to manage such scenarios."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure assumes that the "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " column exists in all referenced tables. If this assumption is incorrect, it will result in runtime errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The lack of indexing on the "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " column could lead to performance degradation, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure does not handle cases where the "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is invalid or does not match any rows in the tables, potentially returning an empty result set without any indication of an issue."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Description:\tGets count of all the published tables for the supplied PublishedBIllingPeriod\r\n--*               \r\n--* AUTHOR:       Peter Heller\r\n--* Created On:   Around 2011\r\n--**************************************************************************************\r\n--* Date       Tech Description of Change\r\n--* ---------- ---\t-------------------------------------------------------------\r\n--* XX/XX/2011 PAH  First Version  \r\n--* 01/16/2016 MOH  Update: removed UtilityCompanyDeliveryRateTariffGroupingTemp it is not being used anywhere in the application\r\n--* 04/12/2016\tZD\tRemoved the part with \"Fiscal Year Pivot By Utility Company Dollars And Usage\" table\r\n--**************************************************************************************\r\n\r\n\r\nCREATE   PROCEDURE [Published].[usp_Utility_CountRowsPublishedDataByPublishedBillingPeriod]    (\t@PublishedBillingPeriod varchar(6))\r\nAS\r\nBegin\r\n\r\n\t\tSELECT  top 1   min('Published.AccountLevelRawDataForCurrentPeriod') as TableName,    PublishedBillingPeriod,  COUNT(*) AS PublishedRowCount FROM Published.AccountLevelRawDataForCurrentPeriod   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.AccountLevelSummaryByAgency') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.AccountLevelSummaryByAgency   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.AccountLevelSummaryByCityWide') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.AccountLevelSummaryByCityWide   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.AccountLevelSummaryByFacility') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.AccountLevelSummaryByFacility   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.AccountLevelSummaryForDollarsBtusAndCo2') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.AccountLevelSummaryForDollarsBtusAndCo2   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.AccountMeterLevelRawDataForCurrentPeriod') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.AccountMeterLevelRawDataForCurrentPeriod   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.EnergyUsageSummaryGroupByAgencyAndEnergyType') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.EnergyUsageSummaryGroupByAgencyAndEnergyType   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.FiscalYearPivotByAgencyAndFacilityDollarsAndUsage') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.FiscalYearPivotByAgencyAndFacilityDollarsAndUsage   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.FiscalYearPivotByAgencyDollarsAndUsage') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.FiscalYearPivotByAgencyDollarsAndUsage   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.FiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.FiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage  where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.FiscalYearPivotByEncoreMonthlyPayments') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.FiscalYearPivotByEncoreMonthlyPayments  where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.FiscalYearPivotByUtilityInvoiceAccountBillingGroupDollarsAndUsage') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.FiscalYearPivotByUtilityInvoiceAccountBillingGroupDollarsAndUsage   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\tunion all\r\n\t\tSELECT  top 1   min('Published.MonthlyPublishedSummaryData') as TableName,     PublishedBillingPeriod,    COUNT(*) AS PublishedRowCount FROM Published.MonthlyPublishedSummaryData   where PublishedBillingPeriod = @PublishedBillingPeriod  GROUP BY PublishedBillingPeriod \r\n\t\torder by PublishedBillingPeriod desc\r\n\r\nEnd"
        }
      ]
    }
  ]
}