{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_PartialLookupAccountBillingRevisedOnly_Upgrade",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_PartialLookupAccountBillingRevisedOnly_Upgrade",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve billing information for accounts, specifically focusing on revised billing data. It allows filtering, sorting, and pagination of the results. The procedure logs the usage of the report and handles different user roles, such as agency users, to determine the appropriate billing period for data retrieval."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report, used for logging and access control."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentAccountNumber AS VARCHAR(15)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The account number for which billing information is being retrieved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SearchText AS VARCHAR(150) = ''",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional search text to filter results based on various fields."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PageSize AS INT = 10",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The number of records to return per page for pagination."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentPageNumber AS INT = 1",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current page number for pagination."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SortColumn AS VARCHAR(100) = 'BillingPeriod'",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The column by which to sort the results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SortOrder AS VARCHAR(100) = 'ASC'",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The order of sorting, either ascending or descending."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsAgencyUser BIT = 0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A flag indicating if the user is an agency user, affecting the billing period selection."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@TotalCount AS INT OUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter that returns the total count of records matching the criteria."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting "
                },
                {
                  "type": "text",
                  "text": "NOCOUNT ON",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to prevent extra result sets and sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to avoid locking issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If the user is an agency user ("
                        },
                        {
                          "type": "text",
                          "text": "@IsAgencyUser = 1",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "), it retrieves the current processing period from "
                        },
                        {
                          "type": "text",
                          "text": "Billing.ApplicationTimeFrame",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Otherwise, it selects the maximum published billing period from "
                        },
                        {
                          "type": "text",
                          "text": "Published.MonthlyPublishedSummaryData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieve Unique Account Sequence ID",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It fetches the "
                },
                {
                  "type": "text",
                  "text": "UniqueAccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for the given "
                },
                {
                  "type": "text",
                  "text": "@CurrentAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " from "
                },
                {
                  "type": "text",
                  "text": "Billing.Account",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Log Report Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Calls an audit procedure to log the usage of the report with details like the report name, user email, and billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "A temporary table "
                        },
                        {
                          "type": "text",
                          "text": "@tempAccountBillingRevised",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is created to store the results."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Data is inserted into this table from "
                        },
                        {
                          "type": "text",
                          "text": "Published.TemporalAccountLevelRawDataForCurrentPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", filtered by the effective period and account sequence ID."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The search text is applied to multiple fields to filter the results."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Count and Paginate Results",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The total count of records is calculated and stored in "
                        },
                        {
                          "type": "text",
                          "text": "@TotalCount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The results are sorted based on the specified "
                        },
                        {
                          "type": "text",
                          "text": "@SortColumn",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "@SortOrder",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Pagination is applied using "
                        },
                        {
                          "type": "text",
                          "text": "OFFSET",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "FETCH NEXT",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " clauses."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but may lead to reading uncommitted data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dynamic Sorting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of dynamic sorting with multiple "
                },
                {
                  "type": "text",
                  "text": "CASE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statements can be inefficient, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Pagination",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Efficiently implemented using "
                },
                {
                  "type": "text",
                  "text": "OFFSET",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "FETCH NEXT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", but performance can degrade with high page numbers due to the need to skip rows."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Search Text Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Applying "
                },
                {
                  "type": "text",
                  "text": "LIKE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " filters on multiple fields can be resource-intensive, especially without proper indexing."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level may lead to dirty reads, which could be problematic if data consistency is critical."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "SQL Injection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of dynamic SQL for sorting and filtering without proper sanitization could expose the procedure to SQL injection risks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Lack of appropriate indexing on the columns used in "
                },
                {
                  "type": "text",
                  "text": "WHERE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "ORDER BY",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " clauses could lead to performance bottlenecks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure's performance may degrade with large datasets due to the complexity of sorting and filtering logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": High concurrency scenarios might lead to contention issues, especially if the underlying tables are frequently updated."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_PartialLookupAccountBillingRevisedOnly_Upgrade]\n(\r\n\t @EmailAddress AS VARCHAR(75)\r\n\t,@CurrentAccountNumber AS VARCHAR(15)\r\n\t,@SearchText AS VARCHAR(150) = ''\r\n\t,@PageSize AS INT = 10\r\n\t,@CurrentPageNumber AS INT = 1\r\n\t,@SortColumn AS VARCHAR(100) = 'BillingPeriod'\r\n\t,@SortOrder AS VARCHAR(100) = 'ASC'\r\n\t,@IsAgencyUser BIT = 0\r\n\t,@TotalCount AS INT OUT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @PublishedBillingPeriod AS VARCHAR(6), @UniqueAccountSeqid AS INT, @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\r\n\tIF (@IsAgencyUser = 1)\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = PublishedBillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\tEND;\r\n\tELSE\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = MAX(PublishedBillingPeriod) FROM Published.MonthlyPublishedSummaryData;\r\n\tEND;\r\n\r\n\tSELECT @UniqueAccountSeqid = UniqueAccountSeqid\r\n\tFROM Billing.Account\r\n\tWHERE CurrentAccountNumber = @CurrentAccountNumber AND IsCurrentRecord = 'Y';\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName = @spname,\r\n\t\t@StoredProcName = @spname,\r\n\t\t@RequestedBy = @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod = @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod = NULL,\r\n\t\t@prmAgency_ies = NULL,\r\n\t\t@prmFacilityNumber_s = NULL,\r\n\t\t@prmStartingBillingPeriod = NULL,\r\n\t\t@prmEndingBillingPeriod = NULL;\r\n\r\n\tDECLARE @tempAccountBillingRevised TABLE(PublishedBillingPeriod VARCHAR(6) NULL\r\n\t\t,CurrentAccountNumber dbo.acctnum NULL\r\n\t\t,OriginalAccountNumber dbo.acctnum NULL\r\n\t\t,AccountStatus VARCHAR(2) NULL\r\n\t\t,BillingPeriod VARCHAR(6) NULL\r\n\t\t,LastPeriodModified VARCHAR(6) NULL\r\n\t\t,FiscalYear VARCHAR(4) NULL\r\n\t\t,FromDate VARCHAR(15) NULL\r\n\t\t,ToDate VARCHAR(15) NULL\r\n\t\t,AccountBillingStatus VARCHAR(2) NULL\r\n\t\t,ActualOrEstimated VARCHAR(3) NULL\r\n\t\t,TotalAmountDue MONEY NULL\r\n\t\t,RevisedBilledAmount MONEY NULL\r\n\t\t,AccountEnergyUsage INT NULL\r\n\t\t,AccountDemandUsage NUMERIC(12,2) NULL\r\n\t\t,BillingPeriodDays INT NULL);\r\n\r\n\tINSERT INTO @tempAccountBillingRevised\r\n\tSELECT @PublishedBillingPeriod AS PublishedBillingPeriod,\r\n\t\tTAD.CurrentAccountNumber,\r\n\t\tTAD.OriginalAccountNumber,\r\n        TAD.AccountStatus,\r\n        TAD.BillingPeriod,\r\n        TAD.LastPeriodModified,\r\n        TAD.FiscalYear,\r\n        SUBSTRING(TAD.FromDate, 5, 2) + '/' + SUBSTRING(TAD.FromDate, 7, 2) + '/' + SUBSTRING(TAD.FromDate, 1, 4) AS FromDate,\r\n\t\tSUBSTRING(TAD.ToDate, 5, 2) + '/' + SUBSTRING(TAD.ToDate, 7, 2) + '/' + SUBSTRING(TAD.ToDate, 1, 4) AS ToDate,\r\n        TAD.AccountBillingStatus,\r\n        TAD.ActualOrEstimated,\r\n        TAD.TotalAmountDue,\r\n        TAD.RevisedBilledAmount,\r\n        TAD.AccountEnergyUsage,\r\n        TAD.AccountDemandUsage,\r\n        TAD.BillingPeriodDays\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS TAD\r\n        INNER JOIN dbo.uftn_TableGetAgencyByEmailAddressAgencyAccessAction(@EmailAddress) AS AD ON TAD.AgencyCodeOEC = AD.AgencyCodeOEC\r\n\tWHERE TAD.EffectiveStartPeriod <= @PublishedBillingPeriod AND TAD.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND TAD.UniqueAccountSeqid = @UniqueAccountSeqid\r\n\t\tAND (@SearchText IS NULL OR TAD.BillingPeriod LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.LastPeriodModified LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.CurrentAccountNumber LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.FromDate LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.ToDate LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.BillingPeriodDays LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.ActualOrEstimated LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.TotalAmountDue LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.RevisedBilledAmount LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.AccountEnergyUsage LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.AccountDemandUsage LIKE '%' + @SearchText + '%'\r\n\t\t\tOR TAD.AccountBillingStatus LIKE '%' + @SearchText + '%');\r\n\r\n\tSELECT @TotalCount = COUNT(*) FROM @tempAccountBillingRevised;\r\n\r\n\tSELECT PublishedBillingPeriod,\r\n           CurrentAccountNumber,\r\n           OriginalAccountNumber,\r\n           AccountStatus,\r\n           BillingPeriod,\r\n           LastPeriodModified,\r\n           FiscalYear,\r\n           FromDate,\r\n           ToDate,\r\n           AccountBillingStatus,\r\n           ActualOrEstimated,\r\n           TotalAmountDue,\r\n           RevisedBilledAmount,\r\n           AccountEnergyUsage,\r\n           AccountDemandUsage,\r\n           BillingPeriodDays\r\n\tFROM @tempAccountBillingRevised\r\n\tORDER BY CASE WHEN(@SortColumn = '' OR @SortColumn IS NULL) THEN ISNULL(BillingPeriod, '') END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'BillingPeriod' AND @SortOrder = 'ASC') THEN BillingPeriod END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'BillingPeriod' AND @SortOrder = 'DESC') THEN BillingPeriod END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'LastPeriodModified' AND @SortOrder = 'ASC') THEN LastPeriodModified END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'LastPeriodModified' AND @SortOrder = 'DESC') THEN LastPeriodModified END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'CurrentAccountNumber' AND @SortOrder = 'ASC') THEN CurrentAccountNumber END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'CurrentAccountNumber' AND @SortOrder = 'DESC') THEN CurrentAccountNumber END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'FromDate' AND @SortOrder = 'ASC') THEN FromDate END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'FromDate' AND @SortOrder = 'DESC') THEN FromDate END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'ToDate' AND @SortOrder = 'ASC') THEN ToDate END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'ToDate' AND @SortOrder = 'DESC') THEN ToDate END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'BillingPeriodDays' AND @SortOrder = 'ASC') THEN BillingPeriodDays END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'BillingPeriodDays' AND @SortOrder = 'DESC') THEN BillingPeriodDays END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'ActualOrEstimated' AND @SortOrder = 'ASC') THEN ActualOrEstimated END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'ActualOrEstimated' AND @SortOrder = 'DESC') THEN ActualOrEstimated END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'TotalAmountDue' AND @SortOrder = 'ASC') THEN TotalAmountDue END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'TotalAmountDue' AND @SortOrder = 'DESC') THEN TotalAmountDue END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'RevisedBilledAmount' AND @SortOrder = 'ASC') THEN RevisedBilledAmount END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'RevisedBilledAmount' AND @SortOrder = 'DESC') THEN RevisedBilledAmount END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'AccountEnergyUsage' AND @SortOrder = 'ASC') THEN AccountEnergyUsage END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'AccountEnergyUsage' AND @SortOrder = 'DESC') THEN AccountEnergyUsage END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'AccountDemandUsage' AND @SortOrder = 'ASC') THEN AccountDemandUsage END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'AccountDemandUsage' AND @SortOrder = 'DESC') THEN AccountDemandUsage END DESC\r\n\t\t,CASE WHEN(@SortColumn = 'AccountBillingStatus' AND @SortOrder = 'ASC') THEN AccountBillingStatus END ASC\r\n\t\t,CASE WHEN(@SortColumn = 'AccountBillingStatus' AND @SortOrder = 'DESC') THEN AccountBillingStatus END DESC\r\n\tOFFSET CASE WHEN @PageSize = -1 THEN 0 ELSE @PageSize * (@CurrentPageNumber -1) END ROWS FETCH NEXT\r\n\t\tCASE WHEN @PageSize = -1 THEN IIF(@TotalCount > 0, @TotalCount, 1) ELSE @PageSize END ROWS ONLY;\r\nEND;"
        }
      ]
    }
  ]
}