{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_MonthlyAgencyDataByEnergyType",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_MonthlyAgencyDataByEnergyType",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report of monthly energy data for agencies, categorized by energy type. It retrieves and formats energy usage and cost data for a specified billing period and agency, and logs the report usage. The procedure supports different types of energy metrics, such as usage in kWh, therms, or costs in dollars, and can be tailored for agency users."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple conditional logic branches, dynamic data aggregation, and formatting operations. It also includes a nested subquery structure and joins, which add to its complexity. However, it does not involve highly complex algorithms or recursive logic, placing it at a medium complexity level."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report, used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the report is generated, formatted as a string (e.g., '202301')."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The agency code(s) for which the report is generated, allowing multiple codes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Type AS VARCHAR(50)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the type of energy data to report, such as 'Total Cost ($)', 'Electricity Usage (kWh)', etc."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsAgencyUser AS BIT = 0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A flag indicating whether the user is an agency user, which affects how the billing period is determined."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to avoid locking issues and initializes local variables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Adjustment",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the user is an agency user, the procedure retrieves the current processing period from the "
                },
                {
                  "type": "text",
                  "text": "Billing.ApplicationTimeFrame",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Calls another stored procedure, "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", to log the report request details."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Month Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Extracts the month from the "
                },
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and adjusts it for fiscal year calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval and Formatting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "A subquery aggregates energy data from the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The data is filtered based on the effective period and energy type."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Energy data is converted to BTU if specified, using conversion factors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The outer query formats the aggregated data for each month and the year-to-date total, applying currency or numeric formatting based on the "
                },
                {
                  "type": "text",
                  "text": "@Type",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The final result set is ordered by fiscal year and agency code."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but leads to reading uncommitted data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "String Manipulation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "SUBSTRING",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "CAST",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for month extraction be optimized if the billing period format changes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conditional Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Extensive use of "
                },
                {
                  "type": "text",
                  "text": "CASE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statements for data conversion and formatting impact performance, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The join with "
                },
                {
                  "type": "text",
                  "text": "uftn_TableGetAgencyChildrenByAgencyCodeOEC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and grouping operations be performance bottlenecks if the underlying tables are large or not indexed appropriately."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level risks reading dirty data, which could lead to inaccurate reports."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Lengths",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for "
                },
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " may lead to inefficient memory usage if not needed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conversion Factors",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Hardcoded conversion factors for BTU calculations may need updates if energy conversion standards change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure's performance may degrade with increasing data volume, especially if the underlying tables grow significantly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete operations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_MonthlyAgencyDataByEnergyType]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@PublishedBillingPeriod AS VARCHAR(6)\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX)\r\n\t,@Type AS VARCHAR(50)\r\n\t,@IsAgencyUser AS BIT = 0\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID), @BillingPeriodMonth AS INT;\r\n\r\n\tIF (@IsAgencyUser = 1)\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = PublishedBillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\tEND;\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName\t= @spname,\r\n\t\t@StoredProcName\t= @spname,\r\n\t\t@RequestedBy = @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod = @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod = NULL,\r\n\t\t@prmAgency_ies = @AgencyCodeOEC,\r\n\t\t@prmFacilityNumber_s = NULL,\r\n\t\t@prmStartingBillingPeriod = NULL,\r\n\t\t@prmEndingBillingPeriod = NULL;\r\n\r\n\tSET @BillingPeriodMonth = CAST(SUBSTRING(@PublishedBillingPeriod, 4, 6) AS INT);\r\n\tSET @BillingPeriodMonth = CASE WHEN @BillingPeriodMonth <= 6 THEN @BillingPeriodMonth + 12 ELSE @BillingPeriodMonth END;\r\n\t\r\n\tSELECT O.EnergyType,\r\n        O.PublishedBillingPeriod,\r\n        O.AgencyCodeOEC,\r\n        O.AgencyName,\r\n        O.FiscalYear,\r\n        CASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.YearToDate, 'C')\r\n\t\t\tELSE FORMAT(O.YearToDate, 'N2') END AS YearToDate,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.July, 'C')\r\n\t\t\tELSE FORMAT(O.July, 'N2') END July,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.August, 'C')\r\n\t\t\tELSE FORMAT(O.August, 'N2') END AS August,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.September, 'C')\r\n\t\t\tELSE FORMAT(O.September, 'N2') END AS September,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.October, 'C')\r\n\t\t\tELSE FORMAT(O.October, 'N2') END AS October,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.November, 'C')\r\n\t\t\tELSE FORMAT(O.November, 'N2') END AS November,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.December, 'C')\r\n\t\t\tELSE FORMAT(O.December, 'N2') END AS December,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.January, 'C')\r\n\t\t\tELSE FORMAT(O.January, 'N2') END AS January,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.February, 'C')\r\n\t\t\tELSE FORMAT(O.February, 'N2') END AS February,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.March, 'C')\r\n\t\t\tELSE FORMAT(O.March, 'N2') END AS March,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.April, 'C')\r\n\t\t\tELSE FORMAT(O.April, 'N2') END AS April,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.May, 'C')\r\n\t\t\tELSE FORMAT(O.May, 'N2') END AS May,\r\n\t\tCASE WHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN FORMAT(O.June, 'C')\r\n\t\t\tELSE FORMAT(O.June, 'N2') END AS June\r\n\tFROM (SELECT @Type AS EnergyType\r\n\t\t\t,R.PublishedBillingPeriod\r\n\t\t\t,R.AgencyCodeOEC\r\n\t\t\t,R.AgencyName\r\n\t\t\t,R.FiscalYear\r\n\t\t\t,CASE WHEN @BillingPeriodMonth >= 7 THEN ISNULL(R.July, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 8 THEN ISNULL(R.August, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 9 THEN ISNULL(R.September, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 10 THEN ISNULL(R.October, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 11 THEN ISNULL(R.November, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 12 THEN ISNULL(R.December, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 13 THEN ISNULL(R.January, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 14 THEN ISNULL(R.February, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 15 THEN ISNULL(R.March, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 16 THEN ISNULL(R.April, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 17 THEN ISNULL(R.May, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 18 THEN ISNULL(R.June, 0) ELSE 0 END AS YearToDate\r\n\t\t\t,R.July\r\n\t\t\t,R.August\r\n\t\t\t,R.September\r\n\t\t\t,R.October\r\n\t\t\t,R.November\r\n\t\t\t,R.December\r\n\t\t\t,R.January\r\n\t\t\t,R.February\r\n\t\t\t,R.March\r\n\t\t\t,R.April\r\n\t\t\t,R.May\r\n\t\t\t,R.June\r\n\t\tFROM (SELECT @PublishedBillingPeriod AS PublishedBillingPeriod, \r\n\t\t\t\tFYPivot.AgencyCodeOEC, \r\n\t\t\t\tFYPivot.AgencyName, \r\n\t\t\t\tFYPivot.FiscalYear, \r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.JulyRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.JulyRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.JulyRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.JulyRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.JulyRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.JulyRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.JulyRevisedBilledDollars) END AS July,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.AugustRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.AugustRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.AugustRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.AugustRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.AugustRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.AugustRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.AugustRevisedBilledDollars) END AS August,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.SeptemberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.SeptemberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.SeptemberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.SeptemberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.SeptemberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.SeptemberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.SeptemberRevisedBilledDollars) END AS September,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.OctoberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.OctoberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.OctoberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.OctoberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.OctoberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.OctoberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.OctoberRevisedBilledDollars) END AS October,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.NovemberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.NovemberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.NovemberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.NovemberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.NovemberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.NovemberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.NovemberRevisedBilledDollars) END AS November,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.DecemberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.DecemberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.DecemberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.DecemberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.DecemberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.DecemberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.DecemberRevisedBilledDollars) END AS December,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.JanuaryRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.JanuaryRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.JanuaryRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.JanuaryRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.JanuaryRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.JanuaryRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.JanuaryRevisedBilledDollars) END AS January,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.FebruaryRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.FebruaryRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.FebruaryRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.FebruaryRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.FebruaryRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.FebruaryRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.FebruaryRevisedBilledDollars) END AS February,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.MarchRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.MarchRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.MarchRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.MarchRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.MarchRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.MarchRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.MarchRevisedBilledDollars) END AS March,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.AprilRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.AprilRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.AprilRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.AprilRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.AprilRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.AprilRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.AprilRevisedBilledDollars) END AS April, \r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.MayRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.MayRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.MayRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.MayRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.MayRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.MayRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.MayRevisedBilledDollars) END AS May,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.JuneRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.JuneRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.JuneRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.JuneRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.JuneRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.JuneRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.JuneRevisedBilledDollars) END AS June\r\n\t\t\tFROM Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage AS FYPivot\r\n\t\t\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS A ON FYPivot.AgencyCodeOEC = A.AgencyCodeOEC\r\n\t\t\tWHERE FYPivot.EffectiveStartPeriod <= @PublishedBillingPeriod AND FYPivot.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\t\t\tAND ((@Type IN ('Electricity Usage (kWh)', 'Electricity Cost ($)', 'Electricity Demand (kW)') AND FYPivot.EnergyType = 'ELE')\r\n\t\t\t\t\tOR (@Type IN ('Gas (Therms)', 'Gas Cost ($)') AND FYPivot.EnergyType = 'GAS')\r\n\t\t\t\t\tOR (@Type IN ('Steam (MLbs)', 'Steam Cost ($)') AND FYPivot.EnergyType = 'STM')\r\n\t\t\t\t\tOR (@Type IN ('BTU', 'Total Cost ($)')))\r\n\t\t\tGROUP BY FYPivot.AgencyCodeOEC, FYPivot.AgencyName, FYPivot.FiscalYear) AS R) AS O\r\n\tORDER BY O.FiscalYear DESC, O.AgencyCodeOEC;\r\nEND;"
        }
      ]
    }
  ]
}