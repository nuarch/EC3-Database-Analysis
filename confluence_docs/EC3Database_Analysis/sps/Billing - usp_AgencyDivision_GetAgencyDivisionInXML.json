{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Billing",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_AgencyDivision_GetAgencyDivisionInXML",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_AgencyDivision_GetAgencyDivisionInXML",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve and return an XML representation of the "
        },
        {
          "type": "text",
          "text": "AgencyDivision",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table from the "
        },
        {
          "type": "text",
          "text": "Billing",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " schema. It organizes the data hierarchically based on the levels of the agency division, which are determined by the "
        },
        {
          "type": "text",
          "text": "AgencyDivisionHierarchy",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " column. The procedure constructs an XML document that reflects the hierarchical structure of the agency divisions, with each level nested within the previous one."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium due to the nested subqueries and the use of XML PATH to construct a hierarchical XML structure. The procedure involves multiple levels of recursion to represent the hierarchy, which requires careful handling of the relationships between different levels of agency divisions."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "This stored procedure does not take any input parameters. It operates on the entire "
        },
        {
          "type": "text",
          "text": "AgencyDivision",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table and filters data based on specific conditions within the procedure itself."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by selecting data from the "
                },
                {
                  "type": "text",
                  "text": "AgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table where the hierarchy level is 1 and the division is active ("
                },
                {
                  "type": "text",
                  "text": "InActive = 'N'",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ")."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "For each level 1 agency division, it performs a nested subquery to retrieve level 2 agency divisions that are children of the current level 1 division, again filtering for active divisions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Similarly, for each level 2 division, another nested subquery retrieves level 3 divisions that are children of the current level 2 division, maintaining the active filter."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The XML PATH clause is used to format the results into an XML structure, with each level of the hierarchy represented as nested XML elements."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The final XML document is wrapped with a root element "
                },
                {
                  "type": "text",
                  "text": "<Agencies>",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The use of nested subqueries can lead to performance issues, especially if the "
                },
                {
                  "type": "text",
                  "text": "AgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is large. Each level of the hierarchy requires a separate query execution, which can be resource-intensive."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure relies on the "
                },
                {
                  "type": "text",
                  "text": "AgencyDivisionHierarchy.GetLevel()",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " function, which should be optimized for performance. If this function is complex or inefficient, it degrade the overall performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing on columns like "
                },
                {
                  "type": "text",
                  "text": "AgencyDivisionSeqID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "ParentAgencyDivisionSeqID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "InActive",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " improve query performance by reducing the time needed to filter and join data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure assumes that the hierarchy levels are strictly defined and that each division has a valid parent-child relationship. Any data integrity issues in the "
                },
                {
                  "type": "text",
                  "text": "AgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table could lead to incorrect XML output."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If the "
                },
                {
                  "type": "text",
                  "text": "AgencyDivisionHierarchy.GetLevel()",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " function is not reliable or returns unexpected results, the hierarchical structure in the XML could be incorrect."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure does not handle exceptions or errors, such as issues with data retrieval or XML generation, which could lead to incomplete or malformed XML output."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The absence of input parameters means that the procedure always processes the entire table, which may not be efficient if only a subset of data is needed for specific use cases."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\tdho\r\n-- Create date: <Create Date,,>\r\n-- Description:\tGet xml representation of agency division table. \r\n-- =============================================\r\ncreate PROCEDURE [Billing].[usp_AgencyDivision_GetAgencyDivisionInXML]\r\nAS\r\nBEGIN\r\n\r\n    SELECT \r\n\t\tagencyL1.AgencyDivisionSeqID AS '@AgencyDivisionSeqID', \r\n\t\tagencyL1.AgencyCodeOEC AS '@AgencyCodeOEC', \r\n\t\tagencyL1.AgencyCodeOEC + '-' + agencyL1.AgencyName AS '@AgencyName',\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\tagencyL2.AgencyDivisionSeqID AS '@AgencyDivisionSeqID', \r\n\t\t\tagencyL2.AgencyCodeOEC AS '@AgencyCodeOEC', \r\n\t\t\tagencyL2.AgencyCodeOEC + '-' + agencyL2.AgencyName AS '@AgencyName',\r\n\t\t\t(\r\n\t\t\t\tSELECT \r\n\t\t\t\tagencyL3.AgencyDivisionSeqID AS '@AgencyDivisionSeqID', \r\n\t\t\t\tagencyL3.AgencyCodeOEC AS '@AgencyCodeOEC', \r\n\t\t\t\tagencyL3.AgencyCodeOEC + '-' + agencyL3.AgencyName AS '@AgencyName'\r\n\t\t\t\tfrom Billing.AgencyDivision AS agencyL3\r\n\t\t\t\tWHERE agencyL3.AgencyDivisionHierarchy.GetLevel() = 3\r\n\t\t\t\tAND agencyL3.ParentAgencyDivisionSeqID = agencyL2.AgencyDivisionSeqID\r\n\t\t\t\tAND agencyL3.InActive = 'N'\r\n\t\t\t\tORDER BY agencyL3.AgencyCodeOEC\t\t\r\n\t\t\t\tFOR XML PATH('Agency'), type\r\n\t\t\t)\t\t\t\r\n\t\t\tfrom Billing.AgencyDivision AS agencyL2\r\n\t\t\tWHERE agencyL2.AgencyDivisionHierarchy.GetLevel() = 2\r\n\t\t\tAND agencyL2.ParentAgencyDivisionSeqID = agencyL1.AgencyDivisionSeqID\r\n\t\t\tAND agencyL2.InActive = 'N'\r\n\t\t\tORDER BY agencyL2.AgencyCodeOEC\t\t\t\r\n\t\t\tFOR XML PATH('Agency'), TYPE\r\n\t\t)\r\n\tfrom Billing.AgencyDivision AS agencyL1\r\n\tWHERE agencyL1.AgencyDivisionHierarchy.GetLevel() = 1\r\n\t\tAND agencyL1.InActive = 'N'\r\n\tORDER BY agencyL1.AgencyCodeOEC\r\n\tFOR XML PATH('Agency'), ROOT('Agencies')\r\n\r\nEND"
        }
      ]
    }
  ]
}