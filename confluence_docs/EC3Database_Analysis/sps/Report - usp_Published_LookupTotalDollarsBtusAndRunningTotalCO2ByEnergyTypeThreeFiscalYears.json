{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_LookupTotalDollarsBtusAndRunningTotalCO2ByEnergyTypeThreeFiscalYears",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_LookupTotalDollarsBtusAndRunningTotalCO2ByEnergyTypeThreeFiscalYears",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report that aggregates energy usage data, including total billed amounts, CO2 emissions, and BTU consumption, by energy type over three fiscal years. It logs the report usage, calculates fiscal years, and retrieves data from a function that aggregates energy data by agency hierarchy. The results are stored in a temporary table and then returned in a structured format."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including logging, fiscal year calculations, data retrieval from a user-defined function, and complex data aggregation. The use of multiple "
        },
        {
          "type": "text",
          "text": "INSERT INTO",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " operations with conditional logic and joins adds to the complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. Used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the report is generated, formatted as "
                },
                {
                  "type": "text",
                  "text": "yyyymm",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCode AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A code representing the agency for which the report is generated. Used in data retrieval."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@FacilityNumber AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A code representing the facility for which the report is generated. Used in data retrieval."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by logging the report request using the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " stored procedure, capturing details such as the report name, requested by, and parameters."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Fiscal Year Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates the previous and prior fiscal years based on the provided billing period using the "
                },
                {
                  "type": "text",
                  "text": "CreateFiscalYear",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " function."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Streetlight Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Retrieves and aggregates data for streetlight energy usage, filtering by fiscal year and energy type 'ELE'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Electricity Excluding Streetlight",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Calculates electricity usage excluding streetlight by subtracting streetlight data from total electricity data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Non-Electricity Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Aggregates data for non-electricity energy types."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Citywide Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Aggregates citywide energy data across all types."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Result Compilation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The results are compiled into a temporary table "
                },
                {
                  "type": "text",
                  "text": "@QueryResult",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and then selected and ordered for output."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but leads to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple aggregations and joins, which can be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a user-defined function for data retrieval can impact performance depending on its complexity and execution plan."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level may result in reading uncommitted data, which could lead to inconsistencies in the report."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure's performance may degrade with larger datasets due to multiple aggregations and joins."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete transactions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no validation of input parameters, which could lead to unexpected behavior if invalid data is provided."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_LookupTotalDollarsBtusAndRunningTotalCO2ByEnergyTypeThreeFiscalYears]\n(\r\n\t@EmailAddress AS VARCHAR(75),\r\n\t@PublishedBillingPeriod AS VARCHAR(6),\r\n\t@AgencyCode AS VARCHAR(MAX),\r\n\t@FacilityNumber AS VARCHAR(MAX)\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName\t\t\t\t\t= @spname,\r\n\t\t@StoredProcName\t\t\t\t= @spname,\r\n\t\t@RequestedBy\t\t\t\t= @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod\t= @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod\t\t\t= NULL,\r\n\t\t@prmAgency_ies\t\t\t\t= @AgencyCode,\r\n\t\t@prmFacilityNumber_s\t\t= @FacilityNumber,\r\n\t\t@prmStartingBillingPeriod\t= NULL,\r\n\t\t@prmEndingBillingPeriod\t\t= NULL;\r\n\r\n\tDECLARE @PreviousYr AS VARCHAR(4), @PriorFY AS VARCHAR(4);\r\n\r\n\tSELECT @PreviousYr = dbo.CreateFiscalYear(@PublishedBillingPeriod,'P')\r\n\tSELECT @PriorFY = dbo.CreateFiscalYear(@PreviousYr,'P')\r\n\t\r\n\tDECLARE @QueryResult TABLE\r\n\t\t([CitywideAgencyOrFacility] VARCHAR(2) NOT NULL,\r\n\t\t[PublishedBillingPeriod] [dbo].[yyyymm] NOT NULL,\r\n\t\t[FiscalYear] [dbo].[yyyy] NOT NULL,\r\n\t\t[BillingPeriod] [dbo].[yyyymm] NOT NULL,\r\n\t\t[EnergyType] varchar(3),\r\n\t\t[TotalBilledAmount] money NULL,\r\n\t\t[TotalCO2] NUMERIC(38, 6) NULL,\r\n\t\t[TotalBTU] NUMERIC(38, 6) NULL,\r\n\t\t[PublishedBillingPeriodRunningTotalCO2] NUMERIC(38, 6) NULL,\r\n\t\t[YtdRunningTotalCO2] NUMERIC(38, 6) NULL,\r\n\t\t[month] VARCHAR(20) NOT NULL,\r\n\t\tCurrentFiscalYear [dbo].[yyyymm] NOT NULL,\r\n\t\tPriorFiscalYear[dbo].[yyyymm] NOT NULL,\r\n\t\tEnergyUsage dbo.EnergyUnitBigInt NULL,\r\n\t\tDemandUsage numeric(38,2) NULL,\r\n\t\tPublishedPeriodCurrentFiscalYear  [dbo].[yyyymm] NOT NULL,\r\n\t\tPublishedPeriodPriorFiscalYear [dbo].[yyyymm] NOT NULL)\r\n\r\n\t/*\r\n\t\tStreetlight\r\n\t*/\r\n\tINSERT INTO @QueryResult\r\n\t\t(CitywideAgencyOrFacility,\r\n        PublishedBillingPeriod,\r\n        FiscalYear,\r\n        BillingPeriod,\r\n        EnergyType,\r\n        TotalBilledAmount,\r\n        TotalCO2,\r\n        TotalBTU,\r\n        PublishedBillingPeriodRunningTotalCO2,\r\n        YtdRunningTotalCO2,\r\n        month,\r\n        CurrentFiscalYear,\r\n        PriorFiscalYear,\r\n        EnergyUsage,\r\n        DemandUsage,\r\n        PublishedPeriodCurrentFiscalYear,\r\n        PublishedPeriodPriorFiscalYear)\r\n\tSELECT CitywideAgencyOrFacility,\r\n        PublishedBillingPeriod,\r\n        FiscalYear,\r\n        BillingPeriod,\r\n        MIN('STL') AS EnergyType,\r\n        SUM(TotalBilledAmount) AS TotalBilledAmount,\r\n        SUM(TotalCO2) AS TotalCO2,\r\n        SUM(TotalBTU) AS TotalBTU,\r\n        SUM(PublishedBillingPeriodRunningTotalCO2) AS PublishedBillingPeriodRunningTotalCO2,\r\n        SUM(YtdRunningTotalCO2) AS YtdRunningTotalCO2,\r\n        MIN([month]) AS month,\r\n        MIN(CurrentFiscalYear) AS CurrentFiscalYear,\r\n        MIN(PriorFiscalYear) AS PriorFiscalYear,\r\n        SUM(EnergyUsage) AS EnergyUsage,\r\n        SUM(DemandUsage) AS DemandUsage,\r\n        MIN(PublishedPeriodCurrentFiscalYear) AS PublishedPeriodCurrentFiscalYear,\r\n        MIN(PublishedPeriodPriorFiscalYear) AS PublishedPeriodPriorFiscalYear\r\n\tFROM Factors.uftn_TableTotalDollarsBtusAndRunningTotalCO2ByAgencyHierarchy\r\n\t\t(@EmailAddress, 'FE', @PublishedBillingPeriod, '841003', '0600303,0600304', '*') AS A\r\n\tWHERE FiscalYear >= @PriorFY\r\n        AND EnergyType = 'ELE'\r\n\tGROUP BY CitywideAgencyOrFacility,\r\n        PublishedBillingPeriod,\r\n        FiscalYear,\r\n        BillingPeriod;\r\n\r\n\t/*\r\n\t\tele exclude streetlight\r\n\t*/\r\n\tINSERT INTO @QueryResult\r\n\t\t(CitywideAgencyOrFacility,\r\n\t\tPublishedBillingPeriod,\r\n\t\tFiscalYear,\r\n\t\tBillingPeriod,\r\n\t\tEnergyType,\r\n\t\tTotalBilledAmount,\r\n\t\tTotalCO2,\r\n\t\tTotalBTU,\r\n\t\tPublishedBillingPeriodRunningTotalCO2,\r\n\t\tYtdRunningTotalCO2,\r\n\t\t[month],\r\n\t\tCurrentFiscalYear,\r\n\t\tPriorFiscalYear,\r\n\t\tEnergyUsage,\r\n\t\tDemandUsage,\r\n\t\tPublishedPeriodCurrentFiscalYear,\r\n\t\tPublishedPeriodPriorFiscalYear)\r\n\tSELECT TotalElec.CitywideAgencyOrFacility,\r\n\t\tTotalElec.PublishedBillingPeriod,\r\n\t\tTotalElec.FiscalYear,\r\n\t\tTotalElec.BillingPeriod,\r\n\t\tTotalElec.EnergyType,\r\n\t\tTotalElec.TotalBilledAmount - STLResultTable.TotalBilledAmount,\r\n\t\tTotalElec.TotalCO2 - STLResultTable.TotalCO2,\r\n\t\tTotalElec.TotalBTU - STLResultTable.TotalBTU,\r\n\t\tTotalElec.PublishedBillingPeriodRunningTotalCO2 - STLResultTable.PublishedBillingPeriodRunningTotalCO2,\r\n\t\tTotalElec.YtdRunningTotalCO2 - STLResultTable.YtdRunningTotalCO2,\r\n\t\tTotalElec.[month],\r\n\t\tTotalElec.CurrentFiscalYear,\r\n\t\tTotalElec.PriorFiscalYear,\r\n\t\tTotalElec.EnergyUsage - STLResultTable.EnergyUsage,\r\n\t\tTotalElec.DemandUsage - STLResultTable.DemandUsage,\r\n\t\tTotalElec.PublishedPeriodCurrentFiscalYear,\r\n\t\tTotalElec.PublishedPeriodPriorFiscalYear\r\n\tFROM (SELECT CitywideAgencyOrFacility,\r\n\t\t\tPublishedBillingPeriod,\r\n\t\t\tFiscalYear,\r\n\t\t\tBillingPeriod,\r\n\t\t\tEnergyType,\r\n\t\t\tSUM(TotalBilledAmount) AS TotalBilledAmount,\r\n\t\t\tSUM(TotalCO2) AS TotalCO2,\r\n\t\t\tSUM(TotalBTU) AS TotalBTU,\r\n\t\t\tSUM(PublishedBillingPeriodRunningTotalCO2) AS PublishedBillingPeriodRunningTotalCO2,\r\n\t\t\tSUM(YtdRunningTotalCO2) AS YtdRunningTotalCO2,\r\n\t\t\tMIN(month) AS month,\r\n\t\t\tMIN(CurrentFiscalYear) AS CurrentFiscalYear,\r\n\t\t\tMIN(PriorFiscalYear) AS PriorFiscalYear,\r\n\t\t\tSUM(EnergyUsage) AS EnergyUsage,\r\n\t\t\tSUM(DemandUsage) AS DemandUsage,\r\n\t\t\tMIN(PublishedPeriodCurrentFiscalYear) AS PublishedPeriodCurrentFiscalYear,\r\n\t\t\tMIN(PublishedPeriodPriorFiscalYear) AS PublishedPeriodPriorFiscalYear\r\n\t\tFROM Factors.uftn_TableTotalDollarsBtusAndRunningTotalCO2ByAgencyHierarchy\r\n\t\t\t(@EmailAddress, 'CE', @PublishedBillingPeriod, NULL, NULL, '') AS A\r\n\t\tWHERE FiscalYear >= @PriorFY AND EnergyType = 'ELE'\r\n\t\tGROUP BY CitywideAgencyOrFacility,\r\n\t\t\tPublishedBillingPeriod,\r\n\t\t\tFiscalYear,\r\n\t\t\tBillingPeriod,\r\n\t\t\tEnergyType) AS TotalElec\r\n\tINNER JOIN @QueryResult AS STLResultTable ON TotalElec.BillingPeriod = STLResultTable.BillingPeriod;\r\n\r\n\t/*\r\n\t\tnon-ele\r\n\t*/\r\n\tINSERT INTO @QueryResult\r\n\t\t(CitywideAgencyOrFacility,\r\n\t\tPublishedBillingPeriod,\r\n\t\tFiscalYear,\r\n\t\tBillingPeriod,\r\n\t\tEnergyType,\r\n\t\tTotalBilledAmount,\r\n\t\tTotalCO2,\r\n\t\tTotalBTU,\r\n\t\tPublishedBillingPeriodRunningTotalCO2,\r\n\t\tYtdRunningTotalCO2,\r\n\t\t[month],\r\n\t\tCurrentFiscalYear,\r\n\t\tPriorFiscalYear,\r\n\t\tEnergyUsage,\r\n\t\tDemandUsage,\r\n\t\tPublishedPeriodCurrentFiscalYear,\r\n\t\tPublishedPeriodPriorFiscalYear)\r\n\tSELECT  CitywideAgencyOrFacility,\r\n\t\tPublishedBillingPeriod,\r\n\t\tFiscalYear,\r\n\t\tBillingPeriod,\r\n\t\tEnergyType,\r\n\t\tSUM(TotalBilledAmount) AS TotalBilledAmount,\r\n\t\tSUM(TotalCO2) AS TotalCO2,\r\n\t\tSUM(TotalBTU) AS TotalBTU,\r\n\t\tSUM(PublishedBillingPeriodRunningTotalCO2) AS PublishedBillingPeriodRunningTotalCO2,\r\n\t\tSUM(YtdRunningTotalCO2) AS YtdRunningTotalCO2,\r\n\t\tMIN([month]) AS month,\r\n\t\tMIN(CurrentFiscalYear) AS CurrentFiscalYear,\r\n\t\tMIN(PriorFiscalYear) AS PriorFiscalYear,\r\n\t\tSUM(EnergyUsage) AS EnergyUsage,\r\n\t\tSUM(DemandUsage) AS DemandUsage,\r\n\t\tMIN(PublishedPeriodCurrentFiscalYear) AS PublishedPeriodCurrentFiscalYear,\r\n\t\tMIN(PublishedPeriodPriorFiscalYear) AS PublishedPeriodPriorFiscalYear\r\n\tFROM Factors.uftn_TableTotalDollarsBtusAndRunningTotalCO2ByAgencyHierarchy\r\n\t\t(@EmailAddress, 'CE', @PublishedBillingPeriod, NULL, NULL, '') AS A\r\n\tWHERE FiscalYear >= @PriorFY AND EnergyType <> 'ELE'\r\n\tGROUP BY CitywideAgencyOrFacility,\r\n\t\tPublishedBillingPeriod,\r\n\t\tFiscalYear,\r\n\t\tBillingPeriod,\r\n\t\tEnergyType;\r\n\r\n\t/*\r\n\tBTU - CitywideAgencyOrFacility: CW\r\n\t*/\t\r\n\tINSERT INTO @QueryResult\r\n\t\t(CitywideAgencyOrFacility,\r\n\t\tPublishedBillingPeriod,\r\n\t\tFiscalYear,\r\n\t\tBillingPeriod,\r\n\t\tEnergyType,\r\n\t\tTotalBilledAmount,\r\n\t\tTotalCO2,\r\n\t\tTotalBTU,\r\n\t\tPublishedBillingPeriodRunningTotalCO2,\r\n\t\tYtdRunningTotalCO2,\r\n\t\t[month],\r\n\t\tCurrentFiscalYear,\r\n\t\tPriorFiscalYear,\r\n\t\tEnergyUsage,\r\n\t\tDemandUsage,\r\n\t\tPublishedPeriodCurrentFiscalYear,\r\n\t\tPublishedPeriodPriorFiscalYear)\r\n\tSELECT CitywideAgencyOrFacility,\r\n\t\tPublishedBillingPeriod,\r\n\t\tFiscalYear,\r\n\t\tBillingPeriod,\r\n\t\tEnergyType,\r\n\t\tSUM(TotalBilledAmount) AS TotalBilledAmount,\r\n\t\tSUM(TotalCO2) AS TotalCO2,\r\n\t\tSUM(TotalBTU) AS TotalBTU,\r\n\t\tSUM(PublishedBillingPeriodRunningTotalCO2) AS PublishedBillingPeriodRunningTotalCO2,\r\n\t\tSUM(YtdRunningTotalCO2) AS YtdRunningTotalCO2,\r\n\t\tMIN(month) AS month,\r\n\t\tMIN(CurrentFiscalYear) AS CurrentFiscalYear,\r\n\t\tMIN(PriorFiscalYear) AS PriorFiscalYear,\r\n\t\tSUM(EnergyUsage) AS EnergyUsage,\r\n\t\tSUM(DemandUsage) AS DemandUsage,\r\n\t\tMIN(PublishedPeriodCurrentFiscalYear) AS PublishedPeriodCurrentFiscalYear,\r\n\t\tMIN(PublishedPeriodPriorFiscalYear) AS PublishedPeriodPriorFiscalYear\r\n\tFROM Factors.uftn_TableTotalDollarsBtusAndRunningTotalCO2ByAgencyHierarchy\r\n\t\t\t\t\t(@EmailAddress,\r\n\t\t\t\t\t  'CW', @PublishedBillingPeriod,\r\n\t\t\t\t\t  '*',\r\n\t\t\t\t\t  '*',\r\n\t\t\t\t\t  '*') AS A\r\n\tWHERE FiscalYear >= @PriorFY\r\n\tGROUP BY CitywideAgencyOrFacility,\r\n\t\t\tPublishedBillingPeriod,\r\n\t\t\tFiscalYear,\r\n\t\t\tBillingPeriod,\r\n\t\t\tEnergyType;\r\n\t\r\n\tSELECT CitywideAgencyOrFacility,\r\n        PublishedBillingPeriod,\r\n        FiscalYear,\r\n        BillingPeriod,\r\n        EnergyType,\r\n        TotalBilledAmount,\r\n        TotalCO2,\r\n        TotalBTU,\r\n        PublishedBillingPeriodRunningTotalCO2,\r\n        YtdRunningTotalCO2,\r\n        [month],\r\n        CurrentFiscalYear,\r\n        PriorFiscalYear,\r\n        EnergyUsage,\r\n        DemandUsage,\r\n        PublishedPeriodCurrentFiscalYear,\r\n        PublishedPeriodPriorFiscalYear\r\n\tFROM @QueryResult\r\n\tORDER BY publishedBillingPeriod, FiscalYear DESC, BillingPeriod;\r\nEND;"
        }
      ]
    }
  ]
}