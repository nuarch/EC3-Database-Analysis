{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ConEd",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Upload_8_Process36Or40Refunds",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Upload_8_Process36Or40Refunds",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to handle refunds for accounts with specific tariff codes ('036' and '040') in the ConEd database. It processes account cancellations for these rates, identifies eligible refunds, updates relevant tables to reflect these refunds, and removes processed cancellation records. The procedure involves multiple steps, including data truncation, selection, insertion, updating, and deletion across several tables."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple SQL operations (TRUNCATE, SELECT, INSERT, UPDATE, DELETE)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It processes data across several tables with conditional logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses nested conditional statements and joins, which require careful handling to ensure data integrity and correct business logic execution."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "This stored procedure does not take any input parameters. It operates on the current state of the database tables involved."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncate Table",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by truncating the "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonRate036Refunds",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table to ensure it starts with a clean slate for the current operation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Identify Refunds",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It counts the number of eligible refunds from "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " where the "
                },
                {
                  "type": "text",
                  "text": "BillingPeriodRevision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " matches the "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", the "
                },
                {
                  "type": "text",
                  "text": "TariffCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is '036' or '040', and "
                },
                {
                  "type": "text",
                  "text": "DeltaNumberOfPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is either 12 or 13."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If eligible refunds are found, it inserts relevant data into "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonRate036Refunds",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Update Cancellation Records",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It updates "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellationPreload",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to set "
                },
                {
                  "type": "text",
                  "text": "Therms",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "CCF",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to zero, marking them for refund processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It also updates "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellationTempSummarySpanned",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " similarly."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Process One Period Refunds",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It checks for refunds in "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellationSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and updates "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonAccountBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with refund details."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "After processing, it deletes the corresponding records from "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellationSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Process Spanned Refunds",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Similar to one-period refunds, it processes refunds in "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellationTempSummarySpanned",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and updates "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonAccountBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It then deletes the processed records from "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonCancellationTempSummarySpanned",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Truncation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating a table is a fast operation but should be used cautiously as it removes all data without logging individual row deletions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conditional Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of conditional logic and multiple updates can be resource-intensive, especially if the tables involved are large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses several joins, which can impact performance if the joined tables are large or not properly indexed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Consider processing data in batches if the volume is large to avoid locking and performance degradation."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple updates and deletions, which could lead to data integrity issues if not handled correctly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include transaction handling, which could lead to issues in a concurrent environment where multiple processes might attempt to modify the same data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no explicit error handling, which means any failure during execution could leave the database in an inconsistent state."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the data grows, the performance of this procedure might degrade, especially due to the lack of indexing considerations and batch processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure relies on specific hardcoded values (e.g., tariff codes, delta periods), which might require updates if business rules change."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [ConEd].[usp_Upload_8_Process36Or40Refunds]\r\nAS \r\n    BEGIN\r\n\t--\r\n-- ********************************************************************\r\n--\tHandle Rate 036 or 040 refunds\r\n-- ********************************************************************\r\n        TRUNCATE TABLE ConEd.UploadConEdisonRate036Refunds\r\n--\r\n--\tFind all rate 036 account cancellations that are canceled for the current period.  Save their basic information that will be\r\n--\tused by the stored procedure (ConEd.usp_IdentifyRefundsForGasRate036).  It will net the following attributes:\r\n--\t\t\t\t\r\n--\t\t\t\tDeltaNumberOfPeriods will generally be 13.  The current month billing plus 12 refund months.\r\n--\t\t\t\tRefundCCF will probably be zero\r\n--\t\t\t\tRefundTherms will be negative and have a relationship as to the amount of money being refunded.\r\n--\t\t\t\tRefundBilledAmount is negative dollars representing the total amount \r\n--\r\n        DECLARE @NumberOfConEdisonRate036Refunds INT\r\n--\r\n        SELECT  @NumberOfConEdisonRate036Refunds = COUNT(*) \r\n        SELECT  COUNT(*)\r\n        FROM ConEd.UploadConEdisonCancellation\r\n        WHERE   ( BillingPeriodRevision = BillingPeriod )\r\n                AND ( TariffCode IN ( '036', '040' ) )\r\n                AND ( DeltaNumberOfPeriods = 12\r\n                      OR DeltaNumberOfPeriods = 13\r\n                    )\r\n--\r\n        IF ( @NumberOfConEdisonRate036Refunds > 0 ) \r\n            BEGIN\r\n                INSERT  INTO ConEd.UploadConEdisonRate036Refunds\r\n                        ( AccountNumber ,\r\n                          TariffCode ,\r\n                          DeltaNumberOfPeriods ,\r\n                          BillingPeriodRevision ,\r\n                          BillingPeriod ,\r\n                          FromDate ,\r\n                          ToDate ,\r\n                          RefundCCF ,\r\n                          RefundTherms ,\r\n                          RefundBilledAmount\r\n                        )\r\n                        SELECT  AccountNumber ,\r\n                                TariffCode ,\r\n                                DeltaNumberOfPeriods ,\r\n                                BillingPeriodRevision ,\r\n                                BillingPeriod ,\r\n                                FromDate ,\r\n                                ToDate ,\r\n                                CCF ,\r\n                                Therms ,\r\n                                BilledAmount\r\n                        FROM ConEd.UploadConEdisonCancellation\r\n                        WHERE   ( BillingPeriodRevision = BillingPeriod )\r\n                                AND ( TariffCode IN ( '036', '040' ) )\r\n                                AND ( DeltaNumberOfPeriods = 12\r\n                                      OR DeltaNumberOfPeriods = 13\r\n                                    )\r\n\r\n                SELECT  'ConEd.UploadConEdisonRate036Refunds' AS description ,\r\n                        *\r\n                FROM ConEd.UploadConEdisonRate036Refunds\r\n--\r\n--\t\tThe identified account(s) are stored in th ConEd.UploadConEdisonRate036Refunds table.  \r\n--\t\tThe ConEd.UploadConEdisonCancellationPreload and ConEd.UploadConEdisonCancellation have their Therms and CCF set to zero in EBCDIC and ascii \r\n--\t\tformat respectively.  This way forces the stored procedure (ConEd.usp_IdentifyRefundsForGasRate036) to process them as refunds.\r\n--\r\n--\t\tThis was a critical correction factor \"(DeltaNumberOfPeriods = 12)\". This isolates the annualized refund for gas rates 036 & 040.  (9/11/2009 pah)\r\n--\r\n\r\n                UPDATE  ConEd.UploadConEdisonCancellationPreload\r\n                SET     Therms = '0000000{' ,\r\n                        CCF = '0000000{'\r\n                WHERE   ( BillingPeriodRevision = BillingPeriodRevision )\r\n                        AND ( TariffCode IN ( '036', '040' ) )\r\n                        AND ( (DeltaNumberOfPeriods = 12\r\n                              OR DeltaNumberOfPeriods = 13)\r\n                            )\r\n\t\t\t\t\r\n                UPDATE  ConEd.UploadConEdisonCancellation\r\n                SET     Therms = 0 ,\r\n                        CCF = 0\r\n                WHERE   ( BillingPeriodRevision = BillingPeriod )\r\n                        AND ( TariffCode IN ( '036', '040' ) )\r\n                        AND ( (DeltaNumberOfPeriods = 12\r\n                              OR DeltaNumberOfPeriods = 13)\r\n                            )\r\n\t\t\t\t\r\n                UPDATE  ConEd.UploadConEdisonCancellationTempSummarySpanned\r\n                SET     CancelCCF = 0 ,\r\n                        CancelTherms = 0\r\n                WHERE   ( BillingPeriodRevision = BillingPeriod )\r\n                        AND ( CancelTariffCode IN ( '036', '040' ) )\r\n                        AND ( (DeltaNumberOfPeriods = 12\r\n                              OR DeltaNumberOfPeriods = 13)\r\n                            )\r\n\r\n            END\r\n  \r\n\r\n        DECLARE @GasRate036RefundCount INT\r\n--\r\n        SELECT  @GasRate036RefundCount = ISNULL(COUNT(*), 0)\r\n        FROM ConEd.UploadConEdisonCancellationSummary\r\n                INNER JOIN ConEd.UploadConEdisonAccountSummary ON ConEd.UploadConEdisonCancellationSummary.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod\r\n                                                              AND ConEd.UploadConEdisonCancellationSummary.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision\r\n                                                              AND ConEd.UploadConEdisonCancellationSummary.OriginalAccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\n        WHERE   ( ConEd.UploadConEdisonCancellationSummary.CancelTotalCCF = 0 )\r\n                AND ( ConEd.UploadConEdisonCancellationSummary.CancelTotalTherms = 0 )\r\n                AND ( ConEd.UploadConEdisonCancellationSummary.TotalCanceledAmount <> 0 )\r\n                AND ( ConEd.UploadConEdisonCancellationSummary.GasRateCode IN (\r\n                      '036', '040' ) )\r\n\r\n--\tOne Period Refund\r\n--\r\n        IF ( @GasRate036RefundCount <> 0 ) \r\n            BEGIN\r\n\t--\r\n\t--\tNote:\tThe workflow has the UploadConEdisonAccountSummary (Rebilled data) loaded into the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tprior to working on the cancellation data.  The correction is being applied to the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tinstead of the ConEd.UploadConEdisonAccountSummary.\r\n\t--\t\r\n                UPDATE  ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n                SET     Notes = CAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount AS VARCHAR(18))\r\n                        + ' net Charge for rate '\r\n                        + ConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode\r\n                        + ' for the Current period ('\r\n                        + ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod\r\n                        + ') net rebilled amount: '\r\n                        + CAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount AS VARCHAR(18))\r\n                        + ' refunded amount: '\r\n                        + CAST(ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount AS VARCHAR(18))\r\n                        + ' refunded Therms(CCF): '\r\n                        + CAST(ConEd.UploadConEdisonRate036Refunds.RefundTherms AS VARCHAR(18))\r\n                        + '('\r\n                        + CAST(ConEd.UploadConEdisonRate036Refunds.RefundCCF AS VARCHAR(18))\r\n                        + ')' ,\r\n                        TotalRebilledAmount = ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount ,\r\n                        TotalCanceledAmount = 0 ,\r\n                        TotalCCF = TotalCCF\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundCCF ,\r\n                        TotalTherms = TotalTherms\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundTherms ,\r\n                        CancelTotalTherms = 0 ,\r\n                        CancelTotalCCF = 0\r\n                FROM ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n                        INNER JOIN ConEd.UploadConEdisonRate036Refunds ON ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod = ConEd.UploadConEdisonRate036Refunds.BillingPeriod\r\n                                                              AND ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriodRevision = ConEd.UploadConEdisonRate036Refunds.BillingPeriodRevision\r\n                                                              AND ConEd.UploadConEdisonAccountBillingAdjustmentGas.OriginalAccountNumber = ConEd.UploadConEdisonRate036Refunds.AccountNumber\r\n                                                              AND ConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode = ConEd.UploadConEdisonRate036Refunds.TariffCode\r\n    --\r\n\t--    Once the refund is applied correctly to the ConEd.UploadConEdisonAccountBillingAdjustmentGas.  The cancellation record will be removed.\r\n\t--\r\n                DELETE  FROM ConEd.UploadConEdisonCancellationSummary\r\n                FROM ConEd.UploadConEdisonCancellationSummary\r\n                        INNER JOIN ConEd.UploadConEdisonAccountSummary ON ConEd.UploadConEdisonCancellationSummary.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod\r\n                                                              AND ConEd.UploadConEdisonCancellationSummary.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision\r\n                                                              AND ConEd.UploadConEdisonCancellationSummary.OriginalAccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\n                WHERE   ( ConEd.UploadConEdisonCancellationSummary.CancelTotalCCF = 0 )\r\n                        AND ( ConEd.UploadConEdisonCancellationSummary.CancelTotalTherms = 0 )\r\n                        AND ( ConEd.UploadConEdisonCancellationSummary.TotalCanceledAmount <> 0 )\r\n                        AND ( ConEd.UploadConEdisonCancellationSummary.GasRateCode IN (\r\n                              '036', '040' ) )\r\n                        AND ( ConEd.UploadConEdisonCancellationSummary.NumberOfBillingPeriods = 12 )\r\n\t--\r\n                SET @GasRate036RefundCount = 0\r\n\r\n            END\r\n--\r\n        SELECT  @GasRate036RefundCount = ISNULL(COUNT(*), 0)\r\n        FROM ConEd.UploadConEdisonCancellationTempSummarySpanned\r\n                INNER JOIN ConEd.UploadConEdisonAccountSummary ON ConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod\r\n                                                              AND ConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision\r\n                                                              AND ConEd.UploadConEdisonCancellationTempSummarySpanned.AccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\n        WHERE   ( ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelCCF = 0 )\r\n                AND ( ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelTherms = 0 )\r\n                AND ( ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelBilledAmount <> 0 )\r\n                AND ( ConEd.UploadConEdisonAccountSummary.GasRateCode IN (\r\n                      '036', '040' ) )\r\n--\r\n--\tSpanned Refund\r\n--\r\n        IF ( @GasRate036RefundCount <> 0 ) \r\n            BEGIN\r\n\t--\r\n\t--\tNote:\tThe workflow has the UploadConEdisonAccountSummary (Rebilled data) loaded into the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tprior to working on the cancellation data.  The correction is being applied to the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tinstead of the ConEd.UploadConEdisonAccountSummary.\r\n\t--\t\t\t\r\n                UPDATE  ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n                SET     Notes = CAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount AS VARCHAR(18))\r\n                        + ' net Charge for rate '\r\n                        + ConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode\r\n                        + ' for the Current period ('\r\n                        + ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod\r\n                        + ') net rebilled amount: '\r\n                        + CAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount AS VARCHAR(18))\r\n                        + ' refunded amount: '\r\n                        + CAST(ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount AS VARCHAR(18))\r\n                        + ' refunded Therms(CCF): '\r\n                        + CAST(ConEd.UploadConEdisonRate036Refunds.RefundTherms AS VARCHAR(18))\r\n                        + '('\r\n                        + CAST(ConEd.UploadConEdisonRate036Refunds.RefundCCF AS VARCHAR(18))\r\n                        + ')' ,\r\n                        TotalRebilledAmount = ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount ,\r\n                        TotalCanceledAmount = 0 ,\r\n                        TotalCCF = TotalCCF\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundCCF ,\r\n                        TotalTherms = TotalTherms\r\n                        + ConEd.UploadConEdisonRate036Refunds.RefundTherms ,\r\n                        CancelTotalTherms = 0 ,\r\n                        CancelTotalCCF = 0\r\n                FROM ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n                        INNER JOIN ConEd.UploadConEdisonRate036Refunds ON ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod = ConEd.UploadConEdisonRate036Refunds.BillingPeriod\r\n                                                              AND ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriodRevision = ConEd.UploadConEdisonRate036Refunds.BillingPeriodRevision\r\n                                                              AND ConEd.UploadConEdisonAccountBillingAdjustmentGas.OriginalAccountNumber = ConEd.UploadConEdisonRate036Refunds.AccountNumber\r\n                                                              AND ConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode = ConEd.UploadConEdisonRate036Refunds.TariffCode\r\n\t--\r\n\t--\tOnce the refund is applied correctly to the ConEd.UploadConEdisonAccountBillingAdjustmentGas.  The cancellation record will be removed.\r\n\t--\r\n                DELETE  FROM ConEd.UploadConEdisonCancellationTempSummarySpanned\r\n                FROM ConEd.UploadConEdisonCancellationTempSummarySpanned\r\n                        INNER JOIN ConEd.UploadConEdisonAccountSummary ON ConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod\r\n                                                              AND ConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision\r\n                                                              AND ConEd.UploadConEdisonCancellationTempSummarySpanned.AccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\n                WHERE   ( ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelCCF = 0 )\r\n                        AND ( ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelTherms = 0 )\r\n                        AND ( ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelBilledAmount <> 0 )\r\n                        AND ( ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelTariffCode IN (\r\n                              '036', '040' ) ) \r\n\t--\r\n                SET @GasRate036RefundCount = 0\r\n\r\n            END\r\n\r\n\r\n\t\t          \r\n    END"
        }
      ]
    }
  ]
}