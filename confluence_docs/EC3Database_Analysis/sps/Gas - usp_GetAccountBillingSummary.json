{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Gas",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_GetAccountBillingSummary",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_GetAccountBillingSummary",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve and summarize billing information for accounts associated with a specific utility company and billing period. It performs a detailed aggregation of billing data, including original and revised billed amounts, energy usage, and adjustments, and categorizes the data into original, adjustment, and total account billing types."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple table joins, temporary table usage, and complex aggregation logic. While it is not overly complex, the use of multiple joins and aggregations requires a good understanding of SQL and the underlying data model."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityCompanySeqID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Identifies the utility company for which the billing summary is being retrieved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the billing period for which the summary is needed, formatted as a string (e.g., '202301' for January 2023)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentInvoiceAccountBillingGroupSeqid int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the current invoice account billing group sequence ID, used to filter the data to a specific billing group."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by selecting detailed billing information from three tables: "
                },
                {
                  "type": "text",
                  "text": "AccountBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "AccountBillingGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "AccountBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ". These tables are joined on multiple keys to ensure data consistency and integrity."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The selected data is inserted into a temporary table "
                },
                {
                  "type": "text",
                  "text": "#AccountBillingDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to facilitate further processing and aggregation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs two main aggregations:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Original and Adjustment Billing",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": It groups data by "
                        },
                        {
                          "type": "text",
                          "text": "LastPeriodModified",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "UtilityCompanySeqID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", distinguishing between original and adjustment billing based on whether the "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " matches the "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriodRevision",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Total Billing",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": It aggregates all transactions to provide a total summary, regardless of the billing type."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The results are ordered by "
                },
                {
                  "type": "text",
                  "text": "BillingType",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and returned to the caller, providing a comprehensive summary of the billing data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cleanup",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The temporary table "
                },
                {
                  "type": "text",
                  "text": "#AccountBillingDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is dropped at the end of the procedure to free up resources."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Index Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the tables involved have appropriate indexes on the columns used in joins and where clauses to optimize query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a temporary table can impact performance, especially if the dataset is large. Consider monitoring the tempdb usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The aggregation logic, particularly the use of "
                },
                {
                  "type": "text",
                  "text": "SUM",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "COUNT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", can be resource-intensive. Ensure that the server has adequate resources to handle the load."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the joins between tables will always yield consistent results. Any discrepancies in data (e.g., missing or mismatched records) could lead to incorrect summaries."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of the procedure may degrade, particularly due to the use of temporary tables and complex joins."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling. Consider adding try-catch blocks to manage potential runtime errors gracefully."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no validation of input parameters. Invalid or unexpected input could lead to runtime errors or incorrect results."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\tDerek    \r\n-- Create date: <Create Date,,>\r\n-- Description:\tGet Account billing summary\r\n--  @UtilityCompanySeqID : sequence id of utility company\r\n-- @billingPeriod : billing period\r\n-- =============================================\r\nCREATE PROCEDURE [Gas].[usp_GetAccountBillingSummary]\r\n\t-- Add the parameters for the stored procedure here\r\n\t@UtilityCompanySeqID int, \r\n\t@BillingPeriod VARCHAR(6),\r\n\t@CurrentInvoiceAccountBillingGroupSeqid int\r\nAS\r\nBEGIN\r\n\t\r\n\t/* =====================================\r\n\t\tRetrieve billing information\r\n\t====================================== */\r\nSELECT  \r\n\t\tBilling.AccountBilling.OriginalAccountNumber,\r\n        Billing.AccountBilling.UtilityCompanySeqid,\r\n        Billing.AccountBilling.CurrentInvoiceAccountBillingGroup,\r\n        Billing.AccountBillingAdjustmentGas.BillingPeriod,\r\n        Billing.AccountBilling.LastPeriodModified,\r\n        Billing.AccountBilling.AccountBillingStatus,\r\n        Billing.AccountBillingAdjustmentGas.AccountStatus,\r\n        Billing.AccountBilling.BillingPeriodRevision,\r\n        Billing.AccountBilling.OriginalBilledAmount,\r\n        Billing.AccountBilling.RevisedBilledAmount,\r\n        Billing.AccountBilling.OriginalBilledAmountPaid,\r\n        Billing.AccountBilling.PaidAdjustmentAmount,\r\n        Billing.AccountBilling.TotalAmountDue,\r\n        Billing.AccountBilling.AccountEnergyUsage,\r\n        Billing.AccountBillingGas.BilledAmount,\r\n        Billing.AccountBillingGas.TotalCCF,\r\n        Billing.AccountBillingGas.TotalTherms,\r\n        Billing.AccountBillingAdjustmentGas.RevisedBilledAmount AS abagRevisedBilledAmount,\r\n        Billing.AccountBillingAdjustmentGas.CanceledBilledAmount AS abagCanceledBilledAmount,\r\n        Billing.AccountBillingGas.DiscountedAmount AS discountedAmount,\r\n        Billing.AccountBillingAdjustmentGas.RevisedCCF,\r\n        Billing.AccountBillingAdjustmentGas.CanceledCCF,\r\n        Billing.AccountBillingAdjustmentGas.RevisedTherms,\r\n        Billing.AccountBillingAdjustmentGas.CanceledTherms,\r\n        Billing.AccountBillingAdjustmentGas.AccountBillingAdjustmentGasSeqid,\r\n        Billing.AccountBillingAdjustmentGas.AccountBillingSeqid,\r\n        Billing.AccountBillingAdjustmentGas.AccountBillingGasSeqid,\r\n        Billing.AccountBilling.AccountBillingSeqid AS abAccountBillingSeqid,\r\n        Billing.AccountBillingGas.AccountBillingSeqid AS abgAccountBillingSeqid,\r\n        Billing.AccountBillingGas.AccountBillingAdjustmentGasSeqid AS abgAccountBillingAdjustmentGasSeqid,\r\n        Billing.AccountBillingGas.AccountBillingGasSeqid AS abgAccountBillingGasSeqid\r\nINTO #AccountBillingDetail\r\nFROM Billing.AccountBilling\r\n        INNER JOIN Billing.AccountBillingGas \r\n        ON \r\n\t\t\tBilling.AccountBilling.AccountBillingSeqid = Billing.AccountBillingGas.AccountBillingSeqid\r\n\t\t\tAND \r\n\t\t\tBilling.AccountBilling.OriginalAccountNumber = Billing.AccountBillingGas.OriginalAccountNumber\r\n\t\t\tAND Billing.AccountBilling.LastPeriodModified = Billing.AccountBillingGas.LastPeriodModified\r\n\t\t\tAND Billing.AccountBilling.BillingPeriodRevision = Billing.AccountBillingGas.BillingPeriodRevision\r\n\t\t\tAND Billing.AccountBilling.BillingPeriod = Billing.AccountBillingGas.BillingPeriod\r\n\t\t\tAND Billing.AccountBilling.UtilityCompanySeqid = Billing.AccountBillingGas.UtilityCompanySeqid\r\n\t\tINNER JOIN Billing.AccountBillingAdjustmentGas \r\n\t\tON \r\n\t\t\tBilling.AccountBillingGas.LastPeriodModified = Billing.AccountBillingAdjustmentGas.BillingPeriod\r\n\t\t\tAND Billing.AccountBillingGas.OriginalAccountNumber = Billing.AccountBillingAdjustmentGas.OriginalAccountNumber\r\n\t\t\tAND Billing.AccountBillingGas.UtilityCompanySeqid = Billing.AccountBillingAdjustmentGas.UtilityCompanySeqid\r\n\t\t\tAND Billing.AccountBillingGas.BillingPeriodRevision = Billing.AccountBillingAdjustmentGas.BillingPeriodRevision\r\nWHERE   Billing.AccountBillingAdjustmentGas.BillingPeriod = @BillingPeriod\r\n        AND Billing.AccountBilling.UtilityCompanySeqid = @UtilityCompanySeqID\r\n        AND Billing.AccountBilling.CurrentInvoiceAccountBillingGroup = @CurrentInvoiceAccountBillingGroupSeqid\r\n\r\n\r\n        /* =============================\r\n        Get summary information\r\n        ==============================*/\r\nSELECT accDetail.* FROM \r\n(\r\n\tSELECT  \r\n\t\t\tCASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t THEN '1) Original Account Billing'\r\n\t\t\t\t ELSE '2) Adjustment Account Billing'\r\n\t\t\tEND AS BillingType,\r\n\t\t\tCOUNT(*) AS NumberOfTransactions,\r\n\t\t\tSUM(abagRevisedBilledAmount + abagCanceledBilledAmount) AS abagNetBilledAmount,\r\n\t\t\tSUM(discountedAmount) AS\t discountedAmount,\r\n\t\t\tSUM(RevisedCCF + CanceledCCF) AS abagNetCCF,\r\n\t\t\tSUM(RevisedTherms + CanceledTherms) AS abagNetTherms,\r\n\t\t\tSUM(CASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t\t THEN OriginalBilledAmount\r\n\t\t\t\t\t ELSE 0\r\n\t\t\t\tEND) AS OriginalBilledAmount,\r\n\t\t\tSUM(RevisedBilledAmount) AS RevisedBilledAmount,\r\n\t\t\tSUM(CASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t\t THEN OriginalBilledAmountPaid\r\n\t\t\t\t\t ELSE 0\r\n\t\t\t\tEND) AS OriginalBilledAmountPaid,\r\n\t\t\tSUM(PaidAdjustmentAmount) AS PaidAdjustmentAmount,\r\n\t\t\tSUM(CASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t\t THEN TotalAmountDue\r\n\t\t\t\t\t ELSE 0\r\n\t\t\t\tEND) AS TotalAmountDue,\r\n\t\t\tSUM(abagRevisedBilledAmount) AS abagRevisedBilledAmount,\r\n\t\t\tSUM(abagCanceledBilledAmount) AS abagCanceledBilledAmount,\r\n\t\t\tSUM(AccountEnergyUsage) AS AccountEnergyUsage,\r\n\t\t\tSUM(TotalTherms) AS TotalTherms,\r\n\t\t\tSUM(TotalCCF) AS TotalCCF,\r\n\t\t\tSUM(RevisedCCF) AS RevisedCCF,\r\n\t\t\tSUM(CanceledCCF) AS CanceledCCF,\r\n\t\t\tSUM(RevisedTherms) AS RevisedTherms,\r\n\t\t\tSUM(CanceledTherms) AS CanceledTherms,\r\n\t\t\tUtilityCompanySeqID,\r\n\t\t\tLastPeriodModified,\r\n\t\t\tBillingPeriod\r\n\tFROM #AccountBillingDetail\r\n\tGROUP BY LastPeriodModified,\r\n\t\t\tBillingPeriod,\r\n\t\t\tUtilityCompanySeqID,\r\n\t\t\tCASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t THEN '1) Original Account Billing'\r\n\t\t\t\t ELSE '2) Adjustment Account Billing'\r\n\t\t\tEND\r\n\tUNION ALL\r\n\tSELECT  MIN('3) Total Account Billing') AS BillingType,\r\n\t\t\tCOUNT(*) AS NumberOfTransactions,\r\n\t\t\tSUM(abagRevisedBilledAmount + abagCanceledBilledAmount) AS abagNetBilledAmount,\r\n\t\t\tSUM(discountedAmount) AS discountedAmount,\r\n\t\t\tSUM(RevisedCCF + CanceledCCF) AS abagNetCCF,\r\n\t\t\tSUM(RevisedTherms + CanceledTherms) AS abagNetTherms,\r\n\t\t\tSUM(CASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t\t THEN OriginalBilledAmount\r\n\t\t\t\t\t ELSE 0\r\n\t\t\t\tEND) AS OriginalBilledAmount,\r\n\t\t\tSUM(RevisedBilledAmount) AS RevisedBilledAmount,\r\n\t\t\tSUM(CASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t\t THEN OriginalBilledAmountPaid\r\n\t\t\t\t\t ELSE 0\r\n\t\t\t\tEND) AS OriginalBilledAmountPaid,\r\n\t\t\tSUM(PaidAdjustmentAmount) AS PaidAdjustmentAmount,\r\n\t\t\tSUM(CASE WHEN BillingPeriod = BillingPeriodRevision\r\n\t\t\t\t\t THEN TotalAmountDue\r\n\t\t\t\t\t ELSE 0\r\n\t\t\t\tEND) AS TotalAmountDue,\r\n\t\t\tSUM(abagRevisedBilledAmount) AS abagRevisedBilledAmount,\r\n\t\t\tSUM(abagCanceledBilledAmount) AS abagCanceledBilledAmount,\r\n\t\t\tSUM(AccountEnergyUsage) AS AccountEnergyUsage,\r\n\t\t\tSUM(TotalTherms) AS TotalTherms,\r\n\t\t\tSUM(TotalCCF) AS TotalCCF,\r\n\t\t\tSUM(RevisedCCF) AS RevisedCCF,\r\n\t\t\tSUM(CanceledCCF) AS CanceledCCF,\r\n\t\t\tSUM(RevisedTherms) AS RevisedTherms,\r\n\t\t\tSUM(CanceledTherms) AS CanceledTherms,\r\n\t\t\t UtilityCompanySeqID,\r\n\t\t\tLastPeriodModified,\r\n\t\t\tBillingPeriod\r\n\tFROM #AccountBillingDetail\r\n\tGROUP BY LastPeriodModified,\r\n\t\t\tBillingPeriod,\r\n\t\t\tUtilityCompanySeqID\r\n\t\r\n) AS accDetail\r\nORDER BY accDetail.BillingType\r\n        \r\nDROP TABLE #AccountBillingDetail\r\nEND"
        }
      ]
    }
  ]
}