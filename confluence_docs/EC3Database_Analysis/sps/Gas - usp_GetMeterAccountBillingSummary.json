{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Gas",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_GetMeterAccountBillingSummary",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_GetMeterAccountBillingSummary",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a summary of meter account billing information for a specified utility company, billing period, and invoice account billing group. It retrieves and processes data from multiple tables related to meter billing, adjustments, and account billing, and outputs a detailed summary of billing transactions, including original and adjusted meter billings."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple table joins, the use of a temporary table, and aggregation operations. While the logic is straightforward, the complexity arises from the need to correctly join and aggregate data from different tables, ensuring data integrity and accuracy."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityCompanySeqID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Identifies the utility company for which the billing summary is to be generated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the billing period for which the data is to be retrieved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentInvoiceAccountBillingGroupSeqid int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Identifies the specific invoice account billing group within the utility company and billing period."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval and Temporary Table Creation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure begins by selecting distinct records from the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBilling",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBillingAdjustmentGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBillingGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " tables, joining them on several keys to ensure data consistency."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The selected data is inserted into a temporary table "
                        },
                        {
                          "type": "text",
                          "text": "#MeterBillingDetail",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation and Summary",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure performs aggregation on the temporary table to calculate various metrics such as net therms, net CCF, and consumption."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It distinguishes between original and adjustment meter billings using a "
                        },
                        {
                          "type": "text",
                          "text": "CASE",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " statement and groups the results accordingly."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "A union operation is used to combine the results of original, adjustment, and total meter billings."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The aggregated results are selected and ordered by "
                        },
                        {
                          "type": "text",
                          "text": "BillType",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to provide a structured summary of the billing data."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cleanup",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The temporary table "
                        },
                        {
                          "type": "text",
                          "text": "#MeterBillingDetail",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is dropped at the end of the procedure to free up resources."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the columns used in joins and where clauses are indexed to improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a temporary table can be resource-intensive, especially with large datasets. Monitor the tempdb usage and optimize if necessary."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The aggregation operations could be computationally expensive, particularly if the dataset is large. Consider optimizing the query or breaking it down if performance issues arise."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure relies on multiple joins with several conditions. Any discrepancies in the data or missing relationships could lead to incorrect results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of the procedure may degrade. Regular monitoring and optimization may be required."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling. Consider adding try-catch blocks to manage potential runtime errors gracefully."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no validation of input parameters. Invalid or unexpected input could lead to errors or incorrect results. Consider adding checks to ensure parameters are within expected ranges or formats."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [Gas].[usp_GetMeterAccountBillingSummary]\r\n\t@UtilityCompanySeqID int, \r\n\t@BillingPeriod VARCHAR(6),\r\n\t@CurrentInvoiceAccountBillingGroupSeqid int\r\nAS\r\nBEGIN\r\n\r\n SELECT DISTINCT Billing.MeterBillingGas.LastPeriodModified,\r\n        Billing.MeterBillingAdjustmentGas.BillingPeriod,\r\n         Billing.AccountBilling.CurrentInvoiceAccountBillingGroup,\r\n        Billing.MeterBillingAdjustmentGas.BillingPeriodRevision,\r\n        Billing.MeterBilling.OriginalAccountNumber,\r\n        Billing.MeterBilling.OriginalMeterNumber,\r\n        Billing.MeterBilling.Consumption,\r\n        Billing.MeterBillingAdjustmentGas.RevisedBilledTherms AS mbagRevisedBilledTherms,\r\n        Billing.MeterBillingAdjustmentGas.CancelTherms AS mbgaCancelTherms,\r\n        Billing.MeterBillingAdjustmentGas.CanceledBilledTherms AS mbgaCanceledBilledTherms,\r\n        Billing.MeterBillingAdjustmentGas.PriorRevisedBilledTherms AS mbgaPriorRevisedBilledTherms,\r\n        Billing.MeterBillingAdjustmentGas.Therms AS mbgaTherms,\r\n        Billing.MeterBillingGas.MeterConstant AS mbgMeterConstant,\r\n        Billing.MeterBillingGas.Ccf AS mbgCCF,\r\n        Billing.MeterBillingGas.ThermsFactor AS mbgThermsFactor,\r\n        Billing.MeterBillingGas.Therms AS mbgTherms,\r\n        Billing.MeterBillingAdjustmentGas.PriorRevisedBilledCCF AS mbgaPriorRevisedBilledCCF,\r\n        Billing.MeterBillingAdjustmentGas.RevisedBilledCCF AS mbgaRevisedBilledCCF,\r\n        Billing.MeterBillingAdjustmentGas.CanceledBilledCCF AS mbgaCanceledBilledCCF,\r\n        Billing.MeterBillingAdjustmentGas.CancelCcf AS mbgaCancelCcf,\r\n        Billing.MeterBillingAdjustmentGas.Ccf AS mbgaCCF,\r\n        Billing.MeterBillingGas.UtilityCompanySeqid\r\n  INTO #MeterBillingDetail\r\n  FROM Billing.MeterBilling\r\n        INNER JOIN \r\n\t\t\tBilling.MeterBillingAdjustmentGas \r\n\t\t\tON Billing.MeterBilling.MeterBillingSeqid = Billing.MeterBillingAdjustmentGas.MeterBillingSeqid\r\n        INNER JOIN Billing.MeterBillingGas \r\n\t\t\tON \r\n\t\t\t  Billing.MeterBilling.MeterBillingSeqid = Billing.MeterBillingGas.MeterBillingSeqid\r\n              AND Billing.MeterBillingAdjustmentGas.MeterBillingAdjustmentGasSeqid = Billing.MeterBillingGas.MeterBillingAdjustmentGasSeqid\r\n              AND Billing.MeterBilling.BillingPeriodRevision = Billing.MeterBillingGas.BillingPeriodRevision\r\n              AND Billing.MeterBillingAdjustmentGas.OriginalAccountNumber = Billing.MeterBillingGas.OriginalAccountNumber\r\n              AND Billing.MeterBillingAdjustmentGas.OriginalMeterNumber = Billing.MeterBillingGas.OriginalMeterNumber\r\n              AND Billing.MeterBillingAdjustmentGas.LastPeriodModified = Billing.MeterBillingGas.LastPeriodModified\r\n              AND Billing.MeterBillingAdjustmentGas.BillingPeriodRevision = Billing.MeterBillingGas.BillingPeriodRevision\r\n        INNER  JOIN Billing.AccountBilling\r\n\t\t\tON Billing.MeterBilling.OriginalAccountNumber = Billing.AccountBilling.OriginalAccountNumber\r\n  WHERE \r\n\tBilling.MeterBillingGas.UtilityCompanySeqid = @UtilityCompanySeqID AND \r\n\tBilling.MeterBillingAdjustmentGas.BillingPeriod = @BillingPeriod AND\r\n\tBilling.AccountBilling.CurrentInvoiceAccountBillingGroup = @CurrentInvoiceAccountBillingGroupSeqid\r\n\r\n\r\nSELECT meterDetail.* \r\nfrom\r\n(\r\n SELECT LastPeriodModified,\r\n        BillingPeriod,\r\n        CASE WHEN BillingPeriod = BillingPeriodRevision\r\n             THEN '1) Original Meter Billing'\r\n             ELSE '2) Adjustment Meter Billing'\r\n        END AS BillType,\r\n        COUNT(*) AS NumberOfTransactions,\r\n        SUM(mbagRevisedBilledTherms + mbgaCancelTherms) AS mbagNetTherms,\r\n        SUM(mbgaRevisedBilledCCF + mbgaCanceledBilledCCF) AS mbagNetCCF,\r\n        SUM(Consumption) AS Consumption,\r\n        SUM(mbagRevisedBilledTherms) AS mbagRevisedBilledTherms,\r\n        SUM(mbgaCancelTherms) AS mbgaCancelTherms,\r\n        SUM(mbgaTherms) AS mbgaTherms,\r\n        SUM(mbgCCF) AS mbgCCF,\r\n        SUM(mbgTherms) AS mbgTherms,\r\n        SUM(mbgaRevisedBilledCCF) AS mbgaRevisedBilledCCF,\r\n        SUM(mbgaCanceledBilledCCF) AS mbgaCanceledBilledCCF,\r\n        SUM(mbgaCancelCcf) AS mbgaCancelCcf,\r\n        SUM(mbgaCCF) AS mbgaCCF\r\n FROM #MeterBillingDetail\r\n GROUP BY LastPeriodModified,\r\n        BillingPeriod,\r\n        CASE WHEN BillingPeriod = BillingPeriodRevision\r\n             THEN '1) Original Meter Billing'\r\n             ELSE '2) Adjustment Meter Billing'\r\n        END\r\n UNION ALL\r\n SELECT LastPeriodModified,\r\n        BillingPeriod,\r\n        MIN('3) Total Meter Billing') AS BillType,\r\n        COUNT(*) AS NumberOfTransactions,\r\n        SUM(mbagRevisedBilledTherms + mbgaCancelTherms) AS mbagNetTherms,\r\n        SUM(mbgaRevisedBilledCCF + mbgaCanceledBilledCCF) AS mbagNetCCF,\r\n        SUM(Consumption) AS Consumption,\r\n        SUM(mbagRevisedBilledTherms) AS mbagRevisedBilledTherms,\r\n        SUM(mbgaCancelTherms) AS mbgaCancelTherms,\r\n        SUM(mbgaTherms) AS mbgaTherms,\r\n        SUM(mbgCCF) AS mbgCCF,\r\n        SUM(mbgTherms) AS mbgTherms,\r\n        SUM(mbgaRevisedBilledCCF) AS mbgaRevisedBilledCCF,\r\n        SUM(mbgaCanceledBilledCCF) AS mbgaCanceledBilledCCF,\r\n        SUM(mbgaCancelCcf) AS mbgaCancelCcf,\r\n        SUM(mbgaCCF) AS mbgaCCF\r\n FROM #MeterBillingDetail\r\n GROUP BY LastPeriodModified,\r\n        BillingPeriod\r\n ) AS meterDetail\r\n ORDER BY BillType\r\n \r\n\r\n DROP table #MeterBillingDetail\r\nEND"
        }
      ]
    }
  ]
}