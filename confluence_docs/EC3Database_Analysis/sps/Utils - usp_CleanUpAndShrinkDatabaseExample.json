{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Utils",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_CleanUpAndShrinkDatabaseExample",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Low",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_CleanUpAndShrinkDatabaseExample",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to manage the transaction log of a SQL Server database named "
        },
        {
          "type": "text",
          "text": "EC3database",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ". It performs two main operations: changing the database recovery model to "
        },
        {
          "type": "text",
          "text": "SIMPLE",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " to truncate the transaction log, and then shrinking the log file to a specified size. After these operations, it sets the recovery model back to "
        },
        {
          "type": "text",
          "text": "FULL",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": ". The procedure includes commented-out sections related to backup operations and troubleshooting, but these are not executed as part of the procedure."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Low"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure is straightforward, involving basic database operations such as altering the recovery model and shrinking a database file. It does not involve complex logic, conditional statements, or loops."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure does not accept any input parameters. It operates directly on the "
        },
        {
          "type": "text",
          "text": "EC3database",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " database, which is hardcoded within the procedure."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Step 1:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure begins by altering the recovery model of "
                },
                {
                  "type": "text",
                  "text": "EC3database",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to "
                },
                {
                  "type": "text",
                  "text": "SIMPLE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ". This action allows the transaction log to be truncated, which means that inactive portions of the log can be removed, freeing up space."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Step 2:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " It then executes the "
                },
                {
                  "type": "text",
                  "text": "DBCC SHRINKFILE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " command on the "
                },
                {
                  "type": "text",
                  "text": "EC3database_log",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " file, reducing its size to 3 MB. This operation physically reduces the size of the log file on disk."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Step 3:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " Finally, the procedure sets the recovery model back to "
                },
                {
                  "type": "text",
                  "text": "FULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which is typically used for databases that require point-in-time recovery."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The commented-out sections suggest additional operations related to backup and troubleshooting, but these are not part of the active procedure logic."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Log Truncation:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " Switching to the "
                },
                {
                  "type": "text",
                  "text": "SIMPLE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " recovery model truncates the transaction log, which can be beneficial for freeing up space but may not be suitable for databases requiring point-in-time recovery."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Shrinking Files:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " Frequent shrinking of database files can lead to fragmentation, which may degrade performance over time. It is generally recommended to avoid regular shrinking unless necessary."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Recovery Model Changes:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " Changing the recovery model can have implications for backup strategies. It is important to ensure that full backups are taken after switching back to the "
                },
                {
                  "type": "text",
                  "text": "FULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " recovery model to maintain the backup chain."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Loss Risk:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " By switching to the "
                },
                {
                  "type": "text",
                  "text": "SIMPLE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " recovery model, the ability to perform point-in-time recovery is temporarily lost. This could be risky if a failure occurs during this period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Fragmentation:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " Regularly shrinking the log file can lead to fragmentation, which may impact performance. It is advisable to monitor and manage fragmentation levels."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Database Name:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure is specific to "
                },
                {
                  "type": "text",
                  "text": "EC3database",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which limits its reusability for other databases without modification."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Backup Strategy:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure does not include any backup operations, which are crucial when altering recovery models. It is important to ensure that appropriate backups are taken before and after executing this procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented-Out Code:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The presence of commented-out code related to backups and troubleshooting may cause confusion. It is important to maintain clear and concise code to avoid misunderstandings."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Utils].[usp_CleanUpAndShrinkDatabaseExample]\nAS\r\n\r\n\r\n----How to truncate the LOG only\r\n--EXECUTE master..sqlbackup '-SQL \"BACKUP LOG [EC3database] TO DISK = ''Z:\\RedGateScheduledBackupProd\\Database\\<database>\\<AUTO>.sqb'' \r\n--WITH MAILTO_ONERRORONLY = ''pheller@dcas.nyc.gov'', \r\n--CHECKSUM, DISKRETRYINTERVAL = 30, DISKRETRYCOUNT = 10, COMPRESSION = 4, THREADCOUNT = 11, VERIFY\"'\r\n\r\nALTER DATABASE EC3database SET RECOVERY simple \r\nDBCC SHRINKFILE(N'EC3database_log', 3) \r\nALTER DATABASE EC3database SET RECOVERY full\r\n\r\n/*\r\n\r\nThank you for your telephone call a few moments ago.\r\nThe Microsoft KB artilce will not help as you are using SQL 2012 and the article refers to a bug in SQL 2008 R2 where the last character of the logical file name is missing.\r\nSQL Error 3234 is from SQL Server, it is indicating that the logical file name supplied to the MOVE command does not belong to the database name - QL error 3234: Logical file 'EC3AssertedVersioining' is not part of database 'EC3AssertedVersioning'. Use RESTORE FILELISTONLY to list the logical file names.\r\nI see from your screenshot that the logical names for each file is 'EC3AssertedVersioining' and 'EC3AssertedVersioining_log'.\r\nWhat are the results when you run the following queries to obtain the header information from the backup file?\r\nUSE master\r\nGO\r\nEXECUTE master..sqlbackup '-SQL \"RESTORE FILELISTONLY FROM DISK = ''Z:\\RedGateScheduledBackupQA\\Database\\EC3AssertedVersioning\\FULL_MSSQLEC3QA_EC3AssertedVersioning_20140521_090051.sqb''\"' \r\nGO\r\nEXECUTE master..sqlbackup '-SQL \"RESTORE SQBHEADERONLY FROM DISK = ''Z:\\RedGateScheduledBackupQA\\Database\\EC3AssertedVersioning\\FULL_MSSQLEC3QA_EC3AssertedVersioning_20140521_090051.sqb''\"' \r\nGO\r\n\r\n*/"
        }
      ]
    }
  ]
}