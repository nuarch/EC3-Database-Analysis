{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "DEMDashboard_UsageByFiscalYear",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "DEMDashboard_UsageByFiscalYear",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report on energy usage metrics by fiscal year. It retrieves data from the "
        },
        {
          "type": "text",
          "text": "Published.TemporalAccountLevelSummaryByCityWide",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table and calculates various energy-related statistics, including energy usage, CO2 emissions, and billing amounts. The procedure also compares these metrics to the previous fiscal year and incorporates degree day data for heating and cooling adjustments."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple nested queries, joins, and calculations, which contribute to its medium complexity. It handles data aggregation, conditional logic, and cross-application of results, making it more complex than simple CRUD operations but not as intricate as procedures involving dynamic SQL or extensive conditional branching."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure does not take any input parameters. It relies on internal logic and data from the database to perform its operations."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting "
                },
                {
                  "type": "text",
                  "text": "NOCOUNT ON",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to prevent the sending of row count messages and sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to allow dirty reads, which can improve performance by reducing locking overhead."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine Latest Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates the latest billing period by selecting the maximum "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " from the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalAccountLevelSummaryByCityWide",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Main Query",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The core of the procedure is a complex query that:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Aggregates energy usage, CO2 emissions, and billing data by fiscal year and energy type."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Calculates metrics such as maximum and average energy usage, billed amounts, and rates."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Compares current fiscal year metrics with the previous fiscal year to determine changes in energy usage and CO2 emissions."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Joins with a subquery to obtain base city energy usage and CO2 data for the fiscal year 2008."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses a "
                        },
                        {
                          "type": "text",
                          "text": "LEFT JOIN",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to compare current year data with the previous year."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Degree Day Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A "
                },
                {
                  "type": "text",
                  "text": "CROSS APPLY",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is used to incorporate heating and cooling degree day data, which are important for normalizing energy usage based on weather conditions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ordering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The final result set is ordered by fiscal year and energy type."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but may lead to reading uncommitted data, which could be inconsistent."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple aggregations and joins, which can be resource-intensive, especially on large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Proper indexing on the "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "FiscalYear",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "EnergyType",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " columns can significantly enhance performance by speeding up data retrieval and join operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Subqueries",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of subqueries for calculating last year's data and degree days could be optimized by ensuring they are efficient and well-indexed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level may lead to reading uncommitted or inconsistent data, which could affect the accuracy of the report."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Division by Zero",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure includes division operations that could potentially result in division by zero errors if not properly handled, although "
                },
                {
                  "type": "text",
                  "text": "ISNULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is used to mitigate this risk."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Volume",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity and performance of the procedure could degrade with large volumes of data, especially if the underlying tables are not properly indexed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Fiscal Year",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a hardcoded fiscal year (2008) for base city energy usage and CO2 data could limit the flexibility and adaptability of the procedure to changes in business requirements or data structure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[DEMDashboard_UsageByFiscalYear]\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @LatestBillingPeriod AS VARCHAR(6);\r\n\t\r\n\tSELECT\r\n\t\t@LatestBillingPeriod = MAX(BillingPeriod)\r\n\tFROM\r\n\t\tPublished.TemporalAccountLevelSummaryByCityWide;\r\n\r\n\tSELECT * FROM \r\n\t\t(SELECT\r\n\t\t\tIL.FiscalYear,\r\n\t\t\tIL.EnergyUsage,\r\n\t\t\tISNULL(IR.EnergyUsage, 0) AS EnergyUsageLastYear,\r\n\t\t\tISNULL(CASE WHEN IL.EnergyUsage IS NULL OR IR.EnergyUsage = 0 THEN 0 ELSE (IL.EnergyUsage/IR.EnergyUsage)-1 END, 0) AS EnergyUsageChange,\r\n\t\t\tIL.MaxEnergyUsage,\r\n\t\t\tIL.AvgEnergyUsage,\r\n\t\t\tIL.BilledAmount,\r\n\t\t\tIL.CO2,\r\n\t\t\tISNULL(IR.CO2, 0) AS CO2LastYear,\r\n\t\t\tISNULL(CASE WHEN IL.CO2 IS NULL OR IR.CO2 = 0 THEN 0 ELSE (IL.CO2/IR.CO2) - 1 END, 0) AS CO2eChange,\r\n\t\t\tIL.EnergyType,\r\n\t\t\tIL.Rate,\r\n\t\t\tIL.BaseCityEnergyUsage,\r\n\t\t\tIL.BaseCityCO2\r\n\t\tFROM\r\n\t\t\t(SELECT\r\n\t\t\t\tTA.FiscalYear,\r\n\t\t\t\tISNULL(SUM(CAST(TA.BTU AS DECIMAL)), 0) AS EnergyUsage,\r\n\t\t\t\tISNULL(MAX(CAST(TA.DemandUsage AS DECIMAL)), 0) * 0.001 AS MaxEnergyUsage,\r\n\t\t\t\tISNULL(AVG(CAST(TA.DemandUsage AS DECIMAL)), 0) * 0.001 AS AvgEnergyUsage,\r\n\t\t\t\tISNULL(SUM(BilledAmount), 0) AS BilledAmount,\r\n\t\t\t\tISNULL(SUM(TA.CO2), 0) AS CO2,\r\n\t\t\t\tTA.EnergyType,\r\n\t\t\t\tSUM(CAST(BilledAmount AS DECIMAL))/SUM(CAST(EnergyUsage AS DECIMAL)) AS Rate,\r\n\t\t\t\tMAX(CJ.BaseCityEnergyUsage) AS BaseCityEnergyUsage,\r\n\t\t\t\tMAX(CJ.BaseCityCO2) AS BaseCityCO2\r\n\t\t\tFROM\r\n\t\t\t\tPublished.TemporalAccountLevelSummaryByCityWide AS TA\r\n\t\t\t\tINNER JOIN (SELECT\t\t\t\t\r\n\t\t\t\t\t\tISNULL(SUM(CAST(TA.BTU AS DECIMAL)), 0) AS BaseCityEnergyUsage,\r\n\t\t\t\t\t\tISNULL(SUM(TA.CO2), 0) AS BaseCityCO2,\r\n\t\t\t\t\t\tEnergyType\r\n\t\t\t\t\tFROM\r\n\t\t\t\t\t\tPublished.TemporalAccountLevelSummaryByCityWide AS TA\r\n\t\t\t\t\tWHERE\r\n\t\t\t\t\t\tTA.EffectiveStartPeriod <= @LatestBillingPeriod\r\n\t\t\t\t\t\tAND TA.EffectiveEndPeriod > @LatestBillingPeriod\r\n\t\t\t\t\t\tAND TA.FiscalYear = 2008\r\n\t\t\t\t\tGROUP BY\r\n\t\t\t\t\t\tTA.FiscalYear,\r\n\t\t\t\t\t\tTA.EnergyType) AS CJ\r\n\t\t\t\tON CJ.EnergyType = TA.EnergyType\r\n\t\t\tWHERE\r\n\t\t\t\tTA.EffectiveStartPeriod <= @LatestBillingPeriod\r\n\t\t\t\tAND TA.EffectiveEndPeriod > @LatestBillingPeriod\r\n\t\t\tGROUP BY\r\n\t\t\t\tTA.FiscalYear,\r\n\t\t\t\tTA.EnergyType) AS IL\r\n\t\t\tLEFT JOIN (SELECT\r\n\t\t\t\t\tSUM(I.CO2) AS CO2,\r\n\t\t\t\t\tSUM(CAST(I.BTU AS DECIMAL)) AS EnergyUsage,\r\n\t\t\t\t\tI.FiscalYear,\r\n\t\t\t\t\tI.EnergyType\r\n\t\t\t\tFROM\r\n\t\t\t\t\tPublished.TemporalAccountLevelSummaryByCityWide AS I\r\n\t\t\t\tWHERE\r\n\t\t\t\t\tI.EffectiveStartPeriod <= @LatestBillingPeriod\r\n\t\t\t\t\tAND I.EffectiveEndPeriod > @LatestBillingPeriod\r\n\t\t\t\tGROUP BY\r\n\t\t\t\t\tI.FiscalYear, I.EnergyType) AS IR\r\n\t\t\t\tON IL.EnergyType = IR.EnergyType\r\n\t\t\t\t\tAND CAST(IL.FiscalYear AS INT) = CAST(IR.FiscalYear AS INT) + 1\r\n\t\t) AS L\r\n\tCROSS APPLY \r\n\t(SELECT\r\n\t\tSUM(IR.HDD) AS HDD,\r\n\t\tSUM(IR.HDDLastYear) AS HDDLastYear,\r\n\t\tSUM(IR.CDD) AS CDD,\r\n\t\tSUM(IR.CDDLastYear) AS CDDLastYear\r\n\tFROM (SELECT\r\n\t\t\tD.BillingPeriod,\r\n\t\t\tdbo.CalculateFiscalYear(D.BillingPeriod) AS FiscalYear\r\n\t\t\t,SUM(D.BaseHeatingDegreeDays) AS HDD,\r\n\t\t\tISNULL((SELECT\r\n\t\t\t\t\tSUM(ID.BaseHeatingDegreeDays)\r\n\t\t\t\tFROM\r\n\t\t\t\t\tFactors.DegreeDayBase AS ID\r\n\t\t\t\t\tINNER JOIN Factors.DegreeDayNormalized30YearAverage AS IDN\r\n\t\t\t\t\t\tON ID.MM = IDN.MM\r\n\t\t\t\tWHERE\r\n\t\t\t\t\tID.BillingPeriod = D.BillingPeriod - 100), 0) AS HDDLastYear,\r\n\t\t\tSUM(D.BaseCoolingDegreeDays) AS CDD,\r\n\t\t\tISNULL((SELECT\r\n\t\t\t\t\tSUM(ID.BaseCoolingDegreeDays)\r\n\t\t\t\tFROM\r\n\t\t\t\t\tFactors.DegreeDayBase AS ID\r\n\t\t\t\t\tINNER JOIN Factors.DegreeDayNormalized30YearAverage AS IDN\r\n\t\t\t\t\t\tON ID.MM = IDN.MM\r\n\t\t\t\tWHERE\r\n\t\t\t\t\tID.BillingPeriod = D.BillingPeriod - 100), 0) AS CDDLastYear\r\n\t\tFROM\r\n\t\t\tFactors.DegreeDayBase AS D \r\n\t\t\tINNER JOIN Factors.DegreeDayNormalized30YearAverage AS N\r\n\t\t\t\tON D.MM = N.MM\r\n\t\tGROUP BY\r\n\t\t\tD.BillingPeriod) AS IR\r\n\tWHERE\r\n\t\tL.FiscalYear = IR.FiscalYear\r\n\tGROUP BY\r\n\t\tIR.FiscalYear) AS A\r\n\tORDER BY\r\n\t\tL.FiscalYear,\r\n\t\tL.EnergyType;\r\nEND;"
        }
      ]
    }
  ]
}