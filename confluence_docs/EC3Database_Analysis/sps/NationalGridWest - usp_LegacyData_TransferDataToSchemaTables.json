{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "NationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_LegacyData_TransferDataToSchemaTables",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_LegacyData_TransferDataToSchemaTables",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to handle the transfer and adjustment of billing data from legacy tables to schema tables within a SQL Server database. It processes billing adjustments for gas accounts, specifically handling cancellations and revisions, and updates the relevant tables with adjusted values. The procedure involves updating existing records, inserting data into target tables, and ensuring data consistency across related tables."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple operations, including updates, inserts, and conditional logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary tables are used to manage intermediate data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure includes identity insert operations, which require careful handling."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs several joins and conditional checks, which add to the complexity."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@InvoiceAccountBillingGroupSeqid AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is used to filter and update records related to a specific billing group. It is crucial for ensuring that only relevant records are processed during the update operations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Update Adjustments for Cancellations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by updating the "
                },
                {
                  "type": "text",
                  "text": "RevisedCCF",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "RevisedTherms",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " fields in the "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestAccountBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table for records where the billing period matches the revision period and there are non-zero cancellation values."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Store Canceled Account Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It selects account numbers and cancellation totals into a temporary table "
                },
                {
                  "type": "text",
                  "text": "#CanceledOriginalAccountBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for further processing."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Process Meter Billing Adjustments",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If there are records in the temporary table, it calculates the number of meters per account and stores this in another temporary table "
                },
                {
                  "type": "text",
                  "text": "#CanceledOriginalMeterBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It updates the "
                },
                {
                  "type": "text",
                  "text": "RevisedBilledCCF",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "RevisedBilledTherms",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " in the "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table for accounts with a single meter."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Transfer to Schema Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure truncates the target schema tables "
                },
                {
                  "type": "text",
                  "text": "Gas.UploadAccountBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "Gas.UploadMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It inserts data from the legacy tables into these schema tables, handling identity inserts and ensuring data integrity with "
                },
                {
                  "type": "text",
                  "text": "ISNULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " checks for certain fields."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Update Additional Fields",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It updates the "
                },
                {
                  "type": "text",
                  "text": "Gas.UploadAccountBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table with billing cycle parameters from the "
                },
                {
                  "type": "text",
                  "text": "Common.UploadCycleParameters",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It updates the "
                },
                {
                  "type": "text",
                  "text": "PaidAdjustmentAmount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " field using a view "
                },
                {
                  "type": "text",
                  "text": "Gas.uvw_CalculateUploadAccountBillingNetPaidAdjustment",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporary tables can impact performance, especially if the dataset is large. Indexing these tables or optimizing the queries that populate them improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncation and Identity Inserts",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating tables and managing identity inserts can be resource-intensive operations. Ensuring that these operations are necessary and optimized is crucial."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Conditional Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple joins and conditional checks, which can be optimized by ensuring that indexes are appropriately used on the joined columns."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves truncating tables and inserting data, which could lead to data loss if not handled carefully. Ensuring backups and transaction management is critical."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporary tables and identity inserts may lead to concurrency issues if the procedure is executed simultaneously by multiple processes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete transactions in case of failures."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the performance of the procedure may degrade, especially due to the use of temporary tables and complex joins."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [NationalGridWest].[usp_LegacyData_TransferDataToSchemaTables]\n(\r\n\t@InvoiceAccountBillingGroupSeqid AS INT\r\n)\r\nAS \r\nBEGIN\r\n\t/*\r\n\t\t1. set revisedCCF, revisedTherms for original bill with cancellation\r\n\t*/\r\n    UPDATE NationalGridWest.UploadLegacyKeyspanWestAccountBillingAdjustmentGas\r\n    SET RevisedCCF = RevisedCCF + CancelTotalCCF,\r\n        RevisedTherms = RevisedTherms + CancelTotalTherms,\r\n        Notes = SUBSTRING(Notes\r\n            + ' Account corrected by netting the CancelTotalCCF:'\r\n            + CAST(CancelTotalCCF AS VARCHAR(10))\r\n            + ' and the CancelTotalTherms: '\r\n            + CAST(CancelTotalTherms AS VARCHAR(10)), 1, 300)\r\n    WHERE BillingPeriod = BillingPeriodRevision\r\n        AND CancelTotalCCF <> 0;\r\n\t\t\r\n\t/*\r\n\t\t2. store accountnumber, total cancel ccf and total cancel therms of original bill \r\n\t\twith cancellationto temp table\r\n\t*/\r\n    SELECT OriginalAccountNumber,\r\n        CancelTotalCCF,\r\n        CancelTotalTherms\r\n    INTO #CanceledOriginalAccountBilling\r\n    FROM NationalGridWest.UploadLegacyKeyspanWestAccountBillingAdjustmentGas\r\n    WHERE BillingPeriod = BillingPeriodRevision\r\n        AND CancelTotalCCF <> 0;\r\n\t\t\r\n    IF (@@Rowcount <> 0) \r\n    BEGIN\r\n        SELECT U.OriginalAccountNumber,\r\n            COUNT(*) AS NumberOfMeters\r\n        INTO #CanceledOriginalMeterBilling\r\n        FROM NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas AS U\r\n            INNER JOIN #CanceledOriginalAccountBilling AS C ON U.OriginalAccountNumber = C.OriginalAccountNumber\r\n        WHERE U.BillingPeriod = U.BillingPeriodRevision\r\n        GROUP BY U.OriginalAccountNumber;\r\n\t\t\r\n        UPDATE U\r\n        SET RevisedBilledCCF = U.RevisedBilledCCF + C.CancelTotalCCF,\r\n            RevisedBilledTherms = U.RevisedBilledTherms + C.CancelTotalTherms,\r\n            Notes = SUBSTRING(U.Notes\r\n                + ' Account corrected by netting the CancelTotalCCF:'\r\n                + CAST(C.CancelTotalCCF AS VARCHAR(10))\r\n                + ' and the CancelTotalTherms: '\r\n                + CAST(C.CancelTotalTherms AS VARCHAR(10)), 1, 300)\r\n        FROM #CanceledOriginalAccountBilling AS C\r\n            INNER JOIN NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas AS U ON C.OriginalAccountNumber = U.OriginalAccountNumber\r\n            INNER JOIN #CanceledOriginalMeterBilling AS CM ON U.OriginalAccountNumber = CM.OriginalAccountNumber\r\n        WHERE CM.NumberOfMeters = 1;\r\n\t\r\n        DROP TABLE IF EXISTS #CanceledOriginalMeterBilling;\r\n    END; -- end if there are records in temptable\r\n\t\t\r\n    DROP TABLE IF EXISTS #CanceledOriginalAccountBilling;\r\n\r\n    TRUNCATE TABLE Gas.UploadAccountBillingAdjustmentGas\r\n    TRUNCATE TABLE Gas.UploadMeterBillingAdjustmentGas\r\n\t\t\r\n    SET IDENTITY_INSERT Gas.UploadAccountBillingAdjustmentGas ON\r\n\t\t\r\n    INSERT INTO Gas.UploadAccountBillingAdjustmentGas\r\n        (UploadAccountBillingAdjustmentGasSeqid,\r\n        FacilityName,\r\n        ServiceAddress,\r\n        AccountSeqid,\r\n        AccountBillingSeqid,\r\n        AccountBillingGasSeqid,\r\n        UtilityCompanySeqid,\r\n        AccountStatus,\r\n        AccountpreviousStatus,\r\n        AccountStatusPeriod,\r\n        InvoiceAccountBillingGroupSeqid,\r\n        NumberOfTransactions,\r\n        NumberOfRebillTransactions,\r\n        NumberOfCancelTransactions,\r\n        OriginalAccountNumber,\r\n        BillingPeriod,\r\n        BillingPeriodRevision,\r\n        FirstCanceledBillingPeriod,\r\n        EstimatedOrActualBilling,\r\n        InitialCancelFromDate,\r\n        CurrentBillingToDate,\r\n        NumberOfBillingPeriods,\r\n        TotalBillingDaysRebilled,\r\n        TotalRebilledAmount,\r\n        TotalCanceledAmount,\r\n        PriorRevisedBilledAmount,\r\n        RevisedBilledAmount,\r\n        CanceledBilledAmount,\r\n        PriorRevisedCCF,\r\n        RevisedCCF,\r\n        CanceledCCF,\r\n        PriorRevisedTherms,\r\n        RevisedTherms,\r\n        CanceledTherms,\r\n        AverageRebillCostOfGasCharge,\r\n        AverageRebillThermsFactor,\r\n        BillingDays,\r\n        BillingDate,\r\n        ToDate,\r\n        FromDate,\r\n        BillingAction,\r\n        ProcessedInTheCurrentPeriod,\r\n        GasRateCode,\r\n        TotalCCF,\r\n        TotalTherms,\r\n        ThermsFactor,\r\n        CancelFromDate,\r\n        CancelToDate,\r\n        CancelTotalCCF,\r\n        CancelTotalTherms,\r\n        CancelThermsFactor,\r\n        CancelBillingDays,\r\n        ProcessEffectiveDate,\r\n        DerivedFromSpannedBill,\r\n        SpannedBillingPeriodRevision,\r\n        SpannedFirstCanceledBillingPeriod,\r\n        SpannedBilledAmount,\r\n        SpannedCCF,\r\n        SpannedThermFactor,\r\n        SpannedTherm,\r\n        SpannedMonthlyPercentage,\r\n        SpannedTotalPercentage,\r\n        Notes,\r\n        AuthenticatedUserID,\r\n        DateAdded,\r\n        LastUpdate,\r\n        EnergySource,\r\n        BillingCycle,\r\n        SalesType,\r\n        ManualPaymentOverride,\r\n        ManualDataEntry,\r\n        IsTimeOfDayAccount,\r\n        LastPeriodModified,\r\n        DiscountedAmount,\r\n        DiscountPercentage,\r\n        balanceDollars,\r\n        CreditDollars,\r\n        PaidAdjustmentAmount)\r\n    SELECT UploadLegacyKeyspanWestAccountBillingAdjustmentGasSeqid,\r\n        FacilityName,\r\n        ServiceAddress,\r\n        AdjustedAccount,\r\n        AdjustedAccountBilling,\r\n        AdjustedAccountBillingGas,\r\n        AccountUtilityCompanySeqid,\r\n        AccountStatus,\r\n        AccountpreviousStatus,\r\n        AccountStatusPeriod,\r\n        CurrentInvoiceAccountBillingGroup,\r\n        NumberOfTransactions,\r\n        NumberOfRebillTransactions,\r\n        NumberOfCancelTransactions,\r\n        OriginalAccountNumber,\r\n        BillingPeriod,\r\n        BillingPeriodRevision,\r\n        FirstCanceledBillingPeriod,\r\n        EstimatedOrActualBilling,\r\n        InitialCancelFromDate,\r\n        CurrentBillingToDate,\r\n        NumberOfBillingPeriods,\r\n        TotalBillingDaysRebilled,\r\n        TotalRebilledAmount,\r\n        TotalCanceledAmount,\r\n        PriorRevisedBilledAmount,\r\n        RevisedBilledAmount,\r\n        CanceledBilledAmount,\r\n        PriorRevisedCCF,\r\n        RevisedCCF,\r\n        ISNULL(CanceledCCF, 0),\r\n        ISNULL(PriorRevisedTherms,0),\r\n        ISNULL(RevisedTherms,0),\r\n        ISNULL(CanceledTherms, 0),\r\n        AverageRebillCostOfGasCharge,\r\n        AverageRebillThermsFactor,\r\n        BillingDays,\r\n        BillingDate,\r\n        ToDate,\r\n        FromDate,\r\n        BillingAction,\r\n        ProcessedInTheCurrentPeriod,\r\n        GasRateCode,\r\n        ISNULL(TotalCCF, 0),\r\n        ISNULL(TotalTherms, 0),\r\n        ThermsFactor,\r\n        CancelFromDate,\r\n        CancelToDate,\r\n        ISNULL(CancelTotalCCF, 0),\r\n        ISNULL(CancelTotalTherms, 0),\r\n        CancelThermsFactor,\r\n        CancelBillingDays,\r\n        ProcessEffectiveDate,\r\n        DerivedFromSpannedBill,\r\n        SpannedBillingPeriodRevision,\r\n        SpannedFirstCanceledBillingPeriod,\r\n        SpannedBilledAmount,\r\n        SpannedCCF,\r\n        SpannedThermFactor,\r\n        SpannedTherm,\r\n        SpannedMonthlyPercentage,\r\n        SpannedTotalPercentage,\r\n        Notes,\r\n        AuthenticatedUserID,\r\n        DateAdded,\r\n        LastUpdate,\r\n        ISNULL(EnergySource, 5),\r\n        BillingCycle,\r\n        SalesType,\r\n        ManualPaymentOverride,\r\n        ManualDataEntry,\r\n        IsTimeOfDayAccount,\r\n        BillingPeriod,\r\n\t\tDiscountedAmount,\r\n\t\tDiscountPercentage,\r\n\t\tbalanceDollars,\r\n\t\tCreditDollars,\r\n\t\tNetPaidAdjustmentAmount\r\n\tFROM NationalGridWest.UploadLegacyKeyspanWestAccountBillingAdjustmentGas\r\n                \r\n    SET IDENTITY_INSERT Gas.UploadAccountBillingAdjustmentGas OFF\r\n    SET IDENTITY_INSERT Gas.UploadMeterBillingAdjustmentGas ON\r\n\t\t\t\r\n    INSERT INTO Gas.UploadMeterBillingAdjustmentGas\r\n        (UploadMeterBillingAdjustmentGasSeqid,\r\n        FacilityName,\r\n        ServiceAddress,\r\n        UtilityCompanySeqid,\r\n        AccountSeqid,\r\n        MeterSeqid,\r\n        AccountExchangeMeterTrackSeqid,\r\n        MeterBillingSeqid,\r\n        MeterBillingGasSeqid,\r\n        OriginalAccountNumber,\r\n        OriginalMeterNumber,\r\n        BillingPeriod,\r\n        BillingPeriodRevision,\r\n        FirstCancelPeriod,\r\n        NumberOfTransactions,\r\n        NumberOfRebillTransactions,\r\n        NumberOfCancelTransactions,\r\n        BillingAction,\r\n        MeterBillingStatus,\r\n        MeterBillingPreviousStatus,\r\n        MeterBillingStatusPeriod,\r\n        PriorRevisedBilledCCF,\r\n        RevisedBilledCCF,\r\n        CanceledBilledCCF,\r\n        PriorRevisedBilledTherms,\r\n        RevisedBilledTherms,\r\n        CanceledBilledTherms,\r\n        InitialCancelFromDate,\r\n        CurrentBillingToDate,\r\n        GasRateCode,\r\n        FromDate,\r\n        ToDate,\r\n        FromReadingDate,\r\n        ToReadingDate,\r\n        MeterFromReading,\r\n        MeterToReading,\r\n        Ccf,\r\n        Therms,\r\n        ThermsFactor,\r\n        MeterConstant,\r\n        TotalBillingDaysRebilled,\r\n        NumberOfBillingPeriods,\r\n        BillingDays,\r\n        BillingDate,\r\n        ReadingCode,\r\n        NumberOfDials,\r\n        MeterType,\r\n        ProcessedInTheCurrentPeriod,\r\n        ProcessEffectiveDate,\r\n        CancelReadingCode,\r\n        CancelFromDate,\r\n        CancelToDate,\r\n        CancelMeterFromReading,\r\n        CancelMeterToReading,\r\n        CancelCcf,\r\n        CancelTherms,\r\n        CancelThermsFactor,\r\n        CancelMeterConstant,\r\n        InitialPostingDate,\r\n        DerivedFromSpannedBill,\r\n        SpannedBillingPeriodRevision,\r\n        SpannedFirstCanceledBillingPeriod,\r\n        SpannedCCF,\r\n        SpannedThermFactor,\r\n        SpannedTherm,\r\n        SpannedMonthlyPercentage,\r\n        SpannedTotalPercentage,\r\n        EstimatedOrActualBilling,\r\n        MeterReset,\r\n        AuthenticatedUserID,\r\n        Notes,\r\n        DateAdded,\r\n        LastUpdate,\r\n        LastPeriodModified,\r\n        BillCreationDate,\r\n        EnergySource,\r\n        BillingCycle,\r\n        SalesType,\r\n        IsTimeOfDayAccount,\r\n        UtilityServiceAddress,\r\n        MeterDials,\r\n        GasCorrectionFactor)\r\n    SELECT UploadLegacyKeyspanWestMeterBillingAdjustmentGasSeqid,\r\n        FacilityName,\r\n        ServiceAddress,\r\n        AccountUtilityCompanySeqid,\r\n        AccountBilled,\r\n        MeterBilled,\r\n        AccountExchangeMeterTrackSeqid,\r\n        AdjustedMeterBilling,\r\n        AdjustedMeterBillingGas,\r\n        OriginalAccountNumber,\r\n        OriginalMeterNumber,\r\n        BillingPeriod,\r\n        BillingPeriodRevision,\r\n        FirstCancelPeriod,\r\n        NumberOfTransactions,\r\n        NumberOfRebillTransactions,\r\n        NumberOfCancelTransactions,\r\n        BillingAction,\r\n        MeterBillingStatus,\r\n        MeterBillingPreviousStatus,\r\n        MeterBillingStatusPeriod,\r\n        PriorRevisedBilledCCF,\r\n        RevisedBilledCCF,\r\n        CanceledBilledCCF,\r\n        PriorRevisedBilledTherms,\r\n        RevisedBilledTherms,\r\n        CanceledBilledTherms,\r\n        InitialCancelFromDate,\r\n        CurrentBillingToDate,\r\n        GasRateCode,\r\n        FromDate,\r\n        ToDate,\r\n        FromReadingDate,\r\n        ToReadingDate,\r\n        MeterFromReading,\r\n        MeterToReading,\r\n        Ccf,\r\n        Therms,\r\n        ThermsFactor,\r\n        MeterConstant,\r\n        TotalBillingDaysRebilled,\r\n        NumberOfBillingPeriods,\r\n        BillingDays,\r\n        BillingDate,\r\n        ReadingCode,\r\n        NumberOfDials,\r\n        MeterType,\r\n        ProcessedInTheCurrentPeriod,\r\n        ProcessEffectiveDate,\r\n        CancelReadingCode,\r\n        CancelFromDate,\r\n        CancelToDate,\r\n        CancelMeterFromReading,\r\n        CancelMeterToReading,\r\n        CancelCcf,\r\n        CancelTherms,\r\n        CancelThermsFactor,\r\n        CancelMeterConstant,\r\n        InitialPostingDate,\r\n        DerivedFromSpannedBill,\r\n        SpannedBillingPeriodRevision,\r\n        SpannedFirstCanceledBillingPeriod,\r\n        SpannedCCF,\r\n        SpannedThermFactor,\r\n        SpannedTherm,\r\n        SpannedMonthlyPercentage,\r\n        SpannedTotalPercentage,\r\n        EstimatedOrActualBilling,\r\n        MeterReset,\r\n        AuthenticatedUserID,\r\n        Notes,\r\n        DateAdded,\r\n        LastUpdate,\r\n        BillingPeriod, --LastPeriodModified,\r\n        BillCreationDate,\r\n        EnergySource,\r\n        BillingCycle,\r\n        SalesType,\r\n        IsTimeOfDayAccount,\r\n        UtilityServiceAddress,\r\n        MeterDials,\r\n        GasCorrectionFactor\r\n\tFROM NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas;\r\n\r\n    SET IDENTITY_INSERT Gas.UploadMeterBillingAdjustmentGas OFF;\r\n\r\n\t--\tSet the dates below into each of the account billing row.  The information is being retrieved from the\r\n\t--\tCommon.UploadCycleParameters table:\r\n\t--\t\t\t\tBillCreationDate\r\n\t--\t\t\t\tPostMarkDate \r\n\t--\t\t\t\tDatePaymentDue \r\n\t--\t\t\t\tDateAcceptanceIntoOEC\r\n\r\n    UPDATE Gas.UploadAccountBillingAdjustmentGas\r\n    SET BillCreationDate = UCP.BillCreationDate,\r\n        PostMarkDate = UCP.PostMarkDate,\r\n        DatePaymentDue = UCP.DatePaymentDue,\r\n        DateAcceptanceIntoOEC = UCP.DateAcceptanceIntoOEC\r\n    FROM Gas.UploadAccountBillingAdjustmentGas AS U\r\n        INNER JOIN Common.UploadCycleParameters AS UCP ON U.UtilityCompanySeqid = UCP.UtilityCompanySeqid\r\n            AND U.BillingPeriod = UCP.BillingPeriod;\r\n\r\n\t--\tPost the non-zero NetPaidAdjustment to the current billing period account billing row\r\n\t-- for Cris, paidAdjustmentAmount is given.\r\n\r\n    UPDATE U\r\n    SET PaidAdjustmentAmount = V.NetPaidAdjustment\r\n    FROM Gas.uvw_CalculateUploadAccountBillingNetPaidAdjustment AS V\r\n        INNER JOIN Gas.UploadAccountBillingAdjustmentGas AS U ON V.UtilityCompanySeqid = U.UtilityCompanySeqid\r\n            AND V.UniqueAccountSeqID = U.UniqueAccountSeqID\r\n    WHERE U.BillingPeriod = U.BillingPeriodRevision\r\n\t\tAND U.InvoiceAccountBillingGroupSeqid = @InvoiceAccountBillingGroupSeqid;\r\nEND;"
        }
      ]
    }
  ]
}