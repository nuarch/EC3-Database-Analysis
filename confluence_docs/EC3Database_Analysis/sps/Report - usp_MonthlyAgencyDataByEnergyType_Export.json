{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_MonthlyAgencyDataByEnergyType_Export",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_MonthlyAgencyDataByEnergyType_Export",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report of monthly energy data for agencies, filtered by energy type and billing period. It logs the report usage and retrieves energy consumption and cost data for a specified agency or agencies, based on the provided parameters. The data is aggregated and returned in a format suitable for reporting, with a focus on fiscal year data."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. Used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the report is generated. Format is expected to be "
                },
                {
                  "type": "text",
                  "text": "YYYYMM",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The agency code(s) for which the report is generated. This can include multiple codes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Type AS VARCHAR(50)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The type of energy data to report on, such as 'BTU', 'Electricity Usage (kWh)', etc."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsAgencyUser AS BIT = 0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A flag indicating if the user is an agency user. If true, the current processing period is used as the billing period."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Setup",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure begins by setting "
                        },
                        {
                          "type": "text",
                          "text": "NOCOUNT ON",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to prevent extra result sets from interfering with the output."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The transaction isolation level is set to "
                        },
                        {
                          "type": "text",
                          "text": "READ UNCOMMITTED",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to allow dirty reads, which can improve performance but may result in reading uncommitted data."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Adjustment",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If "
                        },
                        {
                          "type": "text",
                          "text": "@IsAgencyUser",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is true, the procedure retrieves the current processing period from the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.ApplicationTimeFrame",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table and assigns it to "
                        },
                        {
                          "type": "text",
                          "text": "@PublishedBillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure logs the report usage by calling "
                        },
                        {
                          "type": "text",
                          "text": "Audit.usp_AddReportUsageLog",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", passing relevant parameters including the report name, user email, and agency codes."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval and Transformation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure calculates the month part of the billing period and adjusts it for fiscal year calculations."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It retrieves and aggregates energy data from "
                        },
                        {
                          "type": "text",
                          "text": "Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", joining with agency data to filter by the specified agency codes."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The data is aggregated by month and fiscal year, with conversions applied based on the energy type (e.g., converting energy units to BTUs)."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The final result set includes columns for energy type, billing period, agency details, fiscal year, and monthly energy data, ordered by fiscal year and agency code."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This isolation level can improve performance by reducing locking overhead but may lead to reading uncommitted or inconsistent data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple aggregations and groupings, which can be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dynamic Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of dynamic filtering based on "
                },
                {
                  "type": "text",
                  "text": "@Type",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and agency codes can impact query optimization and execution plans."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Consistency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to reading uncommitted data, which may not be suitable for all reporting needs."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Lengths",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for "
                },
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " may lead to performance issues if excessively large strings are passed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complexity in Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The nested case statements and conditional logic for energy type conversions can be complex to maintain and understand."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the performance of the aggregations and joins may degrade, requiring optimization or indexing strategies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the procedure is protected against SQL injection, especially with dynamic filtering based on input parameters."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_MonthlyAgencyDataByEnergyType_Export]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@PublishedBillingPeriod AS VARCHAR(6)\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX)\r\n\t,@Type AS VARCHAR(50)\r\n\t,@IsAgencyUser AS BIT = 0\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID), @BillingPeriodMonth AS INT;\r\n\t\r\n\tIF (@IsAgencyUser = 1)\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = PublishedBillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\tEND;\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName = @spname,\r\n\t\t@StoredProcName = @spname,\r\n\t\t@RequestedBy = @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod = @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod = NULL,\r\n\t\t@prmAgency_ies = @AgencyCodeOEC,\r\n\t\t@prmFacilityNumber_s = NULL,\r\n\t\t@prmStartingBillingPeriod = NULL,\r\n\t\t@prmEndingBillingPeriod = NULL;\r\n\r\n\tSET @BillingPeriodMonth = CAST(SUBSTRING(@PublishedBillingPeriod, 4, 6) AS INT);\r\n\tSET @BillingPeriodMonth = CASE WHEN @BillingPeriodMonth <= 6 THEN @BillingPeriodMonth + 12 ELSE @BillingPeriodMonth END;\r\n\t\r\n\tSELECT O.EnergyType\r\n        ,O.PublishedBillingPeriod\r\n        ,O.AgencyCodeOEC\r\n        ,O.AgencyName\r\n        ,O.FiscalYear\r\n\t\t,O.YearToDate\r\n\t\t,O.July\r\n\t\t,O.August\r\n\t\t,O.September\r\n\t\t,O.October\r\n\t\t,O.November\r\n\t\t,O.December\r\n\t\t,O.January\r\n\t\t,O.February\r\n\t\t,O.March\r\n\t\t,O.April\r\n\t\t,O. May\r\n\t\t,O.June\r\n\tFROM (SELECT @Type AS EnergyType,\r\n\t\t\tR.PublishedBillingPeriod,\r\n\t\t\tR.AgencyCodeOEC,\r\n\t\t\tR.AgencyName,\r\n\t\t\tR.FiscalYear,\r\n\t\t\tCASE WHEN @BillingPeriodMonth >= 7 THEN ISNULL(R.July, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 8 THEN ISNULL(R.August, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 9 THEN ISNULL(R.September, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 10 THEN ISNULL(R.October, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 11 THEN ISNULL(R.November, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 12 THEN ISNULL(R.December, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 13 THEN ISNULL(R.January, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 14 THEN ISNULL(R.February, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 15 THEN ISNULL(R.March, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 16 THEN ISNULL(R.April, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 17 THEN ISNULL(R.May, 0) ELSE 0 END\r\n\t\t\t\t+ CASE WHEN @BillingPeriodMonth >= 18 THEN ISNULL(R.June, 0) ELSE 0 END AS YearToDate,\r\n\t\t\tR.July,\r\n\t\t\tR.August,\r\n\t\t\tR.September,\r\n\t\t\tR.October,\r\n\t\t\tR.November,\r\n\t\t\tR.December,\r\n\t\t\tR.January,\r\n\t\t\tR.February,\r\n\t\t\tR.March,\r\n\t\t\tR.April,\r\n\t\t\tR.May,\r\n\t\t\tR.June\r\n\t\tFROM (SELECT @PublishedBillingPeriod AS PublishedBillingPeriod,\r\n\t\t\t\tFYPivot.AgencyCodeOEC,\r\n\t\t\t\tFYPivot.AgencyName,\r\n\t\t\t\tCAST(FYPivot.FiscalYear AS INT) AS FiscalYear,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.JulyRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.JulyRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.JulyRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.JulyRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.JulyRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.JulyRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.JulyRevisedBilledDollars) END AS July,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.AugustRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.AugustRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.AugustRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.AugustRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.AugustRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.AugustRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.AugustRevisedBilledDollars) END AS August,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.SeptemberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.SeptemberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.SeptemberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.SeptemberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.SeptemberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.SeptemberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.SeptemberRevisedBilledDollars) END AS September,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.OctoberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.OctoberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.OctoberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.OctoberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.OctoberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.OctoberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.OctoberRevisedBilledDollars) END AS October,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.NovemberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.NovemberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.NovemberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.NovemberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.NovemberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.NovemberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.NovemberRevisedBilledDollars) END AS November,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.DecemberRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.DecemberRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.DecemberRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.DecemberRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.DecemberRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.DecemberRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.DecemberRevisedBilledDollars) END AS December,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.JanuaryRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.JanuaryRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.JanuaryRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.JanuaryRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.JanuaryRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.JanuaryRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.JanuaryRevisedBilledDollars) END AS January,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.FebruaryRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.FebruaryRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.FebruaryRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.FebruaryRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.FebruaryRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.FebruaryRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.FebruaryRevisedBilledDollars) END AS February,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.MarchRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.MarchRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.MarchRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.MarchRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.MarchRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.MarchRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.MarchRevisedBilledDollars) END AS March,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.AprilRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.AprilRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.AprilRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.AprilRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.AprilRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.AprilRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.AprilRevisedBilledDollars) END AS April, \r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.MayRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.MayRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.MayRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.MayRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.MayRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.MayRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.MayRevisedBilledDollars) END AS May,\r\n\t\t\t\tCASE WHEN @Type = 'BTU' THEN SUM(CASE WHEN FYPivot.EnergyType = 'STM' THEN FYPivot.JuneRevisedEnergy * 1.11718000\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'GAS' THEN FYPivot.JuneRevisedEnergy * 0.1\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'ELE' THEN FYPivot.JuneRevisedEnergy * 0.00341297\r\n\t\t\t\t\t\tWHEN FYPivot.EnergyType = 'CHW' THEN FYPivot.JuneRevisedEnergy * 0.0223436 END)\r\n\t\t\t\t\tWHEN @Type IN ('Electricity Usage (kWh)','Gas (Therms)', 'Steam (MLbs)') THEN SUM(FYPivot.JuneRevisedEnergy)\r\n\t\t\t\t\tWHEN @Type = 'Electricity Demand (kW)' THEN SUM(FYPivot.JuneRevisedDemand)\r\n\t\t\t\t\tWHEN @Type IN ('Total Cost ($)', 'Electricity Cost ($)', 'Gas Cost ($)', 'Steam Cost ($)') THEN SUM(FYPivot.JuneRevisedBilledDollars) END AS June\r\n\t\t\tFROM Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage AS FYPivot\r\n\t\t\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS A ON FYPivot.AgencyCodeOEC = A.AgencyCodeOEC\r\n\t\t\tWHERE FYPivot.EffectiveStartPeriod <= @PublishedBillingPeriod AND FYPivot.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\t\t\tAND ((@Type IN ('Electricity Usage (kWh)', 'Electricity Cost ($)', 'Electricity Demand (kW)') AND FYPivot.EnergyType = 'ELE')\r\n\t\t\t\t\tOR (@Type IN ('Gas (Therms)', 'Gas Cost ($)') AND FYPivot.EnergyType = 'GAS')\r\n\t\t\t\t\tOR (@Type IN ('Steam (MLbs)', 'Steam Cost ($)') AND FYPivot.EnergyType = 'STM')\r\n\t\t\t\t\tOR (@Type IN ('BTU', 'Total Cost ($)')))\r\n\t\t\tGROUP BY FYPivot.AgencyCodeOEC, FYPivot.AgencyName, FYPivot.FiscalYear) AS R) AS O\r\n\tORDER BY O.FiscalYear DESC, O.AgencyCodeOEC;\r\nEND;"
        }
      ]
    }
  ]
}