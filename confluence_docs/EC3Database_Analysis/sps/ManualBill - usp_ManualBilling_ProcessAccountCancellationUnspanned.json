{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ManualBill",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ManualBilling_ProcessAccountCancellationUnspanned",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ManualBilling_ProcessAccountCancellationUnspanned",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process account cancellations that are not part of a spanned billing period. It transfers records from the "
        },
        {
          "type": "text",
          "text": "UploadManualBillingCancellation",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table to the "
        },
        {
          "type": "text",
          "text": "UploadManualBillingCancellationSummary",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table. The procedure is part of a manual billing system and is used to handle cancellations that occur within a single billing period (non-spanned)."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium. It involves data manipulation across two tables, uses input parameters, and includes conditional logic to set a status code. The procedure is straightforward in its logic but requires understanding of the business context and the structure of the involved tables."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period for which the cancellations are being processed. It is used to filter and insert records."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@authenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user who is authenticated and executing the procedure. This is recorded in the summary table for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@utilityCompany dbo.seqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for the utility company. It is used to associate the cancellation records with the correct utility company."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Status int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter used to indicate the status of the procedure execution. It is set to 9 at the start and 0 upon successful completion."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting the "
                },
                {
                  "type": "text",
                  "text": "@Status",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter to 9, indicating that the process is starting."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure inserts records into the "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingCancellationSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It selects records from the "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table where "
                },
                {
                  "type": "text",
                  "text": "DeltaNumberOfPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is less than or equal to 1, indicating non-spanned cancellations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The selected fields include various identifiers, transaction counts, billing period details, and usage metrics."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure sets certain fields to default values (e.g., "
                },
                {
                  "type": "text",
                  "text": "DerivedFromSpannedBill",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is set to 'N') and uses the current date for "
                },
                {
                  "type": "text",
                  "text": "DateAdded",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "LastUpdate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Completion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": After the insertion, the "
                },
                {
                  "type": "text",
                  "text": "@Status",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is set to 0, indicating successful execution."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is indexed on "
                },
                {
                  "type": "text",
                  "text": "DeltaNumberOfPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and other frequently queried columns to optimize the selection process."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the table contains a large number of records, consider processing in batches to avoid locking and performance degradation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure should be tested for concurrency to ensure that simultaneous executions do not lead to data integrity issues."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is accurate and complete. Any discrepancies could lead to incorrect records being inserted into the summary table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling. If an error occurs during the insertion, the "
                },
                {
                  "type": "text",
                  "text": "@Status",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " will not reflect the failure, and the procedure will not provide detailed error information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the procedure may need optimization to handle larger datasets efficiently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Audit and Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While the procedure records the authenticated user ID, additional logging might be necessary to track execution details and troubleshoot issues."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [ManualBill].[usp_ManualBilling_ProcessAccountCancellationUnspanned]\n\t@BillingPeriod varchar(6),\r\n\t@authenticatedID int,\r\n\t@utilityCompany dbo.seqid,\r\n\t@Status int  OUTPUT      \r\n   \r\n AS \r\n begin\r\n\r\n --********************************************************************************\r\n --\tAuthor: MOHAMMED BELARREM\r\n -- Description: Copy NON span cancelation records from UploadManualBillingAccountCancelation to UploadManualBillingAccountCancelationSummary\r\n --\r\n --\tLog: \r\n --\t\tCreation 02/10/2009\r\n --\t\tUpdate   02/11/2009\tUpdated the tables and needes to reflect changes \r\n --     Update   06/11/2009 Updated CanceledBilledAmount with NetBilledAmount value\r\n --\t\tUpdate   12/28/2009 Updated the tables and needes to reflect changes  \r\n --\t\tUpdate   01/07/2010 Updated the queries to be Invoice Billing Independant\r\n --\t\tUpdate\t 01/13/2010 Updated the tables and added the AccountSeqid\r\n --     Update   12/17/2018 Updated for UniqueAccountSeqID\r\n --********************************************************************************\r\n\r\n\tset @Status = 9\r\n\t\r\n\t\r\n\tINSERT INTO ManualBill.[UploadManualBillingCancellationSummary]\r\n           ([UtilityCompanySeqid]\r\n           ,[InvoiceAccountBillingGroupSeqid]\r\n           ,[AccountManualBillingHeaderSeqid]\r\n           ,[AccountSeqid]\r\n\t\t   ,[UniqueAccountSeqid] /* added on 12/17/2018 */\r\n           ,[OriginalAccountNumber]\r\n           ,[NumberOfTransactions]\r\n           ,[NumberOfRebillTransactions]\r\n           ,[NumberOfCancelTransactions]\r\n           ,[BillingPeriod]\r\n           ,[BillingPeriodRevision]\r\n           ,[ActualOrEstimated]\r\n           ,[CancelFromDate]\r\n           ,[CancelToDate]\r\n           ,[CancelBillingDays]\r\n           ,[CancelNetBilledAmount]\r\n           ,[CancelEnergyUsage]\r\n           ,[CancelDemandUsage]\r\n           ,[EnergySource]\r\n           ,[DerivedFromSpannedBill]\r\n           ,[SpannedCancelFromDate]\r\n           ,[SpannedCancelToDate]\r\n           ,[SpannedCancelBillingDays]\r\n           ,[SpannedCancelBillingPeriodRevision]\r\n           ,[SpannedCancelFirstBillingPeriodCanceled]\r\n           ,[SpannedCancelNetBilledAmount]\r\n           ,[SpannedCancelEnergy]\r\n           ,[SpannedCancelDemand]\r\n           ,[SpannedMonthlyPercentage]\r\n           ,[SpannedTotalPercentage]\r\n           ,[Notes]\r\n           ,[AuthenticatedUserID]\r\n           ,[DateAdded]\r\n           ,[LastUpdate])\r\n     \r\n\t\t select\r\n\t\t\t   @utilityCompany\t\t\t\t\t---\t[UtilityCompanySeqid]\r\n\t\t\t  ,InvoiceAccountBillingGroupSeqid\t---\t[InvoiceAccountBillingGroupSeqid]\r\n\t\t\t  ,AccountManualBillingHeaderSeqid\t---\t[AccountManualBillingHeaderSeqid]\r\n\t\t\t  ,AccountSeqid\t\t\t\t\t\t--- [Accountseqid]\r\n\t\t\t  ,UniqueAccountSeqid               --- [UniqueAccountSeqid] /* added on 12/17/2018 */\r\n\t\t\t  ,OriginalAccountNumber\t\t\t---\t[OriginalAccountNumber]\r\n\t\t\t  ,1\t\t\t\t\t\t\t\t---\t[NumberOfTransactions]\r\n\t\t\t  ,0\t\t\t\t\t\t\t\t---\t[NumberOfRebillTransactions]\r\n\t\t\t  ,1\t\t\t\t\t\t\t\t---\t[NumberOfCancelTransactions]\r\n\t\t\t  ,BillingPeriod\t\t\t\t\t---\t[BillingPeriod]\r\n\t\t\t  ,BillingPeriodRevision\t\t\t---\t[BillingPeriodRevision]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[ActualOrEstimated]\r\n\t\t\t  ,FromDate\t\t\t\t\t\t\t---\t[CancelFromDate]\r\n\t\t\t  ,ToDate\t\t\t\t\t\t\t---\t[CancelToDate]\r\n\t\t\t  ,BillingPeriodDays            \t---\t[CancelBillingDays]\r\n\t\t\t  ,NetBilledAmount\t\t\t\t\t---\t[CancelNetBilledAmount]\t\t\t\t\t\t\t\t\r\n\t\t\t  ,EnergyUsage\t\t\t\t\t\t---\t[CancelEnergyUsage]\r\n\t\t\t  ,DemandUsage\t    \t\t\t\t---\t[CancelDemandUsage]\r\n\t\t\t  ,EnergySource \t\t\t\t\t---\t[EnergySource]\r\n\t\t\t  ,'N'\t\t\t\t\t\t\t\t---\t[DerivedFromSpannedBill]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelFromDate]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelToDate]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelBillingDays]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelBillingPeriodRevision]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelFirstBillingPeriodCanceled]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelNetBilledAmount]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelEnergy]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedCancelDemand]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedMonthlyPercentage]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[SpannedTotalPercentage]\r\n\t\t\t  ,null\t\t\t\t\t\t\t\t---\t[Notes]\r\n\t\t\t  ,@authenticatedID\t\t\t\t\t---\t[AuthenticatedUserID]\r\n\t\t\t  ,getdate()\t\t\t\t\t\t--- [DateAdded]\r\n\t\t\t  ,getdate()\t\t\t\t\t\t--- [LastUpdate]\r\n\t\t\r\n\t\tFROM ManualBill.UploadManualBillingCancellation\r\n\t\tWHERE DeltaNumberOfPeriods<=1\t\t\t\r\n \r\n\t\tset @Status = 0\t\r\n\t\r\n\t\r\n\t\r\n\t\r\nend"
        }
      ]
    }
  ]
}