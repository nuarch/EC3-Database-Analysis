{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ConEd",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Upload_13_FinalizeMeterBillingProcessing",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Upload_13_FinalizeMeterBillingProcessing",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process and finalize meter billing data for gas usage in a utility company context. It performs several key operations: merging meter records, correcting billing periods, and updating notes for discrepancies between account and meter-reported billing. The procedure involves data manipulation across multiple tables, ensuring that billing records are accurate and discrepancies are documented."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple steps and operations, including data truncation, updates, inserts, and joins."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It handles data aggregation and conditional logic to correct and finalize billing records."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It interacts with several tables and views, requiring a good understanding of the database schema."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "This stored procedure does not have any input parameters. It operates on predefined tables and views within the "
        },
        {
          "type": "text",
          "text": "ConEd",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " schema."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Merge Meter Records",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure starts by truncating the "
                        },
                        {
                          "type": "text",
                          "text": "UploadConEdisonMeterBillingAdjustmentGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table to remove any existing data."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It updates the "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriodRevision",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " in "
                        },
                        {
                          "type": "text",
                          "text": "UploadConEdisonMeterSummary",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to ensure it does not exceed the "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It inserts aggregated and merged meter records into "
                        },
                        {
                          "type": "text",
                          "text": "UploadConEdisonMeterBillingAdjustmentGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", combining single and spanned period records into one per period."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Set Unique Identifiers",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates are performed to set unique sequence IDs for accounts and meters using user-defined functions "
                        },
                        {
                          "type": "text",
                          "text": "udf_GetUniqueAccountSeqId",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "udf_GetUniqueMeterSeqId",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Correct Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates "
                        },
                        {
                          "type": "text",
                          "text": "RevisedBilledCCF",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "MeterToReading",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "Ccf",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " in "
                        },
                        {
                          "type": "text",
                          "text": "UploadConEdisonMeterBillingAdjustmentGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " based on discrepancies identified in "
                        },
                        {
                          "type": "text",
                          "text": "uvw_GasUsageDiscrepanciesBetweenAccountAndMeterReportedBilling",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Update Notes for Discrepancies",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Selects all gas usage discrepancies for review."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates the "
                        },
                        {
                          "type": "text",
                          "text": "Notes",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " field in "
                        },
                        {
                          "type": "text",
                          "text": "UploadConEdisonMeterBillingAdjustmentGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to document discrepancies between account and meter billing, including reported values."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncation and Inserts",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating and inserting large volumes of data can be resource-intensive. Ensure that the database can handle these operations efficiently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Proper indexing on the tables involved, especially on columns used in joins and where clauses, can significantly improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not handle concurrency explicitly. If multiple instances run simultaneously, it could lead to data inconsistencies or locking issues."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in the source tables is accurate. Any errors in the source data could propagate through the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency and Locking",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Without explicit transaction handling, there is a risk of data inconsistencies if the procedure is executed concurrently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the performance of truncation and large-scale inserts/updates may degrade. Consider partitioning or batching operations for scalability."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks error handling mechanisms. Any runtime errors could cause the procedure to fail without logging or rollback, leading to partial updates."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [ConEd].[usp_Upload_13_FinalizeMeterBillingProcessing]\nAS \r\nBEGIN\r\n\t/*\r\n\tSteps:\r\n\t1) Merge single period and spaned meter record into one meter record per period\r\n\t2) Correct billingperiod\r\n\t3) Update note for meter discrepancy\r\n\t*/\r\n\t\r\n\t/*\r\n\tMerge single period and spaned meter record into one meter record per period\r\n\t*/\r\n\tTRUNCATE TABLE ConEd.UploadConEdisonMeterBillingAdjustmentGas;\r\n\r\n\t--\tMake sure that the max BillingPeriodRevision is less than or equal to the current BillingPeriod\r\n\tUPDATE ConEd.UploadConEdisonMeterSummary\r\n\tSET BillingPeriodRevision =case when BillingPeriodRevision> BillingPeriod then BillingPeriod else BillingPeriodRevision end \r\n\tWHERE BillingPeriod < BillingPeriodRevision;\r\n\r\n\tINSERT INTO ConEd.UploadConEdisonMeterBillingAdjustmentGas\r\n\t\t\t(AccountUtilityCompanySeqid,\r\n\t\t\tOriginalAccountNumber,\r\n\t\t\tOriginalMeterNumber,\r\n\t\t\tBillingPeriod,\r\n\t\t\tBillingPeriodRevision,\r\n\t\t\tFirstCancelPeriod,\r\n\t\t\tNumberOfTransactions,\r\n\t\t\tNumberOfRebillTransactions,\r\n\t\t\tNumberOfCancelTransactions,\r\n\t\t\tBillingAction,\r\n\t\t\tInitialCancelFromDate,\r\n\t\t\tCurrentBillingToDate,\r\n\t\t\tGasRateCode,\r\n\t\t\tFromDate,\r\n\t\t\tToDate,\r\n\t\t\tFromReadingDate,\r\n\t\t\tToReadingDate,\r\n\t\t\tMeterFromReading,\r\n\t\t\tMeterToReading,\r\n\t\t\tCcf,\r\n\t\t\tTherms,\r\n\t\t\tThermsFactor,\r\n\t\t\tMeterConstant,\r\n\t\t\tTotalBillingDaysRebilled,\r\n\t\t\tNumberOfBillingPeriods,\r\n\t\t\tBillingDays,\r\n\t\t\tBillingDate,\r\n\t\t\tReadingCode,\r\n\t\t\tNumberOfDials,\r\n\t\t\tMeterType,\r\n\t\t\tProcessedInTheCurrentPeriod,\r\n\t\t\tProcessEffectiveDate,\r\n\t\t\tDerivedFromSpannedBill,\r\n\t\t\tSpannedBillingPeriodRevision,\r\n\t\t\tSpannedFirstCanceledBillingPeriod,\r\n\t\t\tSpannedCCF,\r\n\t\t\tSpannedThermFactor,\r\n\t\t\tSpannedTherm,\r\n\t\t\tSpannedMonthlyPercentage,\r\n\t\t\tSpannedTotalPercentage,\r\n\t\t\tEstimatedOrActualBilling,\r\n\t\t\tAuthenticatedUserID,\r\n\t\t\tNotes,\r\n\t\t\tInitialPostingDate,\r\n\t\t\tFacilityName,\r\n\t\t\tServiceAddress,\r\n\t\t\tBillingCycle)\r\n\tSELECT MIN(AccountUtilityCompanySeqid) AS AccountUtilityCompanySeqid\r\n\t\t,OriginalAccountNumber\r\n\t\t,OriginalMeterNumber\r\n\t\t,MIN(BillingPeriod) AS BillingPeriod\r\n\t\t,BillingPeriodRevision\r\n\t\t,MIN(FirstCancelPeriod) AS FirstCancelPeriod\r\n\t\t,COUNT(NumberOfTransactions) AS NumberOfTransactions\r\n\t\t,COUNT(NumberOfRebillTransactions) AS NumberOfRebillTransactions\r\n\t\t,MIN(0) AS NumberOfCancelTransactions\r\n\t\t,MIN(BillingAction) AS BillingAction\r\n\t\t,MIN(InitialCancelFromDate) AS InitialCancelFromDate\r\n\t\t,MAX(CurrentBillingToDate) AS CurrentBillingToDate\r\n\t\t,MIN(GasRateCode) AS GasRateCode\r\n\t\t,MIN(FromDate) AS FromDate\r\n\t\t,MAX(ToDate) AS ToDate\r\n\t\t,MIN(FromDate) AS FromReadingDate\r\n\t\t,MAX(ToDate) AS ToReadingDate\r\n\t\t,MAX(MeterFromReading) AS MeterFromReading\r\n\t\t,MAX(MeterToReading) AS MeterToReading\r\n\t\t,SUM(Ccf) AS Ccf\r\n\t\t,SUM(Therms) AS Therms\r\n\t\t,MIN(ThermsFactor) AS ThermsFactor\r\n\t\t,MIN(MeterConstant) AS MeterConstant\r\n\t\t,SUM(TotalBillingDaysRebilled) AS TotalBillingDaysRebilled\r\n\t\t,SUM(NumberOfBillingPeriods) AS NumberOfBillingPeriods\r\n\t\t,SUM(BillingDays) AS BillingDays\r\n\t\t,MIN(BillingDate) AS BillingDate\r\n\t\t,MIN(ReadingCode) AS ReadingCode\r\n\t\t,MIN(NumberOfDials) AS NumberOfDials\r\n\t\t,MIN(MeterType) AS MeterType\r\n\t\t,MIN(ProcessedInTheCurrentPeriod) AS ProcessedInTheCurrentPeriod\r\n\t\t,MIN(ProcessEffectiveDate) AS ProcessEffectiveDate\r\n\t\t,MIN(DerivedFromSpannedBill) AS DerivedFromSpannedBill\r\n\t\t,MIN(SpannedBillingPeriodRevision) AS SpannedBillingPeriodRevision\r\n\t\t,MIN(SpannedFirstCanceledBillingPeriod) AS SpannedFirstCanceledBillingPeriod\r\n\t\t,MIN(SpannedCCF) AS SpannedCCF\r\n\t\t,MIN(SpannedThermFactor) AS SpannedThermFactor\r\n\t\t,MIN(SpannedTherm) AS SpannedTherm\r\n\t\t,MIN(SpannedMonthlyPercentage) AS SpannedMonthlyPercentage\r\n\t\t,MIN(SpannedTotalPercentage) AS SpannedTotalPercentage\r\n\t\t,MAX(EstimatedOrActualBilling) AS EstimatedOrActualBilling\r\n\t\t,MIN(AuthenticatedUserID) AS AuthenticatedUserID\r\n\t\t,MIN(Notes) AS Notes\r\n\t\t,MIN(InitialPostingDate) AS InitialPostingDate\r\n\t\t,MIN(FacilityName) AS FacilityName\r\n\t\t,MIN(ServiceAddress) AS ServiceAddress\r\n\t\t,'M'\r\n\tFROM ConEd.UploadConEdisonMeterSummary\r\n\tGROUP BY OriginalAccountNumber, OriginalMeterNumber, BillingPeriodRevision;\r\n\r\n\t-- setting the unique seq IDs\r\n\tUPDATE G\r\n\tSET UniqueAccountSeqID = Common.udf_GetUniqueAccountSeqId(G.OriginalAccountNumber)\r\n\tFROM ConEd.UploadConEdisonAccountBillingAdjustmentGas AS G\r\n\tWHERE G.UniqueAccountSeqID IS NULL;\r\n\r\n\tUPDATE MG \r\n\tSET UniqueMeterSeqID = Common.udf_GetUniqueMeterSeqId(MG.OriginalMeterNumber)\r\n\tFROM ConEd.UploadConEdisonMeterBillingAdjustmentGas AS MG\r\n\tWHERE MG.UniqueMeterSeqID IS NULL;\r\n\r\n\tUPDATE MG \r\n\tSET UniqueAccountSeqID = Common.udf_GetUniqueAccountSeqId(MG.OriginalAccountNumber)\r\n\tFROM ConEd.UploadConEdisonMeterBillingAdjustmentGas AS MG  \r\n\tWHERE MG.UniqueAccountSeqID is NULL;\r\n\r\n\t/*\r\n\t2) Correct billingperiod\r\n\t*/\r\n\r\n\tUPDATE ConEd.UploadConEdisonMeterBillingAdjustmentGas\r\n\tSET RevisedBilledCCF = vGU.MeterCcf + vGU.netCCF\r\n\t\t,MeterToReading = CASE WHEN (UCM.MeterFromReading + vGU.MeterCcf + vGU.netCCF) > 9999999 THEN 9999999\r\n\t\t\tELSE (UCM.MeterFromReading + vGU.MeterCcf + vGU.netCCF) END\r\n\t\t,Ccf = vGU.MeterCcf + vGU.netCCF\r\n\tFROM ConEd.uvw_GasUsageDiscrepanciesBetweenAccountAndMeterReportedBilling AS vGU\r\n\t\tINNER JOIN ConEd.UploadConEdisonMeterBillingAdjustmentGas AS UCM\r\n\t\t\tON vGU.UniqueAccountSeqID = UCM.UniqueAccountSeqID\r\n\t\t\t\tAND vGU.BillingPeriodRevision = UCM.BillingPeriodRevision\r\n\tWHERE vGU.netCCF <> 0 AND UCM.NumberOfRebillTransactions > 1;\r\n\r\n\t/*\r\n    UPDATE G\r\n    SET RevisedBilledCCF = D.MeterCcf + D.netCCF\r\n\t\t,MeterToReading = G.MeterFromReading + D.MeterCcf + D.netCCF\r\n\t\t,Ccf = D.MeterCcf + D.netCCF\r\n    FROM ConEd.uvw_GasUsageDiscrepanciesBetweenAccountAndMeterReportedBilling AS D\r\n        INNER JOIN ConEd.UploadConEdisonMeterBillingAdjustmentGas AS G ON D.UniqueAccountSeqID = G.UniqueAccountSeqID\r\n\t\t\tAND D.BillingPeriodRevision = G.BillingPeriodRevision\r\n    WHERE D.netCCF <> 0 AND G.NumberOfRebillTransactions > 1;\r\n\t*/\r\n\r\n\t/*\r\n\t3)  Update note for meter discrepancy \r\n\t*/\r\n      \r\n\t--\tIdentify all Gas Usage Discrepancies\r\n    SELECT * FROM ConEd.uvw_GasUsageDiscrepanciesBetweenAccountAndMeterReportedBilling;\r\n\t\r\n\t--\tUpdate the notes of all meters that have a discrepancy with the account billing and\r\n\t--\tpreserve the incorrect amount as part of what was actual reported by the utility company.\r\n    UPDATE G\r\n    SET Notes = 'Account and Meter Billing Discrepancies  '\r\n        + CASE WHEN D.netTherms <> 0 THEN 'Net Therms(' + CAST(D.netTherms AS VARCHAR(10)) + ') '\r\n\t\t+ CASE WHEN D.netCCF <> 0 THEN ')  CCF(' + CAST(D.netCCF AS VARCHAR(10)) + ')  ' ELSE ''\r\n        END + ':           Reported: Therms(' + CAST(D.AccountTotalTherms AS VARCHAR(10)) + ')           CCF('\r\n        + CAST(D.AccountTotalCcf AS VARCHAR(10)) + ')           ThermsFactor(' + CAST(D.AccountTotalThermsFactor AS VARCHAR(10)) + ')  '\r\n\t\tELSE '' END\r\n    FROM ConEd.UploadConEdisonMeterBillingAdjustmentGas AS G\r\n\t\tINNER JOIN ConEd.uvw_GasUsageDiscrepanciesBetweenAccountAndMeterReportedBilling AS D ON G.BillingPeriod = D.BillingPeriod\r\n\t\t\tAND G.BillingPeriodRevision = D.BillingPeriodRevision AND G.UniqueAccountSeqID = D.UniqueAccountSeqID;\r\nEND;"
        }
      ]
    }
  ]
}