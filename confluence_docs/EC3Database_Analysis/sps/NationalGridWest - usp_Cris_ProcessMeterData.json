{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "NationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Cris_ProcessMeterData",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Cris_ProcessMeterData",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process meter data for gas billing adjustments within the "
        },
        {
          "type": "text",
          "text": "NationalGridWest",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " schema. It performs the following operations:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncates the "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table to remove existing data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inserts new meter billing adjustment records into the same table from the "
                },
                {
                  "type": "text",
                  "text": "UploadCrisAccountMeterBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates the "
                },
                {
                  "type": "text",
                  "text": "notes",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " field in the "
                },
                {
                  "type": "text",
                  "text": "UploadCrisAccountMeterBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table for accounts with discrepancies in usage data between two tables: "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestAccountBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple operations, including data truncation, insertion, and conditional updates based on aggregated data comparisons. The complexity arises from the need to handle data integrity and ensure accurate updates based on calculated discrepancies."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter represents the ID of the user executing the procedure. It is used to track who performed the data processing by inserting this ID into the "
                },
                {
                  "type": "text",
                  "text": "AuthenticatedUserID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " column of the "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncate Table",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by truncating the "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, effectively removing all existing records to prepare for new data insertion."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Insert Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It inserts new records into the truncated table. The data is sourced from the "
                },
                {
                  "type": "text",
                  "text": "UploadCrisAccountMeterBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, with specific fields being populated directly or set to default values. Key fields like "
                },
                {
                  "type": "text",
                  "text": "FacilityName",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "ServiceAddress",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "AccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "MeterNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " are directly mapped, while others are set to constants or calculated values."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Update Notes for Discrepancies",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure identifies accounts with discrepancies in usage data by comparing aggregated "
                },
                {
                  "type": "text",
                  "text": "CCF",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "Therms",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " values between two tables. If discrepancies are found (differences greater than 1), it updates the "
                },
                {
                  "type": "text",
                  "text": "notes",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " field in the "
                },
                {
                  "type": "text",
                  "text": "UploadCrisAccountMeterBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table to indicate a usage discrepancy."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncation Impact",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating a table is a fast operation but can be resource-intensive if the table is large. It also requires appropriate permissions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Bulk Insert",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The insert operation is straightforward but could be optimized with batch processing if the source table is large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The update operation involves aggregating data and performing joins, which can be resource-intensive. Indexing on "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " in both tables could improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not handle concurrency explicitly, which could be a concern if multiple users execute it simultaneously."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Loss",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating the table results in complete data loss of existing records, which is irreversible. This operation should be carefully controlled."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in "
                },
                {
                  "type": "text",
                  "text": "UploadCrisAccountMeterBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is accurate and complete. Any errors in this data will propagate to the "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency Issues",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Without explicit transaction handling, concurrent executions could lead to race conditions or data inconsistencies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the performance of the aggregation and join operations in the update section may degrade, necessitating optimization strategies such as indexing or partitioning."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks error handling, which could lead to unhandled exceptions and partial updates in case of failures."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n/*\r\n\tData setup for Cris:\r\n\tBillingAction= O -original\r\n\tGasRateCode= '262'\r\n\tNumberOfBillingPeriods= 1\r\n\tSalesType = 'BT'\r\n\tMeterType = 'G'\r\n*/\r\n-- =============================================\r\nCREATE PROCEDURE [NationalGridWest].[usp_Cris_ProcessMeterData]\r\n\t@AuthenticatedUserID int\r\nAS\r\nBEGIN\r\n\tTRUNCATE TABLE [NationalGridWest].[UploadLegacyKeyspanWestMeterBillingAdjustmentGas]\r\n\t\tINSERT INTO [NationalGridWest].[UploadLegacyKeyspanWestMeterBillingAdjustmentGas]\r\n           ([FacilityName]\r\n           ,[ServiceAddress]\r\n           ,[AccountUtilityCompanySeqid]\r\n           ,[AccountBilled]\r\n           ,[MeterBilled]\r\n           ,[AccountExchangeMeterTrackSeqid]\r\n           ,[AdjustedMeterBilling]\r\n           ,[AdjustedMeterBillingGas]\r\n           ,[OriginalAccountNumber]\r\n           ,[OriginalMeterNumber]\r\n           ,[BillingPeriod]\r\n           ,[BillingPeriodRevision]\r\n           ,[FirstCancelPeriod]\r\n           ,[NumberOfTransactions]\r\n           ,[NumberOfRebillTransactions]\r\n           ,[NumberOfCancelTransactions]\r\n           ,[BillingAction]\r\n           ,[MeterBillingStatus]\r\n           ,[MeterBillingPreviousStatus]\r\n           ,[MeterBillingStatusPeriod]\r\n           ,[PriorRevisedBilledCCF]\r\n           ,[RevisedBilledCCF]\r\n           ,[CanceledBilledCCF]\r\n           ,[PriorRevisedBilledTherms]\r\n           ,[RevisedBilledTherms]\r\n           ,[CanceledBilledTherms]\r\n           ,[InitialCancelFromDate]\r\n           ,[CurrentBillingToDate]\r\n           ,[GasRateCode]\r\n           ,[FromDate]\r\n           ,[ToDate]\r\n           ,[FromReadingDate]\r\n           ,[ToReadingDate]\r\n           ,[MeterFromReading]\r\n           ,[MeterToReading]\r\n           ,[Ccf]\r\n           ,[Therms]\r\n           ,[ThermsFactor]\r\n           ,[MeterConstant]\r\n           ,[TotalBillingDaysRebilled]\r\n           ,[NumberOfBillingPeriods]\r\n           ,[BillingDays]\r\n           ,[BillingDate]\r\n           ,[ReadingCode]\r\n           ,[NumberOfDials]\r\n           ,[MeterType]\r\n           ,[ProcessedInTheCurrentPeriod]\r\n           ,[ProcessEffectiveDate]\r\n           ,[CancelReadingCode]\r\n           ,[CancelFromDate]\r\n           ,[CancelToDate]\r\n           ,[CancelMeterFromReading]\r\n           ,[CancelMeterToReading]\r\n           ,[CancelCcf]\r\n           ,[CancelTherms]\r\n           ,[CancelThermsFactor]\r\n           ,[CancelMeterConstant]\r\n           ,[InitialPostingDate]\r\n           ,[DerivedFromSpannedBill]\r\n           ,[SpannedBillingPeriodRevision]\r\n           ,[SpannedFirstCanceledBillingPeriod]\r\n           ,[SpannedCCF]\r\n           ,[SpannedThermFactor]\r\n           ,[SpannedTherm]\r\n           ,[SpannedMonthlyPercentage]\r\n           ,[SpannedTotalPercentage]\r\n           ,[EstimatedOrActualBilling]\r\n           ,[MeterReset]\r\n           ,[BillCreationDate]\r\n           ,[EnergySource]\r\n           ,[LastPeriodModified]\r\n           ,[BillingCycle]\r\n           ,[SalesType]\r\n           ,[IsTimeOfDayAccount]\r\n           ,[UtilityServiceAddress]\r\n           ,[MeterDials]\r\n           ,[GasCorrectionFactor]\r\n           ,[AuthenticatedUserID]\r\n           ,[Notes]\r\n           ,[DateAdded]\r\n           ,[LastUpdate])\r\n\t\tselect\r\n           ServiceAccountName --<FacilityName, UtilityServiceAccountName,>\r\n           ,LTRIM(RTRIM(ServiceAddress)) --<ServiceAddress, addr,>\r\n           ,UtilityCompanyID --<AccountUtilityCompanySeqid, seqid,>\r\n           ,NULL --<AccountBilled, seqid,>\r\n           ,NULL --<MeterBilled, seqid,>\r\n           ,NULL --<AccountExchangeMeterTrackSeqid, seqid,>\r\n           ,NULL --<AdjustedMeterBilling, seqid,>\r\n           ,NULL --<AdjustedMeterBillingGas, seqid,>\r\n           ,AccountNumber --<OriginalAccountNumber, acctnum,>\r\n           ,MeterNumber --<OriginalMeterNumber, MeterNumber,>\r\n           ,BillingPeriod --<BillingPeriod, yyyymm,>\r\n           ,BillingPeriodRevision --<BillingPeriodRevision, yyyymm,>\r\n           ,FirstCancelPeriod --<FirstCancelPeriod, yyyymm,>\r\n           ,1 --<NumberOfTransactions, Accumulator,>\r\n           ,1 --<NumberOfRebillTransactions, Accumulator,>\r\n           ,0 --<NumberOfCancelTransactions, Accumulator,>\r\n           ,'O' --<BillingAction, BillingAction,>\r\n           ,NULL --<MeterBillingStatus, AccountStatus,>\r\n           ,NULL --<MeterBillingPreviousStatus, AccountStatus,>\r\n           ,NULL --<MeterBillingStatusPeriod, StatusCodePeriod,>\r\n           \r\n           ,NULL --<PriorRevisedBilledCCF, EnergyUnit,>\r\n           ,MeterCCF --<RevisedBilledCCF, EnergyUnit,>\r\n           ,NULL --<CanceledBilledCCF, EnergyUnit,>\r\n           \r\n           ,NULL --<PriorRevisedBilledTherms, EnergyUnit,>\r\n           ,MeterTherms --<RevisedBilledTherms, EnergyUnit,>\r\n           ,NULL --<CanceledBilledTherms, EnergyUnit,>\r\n           \r\n           ,FromDate --<InitialCancelFromDate, yyyymmdd,>\r\n           ,ToDate --<CurrentBillingToDate, yyyymmdd,>\r\n           ,'262' --<GasRateCode, GasRateCode,>\r\n           ,FromDate --<FromDate, yyyymmdd,>\r\n           ,ToDate --<ToDate, yyyymmdd,>\r\n           ,FromDate --<FromReadingDate, yyyymmdd,>\r\n           ,ToDate --<ToReadingDate, yyyymmdd,>\r\n           ,FromMeterReading --<MeterFromReading, MeterReadingNumber,>\r\n           ,ToMeterReading --<MeterToReading, MeterReadingNumber,>\r\n           ,MeterCCF --<Ccf, EnergyUnit,>\r\n           ,MeterTherms --<Therms, EnergyUnit,>\r\n           ,ThermsFactor --<ThermsFactor, ThermsFactor,>\r\n           ,MeterConstant --<MeterConstant, MeterConstant,>\r\n           ,BillingDays --<TotalBillingDaysRebilled, Accumulator,>\r\n           ,1 --<NumberOfBillingPeriods, Accumulator,>\r\n           ,BillingDays --<BillingDays, Accumulator,>\r\n           ,NULL --<BillingDate, yyyymmdd,>\r\n           ,NULL --<ReadingCode, ReadingCode,>\r\n           ,NumberOfDials --<NumberOfDials, varchar(1),>\r\n           ,'G' --<MeterType, MeterType,>\r\n           ,'Y' --<ProcessedInTheCurrentPeriod, yesnoWithDefaultNo,>\r\n           ,[dbo].ConvertDateToYYYYMMDD (GETDATE()) --<ProcessEffectiveDate, yyyymmdd,>\r\n           ,NULL --<CancelReadingCode, ReadingCode,>\r\n           ,NULL --<CancelFromDate, yyyymmdd,>\r\n           ,NULL --<CancelToDate, yyyymmdd,>\r\n           ,NULL --<CancelMeterFromReading, MeterReadingNumber,>\r\n           ,NULL --<CancelMeterToReading, MeterReadingNumber,>\r\n           ,NULL --<CancelCcf, EnergyUnit,>\r\n           ,NULL --<CancelTherms, EnergyUnit,>\r\n           ,NULL --<CancelThermsFactor, ThermsFactor,>\r\n           ,NULL --<CancelMeterConstant, MeterConstant,>\r\n           ,GETDATE() --<InitialPostingDate, InitialPostingDate,>\r\n           ,'N' --<DerivedFromSpannedBill, yesnoWithDefaultNo,>\r\n           ,NULL --<SpannedBillingPeriodRevision, yyyymm,>\r\n           ,NULL --<SpannedFirstCanceledBillingPeriod, yyyymm,>\r\n           ,NULL --<SpannedCCF, EnergyUnit,>\r\n           ,NULL --<SpannedThermFactor, ThermsFactor,>\r\n           ,NULL --<SpannedTherm, EnergyUnit,>\r\n           ,NULL --<SpannedMonthlyPercentage, SpannedPercentage,>\r\n           ,NULL --<SpannedTotalPercentage, SpannedPercentage,>\r\n           ,EstimatedCode --<EstimatedOrActualBilling, EstimatedReading,>\r\n           ,NULL --<MeterReset, yesnoWithDefaultNo,>\r\n           ,NULL --<BillCreationDate, yyyymmdd,>\r\n           ,'5' --<EnergySource, EnergySource,>\r\n           ,BillingPeriodRevision --<LastPeriodModified, yyyymm,>\r\n           ,'M' --<BillingCycle, MonthlyBillingCycle,>\r\n           ,'BT' --<SalesType, SalesType,>\r\n           ,'N' --<IsTimeOfDayAccount, yesnoWithDefaultNo,>\r\n           ,LTRIM(RTRIM(ServiceAddress))--<UtilityServiceAddress, addr,>\r\n           ,NumberOfDials --<MeterDials, MeterDials,>\r\n           ,GasCorrectionFactor --<GasCorrectionFactor, GasCorrectionFactor,>\r\n           ,@AuthenticatedUserID --<AuthenticatedUserID, AuthenticatedUserID,>\r\n           ,Notes --<Notes, notes,>\r\n           ,GETDATE() --<DateAdded, DateAdded,>\r\n           ,GETDATE() --<LastUpdate, LastUpdate,>\r\n      FROM NationalGridWest.UploadCrisAccountMeterBilling\r\n\t\r\n\t\t\r\n\t/* update notes for meter with discrepancy */\r\n\tUPDATE NationalGridWest.UploadCrisAccountMeterBilling\r\n\tSET notes = notes + ' Usage discrepancy.'\r\n\tWHERE\r\n\taccountNumber\r\n\tIN(\r\n\t\tSELECT  acc.OriginalAccountNumber\r\n\t\tFROM \r\n\t\t( SELECT    SUM(CCF) AS totalCCF, SUM(therms) AS totalTherm,\r\n\t\t\t\t\tOriginalAccountNumber\r\n\t\t  FROM   NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas\r\n\t\t  GROUP BY  OriginalAccountNumber\r\n\t\t) AS met\r\n\t\tINNER JOIN \r\n\t\t( SELECT SUM(TotalCCF) AS totalCCF, SUM(TotalTherms) AS totalTherm,\r\n\t\t\t\t\tOriginalAccountNumber\r\n\t\t\t FROM NationalGridWest.UploadLegacyKeyspanWestAccountBillingAdjustmentGas\r\n\t\t\t GROUP BY OriginalAccountNumber\r\n\t\t) AS acc \r\n\t\tON \r\n\t\tmet.OriginalAccountNumber = acc.OriginalAccountNumber\r\n\t\tAND \r\n\t\t(\tABS(met.totalCCF - acc.totalCCF) > 1 \r\n\t\t\tor\r\n\t\t\tABS(met.totalTherm - acc.totalTherm) > 1\r\n\t\t)\r\n\t)\r\n\t\r\nEND"
        }
      ]
    }
  ]
}