{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_EIAP_Total_Summary",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_EIAP_Total_Summary",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to calculate and summarize financial adjustments and credits related to utility billing for a specific agency within a given billing period. It computes savings due to adjustments, credits for minimum demand charges, and potential savings reductions due to budgeted delivery costs. The procedure utilizes temporal tables to access historical billing data and performs calculations based on the agency's hierarchical structure."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple calculations and conditional logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses temporal tables and dynamic date calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It requires joining multiple tables and handling hierarchical data structures."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartPeriod BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the starting billing period for the calculations. It is dynamically set within the procedure based on the fiscal year."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SelectedPeriod BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The specific billing period for which the summary is being generated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Email emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An email address used in the context of retrieving agency children, for logging or notification purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The agency code for which the summary is being generated. It is used to determine the agency's hierarchical structure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Fiscal Year Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure calculates the fiscal year based on the "
                },
                {
                  "type": "text",
                  "text": "@SelectedPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and determines the start and end periods for the EIAP (Energy Incentive Adjustment Program) calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Agency Hierarchy",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It retrieves all child agencies of the selected agency using the "
                },
                {
                  "type": "text",
                  "text": "Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " function and stores them in a table variable "
                },
                {
                  "type": "text",
                  "text": "@AgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Savings Due to Adjustment",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure calculates savings due to adjustments by comparing revised billed amounts between the selected period and a calendar end period. This involves joining temporal tables to access historical billing data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Credit for Minimum Demand",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates credits for minimum demand charges by applying a formula to both production and delivery demand. This involves summing up differences in demand usage and applying rates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure returns the calculated savings and credits as a result set."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporal Table Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporal tables can be resource-intensive, especially if the tables contain a large volume of historical data. Indexing on key columns like "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can help improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Variable Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a table variable ("
                },
                {
                  "type": "text",
                  "text": "@AgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") is suitable for small datasets but not perform well with larger datasets. Consider using a temporary table if the dataset is large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "ISNULL and NULLIF Functions",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": These functions are used to handle null values and prevent division by zero errors, which is good practice for maintaining data integrity and avoiding runtime errors."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the temporal tables and agency hierarchy functions return accurate and complete data. Any discrepancies in these sources can lead to incorrect calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of the procedure may degrade, especially due to the use of temporal tables and complex joins."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling mechanisms. Consider adding TRY...CATCH blocks to handle potential runtime errors gracefully."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure contains hardcoded logic for fiscal year calculations and period settings, which may need adjustments if the fiscal year definitions change."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- Stored Procedure\n\r\n--**************************************************************************************\r\n-- AUTHOR:\t\tPeter Heller\r\n--\r\n-- Date\t\t\tTech\tDescription of Change\r\n-- XX/XX/20XX\tPH\t\tFirst Version \r\n-- 02/22/2016\tMB ZD\tUpdate: Changed to use temporal tables\r\n--***************************************************************************************\r\n\r\nCREATE PROCEDURE [Report].[usp_EIAP_Total_Summary]\r\n\t@StartPeriod BillingPeriod,\r\n\t@SelectedPeriod BillingPeriod,\r\n\t@Email emailaddr,\r\n\t@AgencyCodeOEC VARCHAR(6)\r\nAS\r\nBEGIN\r\n\r\n\tDECLARE @FiscalYear VARCHAR(4)\r\n\tDECLARE @SavDueToAdj MONEY --Additional savings/cost due to utility bill adjustment from Sept-Dec 2011\r\n\tDECLARE @CreditForMinDemand MONEY -- Credit for minimum demand charges, if any, Jan 2012 through current month:\r\n\tDECLARE @SavDueToBudgetDeliveryCost MONEY -- Savings reduction due to reduction in budgeted delivery costs, March-June\r\n\tDECLARE @EIAPStartPeriod VARCHAR(6)\r\n\tDECLARE @EIAPCalendarEndPeriod VARCHAR(6)\r\n\r\n\tSELECT @FiscalYear = dbo.CalculateFiscalYear(@SelectedPeriod)\r\n\tSET @EIAPStartPeriod = CAST(CAST(@FiscalYear AS INT) - 1 AS VARCHAR) + '09'\r\n\tSET @EIAPCalendarEndPeriod = CAST(CAST(@FiscalYear AS INT) - 1 AS VARCHAR) + '12'\r\n\r\n\r\n\tIF(CAST(SUBSTRING(@SelectedPeriod, 5, 2) AS INT) BETWEEN 7 AND 12)\r\n\t\tSET @StartPeriod = SUBSTRING(@SelectedPeriod, 1, 4) + '07'\r\n\tELSE\r\n\t\tSET @StartPeriod = @FiscalYear + '01'\r\n\r\n\tSET @SavDueToAdj = 0\r\n\tSET @CreditForMinDemand = 0\r\n\tSET @SavDueToBudgetDeliveryCost = 0\r\n\r\n\t-- all children of selected agency\r\n\tDECLARE @AgencyDivision TABLE\r\n\t(\r\n\t\tAgencyCodeOEC VARCHAR(6),\r\n\t\tAgencyDivisionSeqID int\r\n\t)\r\n\r\n\tINSERT INTO @AgencyDivision\r\n\t(\r\n\t\tAgencyCodeOEC,\r\n\t\tAgencyDivisionSeqID\r\n\t)\r\n\tSELECT AgencyCodeOEC, AgencyDivisionSeqID FROM Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @Email) AS ad\r\n\r\n\t/*\r\n\t\tCalculate saving due to adjustment\r\n\t*/\r\n\t-- this includes amount due to account transfer\r\n\tSELECT @SavDueToAdj = SUM(SelectedPeriodData.RevisedBilledAmount - CalendarEndData.RevisedBilledAmount)\r\n\tFROM\r\n\tPublished.TemporalAccountLevelRawDataForCurrentPeriod AS SelectedPeriodData\r\n\tINNER join \r\n\tPublished.TemporalAccountLevelRawDataForCurrentPeriod AS CalendarEndData\r\n\tON CalendarEndData.AccountSeqid = SelectedPeriodData.AccountSeqid\r\n\tAND SelectedPeriodData.BillingPeriod = CalendarEndData.BillingPeriod\r\n\tINNER JOIN @AgencyDivision ad ON SelectedPeriodData.AgencyCodeOEC = ad.AgencyCodeOEC\r\n\r\n\tWHERE ( SelectedPeriodData.EffectiveStartPeriod <= @SelectedPeriod AND SelectedPeriodData.EffectiveEndPeriod > @SelectedPeriod )\r\n\tAND ( CalendarEndData.EffectiveStartPeriod <= @EIAPCalendarEndPeriod AND CalendarEndData.EffectiveEndPeriod > @EIAPCalendarEndPeriod )\r\n\tAND SelectedPeriodData.BillingPeriod BETWEEN @EIAPStartPeriod AND @EIAPCalendarEndPeriod\r\n\r\n\r\n\r\n\t/*\r\n\tCalulate credit for minimum demand\r\n\tApply this formula for both production and delivery demand\r\n\t(demand - demandWithoutMinDemand) * rate\r\n\t*/\r\n\tSELECT  @CreditForMinDemand = -1 *\r\n\t\t\tSUM\r\n\t\t\t(\r\n\t\t\t\t( ISNULL(MinimumBilledDemandUsage, 0) - ISNULL(AccountDemandUsage, 0) )\r\n\t\t\t\t* ISNULL(MinimumBilledDemandDollars / NULLIF(MinimumBilledDemandUsage, 0), 0)\r\n\t\t\t\t+ ( ISNULL(DeliveryMinimumBilledDemand, 0) - ISNULL(AccountDemandUsage, 0) )\r\n\t\t\t\t* ISNULL((DeliveryMinimumBilledAmount + ISNULL(GrossReceiptTax, 0)) / NULLIF(DeliveryMinimumBilledDemand, 0), 0) \r\n\t\t\t) \r\n\tFROM billing.AccountBillingElectric abe\r\n\t\t\tINNER JOIN Billing.Account a ON abe.OriginalAccountNumber = a.OriginalAccountNumber\r\n\t\t\tINNER JOIN @AgencyDivision ad ON a.AgencyAccount = ad.AgencyDivisionSeqid\r\n\tWHERE   \r\n\t\t\tBillingPeriodRevision <= @SelectedPeriod\r\n\t\t\tAND BillingPeriodRevision >= @StartPeriod\r\n\r\n\r\n\r\n\tSELECT ISNULL(@SavDueToAdj,0) AS SavDueToAdj, ISNULL(@CreditForMinDemand, 0) CreditForMinDemand, ISNULL(@SavDueToBudgetDeliveryCost,0) SavDueToBudgetDeliveryCost\r\n\r\n\r\n\r\nEND"
        }
      ]
    }
  ]
}