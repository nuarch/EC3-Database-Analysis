{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_CRIS_ProcessPaymentAppliedToAccountBilling",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_CRIS_ProcessPaymentAppliedToAccountBilling",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to update billing records in a SQL Server database. It processes payments applied to account billing by updating the "
        },
        {
          "type": "text",
          "text": "CreditedPaidAmount",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " and "
        },
        {
          "type": "text",
          "text": "CreditedPaidAmountDate",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " fields in the "
        },
        {
          "type": "text",
          "text": "Billing.AccountBilling",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table. The procedure ensures that payments are correctly applied to the prior month's billing period and resets payment details for the current period to zero. This procedure is part of a larger billing system, likely used by a utility company, as indicated by the schema name "
        },
        {
          "type": "text",
          "text": "CrisNationalGridWest",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": "."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this stored procedure is medium. It involves multiple SQL operations, including aggregation, joins, and subqueries. The logic is straightforward but requires a good understanding of the database schema and business rules to ensure correct execution."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is intended to identify the user executing the procedure. It is not used within the procedure, suggesting it might be logged or used for auditing purposes elsewhere."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode AS INT OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This output parameter is used to indicate the success or failure of the procedure. A value of "
                },
                {
                  "type": "text",
                  "text": "0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " indicates success, while a value of "
                },
                {
                  "type": "text",
                  "text": "9",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " would indicate failure, although the procedure currently only sets it to "
                },
                {
                  "type": "text",
                  "text": "0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Update Prior Month's Billing Records",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure aggregates payment details from the "
                        },
                        {
                          "type": "text",
                          "text": "CrisNationalGridWest.UploadPaymentDetail",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table, grouping by "
                        },
                        {
                          "type": "text",
                          "text": "AccountNumber",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It calculates the total payment amount and the latest payment date for each account."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "These aggregated payment details are then used to update the "
                        },
                        {
                          "type": "text",
                          "text": "CreditedPaidAmount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "CreditedPaidAmountDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " fields in the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountBilling",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table for records matching the previous billing period and other specified conditions."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Reset Current Period's Billing Records",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure ensures that for the current billing period, the "
                        },
                        {
                          "type": "text",
                          "text": "CreditedPaidAmount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is set to zero and "
                        },
                        {
                          "type": "text",
                          "text": "CreditedPaidAmountDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is set to null for accounts marked as current ("
                        },
                        {
                          "type": "text",
                          "text": "IsCurrentRecord = 'Y'",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ")."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It targets accounts with the latest "
                        },
                        {
                          "type": "text",
                          "text": "AccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to ensure only the most recent records are updated."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Subqueries",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses joins and subqueries, which can be resource-intensive, especially if the tables involved are large. Indexes on "
                },
                {
                  "type": "text",
                  "text": "AccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and other key columns can help optimize performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The aggregation of payment details could be a bottleneck if the "
                },
                {
                  "type": "text",
                  "text": "UploadPaymentDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is large. Ensuring this table is indexed appropriately will help improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include any explicit transaction handling, which could lead to concurrency issues if multiple instances are executed simultaneously."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Lack of Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include error handling mechanisms. If an error occurs during execution, it might not be captured, and the "
                },
                {
                  "type": "text",
                  "text": "@StatusCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " would not reflect a failure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Conditions",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded conditions, such as "
                },
                {
                  "type": "text",
                  "text": "CurrentInvoiceAccountBillingGroup = 3",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which might need to be updated if business rules change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Unused Parameter",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is not utilized within the procedure, which could lead to confusion or indicate incomplete implementation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the database grows, the performance of this procedure might degrade if not optimized with appropriate indexing and query tuning."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the "
                },
                {
                  "type": "text",
                  "text": "Billing.ApplicationTimeFrame",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table always contains a valid current processing period, which is critical for its correct operation."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Exec: [CrisNationalGridWest].[usp_CRIS_ProcessPaymentAppliedToAccountBilling]\r\n--* Parameter(s): \r\n--* StatusCode int output \t - Execution Return Status \r\n--* Return:\t0 Success\r\n--* 9 Failure\r\n--* AUTHOR: Peter Heller (PAH)\r\n--* Created On: 10/17/2006\r\n--* Date Tech Description of Change\r\n--* 11/24/2009 PAH First Version \r\n--* 05/30/2013 PAH Guarentee that Applied payment details to the current period \r\n--*\t\t\t\t\tCreditedPaidAmountDate is null and CreditedPaidAmount is zero\r\n--* 12/10/2018 VY For UniqueAccountSeqID\r\n--***************************************************************************************\r\nCREATE PROCEDURE [CrisNationalGridWest].[usp_CRIS_ProcessPaymentAppliedToAccountBilling]\r\n(\r\n\t@AuthenticatedUserID AS INT,\r\n\t@StatusCode AS INT OUTPUT\r\n)\r\nAS\r\nBegin\r\n\t--************************************************************************************** \r\n\t--\tMain Processing\r\n\t--**************************************************************************************\r\n\t--\tInsert Applied payment details to the prior months account billing row\r\n\t-- UPDATE\tzd\t2018-11-21\tI added a filter to target only latest current account when stting the AccountSeqID\r\n\t--\t\t\t\t\t\t\tThis modification will help process to choose the rigt accountSeqID\r\n\t-- UPDATE   VY  2018-12-10  For UniqueAccountSeqID\r\n\r\n\tUPDATE Billing.AccountBilling\r\n\tSET CreditedPaidAmount = payment.PaymentAmount,\r\n\t\tCreditedPaidAmountDate = payment.PaymentDate\r\n\tFROM (SELECT AccountNumber, SUM(PaymentAmount) as PaymentAmount,\r\n\t\t\tMAX(PaymentDate) as PaymentDate, COUNT(*) as NumberOfPaymentTransactions\r\n\t\tFROM CrisNationalGridWest.UploadPaymentDetail\r\n\t\tGROUP by AccountNumber) as payment\r\n\t\tINNER join Billing.AccountBilling on Payment.AccountNumber = Billing.AccountBilling.OriginalAccountNumber\r\n\tWHERE BillingPeriodRevision = (SELECT TOP 1 PreviousBillingPeriodOneMonth\r\n\t\tFROM Billing.ApplicationTimeFrame\r\n\t\tWHERE CurrentProcessingPeriod = 'Y')\r\n\t\tAND BillingPeriodRevision = BillingPeriod\r\n\t\tand CurrentInvoiceAccountBillingGroup = 3\r\n\t\tand Billing.AccountBilling.AccountBillingSeqid is not null\r\n\r\n\t--\tGuarentee that Applied payment details to the current period CreditedPaidAmountDate is null and CreditedPaidAmount is zero\r\n\t-- last end condition is added to target latest current accounts\r\n\tUPDATE Billing.AccountBilling\r\n\tSET CreditedPaidAmount = 0,\r\n\t\tCreditedPaidAmountDate = null\r\n\tFROM Billing.Account\r\n\t\tINNER join Billing.AccountBilling on /* Billing.Account.AccountSeqid = Billing.AccountBilling.AccountSeqid AND */\r\n\t\tBilling.Account.UniqueAccountSeqid = Billing.AccountBilling.UniqueAccountSeqId AND Billing.Account.IsCurrentRecord = 'Y' /* Added on 12/10/2018 */\r\n\tWHERE Billing.Account.CurrentAccountNumber = Billing.Account.OriginalAccountNumber\r\n\t\tAND Billing.Account.CurrentInvoiceAccountGroup = 3\r\n\t\tAND Billing.AccountBilling.BillingPeriod =(SELECT TOP 1 BillingPeriod\r\n\t\tFROM Billing.ApplicationTimeFrame\r\n\t\tWHERE CurrentProcessingPeriod = 'Y')\r\n\t\tAND Billing.Account.AccountSeqid IN \r\n\t\t(SELECT MAX(aa.AccountSeqid) AccountSeqid\r\n\t\t\tFROM Billing.Account AS aa \r\n\t\t\tWHERE aa.IsCurrentRecord = 'Y'\r\n\t\t\tGROUP BY aa.CurrentAccountNumber)\r\n\tSET @StatusCode = 0;\r\nEND;"
        }
      ]
    }
  ]
}