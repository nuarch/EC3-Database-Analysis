{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Lookup_FacilityInformation",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Lookup_FacilityInformation",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve information about facilities based on various filtering criteria. It logs the usage of the report, filters facilities associated with specific agencies, and returns a paginated list of facilities that match the input criteria. Additionally, it outputs the total count of facilities that meet the criteria."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including logging, filtering, and joining several tables. It uses table variables for intermediate data storage and applies dynamic filtering based on input parameters. The complexity arises from the need to handle various optional filters and the use of table variables for performance optimization."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OriginalAccountNumber acctnum = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by the original account number."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OriginalMeterNumber MeterNumber = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by the original meter number."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Agency VARCHAR(20) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by agency code or name."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OecFacilityNumber OECBuildingNumber = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by OEC facility number."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CityPlanningBIN CityPlanningBIN = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by city planning BIN."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@FacilityAddress addr = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by address."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@FacilityName FacilityName = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by name."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartIndex INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the starting index for pagination."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EndIndex INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the ending index for pagination."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BBL VARCHAR(10) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters facilities by Borough, Block, and Lot number."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Email emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Used for logging the report request."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@TotalCount INT OUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Outputs the total count of facilities that match the criteria."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieve Published Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure starts by determining the latest published billing period from the "
                },
                {
                  "type": "text",
                  "text": "Published.MonthlyPublishedSummaryData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Log Report Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It logs the usage of the report by calling the "
                },
                {
                  "type": "text",
                  "text": "Audit.usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " procedure, passing relevant details such as the report name, requested by email, and the published billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filter Agencies",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It populates a table variable "
                },
                {
                  "type": "text",
                  "text": "@SelectedAgencies",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with agencies associated with the provided email address, filtered by agency code or name."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filter Facilities",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Another table variable "
                },
                {
                  "type": "text",
                  "text": "@FilteredFacility",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is populated with facilities that match the input criteria. This involves joining the "
                },
                {
                  "type": "text",
                  "text": "billing.Account",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "billing.Facility",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "billing.Meter",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " tables, and applying filters based on account status, account number, facility number, BIN, address, facility name, meter number, and BBL."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Pagination and Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure selects facilities from "
                },
                {
                  "type": "text",
                  "text": "@FilteredFacility",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " within the specified index range and assigns the total count of matching facilities to "
                },
                {
                  "type": "text",
                  "text": "@TotalCount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Variables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of table variables ("
                },
                {
                  "type": "text",
                  "text": "@SelectedAgencies",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "@FilteredFacility",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") can be beneficial for performance, especially for smaller datasets, as they reside in memory. However, they may not be optimal for large datasets due to lack of statistics and indexing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dynamic Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "COALESCE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "ISNULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for dynamic filtering allows flexibility but can lead to suboptimal query plans if not handled carefully."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple joins and filtering conditions, which can impact performance if the underlying tables are large or not properly indexed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of table variables without indexing can lead to performance degradation with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dynamic Filtering",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "LIKE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with leading wildcards ("
                },
                {
                  "type": "text",
                  "text": "%",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") can result in full table scans, impacting performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure is executed concurrently by multiple users, it may lead to contention for memory resources due to the use of table variables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions in case of runtime errors."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n\t\t--* Description:  \r\n\t\t--*\r\n\t\t--* AUTHOR:       dho     \r\n\t\t--* Created On :  \r\n\t\t--**************************************************************************************\r\n\t\t--* Date       Tech\t\tDescription of Change\r\n\t\t--* ---------- ---\t\t-------------------------------------------------------------\r\n\t\t--* 2015-11-13  ZD\t\tAdded Report log SP block\r\n\t\t--* 2016-12-19  ZD-MB\tAdded filter for BBL\r\n\t\t--**************************************************************************************\r\n\r\nCREATE PROCEDURE [Report].[usp_Lookup_FacilityInformation]\r\n\t@OriginalAccountNumber acctnum = NULL\r\n\t, @OriginalMeterNumber MeterNumber = NULL  \r\n\t, @Agency VARCHAR(20) = NULL\r\n\t, @OecFacilityNumber OECBuildingNumber = NULL\r\n\t, @CityPlanningBIN CityPlanningBIN = NULL\r\n\t, @FacilityAddress addr = NULL\r\n\t, @FacilityName FacilityName = NULL\r\n\t, @StartIndex INT\r\n\t, @EndIndex INT\r\n\t, @BBL VARCHAR(10) = NULL\r\n\t, @Email emailaddr\r\n\t, @TotalCount INT OUT\r\n\t \r\nAS\r\nBEGIN\r\n\r\n\r\n\r\n\tDECLARE @PublishedBillingPeriod BillingPeriod\r\n\tSELECT @PublishedBillingPeriod = MAX(publishedbillingPeriod) FROM Published.MonthlyPublishedSummaryData\r\n\r\n--------------------------------------------------------------------------\r\n-- This block is added to track report log -------------------------------\r\n DECLARE @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID)\r\nEXEC [Audit].usp_AddReportUsageLog\r\n\t@ReportName\t\t\t\t\t= @spname,\r\n    @StoredProcName\t\t\t\t= @spname,\r\n    @RequestedBy\t\t\t\t= @Email, -- emailaddr\r\n    \r\n    @prmPublishedBillingPeriod\t= @PublishedBillingPeriod,\r\n    @prmBillingPeriod\t\t\t= NULL,\r\n    @prmAgency_ies\t\t\t\t= @Agency, -- varchar(max)\r\n    @prmFacilityNumber_s\t\t= NULL,\r\n    @prmStartingBillingPeriod\t= NULL,\r\n    @prmEndingBillingPeriod\t\t= NULL\r\n\r\n--------------------------------------------------------------------------\r\n\r\n\r\n\tDECLARE @SelectedAgencies TABLE\r\n\t\t(\r\n\t\t\tAgencyDivisionSeqID seqid,\r\n\t\t\tAgencyCodeOEC AgencyCodeOEC,\r\n\t\t\tAgencyName ldesc\r\n\t\t)\r\n\t\r\n\tINSERT INTO @SelectedAgencies\r\n\tSELECT DISTINCT agency.AgencyDivisionSeqID, agency.AgencyCodeOEC, agency.AgencyName\r\n\tfrom dbo.uftn_TableGetActiveAgenciesByEmailAddress(@Email) AS agency\r\n\tWHERE \r\n\tISNULL(agency.AgencyCodeOEC, '') LIKE COALESCE('%' + @Agency + '%', ISNULL(agency.AgencyCodeOEC, ''))\r\n\tOR\r\n\tISNULL(agency.AgencyName, '') LIKE COALESCE('%' + @Agency + '%', ISNULL(agency.AgencyName, ''))\r\n\r\n\t-- use table variable instead of CTE for better performance\r\n\tDECLARE @FilteredFacility TABLE\r\n\t(\r\n\t\tRowID INT IDENTITY,\r\n\t\tFacilitySeqid seqid,\r\n\t\tOecFacilityNumber OECBuildingNumber,\r\n\t\tAgencyDivisionSeqID seqid,\r\n\t\tAgencyName ldesc,\r\n\t\tAgencyCodeOEC AgencyCodeOEC,\r\n\t\tCityPlanningBIN CityPlanningBIN,\r\n\t\tFacilityAddress LongAddress,\r\n\t\tFacilityName VARCHAR(100)\r\n\t)\r\n\r\n\tINSERT INTO @FilteredFacility\r\n\t\t\t( \r\n\t\t\t  FacilitySeqid ,\r\n\t\t\t  OecFacilityNumber ,\r\n\t\t\t  AgencyDivisionSeqID ,\r\n\t\t\t  AgencyName ,\r\n\t\t\t  AgencyCodeOEC ,\r\n\t\t\t  CityPlanningBIN ,\r\n\t\t\t  FacilityAddress ,\r\n\t\t\t  FacilityName\r\n\t\t\t)\r\n  \t\tSELECT DISTINCT\r\n\t\t\t\t\t\tfacility.FacilitySeqid,\r\n\t\t\t\t\t\tfacility.OecFacilityNumber,\r\n\t\t\t\t\t\tagency.AgencyDivisionSeqID,\r\n\t\t\t\t\t\tagency.AgencyName,\r\n\t\t\t\t\t\tagency.AgencyCodeOEC,\r\n\t\t\t\t\t\tfacility.CityPlanningBIN,\r\n\t\t\t\t\t\tfacility.Address1 AS FacilityAddress,\r\n\t\t\t\t\t\tfacility.FacilityName\r\n\t\t\t\tFROM @SelectedAgencies AS agency\r\n\t\t\t\t\t\tINNER JOIN billing.Account AS account \r\n\t\t\t\t\t\t\tON account.AgencyAccount = agency.AgencyDivisionSeqid\r\n\t\t\t\t\t\tINNER JOIN billing.Facility AS facility \r\n\t\t\t\t\t\t\tON account.FacilityAccount = facility.FacilitySeqid\r\n\t\t\t\t\t\tLEFT JOIN Billing.AccountExchangeMeterTrack am\r\n\t\t\t\t\t\t\tON account.AccountSeqid = am.OriginalAccountSeqid\r\n\t\t\t\t\t\tLEFT JOIN billing.Meter AS m\r\n\t\t\t\t\t\t\t ON am.OriginalMeterSeqid = m.MeterSeqid\r\n\t\t\t\tWHERE \r\n\t\t\t\t\taccount.AccountStatus IN ('AC', '46', 'UA')\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tISNULL(account.OriginalAccountNumber, '') LIKE COALESCE('%' + @OriginalAccountNumber + '%', ISNULL(account.OriginalAccountNumber, ''))\r\n\t\t\t\t\tAND \r\n\t\t\t\t\tISNULL(facility.OecFacilityNumber, '') LIKE COALESCE('%' + @OecFacilityNumber + '%', ISNULL(facility.OecFacilityNumber, ''))\r\n\t\t\t\t\tAND \r\n\t\t\t\t\tISNULL(facility.CityPlanningBIN, '') LIKE COALESCE('%' + @CityPlanningBIN + '%', ISNULL(facility.CityPlanningBIN, ''))\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tISNULL(facility.Address1, '') LIKE COALESCE('%' + @FacilityAddress + '%', ISNULL(facility.Address1, ''))\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tISNULL(facility.FacilityName, '') LIKE COALESCE('%' + @FacilityName + '%', ISNULL(facility.FacilityName, ''))\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tISNULL(m.OriginalMeterNumber, '') LIKE COALESCE('%' + @OriginalMeterNumber + '%', ISNULL(m.OriginalMeterNumber, ''))\r\n\t\t\t\t\tAND\r\n\t\t\t\t\tISNULL(facility.Borough, '') + ISNULL(facility.Block, '') + ISNULL(facility.LotNumber, '') LIKE COALESCE('%' + @BBL + '%', ISNULL(facility.Borough, '') + ISNULL(facility.Block, '') + ISNULL(facility.LotNumber, ''))\r\n\t\t\t\t\t\t\r\n\t\r\n\tSELECT *  FROM @FilteredFacility\r\n\tWHERE RowID BETWEEN @StartIndex AND @EndIndex\r\n\r\n\r\n\tSELECT @TotalCount = COALESCE(count(RowID),0) FROM @FilteredFacility\r\n\t\r\n\r\nEND"
        }
      ]
    }
  ]
}