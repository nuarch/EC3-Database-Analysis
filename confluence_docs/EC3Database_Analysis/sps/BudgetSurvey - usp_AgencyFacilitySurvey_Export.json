{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "BudgetSurvey",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_AgencyFacilitySurvey_Export",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_AgencyFacilitySurvey_Export",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to export data related to agency facility surveys. It retrieves information about facilities, including their energy usage and other attributes, for a specific agency identified by an email address. The procedure aggregates energy usage data over a specified billing period and returns a comprehensive dataset that includes both facility details and energy consumption metrics."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple table joins, including both inner and left joins."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses subqueries and aggregate functions to compute energy usage metrics."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It handles dynamic date calculations for billing periods."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It incorporates a user-defined function to filter data based on agency hierarchy."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is used to filter the data based on the agency associated with the provided email address. It is crucial for determining which agency's data should be exported."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", allowing it to read uncommitted changes from other transactions. This can improve performance by reducing locking but may lead to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure calculates the start and end billing periods based on the maximum fiscal year available in the "
                },
                {
                  "type": "text",
                  "text": "Published.AccountLevelSummaryByFacility",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table. It sets:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "@StartPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to two fiscal years prior, starting in November."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "@EndPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to one fiscal year prior, ending in October."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "@PublishedBillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to the most recent published billing period."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The main query retrieves facility and survey data:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Joins multiple tables to gather comprehensive facility information, including agency details, facility names, addresses, and energy usage."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses a subquery to calculate aggregated energy usage metrics (annual kWh, therms, and steam usage) for each facility."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Filters data based on the agency hierarchy using a user-defined function "
                        },
                        {
                          "type": "text",
                          "text": "uftn_TableGetAgencyChildrenByAgencyCodeOEC",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure outputs a dataset containing detailed information about each facility, including energy usage metrics and other attributes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking overhead but may result in reading uncommitted or inconsistent data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Aggregations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple joins and aggregations, which can be resource-intensive, especially if the tables involved are large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexes",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensuring that the joined columns and those used in WHERE clauses are indexed can significantly improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of the user-defined function "
                },
                {
                  "type": "text",
                  "text": "uftn_TableGetAgencyChildrenByAgencyCodeOEC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " may impact performance depending on its complexity and execution cost."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to dirty reads, where the data read might not be consistent or committed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the underlying data changes during execution, the results might not accurately reflect the current state of the database."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the complexity of joins and aggregations may lead to performance degradation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Dependency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure relies on a user-defined function for filtering, which could be a performance bottleneck or a point of failure if not properly maintained."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [BudgetSurvey].[usp_AgencyFacilitySurvey_Export]\n(\r\n\t@EmailAddress AS emailaddr\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\t\r\n\tDECLARE @PublishedBillingPeriod AS BillingPeriod, @StartPeriod AS BillingPeriod, @EndPeriod AS BillingPeriod;\r\n\r\n\tSELECT @StartPeriod = CAST(CAST(MAX(FiscalYear) AS INT) - 2 AS VARCHAR(5)) + '11'\r\n\t\t,@EndPeriod = CAST(CAST(MAX(FiscalYear) AS INT) - 1 AS VARCHAR(5)) + '10'\r\n\t\t,@PublishedBillingPeriod = MAX(PublishedBillingPeriod)\r\n\tFROM Published.AccountLevelSummaryByFacility;\r\n\t\r\n\tSELECT L.OECFacilityID\r\n\t\t,L.AgencyName\r\n\t\t,L.FacilityName\r\n\t\t,L.FacilityAddress\r\n\t\t,L.Borough\r\n\t\t,L.EffectiveDate AS ActionEffectiveDate\r\n\t\t,L.ActionSeqID\t\t\t\t\r\n\t\t,L.ActionDescription\r\n\t\t,L.NumberOfFacilitiesImpacted\r\n\t\t,L.ElecUsage\r\n\t\t,L.ElecDemand\r\n\t\t,L.MonthlyPeakDemand\r\n\t\t,L.GasUsage\r\n\t\t,L.SteamUsage\r\n\t\t,L.NameOfOMBTaskForce\r\n\t\t,L.InitiativeID\r\n\t\t,L.FinancialPlanInitiativeApproved\r\n\t\t,L.ApprovedAmount\r\n\t\t,L.BriefDescription\r\n\t\t,R.AnnualkWh\r\n        ,R.MonthlyPeakDemandkW\r\n        ,R.AnnualTherms\r\n        ,R.AnnualMlbs\r\n\t\t,L.CreatedOn\r\n\t\t,L.ModifiedOn\r\n\tFROM (SELECT AFS.AgencyFacilitySurveyId\r\n\t\t\t,F.OecFacilityNumber AS OECFacilityID\r\n\t\t\t,AD.AgencyCodeOEC + ' - ' + AD.AgencyName + ' (' + AD.AgencyShortDesc + ')' AS AgencyName\r\n\t\t\t,CASE WHEN AFS.FacilitySeqId IS NULL THEN AFS.FacilityName ELSE F.OecFacilityNumber + ' - ' + F.FacilityName + ' (' + F.Address1 + ')' END AS FacilityName\r\n\t\t\t,ISNULL(AFS.FacilityAddress, F.Address1) AS FacilityAddress\r\n\t\t\t,ISNULL(B.[Name], F.Borough) AS Borough\r\n\t\t\t,CONVERT(VARCHAR(10),ISNULL(AFS.ActionEffectiveDate, GETDATE()), 101) AS EffectiveDate\r\n\t\t\t,AFS.ActionTypeId AS ActionSeqID\t\t\t\t\r\n\t\t\t,ACT.[Description] AS ActionDescription\r\n\t\t\t,AFS.NumberOfFacilitiesImpacted\r\n\t\t\t,AFS.ElecUsage\r\n\t\t\t,AFS.ElecDemand\r\n\t\t\t,AFS.PeakMonthElecDemand AS MonthlyPeakDemand\r\n\t\t\t,AFS.GasUsage\r\n\t\t\t,AFS.SteamUsage\r\n\t\t\t,AFS.NameOfOMBTaskForce\r\n\t\t\t,AFS.InitiativeId AS InitiativeID\r\n\t\t\t,AFS.FinancialPlanInitiativeApproved\r\n\t\t\t,AFS.ApprovedAmount\r\n\t\t\t,AFS.BriefDescription\r\n\t\t\t,CONVERT(VARCHAR(10),ISNULL(AFS.CreatedOn, GETDATE()), 101) AS CreatedOn\r\n\t\t\t,CONVERT(VARCHAR(10),ISNULL(AFS.ModifiedOn, GETDATE()), 101) AS ModifiedOn\r\n\t\tFROM BudgetSurvey.AgencyFacilitySurvey AS AFS\r\n\t\t\tINNER JOIN BudgetSurvey.AgencyBudgetFacilitySurveyAttribute AS A ON A.FiscalYear = AFS.FiscalYear\r\n\t\t\tINNER JOIN BudgetSurvey.ActionType AS ACT ON ACT.ActionTypeId = AFS.ActionTypeId\r\n\t\t\tINNER JOIN Billing.AgencyDivision AS AD ON AD.AgencyDivisionSeqid = AFS.AgencyDivisionSeqId\r\n\t\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC('*', @EmailAddress) AS ADF ON ADF.AgencyDivisionSeqid = AD.AgencyDivisionSeqid\r\n\t\t\tLEFT JOIN Billing.Facility AS F ON F.FacilitySeqid = AFS.FacilitySeqId\r\n\t\t\tLEFT JOIN [Lookup].Borough AS B ON B.Id = ISNULL(AFS.BoroughId, F.Borough)) AS L\r\n\t\tLEFT JOIN (SELECT AFS.AgencyFacilitySurveyId\r\n\t\t\t,SUM(CASE WHEN AF.EnergyType = 'ELE' THEN ISNULL(AF.EnergyUsage, 0) ELSE 0 END) AS AnnualkWh\r\n\t\t\t,MAX(CASE WHEN AF.EnergyType = 'ELE' THEN ISNULL(AF.DemandUsage, 0) ELSE 0 END) AS MonthlyPeakDemandkW\r\n\t\t\t,SUM(CASE WHEN AF.EnergyType = 'GAS' THEN ISNULL(AF.EnergyUsage, 0) ELSE 0 END) AS AnnualTherms\r\n\t\t\t,SUM(CASE WHEN AF.EnergyType = 'STM' THEN ISNULL(AF.EnergyUsage, 0) ELSE 0 END) AS AnnualMLbs\r\n\t\tFROM BudgetSurvey.AgencyFacilitySurvey AS AFS\r\n\t\t\tINNER JOIN BudgetSurvey.AgencyBudgetFacilitySurveyAttribute AS A ON A.FiscalYear = AFS.FiscalYear\r\n\t\t\tINNER JOIN Billing.Facility AS F ON F.FacilitySeqid = AFS.FacilitySeqId\r\n\t\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC('*', @EmailAddress) AS AD ON AD.AgencyDivisionSeqid = AFS.AgencyDivisionSeqId\r\n\t\t\tLEFT JOIN Published.AccountLevelSummaryByFacility AS AF ON F.OecFacilityNumber = AF.OecFacilityNumber \r\n\t\t\t\tAND AF.PublishedBillingPeriod = @PublishedBillingPeriod\r\n\t\t\t\tAND AF.BillingPeriod BETWEEN @StartPeriod AND @EndPeriod\r\n\t\tWHERE AFS.ActionTypeId = 3\r\n\t\tGROUP BY AFS.AgencyFacilitySurveyId) AS R ON L.AgencyFacilitySurveyId = R.AgencyFacilitySurveyId;\r\nEND;"
        }
      ]
    }
  ]
}