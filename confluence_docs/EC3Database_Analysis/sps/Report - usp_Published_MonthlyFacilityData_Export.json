{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_MonthlyFacilityData_Export",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_MonthlyFacilityData_Export",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to export monthly facility data related to energy usage and costs for a specified billing period. It logs the report usage, retrieves data from a specific table, performs calculations to convert energy usage into BTUs, and outputs the data based on the specified type of report (e.g., BTU, Electricity Usage, Gas Cost). The procedure supports various energy types and formats the output accordingly."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including logging, data retrieval, conditional logic for different report types, and calculations for energy conversion. The complexity arises from the conditional logic and the need to handle different energy types and report formats."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. Used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the data is being requested. It filters the data to the relevant period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The agency code used to filter the data to specific agencies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Type AS VARCHAR(50)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the type of report to generate (e.g., BTU, Electricity Usage, Gas Cost)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure starts by logging the report usage using the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " stored procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It retrieves data from the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, joining with agency and facility tables to filter based on the provided agency code and billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Energy Conversion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates energy usage in BTUs for each month and year-to-date, using multipliers specific to the energy type (Electricity, Gas, Steam)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conditional Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Based on the "
                },
                {
                  "type": "text",
                  "text": "@Type",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter, it selects and formats the output data accordingly:"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "BTU: Outputs energy usage in BTUs."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Electricity Usage (kWh): Outputs electricity usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Electricity Demand (kW): Outputs electricity demand."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Gas (Therms): Outputs gas usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Steam (MLbs): Outputs steam usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Electricity, Gas, Steam Cost ($): Outputs costs for each energy type."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Total Cost ($): Outputs total costs across all energy types."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which can improve performance by allowing dirty reads but leads to inconsistent data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Variable",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a table variable ("
                },
                {
                  "type": "text",
                  "text": "@tbl",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") can be efficient for small to medium datasets but not perform well with large datasets due to lack of indexing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Conditional Logic",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The multiple "
                },
                {
                  "type": "text",
                  "text": "IF",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statements be optimized by using a more dynamic approach, such as dynamic SQL, to reduce repetitive code and improve maintainability."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Consistency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to reading uncommitted changes, resulting in potential data inconsistencies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a table variable without indexes may not scale well with large datasets, potentially leading to performance bottlenecks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and failures."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include any input validation or sanitization, which could expose it to SQL injection if the inputs are not properly handled elsewhere in the application."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_MonthlyFacilityData_Export]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@PublishedBillingPeriod AS VARCHAR(6)\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX)\r\n\t,@Type AS VARCHAR(50)\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t@ReportName\t\t\t\t\t= @spname,\r\n    @StoredProcName\t\t\t\t= @spname,\r\n    @RequestedBy\t\t\t\t= @EmailAddress,    \r\n    @prmPublishedBillingPeriod\t= @PublishedBillingPeriod,\r\n    @prmBillingPeriod\t\t\t= NULL,\r\n    @prmAgency_ies\t\t\t\t= @AgencyCodeOEC,\r\n    @prmFacilityNumber_s\t\t= NULL,\r\n    @prmStartingBillingPeriod\t= NULL,\r\n    @prmEndingBillingPeriod\t\t= NULL\r\n\r\n\tDECLARE @CHWMultiplier AS FLOAT = 0.0223436, @ELEMultiplier AS FLOAT = 0.00341297, @STMMultiplier AS FLOAT = 1.11718000, @GASMultiplier AS FLOAT = 0.1;\r\n\r\n\tDECLARE @tbl TABLE\r\n\t\t(FacilityName VARCHAR(200),   \r\n\t\tPublishedBillingPeriod VARCHAR(6),\r\n\t\tAgencyCodeOEC VARCHAR(10),\r\n\t\tFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsageSeqid VARCHAR(10),\r\n\t\tBillToAgencyCode VARCHAR(10), \r\n\t\tAgencyName VARCHAR(200), \r\n\t\tOecFacilityNumber VARCHAR(10), \r\n\t\tAddress1 VARCHAR(200), \r\n\t\tFiscalYear VARCHAR(4), \r\n\t\tUtilityCompany VARCHAR(200), \r\n\t\tEnergyType VARCHAR(25), \r\n\t\tJulyRevisedBilledDollars MONEY, \r\n\t\tAugustRevisedBilledDollars MONEY, \r\n\t\tSeptemberRevisedBilledDollars MONEY, \r\n\t\tOctoberRevisedBilledDollars MONEY, \r\n\t\tNovemberRevisedBilledDollars MONEY, \r\n\t\tDecemberRevisedBilledDollars MONEY, \r\n\t\tJanuaryRevisedBilledDollars MONEY, \r\n\t\tFebruaryRevisedBilledDollars MONEY, \r\n\t\tMarchRevisedBilledDollars MONEY, \r\n\t\tAprilRevisedBilledDollars MONEY, \r\n\t\tMayRevisedBilledDollars MONEY, \r\n\t\tJuneRevisedBilledDollars MONEY, \r\n\t\tFiscalYearToDateRevisedBilledDollars MONEY,\r\n      \tJulyRevisedEnergy INT,\r\n\t\tAugustRevisedEnergy INT, \r\n\t\tSeptemberRevisedEnergy INT, \r\n\t\tOctoberRevisedEnergy INT, \r\n\t\tNovemberRevisedEnergy INT, \r\n\t\tDecemberRevisedEnergy INT, \r\n\t\tJanuaryRevisedEnergy INT, \r\n\t\tFebruaryRevisedEnergy INT, \r\n\t\tMarchRevisedEnergy INT, \r\n\t\tAprilRevisedEnergy INT, \r\n\t\tMayRevisedEnergy INT, \r\n\t\tJuneRevisedEnergy INT, \r\n\t\tFiscalYearToDateRevisedEnergy INT, \r\n\t\tJulyRevisedDemand NUMERIC(38,2), \r\n\t\tAugustRevisedDemand NUMERIC(38,2), \r\n\t\tSeptemberRevisedDemand NUMERIC(38,2), \r\n\t\tOctoberRevisedDemand NUMERIC(38,2), \r\n\t\tNovemberRevisedDemand NUMERIC(38,2), \r\n\t\tDecemberRevisedDemand NUMERIC(38,2), \r\n\t\tJanuaryRevisedDemand NUMERIC(38,2), \r\n\t\tFebruaryRevisedDemand NUMERIC(38,2), \r\n\t\tMarchRevisedDemand NUMERIC(38,2), \r\n\t\tAprilRevisedDemand NUMERIC(38,2), \r\n\t\tMayRevisedDemand NUMERIC(38,2), \r\n\t\tJuneRevisedDemand NUMERIC(38,2), \r\n\t\tFiscalYearToDateRevisedDemand NUMERIC(38,2), \r\n\t\tLastUpdate DATETIME,\r\n\t\tJulyRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tAugustRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tSeptemberRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tOctoberRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tNovemberRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tDecemberRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tJanuaryRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tFebruaryRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tMarchRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tAprilRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tMayRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tJuneRevisedEnergyBTU NUMERIC(38,2),\r\n\t\tFiscalYearToDateRevisedEnergyBTU NUMERIC(38,2));\r\n\r\n        INSERT INTO @tbl\r\n\t\tSELECT FA.FacilityName,   \r\n\t\t\t@PublishedBillingPeriod AS PublishedBillingPeriod, \r\n\t\t\tFA.AgencyCodeOEC, \r\n\t\t\tFA.Seqid AS FiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsageSeqid, \r\n\t\t\tFA.BillToAgencyCode, \r\n\t\t\tFA.AgencyName, \r\n\t\t\tFA.OecFacilityNumber, \r\n\t\t\tFA.Address1 + CASE WHEN F.FacilityName <> 'Unassigned' THEN ' [' + F.FacilityName + ']' ELSE '' END AS Address1, \r\n\t\t\tFA.FiscalYear, \r\n\t\t\tFA.UtilityCompany, \r\n\t\t\tFA.EnergyType, \r\n\t\t\tFA.JulyRevisedBilledDollars, \r\n\t\t\tFA.AugustRevisedBilledDollars, \r\n\t\t\tFA.SeptemberRevisedBilledDollars, \r\n\t\t\tFA.OctoberRevisedBilledDollars, \r\n\t\t\tFA.NovemberRevisedBilledDollars, \r\n\t\t\tFA.DecemberRevisedBilledDollars, \r\n\t\t\tFA.JanuaryRevisedBilledDollars, \r\n\t\t\tFA.FebruaryRevisedBilledDollars, \r\n\t\t\tFA.MarchRevisedBilledDollars, \r\n\t\t\tFA.AprilRevisedBilledDollars, \r\n\t\t\tFA.MayRevisedBilledDollars, \r\n\t\t\tFA.JuneRevisedBilledDollars, \r\n\t\t\tFA.FiscalYearToDateRevisedBilledDollars, \r\n\t\t\tFA.JulyRevisedEnergy, \r\n\t\t\tFA.AugustRevisedEnergy, \r\n\t\t\tFA.SeptemberRevisedEnergy, \r\n\t\t\tFA.OctoberRevisedEnergy, \r\n\t\t\tFA.NovemberRevisedEnergy, \r\n\t\t\tFA.DecemberRevisedEnergy, \r\n\t\t\tFA.JanuaryRevisedEnergy, \r\n\t\t\tFA.FebruaryRevisedEnergy, \r\n\t\t\tFA.MarchRevisedEnergy, \r\n\t\t\tFA.AprilRevisedEnergy, \r\n\t\t\tFA.MayRevisedEnergy, \r\n\t\t\tFA.JuneRevisedEnergy, \r\n\t\t\tFA.FiscalYearToDateRevisedEnergy, \r\n\t\t\tFA.JulyRevisedDemand, \r\n\t\t\tFA.AugustRevisedDemand, \r\n\t\t\tFA.SeptemberRevisedDemand, \r\n\t\t\tFA.OctoberRevisedDemand, \r\n\t\t\tFA.NovemberRevisedDemand, \r\n\t\t\tFA.DecemberRevisedDemand, \r\n\t\t\tFA.JanuaryRevisedDemand, \r\n\t\t\tFA.FebruaryRevisedDemand, \r\n\t\t\tFA.MarchRevisedDemand, \r\n\t\t\tFA.AprilRevisedDemand, \r\n\t\t\tFA.MayRevisedDemand, \r\n\t\t\tFA.JuneRevisedDemand, \r\n\t\t\tFA.FiscalYearToDateRevisedDemand, \r\n\t\t\tFA.LastUpdate,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.JulyRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.JulyRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.JulyRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS JulyRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.AugustRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.AugustRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.AugustRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS AugustRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.SeptemberRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.SeptemberRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.SeptemberRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS SeptemberRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.OctoberRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.OctoberRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.OctoberRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS OctoberRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.NovemberRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.NovemberRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.NovemberRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS NovemberRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.DecemberRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.DecemberRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.DecemberRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS DecemberRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.JanuaryRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.JanuaryRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.JanuaryRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS JanuaryRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.FebruaryRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.FebruaryRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.FebruaryRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS FebruaryRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.MarchRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.MarchRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.MarchRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS MarchRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.AprilRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.AprilRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.AprilRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS AprilRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.MayRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.MayRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.MayRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS MayRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.JuneRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.JuneRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.JuneRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS JuneRevisedEnergyBTU,\r\n\t\t\tCASE \r\n\t\t\t\tWHEN FA.EnergyType = 'ELE' THEN FA.FiscalYearToDateRevisedEnergy * @ELEMultiplier \r\n\t\t\t\tWHEN FA.EnergyType = 'GAS' THEN FA.FiscalYearToDateRevisedEnergy * @GASMultiplier\r\n\t\t\t\tWHEN FA.EnergyType = 'STM' THEN FA.FiscalYearToDateRevisedEnergy * @STMMultiplier\r\n\t\t\tEND AS FiscalYearToDateRevisedEnergyBTU\r\n\t\tFROM Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage AS FA \r\n\t\t\tINNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC,@EmailAddress) AS A ON FA.AgencyCodeOEC = A.AgencyCodeOEC\r\n\t\t\tLEFT JOIN Billing.Facility AS F ON FA.OecFacilityNumber = F.OecFacilityNumber\t\t\t\t\r\n\t\tWHERE FA.EffectiveStartPeriod <= @PublishedBillingPeriod AND FA.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tORDER BY FA.AgencyCodeOEC DESC,FA.OecFacilityNumber,FA.FiscalYear DESC;\r\n\r\n\t\tIF @Type = 'BTU'\r\n\t\tBEGIN\r\n\t\t  select OecFacilityNumber,Address1,FiscalYear,@Type AS EnergyType,AgencyCodeOEC,AgencyName,\r\n\t\t\tSUM(JulyRevisedEnergyBTU) AS July,\r\n\t\t\tSUM(AugustRevisedEnergyBTU) AS August,\r\n\t\t\tSUM(SeptemberRevisedEnergyBTU) AS September,\r\n\t\t\tSUM(OctoberRevisedEnergyBTU) AS October,\r\n\t\t\tSUM(NovemberRevisedEnergyBTU) AS November,\r\n\t\t\tSUM(DecemberRevisedEnergyBTU) AS December,\r\n\t\t\tSUM(JanuaryRevisedEnergyBTU) AS January,\r\n\t\t\tSUM(FebruaryRevisedEnergyBTU) AS February,\r\n\t\t\tSUM(MarchRevisedEnergyBTU) AS March,\r\n\t\t\tSUM(AprilRevisedEnergyBTU) AS April,\r\n\t\t\tSUM(MayRevisedEnergyBTU) AS May,\r\n\t\t\tSUM(JuneRevisedEnergyBTU) AS June,\r\n\t\t\tSUM(FiscalYearToDateRevisedEnergyBTU) AS YearToDate\t\t\t\r\n\t\t  from @tbl\r\n\t\t  group by OecFacilityNumber,FiscalYear,AgencyCodeOEC,Address1,FiscalYear,AgencyName\r\n\t\t  order by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber\r\n\t\tEND;\r\n\t\tIF @Type = 'Electricity Usage (kWh)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber, Address1, FiscalYear, @Type AS EnergyType, AgencyCodeOEC, AgencyName,\r\n\t\t\t\tFiscalYearToDateRevisedEnergy AS YearToDate,\r\n\t\t\t\tJulyRevisedEnergy AS July,\r\n\t\t\t\tAugustRevisedEnergy AS August,\r\n\t\t\t\tSeptemberRevisedEnergy AS September,\r\n\t\t\t\tOctoberRevisedEnergy AS October,\r\n\t\t\t\tNovemberRevisedEnergy AS November,\r\n\t\t\t\tDecemberRevisedEnergy AS December,\r\n\t\t\t\tJanuaryRevisedEnergy AS January,\r\n\t\t\t\tFebruaryRevisedEnergy AS February,\r\n\t\t\t\tMarchRevisedEnergy AS March,\r\n\t\t\t\tAprilRevisedEnergy AS April,\r\n\t\t\t\tMayRevisedEnergy AS May,\r\n\t\t\t\tJuneRevisedEnergy AS June\r\n\t\t\tFROM @tbl\r\n\t\t\tWHERE EnergyType = 'ELE'\r\n\t\t\torder by AgencyCodeOEC DESC, FiscalYear DESC, OecFacilityNumber\r\n\t\tEND;\r\n\t\tIF @Type = 'Electricity Demand (kW)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber, Address1, FiscalYear, @Type AS EnergyType, AgencyCodeOEC, AgencyName,\r\n\t\t\t\tFiscalYearToDateRevisedDemand AS YearToDate,\r\n\t\t\t\tJulyRevisedDemand AS July,\r\n\t\t\t\tAugustRevisedDemand AS August,\r\n\t\t\t\tSeptemberRevisedDemand AS September,\r\n\t\t\t\tOctoberRevisedDemand AS October,\r\n\t\t\t\tNovemberRevisedDemand AS November,\r\n\t\t\t\tDecemberRevisedDemand AS December,\r\n\t\t\t\tJanuaryRevisedDemand AS January,\r\n\t\t\t\tFebruaryRevisedDemand AS February,\r\n\t\t\t\tMarchRevisedDemand AS March,\r\n\t\t\t\tAprilRevisedDemand AS April,\r\n\t\t\t\tMayRevisedDemand AS May,\r\n\t\t\t\tJuneRevisedDemand AS June\r\n\t\t\tfrom @tbl where EnergyType = 'ELE' \r\n\t\t\torder by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber\r\n\t\tEND;\r\n\t\tIF @Type = 'Gas (Therms)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber,Address1,FiscalYear,@Type AS EnergyType,AgencyCodeOEC,AgencyName,\r\n\t\t\t\tFiscalYearToDateRevisedEnergy AS YearToDate,\r\n\t\t\t\tJulyRevisedEnergy AS July,\r\n\t\t\t\tAugustRevisedEnergy AS August,\r\n\t\t\t\tSeptemberRevisedEnergy AS September,\r\n\t\t\t\tOctoberRevisedEnergy AS October,\r\n\t\t\t\tNovemberRevisedEnergy AS November,\r\n\t\t\t\tDecemberRevisedEnergy AS December,\r\n\t\t\t\tJanuaryRevisedEnergy AS January,\r\n\t\t\t\tFebruaryRevisedEnergy AS February,\r\n\t\t\t\tMarchRevisedEnergy AS March,\r\n\t\t\t\tAprilRevisedEnergy AS April,\r\n\t\t\t\tMayRevisedEnergy AS May,\r\n\t\t\t\tJuneRevisedEnergy AS June\t\t\t\t\r\n\t\t\tfrom @tbl where EnergyType = 'GAS'\r\n\t\t\torder by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber\r\n\t\tEND\r\n\t\tIF @Type = 'Steam (MLbs)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber,Address1,FiscalYear,@Type AS EnergyType,AgencyCodeOEC,AgencyName,\r\n\t\t\t\tFiscalYearToDateRevisedEnergy AS YearToDate,\r\n\t\t\t\tJulyRevisedEnergy AS July,\r\n\t\t\t\tAugustRevisedEnergy AS August,\r\n\t\t\t\tSeptemberRevisedEnergy AS September,\r\n\t\t\t\tOctoberRevisedEnergy AS October,\r\n\t\t\t\tNovemberRevisedEnergy AS November,\r\n\t\t\t\tDecemberRevisedEnergy AS December,\r\n\t\t\t\tJanuaryRevisedEnergy AS January,\r\n\t\t\t\tFebruaryRevisedEnergy AS February,\r\n\t\t\t\tMarchRevisedEnergy AS March,\r\n\t\t\t\tAprilRevisedEnergy AS April,\r\n\t\t\t\tMayRevisedEnergy AS May,\r\n\t\t\t\tJuneRevisedEnergy AS June\t\t\t\t\r\n\t\t\tfrom @tbl where EnergyType = 'STM'\r\n\t\t\torder by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber\r\n\t\tEND\r\n\t\tIF @Type = 'Electricity Cost ($)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber,Address1,FiscalYear,@Type AS EnergyType,AgencyCodeOEC,AgencyName,\r\n\t\t\t\tFiscalYearToDateRevisedBilledDollars AS YearToDate,\r\n\t\t\t\tJulyRevisedBilledDollars AS July,\r\n\t\t\t\tAugustRevisedBilledDollars AS August,\r\n\t\t\t\tSeptemberRevisedBilledDollars AS September,\r\n\t\t\t\tOctoberRevisedBilledDollars AS October,\r\n\t\t\t\tNovemberRevisedBilledDollars AS November,\r\n\t\t\t\tDecemberRevisedBilledDollars AS December,\r\n\t\t\t\tJanuaryRevisedBilledDollars AS January,\r\n\t\t\t\tFebruaryRevisedBilledDollars AS February,\r\n\t\t\t\tMarchRevisedBilledDollars AS March,\r\n\t\t\t\tAprilRevisedBilledDollars AS April,\r\n\t\t\t\tMayRevisedBilledDollars AS May,\r\n\t\t\t\tJuneRevisedBilledDollars AS June\t\t\t\t\r\n\t\t\tfrom @tbl where EnergyType = 'ELE'\r\n\t\t\torder by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber\r\n\t\tEND\r\n\t\tIF @Type = 'Gas Cost ($)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber,Address1,FiscalYear,@Type AS EnergyType,AgencyCodeOEC,AgencyName,\r\n\t\t\t\tFiscalYearToDateRevisedBilledDollars AS YearToDate,\r\n\t\t\t\tJulyRevisedBilledDollars AS July,\r\n\t\t\t\tAugustRevisedBilledDollars AS August,\r\n\t\t\t\tSeptemberRevisedBilledDollars AS September,\r\n\t\t\t\tOctoberRevisedBilledDollars AS October,\r\n\t\t\t\tNovemberRevisedBilledDollars AS November,\r\n\t\t\t\tDecemberRevisedBilledDollars AS December,\r\n\t\t\t\tJanuaryRevisedBilledDollars AS January,\r\n\t\t\t\tFebruaryRevisedBilledDollars AS February,\r\n\t\t\t\tMarchRevisedBilledDollars AS March,\r\n\t\t\t\tAprilRevisedBilledDollars AS April,\r\n\t\t\t\tMayRevisedBilledDollars AS May,\r\n\t\t\t\tJuneRevisedBilledDollars AS June\t\t\t\t\r\n\t\t\tfrom @tbl where EnergyType = 'GAS'\r\n\t\t\torder by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber\r\n\t\tEND\r\n\t\tIF @Type = 'Steam Cost ($)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber,Address1,FiscalYear,@Type AS EnergyType,AgencyCodeOEC,AgencyName,\r\n\t\t\t\tFiscalYearToDateRevisedBilledDollars AS YearToDate,\r\n\t\t\t\tJulyRevisedBilledDollars AS July,\r\n\t\t\t\tAugustRevisedBilledDollars AS August,\r\n\t\t\t\tSeptemberRevisedBilledDollars AS September,\r\n\t\t\t\tOctoberRevisedBilledDollars AS October,\r\n\t\t\t\tNovemberRevisedBilledDollars AS November,\r\n\t\t\t\tDecemberRevisedBilledDollars AS December,\r\n\t\t\t\tJanuaryRevisedBilledDollars AS January,\r\n\t\t\t\tFebruaryRevisedBilledDollars AS February,\r\n\t\t\t\tMarchRevisedBilledDollars AS March,\r\n\t\t\t\tAprilRevisedBilledDollars AS April,\r\n\t\t\t\tMayRevisedBilledDollars AS May,\r\n\t\t\t\tJuneRevisedBilledDollars AS June\t\t\t\t\r\n\t\t\tfrom @tbl where EnergyType = 'STM'\r\n\t\t\torder by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber\r\n\t\tEND\r\n\t\tIF @Type = 'Total Cost ($)'\r\n\t\tBEGIN\r\n\t\t\tSelect OecFacilityNumber,Address1,FiscalYear,@Type AS EnergyType,AgencyCodeOEC,AGencyName,\r\n\t\t\t\tSUM(FiscalYearToDateRevisedBilledDollars) AS YearToDate,\r\n\t\t\t\tSUM(JulyRevisedBilledDollars) AS July,\r\n\t\t\t\tSUM(AugustRevisedBilledDollars) AS August,\r\n\t\t\t\tSUM(SeptemberRevisedBilledDollars) AS September,\r\n\t\t\t\tSUM(OctoberRevisedBilledDollars) AS October,\r\n\t\t\t\tSUM(NovemberRevisedBilledDollars) AS November,\r\n\t\t\t\tSUM(DecemberRevisedBilledDollars) AS December,\r\n\t\t\t\tSUM(JanuaryRevisedBilledDollars) AS January,\r\n\t\t\t\tSUM(FebruaryRevisedBilledDollars) AS February,\r\n\t\t\t\tSUM(MarchRevisedBilledDollars) AS March,\r\n\t\t\t\tSUM(AprilRevisedBilledDollars) AS April,\r\n\t\t\t\tSUM(MayRevisedBilledDollars) AS May,\r\n\t\t\t\tSUM(JuneRevisedBilledDollars) AS June\t\t\t\t\r\n\t\t\tfrom @tbl\r\n\t\t\tgroup by OecFacilityNumber,FiscalYear,AgencyCodeOEC,Address1,FiscalYear,AgencyName\r\n\t\t  order by AgencyCodeOEC desc,FiscalYear Desc,OecFacilityNumber;\t\t\t\r\n\t\tEND;\r\nEND;"
        }
      ]
    }
  ]
}