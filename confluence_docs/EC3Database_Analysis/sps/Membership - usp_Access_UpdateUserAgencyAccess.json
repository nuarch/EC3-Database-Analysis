{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Membership",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Access_UpdateUserAgencyAccess",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Access_UpdateUserAgencyAccess",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to manage user access to agency divisions within a membership system. It updates the "
        },
        {
          "type": "text",
          "text": "MembershipAgencyAccess",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table based on whether a user has access to all agencies or specific ones. The procedure handles both scenarios: granting access to all agencies or updating access to specific agency divisions as provided in an XML input."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity is considered medium due to the use of XML parsing, conditional logic, and multiple SQL operations (DELETE, INSERT) within the procedure. The logic involves handling both scenarios of full access and selective access, which adds to the complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyDivisionSeqIds XML",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An XML document containing a list of agency division sequence IDs. This parameter is used when the user is granted access to specific agency divisions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID seqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A unique identifier for the authenticated user whose access is being updated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsAllAgency yesnoWithDefaultNo",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A flag indicating whether the user should have access to all agencies ('Y' for yes, 'N' for no)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "All Agency Access (`@IsAllAgency = 'Y'`)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Deletes any existing records for the user in "
                        },
                        {
                          "type": "text",
                          "text": "MembershipAgencyAccess",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts a new record with "
                        },
                        {
                          "type": "text",
                          "text": "IsAllAgencyAccess",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " set to 'Y', indicating the user has access to all agencies."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Specific Agency Access (`@IsAllAgency = 'N'`)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Deletes any existing records for the user where "
                        },
                        {
                          "type": "text",
                          "text": "IsAllAgencyAccess",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is 'Y'."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Parses the XML input to extract agency division IDs and inserts them into a temporary table "
                        },
                        {
                          "type": "text",
                          "text": "@AgencyDivisions",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Deletes records from "
                        },
                        {
                          "type": "text",
                          "text": "MembershipAgencyAccess",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for the user that are not in the provided list of agency division IDs."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts new records for each agency division ID from the XML input that does not already exist in "
                        },
                        {
                          "type": "text",
                          "text": "MembershipAgencyAccess",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Return Value",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure ends with a "
                },
                {
                  "type": "text",
                  "text": "SELECT 0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which returns a constant value of 0, possibly indicating successful execution."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "XML Parsing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Parsing XML can be resource-intensive, especially with large datasets. Ensure that the XML input is optimized and not excessively large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Operations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple DELETE and INSERT operations, which can be costly in terms of performance. Indexing on "
                },
                {
                  "type": "text",
                  "text": "AuthenticatedUserID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "AgencyDivisionSeqID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " in "
                },
                {
                  "type": "text",
                  "text": "MembershipAgencyAccess",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can help optimize these operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include explicit transaction handling, which might lead to concurrency issues if multiple updates occur simultaneously for the same user."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Without transaction handling, there is a risk of partial updates if an error occurs mid-execution. Implementing transactions can help maintain data integrity."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "XML Input Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes the XML input is well-formed and valid. Invalid XML could cause errors during parsing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the number of users and agency divisions grows, the performance of this procedure might degrade. Consider optimizing the XML parsing and database operations for scalability."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Return Value",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure returns a constant value of 0, which may not provide meaningful feedback to the caller about the success or failure of the operation. Consider implementing error handling and meaningful return codes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [Membership].[usp_Access_UpdateUserAgencyAccess]\r\n\t/*\r\n\t<Agencies>\r\n\t\t<Agency>\r\n\t\t\t<AgencyDivisionSeqId>\r\n\t*/\r\n\t@AgencyDivisionSeqIds XML,\r\n\t@AuthenticatedUserID seqid,\r\n\t@IsAllAgency yesnoWithDefaultNo\r\nAS\r\nBEGIN\r\n\t\r\n\tIF(@IsAllAgency = 'Y')\r\n\tBEGIN\r\n\t\tDELETE FROM Membership.MembershipAgencyAccess\r\n\t\tWHERE AuthenticatedUserID = @AuthenticatedUserID\r\n\t\r\n\t\tINSERT INTO Membership.MembershipAgencyAccess\r\n\t\t        ( AuthenticatedUserID ,\r\n\t\t          AgencyDivisionSeqID ,\r\n\t\t          IsAllAgencyAccess ,\r\n\t\t          DateAdded ,\r\n\t\t          DateLastUpdate\r\n\t\t        )\r\n\t\tVALUES  ( @AuthenticatedUserID , -- AuthenticatedUserID - seqid\r\n\t\t          NULL , -- AgencyDivisionSeqID - seqid\r\n\t\t          'Y' , -- IsAllAgencyAccess - yesnoWithDefaultNo\r\n\t\t          GETDATE() , -- DateAdded - DateAdded\r\n\t\t          GETDATE()  -- DateLastUpdate - LastUpdate\r\n\t\t        )\r\n\tEND -- all agencyies   \r\n\tELSE\r\n\tBEGIN\r\n  \r\n\t\tDELETE FROM Membership.MembershipAgencyAccess\r\n\t\tWHERE AuthenticatedUserID = @AuthenticatedUserID AND IsAllAgencyAccess = 'Y'\r\n\t\t  \r\n\t\tDECLARE @AgencyDivisions TABLE\r\n\t\t(\r\n\t\t\tAgencyDivisionSeqId INT\r\n\t\t)\r\n\r\n\t\tINSERT @AgencyDivisions\r\n\t\t\t\t( AgencyDivisionSeqId )\r\n\t\tSELECT\r\n\t\t\tDISTINCT \r\n\t\t\tCAST(CAST(tbl.col.query('data(AgencyDivisionSeqId)') AS varchar) AS int)\r\n\t\tFROM \r\n\t\t\t@AgencyDivisionSeqIds.nodes('//Agencies//Agency') tbl(col)\r\n\r\n\t\tDELETE from\r\n\t\t[Membership].[MembershipAgencyAccess]\r\n\t\tWHERE AuthenticatedUserID = @AuthenticatedUserID\r\n\t\tAND AgencyDivisionSeqID\r\n\t\tNOT IN\r\n\t\t(\r\n\t\t\tSELECT AgencyDivisionSeqID FROM @AgencyDivisions\r\n\t\t)      \r\n\t\t\r\n\t\tINSERT INTO Membership.MembershipAgencyAccess\r\n\t\t( \r\n\t\t\tAuthenticatedUserID ,\r\n\t\t    AgencyDivisionSeqID ,\r\n\t\t    IsAllAgencyAccess ,\r\n\t\t    DateAdded ,\r\n\t\t    DateLastUpdate\r\n\t\t)\r\n\t\tSELECT @AuthenticatedUserID,ad.AgencyDivisionSeqId, 'N', GETDATE(), GETDATE()\r\n\t\tFROM @AgencyDivisions AS ad\r\n\t\tWHERE NOT EXISTS\r\n\t\t  (\r\n\t\t\tSELECT 1 \r\n\t\t\tFROM Membership.MembershipAgencyAccess maa\r\n\t\t\tWHERE maa.AuthenticatedUserID = @AuthenticatedUserID\r\n\t\t\tAND maa.AgencyDivisionSeqID = ad.AgencyDivisionSeqId\r\n\t\t  )      \r\n\r\n        \r\n\tEND\r\n  \r\n\tSELECT 0\r\n\r\nEND"
        }
      ]
    }
  ]
}