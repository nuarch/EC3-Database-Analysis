{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_GetAccountExtentedBillingInformationByAgencyCode_Updated",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_GetAccountExtentedBillingInformationByAgencyCode_Updated",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve extended billing information for accounts based on various criteria such as agency code, billing period, and facility number. It handles different energy sources (electric, gas, steam) and adjusts the data retrieval based on whether the user is an agency user or not. The procedure logs its usage and performs complex data aggregation and filtering to return detailed billing information."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is high due to the following reasons:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple conditional logic paths based on input parameters."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses Common Table Expressions (CTEs) for data aggregation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs multiple UNION ALL operations to combine results from different billing adjustment tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves dynamic decision-making based on agency or facility data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It interacts with several tables and views, indicating a complex data model."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report, used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which data is requested."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCode AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The code of the agency for which billing information is requested."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OECFacilityNumber AS VARCHAR(7)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The facility number used to filter data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@IsAgencyUser BIT = 0",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A flag indicating whether the user is an agency user, affecting how data is retrieved."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting the transaction isolation level to READ UNCOMMITTED to avoid locking issues and declares a variable to store the procedure name for logging."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Agency User Check",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the user is an agency user, the current processing period is retrieved and used as the billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure logs its execution details using the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " stored procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Facility and Agency Determination",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Converts the facility number to a sequence ID."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determines whether to return data by agency or facility based on the presence of a facility sequence ID."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Uses a CTE to aggregate electric billing adjustment data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inserts agency and descendant data into a table variable if data is to be returned by agency."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieves and combines data from multiple billing adjustment tables (electric, gas, steam) using UNION ALL."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Filters data based on agency or facility, billing period, and energy source."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ensures only current accounts are considered by checking account numbers."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This level reduces locking overhead but leads to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complex Joins and Aggregations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of multiple joins and aggregations can be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "UNION ALL Operations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Combining multiple result sets can be costly in terms of performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Variable Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While table variables are useful, they not perform well with large datasets compared to temporary tables."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of READ UNCOMMITTED may lead to inconsistent data being read if there are concurrent updates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity and number of joins may impact performance as data volume grows."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no validation of input parameters, which could lead to unexpected behavior if invalid data is provided."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": High concurrency could lead to performance degradation due to the extensive use of joins and aggregations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_GetAccountExtentedBillingInformationByAgencyCode_Updated]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@PublishedBillingPeriod AS VARCHAR(6)\r\n\t,@AgencyCode AS VARCHAR(6)\r\n\t,@OECFacilityNumber AS VARCHAR(7)\r\n\t,@IsAgencyUser BIT = 0\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\r\n\tIF (@IsAgencyUser = 1)\r\n\tBEGIN\r\n\t\tSELECT @PublishedBillingPeriod = PublishedBillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\tEND;\r\n\r\n\tEXEC [Audit].usp_AddReportUsageLog @ReportName = @spname\r\n\t\t,@StoredProcName = @spname\r\n\t\t,@RequestedBy = @EmailAddress\r\n\t\t,@prmPublishedBillingPeriod\t= @PublishedBillingPeriod\r\n\t\t,@prmBillingPeriod = NULL\r\n\t\t,@prmAgency_ies = @AgencyCode\r\n\t\t,@prmFacilityNumber_s = @OECFacilityNumber\r\n\t\t,@prmStartingBillingPeriod = NULL\r\n\t\t,@prmEndingBillingPeriod = NULL;\r\n\t\r\n\tDECLARE @FacilitySeqid AS INT, @ResultByAgency AS CHAR(1);\r\n\t\t\r\n\t-- convert the facility number to seqid\r\n\tSELECT @FacilitySeqid = FacilitySeqid FROM Billing.Facility WHERE OecFacilityNumber = @OECFacilityNumber;\t\r\n\t\r\n\t-- determine if we need to return data by agency or simply for the single facility\r\n\tSELECT @ResultByAgency = CASE WHEN @FacilitySeqid IS NULL THEN 'Y' ELSE 'N' END;\r\n\r\n\t-- collect the agencies into a table variable to save a bit\r\n\tDECLARE @AgencyAndItsDecendants TABLE(AgencyDivisionSeqID INT);\r\n\r\n\tIF(@ResultByAgency = 'Y')\r\n\tBEGIN\r\n\t\t-- populate the table\r\n\t\tINSERT INTO @AgencyAndItsDecendants (AgencyDivisionSeqID)\r\n\t\tSELECT AgencyDivisionSeqID\r\n\t\tFROM Billing.uftn_TableGetAllAgencyChildrenByAgencyCodeOEC(@AgencyCode, @EmailAddress);\r\n\tEND;\r\n\t-- return a view of the AccountBillingAdjutmentElectric data\r\n\t\r\n\t-- the Electric Block\r\n\t\t\r\n\t-- Define the CTE expression name and column list.\r\n\tWITH ABAE_TOD_Usage_CTE (ABAESeqid\r\n\t\t,BillingPeriod\r\n\t\t,BillingPeriodRevision\r\n\t\t,ConsumtionOnPeak\r\n\t\t,ConsumtionOffPeak\r\n\t\t,CancelConsumtionOnPeak\r\n\t\t,CancelConsumtionOffPeak)\r\n\tAS(SELECT AB.AccountBillingAdjustmentElectricSeqid AS ABSeqid\r\n\t\t\t,AB.BillingPeriod\r\n\t\t\t,AB.BillingPeriodRevision\r\n\t\t\t,SUM(MBAE.Consumption) AS ConsumtionOnPeak\r\n\t\t\t,SUM(MBAE.ConsumptionHoursOffPeak) AS ConsumtionOffPeak\r\n\t\t\t,SUM(MBAE.CancelConsumption) AS CancelConsumtionOnPeak\r\n\t\t\t,SUM(MBAE.CancelConsumptionHoursOffPeak) AS CancelConsumtionOffPeak\r\n\t\tFROM Billing.AccountBillingAdjustmentElectric AS AB\r\n\t\t\tINNER JOIN Billing.Account AS A ON AB.AdjustedAccount = A.AccountSeqid\r\n\t\t\tINNER JOIN Billing.AccountExchangeMeterTrack AS AEMT ON A.AccountSeqid = AEMT.OriginalAccountSeqid\r\n\t\t\tINNER JOIN Billing.Meter AS M ON AEMT.OriginalMeterSeqid = M.MeterSeqid\r\n\t\t\tINNER JOIN Billing.MeterBillingAdjustmentElectric AS MBAE ON M.MeterSeqid = MBAE.MeterBilled\r\n\t\t\t\tAND AB.BillingPeriod = MBAE.BillingPeriod AND AB.BillingPeriodRevision = MBAE.BillingPeriodRevision\r\n\t\tWHERE AB.IsTimeOfDayAccount = 'Y' AND MBAE.BillingPeriod = @PublishedBillingPeriod\r\n\t\t\tAND (@ResultByAgency <> 'Y' OR A.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\t\tAND (@ResultByAgency <> 'N' OR A.FacilityAccount = @FacilitySeqid)\r\n\t\tGROUP BY AB.AccountBillingAdjustmentElectricSeqid, AB.BillingPeriod, AB.BillingPeriodRevision)\r\n\r\n\tSELECT CA.UniqueAccountSeqid AS AccountSeqid\r\n\t\t,CA.CurrentAccountNumber\r\n\t\t,A.EnergySource\r\n\t\t,AB.BillingPeriod\r\n\t\t,AB.BillingPeriodRevision\r\n\t\t,T.OriginalBilledAmount AS OriginalBilledAmount\r\n\t\t,T.PaidAdjustmentAmount\r\n\t\t,T.TotalAmountDue AS TotalAmountDue\r\n\t\t,CASE WHEN CTE.ABAESeqid IS NULL THEN AB.AccountEnergyUsage ELSE CTE.ConsumtionOnPeak END AS AccountOnPeakKWH\r\n\t\t,CASE WHEN CTE.ABAESeqid IS NULL THEN 0 ELSE CTE.ConsumtionOffPeak END AS AccountOffPeakKWH\r\n\t\t,AB.AccountDemandUsage AS AccountDemandKW\r\n\t\t,AB.AccountReactivePowerEnergy AS AccountReactivePowerEnergy\r\n\t\t,AB.CommodityConsumption + AB.CommodityConsumptionOffPeak\r\n\t\t\t+ AB.CommodityConsumptionShoulder AS ProductionEnergyCharge\r\n\t\t,AB.CommodityDemand + AB.CommodityDemandOffPeak + AB.CommodityDemandShoulder\r\n\t\t\t+ AB.MinimumBilledDemandDollars AS ProductionDemandCharge\r\n\t\t,AB.EnergyCostAdjustment AS ProductionECACharges\r\n\t\t,AB.DeliveryChargeAmount\r\n\t\t,AB.DeliveryConsumption\r\n\t\t,AB.DeliveryDemand + AB.DeliveryMinimumBilledAmount AS DeliveryDemandCharge\r\n\t\t,AB.CustomerLevelAdjustmentAmount AS AllocatedCityWideElectricCharge\r\n\t\t,AB.CommodityAllocationCharge AS FixedCharges\r\n\t\t,AB.GrossReceiptTax\r\n\t\t,AB.RevisedReactivePowerDollars\r\n\t\t,AB.MinimumBilledDemandUsage\r\n\t\t,AB.DeliveryMinimumBilledDemand\r\n\t\t,AB.ProductionMisc1 AS ZECsCharge\r\n\t\t--Cancel Block\r\n\t\t,AB.ProductionMisc1 AS OriginalZECsCharge\r\n\t\t,CASE WHEN CTE.ABAESeqid IS NULL THEN (-1) * AB.CancelAccountEnergyUsage\r\n\t\t\tELSE (-1) * CTE.CancelConsumtionOnPeak END AS OriginalAccountOnPeakKHW\r\n\t\t,CASE WHEN CTE.ABAESeqid IS NULL THEN 0\r\n\t\t\tELSE (-1) * CTE.CancelConsumtionOffPeak END AS OriginalAccountOffPeakKWH\r\n\t\t,(-1) * AB.CancelAccountDemandUsage AS OriginalAccountDemandKW\r\n\t\t,(-1) * AB.CanceledAccountReactivePowerEnergy AS OriginalAccountReactivePowerEnergy\r\n\t\t,(-1) * AB.CancelCommodityConsumption + (-1) * AB.CancelCommodityConsumptionOffPeak + (-1)\r\n\t\t\t* AB.CancelCommodityConsumptionShoulder AS OriginalProductionEnergyCharge\r\n\t\t,(-1) * AB.CancelCommodityDemand + (-1) * AB.CancelCommodityDemandOffPeak + (-1)\r\n\t\t\t* AB.cancelCommodityDemandShoulder + (-1)\r\n\t\t\t* AB.CancelMinimumBilledDemandDollars AS OriginalProductionDemandCharge\r\n\t\t,(-1) * AB.CancelEnergyCostAdjustment AS OriginalProductionECACharges\r\n\t\t,(-1) * AB.CancelDeliveryChargeAmount AS OriginalDeliveryChargeAmount\r\n\t\t,(-1) * AB.CancelDeliveryConsumption AS OriginalDeliveryConsumption\r\n\t\t,(-1) * AB.CancelDeliveryDemand + (1) * AB.CancelDeliveryMinimumBilledAmount AS OriginalDeliveryDemandCharge\r\n\t\t,AB.CustomerLevelAdjustmentAmount AS OriginalAllocatedCityWideElectricCharge\r\n\t\t,AB.CommodityAllocationCharge AS OriginalFixedCharges\r\n\t\t,(-1) * AB.CancelGrossReceiptTax AS OriginalGrossReceiptTax\r\n\t\t,(-1) * AB.OriginalReactivePowerDollars AS OriginalReactivePowerDollars\r\n\t\t-- steam block here\r\n\t\t,NULL AS RevisedMLBS\r\n\t\t,NULL AS OriginalMLBS\r\n\t\t-- gas starts here\r\n\t\t,NULL AS RevisedCCF\r\n\t\t,NULL AS OriginalCCF\r\n\t\t,NULL AS RevisedTherms\r\n\t\t,NULL AS OriginalTherms\r\n\tFROM Billing.AccountBillingAdjustmentElectric AS AB\r\n\t\tINNER JOIN Billing.Account AS A ON AB.AdjustedAccount = A.AccountSeqid\r\n\t\tINNER JOIN Billing.Account AS CA ON A.CurrentAccountNumber = CA.CurrentAccountNumber\r\n\t\tINNER JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS T ON T.AccountSeqid = CA.AccountSeqid\r\n\t\tLEFT OUTER JOIN ABAE_TOD_Usage_CTE AS CTE ON AB.AccountBillingAdjustmentElectricSeqid = CTE.ABAESeqid\r\n\tWHERE (@ResultByAgency <> 'Y' OR CA.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\tAND (@ResultByAgency <> 'N' OR CA.FacilityAccount = @FacilitySeqid)\r\n\t\tAND AB.BillingPeriod = @PublishedBillingPeriod\r\n\t\tAND CA.CurrentAccountNumber = CA.OriginalAccountNumber -- filters just the current accounts\r\n\t\tAND T.EffectiveStartPeriod <= @PublishedBillingPeriod\r\n\t\tAND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND AB.BillingPeriodRevision = T.BillingPeriod\r\n\tUNION ALL\r\n\t-- the GAS block\r\n\tSELECT A.UniqueAccountSeqid AS AccountSeqid\r\n\t\t,A.CurrentAccountNumber\r\n\t\t,A.EnergySource\r\n\t\t,ABAG.BillingPeriod\r\n\t\t,ABAG.BillingPeriodRevision\r\n\t\t,T.OriginalBilledAmount\r\n\t\t,T.PaidAdjustmentAmount\r\n\t\t,T.TotalAmountDue\r\n\t\t--electric Block\r\n\t\t,NULL AS AccountOnPeakKWH\r\n\t\t,NULL AS AccountOffPeakKWH\r\n\t\t,NULL AS AccountDemandKW\r\n\t\t,NULL AS AccountReactivePowerEnergy\r\n\t\t,T.RevisedBilledAmount AS ProductionEnergyCharge\r\n\t\t,NULL AS ProductionDemandCharge\r\n\t\t,NULL AS ProductionECACharges\r\n\t\t,NULL AS DeliveryChargeAmount\r\n\t\t,NULL AS DeliveryConsumption\r\n\t\t,NULL AS DeliveryDemandCharge\r\n\t\t,NULL AS AllocatedCityWideElectricCharge\r\n\t\t,NULL AS FixedCharges\r\n\t\t,NULL AS GrossReceiptTax\r\n\t\t,NULL AS RevisedReactivePowerDollars\r\n\t\t,NULL AS MinimumBilledDemandUsage\r\n\t\t,NULL AS DeliveryMinimumBilledDemand\r\n\t\t,NULL AS ZECsCharge\r\n\t\t,NULL AS OriginalZECsCharge\r\n\t\t,NULL AS OriginalAccountOnPeakKHW\r\n\t\t,NULL AS OriginalAccountOffPeakKWH\r\n\t\t,NULL AS OriginalAccountDemandKW\r\n\t\t,NULL AS OriginalAccountReactivePowerEnergy\r\n\t\t,T.OriginalBilledAmount AS OriginalProductionEnergyCharge\r\n\t\t,NULL AS OriginalProductionDemandCharge\r\n\t\t,NULL AS OriginalProductionECACharges\r\n\t\t,NULL AS OriginalDeliveryChargeAmount\r\n\t\t,NULL AS OriginalDeliveryConsumption\r\n\t\t,NULL AS OriginalDeliveryDemandCharge\r\n\t\t,NULL AS OriginalAllocatedCityWideElectricCharge\r\n\t\t,NULL AS OriginalFixedCharges\r\n\t\t,NULL AS OriginalGrossReceiptTax\r\n\t\t,NULL AS OriginalReactivePowerDollars\r\n\t\t-- steam block here\r\n\t\t,NULL AS RevisedMLBS\r\n\t\t,NULL AS OriginalMLBS\r\n\t\t-- gas starts here\r\n\t\t,RevisedCCF AS RevisedCCF\r\n\t\t,ABAG.CanceledCCF AS OriginalCCF\r\n\t\t,RevisedTherms AS RevisedTherms\r\n\t\t,ABAG.CanceledTherms AS OriginalTherms\r\n\tFROM Billing.AccountBillingAdjustmentGas AS ABAG\r\n\t\tINNER JOIN Billing.Account AS A ON ABAG.UniqueAccountSeqId = A.UniqueAccountSeqId\r\n\t\tINNER JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS T ON T.UniqueAccountSeqid = A.UniqueAccountSeqid\r\n\tWHERE ((@ResultByAgency = 'Y' AND A.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\tOR (@ResultByAgency = 'N' AND A.FacilityAccount = @FacilitySeqid))\r\n\t\tAND ABAG.BillingPeriod = @PublishedBillingPeriod\r\n\t\tAND A.CurrentAccountNumber = A.OriginalAccountNumber -- filters just the current accounts\r\n\t\tAND T.EffectiveStartPeriod <= @PublishedBillingPeriod\r\n\t\tAND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ABAG.BillingPeriodRevision = T.BillingPeriod\r\n\t\tAND A.EnergySource = 5\r\n\tUNION ALL\r\n\t-- the CRIS GAS block\r\n\tSELECT A.UniqueAccountSeqid AS AccountSeqid\r\n\t\t,A.CurrentAccountNumber\r\n\t\t,A.EnergySource\r\n\t\t,ABACG.BillingPeriod\r\n\t\t,ABACG.BillingPeriodRevision\r\n\t\t,T.OriginalBilledAmount\r\n\t\t,T.PaidAdjustmentAmount\r\n\t\t,T.TotalAmountDue\r\n\t\t--electric Block\r\n\t\t,NULL AS AccountOnPeakKWH\r\n\t\t,NULL AS AccountOffPeakKWH\r\n\t\t,NULL AS AccountDemandKW\r\n\t\t,NULL AS AccountReactivePowerEnergy\r\n\t\t,T.RevisedBilledAmount AS ProductionEnergyCharge\r\n\t\t,NULL AS ProductionDemandCharge\r\n\t\t,NULL AS ProductionECACharges\r\n\t\t,NULL AS DeliveryChargeAmount\r\n\t\t,NULL AS DeliveryConsumption\r\n\t\t,NULL AS DeliveryDemandCharge\r\n\t\t,NULL AS AllocatedCityWideElectricCharge\r\n\t\t,NULL AS FixedCharges\r\n\t\t,NULL AS GrossReceiptTax\r\n\t\t,NULL AS RevisedReactivePowerDollars\r\n\t\t,NULL AS MinimumBilledDemandUsage\r\n\t\t,NULL AS DeliveryMinimumBilledDemand\r\n\t\t,NULL AS ZECsCharge\r\n\t\t,NULL AS OriginalZECsCharge\r\n\t\t,NULL AS OriginalAccountOnPeakKHW\r\n\t\t,NULL AS OriginalAccountOffPeakKWH\r\n\t\t,NULL AS OriginalAccountDemandKW\r\n\t\t,NULL AS OriginalAccountReactivePowerEnergy\r\n\t\t,T.OriginalBilledAmount AS OriginalProductionEnergyCharge\r\n\t\t,NULL AS OriginalProductionDemandCharge\r\n\t\t,NULL AS OriginalProductionECACharges\r\n\t\t,NULL AS OriginalDeliveryChargeAmount\r\n\t\t,NULL AS OriginalDeliveryConsumption\r\n\t\t,NULL AS OriginalDeliveryDemandCharge\r\n\t\t,NULL AS OriginalAllocatedCityWideElectricCharge\r\n\t\t,NULL AS OrignalFixedCharges\r\n\t\t,NULL AS OriginalGrossReceiptTax\r\n\t\t,NULL AS OriginalReactivePowerDollars\r\n\t\t-- steam block here\r\n\t\t,NULL AS RevisedMLBS\r\n\t\t,NULL AS OriginalMLBS\r\n\t\t-- gas starts here\r\n\t\t,RevisedCCF AS RevisedCCF\r\n\t\t,ABACG.CancelCCF AS OriginalCCF\r\n\t\t,RevisedTherms AS RevisedTherms\r\n\t\t,ABACG.CancelTherms AS OriginalTherms\r\n\tFROM Billing.AccountBillingAdjustmentCrisGas AS ABACG\r\n\t\tINNER JOIN Billing.Account AS A ON ABACG.UniqueAccountSeqId = A.UniqueAccountSeqid\r\n\t\tINNER JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS T ON T.UniqueAccountSeqid = A.UniqueAccountSeqid\r\n\tWHERE (@ResultByAgency <> 'Y' OR A.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\tAND (@ResultByAgency <> 'N' OR A.FacilityAccount = @FacilitySeqid)\r\n\t\tAND ABACG.BillingPeriod = @PublishedBillingPeriod\r\n\t\tAND A.CurrentAccountNumber = A.OriginalAccountNumber -- filters just the current accounts\r\n\t\tAND T.EffectiveStartPeriod <= @PublishedBillingPeriod\r\n\t\tAND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ABACG.BillingPeriodRevision = T.BillingPeriod\r\n\tUNION ALL\r\n\t-- the manual billing STEAM block\r\n\tSELECT A.UniqueAccountSeqid AS AccountSeqid\r\n\t\t,A.CurrentAccountNumber\r\n\t\t,A.EnergySource\r\n\t\t,ABAPB.BillingPeriod\r\n\t\t,ABAPB.BillingPeriodRevision\r\n\t\t,T.OriginalBilledAmount\r\n\t\t,T.PaidAdjustmentAmount\r\n\t\t,T.TotalAmountDue\r\n\t\t--electric Block\r\n\t\t,NULL AS AccountOnPeakKWH\r\n\t\t,NULL AS AccountOffPeakKWH\r\n\t\t,NULL AS AccountDemandKW\r\n\t\t,NULL AS AccountReactivePowerEnergy\r\n\t\t,T.RevisedBilledAmount AS ProductionEnergyCharge\r\n\t\t,NULL AS ProductionDemandCharge\r\n\t\t,NULL AS ProductionECACharges\r\n\t\t,NULL AS DeliveryChargeAmount\r\n\t\t,NULL AS DeliveryConsumption\r\n\t\t,NULL AS DeliveryDemandCharge\r\n\t\t,NULL AS AllocatedCityWideElectricCharge\r\n\t\t,NULL AS FixedCharges\r\n\t\t,NULL AS GrossReceiptTax\r\n\t\t,NULL AS RevisedReactivePowerDollars\r\n\t\t,NULL AS MinimumBilledDemandUsage\r\n\t\t,NULL AS DeliveryMinimumBilledDemand\r\n\t\t,NULL AS ZECsCharge\r\n\t\t,NULL AS OriginalZECsCharge\r\n\t\t,NULL AS OriginalAccountOnPeakKHW\r\n\t\t,NULL AS OriginalAccountOffPeakKWH\r\n\t\t,NULL AS OriginalAccountDemandKW\r\n\t\t,NULL AS OriginalAccountReactivePowerEnergy\r\n\t\t,T.OriginalBilledAmount AS OriginalProductionEnergyCharge\r\n\t\t,NULL AS OriginalProductionDemandCharge\r\n\t\t,NULL AS OriginalProductionECACharges\r\n\t\t,NULL AS OriginalDeliveryChargeAmount\r\n\t\t,NULL AS OriginalDeliveryConsumption\r\n\t\t,NULL AS OriginalDeliveryDemandCharge\r\n\t\t,NULL AS OriginalAllocatedCityWideElectricCharge\r\n\t\t,NULL AS OriginalFixedCharges\r\n\t\t,NULL AS OriginalGrossReceiptTax\r\n\t\t,NULL AS OriginalReactivePowerDollars\r\n\t\t-- steam starts here\r\n\t\t,ABAPB.RevisedEnergy AS RevisedMLBS\r\n\t\t,ABAPB.CanceledEnergy AS OriginalMLBS\r\n\t\t-- gas starts here\r\n\t\t,NULL AS RevisedCCF\r\n\t\t,NULL AS OriginalCCF\r\n\t\t,NULL AS RevisedTherms\r\n\t\t,NULL AS OriginalTherms\r\n\tFROM Billing.AccountBillingAdjustmentPaperBill AS ABAPB\r\n\t\tINNER JOIN Billing.Account AS A ON ABAPB.UniqueAccountSeqId = A.UniqueAccountSeqId\r\n\t\tINNER JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS T ON T.UniqueAccountSeqid = A.UniqueAccountSeqid\r\n\tWHERE (@ResultByAgency <> 'Y' OR A.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\tAND (@ResultByAgency <> 'N' OR A.FacilityAccount = @FacilitySeqid)\r\n\t\tAND ABAPB.BillingPeriod = @PublishedBillingPeriod\r\n\t\tAND A.CurrentAccountNumber = A.OriginalAccountNumber -- filters just the current accounts\r\n\t\tAND T.EffectiveStartPeriod <= @PublishedBillingPeriod\r\n\t\tAND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ABAPB.BillingPeriodRevision = T.BillingPeriod\r\n\t\tAND A.EnergySource = 6\r\n\tUNION ALL\r\n\t-- the manual billing ELECTRIC block\r\n\tSELECT CA.UniqueAccountSeqid AS AccountSeqid\r\n\t\t,CA.CurrentAccountNumber\r\n\t\t,1 AS EnergySource\r\n\t\t,ABAPB.BillingPeriod\r\n\t\t,ABAPB.BillingPeriodRevision\r\n\t\t,T.OriginalBilledAmount\r\n\t\t,T.PaidAdjustmentAmount\r\n\t\t,T.TotalAmountDue\r\n\t\t--electric Block\r\n\t\t,ABAPB.RevisedEnergy AS AccountOnPeakKWH\r\n\t\t,NULL AS AccountOffPeakKWH\r\n\t\t,ABAPB.RevisedDemand AS AccountDemandKW\r\n\t\t,NULL AS AccountReactivePowerEnergy\r\n\t\t,T.RevisedBilledAmount AS ProductionEnergyCharge\r\n\t\t,NULL AS ProductionDemandCharge\r\n\t\t,NULL AS ProductionECACharges\r\n\t\t,NULL AS DeliveryChargeAmount\r\n\t\t,NULL AS DeliveryConsumption\r\n\t\t,NULL AS DeliveryDemandCharge\r\n\t\t,NULL AS AllocatedCityWideElectricCharge\r\n\t\t,NULL AS FixedCharges\r\n\t\t,NULL AS GrossReceiptTax\r\n\t\t,NULL AS RevisedReactivePowerDollars\r\n\t\t,NULL AS MinimumBilledDemandUsage\r\n\t\t,NULL AS DeliveryMinimumBilledDemand\r\n\t\t,NULL AS ZECsCharge\r\n\t\t,NULL AS OriginalZECsCharge\r\n\t\t,ISNULL(ABAPB.CanceledEnergy, 0) AS OriginalAccountOnPeakKHW\r\n\t\t,NULL AS OriginalAccountOffPeakKWH\r\n\t\t,ISNULL(ABAPB.CanceledDemand, 0) AS OriginalAccountDemandKW\r\n\t\t,NULL AS OriginalAccountReactivePowerEnergy\r\n\t\t,T.OriginalBilledAmount AS OriginalProductionEnergyCharge\r\n\t\t,NULL AS OriginalProductionDemandCharge\r\n\t\t,NULL AS OriginalProductionECACharges\r\n\t\t,NULL AS OriginalDeliveryChargeAmount\r\n\t\t,NULL AS OriginalDeliveryConsumption\r\n\t\t,NULL AS OriginalDeliveryDemandCharge\r\n\t\t,NULL AS OriginalAllocatedCityWideElectricCharge\r\n\t\t,NULL AS OriginalFixedCharges\r\n\t\t,NULL AS OriginalGrossReceiptTax\r\n\t\t,NULL AS OriginalReactivePowerDollars\r\n\t\t-- steam starts here\r\n\t\t,NULL AS RevisedMLBS\r\n\t\t,NULL AS OriginalMLBS\r\n\t\t-- gas starts here\r\n\t\t,NULL AS RevisedCCF\r\n\t\t,NULL AS OriginalCCF\r\n\t\t,NULL AS RevisedTherms\r\n\t\t,NULL AS OriginalTherms\r\n\tFROM Billing.AccountBillingAdjustmentPaperBill AS ABAPB\r\n\t\tINNER JOIN Billing.Account AS A ON ABAPB.AccountSeqid = A.AccountSeqid\r\n\t\tINNER JOIN Billing.Account AS CA ON A.CurrentAccountNumber = CA.CurrentAccountNumber\r\n\t\tINNER JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS T ON T.AccountSeqid = CA.AccountSeqid\r\n\tWHERE (@ResultByAgency <> 'Y' OR CA.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\tAND (@ResultByAgency <> 'N' OR CA.FacilityAccount = @FacilitySeqid)\r\n\t\tAND ABAPB.BillingPeriod = @PublishedBillingPeriod\r\n\t\tAND CA.CurrentAccountNumber = CA.OriginalAccountNumber -- filters just the current accounts\r\n\t\tAND T.EffectiveStartPeriod <= @PublishedBillingPeriod\r\n\t\tAND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ABAPB.BillingPeriodRevision = T.BillingPeriod\r\n\t\tAND CA.EnergySource IN (1,2,3,4) -- all electric\r\n\tUNION ALL\r\n\t-- the manual billing GAS block\r\n\tSELECT A.UniqueAccountSeqid AS AccountSeqid\r\n\t\t,A.CurrentAccountNumber\r\n\t\t,A.EnergySource\r\n\t\t,ABAPB.BillingPeriod\r\n\t\t,ABAPB.BillingPeriodRevision\r\n\t\t,T.OriginalBilledAmount\r\n\t\t,T.PaidAdjustmentAmount\r\n\t\t,T.TotalAmountDue\r\n\t\t--electric Block\r\n\t\t,NULL AS AccountOnPeakKWH\r\n\t\t,NULL AS AccountOffPeakKWH\r\n\t\t,NULL AS AccountDemandKW\r\n\t\t,NULL AS AccountReactivePowerEnergy\r\n\t\t,T.RevisedBilledAmount AS ProductionEnergyCharge\r\n\t\t,NULL AS ProductionDemandCharge\r\n\t\t,NULL AS ProductionECACharges\r\n\t\t,NULL AS DeliveryChargeAmount\r\n\t\t,NULL AS DeliveryConsumption\r\n\t\t,NULL AS DeliveryDemandCharge\r\n\t\t,NULL AS AllocatedCityWideElectricCharge\r\n\t\t,NULL AS FixedCharges\r\n\t\t,NULL AS GrossReceiptTax\r\n\t\t,NULL AS RevisedReactivePowerDollars\r\n\t\t,NULL AS MinimumBilledDemandUsage\r\n\t\t,NULL AS DeliveryMinimumBilledDemand\r\n\t\t,NULL AS ZECsCharge\r\n\t\t,NULL AS OriginalZECsCharge\r\n\t\t,NULL AS OriginalAccountOnPeakKHW\r\n\t\t,NULL AS OriginalAccountOffPeakKWH\r\n\t\t,NULL AS OriginalAccountDemandKW\r\n\t\t,NULL AS OriginalAccountReactivePowerEnergy\r\n\t\t,T.OriginalBilledAmount AS OriginalProductionEnergyCharge\r\n\t\t,NULL AS OriginalProductionDemandCharge\r\n\t\t,NULL AS OriginalProductionECACharges\r\n\t\t,NULL AS OriginalDeliveryChargeAmount\r\n\t\t,NULL AS OriginalDeliveryConsumption\r\n\t\t,NULL AS OriginalDeliveryDemandCharge\r\n\t\t,NULL AS OriginalAllocatedCityWideElectricCharge\r\n\t\t,NULL AS OriginalFixedCharges\r\n\t\t,NULL AS OriginalGrossReceiptTax\r\n\t\t,NULL AS OriginalReactivePowerDollars\r\n\t\t-- steam starts here\r\n\t\t,NULL AS RevisedMLBS\r\n\t\t,NULL AS OriginalMLBS\r\n\t\t-- gas starts here\r\n\t\t,ABAPB.RevisedCCF AS RevisedCCF\r\n\t\t,ABAPB.CanceledCCF AS OriginalCCF\r\n\t\t,ABAPB.RevisedEnergy AS RevisedTherms\r\n\t\t,ABAPB.CanceledEnergy AS OriginalTherms\r\n\tFROM Billing.AccountBillingAdjustmentPaperBill AS ABAPB\r\n\t\tINNER JOIN Billing.Account AS A ON ABAPB.UniqueAccountSeqId = A.UniqueAccountSeqId\r\n\t\tINNER JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS T ON T.UniqueAccountSeqid = A.UniqueAccountSeqid\r\n\tWHERE (@ResultByAgency <> 'Y' OR A.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\tAND (@ResultByAgency <> 'N' OR A.FacilityAccount = @FacilitySeqid)\r\n\t\tAND ABAPB.BillingPeriod = @PublishedBillingPeriod\r\n\t\tAND A.CurrentAccountNumber = A.OriginalAccountNumber -- filters just the current accounts\r\n\t\tAND T.EffectiveStartPeriod <= @PublishedBillingPeriod\r\n\t\tAND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ABAPB.BillingPeriodRevision = T.BillingPeriod\r\n\t\tAND A.EnergySource = 5 -- gas only\r\n\tUNION ALL\r\n\t-- CONED GAS STEAM\r\n\tSELECT CA.UniqueAccountSeqid AS AccountSeqid\r\n\t\t,CA.CurrentAccountNumber\r\n\t\t,A.EnergySource\r\n\t\t,ABACES.BillingPeriod\r\n\t\t,ABACES.BillingPeriodRevision\r\n\t\t,T.OriginalBilledAmount\r\n\t\t,T.PaidAdjustmentAmount\r\n\t\t,T.TotalAmountDue\r\n\t\t--electric Block\r\n\t\t,NULL AS AccountOnPeakKWH\r\n\t\t,NULL AS AccountOffPeakKWH\r\n\t\t,NULL AS AccountDemandKW\r\n\t\t,NULL AS AccountReactivePowerEnergy\r\n\t\t,T.RevisedBilledAmount AS ProductionEnergyCharge\r\n\t\t,NULL AS ProductionDemandCharge\r\n\t\t,NULL AS ProductionECACharges\r\n\t\t,NULL AS DeliveryChargeAmount\r\n\t\t,NULL AS DeliveryConsumption\r\n\t\t,NULL AS DeliveryDemandCharge\r\n\t\t,NULL AS AllocatedCityWideElectricCharge\r\n\t\t,NULL AS FixedCharges\r\n\t\t,NULL AS GrossReceiptTax\r\n\t\t,NULL AS RevisedReactivePowerDollars\r\n\t\t,NULL AS MinimumBilledDemandUsage\r\n\t\t,NULL AS DeliveryMinimumBilledDemand\r\n\t\t,NULL AS ZECsCharge\r\n\t\t,NULL AS OriginalZECsCharge\r\n\t\t,NULL AS OriginalAccountOnPeakKHW\r\n\t\t,NULL AS OriginalAccountOffPeakKWH\r\n\t\t,NULL AS OriginalAccountDemandKW\r\n\t\t,NULL AS OriginalAccountReactivePowerEnergy\r\n\t\t,T.OriginalBilledAmount AS OriginalProductionEnergyCharge\r\n\t\t,NULL AS OriginalProductionDemandCharge\r\n\t\t,NULL AS OriginalProductionECACharges\r\n\t\t,NULL AS OriginalDeliveryChargeAmount\r\n\t\t,NULL AS OriginalDeliveryConsumption\r\n\t\t,NULL AS OriginalDeliveryDemandCharge\r\n\t\t,NULL AS OriginalAllocatedCityWideElectricCharge\r\n\t\t,NULL AS OriginalFixedCharges\r\n\t\t,NULL AS OriginalGrossReceiptTax\r\n\t\t,NULL AS OriginalReactivePowerDollars\r\n\t\t-- steam starts here\r\n\t\t,CASE WHEN  ABACES.TransactionType='BI' THEN ABACES.Consumption END AS RevisedMLBS\r\n\t\t,CASE WHEN  ABACES.TransactionType='BC' THEN ABACES.Consumption END AS OriginalMLBS\r\n\t\t-- gas starts here\r\n\t\t,NULL AS RevisedCCF\r\n\t\t,NULL AS OriginalCCF\r\n\t\t,NULL AS RevisedTherms\r\n\t\t,NULL AS OriginalTherms\r\n\tFROM Billing.AccountBillingAdjustmentConEdSteam AS ABACES\r\n\t\tINNER JOIN Billing.Account AS A ON ABACES.AccountSeqid = A.AccountSeqid\r\n\t\tINNER JOIN Billing.Account AS CA ON A.CurrentAccountNumber = CA.CurrentAccountNumber\r\n\t\tINNER JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS T ON T.UniqueAccountSeqid = CA.UniqueAccountSeqid\r\n\tWHERE (@ResultByAgency <> 'Y' OR CA.AgencyAccount IN (SELECT AgencyDivisionSeqID FROM @AgencyAndItsDecendants))\r\n\t\tAND (@ResultByAgency <> 'N' OR CA.FacilityAccount = @FacilitySeqid)\r\n\t\tAND ABACES.BillingPeriod = @PublishedBillingPeriod\r\n\t\tAND CA.CurrentAccountNumber = CA.OriginalAccountNumber -- filters just the current accounts\r\n\t\tAND T.EffectiveStartPeriod <= @PublishedBillingPeriod\r\n\t\tAND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ABACES.BillingPeriodRevision = T.BillingPeriod\r\n\t\tAND CA.EnergySource = 6;\r\nEND;"
        }
      ]
    }
  ]
}