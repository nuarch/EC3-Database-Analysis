{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Common",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchange_Code28",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ProcessExchange_Code28",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to handle the process of turning off an account and its associated meters in a billing system. It specifically deals with an \"exchange\" operation identified by the code \"28\". The procedure performs several validation checks, updates account and meter statuses, and logs the operation in the system. It uses transaction management to ensure data integrity and employs exception handling to manage errors."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple validation checks, conditional logic, and updates across different tables. It also includes transaction management and error handling, which adds to its complexity. However, it is not overly complex as it follows a straightforward sequence of operations once the initial validations are passed."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for the exchange record being processed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeCode AS VARCHAR(2)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The exchange code, expected to be \"28\" for this procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current billing period, used to update account and meter records."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode AS INT OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter to indicate the status of the procedure execution (success or failure)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Message AS VARCHAR(1000) OUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter to provide messages related to the execution status or errors."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validation Checks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Verify if the exchange record exists in the "
                        },
                        {
                          "type": "text",
                          "text": "Common.ExchangeData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Check if the exchange record has already been processed."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Ensure the account is active in the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Collection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieve account and meter information from the "
                        },
                        {
                          "type": "text",
                          "text": "Common.ExchangeData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Exchange Code Verification",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Confirm that the exchange code is \"28\"."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Management",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Begin a transaction to ensure atomicity of the operations."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Account and Meter Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Update the account status to \"28\" (turned off) in the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Update the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountExchangeMeterTrack",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table to reflect the account and meter turn-off."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Update the meter status to \"27\" (turned off) in the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Meter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Mark Exchange as Processed",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Update the "
                        },
                        {
                          "type": "text",
                          "text": "Common.ExchangeData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table to mark the exchange as processed."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Use a TRY-CATCH block to handle exceptions, rollback transactions on error, and provide error messages."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Index Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the columns used in WHERE clauses, such as "
                },
                {
                  "type": "text",
                  "text": "ExchangeDataSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "CurrentAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", are indexed to improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is well-defined, but care should be taken to minimize the time spent in the transaction to reduce locking and potential contention."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure should be tested under concurrent execution scenarios to ensure that it handles locking and isolation levels appropriately."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure is interrupted or fails without proper rollback, it could leave the system in an inconsistent state. The use of transactions mitigates this risk."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The THROW statement provides a generic error message. Consider capturing and logging detailed error information for troubleshooting."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Exchange Code Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The condition "
                },
                {
                  "type": "text",
                  "text": "@ExchangeCode <> '28' OR @ExchangeCode <> @RecordExchangeCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " will always evaluate to true due to logical error. It should be "
                },
                {
                  "type": "text",
                  "text": "@ExchangeCode <> '28' OR @ExchangeCode <> @RecordExchangeCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to "
                },
                {
                  "type": "text",
                  "text": "@ExchangeCode <> '28' AND @ExchangeCode <> @RecordExchangeCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the procedure's performance should be monitored and optimized, especially the parts involving updates to multiple tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the procedure is executed with appropriate permissions to prevent unauthorized access or modifications."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Description:\t\"28\" Turn off Account and associated meters\r\n--*\r\n--* AUTHOR:       Zafer Durmaz\r\n--* Created On:   07/18/2016\r\n--* 03/27/2017 zd  Added Throw for exception handling\r\n--**************************************************************************************\r\n--* Change Log\r\n--* \r\n--* 07/18/2016 zd  First Version\r\n--***************************************************************************************\r\nCREATE PROCEDURE [Common].[usp_ProcessExchange_Code28]\r\n(\r\n\t@AuthenticatedUserID AS INT,\r\n\t@ExchangeSeqid AS INT,\r\n\t@ExchangeCode AS VARCHAR(2),\r\n\t@CurrentBillingPeriod AS VARCHAR(6),\r\n\t@StatusCode AS INT OUTPUT,\r\n\t@Message AS VARCHAR(1000) OUT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\r\n\tDECLARE @AccountNumber NVARCHAR(15), @MeterNumber NVARCHAR(12), @AccountEffectiveTurnOff VARCHAR(8)\r\n\t\t,@TurnOffBillingPeriod VARCHAR(6), @RecordExchangeCode VARCHAR(2);\r\n\r\n\t-- Validations and Checks\r\n\t-- CHECK IF THE record exists\r\n\tIF (NOT EXISTS(SELECT ExchangeDataSeqid FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid))\r\n\tBEGIN\r\n\t\tSELECT @Message = 'The ExchangeSeqid ' + CAST(@ExchangeSeqid AS VARCHAR) + ' does not exist. Please verify ', @StatusCode = 0;\r\n\t\t;THROW 50000, @Message, 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\t-- check if the record was processed\r\n\tIF ('N' <> (SELECT IsProcessed FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid))\r\n\tBEGIN\r\n\t\tSELECT @Message = 'This 28 exchange was already processed. ExchangeSeqid: ' + CAST(@ExchangeSeqid AS VARCHAR), @StatusCode = 0;\r\n\t\t;THROW 50000, @Message, 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\t-- check if the current account number is already in the system under an active status\r\n\tSELECT @AccountNumber = CurrentAccountNumber FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid;\r\n\r\n\tIF (NOT EXISTS (SELECT * FROM Billing.Account WHERE OriginalAccountNumber = @AccountNumber AND AccountStatus IN ('AC', '47', '46', 'UA') AND IsCurrentRecord = 'Y'))\r\n\tBEGIN\r\n\t\tSELECT @Message = 'The account number: ' + @AccountNumber + ' does not exist in the system under an active status. Please verify.', @StatusCode = 0;\r\n\t\t;THROW 50000, @Message, 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\t-- collect some basic information\r\n\tSELECT\r\n\t\t@AccountNumber = CurrentAccountNumber,\r\n\t\t@MeterNumber = CurrentMeterNumber,\r\n\t\t@AccountEffectiveTurnOff = AccountEffectiveTurnOff,\r\n\t\t@TurnOffBillingPeriod = BillingPeriod,\r\n\t\t@RecordExchangeCode = ExchangeCode\r\n\tFROM Common.ExchangeData\r\n\tWHERE ExchangeDataSeqid = @ExchangeSeqid;\r\n\r\n\tIF (@ExchangeCode <> '28' OR @ExchangeCode <> @RecordExchangeCode)\r\n\tBEGIN\r\n\t\tSELECT @Message ='The exchange code is not 28. Please verify: '+ @AccountNumber, @StatusCode = 0;\r\n\t\t;THROW 50000, @Message, 1;\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\tBEGIN TRY\r\n\t\tBEGIN TRANSACTION exchange28;\r\n\t\tDECLARE @AccountSeqID AS INT;\r\n\r\n\t\t-- set account to place in exchange data table\r\n\t\tSELECT @AccountSeqID = AccountSeqid\r\n\t\tFROM Billing.Account\r\n\t\tWHERE OriginalAccountNumber = @AccountNumber AND CurrentAccountNumber = @AccountNumber\r\n\t\t\tAND IsCurrentRecord = 'Y' AND AccountStatus <> '28';\r\n\r\n\t\t-- turn off the account\r\n\t\tUPDATE Billing.Account\r\n\t\tSET AccountPreviousStatus = AccountStatus\r\n\t\t\t,AccountStatus = '28'\r\n\t\t\t,AccountStatusCodePeriod = @CurrentBillingPeriod\r\n\t\t\t,AccountEffectiveTurnOff = @AccountEffectiveTurnOff\r\n\t\t\t,TurnOffDate = @TurnOffBillingPeriod\r\n\t\t\t,FireAuditTrigger = 'Y'\r\n\t\t\t,AuthenticatedUserID = @AuthenticatedUserID\r\n\t\t\t,LastUpdate = GETDATE()\r\n\t\tWHERE OriginalAccountNumber = @AccountNumber AND CurrentAccountNumber = @AccountNumber\r\n\t\t\tAND IsCurrentRecord = 'Y' AND AccountStatus <> '28';\r\n\r\n\t\t-- need to do this first before turning off the meters\r\n\t\t-- update the account meter exchange track to reflec the turn off\r\n\t\tUPDATE T\r\n\t\tSET AccountEffectiveBillingEndDate = @AccountEffectiveTurnOff\r\n\t\t\t,MeterEffectiveBillingEndDate = @AccountEffectiveTurnOff\r\n\t\t\t,FireAuditTrigger = 'Y'\r\n\t\t\t,AuthenticatedUserID = @AuthenticatedUserID\r\n\t\t\t,LastUpdate = GETDATE()\r\n\t\tFROM Billing.AccountExchangeMeterTrack AS T INNER JOIN Billing.Meter AS M ON T.OriginalMeterSeqid = M.MeterSeqid\r\n\t\tWHERE T.OriginalAccountNumber = @AccountNumber AND M.CurrentMeterNumber = M.OriginalMeterNumber AND M.MeterStatus <> '27';\r\n\r\n\t\t--\tUpdate Meter turn Off 27\r\n\t\tUPDATE M\r\n\t\tSET MeterPreviousStatus\t = M.MeterStatus\r\n\t\t\t,MeterStatus = '27'\r\n\t\t\t,MeterStatusCodePeriod = @CurrentBillingPeriod\r\n\t\t\t,MeterEffectiveOffDate = @AccountEffectiveTurnOff\r\n\t\t\t,TurnOffDate = @TurnOffBillingPeriod\r\n\t\t\t,FireAuditTrigger = 'Y'\r\n\t\t\t,AuthenticatedUserID = @AuthenticatedUserID\r\n\t\t\t,LastUpdate = GETDATE()\r\n\t\tFROM Billing.AccountExchangeMeterTrack AS T INNER JOIN Billing.Meter AS M ON T.OriginalMeterSeqid = M.MeterSeqid\r\n\t\tWHERE T.OriginalAccountNumber = @AccountNumber AND M.CurrentMeterNumber = M.OriginalMeterNumber AND M.MeterStatus <> '27';\r\n\r\n\t\tUPDATE Common.ExchangeData\r\n\t\tSET IsProcessed = 'Y', AccountSeqid = @AccountSeqID\r\n\t\tWHERE ExchangeDataSeqid = @ExchangeSeqid;\r\n\r\n\t\tCOMMIT TRANSACTION exchange28;\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n\t\tROLLBACK TRANSACTION exchange28;\r\n\t\tSELECT @Message = 'Error processing exchange  ' + CAST(@ExchangeSeqid AS VARCHAR(10)) + ' error message: ', @StatusCode = 0;\r\n\t\t;THROW 50000, @Message, 1;\r\n\tEND CATCH;\r\nEND;"
        }
      ]
    }
  ]
}