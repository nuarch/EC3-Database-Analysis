{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Common",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchange_Code45_Revert",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ProcessExchange_Code45_Revert",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to revert a meter exchange process identified by a unique sequence ID ("
        },
        {
          "type": "text",
          "text": "@ExchangeSeqid",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": "). It performs several validation checks to ensure the exchange can be reverted, and if all checks pass, it deletes and updates records in the database to effectively reverse the exchange. The procedure also handles transaction management and error handling to ensure data integrity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple validation checks, conditional logic, and database operations, including transactions and error handling. It interacts with several tables and uses a Common Table Expression (CTE) for data manipulation, which adds to its complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for the exchange record to be reverted."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user performing the operation, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode INT OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter indicating the status of the operation (1 for success, 0 for failure)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Message VARCHAR(1000) OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter providing a message about the operation's result or any errors encountered."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Checks if the exchange record is marked as excluded. If so, it exits with a message."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Verifies the existence of the exchange record. If not found, it exits with a message."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Ensures the exchange has been processed before attempting a revert. If not processed, it exits with a message."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieves "
                        },
                        {
                          "type": "text",
                          "text": "AccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "MeterSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "CurrentMeterNumber",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " from the "
                        },
                        {
                          "type": "text",
                          "text": "ExchangeData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Further Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Checks if "
                        },
                        {
                          "type": "text",
                          "text": "AccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "MeterSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " are present. If missing, it exits with a message."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Verifies the meter is active in the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Meter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table. If not, it exits with a message."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Ensures there is exactly one record in "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountExchangeMeterTrack",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for the given account and meter. If not, it exits with a message."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction and Reversion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Begins a transaction named "
                        },
                        {
                          "type": "text",
                          "text": "RevertExchangeMeter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Deletes the relevant records from "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountExchangeMeterTrack",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Meter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses a CTE to retrieve the latest audit record for the meter and updates the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Meter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table with this data."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Commits the transaction if all operations succeed."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Post-Transaction Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates the "
                        },
                        {
                          "type": "text",
                          "text": "ExchangeData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table to mark the exchange as reverted ("
                        },
                        {
                          "type": "text",
                          "text": "IsProcessed = 'R'",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ")."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Catches any errors during the transaction, rolls back changes, and sets an error message and status code."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Index Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the "
                },
                {
                  "type": "text",
                  "text": "ExchangeDataSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "MeterSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " columns are indexed to optimize the SELECT and DELETE operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is well-defined, minimizing the risk of locking issues. However, the transaction should be kept as short as possible to reduce contention."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "CTE Efficiency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The CTE is used efficiently to retrieve the latest audit record, but performance can be impacted if the "
                },
                {
                  "type": "text",
                  "text": "Audit.AuditMeter",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is large and not indexed properly."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple processes attempt to revert the same exchange simultaneously, it could lead to race conditions or deadlocks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure fails after deleting records but before completing the update, it could leave the database in an inconsistent state. The transaction management mitigates this risk."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure captures errors and rolls back transactions, but it may not handle all possible exceptions, such as network issues or database unavailability."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of the CTE and the overall procedure may degrade if not properly indexed and optimized."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Common].[usp_ProcessExchange_Code45_Revert] @ExchangeSeqid INT , @AuthenticatedUserID INT, @StatusCode int OUTPUT, @Message VARCHAR(1000) out\n AS \r\n\r\n--**************************************************************************************\r\n--* Description:\t\"45\" revert a meter exchange\r\n--*\r\n--* AUTHOR:       MOHAMMED BELARREM\r\n--* Created On:   06/21/2016\r\n--**************************************************************************************\r\n--* Change Log\r\n--* \r\n--* 06/21/2016 MOH  First Version \r\n--**************************************************************************************\r\n\r\nBEGIN\r\n\r\n\t\tDECLARE @RecordExchangeCode VARCHAR(2)\r\n\r\n\r\n\t\t-- if the record is flagged as exclude, return and exit\r\n\t\tIF ( 'Y' = ( SELECT Exclude FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'This exchange is excluded from processing. ExchangeSeqid: ' + CAST( @ExchangeSeqid AS VARCHAR ) \r\n\t\t\tSET @StatusCode = 1\t-- this is not necessary an error\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- do some validation \r\n\r\n\t\t-- CHECK IF the record exists\r\n\t\tIF ( NOT EXISTS ( SELECT ExchangeDataSeqid FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid ))\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The ExchangeSeqid ' + CAST( @ExchangeSeqid AS VARCHAR ) + ' does not exist. Please verify '\r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- check if the record was not processed\r\n\t\tIF ( 'N' = ( SELECT IsProcessed FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'This exchange was not processed. It cannot be reverted ExchangeSeqid: ' + CAST( @ExchangeSeqid AS VARCHAR ) \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- the process to add adds a MeterSeqid and an AccountSeqid\r\n\t\tDECLARE @AccountSeqid int\r\n\t\tDECLARE @MeterSeqid INT\r\n\t\tDECLARE @UniqueMeterSeqid INT\r\n        DECLARE @MeterNumber VARCHAR(12)\r\n        \r\n\t\tSELECT @AccountSeqid = AccountSeqid, @MeterSeqid = MeterSeqid, @MeterNumber = CurrentMeterNumber FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid\r\n\r\n\t\tIF ( @AccountSeqid IS NULL OR @MeterSeqid IS NULL)\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The Exchange ' + CAST( @ExchangeSeqid AS VARCHAR ) + ' is missing an AccountSeqid or a MeterSeqid that are required for a reversal. Please verify '\r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- check if the Meter number is in the system under an active status\r\n\t\tIF ( NOT EXISTS ( SELECT * FROM Billing.Meter WHERE MeterSeqid = @MeterSeqid AND MeterStatus = 'AC' AND IsCurrentRecord = 'Y' ) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The meter number: ' + @MeterNumber + ' is not in the system under an active status. The exchange cannot be reverted. Please verfiy ' \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- check if the count of exchange track records is more than 1\r\n\t\tIF ( (SELECT COUNT(*) FROM Billing.AccountExchangeMeterTrack WHERE OriginalAccountSeqid = @AccountSeqid AND OriginalMeterSeqid = @MeterSeqid) <> 1 )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The system expects 1 record on the AccountExchangeMeterTrack table for meter number: ' + @MeterNumber + ' and exchange record: ' + CAST( @ExchangeSeqid AS VARCHAR ) + ' .The exchange cannot be reverted. Please verfiy ' \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\r\n\t\tBEGIN TRY\t\r\n\r\n\t\t\t\tBEGIN TRANSACTION RevertExchangeMeter\r\n\r\n\t\t\t\t-- get some info for the insert\r\n\t\t\t\tSELECT @UniqueMeterSeqid = UniqueMeterSeqid FROM Billing.Meter WHERE MeterSeqid = @MeterSeqid\r\n\t\t\t\t\r\n\t\t\t\t-- all looks good, we can remove that meter and account exchange track\r\n\t\t\t\tDELETE FROM Billing.AccountExchangeMeterTrack\r\n\t\t\t\tWHERE OriginalAccountSeqid = @AccountSeqid AND OriginalMeterSeqid = @MeterSeqid\r\n\t\t\t\t\r\n\t\t\t\tDELETE FROM Billing.Meter\r\n\t\t\t\tWHERE MeterSeqid = @MeterSeqid\r\n\r\n\t\t\t\t-- bring back the other meter records\r\n\r\n\t\t\t\t-- construct the dataset\r\n\t\t\t\t;WITH cte_PreviouMeterVersion AS\r\n\t\t\t\t(\r\n\t\t\t\t   SELECT *, ROW_NUMBER() OVER (PARTITION BY MeterSeqid ORDER BY AuditDateTime DESC) AS rn\r\n\t\t\t\t   FROM Audit.AuditMeter\r\n\t\t\t\t   WHERE UniqueMeterSeqid = @UniqueMeterSeqid\r\n\t\t\t\t)\t\r\n\r\n\t\t\t\t-- update the meters\r\n\t\t\t\tUPDATE Billing.Meter\t\r\n\t\t\t\t\tSet OriginalAccountNumber\t\t= CTE.OriginalAccountNumber ,\r\n\t\t\t\t\t    UtilityServiceAddress\t\t= CTE.UtilityServiceAddress ,\r\n\t\t\t\t\t    CurrentMeterNumber\t\t\t= CTE.CurrentMeterNumber ,\r\n\t\t\t\t\t    OriginalMeterNumber\t\t\t= CTE.OriginalMeterNumber ,\r\n\t\t\t\t\t    NgridCorrectorMeterId\t\t= CTE.NgridCorrectorMeterId ,\r\n\t\t\t\t\t    Tension\t\t\t\t\t\t= CTE.Tension ,\r\n\t\t\t\t\t    IsOECDefinedMeter\t\t\t= CTE.IsOECDefinedMeter ,\r\n\t\t\t\t\t    IsUploadProcessed\t\t\t= CTE.IsUploadProcessed ,\r\n\t\t\t\t\t    IsMeterUsageTracked\t\t\t= CTE.IsMeterUsageTracked ,\r\n\t\t\t\t\t    EnergySource\t\t\t\t= CTE.EnergySource ,\r\n\t\t\t\t\t    EnergyAccountDescription\t= CTE.EnergyAccountDescription ,\r\n\t\t\t\t\t    MeterStatus\t\t\t\t\t= CTE.MeterStatus ,\r\n\t\t\t\t\t    MeterPreviousStatus\t\t\t= CTE.MeterPreviousStatus ,\r\n\t\t\t\t\t    MeterStatusCodePeriod\t\t= CTE.MeterStatusCodePeriod ,\r\n\t\t\t\t\t    AssociatedDemandMeter\t\t= CTE.AssociatedDemandMeter ,\r\n\t\t\t\t\t    AgencyELOMeterLocation\t\t= CTE.AgencyELOMeterLocation ,\r\n\t\t\t\t\t    UtilityAddressMeterLocation = CTE.UtilityAddressMeterLocation ,\r\n\t\t\t\t\t    MeterSquareFootageCoverage\t= CTE.MeterSquareFootageCoverage ,\r\n\t\t\t\t\t    TurnOnDate\t\t\t\t\t= CTE.TurnOnDate ,\r\n\t\t\t\t\t    TurnOffDate\t\t\t\t\t= CTE.TurnOffDate ,\r\n\t\t\t\t\t    MeterEffectiveOnDate\t\t= CTE.MeterEffectiveOnDate ,\r\n\t\t\t\t\t    MeterEffectiveOffDate\t\t= CTE.MeterEffectiveOffDate ,\r\n\t\t\t\t\t    MeterType\t\t\t\t\t= CTE.MeterType ,\r\n\t\t\t\t\t    MeterDials\t\t\t\t\t= CTE.MeterDials ,\r\n\t\t\t\t\t    MeterConstant\t\t\t\t= CTE.MeterConstant ,\r\n\t\t\t\t\t    LastPeriodOriginalBilled\t= CTE.LastPeriodOriginalBilled ,\r\n\t\t\t\t\t    LastPeriodAdjustmentBilled\t= CTE.LastPeriodAdjustmentBilled ,\r\n\t\t\t\t\t    LastZeroUsageBillingPeriod\t= CTE.LastZeroUsageBillingPeriod ,\r\n\t\t\t\t\t    AdjustmentRecordSeqid\t\t= CTE.AdjustmentRecordSeqid ,\r\n\t\t\t\t\t    AMRIndicator\t\t\t\t= CTE.AMRIndicator ,\r\n\t\t\t\t\t    FireAuditTrigger\t\t\t= 'N' , -- do not trigger an audit to avoid circualr nonsense\r\n\t\t\t\t\t    Notes\t\t\t\t\t\t= CTE.Notes ,\r\n\t\t\t\t\t    AuthenticatedUserID\t\t\t= CTE.AuthenticatedUserID ,\r\n\t\t\t\t\t    DateAdded\t\t\t\t\t= CTE.DateAdded ,\r\n\t\t\t\t\t    LastUpdate\t\t\t\t\t= CTE.LastUpdate ,\r\n\t\t\t\t\t    UniqueMeterSeqid\t\t\t= CTE.UniqueMeterSeqid ,\r\n\t\t\t\t\t    IsCurrentRecord\t\t\t\t= CTE.IsCurrentRecord ,\r\n\t\t\t\t\t    RecordVersion\t\t\t\t= CTE.RecordVersion  \r\n\t\t\t\tFROM cte_PreviouMeterVersion CTE INNER JOIN  Billing.Meter ON Meter.MeterSeqid = CTE.MeterSeqid\r\n\t\t\t\tWHERE rn = 1\r\n\r\n\t\t\t\tCOMMIT TRAN RevertExchangeMeter\r\n\r\n\t\t\t\t-- if we make it here and all is well, come back and update the record as processes\r\n\t\t\t\tUPDATE Common.ExchangeData\r\n\t\t\t\tSET IsProcessed = 'R'\r\n\t\t\t\tWHERE ExchangeDataSeqid = @ExchangeSeqid\r\n\r\n\t\t\t\tSET @Message = ''\r\n\t\t\t\tSET @StatusCode = 1\r\n\r\n\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\r\n\t\t\t\tROLLBACK TRAN RevertExchangeMeter\r\n\t\t\t\tSET @Message = 'Error processing exchange  ' + CAST(@ExchangeSeqid AS VARCHAR(10)) + ' error message: ' + ERROR_MESSAGE()\r\n\t\t\t\tSET @StatusCode = 0\r\n\t\tEND CATCH\r\n\r\nEND"
        }
      ]
    }
  ]
}