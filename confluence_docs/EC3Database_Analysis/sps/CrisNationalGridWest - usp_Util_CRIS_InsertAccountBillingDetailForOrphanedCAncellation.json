{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Util_CRIS_InsertAccountBillingDetailForOrphanedCAncellation",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Util_CRIS_InsertAccountBillingDetailForOrphanedCAncellation",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to insert a new record into the "
        },
        {
          "type": "text",
          "text": "CrisNationalGridWest.UploadAccountBillingDetail",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table. It selects data from the same table based on a specific "
        },
        {
          "type": "text",
          "text": "UploadAccountBillingDetailSeqid",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " and inserts it back into the table with some modifications. The procedure appears to handle cases related to orphaned cancellations, as indicated by its name and the logic within the procedure."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure involves a straightforward "
                },
                {
                  "type": "text",
                  "text": "INSERT INTO ... SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " operation, which is simple in terms of SQL operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure modifies certain fields during the insertion, which requires understanding of the business logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure deals with a large number of columns, which increases the complexity of maintaining and understanding the code."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UploadAccountBillingDetailSeqid dbo.seqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is used to filter the records in the "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadAccountBillingDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table. It identifies the specific record to be duplicated and modified for insertion."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by inserting a new record into the "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadAccountBillingDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It selects data from the same table where the "
                },
                {
                  "type": "text",
                  "text": "UploadAccountBillingDetailSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " matches the input parameter."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "During the insertion, several fields are modified:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "TransactionCode",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is set to 'BI'."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Financial fields such as "
                        },
                        {
                          "type": "text",
                          "text": "GasChargeAmount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "BilledCCF",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "BilledTherms",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "CommodityChargeAmount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "DeliveryChargeAmount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and various tax and charge fields are set to 0."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "IsCancelForPreviousTransaction",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is set to 'N'."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure is likely used to handle specific billing scenarios, such as orphaned cancellations, by resetting certain financial fields and flags."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The performance impact of this procedure is generally low, as it involves a single "
                },
                {
                  "type": "text",
                  "text": "INSERT INTO ... SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " operation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure's performance depends on the size of the "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadAccountBillingDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table and the efficiency of the index on "
                },
                {
                  "type": "text",
                  "text": "UploadAccountBillingDetailSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If the table is large, ensure that the "
                },
                {
                  "type": "text",
                  "text": "UploadAccountBillingDetailSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " column is indexed to optimize the "
                },
                {
                  "type": "text",
                  "text": "WHERE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " clause."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure duplicates records with modifications, which could lead to data integrity issues if not properly managed or if the logic for setting fields to zero is incorrect."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple instances of this procedure run simultaneously, there could be potential for race conditions or data inconsistencies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks error handling, which means any failure during execution could leave the database in an inconsistent state."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maintenance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The large number of columns involved makes the procedure harder to maintain, especially if the table schema changes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Business Logic Clarity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The purpose of setting specific fields to zero and the implications of changing certain flags should be well-documented to ensure that future developers understand the business logic."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [CrisNationalGridWest].[usp_Util_CRIS_InsertAccountBillingDetailForOrphanedCAncellation] @UploadAccountBillingDetailSeqid dbo.seqid AS\nBEGIN\r\ninsert  into CrisNationalGridWest.UploadAccountBillingDetail\r\n        ( UtilityCompanySeqid ,\r\n          AccountInvoiceBillingGroup ,\r\n          BillingPeriod ,\r\n          BillingPeriodRevision ,\r\n          CalculatedBillingPeriodRevision ,\r\n          FirstBillingPeriodCanceled ,\r\n          FirstNewCRISBillingPeriodRevision ,\r\n          IsSpannedBilling ,\r\n          NumberOfBillingPeriod ,\r\n          IsCurrentPeriodExchange ,\r\n          AccountNumber ,\r\n          MeterReadWorkDay ,\r\n          UtilityServiceAccountName ,\r\n          UtilityServiceAddress ,\r\n          Borough ,\r\n          Zipcode ,\r\n          State ,\r\n          ActivityCode ,\r\n          ActivityDate ,\r\n          ActivityTime ,\r\n          ActivityDateTime ,\r\n          TransactionCode ,\r\n          SpecialLedgerAccountNUmber ,\r\n          SpecialLedgerWorkDay ,\r\n          GasRateCode ,\r\n          BillFrequency ,\r\n          EstimatedOrActualBillingCode ,\r\n          GasChargeAmount ,\r\n          BillingFromDate ,\r\n          BillingToDate ,\r\n          BillRenderDate ,\r\n          BillingDays ,\r\n          BilledCCF ,\r\n          ThermFactor ,\r\n          BilledTherms ,\r\n          NumberOfMeters ,\r\n          BillType ,\r\n          CommodityChargeAmount ,\r\n          DeliveryChargeAmount ,\r\n          MTACommodityTax ,\r\n          MTADeliveryTax ,\r\n          SalesTax ,\r\n          SystemBenefitsCharge ,\r\n          RetailDecouplingMechanismCharge ,\r\n          DeliveryRateSurcharge ,\r\n          RealTimeNormalizationCharge ,\r\n          LatePaymentCharge ,\r\n          PaperBillCharge ,\r\n          CommodityCostFactor ,\r\n          MTACommodityFactor ,\r\n          MTADeliveryFactor ,\r\n          SalesTaxFactor ,\r\n          SystemBenefitChargeFactor ,\r\n          RetailDecouplingMechanismFactor ,\r\n          DeliveryRateSurchargeFactor ,\r\n          RealTimeNormalizationFactor ,\r\n          LatePaymentFactor ,\r\n          CurrentAccountBalance ,\r\n          AccountArrears ,\r\n          TerminationBalance ,\r\n          TotalPaymentsPosted ,\r\n          DateLastPayment ,\r\n          MiscellaneousChargeAmount ,\r\n          MiscellaneousChargeType ,\r\n          ExcludeAndReview ,\r\n          IsCancelForCurrentTransaction ,\r\n          IsCancelForPreviousTransaction ,\r\n          IsTransactionCancelFound ,\r\n          IsPartialCancelattionFromPriorPeriodMergedBilling ,\r\n          IsPartialRebillFromPriorPeriodMergedBilling ,\r\n          ExcludeReason ,\r\n          FireAuditTrigger ,\r\n          Notes ,\r\n          AuthenticatedUserID ,\r\n          DateAdded ,\r\n          LastUpdate\r\n        )\r\n        select  UtilityCompanySeqid ,\r\n                AccountInvoiceBillingGroup ,\r\n                BillingPeriod ,\r\n                BillingPeriodRevision ,\r\n                CalculatedBillingPeriodRevision ,\r\n                FirstBillingPeriodCanceled ,\r\n                FirstNewCRISBillingPeriodRevision ,\r\n                IsSpannedBilling ,\r\n                NumberOfBillingPeriod ,\r\n                IsCurrentPeriodExchange ,\r\n                AccountNumber ,\r\n                MeterReadWorkDay ,\r\n                UtilityServiceAccountName ,\r\n                UtilityServiceAddress ,\r\n                Borough ,\r\n                Zipcode ,\r\n                State ,\r\n                ActivityCode ,\r\n                ActivityDate ,\r\n                ActivityTime ,\r\n                ActivityDateTime ,\r\n                'BI' as TransactionCode ,\r\n                SpecialLedgerAccountNUmber ,\r\n                SpecialLedgerWorkDay ,\r\n                GasRateCode ,\r\n                BillFrequency ,\r\n                EstimatedOrActualBillingCode ,\r\n                0 as GasChargeAmount ,\r\n                BillingFromDate ,\r\n                BillingToDate ,\r\n                BillRenderDate ,\r\n                BillingDays ,\r\n                0 as BilledCCF ,\r\n                ThermFactor ,\r\n                0 as BilledTherms ,\r\n                NumberOfMeters ,\r\n                BillType ,\r\n                0 as CommodityChargeAmount ,\r\n                0 as DeliveryChargeAmount ,\r\n                0 as MTACommodityTax ,\r\n                0 as MTADeliveryTax ,\r\n                0 as SalesTax ,\r\n                0 as SystemBenefitsCharge ,\r\n                0 as RetailDecouplingMechanismCharge ,\r\n                0 as DeliveryRateSurcharge ,\r\n                0 as RealTimeNormalizationCharge ,\r\n                0 as LatePaymentCharge ,\r\n                0 as PaperBillCharge ,\r\n                CommodityCostFactor ,\r\n                MTACommodityFactor ,\r\n                MTADeliveryFactor ,\r\n                SalesTaxFactor ,\r\n                SystemBenefitChargeFactor ,\r\n                RetailDecouplingMechanismFactor ,\r\n                DeliveryRateSurchargeFactor ,\r\n                RealTimeNormalizationFactor ,\r\n                LatePaymentFactor ,\r\n                CurrentAccountBalance ,\r\n                AccountArrears ,\r\n                TerminationBalance ,\r\n                TotalPaymentsPosted ,\r\n                DateLastPayment ,\r\n                MiscellaneousChargeAmount ,\r\n                MiscellaneousChargeType ,\r\n                ExcludeAndReview ,\r\n                IsCancelForCurrentTransaction ,\r\n                'N' as IsCancelForPreviousTransaction ,\r\n                IsTransactionCancelFound ,\r\n                IsPartialCancelattionFromPriorPeriodMergedBilling ,\r\n                IsPartialRebillFromPriorPeriodMergedBilling ,\r\n                ExcludeReason ,\r\n                FireAuditTrigger ,\r\n                Notes ,\r\n                AuthenticatedUserID ,\r\n                DateAdded ,\r\n                LastUpdate\r\n        FROM CrisNationalGridWest.UploadAccountBillingDetail\r\n        where   ( UploadAccountBillingDetailSeqid = @UploadAccountBillingDetailSeqid )\r\nEND"
        }
      ]
    }
  ]
}