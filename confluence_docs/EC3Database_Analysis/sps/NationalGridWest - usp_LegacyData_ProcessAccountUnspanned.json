{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "NationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_LegacyData_ProcessAccountUnspanned",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_LegacyData_ProcessAccountUnspanned",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process legacy account data for a utility company, specifically for the National Grid West region. It moves data from a preload table to an upload table, updates certain fields based on business rules, and then inserts summarized account data into an account summary table. The procedure handles data transformation, validation, and insertion operations, ensuring that only valid and necessary data is processed."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period in the format "
                },
                {
                  "type": "text",
                  "text": "YYYYMM",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ". It is used to filter and update records based on the billing cycle."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@authenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the authenticated user executing the procedure. This is used for auditing purposes, recording who performed the data operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingCycle varchar(1)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing cycle, which is used in determining billing period revisions and cancellations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A utility code is set to '2', which is used later in the account summary insertion."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Movement",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Data is moved from "
                        },
                        {
                          "type": "text",
                          "text": "UploadLegacyNationalGridWestDataPreload",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to "
                        },
                        {
                          "type": "text",
                          "text": "UploadLegacyKeyspanWestAccount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The data transformation includes converting legacy account numbers, dates, and overpunched numeric values to a standardized format."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Only records with a positive billed amount are considered."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure updates the "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriodRevision",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "FirstPeriodCanceled",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " fields using a custom function "
                        },
                        {
                          "type": "text",
                          "text": "DetermineBillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It ensures that these fields do not exceed the current billing period."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The "
                        },
                        {
                          "type": "text",
                          "text": "DeltaNumberOfPeriods",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is calculated for valid billing periods using the "
                        },
                        {
                          "type": "text",
                          "text": "CalculateDeltaBillingPeriods",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " function."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Summarized data is inserted into "
                        },
                        {
                          "type": "text",
                          "text": "UploadLegacyKeyspanWestAccountSummary",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The insertion includes various fields such as account numbers, billing periods, transaction counts, and energy usage metrics."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure uses current date functions for auditing fields like "
                        },
                        {
                          "type": "text",
                          "text": "DateAdded",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "LastUpdate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the tables involved have appropriate indexes on columns used in WHERE clauses and JOIN operations to optimize query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the preload table contains a large volume of data, consider processing in batches to avoid locking and resource contention."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure relies heavily on user-defined functions for data conversion and calculation. These functions should be optimized for performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in the preload table is correctly formatted and valid. Any discrepancies in data format could lead to errors or incorrect data processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling. Consider adding TRY-CATCH blocks to manage exceptions and log errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple instances of this procedure run simultaneously, there could be issues with data consistency and locking. Implementing transaction isolation levels or row versioning could mitigate this."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the performance of the procedure may degrade. Regular monitoring and optimization of the underlying queries and functions will be necessary."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [NationalGridWest].[usp_LegacyData_ProcessAccountUnspanned] \r\n\t@BillingPeriod varchar(6),\r\n\t@authenticatedID int,\r\n\t@BillingCycle varchar(1)\r\nAS\r\nBEGIN\r\n\t\r\ndeclare @UtilityCode varchar(1)\r\nset @UtilityCode = '2'\r\n\r\n/******************************************************* \r\n\t1. move account data from preload to upload table\r\n**********************************************************/\r\n\r\n\tinsert into\r\n\tNationalGridWest.UploadLegacyKeyspanWestAccount\r\n\t(\r\n\t\t[BillingPeriod]\r\n\t   ,[BillingPeriodRevision]\r\n\t   ,[FirstPeriodCanceled]\r\n\t   ,[DeltaNumberOfPeriods]\r\n\t   ,[RecordType]\r\n\t   ,[AccountNumber]\r\n\t   ,[FacilityName]\r\n\t   ,[ServiceAddress]\r\n\t   ,[FromDate]\r\n\t   ,[ToDate]\r\n\t   ,[BillingPeriodDays]\r\n\t   ,[CCF]\r\n\t   ,[BilledAmount]\r\n\t   ,[PreviousBalance]\r\n\t   ,[Therms]\r\n\t   ,[ThermFactor]\r\n\t   ,[TariffCode]\r\n\t   ,[Dials]\r\n\t   ,[FiscalYear]\r\n\t   ,[PostingDate]\r\n\t   ,[EstimatedOrActual]\r\n\t   ,AuthenticatedUserID\r\n\t   ,DateAdded\r\n\t   ,LastUpdate\t\t\r\n\t)\r\n\tSELECT\r\n\t\t[BillingPeriod]\r\n\t\t,null as [BillingPeriodRevision]\r\n\t\t,null as [FirstPeriodCanceled]\r\n\t\t,null as [DeltaNumberOfPeriods]\r\n\t\t,null as [RecordType]\r\n\t\t,dbo.KeyspanConvertLegacyAccountToEC3Number(dbo.KeyspanConvertCancellationAccountNumber([KeyspanOldAccountNumber],BilledAmount)) as EC3AccountNumber\r\n\t\t,[UtilityServiceAccountName] as FacilityName\r\n\t\t,[UtilityServiceAddress] as ServiceAddress\r\n\t\t,dbo.MMDDYKeyspanToYYYYMMDD(FromDateMMDDY) as FromDate\r\n\t\t,dbo.MMDDYKeyspanToYYYYMMDD(ToDateMMDDY) as ToDate\r\n\t\t,cast(dbo.ConvertOverpunch(NumberOfBillingDays) as int) as NumberOfBillingDays\r\n\t\t,cast(dbo.ConvertOverpunch(CCF) as int) as CCF\r\n\t\t,dbo.ConvertOverpunch9ToMoney(BilledAmount) as BilledAmount\r\n\t\t,null as PreviousBalance\r\n\t\t,cast(dbo.ConvertOverpunch(Therms) as int) as Therms\r\n\t\t,cast(dbo.ConvertOverpunch5ToDecimal(ThermsFactor) as numeric(6,4)) as ThermsFactor\r\n\t\t,null as TariffCode\r\n\t\t,cast(NumberOfDials as int) as [Dials]\r\n\t\t,null as FiscalYear\r\n\t\t,null as PostingDate\r\n\t\t,(case when EstimatedOrActualBillingCode = 'ES' then 'EST' else 'ACT' end)\r\n\t\t,@authenticatedID\r\n\t\t,getdate()\r\n\t\t,getdate()\r\n\t  FROM [NationalGridWest].[UploadLegacyNationalGridWestDataPreload]\r\n\t\twhere cast(dbo.ConvertOverpunch(BilledAmount) as money) > 0 -- billed amount must be positive for non-cancel record\r\n\t  \r\n\t/*\r\n\t\tfill account data based on available data\r\n\t*/\r\n\r\n\t-- update revision biling period\r\n\tupdate NationalGridWest.UploadLegacyKeyspanWestAccount\r\n\tset \r\n\t\tBillingPeriodRevision = NationalGridWest.DetermineBillingPeriod(@BillingCycle, ToDate, 'T', substring(AccountNumber, 12, 2)),\r\n\t\tFirstPeriodCanceled = NationalGridWest.DetermineBillingPeriod(@BillingCycle, FromDate, 'F', substring(AccountNumber, 12, 2))\r\n\r\n\tUPDATE NationalGridWest.UploadLegacyKeyspanWestAccount\r\n\tSET\r\n\t\tBillingPeriodRevision = CASE WHEN BillingPeriodRevision>@BillingPeriod THEN @BillingPeriod ELSE BillingPeriodRevision end,\r\n\t\tFirstPeriodCanceled = CASE WHEN FirstPeriodCanceled>@BillingPeriod THEN @BillingPeriod else\tFirstPeriodCanceled\tEND\r\n\r\n\t-- update number of period. ignore account with invalid billing period\r\n\tupdate NationalGridWest.UploadLegacyKeyspanWestAccount\r\n\tset DeltaNumberOfPeriods = [dbo].[CalculateDeltaBillingPeriods](FirstPeriodCanceled, BillingPeriodRevision, @BillingCycle)\r\n\twhere not(BillingPeriodRevision like 'X%' or FirstPeriodCanceled like 'X%')\r\n\r\n\t\t\r\n/*************************************\r\n2. Process KeyspanWest Account Summary\r\n*******************************/\r\n\r\nINSERT INTO [NationalGridWest].[UploadLegacyKeyspanWestAccountSummary]\r\n           ([AdjustedAccount]\r\n           ,[AccountUtilityCompanySeqid]\r\n           ,[CurrentInvoiceAccountBillingGroup]\r\n           ,[NumberOfTransactions]\r\n           ,[NumberOfRebillTransactions]\r\n           ,[NumberOfCancelTransactions]\r\n           ,[OriginalAccountNumber]\r\n           ,[BillingPeriod]\r\n           ,[BillingPeriodRevision]\r\n           ,[FirstCanceledBillingPeriod]\r\n           ,[EstimatedOrActualBilling]\r\n           ,[InitialCancelFromDate]\r\n           ,[CurrentBillingToDate]\r\n           ,[NumberOfBillingPeriods]\r\n           ,[TotalBillingDaysRebilled]\r\n           ,[TotalRebilledAmount]\r\n           ,[TotalCanceledAmount]\r\n           ,[PriorRevisedBilledAmount]\r\n           ,[RevisedBilledAmount]\r\n           ,[CanceledBilledAmount]\r\n           ,[AverageRebillCostOfGasCharge]\r\n           ,[AverageRebillThermsFactor]\r\n           ,[BillingDays]\r\n           ,[BillingDate]\r\n           ,[ToDate]\r\n           ,[FromDate]\r\n           ,[BillingAction]\r\n           ,[ProcessedInTheCurrentPeriod]\r\n           ,[GasRateCode]\r\n           ,[TotalCCF]\r\n           ,[TotalTherms]\r\n           ,[ThermsFactor]\r\n           ,[CancelFromDate]\r\n           ,[CancelToDate]\r\n           ,[CancelTotalCCF]\r\n           ,[CancelTotalTherms]\r\n           ,[CancelThermsFactor]\r\n           ,[ProcessEffectiveDate]\r\n           ,[DerivedFromSpannedBill]\r\n           ,[SpannedBillingPeriodRevision]\r\n           ,[SpannedFirstCanceledBillingPeriod]\r\n           ,[SpannedBilledAmount]\r\n           ,[SpannedCCF]\r\n           ,[SpannedThermFactor]\r\n           ,[SpannedTherm]\r\n           ,[SpannedMonthlyPercentage]\r\n           ,[SpannedTotalPercentage]\r\n           ,[Notes]\r\n           ,[AuthenticatedUserID]\r\n           ,[DateAdded]\r\n           ,[LastUpdate]\r\n           ,[MTATaxAmount]\r\n           ,[BilledAmount]\r\n           ,[DeliveryChargeAmount]\r\n           ,[ThermsChargeAmount]\r\n           ,[DiscountedAmount]\r\n           ,[DiscountPercentage]\r\n           ,[CustomerMinimumCharge]\r\n           ,[CostOfGasCharge]\r\n           ,[SpecialCharge]\r\n           ,[SomeCharge]\r\n           ,[CancelDeliveryChargeAmount]\r\n           ,[CancelThermsChargeAmount]\r\n           ,[CancelDiscountedAmount]\r\n           ,[CancelDiscountPercentage]\r\n           ,[CancelCustomerMinimumCharge]\r\n           ,[CancelCostOfGasCharge]\r\n           ,[CancelSpecialCharge]\r\n           ,[CancelSomeCharge]\r\n           ,FacilityName\r\n           ,serviceAddress\r\n           )\r\n     select\r\n           null -- <AdjustedAccount, seqid,>\r\n           ,@UtilityCode --<AccountUtilityCompanySeqid, seqid,>\r\n           ,null -- <CurrentInvoiceAccountBillingGroup, seqid,>\r\n           ,1 --<NumberOfTransactions, Accumulator,>\r\n           ,1 --<NumberOfRebillTransactions, Accumulator,>\r\n           ,0 --<NumberOfCancelTransactions, Accumulator,>\r\n           ,AccountNumber --<OriginalAccountNumber, acctnum,>\r\n           ,BillingPeriod --<BillingPeriod, yyyymm,>\r\n           ,BillingPeriodRevision --<BillingPeriodRevision, yyyymm,>\r\n           ,FirstPeriodCanceled --<FirstCanceledBillingPeriod, yyyymm,>\r\n           ,EstimatedOrActual --<EstimatedOrActualBilling, EstimatedReading,>\r\n           ,null --<InitialCancelFromDate, yyyymmdd,>\r\n           ,null --<CurrentBillingToDate, yyyymmdd,>\r\n           ,DeltaNumberOfPeriods --<NumberOfBillingPeriods, Accumulator,>\r\n           ,BillingPeriodDays --<TotalBillingDaysRebilled, Accumulator,>\r\n           ,BilledAmount --<TotalRebilledAmount, BillingAmt,>\r\n           ,0 --<TotalCanceledAmount, BillingAmt,>\r\n           ,null -- <PriorRevisedBilledAmount, BillingAmt,>\r\n           ,null -- <RevisedBilledAmount, BillingAmt,>\r\n           ,null -- <CanceledBilledAmount, BillingAmt,>\r\n           ,null -- <AverageRebillCostOfGasCharge, BillingAmt,>\r\n           ,ThermFactor --<AverageRebillThermsFactor, ThermsFactor,>\r\n           ,BillingPeriodDays --<BillingDays, Accumulator,>\r\n           ,null --<BillingDate, BillingDate,>\r\n           ,ToDate --<ToDate, yyyymmdd,>\r\n           ,FromDate --<FromDate, yyyymmdd,>\r\n           ,CASE WHEN BillingPeriod=BillingPeriodRevision THEN 'O' ELSE 'A' END -- ,<BillingAction, BillingAction,>\r\n           ,'N' --<ProcessedInTheCurrentPeriod, yesnoWithDefaultNo,>\r\n           ,TariffCode --<GasRateCode, GasRateCode,>\r\n           ,CCF --<TotalCCF, EnergyUnit,>\r\n           ,Therms --<TotalTherms, EnergyUnit,>\r\n           ,ThermFactor --<ThermsFactor, ThermsFactor,>\r\n           ,null --<CancelFromDate, yyyymmdd,>\r\n           ,null --<CancelToDate, yyyymmdd,>\r\n           ,null --<CancelTotalCCF, EnergyUnit,>\r\n           ,null --<CancelTotalTherms, EnergyUnit,>\r\n           ,null --<CancelThermsFactor, ThermsFactor,\r\n           ,dbo.ConvertDateToYYYYMMDD (GETDATE()) --<ProcessEffectiveDate, yyyymmdd,>\r\n           ,null --<DerivedFromSpannedBill, yesnoWithDefaultNo,>\r\n           ,null --<SpannedBillingPeriodRevision, yyyymm,>\r\n           ,null --<SpannedFirstCanceledBillingPeriod, yyyymm,>\r\n           ,null --<SpannedBilledAmount, BillingAmt,>\r\n           ,null --<SpannedCCF, EnergyUnit,>\r\n           ,null --<SpannedThermFactor, ThermsFactor,>\r\n           ,null --<SpannedTherm, EnergyUnit,>\r\n           ,null --<SpannedMonthlyPercentage, SpannedPercentage,>\r\n           ,null --<SpannedTotalPercentage, SpannedPercentage,>\r\n           ,null --<Notes, notes,>\r\n           ,@authenticatedID --<AuthenticatedUserID, AuthenticatedUserID,>\r\n           ,getdate() --<DateAdded, DateAdded,>\r\n           ,getdate() --<LastUpdate, LastUpdate,>\r\n           ,0 -- <MTATaxAmount, BillingAmt,>\r\n           ,BilledAmount --<BilledAmount, BillingAmt,>\r\n           ,0 --<DeliveryChargeAmount, BillingAmt,>\r\n           ,0 --<ThermsChargeAmount, BillingAmt,>\r\n           ,0 --<DiscountedAmount, BillingAmt,>\r\n           ,0 --<DiscountPercentage, DiscountPercentage,>\r\n           ,0 --<CustomerMinimumCharge, BillingAmt,>\r\n           ,null --<CostOfGasCharge, BillingAmt,>\r\n           ,0 --<SpecialCharge, BillingAmt,>\r\n           ,0 --<SomeCharge, BillingAmt,>\r\n           ,null --<CancelDeliveryChargeAmount, BillingAmt,>\r\n           ,null --<CancelThermsChargeAmount, BillingAmt,>\r\n           ,null --<CancelDiscountedAmount, BillingAmt,>\r\n           ,null --<CancelDiscountPercentage, DiscountPercentage,>\r\n           ,null --<CancelCustomerMinimumCharge, BillingAmt,>\r\n           ,null --<CancelCostOfGasCharge, BillingAmt,>\r\n           ,null --<CancelSpecialCharge, BillingAmt,>\r\n           ,null --<CancelSomeCharge, BillingAmt,>*/\r\n           ,FacilityName\r\n           ,serviceAddress\r\n\tfrom NationalGridWest.UploadLegacyKeyspanWestAccount\r\n\twhere DeltaNumberOfPeriods <= 1\r\n\r\n\r\n\r\n\r\nEND"
        }
      ]
    }
  ]
}