{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_CRIS_ProcessMeterMoveDataToBilling",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_CRIS_ProcessMeterMoveDataToBilling",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process meter adjustment records and transfer them to the billing system. It performs a series of data manipulations, including inserting, updating, and referencing records across multiple tables within the "
        },
        {
          "type": "text",
          "text": "Billing",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " schema. The procedure handles data related to meter readings, billing periods, and adjustments, ensuring that the billing tables reflect the latest meter data adjustments. It also includes error handling to manage transaction failures."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is high due to several factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple SQL operations (INSERT, UPDATE) across different tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses transactions to ensure data integrity."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes error handling with custom error messages."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves complex business logic with multiple conditions and calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It interacts with multiple tables and requires maintaining referential integrity."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period for which the data is being processed. It is used to filter and update records specific to this period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the authenticated user executing the procedure. It is used for auditing purposes, recording who made changes to the data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter used to indicate the success or failure of the procedure. A value of 0 indicates success, while 1 indicates an error occurred."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Declares local variables and sets the billing cycle to 'M'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Start",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Begins a transaction named "
                },
                {
                  "type": "text",
                  "text": "MoveDataToBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Inserts records from "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadMeterBillingAdjustment",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " into "
                },
                {
                  "type": "text",
                  "text": "Billing.MeterBillingAdjustmentCrisGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates existing records in "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBilling",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " using data from "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBillingAdjustmentCrisGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates existing records in "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBillingCrisGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " similarly."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion for New Records",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts new records into "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBilling",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " where no existing "
                        },
                        {
                          "type": "text",
                          "text": "MeterBillingSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is found."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts new records into "
                        },
                        {
                          "type": "text",
                          "text": "Billing.MeterBillingCrisGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " where no existing "
                        },
                        {
                          "type": "text",
                          "text": "MeterBillingCrisGasSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is found."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Reference Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Updates references in "
                },
                {
                  "type": "text",
                  "text": "Billing.MeterBillingAdjustmentCrisGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to link with newly inserted or updated records in "
                },
                {
                  "type": "text",
                  "text": "Billing.MeterBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "Billing.MeterBillingCrisGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Commit",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Commits the transaction if all operations succeed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Catches errors, logs detailed error messages, sets the "
                },
                {
                  "type": "text",
                  "text": "@StatusCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to 1, and rolls back the transaction if any error occurs."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Management",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of transactions ensures data integrity but can lock resources, potentially leading to contention in high-concurrency environments."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Bulk Operations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs bulk inserts and updates, which can be resource-intensive. Indexes on the involved tables should be optimized to handle these operations efficiently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of scalar functions like "
                },
                {
                  "type": "text",
                  "text": "CalculateConsecutiveNumberOfEstimatedReadings",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "CalculateNextBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can impact performance if not optimized, especially when called for each row in large datasets."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While the procedure includes error handling, the custom error message construction could lead to issues if not all variables are properly initialized or if the error message exceeds the maximum length."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in "
                },
                {
                  "type": "text",
                  "text": "CrisNationalGridWest.UploadMeterBillingAdjustment",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is accurate and complete. Any discrepancies could lead to incorrect billing data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure's transaction scope could lead to locking issues, especially if the tables are accessed concurrently by other processes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of this procedure may degrade if not properly indexed or if the server resources are insufficient."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Audit Trail",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure sets "
                },
                {
                  "type": "text",
                  "text": "FireAuditTrigger",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to 'Y' or 'N', which may not be sufficient for a comprehensive audit trail if additional details are required for compliance or troubleshooting."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [CrisNationalGridWest].[usp_CRIS_ProcessMeterMoveDataToBilling]\n\t@BillingPeriod varchar(6),\r\n\t@AuthenticatedID int,\r\n\t@StatusCode int  OUTPUT      \r\n   \r\n AS \r\n BEGIN\r\n\t\t--**************************************************************************************************************\r\n\t\t--\tAuthor: MOHAMMED BELARREM\r\n\t\t--\tDescription:\tCopy over the adjutment records to the billing side and do the necessary updates and inserts \r\n\t\t-- \t\t\t\t\tto the MeterBilling and MeterBillingCrisGas tables\r\n\t\t--\r\n\t\t--\tLog: \r\n\t\t--\t\t06/08/2010\tMOH\tCreation\r\n\t\t--\t\t06/15/2010\tMOH\tUpdate: Added therms, thermsFactor and GasRateCode\r\n\t\t--\t\t07/09/2010\tMOH\tUpdate: Added CurrentMeterNumber and updated the adjustment part tp add not replace\r\n\t\t--\t\t07/23/2010\tMOH\tUpdate: Corrected the MeterType to fit it into the varchar(1) in the meterbilling\r\n\t\t--\t\t\t\t\t\t\t\tTruncate the adjustment table before anything\r\n\t\t--\t\t07/30/2010  MOH\tUpdate:\tAdded condition to the queried that update the adjustment table with references to the MB and MBCG\t\r\n\t\t--\t\t07/30/2010\tMOH\tUpdate: Corrected BillingPeriod inserted to MeterBilling and MeterBillingCrisGas\t\r\n\t\t--\t\t09/10/2010\tMOH Update: Corrected the reference update queries\r\n\t\t--\t\t10/29/2010  MOH Update: Added FireAuditTrigger in the updates\r\n\t\t--\t\t01/11/2010  MOH Update: Added the condition to test and pickup only non excluded transaction\r\n\t\t--\t\t11/19/2013  MOH Update: Modified MeterBillingRowState to be varchar(1) instead of int\r\n\t\t--      12/11/2018  VY  Update: Modified for UniqueAccountSeqID and UniqueMeterSeqID\r\n\t\t--      12/19/2018  VY  Update: Modified to insert UniqueAccountSeqID and UniqueMeterSeqID in Billing.MeterBilling \r\n\t\t--**************************************************************************************************************\r\n\t \r\n\t\t--**************************************************************************************************************\r\n\t\tDECLARE @AccountNumber acctnum\r\n\t\tDECLARE @MeterNumber MeterNumber\r\n\t\tDECLARE @BillingCycle VARCHAR(1)\r\n\r\n\t\tdeclare @crlf varchar(2)\r\n\t\tset @crlf = CHAR(13) + CHAR(10)\r\n\t\t\r\n\t\tSET @BillingCycle = 'M' \r\n\r\n\t\r\n\t\t\t\r\n\t\tbegin try\t\r\n\t\t\r\n\r\n\t\t\t\tbegin TRANSACTION MoveDataToBilling\r\n\t\t\t\tset @StatusCode  = 0\r\n\t\t\t\t\r\n\t\t\t\t-- copy over the transactions to the billing side\r\n\t\t\t\tINSERT INTO [Billing].[MeterBillingAdjustmentCrisGas]\r\n\t\t\t\t\t\t   ([UtilityCompanySeqid]\r\n\t\t\t\t\t\t   ,[AccountInvoiceBillingGroup]\r\n\t\t\t\t\t\t   ,[MeterBillingSeqid]\r\n\t\t\t\t\t\t   ,[MeterBillingCrisGasSeqid]\r\n\t\t\t\t\t\t   ,[AccountSeqid]\r\n\t\t\t\t\t\t   ,[UniqueAccountSeqid] /* added 12/11/2018 */\r\n\t\t\t\t\t\t   ,[MeterSeqid]\r\n\t\t\t\t\t\t   ,[UniqueMeterSeqid] /* added 12/11/2018 */\r\n\t\t\t\t\t\t   ,[AccountExchangeMeterTrackSeqid]\r\n\t\t\t\t\t\t   ,[NumberOfTransactions]\r\n\t\t\t\t\t\t   ,[NumberOfRebillTransactions]\r\n\t\t\t\t\t\t   ,[NumberOfCancelTransactions]\r\n\t\t\t\t\t\t   ,[BillingPeriod]\r\n\t\t\t\t\t\t   ,[BillingPeriodRevision]\r\n\t\t\t\t\t\t   ,[OriginalAccountNumber]\r\n\t\t\t\t\t\t   ,[MeterReadWorkDay]\r\n\t\t\t\t\t\t   ,[UtilityServiceAccountName]\r\n\t\t\t\t\t\t   ,[UtilityServiceAddress]\r\n\t\t\t\t\t\t   ,[Borough]\r\n\t\t\t\t\t\t   ,[Zipcode]\r\n\t\t\t\t\t\t   ,[State]\r\n\t\t\t\t\t\t   ,[SpecialLedgerAccountNumber]\r\n\t\t\t\t\t\t   ,[MeterNumber]\r\n\t\t\t\t\t\t   ,[CurrentMeterNumber]\r\n\t\t\t\t\t\t   ,[MeterConstant]\r\n\t\t\t\t\t\t   ,[NumberOfDials]\r\n\t\t\t\t\t\t   ,[EstimatedOrActual]\r\n\t\t\t\t\t\t   ,[MeterType]\r\n\t\t\t\t\t\t   ,[FromDate]\r\n\t\t\t\t\t\t   ,[ToDate]\r\n\t\t\t\t\t\t   ,[BillingPeriodDays]\r\n\t\t\t\t\t\t   ,[MeterFromReading]\r\n\t\t\t\t\t\t   ,[MeterToReading]\r\n\t\t\t\t\t\t   ,[MeterCCF]\r\n\t\t\t\t\t\t   ,Therms\r\n\t\t\t\t\t\t   ,ThermsFactor\r\n\t\t\t\t\t\t   ,GasRateCode\r\n\t\t\t\t\t\t   ,HasMeterRolledOver\r\n\t\t\t\t\t\t   ,[FixFactor]\r\n\t\t\t\t\t\t   ,[PartSupplied]\r\n\t\t\t\t\t\t   ,[MeterBillingStatus]\r\n\t\t\t\t\t\t   ,[PreviousMeterBillingStatus]\r\n\t\t\t\t\t\t   ,[MeterBillingStatusCodePeriod]\r\n\t\t\t\t\t\t   ,DerivedFromSpannedBill\r\n\t\t\t\t\t\t   ,[SpannedMeterCCF]\r\n\t\t\t\t\t\t   ,SpannedTherms\r\n\t\t\t\t\t\t   ,SpannedThermsFactor\r\n\t\t\t\t\t\t   ,[SpannedFromDate]\r\n\t\t\t\t\t\t   ,[SpannedToDate]\r\n\t\t\t\t\t\t   ,[SpannedMeterReadingFrom]\r\n\t\t\t\t\t\t   ,[SpannedMeterReadingTo]\r\n\t\t\t\t\t\t   ,[SpannedMonthlyPercentage]\r\n\t\t\t\t\t\t   ,[SpannedTotalPercentage]\r\n\t\t\t\t\t\t   ,[CancelSpecialLedgerAccountNumber]\r\n\t\t\t\t\t\t   ,[CancelMeterNumber]\r\n\t\t\t\t\t\t   ,[CancelMeterConstant]\r\n\t\t\t\t\t\t   ,[CancelNumberOfDials]\r\n\t\t\t\t\t\t   ,[CancelEstimatedOrActual]\r\n\t\t\t\t\t\t   ,[CancelMeterType]\r\n\t\t\t\t\t\t   ,[CancelFromDate]\r\n\t\t\t\t\t\t   ,[CancelToDate]\r\n\t\t\t\t\t\t   ,[CancelMeterFromReading]\r\n\t\t\t\t\t\t   ,[CancelMeterToReading]\r\n\t\t\t\t\t\t   ,[CancelMeterCCF]\r\n\t\t\t\t\t\t   ,CancelTherms\r\n\t\t\t\t\t\t   ,CancelThermsFactor\r\n\t\t\t\t\t\t   ,[CancelFixFactor]\r\n\t\t\t\t\t\t   ,[CancelPartSupplied]\r\n\t\t\t\t\t\t   ,[EnergySource]\r\n\t\t\t\t\t\t   ,[MeterReset]\r\n\t\t\t\t\t\t   ,[Notes]\r\n\t\t\t\t\t\t   ,FireAuditTrigger\r\n\t\t\t\t\t\t   ,[AuthenticatedUserID]\r\n\t\t\t\t\t\t   ,[DateAdded]\r\n\t\t\t\t\t\t   ,[LastUpdate])\r\n\t\t\t\t\t\t   \r\n\t\t\t\tSELECT\t\t[UtilityCompanySeqid]                   --- [UtilityCompanySeqid]\r\n\t\t\t\t\t\t   ,[AccountInvoiceBillingGroup]            --- [AccountInvoiceBillingGroup]\r\n\t\t\t\t\t\t   ,MeterBillingSeqid\t\t\t\t\t\t--- [MeterBillingSeqid]\r\n\t\t\t\t\t\t   ,MeterBillingCrisGasSeqid\t\t\t\t--- [MeterBillingCrisGasSeqid]\r\n\t\t\t\t\t\t   ,[AccountSeqid]\t\t\t\t\t\t\t--- [AccountSeqid]\r\n\t\t\t\t\t\t   ,[UniqueAccountSeqid]                    --- [UniqueAccountSeqid] /* added 12/11/2018 */\r\n\t\t\t\t\t\t   ,[MeterSeqid]                            --- [MeterSeqid]\r\n\t\t\t\t\t\t   ,[UniqueMeterSeqid]                      --- [UniqueMeterSeqid] /* added 12/11/2018 */\r\n\t\t\t\t\t\t   ,[AccountExchangeMeterTrackSeqid]        --- [AccountExchangeMeterTrackSeqid]\r\n\t\t\t\t\t\t   ,[NumberOfTransactions]                  --- [NumberOfTransactions]\r\n\t\t\t\t\t\t   ,[NumberOfRebillTransactions]            --- [NumberOfRebillTransactions]\r\n\t\t\t\t\t\t   ,[NumberOfCancelTransactions]            --- [NumberOfCancelTransactions]\r\n\t\t\t\t\t\t   ,[BillingPeriod]                       \t--- [BillingPeriod]\r\n\t\t\t\t\t\t   ,[BillingPeriodRevision]               \t--- [BillingPeriodRevision]\r\n\t\t\t\t\t\t   ,[OriginalAccountNumber]               \t--- [OriginalAccountNumber]\r\n\t\t\t\t\t\t   ,[MeterReadWorkDay]                    \t--- [MeterReadWorkDay]\r\n\t\t\t\t\t\t   ,[UtilityServiceAccountName]           \t--- [UtilityServiceAccountName]\r\n\t\t\t\t\t\t   ,[UtilityServiceAddress]               \t--- [UtilityServiceAddress]\r\n\t\t\t\t\t\t   ,[Borough]                             \t--- [Borough]\r\n\t\t\t\t\t\t   ,[Zipcode]                             \t--- [Zipcode]\r\n\t\t\t\t\t\t   ,[State]                               \t--- [State]\r\n\t\t\t\t\t\t   ,[SpecialLedgerAccountNumber]          \t--- [SpecialLedgerAccountNumber]\r\n\t\t\t\t\t\t   ,[MeterNumber]                         \t--- [MeterNumber]\r\n\t\t\t\t\t\t   ,[CurrentMeterNumber]\t\t\t\t\t--- CurrentMeterNumber\r\n\t\t\t\t\t\t   ,[MeterConstant]                       \t--- [MeterConstant]\r\n\t\t\t\t\t\t   ,[NumberOfDials]                       \t--- [NumberOfDials]\r\n\t\t\t\t\t\t   ,[EstimatedOrActual]                   \t--- [EstimatedOrActual]\r\n\t\t\t\t\t\t   ,[MeterType]                           \t--- [MeterType]\r\n\t\t\t\t\t\t   ,[FromDate]                            \t--- [FromDate]\r\n\t\t\t\t\t\t   ,[ToDate]                              \t--- [ToDate]\r\n\t\t\t\t\t\t   ,[BillingPeriodDays]                   \t--- [BillingPeriodDays]\r\n\t\t\t\t\t\t   ,[MeterFromReading]                    \t--- [MeterFromReading]\r\n\t\t\t\t\t\t   ,[MeterToReading]                      \t--- [MeterToReading]\r\n\t\t\t\t\t\t   ,[MeterCCF]                           \t--- [MeterCCF]\r\n\t\t\t\t\t\t   ,Therms\t\t\t\t\t\t\t\t\t--- therms\r\n\t\t\t\t\t\t   ,ThermsFactor\t\t\t\t\t\t\t--- thermsFactor\r\n\t\t\t\t\t\t   ,GasRateCode\t\t\t\t\t\t\t\t--- GasRateCode\r\n\t\t\t\t\t\t   ,HasMeterRolledOver\t\t\t\t\t\t--- HasMeterRolledOver\t\r\n\t\t\t\t\t\t   ,[FixFactor]                          \t--- [FixFactor]\r\n\t\t\t\t\t\t   ,[PartSupplied]                       \t--- [PartSupplied]\r\n\t\t\t\t\t\t   ,[MeterBillingStatus]                 \t--- [MeterBillingStatus]\r\n\t\t\t\t\t\t   ,[PreviousMeterBillingStatus]         \t--- [PreviousMeterBillingStatus]\r\n\t\t\t\t\t\t   ,[MeterBillingStatusCodePeriod]       \t--- [MeterBillingStatusCodePeriod]\r\n\t\t\t\t\t\t   ,DerivedFromSpannedBill\t\t\t\t\t--- DerivedFromSpannedBill\r\n\t\t\t\t\t\t   ,[SpannedMeterCCF]                    \t--- [SpannedMeterCCF]\r\n\t\t\t\t\t\t   ,SpannedTherms\t\t\t\t\t\t\t--- spannedTherms\r\n\t\t\t\t\t\t   ,SpannedThermsFactor\t\t\t\t\t\t--- SpannedThermsFactor\r\n\t\t\t\t\t\t   ,[SpannedFromDate]                    \t--- [SpannedFromDate]\r\n\t\t\t\t\t\t   ,[SpannedToDate]                      \t--- [SpannedToDate]\r\n\t\t\t\t\t\t   ,[SpannedMeterReadingFrom]            \t--- [SpannedMeterReadingFrom]\r\n\t\t\t\t\t\t   ,[SpannedMeterReadingTo]              \t--- [SpannedMeterReadingTo]\r\n\t\t\t\t\t\t   ,[SpannedMonthlyPercentage]\t\t\t\t--- [SpannedMonthlyPercentage]\r\n\t\t\t\t\t\t   ,[SpannedTotalPercentage]\t\t\t\t--- [SpannedTotalPercentage]\r\n\t\t\t\t\t\t   ,[CancelSpecialLedgerAccountNumber]\t\t--- [CancelSpecialLedgerAccountNumber]\r\n\t\t\t\t\t\t   ,[CancelMeterNumber]\t\t\t\t\t\t--- [CancelMeterNumber]\r\n\t\t\t\t\t\t   ,[CancelMeterConstant]\t\t\t\t\t--- [CancelMeterConstant]\r\n\t\t\t\t\t\t   ,[CancelNumberOfDials]\t\t\t\t\t--- [CancelNumberOfDials]\r\n\t\t\t\t\t\t   ,[CancelEstimatedOrActual]\t\t\t\t--- [CancelEstimatedOrActual]\r\n\t\t\t\t\t\t   ,[CancelMeterType]\t\t\t\t\t\t--- [CancelMeterType]\r\n\t\t\t\t\t\t   ,[CancelFromDate]\t\t\t\t\t\t--- [CancelFromDate]\r\n\t\t\t\t\t\t   ,[CancelToDate]\t\t\t\t\t\t\t--- [CancelToDate]\r\n\t\t\t\t\t\t   ,[CancelMeterFromReading]\t\t\t\t--- [CancelMeterFromReading]\r\n\t\t\t\t\t\t   ,[CancelMeterToReading]\t\t\t\t\t--- [CancelMeterToReading]\r\n\t\t\t\t\t\t   ,[CancelMeterCCF]\t\t\t\t\t\t--- [CancelMeterCCF]\r\n\t\t\t\t\t\t   ,CancelTherms\t\t\t\t\t\t\t--- cancelTherms\r\n\t\t\t\t\t\t   ,CancelThermsFactor\t\t\t\t\t\t--- cancelThermsFactor\r\n\t\t\t\t\t\t   ,[CancelFixFactor]\t\t\t\t\t\t--- [CancelFixFactor]\r\n\t\t\t\t\t\t   ,[CancelPartSupplied]\t\t\t\t\t--- [CancelPartSupplied]\r\n\t\t\t\t\t\t   ,[EnergySource]\t\t\t\t\t\t\t--- [EnergySource]\r\n\t\t\t\t\t\t   ,[MeterReset]\t\t\t\t\t\t\t--- [MeterReset]\r\n\t\t\t\t\t\t   ,null                                    --- [Notes]\r\n\t\t\t\t\t\t   ,'N'\t\t\t\t\t\t\t\t\t\t--- FireAuditTrigger\r\n\t\t\t\t\t\t   ,@AuthenticatedID                        --- [AuthenticatedUserID]\r\n\t\t\t\t\t\t   ,GETDATE()                               --- [DateAdded]\r\n\t\t\t\t\t\t   ,GETDATE()                               --- [LastUpdate])\r\n\r\n\t\t\t\t\t  FROM [CrisNationalGridWest].[UploadMeterBillingAdjustment]\r\n\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\t-- update MeterBilling\r\n\t\t\t\t\tUPDATE    Billing.MeterBilling\r\n\t\t\t\t\tSET              \r\n\t\t\t\t\t\t\t IsDerived\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.DerivedFromSpannedBill\r\n\t\t\t\t\t\t\t,UploadFileSeqid\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterBillingAdjustmentCrisGasSeqid \r\n\t\t\t\t\t\t\t,LastPeriodModified\t\t\t\t= @BillingPeriod\r\n\t\t\t\t\t\t\t,MeterBillingStatus\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterBillingStatus \r\n\t\t\t\t\t\t\t,PreviousMeterBillingStatus\t\t= Billing.MeterBillingAdjustmentCrisGas.PreviousMeterBillingStatus\r\n\t\t\t\t\t\t\t,MeterBillingStatusCodePeriod\t= Billing.MeterBillingAdjustmentCrisGas.MeterBillingStatusCodePeriod \r\n\t\t\t\t\t\t\t,EstimatedReading\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.EstimatedOrActual\r\n\t\t\t\t\t\t\t,ConsecutivePeriodsEstimatedReading = [Common].[CalculateConsecutiveNumberOfEstimatedReadings]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(\tBilling.MeterBilling.OriginalAccountNumber, \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tBilling.MeterBilling.OriginalMeterNumber, \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tBilling.MeterBilling.AccountUtilityCompanySeqid, \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tBilling.MeterBilling.BillingPeriodRevision,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t@BillingCycle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tBilling.MeterBillingAdjustmentCrisGas.EstimatedOrActual\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t,BillingPeriodDays\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.BillingPeriodDays \r\n\t\t\t\t\t\t\t,FromDate\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.FromDate\r\n\t\t\t\t\t\t\t,ToDate\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.ToDate\r\n\t\t\t\t\t\t\t,FromReadingDate\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.FromDate\r\n\t\t\t\t\t\t\t,ToReadingDate\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.ToDate\r\n\t\t\t\t\t\t\t,Consumption\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.Therms\t\t\t--- + Consumption NO LONGER A net\r\n\t\t\t\t\t\t\t,ProductionAndDeliveryTariff\t= Billing.MeterBillingAdjustmentCrisGas.GasRateCode\r\n\t\t\t\t\t\t\t,AdjustmentRecordSeqid\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterBillingAdjustmentCrisGasSeqid\r\n\t\t\t\t\t\t\t,AuthenticatedUserID\t\t\t= Billing.MeterBillingAdjustmentCrisGas.AuthenticatedUserID\r\n\t\t\t\t\t\t\t,Notes\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.Notes \r\n\t\t\t\t\t\t\t,FireAuditTrigger\t\t\t\t= 'Y'\r\n\t\t\t\t\t\t\t,LastUpdate\t\t\t\t\t\t= getdate()\r\n\t\t\t\t\tFROM \r\n\t\t\t\t\t\t\tBilling.MeterBillingAdjustmentCrisGas INNER JOIN\r\n\t\t\t\t\t\t\tBilling.MeterBilling ON Billing.MeterBillingAdjustmentCrisGas.MeterBillingSeqid = Billing.MeterBilling.MeterBillingSeqid\r\n\t\t\t\t\tWHERE   \r\n\t\t\t\t\t\t\t(Billing.MeterBillingAdjustmentCrisGas.MeterBillingSeqid IS NOT NULL) AND \r\n\t\t\t\t\t\t\t(Billing.MeterBillingAdjustmentCrisGas.BillingPeriod = @BillingPeriod)\r\n\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t-- update MeterBillingCrisGas\r\n\t\t\t\t\tUPDATE    Billing.MeterBillingCrisGas\r\n\t\t\t\t\tSET             \r\n\t\t\t\t\t\t\t MeterBillingAdjustmentCrisGasSeqid\t= Billing.MeterBillingAdjustmentCrisGas.MeterBillingAdjustmentCrisGasSeqid \r\n\t\t\t\t\t\t\t,MeterBillingRowState\t\t\t\t= '2'\r\n\t\t\t\t\t\t\t,FromDate\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.FromDate\r\n\t\t\t\t\t\t\t,ToDate\t\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.ToDate\r\n\t\t\t\t\t\t\t--,ReadingCode\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.ReadingCode\r\n\t\t\t\t\t\t\t,GasRateCode\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.GasRateCode\t\r\n\t\t\t\t\t\t\t,MeterReset\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterReset\r\n\t\t\t\t\t\t\t,MeterFromReading\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterFromReading\r\n\t\t\t\t\t\t\t,MeterToReading\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterToReading\r\n\t\t\t\t\t\t\t,MeterConstant\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterConstant\r\n\t\t\t\t\t\t\t,MeterCCF\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.MeterCCF\t\t--- + Billing.MeterBillingCrisGas.MeterCCF NO LONGER A net\r\n\t\t\t\t\t\t\t,Therms\t\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.Therms\t\t\t--- + MeterBillingCrisGas.Therms NO LONGER A Net\r\n\t\t\t\t\t\t    ,ThermsFactor\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.ThermsFactor\r\n\t\t\t\t\t\t\t,HasMeterRolledOver\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.HasMeterRolledOver\r\n\t\t\t\t\t\t\t,AuthenticatedUserID\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.AuthenticatedUserID \r\n\t\t\t\t\t\t\t,Notes\t\t\t\t\t\t\t\t= Billing.MeterBillingAdjustmentCrisGas.Notes\r\n\t\t\t\t\t\t\t,LastPeriodModified\t\t\t\t\t= @BillingPeriod \r\n\t\t\t\t\t\t\t,FireAuditTrigger\t\t\t\t\t= 'Y'\r\n\t\t\t\t\t\t\t,LastUpdate\t\t\t\t\t\t\t= getdate()\r\n\t\t\t\t\tFROM \r\n\t\t\t\t\t\t\tBilling.MeterBillingAdjustmentCrisGas INNER JOIN\r\n\t\t\t\t\t\t\tBilling.MeterBillingCrisGas \r\n\t\t\t\t\t\t\tON Billing.MeterBillingAdjustmentCrisGas.MeterBillingCrisGasSeqid = Billing.MeterBillingCrisGas.MeterBillingCrisGasSeqid\r\n\t\t\t\t\tWHERE \r\n\t\t\t\t\t\t\t(Billing.MeterBillingAdjustmentCrisGas.MeterBillingSeqid IS NOT NULL) AND \r\n\t\t\t\t\t\t\t(Billing.MeterBillingAdjustmentCrisGas.BillingPeriod = @BillingPeriod)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t-- insert new MeterBilling\r\n\t\t\t\t\tINSERT INTO [Billing].[MeterBilling]\r\n\t\t\t\t\t\t\t   (\r\n\t\t\t\t\t\t\t    [UniqueAccountSeqId] /* added on 12/19/2018 */\r\n\t\t\t\t\t\t\t   ,[UniqueMeterSeqId] /* added on 12/19/2018 */\r\n\t\t\t\t\t\t\t   ,[AccountExchangeMeterTrackSeqid]\r\n\t\t\t\t\t\t\t   ,[IsTimeOfDayAccount]\r\n\t\t\t\t\t\t\t   ,[IsDerived]\r\n\t\t\t\t\t\t\t   ,[OriginalAccountNumber]\r\n\t\t\t\t\t\t\t   ,[OriginalMeterNumber]\r\n\t\t\t\t\t\t\t   ,[AccountUtilityCompanySeqid]\r\n\t\t\t\t\t\t\t---,[UploadFileSeqid]\r\n\t\t\t\t\t\t\t   ,[LastPeriodModified]\r\n\t\t\t\t\t\t\t   ,[BillingPeriod]\r\n\t\t\t\t\t\t\t   ,[BillingPeriodRevision]\r\n\t\t\t\t\t\t\t   ,[NextBillingPeriod]\r\n\t\t\t\t\t\t\t   ,[PreviousBillingPeriod]\r\n\t\t\t\t\t\t\t---,[BillCreationDate]\r\n\t\t\t\t\t\t\t   ,[BillingAction]\r\n\t\t\t\t\t\t\t   ,[MeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,[PreviousMeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,[MeterBillingStatusCodePeriod]\r\n\t\t\t\t\t\t\t   ,[EnergySource]\r\n\t\t\t\t\t\t\t   ,[ProcessedInTheCurrentPeriod]\r\n\t\t\t\t\t\t\t---,[SalesType]\r\n\t\t\t\t\t\t\t   ,[MeterType]\r\n\t\t\t\t\t\t\t   ,[UtilityServiceAddress]\r\n\t\t\t\t\t\t\t   ,[MeterDials]\r\n\t\t\t\t\t\t\t   ,[MeterConstant]\r\n\t\t\t\t\t\t\t---,[Tension]\r\n\t\t\t\t\t\t\t   ,[EstimatedReading]\r\n\t\t\t\t\t\t\t   ,[ConsecutivePeriodsEstimatedReading]\r\n\t\t\t\t\t\t\t   ,[ProductionAndDeliveryTariff]\r\n\t\t\t\t\t\t\t   ,[BillingPeriodDays]\r\n\t\t\t\t\t\t\t   ,[FromDate]\r\n\t\t\t\t\t\t\t   ,[ToDate]\r\n\t\t\t\t\t\t\t   ,[ToReadingDate]\r\n\t\t\t\t\t\t\t   ,[FromReadingDate]\r\n\t\t\t\t\t\t\t   ,[Consumption]\r\n\t\t\t\t\t\t       ,[Demand]\r\n\t\t\t\t\t\t\t   ,[BilledDemand]\r\n\t\t\t\t\t\t\t---,[InitialPostingDate]\r\n\t\t\t\t\t\t\t   ,[MeterLocation]\r\n\t\t\t\t\t\t\t   ,[IsSpannedPeriodBill]\r\n\t\t\t\t\t\t\t   ,[AdjustmentRecordSeqid]\r\n\t\t\t\t\t\t\t   ,[AuthenticatedUserID]\r\n\t\t\t\t\t\t\t   ,[FireAuditTrigger]\r\n\t\t\t\t\t\t\t   ,[Notes]\r\n\t\t\t\t\t\t\t   ,[DateAdded]\r\n\t\t\t\t\t\t\t   ,[LastUpdate])\r\n\t\t\t\t\tselect\t\t    \r\n\t\t\t\t\t\t\t    UniqueAccountSeqId /* added on 12/19/2018 */\r\n\t\t\t\t\t\t\t   ,UniqueMeterSeqId /* added on 12/19/2018 */\r\n\t\t\t\t\t\t\t   ,AccountExchangeMeterTrackSeqid\t\t\t--- [AccountExchangeMeterTrackSeqid]\r\n\t\t\t\t\t\t\t   ,'N'\t\t\t\t\t\t\t\t\t\t--- [IsTimeOfDayAccount]\r\n\t\t\t\t\t\t\t   ,DerivedFromSpannedBill\t\t\t\t\t--- [IsDerived]\r\n\t\t\t\t\t\t\t   ,OriginalAccountNumber\t\t\t\t\t--- [OriginalAccountNumber]\r\n\t\t\t\t\t\t\t   ,MeterNumber\t\t\t\t\t\t\t\t--- [OriginalMeterNumber]\r\n\t\t\t\t\t\t\t   ,UtilityCompanySeqid\t\t\t\t\t\t--- [AccountUtilityCompanySeqid]\r\n\t\t\t\t\t\t\t---,null\t\t\t\t\t\t\t\t\t--- [UploadFileSeqid]\r\n\t\t\t\t\t\t\t   ,@BillingPeriod\t\t\t\t\t\t\t--- [LastPeriodModified]\r\n\t\t\t\t\t\t\t   ,BillingPeriodRevision\t\t\t\t\t--- [BillingPeriod]\r\n\t\t\t\t\t\t\t   ,BillingPeriodRevision\t\t\t\t\t--- [BillingPeriodRevision]\r\n\t\t\t\t\t\t\t   ,dbo.CalculateNextBillingPeriod(BillingPeriodRevision, @BillingCycle)\t--- [NextBillingPeriod]\r\n\t\t\t\t\t\t\t   ,dbo.CreatePreviousPeriod(BillingPeriodRevision, @BillingCycle)\t\t\t--- [PreviousBillingPeriod]\r\n\t\t\t\t/*Revise*/\t---,null\t\t\t\t\t\t\t\t\t--- [BillCreationDate]\r\n\t\t\t\t\t\t\t   ,'O'\t\t\t\t\t\t\t\t\t\t--- [BillingAction]\r\n\t\t\t\t\t\t\t   ,MeterBillingStatus\t\t\t\t\t\t--- [MeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,PreviousMeterBillingStatus\t\t\t\t--- [PreviousMeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,MeterBillingStatusCodePeriod\t\t\t--- [MeterBillingStatusCodePeriod]\r\n\t\t\t\t\t\t\t   ,EnergySource\t\t\t\t\t\t\t--- [EnergySource]\r\n\t\t\t\t\t\t\t   ,'Y'\t\t\t\t\t\t\t\t\t\t--- [ProcessedInTheCurrentPeriod]\r\n\t\t\t\t\t\t\t---,\t\t\t\t\t\t\t\t\t\t--- [SalesType]\r\n\t\t\t\t\t\t\t   ,SUBSTRING(MeterType, 1, 1)\t\t\t\t--- [MeterType] The meterType they report is varchar(2), the meterType in the meterBilling is varchar(1)\r\n\t\t\t\t\t\t\t   ,UtilityServiceAddress\t\t\t\t\t--- [UtilityServiceAddress]\r\n\t\t\t\t\t\t\t   ,NumberOfDials\t\t\t\t\t\t\t--- [MeterDials]\r\n\t\t\t\t\t\t\t   ,MeterConstant\t\t\t\t\t\t\t--- [MeterConstant]\r\n\t\t\t\t\t\t\t---,\t\t\t\t\t\t\t\t\t\t--- [Tension]\r\n\t\t\t\t\t\t\t   ,EstimatedOrActual\t\t\t\t\t\t--- [EstimatedReading]\r\n\t\t\t\t\t\t\t   ,[Common].[CalculateConsecutiveNumberOfEstimatedReadings] (OriginalAccountNumber,MeterNumber,UtilityCompanySeqid,BillingPeriodRevision,@BillingCycle,EstimatedOrActual)\t\t--- [ConsecutivePeriodsEstimatedReading]\r\n\t\t\t\t\t\t\t   ,GasRateCode\t\t\t\t\t\t\t\t--- [ProductionAndDeliveryTariff]\r\n\t\t\t\t\t\t\t   ,BillingPeriodDays\t\t\t\t\t\t--- [BillingPeriodDays]\r\n\t\t\t\t\t\t\t   ,FromDate\t\t\t\t\t\t\t\t--- [FromDate]\r\n\t\t\t\t\t\t\t   ,ToDate\t\t\t\t\t\t\t\t\t--- [ToDate]\r\n\t\t\t\t\t\t\t   ,ToDate\t\t\t\t\t\t\t\t\t--- [ToReadingDate]\r\n\t\t\t\t\t\t\t   ,FromDate\t\t\t\t\t\t\t\t--- [FromReadingDate]\r\n\t\t\t\t\t\t\t   ,Therms\t\t\t\t\t\t\t\t\t--- [Consumption]\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t   ,null\t\t\t\t\t\t\t\t\t--- [Demand]\r\n\t\t\t\t\t\t\t   ,NULL\t\t\t\t\t\t\t\t\t--- [BilledDemand]\r\n\t\t\t\t\t\t\t---,\t\t\t\t\t\t\t\t\t\t--- [InitialPostingDate]\r\n\t\t\t\t\t\t\t   ,UtilityServiceAddress\t\t\t\t\t--- [MeterLocation]\r\n\t\t\t\t\t\t\t   ,DerivedFromSpannedBill\t\t\t\t\t--- [IsSpannedPeriodBill]\r\n\t\t\t\t\t\t\t   ,MeterBillingAdjustmentCrisGasSeqid\t\t--- [AdjustmentRecordSeqid]\r\n\t\t\t\t\t\t\t   ,AuthenticatedUserID\t\t\t\t\t\t--- [AuthenticatedUserID]\r\n\t\t\t\t\t\t\t   ,'N'\t\t\t\t\t\t\t\t\t\t--- [FireAuditTrigger]\r\n\t\t\t\t\t\t\t   ,Notes\t\t\t\t\t\t\t\t\t--- [Notes]\r\n\t\t\t\t\t\t\t   ,GETDATE()\t\t\t\t\t\t\t\t--- [DateAdded]\r\n\t\t\t\t\t\t\t   ,GETDATE()\t\t\t\t\t\t\t\t--- [LastUpdate]\r\n\r\n\t\t\t\t\tFROM \r\n\t\t\t\t\t\t\tBilling.MeterBillingAdjustmentCrisGas \r\n\t\t\t\t\tWHERE   \r\n\t\t\t\t\t\t\t(MeterBillingSeqid IS NULL) AND \r\n\t\t\t\t\t\t\t(BillingPeriod = @BillingPeriod)\r\n\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t-- Insert new  MeterBillingCrisGas\r\n\t\t\t\t\tINSERT INTO [Billing].[MeterBillingCrisGas]\r\n\t\t\t\t\t\t\t   ([UtilityCompanySeqid]\r\n\t\t\t\t\t\t\t   ,[AccountInvoiceBillingGroup]\r\n\t\t\t\t\t\t\t   ,[MeterBillingSeqid]\r\n\t\t\t\t\t\t\t   ,[MeterBillingAdjustmentCrisGasSeqid]\r\n\t\t\t\t\t\t\t   ,[AccountSeqid]\r\n\t\t\t\t\t\t\t   ,[UniqueAccountSeqId] /* added 12/11/2018 */\r\n\t\t\t\t\t\t\t   ,[MeterSeqid]\r\n\t\t\t\t\t\t\t   ,[UniqueMeterSeqId] /* added 12/11/2018 */\r\n\t\t\t\t\t\t\t   ,[AccountExchangeMeterTrackSeqid]\r\n\t\t\t\t\t\t\t   ,[MeterBillingRowState]\r\n\t\t\t\t\t\t\t   ,[LastPeriodModified]\r\n\t\t\t\t\t\t\t   ,[BillingPeriod]\r\n\t\t\t\t\t\t\t   ,[BillingPeriodRevision]\r\n\t\t\t\t\t\t\t   ,[OriginalAccountNumber]\r\n\t\t\t\t\t\t\t   ,[MeterNumber]\r\n\t\t\t\t\t\t\t   ,[MeterReadWorkDay]\r\n\t\t\t\t\t\t\t   ,[UtilityServiceAccountName]\r\n\t\t\t\t\t\t\t   ,[UtilityServiceAddress]\r\n\t\t\t\t\t\t\t   ,[SpecialLedgerAccountNumber]\r\n\t\t\t\t\t\t\t   ,[MeterConstant]\r\n\t\t\t\t\t\t\t   ,[NumberOfDials]\r\n\t\t\t\t\t\t\t   ,[EstimatedOrActual]\r\n\t\t\t\t\t\t\t   ,[MeterType]\r\n\t\t\t\t\t\t\t   ,[FromDate]\r\n\t\t\t\t\t\t\t   ,[ToDate]\r\n\t\t\t\t\t\t\t   ,[BillingPeriodDays]\r\n\t\t\t\t\t\t\t   ,[MeterFromReading]\r\n\t\t\t\t\t\t\t   ,[MeterToReading]\r\n\t\t\t\t\t\t\t   ,[MeterCCF]\r\n\t\t\t\t\t\t\t   ,Therms\r\n\t\t\t\t\t\t\t   ,ThermsFactor\r\n\t\t\t\t\t\t\t   ,GasRateCode\r\n\t\t\t\t\t\t\t   ,HasMeterRolledOver\r\n\t\t\t\t\t\t\t   ,[FixFactor]\r\n\t\t\t\t\t\t\t   ,[PartSupplied]\r\n\t\t\t\t\t\t\t   ,[MeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,[PreviousMeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,[MeterBillingStatusCodePeriod]\r\n\t\t\t\t\t\t\t   ,[EnergySource]\r\n\t\t\t\t\t\t\t   ,[MeterReset]\r\n\t\t\t\t\t\t\t   ,[FireAuditTrigger]\r\n\t\t\t\t\t\t\t   ,[Notes]\r\n\t\t\t\t\t\t\t   ,[AuthenticatedUserID]\r\n\t\t\t\t\t\t\t   ,[DateAdded]\r\n\t\t\t\t\t\t\t   ,[LastUpdate])\r\n\t\t\t\t\tSELECT\r\n\t\t\t\t\t\t\t\tUtilityCompanySeqid\t\t\t\t\t\t--- [UtilityCompanySeqid]\r\n\t\t\t\t\t\t\t   ,AccountInvoiceBillingGroup\t\t\t\t--- [AccountInvoiceBillingGroup]\r\n\t\t\t\t\t\t\t   ,NULL \t\t\t\t\t\t\t\t\t--- [MeterBillingSeqid]\r\n\t\t\t\t\t\t\t   ,MeterBillingAdjustmentCrisGasSeqid\t\t--- [MeterBillingAdjustmentCrisGasSeqid]\r\n\t\t\t\t\t\t\t   ,AccountSeqid\t\t\t\t\t\t\t--- [AccountSeqid]\r\n\t\t\t\t\t\t\t   ,UniqueAccountSeqId                      --- [UniqueAccountSeqId] /* 12/11/2018 */\r\n\t\t\t\t\t\t\t   ,MeterSeqid\t\t\t\t\t\t\t\t--- [MeterSeqid]\r\n\t\t\t\t\t\t\t   ,UniqueMeterSeqId                        --- [UniqueMeterSeqId] /* 12/11/2018 */\r\n\t\t\t\t\t\t\t   ,AccountExchangeMeterTrackSeqid\t\t\t--- [AccountExchangeMeterTrackSeqid]\r\n\t\t\t\t\t\t\t   ,'2'\t\t\t\t\t\t\t\t\t\t--- [MeterBillingRowState]\r\n\t\t\t\t\t\t\t   ,@BillingPeriod\t\t\t\t\t\t\t--- [LastPeriodModified]\r\n\t\t\t\t\t\t\t   ,BillingPeriodRevision\t\t\t\t\t--- [BillingPeriod]\r\n\t\t\t\t\t\t\t   ,BillingPeriodRevision\t\t\t\t\t--- [BillingPeriodRevision]\r\n\t\t\t\t\t\t\t   ,OriginalAccountNumber\t\t\t\t\t--- [OriginalAccountNumber]\r\n\t\t\t\t\t\t\t   ,MeterNumber\t\t\t\t\t\t\t\t--- [MeterNumber]\r\n\t\t\t\t\t\t\t   ,MeterReadWorkDay\t\t\t\t\t\t--- [MeterReadWorkDay]\r\n\t\t\t\t\t\t\t   ,UtilityServiceAccountName\t\t\t\t--- [UtilityServiceAccountName]\r\n\t\t\t\t\t\t\t   ,UtilityServiceAddress\t\t\t\t\t--- [UtilityServiceAddress]\r\n\t\t\t\t\t\t\t   ,SpecialLedgerAccountNumber\t\t\t\t--- [SpecialLedgerAccountNumber]\r\n\t\t\t\t\t\t\t   ,MeterConstant\t\t\t\t\t\t\t--- [MeterConstant]\r\n\t\t\t\t\t\t\t   ,NumberOfDials\t\t\t\t\t\t\t--- [NumberOfDials]\r\n\t\t\t\t\t\t\t   ,EstimatedOrActual\t\t\t\t\t\t--- [EstimatedOrActual]\r\n\t\t\t\t\t\t\t   ,MeterType\t\t\t\t\t\t\t\t--- [MeterType]\r\n\t\t\t\t\t\t\t   ,FromDate\t\t\t\t\t\t\t\t--- [FromDate]\r\n\t\t\t\t\t\t\t   ,ToDate\t\t\t\t\t\t\t\t\t--- [ToDate]\r\n\t\t\t\t\t\t\t   ,BillingPeriodDays\t\t\t\t\t\t--- [BillingPeriodDays]\r\n\t\t\t\t\t\t\t   ,MeterFromReading\t\t\t\t\t\t--- [MeterFromReading]\r\n\t\t\t\t\t\t\t   ,MeterToReading\t\t\t\t\t\t\t--- [MeterToReading]\r\n\t\t\t\t\t\t\t   ,MeterCCF\t\t\t\t\t\t\t\t--- [MeterCCF]\r\n\t\t\t\t\t\t\t   ,Therms\t\t\t\t\t\t\t\t\t--- therms\r\n\t\t\t\t\t\t\t   ,ThermsFactor\t\t\t\t\t\t\t--- thermsFactor\r\n\t\t\t\t\t\t\t   ,GasRateCode\t\t\t\t\t\t\t\t--- GasRateCode\r\n\t\t\t\t\t\t\t   ,HasMeterRolledOver\t\t\t\t\t\t--- HasMeterRolledOver\t\t\t\r\n\t\t\t\t\t\t\t   ,FixFactor\t\t\t\t\t\t\t\t--- [FixFactor]\r\n\t\t\t\t\t\t\t   ,PartSupplied\t\t\t\t\t\t\t--- [PartSupplied]\r\n\t\t\t\t\t\t\t   ,MeterBillingStatus\t\t\t\t\t\t--- [MeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,PreviousMeterBillingStatus\t\t\t\t--- [PreviousMeterBillingStatus]\r\n\t\t\t\t\t\t\t   ,MeterBillingStatusCodePeriod\t\t\t--- [MeterBillingStatusCodePeriod]\r\n\t\t\t\t\t\t\t   ,EnergySource\t\t\t\t\t\t\t--- [EnergySource]\r\n\t\t\t\t\t\t\t   ,MeterReset\t\t\t\t\t\t\t\t--- [MeterReset]\r\n\t\t\t\t\t\t\t   ,'N'\t\t\t\t\t\t\t\t\t\t--- [FireAuditTrigger]\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t   ,Notes\t\t\t\t\t\t\t\t\t--- [Notes]\t\t\t\r\n\t\t\t\t\t\t\t   ,AuthenticatedUserID\t\t\t\t\t\t--- [AuthenticatedUserID]\r\n\t\t\t\t\t\t\t   ,GETDATE()\t\t\t\t\t\t\t\t--- [DateAdded]\r\n\t\t\t\t\t\t\t   ,GETDATE()\t\t\t\t\t\t\t\t--- [LastUpdate]\r\n\t\t\t\t\t\r\n\t\t\t\t\tFROM \r\n\t\t\t\t\t\t\tBilling.MeterBillingAdjustmentCrisGas \r\n\t\t\t\t\tWHERE   \r\n\t\t\t\t\t\t\t(MeterBillingCrisGasSeqid IS NULL) AND \r\n\t\t\t\t\t\t\t(BillingPeriod = @BillingPeriod)\r\n\r\n\t\t\t\t\t\r\n\t\t\t\t\t-- update references\r\n\t\t\t\t\t\r\n\t\t\t\t\t-- update the adjutment table\r\n\t\t\t\t\tUPDATE Billing.MeterBillingAdjustmentCrisGas\r\n\t\t\t\t\tSET \r\n\t\t\t\t\t\tMeterBillingSeqid = Billing.MeterBilling.MeterBillingSeqid\r\n\t\t\t\t\t\r\n\t\t\t\t\tFROM Billing.MeterBillingAdjustmentCrisGas INNER JOIN Billing.MeterBilling\r\n\t\t\t\t\tON Billing.MeterBillingAdjustmentCrisGas.MeterBillingAdjustmentCrisGasSeqid = Billing.MeterBilling.AdjustmentRecordSeqid\r\n\t\t\t\t\tAND Billing.MeterBillingAdjustmentCrisGas.OriginalAccountNumber = Billing.MeterBilling.OriginalAccountNumber AND Billing.MeterBillingAdjustmentCrisGas.MeterNumber = Billing.MeterBilling.OriginalMeterNumber\r\n\t\t\t\t\tWHERE MeterBillingAdjustmentCrisGas.BillingPeriod = @BillingPeriod AND MeterBillingAdjustmentCrisGas.MeterBillingSeqid IS NULL \r\n\r\n\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tUPDATE       Billing.MeterBillingAdjustmentCrisGas\r\n\t\t\t\t\tSET          MeterBillingCrisGasSeqid = MeterBillingCrisGas.MeterBillingCrisGasSeqid\r\n\t\t\t\t\tFROM Billing.MeterBillingAdjustmentCrisGas INNER JOIN\r\n\t\t\t\t\t\t\t\t\t\t\t Billing.MeterBillingCrisGas ON \r\n\t\t\t\t\t\t\t\t\t\t\t Billing.MeterBillingAdjustmentCrisGas.MeterBillingAdjustmentCrisGasSeqid = Billing.MeterBillingCrisGas.MeterBillingAdjustmentCrisGasSeqid\r\n\t\t\t\t\tWHERE    (Billing.MeterBillingAdjustmentCrisGas.BillingPeriod = @BillingPeriod) AND (Billing.MeterBillingAdjustmentCrisGas.MeterBillingCrisGasSeqid IS NULL)\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tUPDATE       Billing.MeterBillingCrisGas\r\n\t\t\t\t\tSET                MeterBillingSeqid = MeterBillingAdjustmentCrisGas.MeterBillingSeqid\r\n\t\t\t\t\tFROM Billing.MeterBillingAdjustmentCrisGas INNER JOIN\r\n\t\t\t\t\t\t\t\t\t\t\t Billing.MeterBillingCrisGas ON \r\n\t\t\t\t\t\t\t\t\t\t\t Billing.MeterBillingAdjustmentCrisGas.MeterBillingAdjustmentCrisGasSeqid = Billing.MeterBillingCrisGas.MeterBillingAdjustmentCrisGasSeqid\r\n\t\t\t\t\tWHERE    (Billing.MeterBillingAdjustmentCrisGas.BillingPeriod = @BillingPeriod) AND (Billing.MeterBillingCrisGas.MeterBillingSeqid IS NULL)\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\r\n\t\t\t\tcommit TRANSACTION MoveDataToBilling\r\n\r\n\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\r\n\t\t\t\tDECLARE @CustomErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorSeverity INT;\r\n\t\t\t\tDECLARE @ErrorState INT;\r\n\t\t\t\tDECLARE @ErrorNumber INT;\r\n\t\t\t\tDECLARE @ErrorLine INT;\r\n\t\t\t\tDECLARE @ErrorProcedure NVARCHAR(126);\r\n\t\t\t\t--\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t@CustomErrorMessage ='Error in StoredProcedure %s at line number %d' + @crlf + 'Billing Period: %s' + @crlf + 'Account:Meter (%s : %s)  ' + @crlf,\r\n\t\t\t\t\t@ErrorMessage\t= ERROR_MESSAGE(),\r\n\t\t\t\t\t@ErrorSeverity\t= ERROR_SEVERITY(),\r\n\t\t\t\t\t@ErrorState\t\t= ERROR_STATE(),\r\n\t\t\t\t\t@ErrorNumber\t= ERROR_NUMBER(),\r\n\t\t\t\t\t@ErrorProcedure = ERROR_PROCEDURE(),\r\n\t\t\t\t\t@ErrorLine\t\t= ERROR_LINE();\t\t\t\r\n\t\t\t\t--\r\n\t\t\t\tset\t@ErrorMessage = @CustomErrorMessage + @ErrorMessage + @crlf + 'ErrorNumber: ' + cast(@ErrorNumber as varchar(10)) + @crlf\r\n\t\t\t\t--\r\n\t\t\t\tRAISERROR (@ErrorMessage, -- Message text.\r\n\t\t\t\t\t\t   @ErrorSeverity, -- Severity.\r\n\t\t\t\t\t\t   @ErrorState, -- State.\r\n\t\t\t\t\t\t   @ErrorProcedure,\r\n\t\t\t\t\t\t   @ErrorLine,\r\n\t\t\t\t\t\t   @BillingPeriod,\r\n\t\t\t\t\t\t   @AccountNumber,\r\n\t\t\t\t\t\t   @MeterNumber\r\n\t\t\t\t\t\t   ) with log;\r\n\t\t\t\t\r\n\t\t\t\tset @StatusCode  = 1\r\n\t\t\t\t\t\t   \r\n\t\t\t\tROLLBACK TRANSACTION MoveDataToBilling\t\r\n\t\t\t\t\t\t   \r\n\t\tEND CATCH\r\n\r\n\r\n\r\n\r\n\t\r\n end"
        }
      ]
    }
  ]
}