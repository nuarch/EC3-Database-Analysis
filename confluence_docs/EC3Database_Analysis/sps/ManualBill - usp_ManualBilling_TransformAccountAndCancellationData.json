{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ManualBill",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ManualBilling_TransformAccountAndCancellationData",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ManualBilling_TransformAccountAndCancellationData",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to transform and prepare manual billing data for further processing. It performs data migration from several source tables related to manual billing into corresponding upload tables. The procedure executes in three main steps: copying header data, copying account detail data, and copying cancellation data. It also updates certain fields to ensure data integrity and completeness before setting a status flag to indicate success or failure."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple data manipulation operations, including truncation, insertion, and updates across several tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes conditional logic based on input parameters and existing data states."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It requires joining tables and updating fields based on calculations and external function calls."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the billing period for which data is being processed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@authenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the ID of the authenticated user executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@utilityCompany dbo.seqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Identifies the utility company for which the billing data is relevant."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Status int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter used to indicate the success (0) or failure (9) of the procedure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting "
                },
                {
                  "type": "text",
                  "text": "@Status",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to 9 (failure) and truncating several upload tables to prepare them for new data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Step 1 - Header Data Migration",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts data from "
                        },
                        {
                          "type": "text",
                          "text": "AccountManualBillingHeader",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " into "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingHeader",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for records matching the specified utility company and billing period, and where the initial posting date is not null and the record has not been processed in the current period."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Step 2 - Account Detail Data Migration",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts data from "
                        },
                        {
                          "type": "text",
                          "text": "AccountManualBillingDetail",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " into "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingAccount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " using a join with "
                        },
                        {
                          "type": "text",
                          "text": "AccountManualBillingHeader",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to ensure consistency and completeness."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates "
                        },
                        {
                          "type": "text",
                          "text": "UniqueAccountSeqID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " in "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingAccount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " by joining with the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Step 3 - Cancellation Data Migration",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Inserts data from "
                        },
                        {
                          "type": "text",
                          "text": "AccountManualBillingCancellation",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " into "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingCancellation",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", again ensuring consistency with "
                        },
                        {
                          "type": "text",
                          "text": "AccountManualBillingHeader",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates "
                        },
                        {
                          "type": "text",
                          "text": "DeltaNumberOfPeriods",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " in both "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingAccount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingCancellation",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " using a custom function "
                        },
                        {
                          "type": "text",
                          "text": "CalculateDeltaBillingPeriods",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates "
                        },
                        {
                          "type": "text",
                          "text": "UniqueAccountSeqID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " in both "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingCancellation",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "UploadManualBillingHeader",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Completion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Sets "
                },
                {
                  "type": "text",
                  "text": "@Status",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to 0 (success) if all operations complete without errors."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncation Operations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Frequent truncation of tables can be resource-intensive and may lock tables, affecting concurrent operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Bulk Inserts",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs bulk inserts, which can be optimized by ensuring indexes are appropriately managed and using batch processing if necessary."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "CalculateDeltaBillingPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " in updates may introduce performance overhead, especially if the function is complex or inefficient."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure's operations may impact other processes accessing the same tables, necessitating careful transaction management and isolation level considerations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Truncating tables without proper backup or logging can lead to data loss if the procedure fails midway."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency Conflicts",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure may cause locking issues, especially during truncation and bulk insert operations, potentially leading to deadlocks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks detailed error handling and logging, which could make troubleshooting difficult in case of failures."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the performance of this procedure may degrade, necessitating optimization or redesign."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dependency on External Functions",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The reliance on "
                },
                {
                  "type": "text",
                  "text": "CalculateDeltaBillingPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " means any changes or issues with this function could impact the procedure's correctness and performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--****************************************************************************************************************************************************************\n-- Name:\t\t\tusp_ManualBilling_TransformAccountAndCancellationData\r\n--\r\n-- Description:\t\tThe main function of this stored procedure is to copy data from the manual billing detail and header records into \r\n--\t\t\t\t\tManualBill.UploadManualBillingAccount and ManualBill.UploadManualBillingCancellation table before the processing\r\n--\t\t\t\t\tIt does it in 3 steps\r\n--\t\t\t\t\t*   Collect all the headers that have been vouchered and havent been processed yet\r\n--\r\n--\t\t\t\t\t*\tCollect all the records from AccountManualBillingDetail and copy them into the UploadManualBillingAccount  \r\n--\t\t\t\t\t\t\r\n--\t\t\t\t\t*\tCollect all the cancellation from AccountManualBillingCancellation and copy them into the UploadManualBillingAccount                \r\n--               \r\n--\r\n-- Parameter(s):     @BillingPeriod varchar(6),\r\n--\t\t\t\t\t@authenticatedID int,\r\n--\t\t\t\t\t@utilityCompany dbo.seqid,\r\n-- \t\t\t\t\t@invoiceBillingGroup dbo.seqid,\r\n--\t\t\t\t\t@Status int  OUTPUT     \r\n--\r\n-- Return:\t    0 Success\r\n--              9 Failure\r\n--\r\n-- AUTHOR:       MOHAMMED BELARREM\r\n--*****************************************************************************************************************************************************************\r\n-- Date       Tech\tDescription of Change\r\n-- ---------- ----\t-----------------------------------------------------------------------------------------------------------------------------------------------\r\n-- 02/10/2009 MOH\tFirst Version \r\n-- 07/30/2009 MOH\tUpdate: Updated the AmountPaid to be picked up as VoucheredAmount since this is a better representation of the amount paid\r\n--\t\t\t\t\t\t\tI also changed the UploadManualBillingAccount table to carry over the InvoiceTrackingSeqid into the upload process \r\n-- 10/20/2009 MOH   Update: Updated the stored to get the data from AccountManualBillingTESTCancelation since the structure changed to Header, Detail and Cancel tables\r\n-- 12/28/2009 MOH\tUpdate: ReWrite \r\n--\t\t\t\t\t        we now have a cancellation table so we need to grad the data directly from there. also the  UploadManualBillingAccount and the UploadManualBillingCancellation tables \r\n--\t\t\t\t\t\t\thave been reduced to essential information, the rest will get picked up later in the process\r\n-- 01/05/2010 MOH   Update: Added the UploadManualBillingHeader table to hold the header information, and then couple together later in the process\r\n-- 01/07/2010 MOH   Update: Make the queries Invoice Billing Independant\r\n-- 01/13/2010 MOH   Update: Added AccountSeqid to the tables\r\n-- 07/06/2011 MOH\tUpdate: Added Tax to the upload header table\r\n-- 08/30/2011 MOH\tUpdate: added isNull to handle tax and LatePaymentCharges\r\n-- 12/17/2018 VY    update: Modified for UniqueAccountSeqID \r\n-- ****************************************************************************************************************************************************************\r\nCREATE PROCEDURE [ManualBill].[usp_ManualBilling_TransformAccountAndCancellationData] \r\n(\r\n\t@BillingPeriod varchar(6),\r\n\t@authenticatedID int,\r\n\t@utilityCompany dbo.seqid,\r\n\t@Status int  OUTPUT     \r\n)\r\nAS \r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\r\n\tSET @Status = 9;\r\n\r\n\t---------- Load Formated Tables\r\n\t----\r\n\t----\tInitialize processing tables prior to insertion from header and detail\r\n\t----\r\n\tTruncate table  ManualBill.UploadManualBillingHeader\r\n\tTruncate table  ManualBill.UploadManualBillingAccount\r\n\tTruncate table  ManualBill.UploadManualBillingCancellation\r\n\t\r\n\t---\t\tother tables that need to be trancated\r\n\tTruncate table  ManualBill.UploadManualBillingAccountSummary\r\n\tTruncate table  ManualBill.UploadManualBillingAccountTempSummarySpanned\r\n\tTruncate table  ManualBill.UploadManualBillingCancellationSummary\r\n\tTruncate table  ManualBill.UploadManualBillingCancellationTempSummarySpanned\r\n\t \r\n\tTruncate table  ManualBill.UploadManualBillingAccountAdjustment\r\n\t\r\n\t-- STEP1\r\n\t-- collect all the headers from AccountManualBillingHeader and copy them into the ManualBill.UploadManualBillingHeader\r\n\tINSERT INTO ManualBill.[UploadManualBillingHeader]\r\n        ([AccountManualBillingHeaderSeqid]\r\n        ,[AccountUtilityCompanySeqid]\r\n        ,[CurrentInvoiceAccountGroup]\r\n        ,[AccountSeqid]\r\n        ,[OriginalAccountNumber]\r\n        ,[AccountEnergySource]\r\n        ,[BillingPeriod]\r\n        ,[BillingPeriodRevision]\r\n        ,[FirstPeriodCanceled]\r\n        ,[BillingAction]\r\n        ,[ActualOrEstimated]\r\n        ,[InvoiceTrackingSeqid]\r\n        ,[VoucherBillingStatus]\r\n        ,[VoucherBillingStatusPeriod]\r\n        ,[VoucheredAmount]\r\n        ,[CreditHasBeenCollected]\r\n        ,[ProcessedInTheCurrentPeriod]\r\n        ,[BillingPeriodDays]\r\n        ,[FromDate]\r\n        ,[ToDate]\r\n        ,[LatePaymentAmount]\r\n        ,[TotalCancellationCreditTransfer]\r\n        ,[PreviousAccountBalance]\r\n        ,[CurrentChargeAmount]\r\n        ,[Tax]\r\n        ,[ManualPaymentOverrideAmount]\r\n        ,[TotalAmountDue]\r\n        ,[CreditedPaidAmount]\r\n        ,[CreditedPaymentDate]\r\n        ,[AccountEnergyUsage]\r\n        ,[AccountDemandUsage]\r\n        ,[ReadyForVouchering]\r\n        ,[BillCreationDate]\r\n        ,[PostMarkDate]\r\n        ,[DatePaymentDue]\r\n        ,[DateAcceptanceIntoOEC]\r\n        ,[Notes]\r\n        ,[AuthenticatedUserID]\r\n        ,[InitialPostingDate]\r\n        ,[DateAdded]\r\n        ,[LastUpdate])\r\n\tSELECT  [AccountManualBillingHeaderSeqid]\t\t---[AccountManualBillingHeaderSeqid]\r\n        ,[AccountUtilityCompanySeqid]\t\t\t---[AccountUtilityCompanySeqid]\r\n        ,[CurrentInvoiceAccountGroup]\t\t\t---[CurrentInvoiceAccountGroup]\r\n        ,[AccountSeqid]\t\t\t\t\t\t\t---[AccountSeqid]\r\n        ,[OriginalAccountNumber]\t\t\t\t\t---[OriginalAccountNumber]\r\n        ,[AccountEnergySource]\t\t\t\t\t---[AccountEnergySource]\r\n        ,[BillingPeriod]\t\t\t\t\t\t\t---[BillingPeriod]\r\n        ,[BillingPeriodRevision]\t\t\t\t\t---[BillingPeriodRevision]\r\n        ,[FirstPeriodCanceled]\t\t\t\t\t---[FirstPeriodCanceled]\r\n        ,[BillingAction]\t\t\t\t\t\t\t---[BillingAction]\r\n        ,[ActualOrEstimated]\t\t\t\t\t\t---[ActualOrEstimated]\r\n        ,[InvoiceTrackingSeqid]\t\t\t\t\t---[InvoiceTrackingSeqid]\r\n        ,[VoucherBillingStatus]\t\t\t\t\t---[VoucherBillingStatus]\r\n        ,[VoucherBillingStatusPeriod]\t\t\t---[VoucherBillingStatusPeriod]\r\n        ,[VoucheredAmount]\t\t\t\t\t\t---[VoucheredAmount]\r\n        ,[CreditHasBeenCollected]\t\t\t\t---[CreditHasBeenCollected]\r\n        ,[ProcessedInTheCurrentPeriod]\t\t\t---[ProcessedInTheCurrentPeriod]\r\n        ,[BillingPeriodDays]\t\t\t\t\t\t---[BillingPeriodDays]\r\n        ,[FromDate]\t\t\t\t\t\t\t\t---[FromDate]\r\n        ,[ToDate]\t\t\t\t\t\t\t\t---[ToDate]\r\n        ,ISNULL([LatePaymentAmount], 0)\t\t\t---[LatePaymentAmount]\r\n        ,[TotalCancellationCreditTransfer]\t\t---[TotalCancellationCreditTransfer]\r\n        ,[PreviousAccountBalance]\t\t\t\t---[PreviousAccountBalance]\r\n        ,[CurrentChargeAmount]\t\t\t\t\t---[CurrentChargeAmount]\r\n        ,ISNULL([Tax], 0)\t\t\t\t\t\t---[Tax]\r\n        ,[ManualPaymentOverrideAmount]\t\t\t---[ManualPaymentOverrideAmount]\r\n        ,[TotalAmountDue]\t\t\t\t\t\t---[TotalAmountDue]\r\n        ,[CreditedPaidAmount]\t\t\t\t\t---[CreditedPaidAmount]\r\n        ,[CreditedPaymentDate]\t\t\t\t\t---[CreditedPaymentDate]\r\n        ,[AccountEnergyUsage]\t\t\t\t\t---[AccountEnergyUsage]\r\n        ,[AccountDemandUsage]\t\t\t\t\t---[AccountDemandUsage]\r\n        ,[ReadyForVouchering]\t\t\t\t\t---[ReadyForVouchering]\r\n        ,[BillCreationDate]\t\t\t\t\t\t---[BillCreationDate]\r\n        ,[PostMarkDate]\t\t\t\t\t\t\t---[PostMarkDate]\r\n        ,[DatePaymentDue]\t\t\t\t\t\t---[DatePaymentDue]\r\n        ,[DateAcceptanceIntoOEC]\t\t\t\t\t---[DateAcceptanceIntoOEC]\r\n        ,[Notes]\t\t\t\t\t\t\t\t\t---[Notes]\r\n        ,[AuthenticatedUserID]\t\t\t\t\t---[AuthenticatedUserID]\r\n        ,[InitialPostingDate]\t\t\t\t\t---[InitialPostingDate]\r\n        ,[DateAdded]\t\t\t\t\t\t\t\t---[DateAdded]\r\n        ,[LastUpdate]\t\t\t\t\t\t\t---[LastUpdate]\r\n\tFROM ManualBill.AccountManualBillingHeader header\r\n\tWHERE(header.AccountUtilityCompanySeqid = @utilityCompany) AND \r\n\t\t (header.BillingPeriod = @BillingPeriod) AND \r\n\t\t (header.InitialPostingDate IS NOT NULL) AND \r\n\t\t (header.ProcessedInTheCurrentPeriod = 'N');\r\n\r\n\t-- STEP2\r\n\t-- collect all the records from AccountManualBillingDetail and copy them into the UploadManualBillingAccount  \r\n    INSERT INTO ManualBill.[UploadManualBillingAccount] \r\n        ([UtilityCompanySeqid]\r\n        ,[InvoiceAccountBillingGroupSeqid]\r\n        ,[AccountmanualBillingHeaderSeqid]\r\n        ,[AccountSeqid]\r\n        ,[OriginalAccountNumber]\r\n        ,[BillingPeriod]\r\n        ,[BillingPeriodRevision]\r\n        ,[FirstBillingPeriodCanceled]\r\n        ,[DeltaNumberOfPeriods]\r\n        ,[FromDate]\r\n        ,[ToDate]\r\n        ,[BillingPeriodDays]\r\n        ,[BillingAction]\r\n        ,[ActualOrEstimated]\r\n        ,[NetBilledAmount]\r\n        ,[EnergyUsage]\r\n        ,[DemandUsage]\r\n        ,[EnergySource]\r\n        ,[AuthenticatedUserID]\r\n        ,[DateAdded]\r\n        ,[LastUpdate])\r\n   SELECT header.AccountUtilityCompanySeqid\t\t---[UtilityCompanySeqid]\r\n        ,header.CurrentInvoiceAccountGroup\t\t---[InvoiceAccountBillingGroupSeqid]\r\n        ,header.AccountManualBillingHeaderSeqid\t---[AccountmanualBillingHeaderSeqid]\r\n        ,header.AccountSeqid\t\t\t\t\t\t---[AccountSeqid]\r\n        ,header.OriginalAccountNumber\t\t\t---[OriginalAccountNumber]\r\n        ,detail.BillingPeriod\t\t\t\t\t---[BillingPeriod]\r\n        ,detail.BillingPeriodRevision\t\t\t---[BillingPeriodRevision]\r\n        ,detail.FirstBillingPeriodCanceled\t\t---[FirstBillingPeriodCanceled]\r\n        ,NULL\t\t\t\t\t\t\t\t\t---[DeltaNumberOfPeriods]\r\n        ,detail.FromDate\t\t\t\t\t\t\t---[FromDate]\r\n        ,detail.ToDate\t\t\t\t\t\t\t---[ToDate]\r\n        ,detail.BillingPeriodDays\t\t\t\t---[BillingPeriodDays]\r\n        ,detail.BillingAction\t\t\t\t\t---[BillingAction]\r\n        ,detail.ActualOrEstimated\t\t\t\t---[ActualOrEstimated]\r\n        ,detail.NetBilledAmount\t\t\t\t\t---[NetBilledAmount]\r\n        ,detail.EnergyUsage\t\t\t\t\t\t---[EnergyUsage]\r\n        ,detail.DemandUsage\t\t\t\t\t\t---[DemandUsage]\r\n        ,detail.EnergySource\t\t\t\t\t\t---[EnergySource]\r\n        ,detail.AuthenticatedUserID\t\t\t\t---[AuthenticatedUserID]\r\n        ,GETDATE()\t\t\t\t\t\t\t\t---[DateAdded]\r\n        ,GETDATE()\t\t\t\t\t\t\t\t---[LastUpdate]\r\n\tFROM ManualBill.AccountManualBillingDetail detail INNER JOIN\r\n          ManualBill.AccountManualBillingHeader header ON \r\n          detail.AccountManualBillingHeaderSeqid = header.AccountManualBillingHeaderSeqid\r\n\tWHERE (header.AccountUtilityCompanySeqid = @utilityCompany) AND \r\n\t\t  (header.BillingPeriod = @BillingPeriod) AND \r\n\t\t  (header.InitialPostingDate IS NOT NULL) AND \r\n\t\t  (header.ProcessedInTheCurrentPeriod = 'N');\r\n     \r\n  \t/* added on 12/17/2018 for UniqueAccountSeqID */\r\n\tUPDATE ManualBill.UploadManualBillingAccount\r\n\tSET ManualBill.UploadManualBillingAccount.UniqueAccountSeqID = Billing.Account.UniqueAccountSeqID\r\n\tFROM ManualBill.UploadManualBillingAccount inner join Billing.Account on ManualBill.UploadManualBillingAccount.AccountSeqID = Billing.Account.AccountSeqID\r\n\tWHERE ManualBill.UploadManualBillingAccount.UniqueAccountSeqID IS NULL;   \r\n     \r\n    --STEP3 \r\n    -- collect all the cancelation and recreated legacy records from AccountManualBillingDetail and copy them into the UploadManualBillingAccount  \r\n    INSERT INTO ManualBill.[UploadManualBillingCancellation]\r\n        ([UtilityCompanySeqid]\r\n        ,[InvoiceAccountBillingGroupSeqid]\r\n        ,[AccountManualBillingHeaderSeqid]\r\n        ,[AccountSeqid]\r\n        ,[OriginalAccountNumber]\r\n        ,[BillingPeriod]\r\n        ,[BillingPeriodRevision]\r\n        ,[FirstBillingPeriodCanceled]\r\n        ,[DeltaNumberOfPeriods]\r\n        ,[FromDate]\r\n        ,[ToDate]\r\n        ,[BillingPeriodDays]\r\n        ,[NetBilledAmount]\r\n        ,[EnergyUsage]\r\n        ,[DemandUsage]\r\n        ,[EnergySource]\r\n        ,[Notes]\r\n        ,[AuthenticatedUserID]\r\n        ,[DateAdded]\r\n        ,[LastUpdate])\r\n\tSELECT header.AccountUtilityCompanySeqid                --[UtilityCompanySeqid]                  \r\n\t\t,header.CurrentInvoiceAccountGroup                --[InvoiceAccountBillingGroupSeqid]                  \r\n\t\t,header.AccountManualBillingHeaderSeqid           --[AccountManualBillingHeaderSeqid]                       \r\n        ,header.AccountSeqid\t\t\t\t\t\t\t\t --[AccountSeqid]\t\r\n\t\t,header.OriginalAccountNumber                     --[OriginalAccountNumber]             \r\n\t\t,cancellation.BillingPeriod                       --[BillingPeriod]           \r\n\t\t,cancellation.BillingPeriodRevision               --[BillingPeriodRevision]                   \r\n\t\t,cancellation.FirstBillingPeriodCanceled          --[--[FirstBillingPeriodCanceled]                        \r\n\t\t,NULL                                             --[--[DeltaNumberOfPeriods]                                                                     \r\n\t\t,cancellation.FromDate                            --[FromDate]      \r\n\t\t,cancellation.ToDate                              --[ToDate]    \r\n\t\t,cancellation.BillingPeriodDays                   --[BillingPeriodDays]               \r\n\t\t,cancellation.NetBilledAmount                     --[NetBilledAmount]             \r\n\t\t,cancellation.EnergyUsage                         --[--[EnergyUsage]         \r\n\t\t,cancellation.DemandUsage                         --[DemandUsage]         \r\n\t\t,header.AccountEnergySource                       --[EnergySource]           \r\n\t\t,null                                             --[Notes]                                                                     \r\n\t\t,header.AuthenticatedUserID                       --[AuthenticatedUserID]                                                                                           \r\n\t\t,getdate()                                        --[DateAdded]                                                                          \r\n\t\t,getdate()                                        --[LastUpdate]\r\n\tFROM ManualBill.AccountManualBillingCancellation  cancellation INNER JOIN\r\n        ManualBill.AccountManualBillingHeader header ON \r\n        cancellation.AccountManualBillingHeaderSeqid = header.AccountManualBillingHeaderSeqid\r\n\tWHERE (header.AccountUtilityCompanySeqid = @utilityCompany) AND \r\n\t\t(header.BillingPeriod = @BillingPeriod) AND \r\n\t\t(header.InitialPostingDate IS NOT NULL) AND \r\n\t\t(header.ProcessedInTheCurrentPeriod = 'N');\r\n\r\n\t-- update the delta number of periods in account\r\n\tUPDATE ManualBill.UploadManualBillingAccount\r\n\tSET  DeltaNumberOfPeriods = dbo.CalculateDeltaBillingPeriods(ManualBill.UploadManualBillingAccount.FirstBillingPeriodCanceled, ManualBill.UploadManualBillingAccount.BillingPeriodRevision, Billing.Account.BillingCycle)\r\n\tFROM ManualBill.UploadManualBillingAccount INNER JOIN\r\n        Billing.Account ON ManualBill.UploadManualBillingAccount.OriginalAccountNumber = Billing.Account.OriginalAccountNumber;\r\n\r\n\t-- update the delta number of periods in cancellation\r\n\tUPDATE ManualBill.UploadManualBillingCancellation\r\n\tSET  DeltaNumberOfPeriods = dbo.CalculateDeltaBillingPeriods(ManualBill.UploadManualBillingCancellation.FirstBillingPeriodCanceled, ManualBill.UploadManualBillingCancellation.BillingPeriodRevision, Billing.Account.BillingCycle)\r\n\tFROM ManualBill.UploadManualBillingCancellation INNER JOIN\r\n\t\tBilling.Account ON ManualBill.UploadManualBillingCancellation.OriginalAccountNumber = Billing.Account.OriginalAccountNumber;\r\n\r\n\t/* added on 12/17/2018 for UniqueAccountSeqID */\r\n\tUPDATE ManualBill.UploadManualBillingAccount\r\n\tSET ManualBill.UploadManualBillingAccount.UniqueAccountSeqID = Billing.Account.UniqueAccountSeqID\r\n\tFROM ManualBill.UploadManualBillingAccount inner join Billing.Account on ManualBill.UploadManualBillingAccount.AccountSeqID = Billing.Account.AccountSeqID\r\n\tWHERE ManualBill.UploadManualBillingAccount.UniqueAccountSeqID IS NULL;\r\n\r\n\t/* added on 12/17/2018 for UniqueAccountSeqID */\r\n\tUPDATE ManualBill.UploadManualBillingCancellation\r\n\tSET ManualBill.UploadManualBillingCancellation.UniqueAccountSeqID = Billing.Account.UniqueAccountSeqID\r\n\tFROM ManualBill.UploadManualBillingCancellation inner join Billing.Account on ManualBill.UploadManualBillingCancellation.AccountSeqID = Billing.Account.AccountSeqID\r\n\tWHERE ManualBill.UploadManualBillingCancellation.UniqueAccountSeqID IS NULL;\r\n\r\n\r\n\t/* added on 12/17/2018 for UniqueAccountSeqID */\r\n\tUPDATE ManualBill.UploadManualBillingHeader\r\n\tSET UniqueAccountSeqID = Billing.Account.UniqueAccountSeqID\r\n\tFROM ManualBill.UploadManualBillingHeader INNER join Billing.Account on ManualBill.UploadManualBillingHeader.AccountSeqID = Billing.Account.AccountSeqID\r\n\tWHERE ManualBill.UploadManualBillingHeader.UniqueAccountSeqID IS NULL;\r\n\r\n\r\n-- ManualBill.UploadManualBillingHeader\r\n---- ManualBill.UploadManualBillingAccount\r\n---- ManualBill.UploadManualBillingCancellation\r\n\r\n\r\n\tSET @Status = 0;\r\nEND;"
        }
      ]
    }
  ]
}