{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ConEd",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Archive_usp_IdentifyAndCorrectMeterDataFromAndToDate",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "Archive_usp_IdentifyAndCorrectMeterDataFromAndToDate",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to correct meter data records in the "
        },
        {
          "type": "text",
          "text": "ConEd.UploadConEdisonMeter",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table. It updates the "
        },
        {
          "type": "text",
          "text": "toDate",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " field for meter records to ensure data consistency, particularly focusing on correcting the billing periods for each meter. The procedure also updates several other fields related to billing periods and calculates the number of billing days. The corrections are marked by setting the "
        },
        {
          "type": "text",
          "text": "IsEC3Corrected",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " flag to 'Y'."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is medium due to the following reasons:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple nested subqueries to determine the correct "
                },
                {
                  "type": "text",
                  "text": "toDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " values."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It updates multiple fields based on calculations and function calls."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It handles data consistency across potentially large datasets, which requires careful consideration of performance and correctness."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is intended to identify the user executing the procedure. However, it is not used within the procedure, suggesting it might be reserved for logging or auditing purposes outside the scope of this procedure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Correcting `toDate` for Latest `fromDate`:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "For each meter, the procedure identifies the record with the largest "
                        },
                        {
                          "type": "text",
                          "text": "fromDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and updates its "
                        },
                        {
                          "type": "text",
                          "text": "toDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to the maximum "
                        },
                        {
                          "type": "text",
                          "text": "toDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " found for that meter and account combination."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If multiple records have the same largest "
                        },
                        {
                          "type": "text",
                          "text": "fromDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", the one with the largest "
                        },
                        {
                          "type": "text",
                          "text": "toDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is updated."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Correcting `toDate` for Previous Records:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure updates the "
                        },
                        {
                          "type": "text",
                          "text": "toDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for records that are not the latest by setting it to the "
                        },
                        {
                          "type": "text",
                          "text": "fromDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " of the next record for the same meter and account combination."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "This ensures that the billing periods are contiguous without gaps."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updating Billing Information:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure updates billing-related fields such as "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriodRevision",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "FirstPeriodCanceled",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "DeltaNumberOfPeriods",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "CycleBillingDays",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " using custom functions."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "These updates are performed only on records marked as corrected ("
                        },
                        {
                          "type": "text",
                          "text": "IsEC3Corrected = 'Y'",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ")."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure outputs the number of corrected meter transactions using the "
                        },
                        {
                          "type": "text",
                          "text": "@@ROWCOUNT",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " system function."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Subquery Execution:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The use of nested subqueries for each update operation can be resource-intensive, especially on large datasets. Indexing on "
                },
                {
                  "type": "text",
                  "text": "AccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "MeterNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "fromDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "toDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can help improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure relies on several user-defined functions for calculations. The performance of these functions can significantly impact the overall execution time."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure updates records in the "
                },
                {
                  "type": "text",
                  "text": "ConEd.UploadConEdisonMeter",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, which may lead to locking issues if executed concurrently by multiple users."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Unused Parameter:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The "
                },
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is not utilized within the procedure, which could lead to confusion or missed opportunities for logging or auditing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure assumes that the meter billing range is always correct, which may not hold true if there are data entry errors or discrepancies in the source data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure lacks explicit error handling, which could result in unhandled exceptions or incomplete updates if an error occurs during execution."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " As the dataset grows, the performance of the procedure may degrade due to the complexity of the queries and the reliance on subqueries and function calls."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [ConEd].[Archive_usp_IdentifyAndCorrectMeterDataFromAndToDate] (@AuthenticatedUserID int)\nAS\r\n\r\n--**************************************************************************************\r\n--* Name:         \r\n--*\r\n--* Description:  \r\n--*               \r\n--*               \r\n--*               \r\n--* Exec:         usp_IdentifyAndCorrectMeterDataFromAndToDate\r\n--*\r\n--* Parameter(s):         \r\n--*                            UtilityCompanySeqid int   \t   - The sequence id of the Utility Companyto be processed\r\n--*                            StatusCode  int output       \t   -  Execution Return Status \r\n--*\r\n--* Database:     OEC\r\n--*\r\n--* Return:\t    0 Success\r\n--*                   9 Failure\r\n--*\r\n--* AUTHOR:       Peter Heller (PAH)\r\n--* Created On:   10/26/2005\r\n--**************************************************************************************\r\n--* Date         Tech Description of Change\r\n--* ---------- ----  -------------------------------------------------------------\r\n--* 05/16/2006 PAH  First Version  \r\n--***************************************************************************************\r\nBegin \r\n--************************************************************************************** \r\n--Declare Variables                                            \r\n--**************************************************************************************\r\n--\r\n----\r\n\r\n/*\r\n\tFor each meter, meter record with the largest fromDate will have the largest toDate.\r\n\tIf there are more than one record with the largest fromDate, the record with the largest current toDate value and with the same fromDate will \r\n\tbe updated with the largest toDate value.\r\n*/\r\nupdate ConEd.UploadConEdisonMeter\r\n\tset IsEC3Corrected = 'Y',\r\n\ttoDate =(\r\n\t\t\t\tselect max(todate) \r\n\t\t\t\tfrom ConEd.UploadConEdisonMeter as meter\r\n\t\t\t\twhere \r\n\t\t\t\tmeter.AccountNumber= ConEd.UploadConEdisonMeter.AccountNumber and\r\n\t\t\t\tmeter.MeterNumber = ConEd.UploadConEdisonMeter.MeterNumber\r\n\t\t\t)\r\n\tfrom ConEd.UploadConEdisonMeter -- as UploadConEdisonMeterCorrection\r\n\twhere \r\n\tfromDate = \r\n\t(\r\n\t\tselect max(fromDate) \r\n\t\tfrom ConEd.UploadConEdisonMeter as meter2\r\n\t\twhere \r\n\t\tmeter2.AccountNumber= ConEd.UploadConEdisonMeter.AccountNumber and\r\n\t\tmeter2.MeterNumber = ConEd.UploadConEdisonMeter.MeterNumber\r\n\t)\r\n\tand\r\n\ttoDate =\r\n\t(\r\n\t\tselect max(meter3.toDate)\r\n\t\tfrom ConEd.UploadConEdisonMeter as meter3\r\n\t\twhere\r\n\t\tmeter3.AccountNumber= ConEd.UploadConEdisonMeter.AccountNumber and\r\n\t\tmeter3.MeterNumber = ConEd.UploadConEdisonMeter.MeterNumber and\r\n\t\tmeter3.fromDate = ConEd.UploadConEdisonMeter.fromDate\r\n\t)\r\n\t\t\t\t\r\n--\r\n--\tAssumption that the meter billing range is always correct.  Problems may occur when there are splits spans\r\n--\tor just plain errors from Con Edison.  The data is corrected in the UploadConEdisonMeterUncorrected table.\r\n--\r\nupdate ConEd.UploadConEdisonMeter\r\nset \r\n\tIsEC3Corrected = 'Y',\r\n\ttoDate =(\r\n\t\t\t\t-- \r\n\t\t\t\t-- Finding the minimum from date for the account and meter combination and the todate is equal to\r\n\t\t\t\t-- the fromdate of the next meter reading\r\n\t\t\t\t-- \r\n\t\t\t\tselect min(Fromdate) \r\n\t\t\t\tfrom ConEd.UploadConEdisonMeter as t2\r\n\t\t\t\twhere t2.FromDate > ConEd.UploadConEdisonMeter.FromDate and\r\n\t\t\t\tt2.AccountNumber= ConEd.UploadConEdisonMeter.AccountNumber and\r\n\t\t\t\tt2.MeterNumber = ConEd.UploadConEdisonMeter.MeterNumber\r\n\t\t\t)\r\n\t\t\tfrom ConEd.UploadConEdisonMeter -- as UploadConEdisonMeterCorrection\r\n\t\t\t-- \r\n\t\t\t-- This processes n-1 meter billing transaction for the account and meter combination and\r\n\t\t\t-- always assumes that min(from date) to the max(todate) is equal to the account billing range.\r\n\t\t\t-- Note: the nth transaction is skipped due to being correct by using \"is not null\" in the where clause.\r\n\t\t\t--\r\n\t\t\twhere (select min(Fromdate) \r\n\t\t\t\tfrom ConEd.UploadConEdisonMeter as t2\r\n\t\t\t\twhere t2.FromDate > ConEd.UploadConEdisonMeter.FromDate and\r\n\t\t\t\tt2.AccountNumber= ConEd.UploadConEdisonMeter.AccountNumber and\r\n\t\t\t\tt2.MeterNumber = ConEd.UploadConEdisonMeter.MeterNumber ) is not null\r\n--\r\nupdate ConEd.UploadConEdisonMeter\r\nset \r\n\tBillingPeriodRevision = [dbo].[DetermineConEdisonBillingPeriodProjected] (ToDate ,[dbo].[DetermineConEdisonGetGasTariffRateFromAccountTable] (AccountNumber,BillingPeriodRevision),9),\r\n\tFirstPeriodCanceled = [dbo].[CalculateNextBillingPeriod]([dbo].[DetermineConEdisonBillingPeriodProjected](FromDate,[dbo].[DetermineConEdisonGetGasTariffRateFromAccountTable] (AccountNumber,BillingPeriodRevision),9),'M'),\r\n\tDeltaNumberOfPeriods = [dbo].[CalculateDeltaBillingPeriods]  ([dbo].[CalculateNextBillingPeriod]([dbo].[DetermineConEdisonBillingPeriodProjected](FromDate,[dbo].[DetermineConEdisonGetGasTariffRateFromAccountTable] (AccountNumber,BillingPeriodRevision),9),'M'),[dbo].[DetermineConEdisonBillingPeriodProjected] (ToDate ,[dbo].[DetermineConEdisonGetGasTariffRateFromAccountTable] (AccountNumber,BillingPeriodRevision),9),'M'),\r\n\tCycleBillingDays = dbo.[CalculateNumberOfBillingDays]  (FromDate,ToDate)\r\nwhere IsEC3Corrected = 'Y'\r\n--\r\nselect 'Number of Meter transactions corrected in the UploadConEdisonMeter table: ',@@rowcount\r\n--\r\nend"
        }
      ]
    }
  ]
}