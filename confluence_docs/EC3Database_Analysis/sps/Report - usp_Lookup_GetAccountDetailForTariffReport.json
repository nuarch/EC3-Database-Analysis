{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Lookup_GetAccountDetailForTariffReport",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Lookup_GetAccountDetailForTariffReport",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve detailed account information for generating a tariff report. It processes input parameters to filter and select account data, utility tariff information, and related billing details. The procedure logs its usage, handles input parameters, and performs complex data retrieval operations involving multiple tables and joins."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is high due to several factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple conditional logic branches and dynamic data handling."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It processes XML input for utility tariff information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs several joins across different tables, including user-defined functions and temporary tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes complex business logic for filtering and selecting data based on various criteria."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityTariffInformationSeqIDs AS XML = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": XML input containing selected utility tariff information sequence IDs."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BeginningFiscalYear AS yyyy",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The fiscal year to start retrieving data from."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OriginalAccountNumber AS acctnum = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional filter for specific account numbers."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional filter for agency codes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Email address of the requester, used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StartIndex AS INT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional pagination start index."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EndIndex AS INT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Optional pagination end index."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure logs its execution using "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", capturing details like the report name, stored procedure name, and requester email."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Agency Code Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If no agency code is provided, it defaults to '*', indicating all agencies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Utility Tariff Information",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If no specific utility tariff information is provided, it selects all available tariffs."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If provided, it parses the XML to extract specific tariff IDs."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Period Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Determines the beginning billing period for the specified fiscal year."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieves the current published billing period."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Selection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Populates a temporary table "
                        },
                        {
                          "type": "text",
                          "text": "@SelectedAccounts",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " with account details, joining multiple tables to gather comprehensive data."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Filters accounts based on status and optional account number."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Joins "
                        },
                        {
                          "type": "text",
                          "text": "@SelectedAccounts",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " with tariff and billing data to compile the final report data."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Applies additional filters based on billing periods."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but may lead to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "XML Parsing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Parsing XML can be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Temporary Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Multiple joins and the use of temporary tables can impact performance, particularly with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a non-clustered index on "
                },
                {
                  "type": "text",
                  "text": "@SelectedAccounts",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " helps optimize query performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level can lead to reading uncommitted data, which might not be suitable for all reporting needs."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "XML Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Errors in XML structure or large XML inputs can cause performance degradation or failures."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the complexity and number of joins may lead to performance bottlenecks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or incomplete data processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include any input validation or sanitization, which could expose it to SQL injection risks, especially with dynamic inputs like "
                },
                {
                  "type": "text",
                  "text": "@OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Lookup_GetAccountDetailForTariffReport]\n(\r\n    @UtilityTariffInformationSeqIDs AS XML = NULL\r\n\t,@BeginningFiscalYear AS yyyy\r\n\t,@OriginalAccountNumber AS acctnum = NULL\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX) = NULL\r\n\t,@EmailAddress AS emailaddr\r\n\t,@StartIndex AS INT = NULL\r\n\t,@EndIndex AS INT = NULL\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\t DECLARE @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID)\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName\t\t\t\t\t= @spname,\r\n\t\t@StoredProcName\t\t\t\t= @spname,\r\n\t\t@RequestedBy\t\t\t\t= @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod\t= null,\r\n\t\t@prmBillingPeriod\t\t\t= NULL,\r\n\t\t@prmAgency_ies\t\t\t\t= @AgencyCodeOEC,\r\n\t\t@prmFacilityNumber_s\t\t= NULL,\r\n\t\t@prmStartingBillingPeriod\t= NULL,\r\n\t\t@prmEndingBillingPeriod\t\t= NULL\r\n\r\n\t/*  Select information for agencies if agency is not specified by user */\r\n    IF (@AgencyCodeOEC IS NULL OR LTRIM(RTRIM(@AgencyCodeOEC)) = '')\r\n    BEGIN\r\n        SET @AgencyCodeOEC = '*';\r\n    END;\r\n\r\n    DECLARE @UtilityTariffInformation TABLE(UtilityTariffInfomrationSeqid INT);\r\n\t\r\n\t-- if utility tariff is null, select all utility tariff\r\n    IF (@UtilityTariffInformationSeqIDs IS NULL)\r\n    BEGIN\r\n        INSERT INTO @UtilityTariffInformation(UtilityTariffInfomrationSeqid)\r\n        SELECT UtilityTariffRateInformationSeqid\r\n        FROM Billing.UtilityTariffRateInformation;\r\n    END;\r\n    ELSE\r\n    BEGIN\r\n\t\t-- parse the xml for selected utility tariff information\r\n        INSERT INTO @UtilityTariffInformation(UtilityTariffInfomrationSeqid)\r\n        SELECT CAST(CAST(tbl.col.query('data(UtilityTariffInformationSeqID)') AS VARCHAR) AS INT)\r\n        FROM @UtilityTariffInformationSeqIDs.nodes('//serviceClasses//serviceClass') tbl (col);\r\n    END;\r\n\t\r\n    DECLARE @BeginningPeriod AS BillingPeriod, @CurrentPublishedBillingPeriod AS BillingPeriod;\r\n\t\r\n\t-- get the beginning period for @BeginningFiscalYear\r\n    SELECT @BeginningPeriod = dbo.CreateFiscalYearPeriod(@BeginningFiscalYear, 'S');\r\n\r\n\tSELECT @CurrentPublishedBillingPeriod = MAX(PublishedBillingPeriod)\r\n    FROM Published.MonthlyPublishedSummaryData;\r\n\t\t\r\n    DECLARE @SelectedAccounts TABLE\r\n        (AccountSeqID seqid\r\n        ,OriginalAccountNumber acctnum\r\n        ,AgencyDivisionSeqID seqid\r\n        ,AgencyName ldesc\r\n        ,AgencyCodeOEC AgencyCodeOEC\r\n        ,UtilityTariffRateInformationSeqid seqid\r\n        ,UtilityCompanySeqID seqid\r\n        ,UtilityCompanyName ldesc\r\n        ,FacilitySeqId seqid  NULL\r\n        ,OECFacilityNumber OECBuildingNumber NULL\r\n        ,FacilityName SeptsBuildName NULL\r\n        ,FacilityAddress LongAddress NULL\r\n        ,UtilityServiceAddress LongAddress\r\n\t\t,EnergySource seqid\r\n\t\t,UNIQUE NONCLUSTERED (AccountSeqID, OriginalAccountNumber, UtilityTariffRateInformationSeqid, AgencyDivisionSeqID, FacilitySeqId));\r\n\r\n    INSERT INTO @SelectedAccounts\r\n        (AccountSeqID\r\n        ,OriginalAccountNumber\r\n        ,AgencyDivisionSeqID\r\n        ,AgencyName\r\n        ,AgencyCodeOEC\r\n        ,UtilityTariffRateInformationSeqid\r\n        ,UtilityCompanySeqID\r\n        ,UtilityCompanyName\r\n        ,FacilitySeqId\r\n        ,OECFacilityNumber\r\n        ,FacilityName\r\n        ,FacilityAddress\r\n        ,UtilityServiceAddress\r\n\t\t,EnergySource)\r\n    SELECT A.AccountSeqid\r\n        ,A.OriginalAccountNumber\r\n        ,A.AgencyAccount AS AgencyDivisionSeqID\r\n        ,ad.AgencyName\r\n        ,ad.AgencyCodeOEC\r\n        ,A.UtilityTariffRateInformationSeqid\r\n        ,A.UtilityAccountProvider AS UtilityCompanySeqID\r\n        ,uc.[Description] AS UtilityCompanyName\r\n        ,f.FacilitySeqid\r\n        ,f.OecFacilityNumber\r\n        ,f.FacilityName\r\n        ,f.Address1 FacilityAddress\r\n        ,A.UtilityServiceAddress\r\n\t\t,A.EnergyAccountDescription EnergySource\r\n    FROM Billing.Account AS A\r\n        INNER JOIN Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS ad ON A.AgencyAccount = ad.AgencyDivisionSeqID\r\n        INNER JOIN Billing.UtilityCompany AS uc ON A.UtilityAccountProvider = uc.UtilityCompanySeqid\r\n        INNER JOIN @UtilityTariffInformation AS uti ON A.UtilityTariffRateInformationSeqid = uti.UtilityTariffInfomrationSeqid\r\n        INNER JOIN Billing.Facility AS f ON A.FacilityAccount = f.FacilitySeqid\r\n    WHERE A.AccountStatus IN ('AC', '46', 'UA') AND A.OriginalAccountNumber LIKE ISNULL(@OriginalAccountNumber, '%');\r\n\r\n\tSELECT ROW_NUMBER() OVER (ORDER BY sa.AgencyCodeOEC, sa.OriginalAccountNumber) AS rowNumber\r\n\t\t,tariff.DeliveryTariffRate\r\n\t\t,sa.OriginalAccountNumber\r\n\t\t,publishedAccountData.RevisedBilledAmount\r\n\t\t,ISNULL(publishedAccountData.RevisedReactivePowerDollars, 0) AS RevisedReactivePowerDollars\r\n\t\t,ISNULL(publishedAccountData.AccountReactivePowerEnergy, 0) AS ReactivePowerKVAR\r\n\t\t,publishedAccountData.RevisedDemandDollar AS DemandUsageDollars\r\n\t\t,CASE WHEN sa.UtilityCompanySeqID = 7 THEN publishedAccountData.RevisedEnergyDollar ELSE publishedAccountData.RevisedBilledAmount END AS EnergyUsageDollars\r\n\t\t,publishedAccountData.AccountDemandUsage\r\n\t\t,publishedAccountData.AccountEnergyUsage\r\n\t\t,publishedAccountData.BillingPeriod\r\n\t\t,sa.AgencyDivisionSeqID\r\n\t\t,sa.AgencyCodeOEC\r\n\t\t,sa.AgencyName\r\n\t\t,sa.UtilityCompanyName AS UtilityCompany\r\n\t\t,tariff.EnergyDeliveryType AS EnergyType\r\n\t\t,dbo.CalculateFiscalYear(publishedAccountData.BillingPeriod) AS FiscalYear\r\n\t\t,LEFT(DATENAME(MONTH, DATEADD(MONTH, CAST(SUBSTRING(publishedAccountData.BillingPeriod, 5, 2) AS INT), 0) - 1), 3) AS mon\r\n\t\t,publishedAccountData.EnergyUnit\r\n\t\t,tariff.[Description] AS tariffRateDescription\r\n\t\t,sa.AccountSeqID\r\n\t\t,sa.FacilitySeqId\r\n\t\t,sa.OECFacilityNumber\r\n\t\t,sa.FacilityName\r\n\t\t,sa.FacilityAddress\r\n\t\t,sa.UtilityServiceAddress\r\n    FROM @SelectedAccounts AS sa\r\n        INNER JOIN Billing.UtilityTariffRateInformation AS tariff ON sa.UtilityTariffRateInformationSeqid = tariff.UtilityTariffRateInformationSeqid\r\n\t\tINNER JOIN Billing.EnergyDeliveryType EDT ON EDT.EnergyDeliveryType = sa.EnergySource\r\n        LEFT JOIN Published.TemporalAccountLevelRawDataForCurrentPeriod AS publishedAccountData ON publishedAccountData.AccountSeqid = sa.AccountSeqID\r\n    WHERE publishedAccountData.BillingPeriod >= @BeginningPeriod\r\n        AND publishedAccountData.EffectiveStartPeriod <= @CurrentPublishedBillingPeriod\r\n\t\tAND publishedAccountData.EffectiveEndPeriod > @CurrentPublishedBillingPeriod;\r\nEND;"
        }
      ]
    }
  ]
}