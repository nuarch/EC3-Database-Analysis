{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "NationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_LegacyData_ProcessAccountCancellationUnspanned",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_LegacyData_ProcessAccountCancellationUnspanned",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process account cancellations for a legacy system within the "
        },
        {
          "type": "text",
          "text": "NationalGridWest",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " schema. It performs data migration and transformation tasks by moving data from a preload table to an upload table and then to a summary table. The procedure handles account cancellations by calculating billing periods, updating records, and summarizing the data for further processing."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this stored procedure is medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple data transformations and calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses several user-defined functions for data conversion and calculation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes conditional logic for updating records based on specific criteria."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It interacts with multiple tables and requires understanding of the business rules embedded in the logic."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period in the format "
                },
                {
                  "type": "text",
                  "text": "YYYYMM",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@authenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the authenticated user executing the procedure, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingCycle varchar(1)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing cycle, which is used in determining billing periods."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Migration from Preload to Upload Table:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by inserting data from "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyNationalGridWestDataPreload",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " into "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs data transformations using user-defined functions to convert account numbers, dates, and other fields into the required format."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Only records with a negative billed amount are considered for insertion."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updating Billing Periods:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure updates the "
                },
                {
                  "type": "text",
                  "text": "BillingPeriodRevision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "FirstPeriodCanceled",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " fields using a function "
                },
                {
                  "type": "text",
                  "text": "DetermineBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It ensures that these fields do not exceed the current billing period."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculating Delta Number of Periods:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The "
                },
                {
                  "type": "text",
                  "text": "DeltaNumberOfPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is calculated using the "
                },
                {
                  "type": "text",
                  "text": "CalculateDeltaBillingPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " function, which determines the difference between the first canceled period and the billing period revision."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Records with invalid billing periods (those starting with 'X') are ignored."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Migration to Summary Table:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure inserts records from "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " into "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestCancellationSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes various calculated fields and default values for fields not directly derived from the source data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Only records with "
                },
                {
                  "type": "text",
                  "text": "DeltaNumberOfPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " less than or equal to 1 are considered."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " Ensure that the tables involved have appropriate indexes, especially on columns used in WHERE clauses and JOIN conditions, to improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The use of scalar functions in SELECT statements can impact performance. Consider inlining these functions or optimizing them if performance issues arise."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " If the tables contain a large number of records, consider processing the data in batches to avoid locking and reduce transaction log usage."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure assumes that the user-defined functions return valid and expected results. Any changes to these functions could affect the procedure's output."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure lacks explicit error handling. Consider adding TRY...CATCH blocks to handle exceptions and log errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure does not include any locking hints or transaction management, which could lead to concurrency issues if multiple instances are run simultaneously."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " Some values, such as "
                },
                {
                  "type": "text",
                  "text": "AccountUtilityCompanySeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", are hardcoded, which reduces flexibility and could lead to maintenance challenges if these values change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Assumptions on Data Validity:",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " The procedure assumes that all data transformations and calculations will succeed without validating the input data for anomalies or inconsistencies."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [NationalGridWest].[usp_LegacyData_ProcessAccountCancellationUnspanned]\r\n\t@BillingPeriod varchar(6),\r\n\t@authenticatedID int,\r\n\t@BillingCycle varchar(1)\r\nAS\r\nBEGIN\r\n\r\n/*************************************\r\n 1. Move data from preload to upload\r\n**************************************/\r\ninsert into NationalGridWest.UploadLegacyKeyspanWestCancellation\r\n\t([BillingPeriod]\r\n   ,[BillingPeriodRevision]\r\n   ,[FirstPeriodCanceled]\r\n   ,[DeltaNumberOfPeriods]\r\n   ,[RecordType]\r\n   ,[AccountNumber]\r\n   ,[MeterNumber]\r\n   ,[FacilityName]\r\n   ,[ServiceAddress]\r\n   ,[FromDate]\r\n   ,[ToDate]\r\n   ,[BillingPeriodDays]\r\n   ,[CCF]\r\n   ,[BilledAmount]\r\n   ,[Therms]\r\n   ,[ThermFactor]\r\n   ,[TariffCode]\r\n   ,[Dials]\r\n   ,[FiscalYear]\r\n   ,[PostingDate]\r\n   ,[EstimatedOrActual]\r\n   ,[AuthenticatedUserID]\r\n   ,[DateAdded]\r\n   ,[LastUpdate])\r\nselect \r\n\tBillingPeriod, \r\n\tnull as [BillingPeriodRevision], \r\n\tnull as [FirstPeriodCanceled], \r\n\tnull as [DeltaNumberOfPeriods], \r\n\tnull as [RecordType], \r\n\tdbo.KeyspanConvertLegacyAccountToEC3Number(dbo.KeyspanConvertCancellationAccountNumber([KeyspanOldAccountNumber],BilledAmount)) as EC3AccountNumber, \r\n\tMeterNumber,\r\n\t[UtilityServiceAccountName] as FacilityName, \r\n\t[UtilityServiceAddress] as ServiceAddress, \r\n\tdbo.MMDDYKeyspanToYYYYMMDD(FromDateMMDDY) as FromDate, \r\n\tdbo.MMDDYKeyspanToYYYYMMDD(ToDateMMDDY) as ToDate, \r\n\tcast(dbo.ConvertOverpunch(NumberOfBillingDays) as int) as NumberOfBillingDays, \r\n\tcast(dbo.ConvertOverpunch(CCF) as int) as CCF, \r\n\tdbo.ConvertOverpunch9ToMoney(BilledAmount) as BilledAmount,\r\n\tcast(dbo.ConvertOverpunch(Therms) as int) as Therms, \r\n\tcast(dbo.ConvertOverpunch5ToDecimal(ThermsFactor) as numeric(6,4)) as ThermsFactor, \r\n\tnull as TariffCode, \r\n\tcast(NumberOfDials as int) as [Dials], \r\n\tnull as FiscalYear,\t\t\r\n\tnull as PostingDate, \r\n\t(case when EstimatedOrActualBillingCode = 'ES' then 'EST' else 'ACT' end),\r\n\t@authenticatedID, \r\n\tgetdate(),\r\n\tgetdate()\r\nFROM NationalGridWest.UploadLegacyNationalGridWestDataPreload\r\nwhere\r\ncast(dbo.ConvertOverpunch(BilledAmount) as money) < 0\r\n\r\n-- update revision biling period\r\nupdate NationalGridWest.UploadLegacyKeyspanWestCancellation\r\nset \r\n\tBillingPeriodRevision = NationalGridWest.DetermineBillingPeriod(@BillingCycle, ToDate, 'T', substring(AccountNumber, 12, 2)),\r\n\tFirstPeriodCanceled = NationalGridWest.DetermineBillingPeriod(@BillingCycle, FromDate, 'F', substring(AccountNumber, 12, 2))\r\n\r\nUPDATE NationalGridWest.UploadLegacyKeyspanWestCancellation\r\n\tSET\r\n\t\tBillingPeriodRevision = CASE WHEN BillingPeriodRevision>@BillingPeriod THEN @BillingPeriod ELSE BillingPeriodRevision end,\r\n\t\tFirstPeriodCanceled = CASE WHEN FirstPeriodCanceled>@BillingPeriod THEN @BillingPeriod ELSE FirstPeriodCanceled\t\tEND\r\n\r\n\r\n-- update number of period. ignore account with invalid billing period\r\nupdate NationalGridWest.UploadLegacyKeyspanWestCancellation\r\nset DeltaNumberOfPeriods = [dbo].[CalculateDeltaBillingPeriods](FirstPeriodCanceled, BillingPeriodRevision, @BillingCycle)\r\nwhere not(BillingPeriodRevision like 'X%' or FirstPeriodCanceled like 'X%')\r\n\r\n\r\n\r\n\r\n\r\n\r\n/*************************************************************\r\n\t2. move unspanned data from upload table to summary table \r\n***************************************************************/\r\nINSERT INTO [NationalGridWest].[UploadLegacyKeyspanWestCancellationSummary]\t\r\n   ([AdjustedAccount]\t\t\t\r\n   ,[AccountUtilityCompanySeqid]\t\t\t\r\n   ,[NumberOfTransactions]\t\t\t\r\n   ,[NumberOfRebillTransactions]\t\t\t\r\n   ,[NumberOfCancelTransactions]\t\t\t\r\n   ,[OriginalAccountNumber]\t\t\t\r\n   ,[BillingPeriod]\t\t\t\r\n   ,[BillingPeriodRevision]\t\t\t\r\n   ,[FirstCanceledBillingPeriod]\t\t\t\r\n   ,[EstimatedOrActualBilling]\t\t\t\r\n   ,[InitialCancelFromDate]\t\t\t\r\n   ,[CurrentBillingToDate]\t\t\t\r\n   ,[NumberOfBillingPeriods]\t\t\t\r\n   ,[TotalBillingDaysRebilled]\t\t\t\r\n   ,[TotalRebilledAmount]\t\t\t\r\n   ,[TotalCanceledAmount]\t\t\t\r\n   ,[AverageRebillCostOfGasCharge]\t\t\t\r\n   ,[AverageRebillThermsFactor]\t\t\t\r\n   ,[BillingDays]\t\t\t\r\n   ,[BillingDate]\t\t\t\r\n   ,[ToDate]\t\t\t\r\n   ,[FromDate]\t\t\t\r\n   ,[MTATaxAmount]\t\t\t\r\n   ,[BillingAction]\t\t\t\r\n   ,[ProcessedInTheCurrentPeriod]\t\t\t\r\n   ,[GasRateCode]\t\t\t\r\n   ,[TotalCCF]\t\t\t\r\n   ,[TotalTherms]\t\t\t\r\n   ,[ThermsFactor]\t\t\t\r\n   ,[CancelFromDate]\t\t\t\r\n   ,[CancelToDate]\t\t\t\r\n   ,[CancelTotalCCF]\t\t\t\r\n   ,[CancelTotalTherms]\t\t\t\r\n   ,[CancelThermsFactor]\r\n   ,[CancelBillingDays]\t\t\t\r\n   ,[ProcessEffectiveDate]\t\t\t\r\n   ,[Notes]\t\t\t\r\n   ,[AuthenticatedUserID]\t\t\t\r\n   ,[DateAdded]\t\t\t\r\n   ,[LastUpdate]\t\t\t\r\n   ,[DeliveryChargeAmount]\t\t\t\r\n   ,[ThermsChargeAmount]\t\t\t\r\n   ,[DiscountedAmount]\t\t\t\r\n   ,[DiscountPercentage]\t\t\t\r\n   ,[CustomerMinimumCharge]\t\t\t\r\n   ,[CostOfGasCharge]\t\t\t\r\n   ,[SpecialCharge]\t\t\t\r\n   ,[SomeCharge]\t\t\t\r\n   ,[CancelDeliveryChargeAmount]\t\t\t\r\n   ,[CancelThermsChargeAmount]\t\t\t\r\n   ,[CancelDiscountedAmount]\t\t\t\r\n   ,[CancelDiscountPercentage]\t\t\t\r\n   ,[CancelCustomerMinimumCharge]\t\t\t\r\n   ,[CancelCostOfGasCharge]\t\t\t\r\n   ,[CancelSpecialCharge]\t\t\t\r\n   ,[CancelSomeCharge])\t\t\r\nSELECT \t\t\t\r\n\tNULL, -- (<AdjustedAccount, seqid,>\r\n\t9, -- <AccountUtilityCompanySeqid, seqid,>\r\n\t1, --[NumberOfTransactions]\t\r\n\t0, -- [NumberOfRebillTransactions]\t\t\t\r\n\t1, -- [NumberOfCancelTransactions]\t\r\n\tAccountNumber, --<OriginalAccountNumber, acctnum,>\r\n\tBillingPeriod, -- <BillingPeriod, BillingPeriod,>\t\r\n\tBillingPeriodRevision,\t-- <BillingPeriodRevision, BillingPeriodRevision,>\r\n\tFirstPeriodCanceled,\t--<FirstCanceledBillingPeriod, yyyymm,>\r\n\tEstimatedOrActual, -- <EstimatedOrActualBilling, varchar(3),>\r\n\tFromDate, -- <InitialCancelFromDate, yyyymmdd,>\r\n\tToDate,\t-- <CurrentBillingToDate, yyyymmdd,>\r\n\tDeltaNumberOfPeriods,\t--<NumberOfBillingPeriods, int,>\t\r\n\tdbo.CalculateNumberOfBillingDays(FromDate, ToDate),\t--<TotalBillingDaysRebilled, int,>\r\n\t0, --<TotalRebilledAmount, money,>\r\n\tBilledAmount, -- <TotalCanceledAmount, money,>\r\n\t0,\t-- <AverageRebillCostOfGasCharge, money,>\r\n\t1.0, -- <AverageRebillThermsFactor, ThermsFactor,>\r\n\t0, -- <BillingDays, int,>\r\n\tPostingDate, -- <BillingDate, int,>\r\n\tnull, -- <ToDate, yyyymmdd,>\r\n\tnull, -- <FromDate, yyyymmdd,>\r\n\t0, -- <MTATaxAmount, money,>\r\n\tCASE WHEN BillingPeriod=BillingPeriodRevision THEN 'O' ELSE 'A' END, -- ,<BillingAction, BillingAction,>\r\n\t'N', -- <ProcessedInTheCurrentPeriod, yesno,>\r\n\tTariffCode,\t-- <GasRateCode, varchar(3),>\r\n\t0,-- <TotalCCF, EnergyUnit,>\r\n\t0,-- <TotalTherms, EnergyUnit,>\r\n\t1.0, --\t<ThermsFactor, ThermsFactor,>\r\n\tFromDate,\t-- <CancelFromDate, yyyymmdd,>\r\n\tToDate,\t--<CancelToDate, yyyymmdd,>\r\n\tCCF, -- <CancelTotalCCF, EnergyUnit,>\r\n\tTherms,\t--<CancelTotalTherms, EnergyUnit,>\r\n\tThermFactor,--<CancelThermsFactor, ThermsFactor,>\r\n\tdbo.CalculateNumberOfBillingDays(FromDate,ToDate), --<CancelBillingDays>\r\n\t[dbo].ConvertDateToYYYYMMDD (GETDATE()), -- <ProcessEffectiveDate, varchar(8),>\r\n\tNULL,\t\t\t\r\n\t1,\t\t\t\r\n\tGETDATE(),\t\t\t\r\n\tGETDATE(),\t\t\t\r\n\t0, -- <DeliveryChargeAmount, BillingAmt,>\r\n\t0, --<ThermsChargeAmount, BillingAmt,>\r\n\t0, --<DiscountedAmount, BillingAmt,>\r\n\t0, --<DiscountPercentage, DiscountPercentage,>\r\n\t0, --<CustomerMinimumCharge, BillingAmt,>\r\n\tnull, -- <CostOfGasCharge, BillingAmt,>\r\n\t0, --<SpecialCharge, BillingAmt,>\r\n\t0, --<SomeCharge, money,>\r\n\tNULL, --<CancelDeliveryChargeAmount, BillingAmt,>\r\n\tNULL, --<CancelThermsChargeAmount, BillingAmt,>\r\n\tNULL, --<CancelDiscountedAmount, BillingAmt,>\r\n\tNULL, --<CancelDiscountPercentage, DiscountPercentage,>\r\n\tNULL, --<CancelCustomerMinimumCharge, BillingAmt,>\r\n\tNULL, --<CancelCostOfGasCharge, BillingAmt,>\r\n\tNULL, --<CancelSpecialCharge, BillingAmt,>\r\n\tNULL --<CancelSomeCharge, money,>*/\r\nFROM NationalGridWest.UploadLegacyKeyspanWestCancellation\t\r\nWHERE DeltaNumberOfPeriods<=1\t\r\n\r\n\r\nEND"
        }
      ]
    }
  ]
}