{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Common",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchange_CodeAX_Revert",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "[Common].[usp_ProcessExchange_CodeAX_Revert]",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to revert an account exchange process in a Microsoft SQL Server database. It checks various conditions to ensure the exchange can be reverted, performs the necessary database operations to undo the exchange, and updates the status of the exchange record. The procedure uses transactions to ensure data integrity and handles errors using a TRY-CATCH block."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Multiple conditional checks and validations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Use of transactions and error handling."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Involvement of multiple tables and a Common Table Expression (CTE) for data manipulation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure involves both SELECT and DELETE operations, as well as an UPDATE operation with a CTE."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for the exchange record to be reverted."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user performing the operation, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode INT OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter that indicates the success (1) or failure (0) of the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Message VARCHAR(1000) OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter that provides a message detailing the result of the procedure or any errors encountered."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Checks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure checks if the exchange record is flagged as excluded. If so, it exits with a message and a status code of 1."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It verifies the existence of the exchange record. If not found, it exits with a message and a status code of 0."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It checks if the exchange has been processed. If not, it exits with a message and a status code of 0."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Account Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieves the "
                        },
                        {
                          "type": "text",
                          "text": "AccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "OriginalAccountNumber",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " from the "
                        },
                        {
                          "type": "text",
                          "text": "ExchangeData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Checks if the account is active in the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table. If not, it exits with a message and a status code of 0."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction and Reversion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Begins a transaction named "
                        },
                        {
                          "type": "text",
                          "text": "RevertExchangeAccount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieves the "
                        },
                        {
                          "type": "text",
                          "text": "UniqueAccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " for the account."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Deletes records from "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountExchangeMeterTrack",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " related to the "
                        },
                        {
                          "type": "text",
                          "text": "AccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses a CTE to fetch the most recent version of the account from "
                        },
                        {
                          "type": "text",
                          "text": "Audit.AuditAccount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and updates the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table with this data."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Commits the transaction if all operations succeed."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Post-Transaction Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates the "
                        },
                        {
                          "type": "text",
                          "text": "IsProcessed",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " status of the exchange record to 'R' to indicate reversion."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Sets the output message to an empty string and the status code to 1."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If an error occurs, the transaction is rolled back, and an error message is set in the output parameters."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the "
                },
                {
                  "type": "text",
                  "text": "ExchangeDataSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "UniqueAccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " columns are indexed to optimize the SELECT and DELETE operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is well-defined, but the procedure could be optimized by minimizing the data locked during the transaction."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "CTE Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The CTE is used efficiently to retrieve the latest account version, but performance can be impacted if the "
                },
                {
                  "type": "text",
                  "text": "Audit.AuditAccount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is large and not properly indexed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves DELETE operations and updates within a transaction, which could lead to locking issues if multiple instances of the procedure are run concurrently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure fails after deleting records but before completing the reversion, it could leave the database in an inconsistent state. However, the use of transactions mitigates this risk."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While the procedure includes error handling, it does not log errors to a persistent store, which could be useful for auditing and troubleshooting."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of the CTE and the transaction could degrade if not properly indexed and optimized."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Common].[usp_ProcessExchange_CodeAX_Revert] @ExchangeSeqid INT , @AuthenticatedUserID INT, @StatusCode int OUTPUT, @Message VARCHAR(1000) out\n AS \r\n\r\n--**************************************************************************************\r\n--* Description:\t\"AX\" revert an account exchange\r\n--*\r\n--* AUTHOR:       Zafer Durmaz\r\n--* Created On:   06/24/2016\r\n--**************************************************************************************\r\n--* Change Log\r\n--* \r\n--* 06/24/2016 zd  First Version \r\n--**************************************************************************************\r\n\r\nBEGIN\r\n\r\n\t\tDECLARE @RecordExchangeCode VARCHAR(2)\r\n\r\n\r\n\t\t-- if the record is flagged as exclude, return and exit\r\n\t\tIF ( 'Y' = ( SELECT Exclude FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'This exchange is excluded from processing. ExchangeSeqid: ' + CAST( @ExchangeSeqid AS VARCHAR ) \r\n\t\t\tSET @StatusCode = 1\t-- this is not necessary an error\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- do some validation \r\n\r\n\t\t-- CHECK IF the record exists\r\n\t\tIF ( NOT EXISTS ( SELECT ExchangeDataSeqid FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid ))\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The ExchangeSeqid ' + CAST( @ExchangeSeqid AS VARCHAR ) + ' does not exist. Please verify '\r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- check if the record was not processed\r\n\t\tIF ( 'N' = ( SELECT IsProcessed FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'This exchange was not processed. It cannot be reverted ExchangeSeqid: ' + CAST( @ExchangeSeqid AS VARCHAR ) \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- the process to add an AccountSeqid\r\n\t\tDECLARE @AccountSeqid int\r\n\t\tDECLARE @UniqueAccountSeqid INT\r\n        DECLARE @AccountNumber VARCHAR(15)\r\n        \r\n\t\tSELECT @AccountSeqid = AccountSeqid, @AccountNumber = OriginalAccountNumber FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid\r\n\r\n\t\tIF ( @AccountSeqid IS NULL )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The Exchange ' + CAST( @ExchangeSeqid AS VARCHAR ) + ' is missing an AccountSeqid that are required for a reversal. Please verify '\r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- check if the Account number is in the system under an active status\r\n\t\tIF ( NOT EXISTS ( SELECT * FROM Billing.Account WHERE AccountSeqid = @AccountSeqid AND AccountStatus = 'AC' AND IsCurrentRecord = 'Y' ) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The Account number: ' + @AccountNumber + ' is not in the system under an active status. The exchange cannot be reverted. Please verfiy ' \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\r\n\t\tBEGIN TRY\t\r\n\r\n\t\t\t\tBEGIN TRANSACTION RevertExchangeAccount\r\n\r\n\t\t\t\t-- get some info for the insert\r\n\t\t\t\tSELECT @UniqueAccountSeqid = UniqueAccountSeqid FROM Billing.Account WHERE AccountSeqid = @AccountSeqid\r\n\t\t\t\t\r\n\t\t\t\t-- all looks good, we can remove that meter and account exchange track\r\n\t\t\t\tDELETE FROM Billing.AccountExchangeMeterTrack\r\n\t\t\t\tWHERE OriginalAccountSeqid = @AccountSeqid --AND OriginalMeterSeqid = @MeterSeqid\r\n\t\t\t\t\r\n\t\t\t\tDELETE FROM Billing.Account\r\n\t\t\t\tWHERE AccountSeqid = @AccountSeqid\r\n\r\n\t\t\t\t-- bring back the other meter records\r\n\r\n\t\t\t\t-- construct the dataset\r\n\t\t\t\t;WITH cte_PreviousAccountVersion AS\r\n\t\t\t\t(\r\n\t\t\t\t   SELECT *, ROW_NUMBER() OVER (PARTITION BY AccountSeqid ORDER BY AuditDateTime DESC) AS rn\r\n\t\t\t\t   FROM Audit.AuditAccount\r\n\t\t\t\t   WHERE UniqueAccountSeqid = @UniqueAccountSeqid\r\n\t\t\t\t)\t\r\n\r\n\t\t\t\t-- update the Accounts\r\n\t\t\t\tUPDATE Billing.Account\t\r\n\t\t\t\t\tSet \r\n\t\t\t\t\t\tExcessDistributionAssocEnergyAccount\t = CTE.ExcessDistributionAssocEnergyAccount\t,\r\n\t\t\t\t\t\tIsExcessDistribution\t = CTE.IsExcessDistribution\t,\r\n\t\t\t\t\t\tCommodityAssocDeliveryAccount\t = CTE.CommodityAssocDeliveryAccount\t,\r\n\t\t\t\t\t\tIsCommodityAccount\t = CTE.IsCommodityAccount\t,\r\n\t\t\t\t\t\tUtilityAccountProvider\t = CTE.UtilityAccountProvider\t,\r\n\t\t\t\t\t\tAgencyAccount\t = CTE.AgencyAccount\t,\r\n\t\t\t\t\t\tFacilityAccount\t = CTE.FacilityAccount\t,\r\n\t\t\t\t\t\tUtilityTariffRateInformationSeqid\t = CTE.UtilityTariffRateInformationSeqid\t,\r\n\t\t\t\t\t\tAgencyEnergyBillingBudgetLine\t = CTE.AgencyEnergyBillingBudgetLine\t,\r\n\t\t\t\t\t\tManualDataEntry\t = CTE.ManualDataEntry\t,\r\n\t\t\t\t\t\tCurrentAccountNumber\t = CTE.CurrentAccountNumber\t,\r\n\t\t\t\t\t\tOriginalAccountNumber\t = CTE.OriginalAccountNumber\t,\r\n\t\t\t\t\t\tReadingCycleNumber\t = CTE.ReadingCycleNumber\t,\r\n\t\t\t\t\t\tAccountStatus\t = CTE.AccountStatus\t,\r\n\t\t\t\t\t\tAccountPreviousStatus\t = CTE.AccountPreviousStatus\t,\r\n\t\t\t\t\t\tAccountStatusCodePeriod\t = CTE.AccountStatusCodePeriod\t,\r\n\t\t\t\t\t\tCurrentInvoiceAccountGroup\t = CTE.CurrentInvoiceAccountGroup\t,\r\n\t\t\t\t\t\tAccountEffectiveTurnOn\t = CTE.AccountEffectiveTurnOn\t,\r\n\t\t\t\t\t\tAccountEffectiveTurnOff\t = CTE.AccountEffectiveTurnOff\t,\r\n\t\t\t\t\t\tEnergySource\t = CTE.EnergySource\t,\r\n\t\t\t\t\t\tEnergyAccountDescription\t = CTE.EnergyAccountDescription\t,\r\n\t\t\t\t\t\tIsMultipleEnergySourceAccount\t = CTE.IsMultipleEnergySourceAccount\t,\r\n\t\t\t\t\t\tIsTimeOfDayAccount\t = CTE.IsTimeOfDayAccount\t,\r\n\t\t\t\t\t\tHasAccountLevelChange\t = CTE.HasAccountLevelChange\t,\r\n\t\t\t\t\t\tHasMeters\t = CTE.HasMeters\t,\r\n\t\t\t\t\t\tHasMultipleActiveMeters\t = CTE.HasMultipleActiveMeters\t,\r\n\t\t\t\t\t\tSalesType\t = CTE.SalesType\t,\r\n\t\t\t\t\t\tDeliveryTariffRate\t = CTE.DeliveryTariffRate\t,\r\n\t\t\t\t\t\tDeliveryTariffEffectiveDate\t = CTE.DeliveryTariffEffectiveDate\t,\r\n\t\t\t\t\t\tCommodityTariffRate\t = CTE.CommodityTariffRate\t,\r\n\t\t\t\t\t\tCommodityTariffEffectiveDate\t = CTE.CommodityTariffEffectiveDate\t,\r\n\t\t\t\t\t\tBillingCycle\t = CTE.BillingCycle\t,\r\n\t\t\t\t\t\tDelivery\t = CTE.Delivery\t,\r\n\t\t\t\t\t\tAccountInMultipleBuildings\t = CTE.AccountInMultipleBuildings\t,\r\n\t\t\t\t\t\tSourceOfRevenue\t = CTE.SourceOfRevenue\t,\r\n\t\t\t\t\t\tTurnOnDate\t = CTE.TurnOnDate\t,\r\n\t\t\t\t\t\tTurnOffDate\t = CTE.TurnOffDate\t,\r\n\t\t\t\t\t\tMunicipalCode\t = CTE.MunicipalCode\t,\r\n\t\t\t\t\t\tTerritory\t = CTE.Territory\t,\r\n\t\t\t\t\t\tTension\t = CTE.Tension\t,\r\n\t\t\t\t\t\tTripNumber\t = CTE.TripNumber\t,\r\n\t\t\t\t\t\tPartSupplied\t = CTE.PartSupplied\t,\r\n\t\t\t\t\t\tUtilityServiceAccountName\t = CTE.UtilityServiceAccountName\t,\r\n\t\t\t\t\t\tUtilityServiceAddress\t = CTE.UtilityServiceAddress\t,\r\n\t\t\t\t\t\tBorough\t = CTE.Borough\t,\r\n\t\t\t\t\t\tBlock\t = CTE.Block\t,\r\n\t\t\t\t\t\tLotNumber\t = CTE.LotNumber\t,\r\n\t\t\t\t\t\tCityPlanningBIN\t = CTE.CityPlanningBIN\t,\r\n\t\t\t\t\t\tELOAgencyAddress\t = CTE.ELOAgencyAddress\t,\r\n\t\t\t\t\t\tLastPeriodOriginalBilled\t = CTE.LastPeriodOriginalBilled\t,\r\n\t\t\t\t\t\tLastPeriodAdjustmentBilled\t = CTE.LastPeriodAdjustmentBilled\t,\r\n\t\t\t\t\t\tLastZeroDollarsBillingPeriod\t = CTE.LastZeroDollarsBillingPeriod\t,\r\n\t\t\t\t\t\tIsSeasonalAccount\t = CTE.IsSeasonalAccount\t,\r\n\t\t\t\t\t\tAdjustmentRecordSeqid\t = CTE.AdjustmentRecordSeqid\t,\r\n\t\t\t\t\t\tAccountDataCorrectionBillingPeriod\t = CTE.AccountDataCorrectionBillingPeriod\t,\r\n\t\t\t\t\t\tFireAuditTrigger\t = 'N'\t,\r\n\t\t\t\t\t\tNotes\t = CTE.Notes\t,\r\n\t\t\t\t\t\tAuthenticatedUserID\t = CTE.AuthenticatedUserID\t,\r\n\t\t\t\t\t\tDateAdded\t = CTE.DateAdded\t,\r\n\t\t\t\t\t\tLastUpdate\t = CTE.LastUpdate\t,\r\n\t\t\t\t\t\tUniqueAccountSeqid\t = CTE.UniqueAccountSeqid\t,\r\n\t\t\t\t\t\tIsCurrentRecord\t = CTE.IsCurrentRecord\t,\r\n\t\t\t\t\t\tContractNumber\t = CTE.ContractNumber\t,\r\n\t\t\t\t\t\tRecordVersion\t = CTE.RecordVersion\t\r\n\r\n\t\t\t\tFROM cte_PreviousAccountVersion CTE INNER JOIN  Billing.Account ON Account.AccountSeqid = CTE.AccountSeqid\r\n\t\t\t\tWHERE rn = 1\r\n\r\n\t\t\t\tCOMMIT TRAN RevertExchangeAccount\r\n\r\n\t\t\t\t-- if we make it here and all is well, come back and update the record as processes\r\n\t\t\t\tUPDATE Common.ExchangeData\r\n\t\t\t\tSET IsProcessed = 'R'\r\n\t\t\t\tWHERE ExchangeDataSeqid = @ExchangeSeqid\r\n\r\n\t\t\t\tSET @Message = ''\r\n\t\t\t\tSET @StatusCode = 1\r\n\r\n\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\r\n\t\t\t\tROLLBACK TRAN RevertExchangeAccount\r\n\t\t\t\tSET @Message = 'Error processing exchange  ' + CAST(@ExchangeSeqid AS VARCHAR(10)) + ' error message: ' + ERROR_MESSAGE()\r\n\t\t\t\tSET @StatusCode = 0\r\n\t\tEND CATCH\r\n\r\nEND"
        }
      ]
    }
  ]
}