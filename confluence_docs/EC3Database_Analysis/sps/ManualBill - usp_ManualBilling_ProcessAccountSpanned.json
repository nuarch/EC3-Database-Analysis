{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ManualBill",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ManualBilling_ProcessAccountSpanned",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ManualBilling_ProcessAccountSpanned",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process billing records that span multiple billing periods. It takes spanned billing records, splits them into individual billing periods, and calculates the appropriate billing amounts and usage for each period. The procedure then inserts these calculated values into a summary table for further processing or reporting."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is high due to several factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple steps, including data insertion, cursor-based iteration, and complex calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses several custom functions and procedures to calculate billing percentages and dates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure handles multiple variables and calculations to ensure accurate distribution of billing amounts across periods."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves conditional logic to handle different scenarios for date determination and percentage application."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period in 'YYYYMM' format."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@authenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the authenticated user executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@utilityCompany dbo.seqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for the utility company."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Status int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter used to indicate the status of the procedure execution (0 for success, 9 for initial setup)."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Sets the initial status to 9 and declares various variables for processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Copies records with "
                },
                {
                  "type": "text",
                  "text": "DeltaNumberOfPeriods > 1",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " from "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingAccount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingAccountTempSummarySpanned",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Declaration and Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "A cursor is declared to iterate over records in "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingAccountTempSummarySpanned",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "For each record, it retrieves necessary details and calculates the total spanned billed percentage."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Distribution of Spanned Periods",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "For each spanned record, it calculates the billing amounts and usage for each period using a loop."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It applies a monthly percentage to distribute the amounts and usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inserts the calculated values into "
                },
                {
                  "type": "text",
                  "text": "UploadManualBillingAccountSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Period Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "After processing n-1 periods, it calculates the remaining amounts for the last period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inserts the final period's data into the summary table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Closure",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Closes and deallocates the cursor after processing all records."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Status Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Sets the status to 0 to indicate successful completion."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a cursor can lead to performance issues, especially with large datasets, as it processes records row-by-row."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complex Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple calculations and function calls, which can be resource-intensive."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Inserts",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Frequent inserts into the summary table can cause I/O overhead, especially if the table is large or heavily indexed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Performance",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The cursor-based approach may not scale well with large datasets, potentially leading to slow performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or incorrect status updates."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Date Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The reliance on external functions for date calculations could introduce errors if those functions are not robust or if they fail to handle edge cases."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Rounding Errors",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure attempts to mitigate rounding errors, but there is still a risk of inaccuracies in financial calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple instances of this procedure run simultaneously, there could be contention issues, especially with shared resources like tables or functions."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [ManualBill].[usp_ManualBilling_ProcessAccountSpanned]\n\t@BillingPeriod varchar(6),\r\n\t@authenticatedID int,\r\n\t@utilityCompany dbo.seqid,\r\n\t@Status int  OUTPUT      \r\n   \r\n AS \r\n begin\r\n \r\n\t --********************************************************************************\r\n\t --\tAuthor: MOHAMMED BELARREM\r\n\t -- Description: Slice and dice the spanned bills to individual periods \r\n\t --\t\t\t\t \r\n\t --\r\n\t --\tLog: \r\n\t --\t\tCreation 02/10/2009\r\n\t --\t\tUpdate   06/15/2009\tUpdated the @CalculatedFromDate = @CalculatedToDate after each iteration\r\n\t --\t\tUpdate   12/28/2009 Updated the tables and needed to reflect the changes\r\n\t --\t\tUpdate\t 01/07/2010 Updated the queries to be invoice Billing Group independant\r\n\t --\t\tUpdate   01/13/2010 Updated the tables and added the accountseqid\r\n\t --\t\tUpdate   12/17/2010 Updated the pasrsing initial load query to join by accountseqid\r\n\t --\t\t\t\t\t\t\tsince some of the utilities recylce accounts.\r\n\t --\t\t\t\t\t\t\tcentral hudson accounts caused a bug because 2 of the accounts when they recycled the acccounts and the previous number was \r\n\t --\t\t\t\t\t\t\tbimonthly so the query picked up B as cycle and produced wrong results \r\n\t --     Update   12/17/2018 VY update for UniqueAccountSeqID\r\n\t --******************************************************************************** \r\n\t\r\n \r\n \r\n \r\n\t/*****************************************************\r\n\tDeclarations\r\n\t******************************************************/\r\n\t-- cursor\r\n\tdeclare @UploadAccountTempSummarySpannedSeqid dbo.seqid\r\n\t\r\n\t-- spanned record information\r\n\tdeclare @IBGSeqid\t\t\t\t\t\tdbo.seqid\t\r\n\tdeclare @AccountmanualBillingHeaderSeqid dbo.seqid\t\r\n    declare @AccountSeqid\t\t\t\t\tdbo.seqid\r\n\tdeclare @OriginalAccountNumber\t\t\tdbo.acctnum\t\t\t\r\n\tdeclare @BillingPeriodRevision\t\t\tdbo.yyyymm\t\t\t\r\n\tdeclare @FirstBillingPeriodCanceled\t\tdbo.yyyymm\t\t\t\t\t\t\r\n\tdeclare @DeltaNumberOfPeriods\t\t\tdbo.Accumulator\t\t\t\r\n\tdeclare @FromDate\t\t\t\t\t\tdbo.yyyymmdd\t\t\t\t\t\t\r\n\tdeclare @ToDate\t\t\t\t\t\t\tdbo.yyyymmdd\t\t\r\n\tdeclare @BillingPeriodDays\t\t\t\tdbo.BillingPeriodDays\t\t\t\r\n\tdeclare @NetBilledAmount\t\t\t\tdbo.BillingAmt\t\t\t\r\n\tdeclare @EnergySource\t\t\t\t\tdbo.EnergySource\t\t\t\r\n\tdeclare @EnergyUsage\t\t\t\t\tdbo.EnergyUnit\t\t\t\r\n\tdeclare @DemandUsage\t\t\t\t\tdbo.Kilowatts\t\t\t\r\n\tdeclare @BillingCycle\t\t\t\t\tdbo.MonthlyBillingCycle\t\r\n\tdeclare @TripNumber\t\t\t\t\t\tdbo.TripNumber\r\n\t\t\r\n\tdeclare @NumberOfPeriodsMinusOne\t\t\tint\r\n\tdeclare @TotalXXXSpannedBilledPercentage\tdbo.DiscountPercentage\r\n\tdeclare @ApplyMonthlyPercentage\t\t\t\tdbo.DiscountPercentage\r\n\t\r\n\tdeclare @CalculatedBillingPeriodRevision\tdbo.yyyymm\r\n\tdeclare @CalculatedFromDate\t\t\t\t\tdbo.yyyymmdd\r\n\tdeclare @CalculatedToDate\t\t\t\t\tdbo.yyyymmdd\r\n\tdeclare @idx\t\t\t\t\t\t\t\tint\r\n\tdeclare @NetBilledAmountMonthlySum\t\t\tdbo.BillingAmt\r\n\tdeclare @EnergyMonthlySum\t\t\t\t\tdbo.EnergyUnit\r\n\tdeclare @DemandMonthlySum\t\t\t\t\tdbo.Kilowatts\r\n\tdeclare @NetBilledAmountMonthly\t\t\t\tdbo.BillingAmt\r\n\tdeclare @EnergyMonthly\t\t\t\t\t\tdbo.EnergyUnit\r\n\tdeclare @DemandMonthly\t\t\t\t\t\tdbo.Kilowatts\r\n\tdeclare @NetBilledAmountLastPeriod\t\t\tdbo.BillingAmt\r\n\tdeclare @EnergyLastPeriod\t\t\t\t\tdbo.EnergyUnit\r\n\tdeclare @DemandLastPeriod\t\t\t\t\tdbo.Kilowatts\r\n\t\r\n\tdeclare @Notes\tdbo.notes\r\n\t\r\n \r\n\t-- setup \r\n\tset @Status = 9 \r\n\t\r\n\t\r\n\t/*********************************\r\n\t1. copy spanned bills into UploadManualBillingAccountTempSummarySpanned\r\n\t********************************/ \r\n\tINSERT INTO ManualBill.[UploadManualBillingAccountTempSummarySpanned]\r\n           ([title]\r\n           ,[UtilityCompanySeqid]\r\n           ,[InvoiceAccountBillingGroupSeqid]\r\n           ,[AccountmanualBillingHeaderSeqid]\r\n           ,[AccountSeqid]\r\n\t\t   ,[UniqueAccountSeqid] /* added on 12/17/2018 */\r\n           ,[OriginalAccountNumber]\r\n           ,[BillingPeriod]\r\n           ,[BillingPeriodRevision]\r\n           ,[FirstBillingPeriodCanceled]\r\n           ,[DeltaNumberOfPeriods]\r\n           ,[FromDate]\r\n           ,[ToDate]\r\n           ,[BillingPeriodDays]\r\n           ,[BillingAction]\r\n           ,[ActualOrEstimated]\r\n           ,[NetBilledAmount]\r\n           ,[EnergyUsage]\r\n           ,[DemandUsage]\r\n           ,[EnergySource])\r\n           \r\n\tselect \r\n\t\t\t'SpannedAccountbilling'\t\t\t---\t[title]\r\n           ,UtilityCompanySeqid\t\t\t\t---\t[UtilityCompanySeqid]\r\n           ,InvoiceAccountBillingGroupSeqid\t---\t[InvoiceAccountBillingGroupSeqid]\r\n           ,AccountmanualBillingHeaderSeqid ---\t[AccountmanualBillingHeaderSeqid]\r\n           ,AccountSeqid\t\t\t\t\t--- [AccountSeqid]\r\n\t\t   ,UniqueAccountSeqid               --- [UniqueAccountSeqid] /* added on 12/17/2018 */\r\n           ,OriginalAccountNumber\t\t\t---\t[OriginalAccountNumber]\r\n           ,BillingPeriod \t\t\t\t\t---\t[BillingPeriod]\r\n           ,BillingPeriodRevision \t\t\t---\t[BillingPeriodRevision]\r\n           ,FirstBillingPeriodCanceled \t\t---\t[FirstBillingPeriodCanceled]\r\n           ,DeltaNumberOfPeriods\t\t\t---\t[DeltaNumberOfPeriods]\r\n           ,FromDate \t\t\t\t\t\t---\t[FromDate]\r\n           ,ToDate \t\t\t\t\t\t\t---\t[ToDate]\r\n           ,BillingPeriodDays \t\t\t\t---\t[BillingPeriodDays]\r\n           ,BillingAction\t\t\t\t\t--- BillingAction\r\n           ,ActualOrEstimated\t\t\t\t--- ActualOrEstimated\r\n           ,NetBilledAmount\t\t\t\t\t---\t[NetBilledAmount]\r\n           ,EnergyUsage\t\t\t\t\t\t---\t[EnergyUsage]\r\n           ,DemandUsage\t\t\t\t\t\t---\t[DemandUsage]\r\n           ,EnergySource\t\t\t\t\t---\t[EnergySource]\r\n\t\r\n\tFROM ManualBill.UploadManualBillingAccount\r\n\tWHERE ( DeltaNumberOfPeriods > 1 )\r\n \r\n\t/*********************************\r\n\t2. Parsed spanned acount info\r\n\t********************************/\r\n\r\n\t--\tDECLARE a cursor to find all account bills that span more than one period.\r\n\tDECLARE SpannedBillCursor CURSOR FOR\r\n\tSELECT UploadManualBillingAccountTempSummarySpannedSeqid FROM ManualBill.UploadManualBillingAccountTempSummarySpanned\r\n\r\n\tOPEN SpannedBillCursor;\r\n\r\n\tFETCH NEXT FROM SpannedBillCursor INTO @UploadAccountTempSummarySpannedSeqid\r\n\t--\r\n\t-- Check @@FETCH_STATUS to see if there are any more rows to fetch.\r\n\t--\r\n\tWHILE @@FETCH_STATUS = 0\r\n\tBEGIN -- begin processing for fetched record\r\n\t\t\t\t\r\n\t\t\t--\r\n\t\t\t-- 2.1. Process n-1 spanned periods\r\n\t\t\t--\r\n\t\r\n\t\t\tselect\r\n\t\t\t\t @AccountmanualBillingHeaderSeqid\t= Spanned.AccountmanualBillingHeaderSeqid\r\n\t\t\t\t,@AccountSeqid\t\t\t\t\t\t= Spanned.AccountSeqid\r\n\t\t\t\t,@OriginalAccountNumber\t\t\t\t= Spanned.OriginalAccountNumber\r\n\t\t\t\t,@BillingPeriodRevision\t\t\t\t= Spanned.BillingPeriodRevision\r\n\t\t\t\t,@FirstBillingPeriodCanceled\t\t= Spanned.FirstBillingPeriodCanceled\r\n\t\t\t\t,@DeltaNumberOfPeriods\t\t\t\t= Spanned.DeltaNumberOfPeriods\r\n\t\t\t\t,@FromDate\t\t\t\t\t\t\t= Spanned.FromDate\r\n\t\t\t\t,@ToDate\t\t\t\t\t\t\t= Spanned.ToDate\r\n\t\t\t\t,@BillingPeriodDays\t\t\t\t\t= Spanned.BillingPeriodDays\r\n\t\t\t\t,@NetBilledAmount\t\t\t\t\t= Spanned.NetBilledAmount\r\n\t\t\t\t,@EnergyUsage\t\t\t\t\t\t= Spanned.EnergyUsage\r\n\t\t\t\t,@DemandUsage\t\t\t\t\t\t= Spanned.DemandUsage\r\n\t\t\t\t,@EnergySource\t\t\t\t\t\t= Spanned.EnergySource\r\n\t\t\t\t,@BillingCycle\t\t\t\t\t\t= Billing.Account.BillingCycle\r\n\t\t\t\t,@TripNumber\t\t\t\t\t\t= Billing.Account.TripNumber\r\n\t\t\tfrom ManualBill.UploadManualBillingAccountTempSummarySpanned as Spanned inner join Billing.Account on\r\n\t\t\t\tspanned.OriginalAccountNumber = Billing.Account.OriginalAccountNumber  AND Billing.Account.AccountSeqid = Spanned.AccountSeqid\r\n\t\t\twhere ( UploadManualBillingAccountTempSummarySpannedSeqid = @UploadAccountTempSummarySpannedSeqid )\r\n\r\n\r\n\t\t\t/*\r\n\t\t\t\t Distribute over spanned based on given percentage\r\n\t\t\t*/\r\n\r\n\t\t\t-- 2.1 periodAggregate the average City wide monthly energy usage percentage for the spanned row billing periods \r\n\t\t\tselect @TotalXXXSpannedBilledPercentage =[ManualBill].[CalculateTotalXXXSpannedBilledPercentage] (@BillingCycle,@DeltaNumberOfPeriods,@FirstBillingPeriodCanceled,@BillingPeriodRevision,@EnergySource )\r\n\t\t\t\t\r\n\t\t\t-- 2.2 Determine the number of periods minus 1 to pro-rate the money and usage.  The last period will derive the money and usage\r\n\t\t\t--\tby row totals - (the n-1 aggregates of money and usage)\r\n\t\t\tset @NumberOfPeriodsMinusOne = @DeltaNumberOfPeriods-1\r\n\r\n\r\n\t\t\t--\r\n\t\t\t--\t2.3 Initialize the counters for the n-1 parses\r\n\t\t\t--\r\n\t\t\tset @CalculatedBillingPeriodRevision = @FirstBillingPeriodCanceled \r\n\t\t\tset @CalculatedFromDate\t\t\t\t = @FromDate \r\n\t\t\tset @CalculatedToDate\t\t\t\t = @ToDate \r\n\t\t\tset @idx\t\t\t\t\t\t\t = 0 \r\n\t\t\tset @NetBilledAmountMonthlySum\t\t = 0.00 \r\n\t\t\tset @EnergyMonthlySum\t\t\t\t = 0.00  \r\n\t\t\tset @DemandMonthlySum\t\t\t\t = 0  \r\n\t\t\t--\r\n\t\t\t\r\n\t\t\t--- 2.4 distribute / parse\r\n\t\t\twhile (@NumberOfPeriodsMinusOne > @idx)\r\n\t\t\tBegin \r\n\r\n\t\t\t\t-- 2.4.1 set value for required variables\r\n\r\n\t\t\t\t-- The @ApplyMonthlyPercentage holds the weigthed average for the particular month\r\n\t\t\t\tselect @ApplyMonthlyPercentage = [ManualBill].[CalculateApplyMonthlyPercentageXXXSpannedBilled] (@CalculatedBillingPeriodRevision,@TotalXXXSpannedBilledPercentage, @EnergySource)\r\n\r\n\t\t\t\t--\t\t\t\t\r\n\t\t\t\t-- Apply the Monthly Percentage to the CCF,Therms and Billed Amount \r\n\t\t\t\t--\r\n\t\t\t\tset @NetBilledAmountMonthly\t= ROUND(@NetBilledAmount * @ApplyMonthlyPercentage,2)\r\n\t\t\t\tset @EnergyMonthly\t\t\t= ROUND(@EnergyUsage * @ApplyMonthlyPercentage,0)\r\n\t\t\t\tset @DemandMonthly\t\t\t= ROUND(@DemandUsage * @ApplyMonthlyPercentage,2)\r\n\t\t\t\t\r\n\t\t\t\t--\r\n\t\t\t\t-- Accululate the weigthed average units.\r\n\t\t\t\t--\r\n\t\t\t\tset @NetBilledAmountMonthlySum = @NetBilledAmountMonthlySum + @NetBilledAmountMonthly\r\n\t\t\t\tset @EnergyMonthlySum\t\t= @EnergyMonthlySum + @EnergyMonthly\r\n\t\t\t\tset @DemandMonthlySum\t\t= @DemandMonthlySum + @DemandMonthly\r\n\t\t\r\n\t\t\t\t\r\n\t\t\t\t--  \r\n\t\t\t\t--\tThe Billing Period Projected \"ToDate\" is derived from the table \"dbo.BillingPeriodProjected\" using the utility company seqid and the\r\n\t\t\t\t--\tRevisedBillingPeriod and using the \"EndofPeriodTodate\" as the derived \"Todate\" for the account.\r\n\t\t\t\t--\r\n\t\t\t\tselect @CalculatedToDate = ManualBill.DeterminActualDate(@OriginalAccountNumber, 'T', @CalculatedBillingPeriodRevision, @BillingCycle)\r\n\r\n\t\t\t\tif(@CalculatedToDate is null)\r\n\t\t\t\t\tselect @CalculatedToDate = ManualBill.DetermineProjectedToOrFromDate(@utilityCompany, @IBGSeqid, @CalculatedBillingPeriodRevision, 'T', @tripNumber, @BillingCycle ) \r\n\t\t\t\t\t-- if both above methods fail prorate\r\n\t\t\t\tif(@CalculatedToDate is null)\r\n\t\t\t\t\tselect @CalculatedToDate = ManualBill.ProRateToOrFromDate('T', @BillingCycle, @FromDate, @ToDate, @idx, @DeltaNumberOfPeriods  )\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- 2.4.2\tCreate a custom note that explains how the information was parsed and what was the original information of the spanned row.\r\n\t\t\t\t--\tIt will note in EC3 that the transaction was derived.\r\n\t\t\t\tselect @Notes = SUBSTRING( cast(@DeltaNumberOfPeriods as varchar(6))+ ' First: '+@FirstBillingPeriodCanceled +' ( '+@FromDate+') Last: '+ \r\n\t\t\t\t@BillingPeriodRevision +' ( '+@ToDate+'). '+' period: '+@CalculatedBillingPeriodRevision+ ' Month %: '+cast(@ApplyMonthlyPercentage as varchar(10))+\r\n\t\t\t\t' - Total %: '+cast(@TotalXXXSpannedBilledPercentage as varchar(10)), 1, 300)\r\n\r\n\t\t\t\t--\r\n\t\t\t\t-- 2.4.3  INSERT the data into the summary table\r\n\t\t\t\t--\t\t\r\n\t\t\t\tINSERT INTO ManualBill.[UploadManualBillingAccountSummary]\r\n\t\t\t\t\t   ([UtilityCompanySeqid]\r\n\t\t\t\t\t   ,[InvoiceAccountBillingGroupSeqid]\r\n\t\t\t\t\t   ,[AccountManualBillingHeaderSeqid]\r\n\t\t\t\t\t   ,[AccountSeqid]\r\n\t\t\t\t\t   ,[UniqueAccountSeqid] /* added on 12/17/2018 */\r\n\t\t\t\t\t   ,[OriginalAccountNumber]\r\n\t\t\t\t\t   ,[NumberOfTransactions]\r\n\t\t\t\t\t   ,[NumberOfRebillTransactions]\r\n\t\t\t\t\t   ,[NumberOfCancelTransactions]\r\n\t\t\t\t\t   ,[BillingPeriod]\r\n\t\t\t\t\t   ,[BillingPeriodRevision]\r\n\t\t\t\t\t   ,[BillingAction]\r\n\t\t\t\t\t   ,[ActualOrEstimated]\r\n\t\t\t\t\t   ,[FromDate]\r\n\t\t\t\t\t   ,[ToDate]\r\n\t\t\t\t\t   ,[BillingPeriodDays]\r\n\t\t\t\t\t   ,[NetBilledAmount]\r\n\t\t\t\t\t   ,[EnergyUsage]\r\n\t\t\t\t\t   ,[DemandUsage]\r\n\t\t\t\t\t   ,[EnergySource]\r\n\t\t\t\t\t   ,[DerivedFromSpannedBill]\r\n\t\t\t\t\t   ,[SpannedFromDate]\r\n\t\t\t\t\t   ,[SpannedToDate]\r\n\t\t\t\t\t   ,[SpannedBillingPeriodDays]\r\n\t\t\t\t\t   ,[SpannedBillingPeriodRevision]\r\n\t\t\t\t\t   ,[SpannedFirstBillingPeriodCanceled]\r\n\t\t\t\t\t   ,[SpannedNetBilledAmount]\r\n\t\t\t\t\t   ,[SpannedEnergyUsage]\r\n\t\t\t\t\t   ,[SpannedDemandUsage]\r\n\t\t\t\t\t   ,[SpannedMonthlyPercentage]\r\n\t\t\t\t\t   ,[SpannedTotalPercentage]\r\n\t\t\t\t\t   ,[Notes]\r\n\t\t\t\t\t   ,[AuthenticatedUserID]\r\n\t\t\t\t\t   ,[DateAdded]\r\n\t\t\t\t\t   ,[LastUpdate])\r\n\t\t\t\t\r\n\t\t\t\tselect \t\r\n\t\t\t\t\t\t@utilityCompany\t\t\t\t\t\t\t--[UtilityCompanySeqid]\r\n\t\t\t\t\t   ,InvoiceAccountBillingGroupSeqid\t\t\t--[InvoiceAccountBillingGroupSeqid]\r\n\t\t\t\t\t   ,AccountmanualBillingHeaderSeqid\t\t\t--[AccountManualBillingHeaderSeqid]\r\n\t\t\t\t\t   ,AccountSeqid\t\t\t\t\t\t\t--[AccountSeqid] \r\n\t\t\t\t\t   ,UniqueAccountSeqID                      --[UniqueAccountSeqid] /* added on 12/17/2018 */\r\n\t\t\t\t\t   ,OriginalAccountNumber\t\t\t\t\t--[OriginalAccountNumber]\r\n\t\t\t\t\t   ,1\t\t\t\t\t\t\t\t\t\t--[NumberOfTransactions]\r\n\t\t\t\t\t   ,1\t\t\t\t\t\t\t\t\t\t--[NumberOfRebillTransactions]\r\n\t\t\t\t\t   ,0\t\t\t\t\t\t\t\t\t\t--[NumberOfCancelTransactions]\r\n\t\t\t\t\t   ,BillingPeriod\t\t\t\t\t\t\t--[BillingPeriod]\r\n\t\t\t\t\t   ,@CalculatedBillingPeriodRevision\t\t--[BillingPeriodRevision]\r\n\t\t\t\t\t   ,CASE WHEN @BillingPeriod = @CalculatedBillingPeriodRevision THEN 'O' ELSE 'A' END\t--[BillingAction]\r\n\t\t\t\t\t   ,'EST'\t\t\t\t\t\t\t\t\t--[ActualOrEstimated]\r\n\t\t\t\t\t   ,@CalculatedFromDate\t\t\t\t\t\t--[FromDate]\r\n\t\t\t\t\t   ,@CalculatedToDate\t\t\t\t\t\t--[ToDate]\r\n\t\t\t\t\t   ,dbo.CalculateNumberOfBillingDays(@CalculatedFromDate, @CalculatedToDate)\t\t\t--[BillingDays]\r\n\t\t\t\t\t   ,@NetBilledAmountMonthly\t\t\t\t\t--[NetBilledAmount]\r\n\t\t\t\t\t   ,isnull(@EnergyMonthly, 0)\t\t\t\t--[EnergyUsage]\r\n\t\t\t\t\t   ,@DemandMonthly\t\t\t\t\t\t\t--[DemandUsage]\r\n\t\t\t\t\t   ,@EnergySource\t\t\t\t\t\t\t--[EnergySource]\r\n\t\t\t\t\t   ,'Y'\t\t\t\t\t\t\t\t\t\t--[DerivedFromSpannedBill]\r\n\t\t\t\t\t   ,@FromDate\t\t\t\t\t\t\t\t--[SpannedFromDate]\r\n\t\t\t\t\t   ,@ToDate\t\t\t\t\t\t\t\t\t--[SpannedToDate]\r\n\t\t\t\t\t   ,@BillingPeriodDays\t\t\t\t\t\t--[SpannedBillingDays]\r\n\t\t\t\t\t   ,@BillingPeriodRevision\t\t\t\t\t--[SpannedBillingPeriodRevision]\r\n\t\t\t\t\t   ,@FirstBillingPeriodCanceled\t\t\t\t--[SpannedFirstBillingPeriodCanceled]\r\n\t\t\t\t\t   ,@NetBilledAmount\t\t\t\t\t\t--[SpannedNetBilledAmount]\r\n\t\t\t\t\t   ,@EnergyUsage\t\t\t\t\t\t\t--[SpannedEnergy]\r\n\t\t\t\t\t   ,@DemandUsage\t\t\t\t\t\t\t--[SpannedDemand]\r\n\t\t\t\t\t   ,@ApplyMonthlyPercentage\t\t\t\t\t--[SpannedMonthlyPercentage]\r\n\t\t\t\t\t   ,@TotalXXXSpannedBilledPercentage\t\t--[SpannedTotalPercentage]\r\n\t\t\t\t\t   ,@Notes\t\t\t\t\t\t\t\t\t--[Notes]\r\n\t\t\t\t\t   ,@authenticatedID\t\t\t\t\t\t--[AuthenticatedUserID]\r\n\t\t\t\t\t   ,getdate()\t\t\t\t\t\t\t\t--[DateAdded]\r\n\t\t\t\t\t   ,getdate()\t\t\t\t\t\t\t\t--[LastUpdate]\r\n\t\t \t\tfrom ManualBill.UploadManualBillingAccountTempSummarySpanned \r\n\t\t\t\twhere ( UploadManualBillingAccountTempSummarySpannedSeqid = @UploadAccountTempSummarySpannedSeqid )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t \t\t\t\t\t \r\n\t\t\t\t\t--\r\n\t\t\t\t\t--\tCalculate the next Revised Billing Period row.\r\n\t\t\t\t\tselect @CalculatedBillingPeriodRevision = [dbo].[CalculateNextBillingPeriod]  (@CalculatedBillingPeriodRevision,@BillingCycle)\r\n\t\t\t\t\t--\tThis will derive the new Revised Billing Period row's \"FromDate\"\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t-- commented by MOH on 06/15/2009\r\n\t\t\t\t\t-- *********************************************************************************************************************************************************************************\r\n\t\t\t\t\tset @CalculatedFromDate = @CalculatedToDate\r\n\t\t\t\t\t--select @CalculatedToDate = ManualBill.DeterminActualDate(@OriginalAccountNumber, 'T', @CalculatedBillingPeriodRevision, @BillingCycle)\r\n\t\t\t\t\t--\r\n\t\t\t\t\t--if(@CalculatedToDate is null)\r\n\t\t\t\t\t--\tselect @CalculatedToDate = ManualBill.DetermineProjectedToOrFromDate(@utilityCompany, @IBGSeqid, @CalculatedBillingPeriodRevision, 'T', @tripNumber, @BillingCycle\t) \r\n\t\t\t\t\t--\r\n\t\t\t\t\t--\t-- if both above methods fail prorate\r\n\t\t\t\t\t--if(@CalculatedToDate is null)\r\n\t\t\t\t\t--\tselect @CalculatedToDate = ManualBill.ProRateToOrFromDate('T', @BillingCycle, @FromDate, @ToDate, @idx, @DeltaNumberOfPeriods  )\r\n\t\t\t\t\t-- *********************************************************************************************************************************************************************************\r\n\r\n\r\n\r\n\t\t\t\tset @idx = @idx + 1\r\n\t\t\tend -- end distribute/parse\r\n\r\n\t\t--\r\n\t\t-- 2.2. Process the last spanned period\r\n\t\t--\r\n\t\r\n\t\tselect @CalculatedFromDate = ManualBill.DeterminActualDate(@OriginalAccountNumber, 'F', @CalculatedBillingPeriodRevision, @BillingCycle)\r\n\r\n\t\tif(@CalculatedFromDate is null)\r\n\t\t\tselect @CalculatedFromDate = ManualBill.DetermineProjectedToOrFromDate(@utilityCompany, @IBGSeqid, @CalculatedBillingPeriodRevision, 'F', @tripNumber, @BillingCycle\t) \r\n\r\n\t\t\t-- if both above methods fail prorate\r\n\t\tif(@CalculatedFromDate is null)\r\n\t\t\tselect @CalculatedFromDate = ManualBill.ProRateToOrFromDate('F', @BillingCycle, @FromDate, @ToDate, @idx, @DeltaNumberOfPeriods  )\r\n\t\t\r\n\t\t--\r\n\t\tselect @CalculatedToDate = @ToDate\r\n\t\t--\r\n\t\t--\t@ApplyMonthlyPercentage is used for the notes purposes only\r\n\t\t--\r\n\t\tselect @ApplyMonthlyPercentage = [ManualBill].[CalculateApplyMonthlyPercentageXXXSpannedBilled] (@CalculatedBillingPeriodRevision,@TotalXXXSpannedBilledPercentage, @EnergySource)\r\n\t\t\r\n\t\t\r\n\t\t/*debugger*/\r\n\t\tselect 'value of @ApplyMonthlyPercentage is: ' + cast( @TotalXXXSpannedBilledPercentage as varchar(15)) AS \tTotalXXXSpannedBilledPercentage\t\r\n\t\tselect 'value of @ApplyMonthlyPercentage is: ' + cast( @ApplyMonthlyPercentage as varchar(15)) AS \tApplyMonthlyPercentageis\t\r\n\r\n\t\t\r\n\t\t--\r\n\t\t--\tDerive the net changes to avoid rounding errors\r\n\t\t--\r\n\t\tset @NetBilledAmountLastPeriod\t= @NetBilledAmount - @NetBilledAmountMonthlySum\r\n\t\tset @EnergyLastPeriod\t\t\t= @EnergyUsage  - @EnergyMonthlySum\r\n\t\tset @DemandLastPeriod\t\t\t= @DemandUsage  - @DemandMonthlySum\r\n\r\n\t\t--\r\n\t\t--\tCreate a custom note that explains how the information was parsed and what was the original information of the spanned row.\r\n\t\t--\tIt will note in EC3 that the transaction was derived.\r\n\t\t--\r\n\t\tselect @Notes = SUBSTRING(cast(@DeltaNumberOfPeriods as varchar(6))+' First: '+@FirstBillingPeriodCanceled +' ( '+@FromDate+') Last: '+ \r\n\t\t@BillingPeriodRevision +' ( '+@ToDate+'). '+' period: '+@CalculatedBillingPeriodRevision+ ' Month %: '+cast(@ApplyMonthlyPercentage as varchar(10))+\r\n\t\t' - Total %: '+cast(@TotalXXXSpannedBilledPercentage as varchar(10)), 1, 300)\t\r\n\r\n\r\n\r\n\r\n\t\t/******************************************************************************************************\r\n\t\t\tInsert the last period \r\n\t\t*******************************************************************************************************/\r\n\r\n\r\n\t\tINSERT INTO [ManualBill].[UploadManualBillingAccountSummary]\r\n\t\t\t\t   ([UtilityCompanySeqid]\r\n\t\t\t\t   ,[InvoiceAccountBillingGroupSeqid]\r\n\t\t\t\t   ,[AccountManualBillingHeaderSeqid]\r\n\t\t\t\t   ,[AccountSeqid]\r\n\t\t\t\t   ,[UniqueAccountSeqid] /* added on 12/17/2018 */\r\n\t\t\t\t   ,[OriginalAccountNumber]\r\n\t\t\t\t   ,[NumberOfTransactions]\r\n\t\t\t\t   ,[NumberOfRebillTransactions]\r\n\t\t\t\t   ,[NumberOfCancelTransactions]\r\n\t\t\t\t   ,[BillingPeriod]\r\n\t\t\t\t   ,[BillingPeriodRevision]\r\n\t\t\t\t   ,[BillingAction]\r\n\t\t\t\t   ,[ActualOrEstimated]\r\n\t\t\t\t   ,[FromDate]\r\n\t\t\t\t   ,[ToDate]\r\n\t\t\t\t   ,[BillingPeriodDays]\r\n\t\t\t\t   ,[NetBilledAmount]\r\n\t\t\t\t   ,[EnergyUsage]\r\n\t\t\t\t   ,[DemandUsage]\r\n\t\t\t\t   ,[EnergySource]\r\n\t\t\t\t   ,[DerivedFromSpannedBill]\r\n\t\t\t\t   ,[SpannedFromDate]\r\n\t\t\t\t   ,[SpannedToDate]\r\n\t\t\t\t   ,[SpannedBillingPeriodDays]\r\n\t\t\t\t   ,[SpannedBillingPeriodRevision]\r\n\t\t\t\t   ,[SpannedFirstBillingPeriodCanceled]\r\n\t\t\t\t   ,[SpannedNetBilledAmount]\r\n\t\t\t\t   ,[SpannedEnergyUsage]\r\n\t\t\t\t   ,[SpannedDemandUsage]\r\n\t\t\t\t   ,[SpannedMonthlyPercentage]\r\n\t\t\t\t   ,[SpannedTotalPercentage]\r\n\t\t\t\t   ,[Notes]\r\n\t\t\t\t   ,[AuthenticatedUserID]\r\n\t\t\t\t   ,[DateAdded]\r\n\t\t\t\t   ,[LastUpdate])\r\n\r\n\r\n\t\t\tselect \t\r\n\t\t\t\t\t@utilityCompany\t\t\t\t\t\t\t--[UtilityCompanySeqid]\r\n\t\t\t\t   ,InvoiceAccountBillingGroupSeqid\t\t\t--[InvoiceAccountBillingGroupSeqid]\r\n\t\t\t\t   ,AccountmanualBillingHeaderSeqid\t\t\t--[AccountManualBillingHeaderSeqid]\r\n\t\t\t\t   ,AccountSeqid\t\t\t\t\t\t\t--[Accountseqid]\r\n\t\t\t\t   ,UniqueAccountSeqid                      --[UniqueAccountSeqid] /* added on 12/17/2018 */\r\n\t\t\t\t   ,OriginalAccountNumber\t\t\t\t\t--[OriginalAccountNumber]\r\n\t\t\t\t   ,1\t\t\t\t\t\t\t\t\t\t--[NumberOfTransactions]\r\n\t\t\t\t   ,1\t\t\t\t\t\t\t\t\t\t--[NumberOfRebillTransactions]\r\n\t\t\t\t   ,0\t\t\t\t\t\t\t\t\t\t--[NumberOfCancelTransactions]\r\n\t\t\t\t   ,BillingPeriod\t\t\t\t\t\t\t--[BillingPeriod]\r\n\t\t\t\t   ,@CalculatedBillingPeriodRevision\t\t--[BillingPeriodRevision]\r\n\t\t\t\t   ,CASE WHEN @BillingPeriod = @CalculatedBillingPeriodRevision THEN 'O' ELSE 'A' END\t\t--[BillingAction]\r\n\t\t\t\t   ,'EST'\t\t\t\t\t\t\t\t\t--[ActualOrEstimated]\r\n\t\t\t\t   ,@CalculatedFromDate\t\t\t\t\t\t--[FromDate]\r\n\t\t\t\t   ,@CalculatedToDate\t\t\t\t\t\t--[ToDate]\r\n\t\t\t\t   ,dbo.CalculateNumberOfBillingDays(@CalculatedFromDate, @CalculatedToDate)\t\t\t\t--[BillingPeriodDays]\r\n\t\t\t\t   ,@NetBilledAmountLastPeriod\t\t\t\t--[NetBilledAmount]\r\n\t\t\t\t   ,isnull(@EnergyLastPeriod, 0)\t\t\t--[EnergyUsage]\r\n\t\t\t\t   ,@DemandLastPeriod\t\t\t\t\t\t--[DemandUsage]\r\n\t\t\t\t   ,@EnergySource\t\t\t\t\t\t\t--[EnergySource]\r\n\t\t\t\t   ,'Y'\t\t\t\t\t\t\t\t\t\t--[DerivedFromSpannedBill]\r\n\t\t\t\t   ,@FromDate\t\t\t\t\t\t\t\t--[SpannedFromDate]\r\n\t\t\t\t   ,@ToDate\t\t\t\t\t\t\t\t\t--[SpannedToDate]\r\n\t\t\t\t   ,@BillingPeriodDays\t\t\t\t\t\t--[SpannedBillingDays]\r\n\t\t\t\t   ,@BillingPeriodRevision\t\t\t\t\t--[SpannedBillingPeriodRevision]\r\n\t\t\t\t   ,@FirstBillingPeriodCanceled\t\t\t\t--[SpannedFirstCanceledBillingPeriod]\r\n\t\t\t\t   ,@NetBilledAmount\t\t\t\t\t\t--[SpannedNetBilledAmount]\r\n\t\t\t\t   ,@EnergyUsage\t\t\t\t\t\t\t--[SpannedEnergy]\r\n\t\t\t\t   ,@DemandUsage\t\t\t\t\t\t\t--[SpannedDemand]\r\n\t\t\t\t   ,@ApplyMonthlyPercentage\t\t\t\t\t--[SpannedMonthlyPercentage]\r\n\t\t\t\t   ,@TotalXXXSpannedBilledPercentage\t\t--[SpannedTotalPercentage]\r\n\t\t\t\t   ,@Notes\t\t\t\t\t\t\t\t\t--[Notes]\r\n\t\t\t\t   ,@authenticatedID\t\t\t\t\t\t--[AuthenticatedUserID]\r\n\t\t\t\t   ,getdate()\t\t\t\t\t\t\t\t--[DateAdded]\r\n\t\t\t\t   ,getdate()\t\t\t\t\t\t\t\t--[LastUpdate]\r\n\t \t\tfrom ManualBill.UploadManualBillingAccountTempSummarySpanned \r\n\t\t\twhere ( UploadManualBillingAccountTempSummarySpannedSeqid = @UploadAccountTempSummarySpannedSeqid )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\r\n\r\n \r\n\t\t\t--\tProcess the next row\r\n\t\t\t--\r\n\t\t\tFETCH NEXT FROM SpannedBillCursor INTO @UploadAccountTempSummarySpannedSeqid\r\n\tEnd -- end processing for fetched record\r\n\r\n\tCLOSE SpannedBillCursor; -- close cursor\r\n\tDEALLOCATE SpannedBillCursor;\r\n\t\r\n\t\r\n\tset @Status = 0\r\n\r\n \r\n end"
        }
      ]
    }
  ]
}