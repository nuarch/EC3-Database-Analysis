{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Common",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchange_CodeMISC",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "[Common].[usp_ProcessExchange_CodeMISC]",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to process exchange records in a SQL Server database. It updates account information based on specific conditions and flags records as processed. The procedure handles two types of transactions: updating gas rate codes and updating workday numbers. It includes error handling to manage exceptions and ensure data integrity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple conditional checks, data retrieval, updates, and transaction management. It uses error handling with "
        },
        {
          "type": "text",
          "text": "TRY...CATCH",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " blocks and custom error messages. The complexity is medium due to the combination of these elements and the need for careful management of transaction states and error handling."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier of the exchange record to be processed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeCode varchar(2)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The exchange code, expected to be 'DC' for processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current billing period, though not used in the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter indicating the execution status (0 for success, 1 for failure)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Message VARCHAR(1000) OUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter for returning messages or error descriptions."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Checks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure checks if the record is flagged as excluded. If so, it sets a message and status code, then throws an exception."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It verifies the existence of the record. If not found, it sets a message and status code, then throws an exception."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It checks if the record has already been processed. If so, it sets a message and status code, then throws an exception."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieves account-related information from the "
                        },
                        {
                          "type": "text",
                          "text": "Common.ExchangeData",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table based on "
                        },
                        {
                          "type": "text",
                          "text": "@ExchangeSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Ensures the exchange code is 'DC'. If not, it sets a message and status code, then throws an exception."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Verifies the account exists and is active in the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table. If not, it sets a message and status code, then throws an exception."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Begins a transaction named "
                        },
                        {
                          "type": "text",
                          "text": "exchangeMISC",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Depending on the "
                        },
                        {
                          "type": "text",
                          "text": "@TransactionCode",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", it performs specific updates:"
                        }
                      ]
                    },
                    {
                      "type": "bulletList",
                      "content": [
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "Gas Rate Code Update ('SC')",
                                  "marks": [
                                    {
                                      "type": "strong"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": ": Updates tariff information in the "
                                },
                                {
                                  "type": "text",
                                  "text": "Billing.Account",
                                  "marks": [
                                    {
                                      "type": "code"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": " table and marks the record as processed."
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "Work Day Update ('WD')",
                                  "marks": [
                                    {
                                      "type": "strong"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": ": Updates the workday number in the "
                                },
                                {
                                  "type": "text",
                                  "text": "Billing.Account",
                                  "marks": [
                                    {
                                      "type": "code"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": " table and marks the record as processed."
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Commits the transaction if successful."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "In the "
                        },
                        {
                          "type": "text",
                          "text": "CATCH",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " block, rolls back the transaction and sets an error message and status code, then throws an exception."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the "
                },
                {
                  "type": "text",
                  "text": "ExchangeDataSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " columns are indexed to optimize lookup and update operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of transactions ensures data integrity but may lead to locking issues if multiple instances of the procedure are run concurrently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "THROW",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for error handling is efficient but may need to be monitored for frequent exceptions that could indicate underlying issues."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded values (e.g., "
                },
                {
                  "type": "text",
                  "text": "@RecordUtilitySeqid = 2",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "), which may need to be parameterized for flexibility."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Unused Parameters",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is declared but not used, which could lead to confusion or maintenance issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While exceptions are thrown, they may not be logged or handled at a higher level, potentially leading to untracked errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes certain conditions (e.g., exchange code 'DC') without fallback logic, which could lead to incomplete processing if assumptions are incorrect."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the procedure involves multiple table updates and checks, performance may degrade with larger datasets or higher concurrency without proper indexing and optimization."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE  PROCEDURE [Common].[usp_ProcessExchange_CodeMISC] @AuthenticatedUserID int , @ExchangeSeqid int , @ExchangeCode varchar(2) , @CurrentBillingPeriod VARCHAR(6), @StatusCode int  OUTPUT   , @Message VARCHAR(1000) OUT\n   \r\nAS \r\n \r\nBegin  \r\n\t\t--**************************************************************************************\r\n\t\t--* Description:\tThis stored procedure changes some information on the account\r\n\t\t--*               \r\n\t\t--* Parameter(s):        \r\n\t\t--*\t\t\t\t\t@AuthenticatedUserID int\t\t- the seqid of the user that runs the stored procedure\t\r\n\t\t--*\t\t\t\t\t@ExchangeSeqid int\t\t\t\t- the seqid of the record to process\r\n\t\t--*                 @ExchangeCode int\t\t\t\t- the exchange code in this case 28\r\n\t\t--*\t\t\t\t\t@UtilityCompanySeqid\t\t\t- the utility company \r\n\t\t--*                 @StatusCode  int output\t\t\t- Execution Return Status \r\n\t\t--*\r\n\t\t--*\r\n\t\t--* Return:\t        0 Success\r\n\t\t--*                 1 Failure\r\n\t\t--*\r\n\t\t--* AUTHOR:       Zafer Durmaz\t\r\n\t\t--* Created On:   07/28/2016\r\n\t\t--**************************************************************************************\r\n\t\t--* Date       Tech Description of Change\r\n\t\t--* ---------- ---\t-------------------------------------------------------------\r\n\t\t--* 07/28/2016  ZD  First Version \r\n\t\t--* 03/27/2017 zd  Added Throw for exception handling\r\n\t\t--**************************************************************************************\r\n\r\n\r\n\t\t--************************************************************************************** \r\n\t\t--Declare Variables                                            \r\n\t\t--**************************************************************************************\r\n\t\t\r\n\t\tDECLARE @AccountNumber NVARCHAR(15)\r\n\t\tDECLARE @RecordExchangeCode VARCHAR(2)\r\n\t\tDECLARE @TransactionCode VARCHAR(2)\r\n\t\tDECLARE @GasRateCode dbo.ServiceClassification\r\n\t\tDECLARE @RateCodeChangeDate VARCHAR(8)\r\n\t\tDECLARE @WDNumber VARCHAR(2)\r\n\t\tDECLARE @RecordUtilitySeqid INT\r\n\t\tDECLARE @UtilityTariffRateInformationSeqid INT\r\n\t\tDECLARE @AccountSeqid INT\r\n\r\n\t\t\r\n\t\tdeclare @crlf varchar(2)\r\n\t\tset @crlf = CHAR(13) + CHAR(10) \r\n\t\tSET @RecordUtilitySeqid = 2\r\n\t\t\r\n\t\t--**************************************************************************************  \r\n\t\t--Main Process                                      \r\n\t\t--**************************************************************************************\r\n\r\n\t\t-- if the record is flagged as exclude, return and exit\r\n\t\tIF ( 'Y' = ( SELECT Exclude FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'This exchange is excluded from processing. ExchangeSeqid: ' + CAST( @ExchangeSeqid AS VARCHAR ) \r\n\t\t\tSET @StatusCode = 1\t-- this is not necessary an error\r\n\t\t\t;THROW 50000,@Message,1;\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- CHECK IF the record exists\r\n\t\tIF ( NOT EXISTS ( SELECT ExchangeDataSeqid FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid ))\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The ExchangeSeqid ' + CAST( @ExchangeSeqid AS VARCHAR ) + ' does not exist. Please verify '\r\n\t\t\tSET @StatusCode = 0\r\n\t\t\t;THROW 50000,@Message,1;\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- check if the record was processed\r\n\t\tIF ( 'Y' = ( SELECT IsProcessed FROM Common.ExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid) )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'This MISC exchange was already processed. ExchangeSeqid: ' + CAST( @ExchangeSeqid AS VARCHAR ) + '  ' + CAST( @ExchangeCode AS VARCHAR ) \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\t;THROW 50000,@Message,1;\r\n\t\t\tRETURN\r\n\t\tEND\r\n\r\n\t\t-- collect some basic information\r\n\t\tSELECT \r\n\t\t\t@AccountNumber\t\t\t= CurrentAccountNumber, \r\n\t\t\t@GasRateCode\t\t\t= DeliveryServiceClass,\r\n\t\t\t@RateCodeChangeDate\t\t= DeliveryServiceClassEffectiveDate,\r\n\t\t\t@WDNumber\t\t\t\t= TripNumber,\r\n\t\t\t@RecordExchangeCode\t\t= ExchangeCode,\r\n\t\t\t@TransactionCode\t\t= TransactionCode\r\n\t\tFROM Common.ExchangeData\r\n\t\tWHERE   (ExchangeDataSeqid = @ExchangeSeqid)\r\n\r\n\r\n\t\t-- some validation\r\n\t\t-- check the obvious\r\n\t\tIF ( @RecordExchangeCode <> 'DC' )\r\n\t\tBEGIN          \r\n\t\t\tSET @Message = 'The exchange code is not DC. Please verfiy: account number: ' + @AccountNumber \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\t;THROW 50000,@Message,1;\r\n\t\t\tRETURN\r\n\t\tEND\r\n\t\t\r\n\t\t-- verify the account exists under an active status\r\n\t\tSELECT @AccountSeqid = AccountSeqid FROM Billing.Account WHERE OriginalAccountNumber = @AccountNumber AND IsCurrentRecord = 'Y' --AND AccountStatus IN ('AC', '47', '46', 'UA') \r\n\t\tIF ( @AccountSeqid IS NULL )\r\n\t\tBEGIN\r\n\t\t\tSET @Message = 'The account number: ' + @AccountNumber + ' is NOT in the system under an active status. Please verfiy ' \r\n\t\t\tSET @StatusCode = 0\r\n\t\t\t;THROW 50000,@Message,1;\r\n\t\t\tRETURN\r\n\t\tEND\r\n\t\t\r\n\t\t\r\n\t\tbegin try\t\r\n\t\t\r\n\t\t\t\tbegin TRANSACTION exchangeMISC\r\n\t\t\t\tset @StatusCode  = 0\r\n\t\t\t\t\r\n\t\t\t\t-- update the GasRateCode\r\n\t\t\t\tIF ( @TransactionCode = 'SC')\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\t\t-- Update the tariff information  seqid in account record\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t-- verify that the tarrif exists in the UtilityTariffRateInformation table\r\n\t\t\t\t\t\tSELECT @UtilityTariffRateInformationSeqid = UtilityTariffRateInformationSeqid\r\n\t\t\t\t\t\tFROM Billing.UtilityTariffRateInformation\r\n\t\t\t\t\t\tWHERE\tUtilityCompanyTariff = @RecordUtilitySeqid \r\n\t\t\t\t\t\t\t\tAND DeliveryTariffRate = @GasRateCode\r\n\t\t\t\t\t\t\t\tAND IsTod = 'N'  -- all gas accounts\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIF ( @UtilityTariffRateInformationSeqid IS NULL OR @UtilityTariffRateInformationSeqid = 0 )\r\n\t\t\t\t\t\tBEGIN\t\r\n\t\t\t\t\t\t\tPRINT 'the reported rate on account number ' + @AccountNumber +  ' does not exist in the system, please verify'\t\t\r\n\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tUPDATE Billing.Account\r\n\t\t\t\t\t\tSET  CommodityTariffRate\t\t\t\t= @GasRateCode\r\n\t\t\t\t\t\t\t,CommodityTariffEffectiveDate\t\t= @RateCodeChangeDate\r\n\t\t\t\t\t\t\t,DeliveryTariffRate\t\t\t\t\t= @GasRateCode\r\n\t\t\t\t\t\t\t,DeliveryTariffEffectiveDate\t\t= @RateCodeChangeDate\r\n\t\t\t\t\t\t\t,UtilityTariffRateInformationSeqid\t= @UtilityTariffRateInformationSeqid\r\n\t\t\t\t\t\t\t,FireAuditTrigger\t\t\t\t\t= 'Y'\r\n\t\t\t\t\t\t\t,AuthenticatedUserID\t\t\t\t= @AuthenticatedUserID\r\n\t\t\t\t\t\t\t,LastUpdate\t\t\t\t\t\t\t= GETDATE()\r\n\t\t\t\t\t\t\t \r\n\t\t\t\t\t\tFROM Billing.Account\t\t\r\n\t\t\t\t\t\tWHERE AccountSeqid=@AccountSeqid\r\n\r\n\r\n\t\t\t\t\t\t-- mark as processed\t \r\n\t\t\t\t\t\tUPDATE common.ExchangeData\r\n\t\t\t\t\t\tSET IsProcessed = 'Y',\r\n\t\t\t\t\t\tAccountSeqid = @AccountSeqid\r\n\t\t\t\t\t\tWHERE ExchangeDataSeqid = @ExchangeSeqid\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tend\r\n\t\t\t\t\r\n\t\t\t\t-- update the Work Day\r\n\t\t\t\tIF ( @TransactionCode = 'WD')\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tupdate Billing.Account\r\n\t\t\t\t\t\tSET  TripNumber\t\t\t\t= @WDNumber\r\n\t\t\t\t\t\t\t,FireAuditTrigger\t\t= 'Y'\r\n\t\t\t\t\t\t\t,AuthenticatedUserID\t= @AuthenticatedUserID\r\n\t\t\t\t\t\t\t,LastUpdate\t\t\t\t= GETDATE()\r\n\t\t\t\t\t\t\t \r\n\t\t\t\t\t\tFROM Billing.Account\t\t\r\n\t\t\t\t\t\tWHERE AccountSeqid = @AccountSeqid\r\n\t\t\t\t\t\t\t \r\n\t\t\t\t\t\t-- mark as processed\r\n\t\t\t\t\t\tUPDATE Common.ExchangeData\r\n\t\t\t\t\t\tSET IsProcessed = 'Y',\r\n\t\t\t\t\t\tAccountSeqid = @AccountSeqid\r\n\t\t\t\t\t\tWHERE ExchangeDataSeqid = @ExchangeSeqid\t \r\n\r\n\t\t\t\t\r\n\t\t\t\tEND\r\n\t\t\t\t\r\n\r\n\t\t\t\tcommit TRANSACTION exchangeMISC\r\n\r\n\t\t\r\n\t\tEND TRY\r\n\t\t\r\n\t\t\r\n\t\tBEGIN CATCH\r\n\r\n\t\t\t\tROLLBACK TRAN exchangeMISC\r\n\t\t\t\tSET @Message = 'Error processing exchange  ' + CAST(@ExchangeSeqid AS VARCHAR(10)) + ' error message: ' + ERROR_MESSAGE()\r\n\t\t\t\tSET @StatusCode = 0\r\n\t\t\t\t;THROW 50000,@Message,1;\r\n\t\t\t\r\n\t\tEND CATCH\r\n\r\nEnd"
        }
      ]
    }
  ]
}