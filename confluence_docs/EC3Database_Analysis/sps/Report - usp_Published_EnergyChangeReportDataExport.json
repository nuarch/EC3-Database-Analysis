{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_EnergyChangeReportDataExport",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_EnergyChangeReportDataExport",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report on energy usage changes for facilities associated with specific agencies. It calculates and returns energy usage metrics for the current and previous fiscal years, including changes and percentage changes in energy consumption. The procedure logs its execution for auditing purposes and retrieves data based on the billing period and email address provided as input parameters."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including data retrieval, transformation, and aggregation. It uses temporary tables to manage intermediate data and performs calculations to derive changes in energy usage. The complexity arises from the need to handle multiple energy types and fiscal year calculations, as well as the integration of auditing functionality."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period for which the report is generated. It is used to filter and calculate energy usage data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Email AS emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. It is used to determine the agencies associated with the user and for logging purposes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by setting the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to avoid locking issues and initializes variables for fiscal year calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Auditing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It logs the execution of the report using the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " procedure, capturing details like the report name, stored procedure name, and the requesting user's email."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Fiscal Year Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates the current and previous fiscal years and billing periods using helper functions "
                },
                {
                  "type": "text",
                  "text": "CalculateFiscalYear",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "CalcBillingPeriodYearPrior",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Agencies",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Retrieves active agencies associated with the provided email address and stores them in a temporary table "
                        },
                        {
                          "type": "text",
                          "text": "@SelectedAgencies",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Facilities",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Retrieves facilities linked to the selected agencies and stores them in another temporary table "
                        },
                        {
                          "type": "text",
                          "text": "@Facility",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Energy Usage Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Aggregates energy usage data from the "
                },
                {
                  "type": "text",
                  "text": "TemporalAccountLevelSummaryByFacility",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table for the current and previous fiscal years, storing results in "
                },
                {
                  "type": "text",
                  "text": "@FacilitySummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Computes changes and percentage changes in energy usage metrics for BTU, KWH, Therms, and MLBS."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Result Set",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Joins the facility and summary data to produce the final result set, which includes detailed energy usage metrics and changes for each facility."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but may lead to reading uncommitted data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporary tables helps manage intermediate data but can increase memory usage and I/O operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Joins",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple aggregations and joins, which can be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensuring proper indexing on the tables involved, particularly on join and filter columns, can significantly enhance performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level may result in dirty reads, where uncommitted changes are visible, potentially leading to inaccurate data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the volume of data grows, the performance of aggregations and joins may degrade, necessitating optimization or hardware scaling."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete execution in case of errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The reliance on email addresses to determine agency access could pose a security risk if not properly validated and managed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Resource Utilization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of large temporary tables and complex calculations may lead to high resource consumption, impacting overall system performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_EnergyChangeReportDataExport]\n(\r\n\t@PublishedBillingPeriod AS BillingPeriod,\r\n\t@Email AS emailaddr\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\tEXEC [Audit].[usp_AddReportUsageLog]\r\n\t\t@ReportName = @spname,\r\n\t\t@StoredProcName = @spname,\r\n\t\t@RequestedBy = @Email,\r\n\t\t@prmPublishedBillingPeriod = @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod = NULL,\r\n\t\t@prmAgency_ies = null,\r\n\t\t@prmFacilityNumber_s = NULL,\r\n\t\t@prmStartingBillingPeriod = NULL,\r\n\t\t@prmEndingBillingPeriod = NULL\r\n\r\n\tDECLARE @FiscalYear AS VARCHAR(4), @PreviousFiscalYear AS VARCHAR(4), @MonthCurrentFY AS VARCHAR(6), @MonthPreviousFY AS VARCHAR(6);\r\n\t\r\n\tSELECT @FiscalYear = [dbo].[CalculateFiscalYear](@PublishedBillingPeriod),  @MonthPreviousFY = [dbo].[CalcBillingPeriodYearPrior](@PublishedBillingPeriod);\r\n\tSELECT @PreviousFiscalYear = CAST(CAST(@FiscalYear AS INT)  - 1 AS VARCHAR(4));\r\n\tSET @MonthCurrentFY = @PublishedBillingPeriod\r\n\r\n\tDECLARE @SelectedAgencies TABLE (AgencyDivisionSeqID seqid, AgencyCodeOEC AgencyCodeOEC, AgencyName VARCHAR(75));\r\n\tDECLARE @Facility TABLE (AgencyName VARCHAR(75),\r\n\t\tFacilitySeqId INT,\r\n\t\tOECFacilityID VARCHAR(7),\r\n\t\tFacilityName VARCHAR(100),\r\n\t\tFacilityAddress LongAddress,\r\n\t\tTotalSquareFootage SquareFootage,\r\n\t\tAgencyCodeOEC AgencyCodeOEC);\r\n\tDECLARE @FacilitySummary TABLE (FacilitySeqId INT,\r\n\t\tAgencyCodeOEC AgencyCodeOEC,\r\n\t\tBTUMonthCurrentFY NUMERIC(38, 6),\r\n\t\tBTUMonthPreviousFY NUMERIC(38, 6),\r\n\t\tBTUMonthChange FLOAT,\r\n\t\tBTUMonthPercentageChange FLOAT,\r\n\t\tBTUYTDCurentFY NUMERIC(38, 6),\r\n\t\tBTUYTDPreviousFY NUMERIC(38, 6),\r\n\t\tBTUYTDChange INT,\r\n\t\tBTUYTDPercentageChange FLOAT,\r\n\t\tKWHMonthCurrentFY INT,\r\n\t\tKWHMonthPreviousFY INT,\r\n\t\tKWHMonthChange INT,\r\n\t\tKWHYTDCurrentFY INT,\r\n\t\tKWHYTDPreviousFY INT,\r\n\t\tKWHYTDChange INT,\r\n\t\tThermsMonthCurrentFY INT,\r\n\t\tThermsMonthPreviousFY INT,\r\n\t\tThermsMonthChange INT,\r\n\t\tThermsYTDCurrentFY INT,\r\n\t\tThermsYTDPreviousFY INT,\r\n\t\tThermsYTDChange INT,\r\n\t\tMLBSMonthCurrentFY INT,\r\n\t\tMLBSMonthPreviousFY INT,\r\n\t\tMLBSMonthChange INT,\r\n\t\tMLBSYTDCurrentFY INT,\r\n\t\tMLBSYTDPreviousFY INT,\r\n\t\tMLBSYTDChange INT);\r\n\r\n\tINSERT INTO @SelectedAgencies(AgencyDivisionSeqID, AgencyCodeOEC, AgencyName)\r\n\tSELECT DISTINCT a.AgencyDivisionSeqID, A.AgencyCodeOEC, A.AgencyName\r\n\tFROM dbo.uftn_TableGetActiveAgenciesByEmailAddress(@Email) AS A;\r\n\r\n\tINSERT INTO @Facility\r\n\t\t(AgencyName,\r\n\t\tFacilitySeqId,\r\n\t\tOECFacilityID,\r\n\t\tFacilityName,\r\n\t\tFacilityAddress,\r\n\t\tTotalSquareFootage,\r\n\t\tAgencyCodeOEC)\r\n\tSELECT DISTINCT SA.AgencyName,\r\n\t\tF.FacilitySeqid,\r\n\t\tF.OecFacilityNumber,\r\n\t\tF.FacilityName,\r\n\t\tF.Address1,\r\n\t\tF.TotalSquareFootage,\r\n\t\tSA.AgencyCodeOEC\r\n\tFROM @SelectedAgencies AS SA\r\n\t\tINNER JOIN Billing.Account AS A ON A.AgencyAccount = SA.AgencyDivisionSeqid\r\n\t\tINNER JOIN Billing.Facility AS F ON A.FacilityAccount = F.FacilitySeqid\r\n\tWHERE A.AccountStatus IN ('AC', '46', 'UA');\r\n\r\n\tINSERT INTO @FacilitySummary\r\n\t\t(FacilitySeqId,\r\n\t\tAgencyCodeOEC,\r\n\t\tBTUMonthCurrentFY,\r\n\t\tBTUMonthPreviousFY,\r\n\t\tBTUYTDCurentFY,\r\n\t\tBTUYTDPreviousFY,\r\n\t\tKWHMonthCurrentFY,\r\n\t\tKWHMonthPreviousFY,\r\n\t\tKWHYTDCurrentFY,\r\n\t\tKWHYTDPreviousFY,\r\n\t\tThermsMonthCurrentFY,\r\n\t\tThermsMonthPreviousFY,\r\n\t\tThermsYTDCurrentFY,\r\n\t\tThermsYTDPreviousFY,\r\n\t\tMLBSMonthCurrentFY,\r\n\t\tMLBSMonthPreviousFY,\r\n\t\tMLBSYTDCurrentFY,\r\n\t\tMLBSYTDPreviousFY)\r\n\tSELECT F.FacilitySeqId,\r\n\t\tF.AgencyCodeOEC,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY THEN TAS.BTU ELSE 0 END) AS BTUMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY THEN TAS.BTU ELSE 0 END) AS BTUMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear THEN TAS.BTU ELSE 0 END) AS BTUYTDCurentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY THEN TAS.BTU ELSE 0 END) AS BTUYTDPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY  AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHYTDCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY AND TAS.EnergyType = 'ELE' THEN TAS.EnergyUsage ELSE 0 END) AS KWHYTDPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsYTDCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY AND TAS.EnergyType = 'GAS' THEN TAS.EnergyUsage ELSE 0 END) AS ThermsYTDPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthCurrentFY AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSMonthCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.BillingPeriod = @MonthPreviousFY AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSMonthPreviousFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @FiscalYear AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSYTDCurrentFY,\r\n\t\tSUM(CASE WHEN TAS.FiscalYear = @PreviousFiscalYear AND TAS.BillingPeriod <= @MonthPreviousFY AND TAS.EnergyType = 'STM' THEN TAS.EnergyUsage ELSE 0 END) AS MLBSYTDPreviousFY\r\n\tFROM @Facility AS F INNER JOIN Published.TemporalAccountLevelSummaryByFacility AS TAS ON TAS.OecFacilityNumber = F.OECFacilityID AND TAS.AgencyCodeOEC = F.AgencyCodeOEC\r\n\tWHERE TAS.FiscalYear IN (@FiscalYear, @PreviousFiscalYear) AND TAS.EffectiveStartPeriod <= @PublishedBillingPeriod AND TAS.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\tGROUP BY F.FacilitySeqId, F.AgencyCodeOEC;\r\n\r\n\t-- calculate change column\r\n\tUPDATE  @FacilitySummary\r\n\tSET BTUMonthChange = BTUMonthCurrentFY - BTUMonthPreviousFY,\r\n\t\tBTUMonthPercentageChange = CAST(BTUMonthCurrentFY - BTUMonthPreviousFY AS FLOAT) / NULLIF(BTUMonthPreviousFY, 0),\r\n\t\tBTUYTDChange = BTUYTDCurentFY - BTUYTDPreviousFY,\r\n\t\tBTUYTDPercentageChange = CAST(BTUYTDCurentFY - BTUYTDPreviousFY AS FLOAT) / NULLIF(BTUYTDPreviousFY, 0),\r\n\t\tKWHMonthChange = KWHMonthCurrentFY - KWHMonthPreviousFY,\r\n\t\tKWHYTDChange = KWHYTDCurrentFY - KWHYTDPreviousFY,\r\n\t\tThermsMonthChange = ThermsMonthCurrentFY - ThermsMonthPreviousFY,\r\n\t\tThermsYTDChange =ThermsYTDCurrentFY - ThermsYTDPreviousFY,\r\n\t\tMLBSMonthChange = MLBSMonthCurrentFY - MLBSMonthPreviousFY,\r\n\t\tMLBSYTDChange = MLBSYTDCurrentFY - MLBSYTDPreviousFY;\r\n\r\n\tSELECT F.AgencyName,\r\n\t\tF.OECFacilityID,\r\n\t\tF.FacilityName,\r\n\t\tF.FacilityAddress,\r\n\t\tF.TotalSquareFootage,\r\n\t\tF.AgencyCodeOEC,\r\n\t\tFS.BTUMonthCurrentFY,\r\n\t\tFS.BTUMonthPreviousFY,\r\n\t\tFS.BTUMonthChange,\r\n\t\tFS.BTUMonthPercentageChange,\r\n\t\tFS.BTUYTDCurentFY,\r\n\t\tFS.BTUYTDPreviousFY,\r\n\t\tFS.BTUYTDChange,\r\n\t\tFS.BTUYTDPercentageChange,\r\n\t\tFS.KWHMonthCurrentFY,\r\n\t\tFS.KWHMonthPreviousFY,\r\n\t\tFS.KWHMonthChange,\r\n\t\tFS.KWHYTDCurrentFY,\r\n\t\tFS.KWHYTDPreviousFY,\r\n\t\tFS.KWHYTDChange,\r\n\t\tFS.ThermsMonthCurrentFY,\r\n\t\tFS.ThermsMonthPreviousFY,\r\n\t\tFS.ThermsMonthChange,\r\n\t\tFS.ThermsYTDCurrentFY,\r\n\t\tFS.ThermsYTDPreviousFY,\r\n\t\tFS.ThermsYTDChange,\r\n\t\tFS.MLBSMonthCurrentFY,\r\n\t\tFS.MLBSMonthPreviousFY,\r\n\t\tFS.MLBSMonthChange,\r\n\t\tFS.MLBSYTDCurrentFY,\r\n\t\tFS.MLBSYTDPreviousFY,\r\n\t\tFS.MLBSYTDChange\r\n\tFROM @FacilitySummary AS FS\r\n\t\tINNER JOIN @Facility AS F ON FS.FacilitySeqId = F.FacilitySeqId AND FS.AgencyCodeOEC = F.AgencyCodeOEC;\r\nEND;"
        }
      ]
    }
  ]
}