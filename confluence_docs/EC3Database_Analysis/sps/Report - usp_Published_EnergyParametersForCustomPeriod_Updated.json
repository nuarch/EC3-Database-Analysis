{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_EnergyParametersForCustomPeriod_Updated",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_EnergyParametersForCustomPeriod_Updated",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report of energy parameters for a specified custom period. It logs the usage of the report, retrieves energy-related data from a temporal table, and aggregates this data based on specific criteria. The procedure outputs a summary of energy parameters such as cost, demand, and usage for facilities within a specified agency and billing period."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple SQL operations, including data retrieval, transformation, and aggregation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses a temporary table to store intermediate results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes conditional logic to handle different energy types."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves joining with a user-defined function to filter data based on agency hierarchy."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report, used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the report is published."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The agency code used to filter data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OecFacilityNumber AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The facility number used to filter data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriodStart AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The start of the billing period range for data retrieval."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriodEnd AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The end of the billing period range for data retrieval."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by logging the report usage through an audit stored procedure, capturing details such as the report name, requested by, and parameters used."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It retrieves data from the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalAccountLevelRawDataForCurrentPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, filtering records based on the effective period and billing period range."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Transformation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses conditional logic to transform energy types into descriptive cost or usage labels."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The retrieved data is inserted into a temporary table, "
                },
                {
                  "type": "text",
                  "text": "@tbl",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which is then used to calculate the total revised billed amount for each facility and energy parameter."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The final result set is selected from the temporary table, grouping by facility and energy parameter, and ordered by the current account number."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level, which can improve performance by reducing locking but leads to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a temporary table can impact performance, especially if the dataset is large. Consider indexing or optimizing the temporary table if performance issues arise."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Call",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The join with the user-defined function "
                },
                {
                  "type": "text",
                  "text": "uftn_TableGetOECFacilityNumberByAgencyHierarchy",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " be a performance bottleneck if the function is complex or not optimized."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Using "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to reading uncommitted or dirty data, which might not be suitable for all reporting scenarios."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a temporary table and multiple UNION ALL operations could affect scalability as the data volume increases."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or failures."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no validation for input parameters, which could lead to unexpected behavior if invalid data is provided."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the procedure is executed with appropriate permissions to prevent unauthorized data access."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_EnergyParametersForCustomPeriod_Updated]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@PublishedBillingPeriod AS VARCHAR(6)\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX)\r\n\t,@OecFacilityNumber AS VARCHAR(MAX)\r\n\t,@BillingPeriodStart AS VARCHAR(6)\r\n\t,@BillingPeriodEnd AS VARCHAR(6)\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName\t\t\t\t\t= @spname,\r\n\t\t@StoredProcName\t\t\t\t= @spname,\r\n\t\t@RequestedBy\t\t\t\t= @EmailAddress,    \r\n\t\t@prmPublishedBillingPeriod\t= @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod\t\t\t= NULL,\r\n\t\t@prmAgency_ies\t\t\t\t= @AgencyCodeOEC, \r\n\t\t@prmFacilityNumber_s\t\t= @OecFacilityNumber,\r\n\t\t@prmStartingBillingPeriod\t= @BillingPeriodStart,\r\n\t\t@prmEndingBillingPeriod\t\t= @BillingPeriodEnd\r\n\r\n\tDECLARE @tbl TABLE(PublishedBillingPeriod VARCHAR(6)\r\n\t\t,BillingPeriod VARCHAR(6)\r\n\t\t,FiscalYear VARCHAR(4)\r\n\t\t,BillingMonth VARCHAR(20)\r\n\t\t,AgencyCodeOEC VARCHAR(10)\r\n\t\t,AgencyName VARCHAR(100)\r\n\t\t,OecFacilityNumber VARCHAR(10)\r\n\t\t,FacilityName VARCHAR(250)\r\n\t\t,Address1 VARCHAR(250)\r\n\t\t,UtilityCompany VARCHAR(100)\r\n\t\t,UtilityServiceAddress VARCHAR(250)\r\n\t\t,CityPlanningBIN VARCHAR(10)\r\n\t\t,Borough VARCHAR(10)\r\n\t\t,[Block] VARCHAR(5)\r\n\t\t,LotNumber VARCHAR(5)\r\n\t\t,CurrentAccountNumber VARCHAR(15)\r\n\t\t,Cost VARCHAR(25)\r\n\t\t,RevisedBilledAmount DECIMAL);\r\n\r\n\tINSERT INTO @tbl\r\n\tSELECT @PublishedBillingPeriod AS PublishedBillingPeriod\r\n\t\t,T.BillingPeriod \r\n\t\t,T.FiscalYear\r\n\t\t,T.BillingMonth \r\n\t\t,T.AgencyCodeOEC\r\n\t\t,T.AgencyName\r\n\t\t,T.OecFacilityNumber\r\n\t\t,T.FacilityName\r\n\t\t,T.Address1\r\n\t\t,T.UtilityCompany\r\n\t\t,T.UtilityServiceAddress\r\n\t\t,T.CityPlanningBIN\r\n\t\t,T.Borough\r\n\t\t,T.[Block]\r\n\t\t,T.LotNumber\r\n\t\t,T.CurrentAccountNumber \r\n\t\t,CASE WHEN T.Energytype = 'ELE' THEN 'Electricity Cost ($)' WHEN T.Energytype = 'GAS' THEN 'Gas Cost ($)' \r\n\t\t\tWHEN T.Energytype = 'STM' THEN 'Steam Cost ($)' END AS Cost\r\n\t\t,T.RevisedBilledAmount\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS T\r\n\t\tINNER JOIN Billing.uftn_TableGetOECFacilityNumberByAgencyHierarchy(@AgencyCodeOEC, @OecFacilityNumber, @EmailAddress) AS A\r\n\t\t\tON T.OecFacilityNumber = A.OecFacilityNumber AND T.AgencyCodeOEC = A.AgencyCodeOEC\r\n\tWHERE T.EffectiveStartPeriod <= @PublishedBillingPeriod AND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND T.BillingPeriod >= @BillingPeriodStart AND T.BillingPeriod <= @BillingPeriodEnd\r\n\tUNION ALL\r\n\tSELECT @PublishedBillingPeriod AS PublishedBillingPeriod\r\n\t\t,T.BillingPeriod\r\n\t\t,T.FiscalYear\r\n\t\t,T.BillingMonth\r\n\t\t,T.AgencyCodeOEC\r\n\t\t,T.AgencyName\r\n\t\t,T.OecFacilityNumber\r\n\t\t,T.FacilityName\r\n\t\t,T.Address1\r\n\t\t,T.UtilityCompany\r\n\t\t,T.UtilityServiceAddress \r\n\t\t,T.CityPlanningBIN\r\n\t\t,T.Borough\r\n\t\t,T.[Block]\r\n\t\t,T.LotNumber\r\n\t\t,T.CurrentAccountNumber\r\n\t\t,CASE WHEN T.Energytype = 'ELE' THEN 'Electricity Demand (kW)' ELSE '' END AS Expr1\r\n\t\t,T.AccountDemandUsage\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS T\r\n\t\tINNER JOIN Billing.uftn_TableGetOECFacilityNumberByAgencyHierarchy(@AgencyCodeOEC, @OecFacilityNumber, @EmailAddress) AS A\r\n\t\t\tON T.OecFacilityNumber = A.OecFacilityNumber AND T.AgencyCodeOEC = A.AgencyCodeOEC\r\n\tWHERE T.EffectiveStartPeriod <= @PublishedBillingPeriod AND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND T.BillingPeriod >= @BillingPeriodStart AND T.BillingPeriod <= @BillingPeriodEnd\t\r\n\tUNION ALL\r\n\tSELECT @PublishedBillingPeriod AS PublishedBillingPeriod\r\n\t\t,T.BillingPeriod\r\n\t\t,T.FiscalYear\r\n\t\t,T.BillingMonth\r\n\t\t,T.AgencyCodeOEC\r\n\t\t,T.AgencyName\r\n\t\t,T.OecFacilityNumber\r\n\t\t,T.FacilityName\r\n\t\t,T.Address1\r\n\t\t,T.UtilityCompany\r\n\t\t,T.UtilityServiceAddress\r\n\t\t,T.CityPlanningBIN\r\n\t\t,T.Borough\r\n\t\t,T.[Block]\r\n\t\t,T.LotNumber\r\n\t\t,T.CurrentAccountNumber\r\n\t\t,CASE WHEN T.Energytype = 'ELE' THEN 'Electricity Usage (kWh)' WHEN T.Energytype = 'GAS' THEN 'Gas (Therms)' \r\n\t\t\tWHEN T.Energytype = 'STM' THEN 'Steam (MLbs)' END AS Cost\r\n\t\t,T.AccountEnergyUsage\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS T\r\n\t\tINNER JOIN Billing.uftn_TableGetOECFacilityNumberByAgencyHierarchy(@AgencyCodeOEC, @OecFacilityNumber, @EmailAddress) AS A\r\n\t\t\tON T.OecFacilityNumber = A.OecFacilityNumber AND T.AgencyCodeOEC = A.AgencyCodeOEC\r\n\tWHERE T.EffectiveStartPeriod <= @PublishedBillingPeriod AND T.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND T.BillingPeriod >= @BillingPeriodStart AND T.BillingPeriod <= @BillingPeriodEnd;\r\n\r\n\tSELECT OecFacilityNumber\r\n\t\t,CityPlanningBIN\r\n\t\t,Address1 AS FacilityAddress\r\n\t\t,FacilityName\r\n\t\t,UtilityCompany\r\n\t\t,UtilityServiceAddress\r\n\t\t,CurrentAccountNumber\r\n\t\t,Cost AS EnergyParameter\r\n\t\t,FORMAT(SUM(ISNULL(RevisedBilledAmount, 0)), 'N2') AS Total\r\n\tFROM @tbl\r\n\tGroup By OecFacilityNumber\r\n\t\t,CityPlanningBIN, Address1, FacilityName, UtilityCompany, UtilityServiceAddress, CurrentAccountNumber, Cost\r\n\tHAVING Cost <> ''\r\n\tORDER BY CurrentAccountNumber;\r\nEND;"
        }
      ]
    }
  ]
}