{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Published_AgencyExcelData",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Published_AgencyExcelData",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report of revised billing and energy data for a specified agency over a fiscal year. It logs the usage of the report and retrieves aggregated billing and energy data for each month within the fiscal year for agencies related to the specified agency code. The data is filtered based on a published billing period and is grouped by agency code, agency name, fiscal year, and energy type."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple operations, including logging, data retrieval with joins, filtering, and aggregation. The use of a user-defined function to retrieve agency data adds to the complexity. However, the logic is straightforward, focusing on data aggregation and filtering."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. Used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@PublishedBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the report is generated. It is used to filter the data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The agency code for which the report is generated. It is used to retrieve related agency data and filter the results."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure starts by logging the report usage through the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " stored procedure. This includes details like the report name, stored procedure name, requester email, and the published billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure retrieves data from the "
                        },
                        {
                          "type": "text",
                          "text": "Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It joins this table with the result of the function "
                        },
                        {
                          "type": "text",
                          "text": "Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", which returns agency codes related to the input agency code."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The data is filtered to include only records where the "
                        },
                        {
                          "type": "text",
                          "text": "EffectiveStartPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is less than or equal to the "
                        },
                        {
                          "type": "text",
                          "text": "@PublishedBillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and the "
                        },
                        {
                          "type": "text",
                          "text": "EffectiveEndPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is greater than the "
                        },
                        {
                          "type": "text",
                          "text": "@PublishedBillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure aggregates monthly revised billing dollars, energy, and demand data for each agency, fiscal year, and energy type."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The results are grouped by agency code, agency name, fiscal year, and energy type to provide a summarized view of the data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses "
                },
                {
                  "type": "text",
                  "text": "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which can improve performance by allowing dirty reads but may result in reading uncommitted data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The aggregation of monthly data can be resource-intensive, especially if the dataset is large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Call",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a user-defined function to retrieve agency data can impact performance, depending on the complexity and execution time of the function."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level can lead to reading uncommitted or inconsistent data, which may not be suitable for all reporting requirements."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Type for Agency Code",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is defined as "
                },
                {
                  "type": "text",
                  "text": "VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which may not be necessary if the agency codes are of a fixed or smaller length. This could lead to inefficient memory usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the performance of the aggregation and join operations may degrade, requiring optimization or indexing strategies."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete operations in case of failures."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Published_AgencyExcelData]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@PublishedBillingPeriod AS VARCHAR(6)\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX)\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\t DECLARE @spname AS VARCHAR(100) = OBJECT_NAME(@@PROCID)\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName\t\t\t\t\t= @spname,\r\n\t\t@StoredProcName\t\t\t\t= @spname,\r\n\t\t@RequestedBy\t\t\t\t= @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod\t= @PublishedBillingPeriod,\r\n\t\t@prmBillingPeriod\t\t\t= NULL,\r\n\t\t@prmAgency_ies\t\t\t\t= @AgencyCodeOEC,\r\n\t\t@prmFacilityNumber_s\t\t= NULL,\r\n\t\t@prmStartingBillingPeriod\t= NULL,\r\n\t\t@prmEndingBillingPeriod\t\t= NULL\r\n\r\n--------------------------------------------------------------------------\r\n\r\ndeclare @AgencyCode varchar(7)\r\n\r\n\t\tSELECT \r\n\t\t\t\t@PublishedBillingPeriod AS PublishedBillingPeriod, \r\n\t\t\t\tFYPivot.AgencyCodeOEC, \r\n\t\t\t\tFYPivot.AgencyName, \r\n\t\t\t\tFYPivot.FiscalYear,  \r\n\t\t\t\tFYPivot.EnergyType, \r\n\t\t\t\tsum(FYPivot.JulyRevisedBilledDollars) as JulyRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.AugustRevisedBilledDollars) as AugustRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.SeptemberRevisedBilledDollars) as SeptemberRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.OctoberRevisedBilledDollars) as OctoberRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.NovemberRevisedBilledDollars) as NovemberRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.DecemberRevisedBilledDollars) as DecemberRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.JanuaryRevisedBilledDollars) as JanuaryRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.FebruaryRevisedBilledDollars) as FebruaryRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.MarchRevisedBilledDollars) as MarchRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.AprilRevisedBilledDollars) as AprilRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.MayRevisedBilledDollars) as MayRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.JuneRevisedBilledDollars) as JuneRevisedBilledDollars, \r\n\t\t\t\tsum(FYPivot.JulyRevisedEnergy) as JulyRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.AugustRevisedEnergy) as AugustRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.SeptemberRevisedEnergy) as SeptemberRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.OctoberRevisedEnergy) as OctoberRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.NovemberRevisedEnergy) as NovemberRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.DecemberRevisedEnergy) as DecemberRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.JanuaryRevisedEnergy) as JanuaryRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.FebruaryRevisedEnergy) as FebruaryRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.MarchRevisedEnergy) as MarchRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.AprilRevisedEnergy) as AprilRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.MayRevisedEnergy) as MayRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.JuneRevisedEnergy) as JuneRevisedEnergy, \r\n\t\t\t\tsum(FYPivot.JulyRevisedDemand) as JulyRevisedDemand, \r\n\t\t\t\tsum(FYPivot.AugustRevisedDemand) as AugustRevisedDemand, \r\n\t\t\t\tsum(FYPivot.SeptemberRevisedDemand) as SeptemberRevisedDemand, \r\n\t\t\t\tsum(FYPivot.OctoberRevisedDemand) as OctoberRevisedDemand, \r\n\t\t\t\tsum(FYPivot.NovemberRevisedDemand) as NovemberRevisedDemand, \r\n\t\t\t\tsum(FYPivot.DecemberRevisedDemand) as DecemberRevisedDemand, \r\n\t\t\t\tsum(FYPivot.JanuaryRevisedDemand) as JanuaryRevisedDemand, \r\n\t\t\t\tsum(FYPivot.FebruaryRevisedDemand) as FebruaryRevisedDemand, \r\n\t\t\t\tsum(FYPivot.MarchRevisedDemand) as MarchRevisedDemand, \r\n\t\t\t\tsum(FYPivot.AprilRevisedDemand) as AprilRevisedDemand, \r\n\t\t\t\tsum(FYPivot.MayRevisedDemand) as MayRevisedDemand, \r\n\t\t\t\tsum(FYPivot.JuneRevisedDemand) as JuneRevisedDemand\r\n\t\tFROM     \r\n\t\t\t\tPublished.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage FYPivot INNER JOIN\r\n\t\t\t\tBilling.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC,@EmailAddress) AS uftn_TableGetAgencyChildrenByAgencyCodeOEC_1 ON \r\n\t\t\t\tFYPivot.AgencyCodeOEC = uftn_TableGetAgencyChildrenByAgencyCodeOEC_1.AgencyCodeOEC\r\n\t\tWHERE \r\n\t\t\t\t(FYPivot.EffectiveStartPeriod <= @PublishedBillingPeriod AND  FYPivot.EffectiveEndPeriod > @PublishedBillingPeriod)\r\n\t\tGROUP BY\t\r\n\t\t\t\tFYPivot.AgencyCodeOEC,  \r\n\t\t\t\tFYPivot.AgencyName, \r\n\t\t\t\tFYPivot.FiscalYear, \r\n\t\t\t\tFYPivot.EnergyType \r\nend"
        }
      ]
    }
  ]
}