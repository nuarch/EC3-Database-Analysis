{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "BudgetSurvey",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_AgencyFacilitySurvey_Retrieve",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_AgencyFacilitySurvey_Retrieve",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve detailed information about an agency's facility survey. It combines data from multiple tables to provide a comprehensive view of the survey, including energy usage, facility details, and associated SBMR (State Budget Management Report) identifiers. The procedure uses input parameters to filter and retrieve specific records related to an agency's facility survey."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple table joins, subqueries, and conditional logic, which adds to its complexity. The use of dynamic date calculations and XML path queries for concatenating results further increases the complexity. However, it does not involve any advanced SQL features like dynamic SQL or complex transaction handling, keeping it at a medium complexity level."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyFacilitySurveyId AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Identifies the specific agency facility survey to retrieve."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyDivisionSeqId AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters the data to a specific agency division."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@FacilitySeqId AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Filters the data to a specific facility."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", allowing dirty reads to improve performance by avoiding locks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": It calculates the start and end billing periods based on the maximum fiscal year available in the "
                },
                {
                  "type": "text",
                  "text": "Published.AccountLevelSummaryByFacility",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table. The published billing period is also retrieved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Subquery L",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Aggregates facility and energy usage data from the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Facility",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Account",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "Published.AccountLevelSummaryByFacility",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " tables. It filters by the provided "
                        },
                        {
                          "type": "text",
                          "text": "@AgencyDivisionSeqId",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "@FacilitySeqId",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Subquery R",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Retrieves survey details from the "
                        },
                        {
                          "type": "text",
                          "text": "BudgetSurvey.AgencyFacilitySurvey",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table, filtering by "
                        },
                        {
                          "type": "text",
                          "text": "@AgencyFacilitySurveyId",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "ActionTypeId = 3",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Main Query",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Joins the results of subqueries L and R to produce a comprehensive dataset. It includes additional subqueries to concatenate SBMR header sequence IDs and reference numbers into comma-separated strings."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure returns a single row with detailed survey information, including energy usage, facility details, and SBMR identifiers."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This isolation level improves performance by reducing locking overhead but may return uncommitted or dirty data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexes",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that appropriate indexes exist on the columns used in joins and where clauses, such as "
                },
                {
                  "type": "text",
                  "text": "FacilitySeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "AgencyDivisionSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "AgencyFacilitySurveyId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", to enhance query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "MAX",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "SUM",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " functions in subquery L can be resource-intensive, especially if the underlying tables are large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Subqueries",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The XML path subqueries for concatenating SBMR IDs and numbers could be optimized if performance issues arise."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " may lead to inconsistent data being returned if there are concurrent updates to the tables involved."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the maximum fiscal year is a valid reference for calculating billing periods, which may not always be accurate if data is missing or incomplete."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the performance of aggregation and join operations may degrade, necessitating further optimization or indexing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions if unexpected data conditions occur."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [BudgetSurvey].[usp_AgencyFacilitySurvey_Retrieve]\n(\r\n\t @AgencyFacilitySurveyId AS INT,\r\n\t @AgencyDivisionSeqId AS INT,\r\n\t @FacilitySeqId AS INT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @PublishedBillingPeriod AS BillingPeriod, @StartPeriod AS BillingPeriod, @EndPeriod AS BillingPeriod;\r\n\t\r\n\tSELECT @StartPeriod = CAST(CAST(MAX(FiscalYear) AS INT) - 2 AS VARCHAR(5)) + '11'\r\n\t\t,@EndPeriod = CAST(CAST(MAX(FiscalYear) AS INT) - 1 AS VARCHAR(5)) + '10'\r\n\t\t,@PublishedBillingPeriod = MAX(PublishedBillingPeriod)\r\n\tFROM Published.AccountLevelSummaryByFacility;\r\n\t\r\n\tSELECT ISNULL(R.AgencyFacilitySurveyId, 0) AS AgencyFacilitySurveyId\r\n        ,ISNULL(R.AgencyDivisionSeqId, L.AgencyDivisionSeqid) AS AgencyDivisionSeqId\r\n\t\t,L.AgencyName\r\n        ,3 AS ActionTypeId\r\n        ,R.ActionEffectiveDate\r\n        ,ISNULL(R.FiscalYear, 0) AS FiscalYear\r\n        ,R.BriefDescription\r\n        ,L.FacilitySeqId\r\n        ,L.FacilityName\r\n        ,R.FacilityAddress\r\n        ,R.BoroughId\r\n        ,R.NumberOfFacilitiesImpacted\r\n        ,CAST(L.ElecUsage AS INT) AS ElecUsage\r\n        ,CAST(L.ElecDemand AS INT) AS ElecDemand\r\n        ,CAST(L.GasUsage AS INT) AS GasUsage\r\n        ,L.SteamUsage\r\n        ,R.HeatingCoolingTypeId\r\n        ,R.NameOfOMBTaskForce\r\n        ,R.InitiativeId\r\n        ,R.FinancialPlanInitiativeApproved\r\n        ,R.ApprovedAmount\r\n        ,ISNULL(R.CreatedBy, 0) AS CreatedBy\r\n        ,ISNULL(R.CreatedOn, GETDATE()) AS CreatedOn\r\n        ,R.ModifiedBy\r\n        ,R.ModifiedOn\r\n\t\t,(SELECT STUFF((SELECT ', ' + CAST(SH.SBMRHeaderSeqid AS VARCHAR(10)) FROM BudgetSurvey.AgencyFacilitySurveySBMR AS SS \r\n\t\t\t\tINNER JOIN SBMR.SBMRHeader AS SH ON SH.SBMRHeaderSeqid = SS.SBMRId\r\n\t\t\tWHERE SS.AgencyFacilitySurveyId = R.AgencyFacilitySurveyId FOR XML PATH('')), 1, 2, '')) AS SbmrIds\r\n\t\t,(SELECT STUFF((SELECT ', ' + SH.SbmrReferenceNumber FROM BudgetSurvey.AgencyFacilitySurveySBMR AS SS \r\n\t\t\t\tINNER JOIN SBMR.SBMRHeader AS SH ON SH.SBMRHeaderSeqid = SS.SBMRId\r\n\t\t\tWHERE SS.AgencyFacilitySurveyId = R.AgencyFacilitySurveyId FOR XML PATH('')), 1, 2, '')) AS SbmrNumbers\r\n\tFROM (SELECT AD.AgencyDivisionSeqid\r\n\t\t\t\t,MAX(F.FacilitySeqid) AS FacilitySeqid\r\n\t\t\t\t,SUM(CASE WHEN AF.EnergyType = 'ELE' THEN AF.EnergyUsage ELSE 0 END) AS ElecUsage\r\n\t\t\t\t,MAX(CASE WHEN AF.EnergyType = 'ELE' THEN AF.DemandUsage ELSE 0 END) AS ElecDemand\r\n\t\t\t\t,SUM(CASE WHEN AF.EnergyType = 'GAS' THEN AF.EnergyUsage ELSE 0 END) AS GasUsage\r\n\t\t\t\t,SUM(CASE WHEN AF.EnergyType = 'STM' THEN AF.EnergyUsage ELSE 0 END) AS SteamUsage\r\n\t\t\t\t,MAX(F.OecFacilityNumber) + ' - ' + MAX(F.FacilityName) + ' (' + MAX(ISNULL(F.Address1, '')) + ')' AS FacilityName\r\n\t\t\t\t,MAX(AD.AgencyCodeOEC) + ' - ' + MAX(AD.AgencyName) + ' (' + MAX(AD.AgencyShortDesc) + ')' AS AgencyName\r\n\t\t\tFROM Billing.Facility AS F\r\n\t\t\t\tINNER JOIN Billing.Account AS A ON A.FacilityAccount = F.FacilitySeqid\r\n\t\t\t\tINNER JOIN Billing.AgencyDivision AS AD ON AD.AgencyDivisionSeqid = A.AgencyAccount AND AD.AgencyDivisionSeqid =  @AgencyDivisionSeqID\r\n\t\t\t\tLEFT JOIN Published.AccountLevelSummaryByFacility AS AF ON F.OecFacilityNumber = AF.OecFacilityNumber \r\n\t\t\t\t\tAND AF.PublishedBillingPeriod = @PublishedBillingPeriod\r\n\t\t\t\t\tAND AF.BillingPeriod BETWEEN @StartPeriod AND @EndPeriod\r\n\t\t\tWHERE F.FacilitySeqid = @FacilitySeqId\r\n\t\t\tGROUP BY AF.OecFacilityNumber,\r\n\t\t\t\tAD.AgencyDivisionSeqid) AS L\r\n\t\tLEFT JOIN (SELECT AFS.AgencyFacilitySurveyId\r\n               ,AFS.AgencyDivisionSeqId\r\n               ,AFS.ActionTypeId\r\n               ,AFS.ActionEffectiveDate\r\n               ,AFS.FiscalYear\r\n               ,AFS.BriefDescription\r\n               ,AFS.FacilitySeqId\r\n               ,AFS.FacilityName\r\n               ,AFS.FacilityAddress\r\n               ,AFS.BoroughId\r\n               ,AFS.NumberOfFacilitiesImpacted\r\n               ,AFS.ElecUsage\r\n               ,AFS.ElecDemand\r\n               ,AFS.GasUsage\r\n               ,AFS.SteamUsage\r\n               ,AFS.HeatingCoolingTypeId\r\n               ,AFS.NameOfOMBTaskForce\r\n               ,AFS.InitiativeId\r\n               ,AFS.FinancialPlanInitiativeApproved\r\n               ,AFS.ApprovedAmount\r\n               ,AFS.CreatedBy\r\n               ,AFS.CreatedOn\r\n               ,AFS.ModifiedBy\r\n               ,AFS.ModifiedOn\r\n\t\t\tFROM BudgetSurvey.AgencyFacilitySurvey AS AFS\r\n\t\t\t\tINNER JOIN BudgetSurvey.AgencyBudgetFacilitySurveyAttribute AS A ON A.FiscalYear = AFS.FiscalYear\r\n\t\tWHERE AFS.AgencyFacilitySurveyId = @AgencyFacilitySurveyId AND AFS.ActionTypeId = 3) AS R ON L.AgencyDivisionSeqid = R.AgencyDivisionSeqID\r\n\t\t\tAND L.FacilitySeqid = R.FacilitySeqId;\r\nEND;"
        }
      ]
    }
  ]
}