{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "USP_AgencyDashboard_UsageDemandDeviationCurrentVsPriorPeriod",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "USP_AgencyDashboard_UsageDemandDeviationCurrentVsPriorPeriod",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to analyze and report on the deviation in energy usage and demand for a specified agency between the current and prior billing periods. It calculates the percentage increase or decrease in energy usage and demand, normalizes these values based on billing period days, and identifies accounts that exceed specified thresholds for usage and demand deviations."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including data retrieval, temporary table usage, and complex calculations for deviation analysis. It also includes conditional logic for handling different scenarios in deviation calculations, making it moderately complex."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@agencyCode AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The code representing the agency for which the report is generated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@usageThreshold AS DECIMAL(6, 2) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The threshold percentage for usage deviation. Defaults to 25.00 if not provided."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@demandThreshold AS DECIMAL(6, 2) = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The threshold percentage for demand deviation. Defaults to 25.00 if not provided."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@debugMode AS BIT = NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A flag for enabling debug mode, though it is not utilized within the procedure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Sets "
                },
                {
                  "type": "text",
                  "text": "NOCOUNT ON",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to prevent extra result sets from interfering with SELECT statements."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to allow reading uncommitted data, which can reduce locking contention."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Defaults",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Sets default values for "
                },
                {
                  "type": "text",
                  "text": "@usageThreshold",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "@demandThreshold",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " if they are not provided."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Agency Hierarchy Retrieval",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieves the agency hierarchy using a user-defined function and stores it in a temporary table "
                },
                {
                  "type": "text",
                  "text": "#tmpAgencies",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period and Fiscal Year",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieves the latest published billing period and calculates the current fiscal year."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval for Current and Prior Periods",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Retrieves and stores account-level energy and demand usage data for the current and prior billing periods into temporary tables "
                },
                {
                  "type": "text",
                  "text": "#tmpCurrentPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "#tmpPriorPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Normalizes energy usage based on billing period days."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Deviation Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculates the percentage deviation in energy usage, normalized usage, and demand between the current and prior periods."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Stores the results in a temporary table "
                },
                {
                  "type": "text",
                  "text": "#tmpDeviation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Threshold Analysis and Reporting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Identifies accounts where the normalized usage or demand increase exceeds the specified thresholds."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregates and reports the count and percentage of such accounts by energy type."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Produces a result set with the agency code, billing period, category (USAGE or DEMAND), label, energy type, count of deviations, total count, and percentage of deviations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Use of NOLOCK",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "WITH (NOLOCK)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking contention but leads to reading uncommitted or inconsistent data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Tables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of temporary tables can impact performance, especially if the data volume is large. Indexing these tables improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complex Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure performs multiple calculations, which be optimized if performance issues arise."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Setting the isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance but at the risk of data inconsistency."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Consistency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "NOLOCK",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to dirty reads, which may result in reporting inaccurate data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Debug Mode",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "@debugMode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is defined but not used, which could lead to confusion or maintenance issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Period Adjustment",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The prior period calculation subtracts 100 from the current period, assuming a monthly format (e.g., YYYYMM). This could lead to errors if the format changes or if the billing periods are not strictly monthly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the use of temporary tables and complex joins may impact performance. Consider indexing or optimizing queries for large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or failures in production environments."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[USP_AgencyDashboard_UsageDemandDeviationCurrentVsPriorPeriod]\n(\r\n\t@agencyCode AS VARCHAR(6)\r\n\t,@usageThreshold AS DECIMAL(6, 2) = NULL\r\n\t,@demandThreshold AS DECIMAL(6, 2) = NULL\r\n\t,@debugMode AS BIT = NULL\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tSELECT @usageThreshold = ISNULL(@usageThreshold, 25.00), @demandThreshold = ISNULL(@demandThreshold, 25.00);\r\n\r\n\t-- Get the agency hierarchy\r\n\tSELECT AgencyCodeOEC INTO #tmpAgencies FROM [Billing].[UDF_GetAgencyHierarchy](@agencyCode);\r\n\r\n\t\r\n\tDECLARE @publishedBillingPeriod AS VARCHAR(6), @currentFY AS INT;\r\n\tSELECT @publishedBillingPeriod = MAX(PublishedBillingPeriod) FROM Published.MonthlyPublishedSummaryData WITH (NOLOCK);\r\n\tSELECT @currentFY = dbo.CalculateFiscalYear(@publishedBillingPeriod);\r\n\r\n\t-- Current Period\r\n\tSELECT ALRDCP.CurrentAccountNumber, ALRDCP.EnergyType\r\n\t\t,CONVERT(DECIMAL(18, 2), ISNULL(BillingPeriodDays, 0)) AS BillingPeriodDays\r\n\t\t,CONVERT(DECIMAL(18, 2), ISNULL(AccountEnergyUsage, 0)) AS AccountEnergyUsage\r\n\t\t,CASE\r\n\t\t\tWHEN ISNULL(BillingPeriodDays, 0) > 0 THEN\r\n\t\t\t\t((CONVERT(DECIMAL(18, 2), ISNULL(AccountEnergyUsage, 0)) * 30.00) / CONVERT(DECIMAL(18, 2), BillingPeriodDays))\r\n\t\t\tELSE CONVERT(DECIMAL(18, 2), 0.00) END AS AccountEnergyUsageNormalized\r\n\t\t,CONVERT(DECIMAL(18, 2), ISNULL(AccountDemandUsage, 0)) AS AccountDemandUsage\r\n\tINTO #tmpCurrentPeriod\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS ALRDCP WITH (NOLOCK)\r\n\t\tINNER JOIN #tmpAgencies AS TA ON TA.AgencyCodeOEC = ALRDCP.AgencyCodeOEC\r\n\tWHERE ALRDCP.EffectiveStartPeriod <= @PublishedBillingPeriod AND ALRDCP.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ALRDCP.BillingPeriod = @publishedBillingPeriod AND ISNULL(BillingPeriodDays, 0) > 0;\r\n\t\r\n\t-- Prior Period\r\n\tSELECT ALRDCP.CurrentAccountNumber, ALRDCP.EnergyType\r\n\t\t,CONVERT(DECIMAL(18, 2), ISNULL(BillingPeriodDays, 0)) AS BillingPeriodDays\r\n\t\t,CONVERT(DECIMAL(18, 2), ISNULL(AccountEnergyUsage, 0)) AS AccountEnergyUsage\r\n\t\t,CASE\r\n\t\t\tWHEN ISNULL(BillingPeriodDays, 0) > 0 THEN\r\n\t\t\t\t((CONVERT(DECIMAL(18, 2), ISNULL(AccountEnergyUsage, 0)) * 30.00) / CONVERT(DECIMAL(18, 2), BillingPeriodDays))\r\n\t\t\tELSE CONVERT(DECIMAL(18, 2), 0.00) END AS AccountEnergyUsageNormalized\r\n\t\t,CONVERT(DECIMAL(18, 2), ISNULL(AccountDemandUsage, 0)) AS AccountDemandUsage\r\n\tINTO #tmpPriorPeriod\r\n\tFROM Published.TemporalAccountLevelRawDataForCurrentPeriod AS ALRDCP WITH (NOLOCK)\r\n\t\tINNER JOIN #tmpAgencies TA ON TA.AgencyCodeOEC = ALRDCP.AgencyCodeOEC\r\n\tWHERE ALRDCP.EffectiveStartPeriod <= @PublishedBillingPeriod AND ALRDCP.EffectiveEndPeriod > @PublishedBillingPeriod\r\n\t\tAND ALRDCP.BillingPeriod = CONVERT(VARCHAR(6), (CONVERT(INT, @publishedBillingPeriod) - 100)) AND ISNULL(BillingPeriodDays, 0) > 0;\r\n\r\n\t-- Deviation statistics\r\n\tSELECT CurrentPeriod.CurrentAccountNumber, CurrentPeriod.EnergyType\r\n\t\t,CurrentPeriod.AccountEnergyUsage AS EnergyUsageCurrentPeriod\r\n\t\t\t,PriorPeriod.AccountEnergyUsage AS EnergyUsagePriorPeriod\r\n\t\t\t,CASE\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountEnergyUsage, 0.00) <> 0.00 AND ISNULL(CurrentPeriod.AccountEnergyUsage, 0.00) <> 0.00\r\n\t\t\t\t\tTHEN (((CurrentPeriod.AccountEnergyUsage - PriorPeriod.AccountEnergyUsage) * 100.00) / PriorPeriod.AccountEnergyUsage)\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountEnergyUsage, 0.00) <> 0.00 AND ISNULL(CurrentPeriod.AccountEnergyUsage, 0.00) = 0.00\r\n\t\t\t\t\tTHEN -100.00\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountEnergyUsage, 0.00) = 0.00 AND ISNULL(CurrentPeriod.AccountEnergyUsage, 0.00) <> 0.00\r\n\t\t\t\t\tTHEN 100.00\r\n\t\t\t\tELSE 0.00 END AS UsageIncrease\r\n\t\t,CurrentPeriod.AccountEnergyUsageNormalized AS EnergyUsageNormalizedCurrentPeriod\r\n\t\t\t,PriorPeriod.AccountEnergyUsageNormalized AS EnergyUsageNormalizedPriorPeriod\r\n\t\t\t,CASE\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountEnergyUsageNormalized, 0.00) <> 0.00 AND ISNULL(CurrentPeriod.AccountEnergyUsageNormalized, 0.00) <> 0.00\r\n\t\t\t\t\tTHEN (((CurrentPeriod.AccountEnergyUsageNormalized - PriorPeriod.AccountEnergyUsageNormalized) * 100.00) / PriorPeriod.AccountEnergyUsageNormalized)\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountEnergyUsageNormalized, 0.00) <> 0.00 AND ISNULL(CurrentPeriod.AccountEnergyUsageNormalized, 0.00) = 0.00\r\n\t\t\t\t\tTHEN -100.00\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountEnergyUsageNormalized, 0.00) = 0.00 AND ISNULL(CurrentPeriod.AccountEnergyUsageNormalized, 0.00) <> 0.00\r\n\t\t\t\t\tTHEN 100.00\r\n\t\t\t\tELSE 0.00 END AS NormalizedUsageIncrease\r\n\t\t,CurrentPeriod.AccountDemandUsage AS DemandUsageCurrentPeriod\r\n\t\t\t,PriorPeriod.AccountDemandUsage AS DemandUsagePriorPeriod\r\n\t\t\t,CASE\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountDemandUsage, 0.00) <> 0.00 AND ISNULL(CurrentPeriod.AccountDemandUsage, 0.00) <> 0.00\r\n\t\t\t\t\tTHEN (((CurrentPeriod.AccountDemandUsage - PriorPeriod.AccountDemandUsage) * 100.00) / PriorPeriod.AccountDemandUsage)\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountDemandUsage, 0.00) <> 0.00 AND ISNULL(CurrentPeriod.AccountDemandUsage, 0.00) = 0.00\r\n\t\t\t\t\tTHEN -100.00\r\n\t\t\t\tWHEN ISNULL(PriorPeriod.AccountDemandUsage, 0.00) = 0.00 AND ISNULL(CurrentPeriod.AccountDemandUsage, 0.00) <> 0.00\r\n\t\t\t\t\tTHEN 100.00\r\n\t\t\t\tELSE 0.00 END AS DemandIncrease\r\n\tINTO #tmpDeviation\r\n\tFROM #tmpCurrentPeriod CurrentPeriod\r\n\t\tINNER JOIN #tmpPriorPeriod PriorPeriod ON PriorPeriod.CurrentAccountNumber = CurrentPeriod.CurrentAccountNumber\r\n\t\t\tAND PriorPeriod.EnergyType = CurrentPeriod.EnergyType;\r\n\t\r\n\tSELECT @agencyCode AS AgencyCodeOEC\r\n\t\t,@publishedBillingPeriod AS BillingPeriod\r\n\t\t,'USAGE' AS Category\r\n\t\t,'Exceed Threshold' AS Label\r\n\t\t,A.EnergyType\r\n\t\t,CONVERT(DECIMAL(18, 2), COUNT(A.EnergyType)) AS [Count]\r\n\t\t,CONVERT(DECIMAL(18, 2), (SELECT COUNT(1) FROM #tmpDeviation WHERE EnergyType = A.EnergyType)) AS TotalCount\r\n\t\t,ROUND(((COUNT(A.EnergyType) * 100.00) / (SELECT COUNT(1) FROM #tmpDeviation WHERE EnergyType = A.EnergyType)), 0) AS [Percentage]\r\n\tFROM #tmpDeviation A\r\n\tWHERE A.NormalizedUsageIncrease >= @usageThreshold\r\n\tGROUP BY A.EnergyType\r\n\tUNION\r\n\tSELECT @agencyCode AS AgencyCodeOEC\r\n\t\t,@publishedBillingPeriod AS BillingPeriod\r\n\t\t,'DEMAND' AS Category\r\n\t\t,'Exceed Threshold' AS Label\r\n\t\t,B.EnergyType\r\n\t\t,CONVERT(DECIMAL(18, 2), COUNT(B.EnergyType)) AS [Count]\r\n\t\t,CONVERT(DECIMAL(18, 2), (SELECT COUNT(1) FROM #tmpDeviation WHERE EnergyType = B.EnergyType)) AS TotalCount\r\n\t\t,ROUND(((COUNT(B.EnergyType) * 100.00) / (SELECT COUNT(1) FROM #tmpDeviation WHERE EnergyType = B.EnergyType)), 0) AS [Percentage]\r\n\tFROM #tmpDeviation B\r\n\tWHERE B.DemandIncrease >= @demandThreshold\r\n\tGROUP BY B.EnergyType\r\n\tORDER BY Category ASC, EnergyType ASC;\r\nEND;"
        }
      ]
    }
  ]
}