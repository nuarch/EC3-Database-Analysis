{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Budget",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Report_BudgetVersusYearToDateUsageAndRateBreakDownAgencyLevel",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Report_BudgetVersusYearToDateUsageAndRateBreakDownAgencyLevel",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report comparing budgeted versus actual energy usage and expenditure at the agency level. It processes data for a specified billing period, calculates various financial metrics, and organizes the results into a structured format for reporting. The procedure handles special cases, such as excluding certain state funds and adjusting budgeted quantities accordingly."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure is complex due to its multiple steps, including data aggregation, conditional logic, updates, and hierarchical data processing. It involves several calculations and joins, making it intricate and requiring careful management of data flow and logic."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Used to filter or join data related to the user's email address, likely for security or personalization."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the agency code, used to filter data specific to an agency."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Specifies the billing period for which the report is generated, serving as a temporal filter for data selection."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Sets the information group level and calculates the fiscal year start period using a helper function "
                },
                {
                  "type": "text",
                  "text": "dbo.CreateFiscalYearPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Inserts aggregated agency data into a table variable "
                },
                {
                  "type": "text",
                  "text": "@AgencyData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " by joining with a user-defined function "
                },
                {
                  "type": "text",
                  "text": "uftn_BudgetAgencyDivision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and filtering by the billing period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Special Case Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Adjusts data for specific agency codes ('856090' and '856001') by reallocating budgeted quantities and removing certain entries."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Updates "
                },
                {
                  "type": "text",
                  "text": "@AgencyData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with calculated rates ("
                },
                {
                  "type": "text",
                  "text": "BudgetRate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "ActualRate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") and surpluses ("
                },
                {
                  "type": "text",
                  "text": "TotalSurplus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "CurrentMonthSurplus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "RateSurplus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "UsageSurplus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "CombinedSurplus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") using custom functions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Result Compilation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Inserts processed data into "
                },
                {
                  "type": "text",
                  "text": "@QueryResult",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " based on the information group level, filtering out hidden entries."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hierarchical Data Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Iteratively updates surplus values in "
                },
                {
                  "type": "text",
                  "text": "@QueryResult",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to account for hierarchical relationships in expenditure types."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Selects and orders the final result set for reporting."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Table Variables",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of table variables ("
                },
                {
                  "type": "text",
                  "text": "@AgencyData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "@QueryResult",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") can impact performance, especially with large datasets, as they reside in memory and do not benefit from indexing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Aggregations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Multiple joins and aggregations can be resource-intensive, particularly if the underlying tables are large or lack proper indexing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Iterative Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The loop for hierarchical data processing may lead to performance bottlenecks if the hierarchy is deep or the data set is large."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure may not scale well with increasing data volume due to reliance on in-memory table variables and iterative processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in "
                },
                {
                  "type": "text",
                  "text": "Budget.BudgetVersusActualExpendituresByAgencyAndServiceClassification",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and related tables is accurate and complete. Any discrepancies could lead to incorrect calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple instances of this procedure run simultaneously, there could be contention for resources, especially if the underlying tables are heavily accessed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or incomplete processing in case of data anomalies or runtime errors."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [Budget].[usp_Report_BudgetVersusYearToDateUsageAndRateBreakDownAgencyLevel]\r\n\t@EmailAddress emailaddr,\r\n\t@AgencyCodeOEC VARCHAR(MAX),\r\n\t@BillingPeriod BillingPeriod\r\nAS\r\nBEGIN\r\n\t\r\n\tDECLARE @InformationGroupLevel INT\r\n  SET @InformationGroupLevel = 3  \r\n\r\n\r\n\r\n\tDECLARE @FiscalYearBegin BillingPeriod\r\n\tSET @FiscalYearBegin = dbo.CreateFiscalYearPeriod(@BillingPeriod, 'S')\r\n\tDECLARE @AgencyData TABLE\r\n\t (\r\n\t\tAgencyCodeOEC AgencyCodeOEC,\r\n\t\tAgencyName ldesc,\r\n\t\tCurrentMonthBudgetEnergyUsage FLOAT ,\r\n\t\tCurrentMonthBudgetEnergyDollars MONEY,\r\n\t\tCurrentMonthActualDollars MONEY,\r\n\t\tCurrentMonthActualUsage float,\r\n\t\tIsSourceOfFundingGroupData VARCHAR(1),\r\n\t\tBudgetVersusExpenditureTypeSeqID INT,\r\n\t\tCurrentMonthPaidAdjustment MONEY,\r\n\t\tIsHidden VARCHAR(1),\r\n\t\tBudgetRate FLOAT,\r\n\t\tActualRate FLOAT,\r\n\t\tTotalSurplus MONEY,\r\n\t\tAdjustmentSurplus MONEY,\r\n\t\tCurrentMonthSurplus FLOAT,\r\n\t\tRateSurplus FLOAT,\r\n\t\tUsageSurplus FLOAT,\r\n\t\tCombinedSurplus FLOAT,\r\n\t\tAgencyFundingSeqID int\r\n\t )\t\r\n\r\n\tDECLARE @QueryResult TABLE\r\n\t(\t\r\n\t\tGroupDescription VARCHAR(75),\r\n\t\texpenditureTypeID INT,\r\n\t\texpenditureType VARCHAR(75) ,\r\n\t\tCurrentMonthBudgetEnergyUsage int ,\r\n\t\tCurrentMonthBudgetEnergyDollars MONEY,\r\n\t\tCurrentMonthActualDollars MONEY,\r\n\t\tCurrentMonthActualUsage int,\r\n\t\tBudgetRate FLOAT,\r\n\t\tActualRate FLOAT,\r\n\t\tTotalSurplus MONEY,\r\n\t\tAdjustmentSurplus MONEY,\r\n\t\tCurrentMonthSurplus FLOAT,\r\n\t\tRateSurplus FLOAT,\r\n\t\tUsageSurplus FLOAT,\r\n\t\tCombinedSurplus FLOAT,\r\n\t\tIngoreEnergySum VARCHAR(1),\r\n\t\tInformationLevel int -- 1:citywide;2:funding source;3:agency\r\n\t)\r\n\r\n\t\r\n\t/*\r\n\t1. insert agency data into table variable\r\n\t2. handle special case\r\n\t3. insert data into final result table\r\n\t*/\r\n\t-- 1. insert agency data into table variable\r\n\r\n\t\r\n\t\tINSERT INTO @AgencyData\r\n\t\t( \r\n\t\t\tAgencyCodeOEC ,\r\n\t\t\tAgencyName ,\r\n\t\t\tCurrentMonthBudgetEnergyUsage  ,\r\n\t\t\tCurrentMonthBudgetEnergyDollars ,\r\n\t\t\tCurrentMonthActualDollars ,\r\n\t\t\tCurrentMonthActualUsage ,\r\n\t\t\tIsSourceOfFundingGroupData,\r\n\t\t\tBudgetVersusExpenditureTypeSeqID,\r\n\t\t\tCurrentMonthPaidAdjustment,\r\n\t\t\tIsHidden,\r\n\t\t\tAdjustmentSurplus,\r\n\t\t\tAgencyFundingSeqID\r\n\t\t)\r\n\t\tSELECT  budgetsummary.AgencyCodeOEC ,\r\n\t\t\t\tAgencyName ,\r\n\t\t\t\tSUM(CurrentMonthBudgetEnergyUsage)  ,\r\n\t\t\t\tSUM(CurrentMonthBudgetEnergyDollars) ,\r\n\t\t\t\tSUM(CurrentMonthActualDollars) ,\r\n\t\t\t\tSUM(CurrentMonthActualUsage) ,\r\n\t\t\t\tnull,\r\n\t\t\t\tbudgetsummary.BudgetVersusExpenditureTypeSeqID ,\r\n\t\t\t\tSUM(CurrentMonthPaidAdjustment),\r\n\t\t\t\tIsHidden,\t\t\r\n\t\t\t\tSUM(AdjustmentSurplus),\r\n\t\t\t\tAgencyFundingSeqid\r\n\t\tFROM Budget.BudgetVersusActualExpendituresByAgencyAndServiceClassification budgetsummary\r\n\t\t\t\tLEFT JOIN [Budget].[uftn_BudgetAgencyDivision](@EmailAddress,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t@AgencyCodeOEC, 'N')\r\n\t\t\t\tAS BudgetAgencyDivision ON budgetsummary.AgencyCodeOEC = BudgetAgencyDivision.AgencyCodeOEC\r\n\t\tWHERE   BillingPeriod BETWEEN @FiscalYearBegin AND @BillingPeriod\r\n\t\tGROUP BY budgetsummary.AgencyCodeOEC ,\r\n\t\t\t\tAgencyName ,\r\n\t\t\t\tbudgetsummary.BudgetVersusExpenditureTypeSeqID,\r\n\t\t\t\tIsHidden,\r\n\t\t\t\tAgencyFundingSeqid\r\n\r\n\t-- 2. handle special case\r\n\r\n\t/*\r\n\tState Funds should be excluded from this report.\r\n\tThe budgeted quantities for State Funds should be added to 856001.\r\n\t*/\r\n\tUPDATE  data856001\r\n\tSET     CurrentMonthBudgetEnergyUsage = ISNULL(CurrentMonthBudgetEnergyUsage, 0)\r\n\t\t\t+ ( SELECT  ISNULL(SUM(CurrentMonthBudgetEnergyUsage), 0)\r\n\t\t\t\tFROM @AgencyData AS data856090\r\n\t\t\t\tWHERE   AgencyCodeOEC = '856090'\r\n\t\t\t\t\t\tAND data856090.BudgetVersusExpenditureTypeSeqID = data856001.BudgetVersusExpenditureTypeSeqID\r\n\t\t\t  ),\r\n\t\t\tCurrentMonthBudgetEnergyDollars = ISNULL(CurrentMonthBudgetEnergyDollars, 0)\r\n\t\t\t+ ( SELECT  ISNULL(SUM(CurrentMonthBudgetEnergyDollars), 0)\r\n\t\t\t\tFROM @AgencyData AS data856090\r\n\t\t\t\tWHERE   AgencyCodeOEC = '856090'\r\n\t\t\t\t\t\tAND data856090.BudgetVersusExpenditureTypeSeqID = data856001.BudgetVersusExpenditureTypeSeqID\r\n\t\t\t  )\r\n\tFROM @AgencyData AS data856001\r\n\tWHERE   data856001.AgencyCodeOEC = '856001'\r\n\t\r\n\tDELETE @AgencyData WHERE AgencyCodeOEC = '856090'\r\n\t\r\n\t\r\n\tUPDATE @AgencyData\r\n\tSET BudgetRate = budget.CalcBudgetRate(CurrentMonthBudgetEnergyDollars, CurrentMonthBudgetEnergyUsage),\r\n\t\tActualRate = budget.CalcActualRate(CurrentMonthActualDollars, CurrentMonthPaidAdjustment,  CurrentMonthActualUsage),\r\n\t\tTotalSurplus = ISNULL(CurrentMonthBudgetEnergyDollars, 0) - ISNULL(CurrentMonthActualDollars, 0)\r\n\r\n\t\r\n\tUPDATE @AgencyData\r\n\tSET CurrentMonthSurplus = TotalSurplus - AdjustmentSurplus\r\n\t\r\n\tUPDATE \t@AgencyData\r\n\tSET RateSurplus = budget.CalcBudgetRateSurplus(BudgetRate, ActualRate, CurrentMonthBudgetEnergyUsage),\r\n\t\tUsageSurplus = budget.CalcBudgetUsageSurplus(CurrentMonthBudgetEnergyUsage, CurrentMonthActualUsage, BudgetRate)\r\n\r\n\t\r\n\tUPDATE \t@AgencyData\r\n\tSET CombinedSurplus = CurrentMonthSurplus - (RateSurplus + UsageSurplus)\r\n\r\n\t\r\n\r\n\t\r\n\r\n\t--/*\r\n\t--\tgroup by agency\r\n\t--*/\r\n\tIF(@InformationGroupLevel = 3)\r\n\tBEGIN\r\n\t\tINSERT INTO @QueryResult\r\n\t\t\t\t( GroupDescription ,\r\n\t\t\t\t  expenditureTypeID,\r\n\t\t\t\t  expenditureType ,\r\n\t\t\t\t  CurrentMonthBudgetEnergyUsage ,\r\n\t\t\t\t  CurrentMonthBudgetEnergyDollars ,\r\n\t\t\t\t  CurrentMonthActualDollars ,\r\n\t\t\t\t  CurrentMonthActualUsage ,\r\n\t\t\t\t  BudgetRate ,\r\n\t\t\t\t  ActualRate ,\r\n\t\t\t\t  TotalSurplus ,\r\n\t\t\t\t  AdjustmentSurplus ,\r\n\t\t\t\t  CurrentMonthSurplus ,\r\n\t\t\t\t  RateSurplus ,\r\n\t\t\t\t  UsageSurplus ,\r\n\t\t\t\t  CombinedSurplus ,\r\n\t\t\t\t  IngoreEnergySum,\r\n\t\t\t\t  InformationLevel\r\n\t\t\t\t)\t\r\n\t\tSELECT  \r\n\t\t\tbudgetsummary.AgencyCodeOEC + '-' + budgetsummary.agencyname,\r\n\t\t\texpenditureTypee.BudgetVersusExpenditureTypeSeqid,\r\n\t\t\texpenditureTypee.Description expenditureType ,\r\n\t\t\tCurrentMonthBudgetEnergyUsage ,\r\n\t\t\tCurrentMonthBudgetEnergyDollars ,\r\n\t\t\tCurrentMonthActualDollars ,\r\n\t\t\tCurrentMonthActualUsage ,\r\n\t\t\tBudgetRate ,\r\n\t\t\tActualRate ,\r\n\t\t\tTotalSurplus ,\r\n\t\t\tAdjustmentSurplus ,\r\n\t\t\tCurrentMonthSurplus ,\r\n\t\t\tRateSurplus ,\r\n\t\t\tUsageSurplus ,\r\n\t\t\tCombinedSurplus,\r\n\t\t\texpenditureTypee.IngoreEnergySum,\r\n\t\t\t3\r\n\t\tFROM @AgencyData budgetsummary\r\n\t\t\t\tINNER JOIN Budget.BudgetVersusExpenditureType expenditureTypee ON budgetsummary.BudgetVersusExpenditureTypeSeqID = expenditureTypee.BudgetVersusExpenditureTypeSeqid\r\n\t\tWHERE budgetsummary.IsHidden = 'N' AND expenditureTypee.isHidden = 'N'\r\n\t\tORDER BY DisplayOrderIndex\r\n\tEND\r\n\r\n\r\n\tDECLARE @Level INT = 4\r\n\tWHILE(@Level > 1)\r\n\tBEGIN\r\n\t\tUPDATE BAData\r\n\t\tSET BAData.UsageSurplus = childTotal.UsageSurplus,\r\n\t\t\tBAData.RateSurplus = childTotal.RateSurplus,\r\n\t\t\tBAData.CombinedSurplus = childTotal.CombinedSurplus,\r\n\t\t\tBAData.AdjustmentSurplus = childTotal.AdjustmentSurplus,\r\n\t\t\tBAData.TotalSurplus = childTotal.TotalSurplus\r\n\t\tFROM \r\n\t\t@QueryResult AS BAData \r\n\t\tINNER JOIN Budget.BudgetVersusExpenditureType AS parentType\r\n\t\tON BAData.expenditureTypeID = parentType.BudgetVersusExpenditureTypeSeqID\r\n\t\tINNER JOIN \t\r\n\t\t(\r\n\t\t\tSELECT \r\n\t\t\tSUM(childData.UsageSurplus) UsageSurplus,\r\n\t\t\tSUM(childData.RateSurplus) RateSurplus,\r\n\t\t\tSUM(childData.CombinedSurplus) CombinedSurplus,\r\n\t\t\tSUM(childData.AdjustmentSurplus) AdjustmentSurplus,\r\n\t\t\tSUM(childData.TotalSurplus) TotalSurplus,\r\n\t\t\tchildData.GroupDescription,\r\n\t\t\tchildType.ParentExpenditureTypeID AS expenditureTypeID\r\n\t\t\tFROM @QueryResult AS childData \r\n\t\t\tINNER JOIN Budget.BudgetVersusExpenditureType AS childType\r\n\t\t\tON childData.expenditureTypeID = childType.BudgetVersusExpenditureTypeSeqID\r\n\t\t\tAND childType.HierarchyLevel = @Level\r\n\t\t\tGROUP BY childData.GroupDescription, childType.ParentExpenditureTypeID\r\n\t\t) AS childTotal\r\n\t\tON \r\n\t\tBAData.GroupDescription = childTotal.GroupDescription\r\n\t\tAND \r\n\t\tBADATa.expenditureTypeID = childTotal.expenditureTypeID\r\n\t\t\r\n\t\tSET @Level = @Level -1\r\n\tEND\r\n\r\n\tSELECT * FROM @QueryResult  budgetsummary\r\n\tINNER JOIN Budget.BudgetVersusExpenditureType expenditureTypee ON budgetsummary.expenditureTypeID = expenditureTypee.BudgetVersusExpenditureTypeSeqid\r\n\tORDER BY budgetsummary.GroupDescription, DisplayOrderIndex\t\r\nEND"
        }
      ]
    }
  ]
}