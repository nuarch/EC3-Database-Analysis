{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Lookup_AccountMonthlySummary",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Lookup_AccountMonthlySummary",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a monthly summary report of billing data for a specified account number. It retrieves and processes data related to energy usage, demand, and billed amounts over the past three fiscal years for the given account. The procedure aggregates this data by fiscal year and energy type, and formats it for output."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentAccountNumber AS acctnum",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter represents the account number for which the monthly summary report is to be generated. It is used to identify the current account number in the database and retrieve relevant billing data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initial Setup",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by setting "
                },
                {
                  "type": "text",
                  "text": "NOCOUNT ON",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to prevent the message indicating the number of rows affected by a SQL statement from being returned."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The transaction isolation level is set to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to allow dirty reads, which can improve performance by not acquiring locks."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine Published Billing Period",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure retrieves the latest published billing period from the "
                },
                {
                  "type": "text",
                  "text": "Published.MonthlyPublishedSummaryData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Resolve Current Account Number",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It updates the "
                },
                {
                  "type": "text",
                  "text": "@CurrentAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to the latest current account number from the "
                },
                {
                  "type": "text",
                  "text": "Billing.Account",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table where the original account number matches the input parameter and the record is marked as current."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determine Latest Fiscal Year with Billing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure finds the latest fiscal year with billing data for the current account number from the "
                },
                {
                  "type": "text",
                  "text": "Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Aggregation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "An in-memory table "
                },
                {
                  "type": "text",
                  "text": "@AccountBillingSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is created to store the aggregated billing data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Three separate "
                },
                {
                  "type": "text",
                  "text": "INSERT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " operations populate this table:"
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Energy Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Aggregates energy usage data by fiscal year and energy type (Electricity, Gas, Steam)."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Electricity Demand (KW)",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Aggregates electricity demand data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Revised Billed Amounts",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Aggregates revised billed dollar amounts."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Cleaning",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure updates the "
                },
                {
                  "type": "text",
                  "text": "@AccountBillingSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table to replace zero values with "
                },
                {
                  "type": "text",
                  "text": "NULL",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " for each month, which can help in reporting by avoiding misleading zero values."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output Formatting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The final "
                },
                {
                  "type": "text",
                  "text": "SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statement retrieves data from "
                },
                {
                  "type": "text",
                  "text": "@AccountBillingSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", formatting numeric values as strings for certain record types to ensure consistent output formatting."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This can improve performance by reducing locking overhead but leads to reading uncommitted or dirty data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregation and Grouping",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "GROUP BY",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "SUM",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " functions can be resource-intensive, especially if the underlying tables are large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "In-Memory Table",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a table variable ("
                },
                {
                  "type": "text",
                  "text": "@AccountBillingSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") is efficient for temporary storage but not perform well with very large datasets compared to temporary tables."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level can lead to inconsistencies if the data is being modified concurrently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the "
                },
                {
                  "type": "text",
                  "text": "CurrentAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "PublishedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " are correctly resolved, which may not always be the case if the underlying data is inconsistent."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure's performance may degrade with large datasets due to multiple aggregations and the use of a table variable."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or incomplete operations in case of failures."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_Lookup_AccountMonthlySummary]\n(\r\n\t@CurrentAccountNumber AS acctnum\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRAN ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @PublishedBillingPeriod AS BillingPeriod;\r\n\tSELECT @PublishedBillingPeriod = MAX(publishedbillingPeriod) FROM Published.MonthlyPublishedSummaryData;\r\n\r\n\tSELECT @CurrentAccountNumber = MAX(CurrentAccountNumber) FROM Billing.Account WHERE OriginalAccountNumber = @CurrentAccountNumber AND IsCurrentRecord = 'Y';\r\n\r\n\t-- Changed the query to get the fiscal year as max fiscal year for the currentaccountnumber\r\n\tDECLARE @LatestFiscalYearWithBilling AS INT;\r\n\tSELECT @LatestFiscalYearWithBilling = MAX(FiscalYear) FROM Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage\r\n\tWHERE CurrentAccountNumber = @CurrentAccountNumber AND EffectiveStartPeriod <= @PublishedBillingPeriod AND EffectiveEndPeriod > @PublishedBillingPeriod;\r\n\r\n\tDECLARE @AccountBillingSummary TABLE\r\n\t\t(fiscalYear VARCHAR(4) NULL,\r\n\t\trecordType INT NULL,\r\n\t\tunit VARCHAR(6) NULL,\r\n\t\tJuly DECIMAL(18, 2) NULL,\r\n\t\tAugust DECIMAL(18, 2) NULL,\r\n\t\tSeptember DECIMAL(18, 2) NULL,\r\n\t\tOctober DECIMAL(18, 2) NULL,\r\n\t\tNovember DECIMAL(18, 2) NULL,\r\n\t\tDecember DECIMAL(18, 2) NULL,\r\n\t\tJanuary DECIMAL(18, 2) NULL,\r\n\t\tFebruary DECIMAL(18, 2) NULL,\r\n\t\tMarch DECIMAL(18, 2) NULL,\r\n\t\tApril DECIMAL(18, 2) NULL,\r\n\t\tMay DECIMAL(18, 2) NULL,\r\n\t\tJune DECIMAL(18, 2) NULL)\r\n\r\n\t-- Energy usage:\r\n\tINSERT INTO @AccountBillingSummary\r\n\t\t(fiscalYear,\r\n\t\trecordType,\r\n\t\tunit,\r\n\t\tJuly,\r\n\t\tAugust,\r\n\t\tSeptember,\r\n\t\tOctober,\r\n\t\tNovember,\r\n\t\tDecember,\r\n\t\tJanuary,\r\n\t\tFebruary,\r\n\t\tMarch,\r\n\t\tApril,\r\n\t\tMay,\r\n\t\tJune)\r\n\tSELECT FiscalYear,\r\n\t\t1,\r\n\t\tCASE WHEN EnergyType = 'ELE' THEN 'kWh' \r\n\t\t\tWHEN EnergyType ='GAS' THEN 'THERMS' \r\n\t\t\tWHEN EnergyType ='STM' THEN 'MLbs' END,\r\n\t\tSUM(JulyRevisedEnergy),\r\n\t\tSUM(AugustRevisedEnergy),\r\n\t\tSUM(SeptemberRevisedEnergy),\r\n\t\tSUM(OctoberRevisedEnergy),\r\n\t\tSUM(NovemberRevisedEnergy),\r\n\t\tSUM(DecemberRevisedEnergy),\r\n\t\tSUM(JanuaryRevisedEnergy),\r\n\t\tSUM(FebruaryRevisedEnergy),\r\n\t\tSUM(MarchRevisedEnergy),\r\n\t\tSUM(AprilRevisedEnergy),\r\n\t\tSUM(MayRevisedEnergy),\r\n\t\tSUM(JuneRevisedEnergy)         \r\n\tFROM Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage\r\n\tWHERE CurrentAccountNumber = @CurrentAccountNumber AND CAST(FiscalYear AS INT) > @LatestFiscalYearWithBilling - 3\r\n\t\tAND EffectiveStartPeriod <= @PublishedBillingPeriod AND EffectiveEndPeriod > @PublishedBillingPeriod\r\n\tGROUP BY FiscalYear, EnergyType\r\n\tORDER BY FiscalYear;\r\n\r\n\t-- ELE KW\r\n\tINSERT INTO @AccountBillingSummary\r\n\t\t(fiscalYear,\r\n        recordType,\r\n\t\tunit,\r\n\t\tJuly,\r\n\t\tAugust,\r\n\t\tSeptember,\r\n\t\tOctober,\r\n\t\tNovember,\r\n\t\tDecember,\r\n\t\tJanuary,\r\n\t\tFebruary,\r\n\t\tMarch,\r\n\t\tApril,\r\n\t\tMay,\r\n\t\tJune)\r\n\tSELECT FiscalYear,\r\n\t\t2,\r\n        'KW',\r\n\t\tSUM(JulyRevisedDemand) ,\r\n        SUM(AugustRevisedDemand) ,\r\n        SUM(SeptemberRevisedDemand) ,\r\n        SUM(OctoberRevisedDemand) ,\r\n        SUM(NovemberRevisedDemand) ,\r\n        SUM(DecemberRevisedDemand) ,\r\n        SUM(JanuaryRevisedDemand) ,\r\n        SUM(FebruaryRevisedDemand) ,\r\n        SUM(MarchRevisedDemand) ,\r\n        SUM(AprilRevisedDemand) ,\r\n        SUM(MayRevisedDemand) ,\r\n        SUM(JuneRevisedDemand)\r\n\tFROM Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage\r\n\tWHERE CurrentAccountNumber = @CurrentAccountNumber AND CAST(FiscalYear AS INT) > @LatestFiscalYearWithBilling - 3\r\n        AND EffectiveStartPeriod <= @PublishedBillingPeriod AND EffectiveEndPeriod > @PublishedBillingPeriod AND EnergyType = 'ELE'\r\n\tGROUP BY FiscalYear\r\n\tORDER BY FiscalYear;\r\n\r\n\t-- revised amount\r\n\tINSERT INTO @AccountBillingSummary\r\n\t\t(fiscalYear,\r\n\t\trecordType,\r\n        unit,\r\n        July,\r\n        August,\r\n        September,\r\n        October,\r\n        November,\r\n        December,\r\n        January,\r\n        February,\r\n        March,\r\n        April,\r\n        May,\r\n        June)\r\n\tSELECT FiscalYear,\r\n\t\t3,\r\n        '$$$',\r\n\t\tSUM(JulyRevisedBilledDollars) ,\r\n        SUM(AugustRevisedBilledDollars) ,\r\n        SUM(SeptemberRevisedBilledDollars) ,\r\n        SUM(OctoberRevisedBilledDollars) ,\r\n        SUM(NovemberRevisedBilledDollars) ,\r\n        SUM(DecemberRevisedBilledDollars) ,\r\n        SUM(JanuaryRevisedBilledDollars) ,\r\n        SUM(FebruaryRevisedBilledDollars) ,\r\n        SUM(MarchRevisedBilledDollars) ,\r\n        SUM(AprilRevisedBilledDollars) ,\r\n        SUM(MayRevisedBilledDollars) ,\r\n        SUM(JuneRevisedBilledDollars)\r\n\tFROM Published.TemporalFiscalYearPivotByAgencyFacilityAndAccountDollarsAndUsage\r\n\tWHERE CurrentAccountNumber = @CurrentAccountNumber AND CAST(FiscalYear AS INT) > @LatestFiscalYearWithBilling - 3\r\n\t\tAND EffectiveStartPeriod <= @PublishedBillingPeriod AND EffectiveEndPeriod > @PublishedBillingPeriod\r\n\tGROUP BY FiscalYear\r\n\tORDER BY FiscalYear;\r\n\r\n\tUPDATE @AccountBillingSummary \r\n\t\tSET July = CASE WHEN July = 0 THEN NULL ELSE July END\r\n\t\t,August = CASE WHEN August = 0 THEN NULL ELSE August END\r\n\t\t,September = CASE WHEN September = 0 THEN NULL ELSE September END\r\n\t\t,October = CASE WHEN October = 0 THEN NULL ELSE October END\r\n\t\t,November = CASE WHEN November = 0 THEN NULL ELSE November END\r\n\t\t,December = CASE WHEN December = 0 THEN NULL ELSE December END\r\n\t\t,January = CASE WHEN January = 0 THEN NULL ELSE January END\r\n\t\t,February = CASE WHEN February = 0 THEN NULL ELSE February END\r\n\t\t,March = CASE WHEN March = 0 THEN NULL ELSE March END\r\n\t\t,April = CASE WHEN April = 0 THEN NULL ELSE April END\r\n\t\t,May = CASE WHEN May = 0 THEN NULL ELSE May END\r\n\t\t,June = CASE WHEN June = 0 THEN NULL ELSE June END;\r\n\r\n\tSELECT fiscalYear,\r\n        recordType,\r\n        unit,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(July AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(July, 21, 0)) END AS July,\r\n\t\tCASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(August AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(August, 21, 0)) END AS August,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(September AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(September, 21, 0)) END AS September,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(October AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(October, 21, 0)) END AS October,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(November AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(November, 21, 0)) END AS November,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(December AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(December, 21, 0)) END AS December,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(January AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(January, 21, 0)) END AS January,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(February AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(February, 21, 0)) END AS February,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(March AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(March, 21, 0)) END AS March,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(April AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(April, 21, 0)) END AS April,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(May AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(May, 21, 0)) END AS May,\r\n        CASE WHEN recordType IN (2, 3) THEN LTRIM(CAST(CAST(June AS DECIMAL(18, 2)) AS VARCHAR(21))) ELSE LTRIM(STR(June, 21, 0)) END AS June\r\n\tFROM @AccountBillingSummary;\r\nEND;"
        }
      ]
    }
  ]
}