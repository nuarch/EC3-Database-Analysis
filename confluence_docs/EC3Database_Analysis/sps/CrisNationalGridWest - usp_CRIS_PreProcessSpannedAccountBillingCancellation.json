{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_CRIS_PreProcessSpannedAccountBillingCancellation",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_CRIS_PreProcessSpannedAccountBillingCancellation",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to handle the preprocessing of spanned account billing cancellations for a utility company. It involves moving, parsing, and adjusting billing data related to spanned billing periods. The procedure interacts with several tables within the "
        },
        {
          "type": "text",
          "text": "CrisNationalGridWest",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " schema, primarily focusing on records marked as spanned billing and those with specific transaction codes."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including data insertion, execution of another stored procedure, and data truncation. It handles complex business logic related to billing data processing, making it moderately complex. The use of multiple tables and the need for careful data handling contribute to this complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period for which the procedure is being executed. It is used to filter and process records relevant to this specific period."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@authenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the ID of the authenticated user executing the procedure. This is used for logging and tracking purposes within the data processing."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A utility code is set to '2', though it is not used further in the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Movement",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Spanned billing records are inserted into the "
                },
                {
                  "type": "text",
                  "text": "UploadCrisTempCancellationAccountBillingSpannedSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table from "
                },
                {
                  "type": "text",
                  "text": "UploadAccountBillingDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " where "
                },
                {
                  "type": "text",
                  "text": "IsSpannedBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'Y', "
                },
                {
                  "type": "text",
                  "text": "ExcludeAndReview",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'N', and "
                },
                {
                  "type": "text",
                  "text": "TransactionCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'BC'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "A message is printed indicating the number of rows inserted."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parsing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure calls another stored procedure "
                },
                {
                  "type": "text",
                  "text": "usp_CRIS_PreProcessParsingSpannedAccountInfoCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to parse the spanned account information."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Truncation and Reinsertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The "
                },
                {
                  "type": "text",
                  "text": "UploadCrisTempCancellationAccountBillingSpannedSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is truncated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Non-spanned billing records are reinserted into the same table from "
                },
                {
                  "type": "text",
                  "text": "UploadAccountBillingDetail",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " where "
                },
                {
                  "type": "text",
                  "text": "IsSpannedBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'N', "
                },
                {
                  "type": "text",
                  "text": "ExcludeAndReview",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'N', and "
                },
                {
                  "type": "text",
                  "text": "TransactionCode",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is 'BC'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "A message is printed indicating the number of rows inserted."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Adjustment Table Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data from "
                },
                {
                  "type": "text",
                  "text": "UploadCrisTempCancellationAccountBillingSpannedSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is inserted into "
                },
                {
                  "type": "text",
                  "text": "UploadAccountBillingAdjustmentCrisGasTempCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", with some fields being set to specific values (e.g., "
                },
                {
                  "type": "text",
                  "text": "AccountBillingStatus",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to 'AC')."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "A message is printed indicating the number of rows inserted."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Count",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The total count of rows in "
                },
                {
                  "type": "text",
                  "text": "UploadAccountBillingAdjustmentCrisGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is printed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Volume",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple insert operations, which can be resource-intensive if the tables contain a large number of records."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Truncation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "TRUNCATE TABLE",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is efficient for clearing data but requires careful handling to avoid data loss."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not include explicit transaction management, which leads to issues in a high-concurrency environment."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves truncating and reinserting data, which could lead to data loss if not handled correctly."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no explicit error handling, which could result in unhandled exceptions and incomplete data processing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure uses hardcoded values (e.g., 'Y', 'N', 'BC'), which could lead to maintenance challenges if business rules change."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dependency on External Procedure",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure relies on another stored procedure ("
                },
                {
                  "type": "text",
                  "text": "usp_CRIS_PreProcessParsingSpannedAccountInfoCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "), which could introduce dependencies and potential points of failure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [CrisNationalGridWest].[usp_CRIS_PreProcessSpannedAccountBillingCancellation]\r\n\t@BillingPeriod varchar(6),@authenticatedID int\r\n\t\r\nAS\r\n\r\nBEGIN\r\n\r\ndeclare @utilityCode varchar(1)\r\nset @utilityCode = '2'\r\n\r\n\r\n/******************************************************\r\n1. Move spanned records in to UploadLegacyKeyspanWestAccountTempSummarySpanned\r\n*******************************************************/\r\n--\r\n--\r\nINSERT INTO CrisNationalGridWest.UploadCrisTempCancellationAccountBillingSpannedSummary\r\n       (\t\tUtilityCompanySeqid ,\r\n\t\t        AccountInvoiceBillingGroup ,\r\n\t\t        BillingPeriod ,\r\n\t\t        BillingPeriodRevision ,\r\n\t\t        CalculatedBillingPeriodRevision ,\r\n\t\t        FirstBillingPeriodCanceled ,\r\n\t\t        IsSpannedBilling ,\r\n\t\t        NumberOfBillingPeriod ,\r\n\t\t        IsCurrentPeriodExchange ,\r\n\t\t        AccountNumber ,\r\n\t\t        MeterReadWorkDay ,\r\n\t\t        UtilityServiceAccountName ,\r\n\t\t        UtilityServiceAddress ,\r\n\t\t        Borough ,\r\n\t\t        Zipcode ,\r\n\t\t        State ,\r\n\t\t        ActivityCode ,\r\n\t\t        ActivityDate ,\r\n\t\t        ActivityTime ,\r\n\t\t        ActivityDateTime ,\r\n\t\t        TransactionCode ,\r\n\t\t        SpecialLedgerAccountNUmber ,\r\n\t\t        GasRateCode ,\r\n\t\t        BillFrequency ,\r\n\t\t        EstimatedOrActualBillingCode ,\r\n\t\t        GasChargeAmount ,\r\n\t\t        FromDate ,\r\n\t\t        ToDate ,\r\n\t\t        BillRenderDate ,\r\n\t\t        BillingDays ,\r\n\t\t        BilledCCF ,\r\n\t\t        ThermFactor ,\r\n\t\t        BilledTherms ,\r\n\t\t        NumberOfMeters ,\r\n\t\t        BillType ,\r\n\t\t        CommodityChargeAmount ,\r\n\t\t        DeliveryChargeAmount ,\r\n\t\t        MTACommodityTax ,\r\n\t\t        MTADeliveryTax ,\r\n\t\t        SalesTax ,\r\n\t\t        SystemBenefitsCharge ,\r\n\t\t        RetailDecouplingMechanismCharge ,\r\n\t\t        DeliveryRateSurcharge ,\r\n\t\t        RealTimeNormalizationCharge ,\r\n\t\t        LatePaymentCharge ,\r\n\t\t        PaperBillCharge ,\r\n\t\t        CommodityCostFactor ,\r\n\t\t        MTACommodityFactor ,\r\n\t\t        MTADeliveryFactor ,\r\n\t\t        SalesTaxFactor ,\r\n\t\t        SystemBenefitChargeFactor ,\r\n\t\t        RetailDecouplingMechanismFactor ,\r\n\t\t        DeliveryRateSurchargeFactor ,\r\n\t\t        RealTimeNormalizationFactor ,\r\n\t\t        LatePaymentFactor ,\r\n\t\t        CurrentAccountBalance ,\r\n\t\t        AccountArrears ,\r\n\t\t        TerminationBalance ,\r\n\t\t        TotalPaymentsPosted ,\r\n\t\t        DateLastPayment ,\r\n\t\t        MiscellaneousChargeAmount ,\r\n\t\t        MiscellaneousChargeType ,\r\n\t\t        ExcludeAndReview ,\r\n\t\t        FireAuditTrigger ,\r\n\t\t        Notes ,\r\n\t\t        AuthenticatedUserID ,\r\n\t\t        DateAdded ,\r\n\t\t        LastUpdate,\r\n\t\t        FirstNewCRISBillingPeriodRevision\r\n)\r\n select \r\n\t\t        UtilityCompanySeqid ,\r\n\t\t        AccountInvoiceBillingGroup ,\r\n\t\t        BillingPeriod ,\r\n\t\t        BillingPeriodRevision ,\r\n\t\t        CalculatedBillingPeriodRevision ,\r\n\t\t        FirstBillingPeriodCanceled ,\r\n\t\t        IsSpannedBilling ,\r\n\t\t        NumberOfBillingPeriod ,\r\n\t\t        IsCurrentPeriodExchange ,\r\n\t\t        AccountNumber ,\r\n\t\t        MeterReadWorkDay ,\r\n\t\t        UtilityServiceAccountName ,\r\n\t\t        UtilityServiceAddress ,\r\n\t\t        Borough ,\r\n\t\t        Zipcode ,\r\n\t\t        State ,\r\n\t\t        ActivityCode ,\r\n\t\t        ActivityDate ,\r\n\t\t        ActivityTime ,\r\n\t\t        ActivityDateTime ,\r\n\t\t        TransactionCode ,\r\n\t\t        SpecialLedgerAccountNUmber ,\r\n\t\t        GasRateCode ,\r\n\t\t        BillFrequency ,\r\n\t\t        EstimatedOrActualBillingCode ,\r\n\t\t        GasChargeAmount ,\r\n\t\t        BillingFromDate ,\r\n\t\t        BillingToDate ,\r\n\t\t        BillRenderDate ,\r\n\t\t        BillingDays ,\r\n\t\t        BilledCCF ,\r\n\t\t        ThermFactor ,\r\n\t\t        BilledTherms ,\r\n\t\t        NumberOfMeters ,\r\n\t\t        BillType ,\r\n\t\t        CommodityChargeAmount ,\r\n\t\t        DeliveryChargeAmount ,\r\n\t\t        MTACommodityTax ,\r\n\t\t        MTADeliveryTax ,\r\n\t\t        SalesTax ,\r\n\t\t        SystemBenefitsCharge ,\r\n\t\t        RetailDecouplingMechanismCharge ,\r\n\t\t        DeliveryRateSurcharge ,\r\n\t\t        RealTimeNormalizationCharge ,\r\n\t\t        LatePaymentCharge ,\r\n\t\t        PaperBillCharge ,\r\n\t\t        CommodityCostFactor ,\r\n\t\t        MTACommodityFactor ,\r\n\t\t        MTADeliveryFactor ,\r\n\t\t        SalesTaxFactor ,\r\n\t\t        SystemBenefitChargeFactor ,\r\n\t\t        RetailDecouplingMechanismFactor ,\r\n\t\t        DeliveryRateSurchargeFactor ,\r\n\t\t        RealTimeNormalizationFactor ,\r\n\t\t        LatePaymentFactor ,\r\n\t\t        CurrentAccountBalance ,\r\n\t\t        AccountArrears ,\r\n\t\t        TerminationBalance ,\r\n\t\t        TotalPaymentsPosted ,\r\n\t\t        DateLastPayment ,\r\n\t\t        MiscellaneousChargeAmount ,\r\n\t\t        MiscellaneousChargeType ,\r\n\t\t        ExcludeAndReview ,\r\n\t\t        FireAuditTrigger ,\r\n\t\t        Notes ,\r\n\t\t        AuthenticatedUserID ,\r\n\t\t        DateAdded ,\r\n\t\t        LastUpdate,\r\n\t\t        FirstNewCRISBillingPeriodRevision\r\n from CrisNationalGridWest.UploadAccountBillingDetail\r\n where IsSpannedBilling = 'Y' and ExcludeAndReview = 'N'\r\n and TransactionCode = 'BC'\r\nprint 'Inserted BC Transaction code for Spanned Rowcount: '+cast( @@rowcount as varchar(10))\r\n\r\n/*********************************\r\n2. Parsed spanned acount info\r\n********************************/\r\nDECLARE @RC int\r\n\r\nEXECUTE @RC = CrisNationalGridWest.usp_CRIS_PreProcessParsingSpannedAccountInfoCancellation @BillingPeriod,1 --@BillingPeriod,@authenticatedID\r\nprint 'Parsed Spanned Rows '\r\n\r\n\r\n\r\n/********************************\r\n3. move data from summary into adjustment\r\n*********************************/\r\ntruncate table CrisNationalGridWest.UploadCrisTempCancellationAccountBillingSpannedSummary\r\nprint 'Remove  BC Transaction code Spanned Rows'\r\n\r\nINSERT INTO CrisNationalGridWest.UploadCrisTempCancellationAccountBillingSpannedSummary\r\n       (\t\t        UtilityCompanySeqid ,\r\n\t\t        AccountInvoiceBillingGroup ,\r\n\t\t        BillingPeriod ,\r\n\t\t        BillingPeriodRevision ,\r\n\t\t        CalculatedBillingPeriodRevision ,\r\n\t\t        FirstBillingPeriodCanceled ,\r\n\t\t        IsSpannedBilling ,\r\n\t\t        NumberOfBillingPeriod ,\r\n\t\t        IsCurrentPeriodExchange ,\r\n\t\t        AccountNumber ,\r\n\t\t        MeterReadWorkDay ,\r\n\t\t        UtilityServiceAccountName ,\r\n\t\t        UtilityServiceAddress ,\r\n\t\t        Borough ,\r\n\t\t        Zipcode ,\r\n\t\t        State ,\r\n\t\t        ActivityCode ,\r\n\t\t        ActivityDate ,\r\n\t\t        ActivityTime ,\r\n\t\t        ActivityDateTime ,\r\n\t\t        TransactionCode ,\r\n\t\t        SpecialLedgerAccountNUmber ,\r\n\t\t        GasRateCode ,\r\n\t\t        BillFrequency ,\r\n\t\t        EstimatedOrActualBillingCode ,\r\n\t\t        GasChargeAmount ,\r\n\t\t        FromDate ,\r\n\t\t        ToDate ,\r\n\t\t        BillRenderDate ,\r\n\t\t        BillingDays ,\r\n\t\t        BilledCCF ,\r\n\t\t        ThermFactor ,\r\n\t\t        BilledTherms ,\r\n\t\t        NumberOfMeters ,\r\n\t\t        BillType ,\r\n\t\t        CommodityChargeAmount ,\r\n\t\t        DeliveryChargeAmount ,\r\n\t\t        MTACommodityTax ,\r\n\t\t        MTADeliveryTax ,\r\n\t\t        SalesTax ,\r\n\t\t        SystemBenefitsCharge ,\r\n\t\t        RetailDecouplingMechanismCharge ,\r\n\t\t        DeliveryRateSurcharge ,\r\n\t\t        RealTimeNormalizationCharge ,\r\n\t\t        LatePaymentCharge ,\r\n\t\t        PaperBillCharge ,\r\n\t\t        CommodityCostFactor ,\r\n\t\t        MTACommodityFactor ,\r\n\t\t        MTADeliveryFactor ,\r\n\t\t        SalesTaxFactor ,\r\n\t\t        SystemBenefitChargeFactor ,\r\n\t\t        RetailDecouplingMechanismFactor ,\r\n\t\t        DeliveryRateSurchargeFactor ,\r\n\t\t        RealTimeNormalizationFactor ,\r\n\t\t        LatePaymentFactor ,\r\n\t\t        CurrentAccountBalance ,\r\n\t\t        AccountArrears ,\r\n\t\t        TerminationBalance ,\r\n\t\t        TotalPaymentsPosted ,\r\n\t\t        DateLastPayment ,\r\n\t\t        MiscellaneousChargeAmount ,\r\n\t\t        MiscellaneousChargeType ,\r\n\t\t        ExcludeAndReview ,\r\n\t\t        FireAuditTrigger ,\r\n\t\t        Notes ,\r\n\t\t        AuthenticatedUserID ,\r\n\t\t        DateAdded ,\r\n\t\t        LastUpdate,\r\n\t\t        FirstNewCRISBillingPeriodRevision\r\n)\r\n select \r\n\t\t        UtilityCompanySeqid ,\r\n\t\t        AccountInvoiceBillingGroup ,\r\n\t\t        BillingPeriod ,\r\n\t\t        BillingPeriodRevision ,\r\n\t\t        CalculatedBillingPeriodRevision ,\r\n\t\t        FirstBillingPeriodCanceled ,\r\n\t\t        IsSpannedBilling ,\r\n\t\t        NumberOfBillingPeriod ,\r\n\t\t        IsCurrentPeriodExchange ,\r\n\t\t        AccountNumber ,\r\n\t\t        MeterReadWorkDay ,\r\n\t\t        UtilityServiceAccountName ,\r\n\t\t        UtilityServiceAddress ,\r\n\t\t        Borough ,\r\n\t\t        Zipcode ,\r\n\t\t        State ,\r\n\t\t        ActivityCode ,\r\n\t\t        ActivityDate ,\r\n\t\t        ActivityTime ,\r\n\t\t        ActivityDateTime ,\r\n\t\t        TransactionCode ,\r\n\t\t        SpecialLedgerAccountNUmber ,\r\n\t\t        GasRateCode ,\r\n\t\t        BillFrequency ,\r\n\t\t        EstimatedOrActualBillingCode ,\r\n\t\t        GasChargeAmount ,\r\n\t\t        BillingFromDate ,\r\n\t\t        BillingToDate ,\r\n\t\t        BillRenderDate ,\r\n\t\t        BillingDays ,\r\n\t\t        BilledCCF ,\r\n\t\t        ThermFactor ,\r\n\t\t        BilledTherms ,\r\n\t\t        NumberOfMeters ,\r\n\t\t        BillType ,\r\n\t\t        CommodityChargeAmount ,\r\n\t\t        DeliveryChargeAmount ,\r\n\t\t        MTACommodityTax ,\r\n\t\t        MTADeliveryTax ,\r\n\t\t        SalesTax ,\r\n\t\t        SystemBenefitsCharge ,\r\n\t\t        RetailDecouplingMechanismCharge ,\r\n\t\t        DeliveryRateSurcharge ,\r\n\t\t        RealTimeNormalizationCharge ,\r\n\t\t        LatePaymentCharge ,\r\n\t\t        PaperBillCharge ,\r\n\t\t        CommodityCostFactor ,\r\n\t\t        MTACommodityFactor ,\r\n\t\t        MTADeliveryFactor ,\r\n\t\t        SalesTaxFactor ,\r\n\t\t        SystemBenefitChargeFactor ,\r\n\t\t        RetailDecouplingMechanismFactor ,\r\n\t\t        DeliveryRateSurchargeFactor ,\r\n\t\t        RealTimeNormalizationFactor ,\r\n\t\t        LatePaymentFactor ,\r\n\t\t        CurrentAccountBalance ,\r\n\t\t        AccountArrears ,\r\n\t\t        TerminationBalance ,\r\n\t\t        TotalPaymentsPosted ,\r\n\t\t        DateLastPayment ,\r\n\t\t        MiscellaneousChargeAmount ,\r\n\t\t        MiscellaneousChargeType ,\r\n\t\t        ExcludeAndReview ,\r\n\t\t        FireAuditTrigger ,\r\n\t\t        Notes ,\r\n\t\t        AuthenticatedUserID ,\r\n\t\t        DateAdded ,\r\n\t\t        LastUpdate,\r\n\t\t        FirstNewCRISBillingPeriodRevision\r\n from CrisNationalGridWest.UploadAccountBillingDetail\r\n where IsSpannedBilling = 'N'  and ExcludeAndReview = 'N'\r\n and TransactionCode = 'BC'\r\nprint 'Inserted Single Period  BI Transaction code Rowcount: '+cast( @@rowcount as varchar(10))\r\n\r\ndeclare @Count int\r\nselect @Count=count(*) from CrisNationalGridWest.UploadAccountBillingAdjustmentCrisGas\r\n--\r\nprint 'Parsed Spanned rows into Single Period Rows  Count: '+cast( @Count as varchar(10))\r\n\r\n--\r\n/*\r\nmove data into adjustment table from the summary.\r\ntable includes original bill (billingPeriod = revisedBillingPeriod)\r\n*/\r\n--truncate table CrisNationalGridWest.UploadAccountBillingAdjustmentCrisGas\r\nINSERT INTO CrisNationalGridWest.UploadAccountBillingAdjustmentCrisGasTempCancellation\r\n\t\t(\r\n\t\t\tUtilityCompanySeqid, AccountInvoiceBillingGroup, BillingPeriod, BillingPeriodRevision, FirstBillingPeriodCanceled, IsSpannedBilling, \r\n\t\t\tNumberOfBillingPeriod, IsCurrentPeriodExchange, AccountNumber, MeterReadWorkDay, AccountBillingStatus, PreviousAccountBillingStatus, \r\n\t\t\tAccountBillingStatusCodePeriod, UtilityServiceAccountName, UtilityServiceAddress, Borough, Zipcode, State, ActivityCode, ActivityDateTime, \r\n\t\t\tSpecialLedgerAccountNUmber, GasRateCode, BillFrequency, EstimatedOrActualBillingCode, GasChargeAmount, FromDate, ToDate, BillRenderDate, \r\n\t\t\tBillingDays, BilledCCF, ThermFactor, BilledTherms, NumberOfMeters, BillType, CommodityChargeAmount, DeliveryChargeAmount, MTACommodityTax,\r\n\t\t\tMTADeliveryTax, SalesTax, SystemBenefitsCharge, RetailDecouplingMechanismCharge, DeliveryRateSurcharge, RealTimeNormalizationCharge, \r\n\t\t\tLatePaymentCharge, PaperBillCharge, CommodityCostFactor, MTACommodityFactor, MTADeliveryFactor, SalesTaxFactor, SystemBenefitChargeFactor, \r\n\t\t\tRetailDecouplingMechanismFactor, DeliveryRateSurchargeFactor, RealTimeNormalizationFactor, LatePaymentFactor, AccountArrears, \r\n\t\t\tTerminationBalance, TotalPaymentsPosted, CurrentAccountBalance, DateLastPayment, MiscellaneousChargeAmount, MiscellaneousChargeType, \r\n\t\t\tNotes, AuthenticatedUserID, DateAdded, LastUpdate,FirstNewCRISBillingPeriodRevision,TransactionCode,GasChargeSummedPieces\r\n\t\t)\r\nselect \r\n\t\t\tUtilityCompanySeqid, AccountInvoiceBillingGroup, BillingPeriod, BillingPeriodRevision, \r\n\t\t\tFirstBillingPeriodCanceled, IsSpannedBilling, NumberOfBillingPeriod, IsCurrentPeriodExchange, AccountNumber, MeterReadWorkDay, \r\n\t\t\t'AC' as AccountBillingStatus, '46' as PreviousAccountBillingStatus, \r\n\t\t\tBillingPeriod as AccountBillingStatusCodePeriod, \r\n\t\t\tUtilityServiceAccountName, UtilityServiceAddress, Borough, \r\n\t\t\tZipcode, State, ActivityCode, ActivityDateTime, SpecialLedgerAccountNUmber, GasRateCode, BillFrequency, EstimatedOrActualBillingCode, \r\n\t\t\tGasChargeAmount, FromDate, ToDate, BillRenderDate, BillingDays, BilledCCF, ThermFactor, BilledTherms, NumberOfMeters, BillType, \r\n\t\t\tCommodityChargeAmount, DeliveryChargeAmount, MTACommodityTax, MTADeliveryTax, SalesTax, SystemBenefitsCharge, \r\n\t\t\tRetailDecouplingMechanismCharge, DeliveryRateSurcharge, RealTimeNormalizationCharge, LatePaymentCharge, PaperBillCharge, \r\n\t\t\tCommodityCostFactor, MTACommodityFactor, MTADeliveryFactor, SalesTaxFactor, SystemBenefitChargeFactor, RetailDecouplingMechanismFactor, \r\n\t\t\tDeliveryRateSurchargeFactor, RealTimeNormalizationFactor, LatePaymentFactor, AccountArrears, TerminationBalance, \r\n\t\t\tTotalPaymentsPosted, CurrentAccountBalance, DateLastPayment, MiscellaneousChargeAmount, MiscellaneousChargeType, Notes, \r\n\t\t\tAuthenticatedUserID, DateAdded, LastUpdate,FirstNewCRISBillingPeriodRevision,TransactionCode,\r\n\t\t\tGasChargeAmount -- as GasChargeSummedPieces for no span\r\nfrom \r\n\t\tCrisNationalGridWest.UploadCrisTempCancellationAccountBillingSpannedSummary\r\nprint 'Inserted UploadCrisTempAccountBillingSpannedSummary Single Period Rowcount: '+cast( @@rowcount as varchar(10))\r\n\t\t\r\n\t\t\r\nselect @Count=count(*) from CrisNationalGridWest.UploadAccountBillingAdjustmentCrisGas\r\n--\r\nprint 'Total Single Period Rows  Count: '+cast( @Count as varchar(10))\r\n------------------\r\n------------------ Making sure that the CurrentAccountBalance is always applied to the current billing period account bill\r\n------------------\r\n----------------update CrisNationalGridWest.UploadAccountBillingAdjustmentCrisGas\r\n----------------set \r\n----------------\t\tAccountArrears = 0,\r\n----------------\t\tCurrentAccountBalance = 0\r\n----------------\t\twhere BillingPeriod <> BillingPeriodRevision\r\n--\t\t\r\nEND"
        }
      ]
    }
  ]
}