{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Utils",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_GrantPermissionsOnTablesAndViews",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_GrantPermissionsOnTablesAndViews",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to manage permissions and alter domain names for tables and views within a SQL Server database. The procedure is structured to grant specific permissions on tables and views and alter the domain of columns in tables or views based on user-defined data types. However, the actual implementation of these functionalities is commented out, leaving the procedure effectively inactive."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level of this stored procedure is medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves dynamic SQL execution, which requires careful handling to avoid SQL injection."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses a cursor to iterate over a set of database objects, which can be complex to manage and optimize."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure is designed to handle both tables and views, adding to its complexity."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@DomainUserName NVARCHAR(256)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is intended to specify the domain user name for which permissions be granted. However, it is not used in the current implementation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@OldDomainName NVARCHAR(256)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is intended to specify the old domain name of a user-defined data type that needs to be altered."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@NewDomainName NVARCHAR(256)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is intended to specify the new domain name to which the user-defined data type should be changed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The business logic and workflow of the procedure, as intended, are as follows:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Grant Permissions",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The commented-out section contains SQL statements to grant various permissions (INSERT, SELECT, UPDATE, EXECUTE) on specific tables and views to a specified domain user ("
                },
                {
                  "type": "text",
                  "text": "DCAS\\ec3applogin",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "). These permissions are intended to be granted within the "
                },
                {
                  "type": "text",
                  "text": "EC3database",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Alter Domain Names",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure is designed to alter the domain of columns in tables or views that use a specific user-defined data type. It uses a cursor to iterate over the results of a query that identifies such columns. For each column, it constructs and executes a dynamic SQL statement to alter the column's domain or refresh the view if applicable."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The cursor "
                },
                {
                  "type": "text",
                  "text": "AlterDomainAndChangeColumnDomainCursor",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is used to fetch and process each table or view that matches the criteria of having a specific domain name."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Cursors can be resource-intensive and slow, especially if the dataset is large. Consider replacing the cursor with set-based operations if possible."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dynamic SQL",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of dynamic SQL can impact performance due to the overhead of compiling and executing SQL statements at runtime. Ensure that dynamic SQL is used judiciously and that SQL injection risks are mitigated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Commented Code",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure contains a significant amount of commented-out code, which does not affect performance but can make the codebase harder to maintain and understand."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "SQL Injection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of dynamic SQL poses a risk of SQL injection if input parameters are not properly sanitized. Ensure that all dynamic SQL statements are constructed safely."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inactive Code",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure currently does not perform any actions due to the commented-out code. This could lead to confusion or errors if the procedure is expected to be functional."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Permission Management",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Granting permissions and altering schema ownership should be done with caution to avoid unintentional security vulnerabilities."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks error handling mechanisms, which could lead to unhandled exceptions and potential data integrity issues. Consider adding TRY...CATCH blocks to manage errors gracefully."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Utils].[usp_GrantPermissionsOnTablesAndViews] (@DomainUserName NVARCHAR(256),@OldDomainName NVARCHAR(256),@NewDomainName NVARCHAR(256))\nAS\r\n--**************************************************************************************\r\n--\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT INSERT ON [SBMR].[SbmrAction] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT SELECT ON [SBMR].[SbmrAction] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT UPDATE ON [SBMR].[SbmrAction] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Budget] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[KeyspanPayment] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[FuelOil] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[crw] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Billing] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Encore] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[KeySpanEast] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[ManualBill] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[ActualBill] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[CityPlanning] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Audit] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Utils] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Gas] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[NationalGridEast] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[FMS] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Gbat] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[CrystalReportsUser] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Contact] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[CrystalRpt] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[OECStaff] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[KeySpanWest] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Voucher] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[ConEd] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[NationalGridWest] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Nypa] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tUSE [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tALTER AUTHORIZATION ON SCHEMA::[Common] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT REFERENCES ON [Gas].[AccountMeterAndTrackTablesSeqidPriorToGasExchange] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT SELECT ON [Gas].[AccountMeterAndTrackTablesSeqidPriorToGasExchange] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT UPDATE ON [Gas].[AccountMeterAndTrackTablesSeqidPriorToGasExchange] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT SELECT ON [Gas].[uftn_TableCompareABGandABAGsummaryInfo] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT SELECT ON [Gas].[uftn_TableVerifyAccountBillingSummaryInfo] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT EXECUTE ON [Gas].[usp_ProcessGasAccountBilling] TO [DCAS\\ec3applogin]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tuse [EC3database]\r\n--\t\t\t\t\tGO\r\n--\t\t\t\t\tGRANT SELECT ON [Gas].[uvw_XcheckSummaryUploadGasAccountBillingAdjustmentShort] TO [DCAS\\ec3applogin]\r\n--\r\n--\r\n--------Declare Variables                                            \r\n--------**************************************************************************************\r\n------declare @I int\r\n------declare @SQLString NVARCHAR(512)\r\n------declare @View NVARCHAR(512)\r\n------declare @SchemaQualifiedTriggerName NVARCHAR(256)\r\n------declare @TABLE_SCHEMA NVARCHAR(256)\r\n------declare @TABLE_NAME NVARCHAR(256)\r\n------declare @DOMAIN_SCHEMA NVARCHAR(256)\r\n------declare @DOMAIN_NAME NVARCHAR(256) \r\n------declare @COLUMN_NAME NVARCHAR(256)\r\n\r\n------declare @View_SCHEMA_NAME NVARCHAR(256)\r\n------declare @View_NAME NVARCHAR(256)\r\n------declare @IsTable VARCHAR(1)\r\n--------\r\n------declare @SqlQuote char(1)\r\n--------\r\n------set @I = 0\r\n------set @SqlQuote = char(39)\r\n--------\r\n--------\r\n------DECLARE AlterDomainAndChangeColumnDomainCursor CURSOR FOR\r\n------SELECT TABLE_SCHEMA, TABLE_NAME, DOMAIN_SCHEMA, DOMAIN_NAME, COLUMN_NAME,View_SCHEMA_NAME,View_NAME,IsTable\r\n------FROM Utils.uvw_FindAllTablesColumnsByUserDefinedDatatype\r\n------WHERE (DOMAIN_NAME = @OldDomainName) -- and TABLE_NAME not like 'uvw%' \r\n\r\n--------\r\n------OPEN AlterDomainAndChangeColumnDomainCursor;\r\n--------\r\n------FETCH NEXT FROM AlterDomainAndChangeColumnDomainCursor INTO \r\n------\t\t@TABLE_SCHEMA, @TABLE_NAME, @DOMAIN_SCHEMA, @DOMAIN_NAME, @COLUMN_NAME,@View_SCHEMA_NAME,@View_NAME,@IsTable\r\n--------\r\n-------- Check @@FETCH_STATUS to see if there are any more rows to fetch.\r\n\r\n------WHILE @@FETCH_STATUS = 0\r\n------   BEGIN\r\n------\t--\r\n------\tif (@IsTable = 'T')\r\n------\t\tBEGIN\r\n------\t\t\tset @SQLString = 'ALTER TABLE '+@TABLE_SCHEMA+'.'+@TABLE_NAME+' ALTER COLUMN '+@COLUMN_NAME +' '+@NewDomainName\r\n------\t\t\tprint cast(@I as varchar(3))+') Table Altered: '+@SQLString\r\n------\t\tend\r\n------\telse\r\n------\t\tbegin\r\n------\t\t\tset @View = @SqlQuote+@View_SCHEMA_NAME+'.'+@View_NAME+@SqlQuote\r\n------\t\t\tset @SQLString = 'exec sp_refreshview '+ @View\r\n------\t\t\tprint cast(@I as varchar(3))+') Recompiled View: '+@SQLString\r\n------\t\tend\r\n--------\r\n------\tEXEC sp_executesql @SQLString;\r\n------\tset @I = @I+1\r\n\r\n------\t--\r\n------FETCH NEXT FROM AlterDomainAndChangeColumnDomainCursor INTO \r\n------\t\t@TABLE_SCHEMA, @TABLE_NAME, @DOMAIN_SCHEMA, @DOMAIN_NAME, @COLUMN_NAME,@View_SCHEMA_NAME,@View_NAME,@IsTable\r\n------   END\r\n\r\n------CLOSE AlterDomainAndChangeColumnDomainCursor;\r\n------DEALLOCATE AlterDomainAndChangeColumnDomainCursor;"
        }
      ]
    }
  ]
}