{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_EnergyUsageSpikesReport_Export",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_EnergyUsageSpikesReport_Export",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report on energy usage spikes for accounts. It identifies accounts with unusually high energy usage compared to their average usage over a billing period. The procedure calculates various metrics, such as the maximum energy usage, average energy usage excluding the maximum, and a ratio of the maximum usage to the average of the rest. It filters and ranks these accounts, ultimately selecting those with significant spikes for reporting."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is medium due to the use of Common Table Expressions (CTEs), window functions, multiple joins, and conditional logic within aggregate functions. The procedure involves several nested queries and calculations, which require a good understanding of SQL and database design."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "This stored procedure does not take any input parameters. It operates on predefined tables and conditions within the database."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure sets the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", allowing it to read uncommitted changes from other transactions. This can improve performance by reducing locking but may result in reading dirty data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "CTE Definition",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure defines a CTE named "
                },
                {
                  "type": "text",
                  "text": "EnrgyExprt",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to calculate and rank energy usage metrics for each account:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Metrics Calculated",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ":"
                        }
                      ]
                    },
                    {
                      "type": "bulletList",
                      "content": [
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "CountOfAccounts",
                                  "marks": [
                                    {
                                      "type": "code"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": ": Total number of records for an account."
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "TotalAccountEnergyUsage",
                                  "marks": [
                                    {
                                      "type": "code"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": ": Sum of energy usage for an account."
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "MaxAccountEnergyUsage",
                                  "marks": [
                                    {
                                      "type": "code"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": ": Maximum energy usage recorded for an account."
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "AverageOftheRestOtherThanMaxEnergy",
                                  "marks": [
                                    {
                                      "type": "code"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": ": Average energy usage excluding the maximum value."
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "MaxEnergyUsageDividedbyAverageOfRest",
                                  "marks": [
                                    {
                                      "type": "code"
                                    }
                                  ]
                                },
                                {
                                  "type": "text",
                                  "text": ": Ratio of maximum usage to the average of the rest."
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Ranking",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ": Accounts are ranked within each "
                        },
                        {
                          "type": "text",
                          "text": "AccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " based on "
                        },
                        {
                          "type": "text",
                          "text": "BillingPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " in descending order."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Filtering and Joining",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure filters accounts with more than one record and non-zero energy usage."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It joins the results with the "
                        },
                        {
                          "type": "text",
                          "text": "Published.AccountLevelRawDataForCurrentPeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table to associate the maximum energy usage with its billing period."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Selection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The final query selects accounts with a rank of 1, ensuring they have the highest energy usage for their billing period."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It excludes accounts that also have a rank of 2, ensuring only unique maximum spikes are reported."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It filters for accounts where the ratio of maximum usage to average usage is greater than 4 and the billing period is after November 2016."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The results are ordered by the ratio in descending order."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While this isolation level can improve performance by reducing locking, it may lead to reading uncommitted or dirty data, which could affect the accuracy of the report."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complex Joins and Aggregations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of multiple joins and aggregations can be resource-intensive, especially on large datasets. Indexing on key columns like "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can help improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Window Functions",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "RANK()",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can be computationally expensive, particularly if the dataset is large. Ensuring efficient indexing can mitigate this."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can lead to inconsistencies if the underlying data is being modified concurrently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Division by Zero",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure handles potential division by zero by substituting with 1, which may skew results. This should be carefully considered in the context of business logic."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Skew",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The logic assumes that a ratio greater than 4 indicates a significant spike, which may not hold true for all datasets or business contexts."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As data volume grows, the performance of the procedure may degrade due to the complexity of the queries and calculations involved. Regular monitoring and optimization may be necessary."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_EnergyUsageSpikesReport_Export]\nAS \r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\t\r\n    WITH EnrgyExprt \r\n\t\t(BillingPeriod\r\n\t\t,AccountSeqId\r\n\t\t,CurrentAccountNumber\r\n\t\t,CountOfAccounts\r\n\t\t,TotalAccountEnergyUsage\r\n\t\t,MaxAccountEnergyUsage\r\n\t\t,AverageOftheRestOtherThanMaxEnergy\r\n\t\t,MaxEnergyUsageDividedbyAverageOfRest\r\n\t\t,Rankk)\r\n\tAS\r\n\t(SELECT F.BillingPeriod,\r\n        F.AccountSeqid,\r\n        F.CurrentAccountNumber,\r\n        F.CountOfAccounts,\r\n        F.TotalAccountEnergyUsage,\r\n        F.MaxAccountEnergyUsage,\r\n        F.AverageOftheRestOtherThanMaxEnergy,\r\n        F.MaxEnergyUsageDividedbyAverageOfRest,\r\n\t\tRANK() OVER(PARTITION BY F.AccountSeqid,F.maxAccountEnergyUsage ORDER BY F.BillingPeriod DESC) AS rankk\r\n\tFROM (SELECT DISTINCT R.BillingPeriod\r\n\t\t\t,L.AccountSeqid\r\n\t\t\t,L.CurrentAccountNumber\r\n\t\t\t,L.CountOfAccounts\r\n\t\t\t,L.TotalAccountEnergyUsage\r\n\t\t\t,L.MaxAccountEnergyUsage\r\n\t\t\t,L.AverageOftheRestOtherThanMaxEnergy\r\n\t\t\t,L.MaxEnergyUsageDividedbyAverageOfRest\r\n\t\tFROM (SELECT AccountSeqid\r\n\t\t\t\t,CurrentAccountNumber\r\n\t\t\t\t,COUNT(*) AS CountOfAccounts\r\n\t\t\t\t,SUM(AccountEnergyUsage) AS TotalAccountEnergyUsage\r\n\t\t\t\t,MAX(AccountEnergyUsage) AS MaxAccountEnergyUsage\r\n\t\t\t\t,CASE WHEN ((SUM(AccountEnergyUsage) - MAX(AccountEnergyUsage)) / (COUNT(*) - 1)) = 0 THEN 1 \r\n\t\t\t\t\tELSE ((SUM(AccountEnergyUsage)-MAX(AccountEnergyUsage)) / (COUNT(*) - 1)) END AS AverageOftheRestOtherThanMaxEnergy\r\n\t\t\t\t,MAX(AccountEnergyUsage) / (CASE WHEN ((SUM(AccountEnergyUsage) - MAX(AccountEnergyUsage)) / (COUNT(*) - 1)) = 0 THEN 1 \r\n\t\t\t\t\tELSE ((SUM(AccountEnergyUsage) - MAX(AccountEnergyUsage)) / (COUNT(*) - 1)) END) AS MaxEnergyUsageDividedbyAverageOfRest\r\n\t\t\tFROM Published.AccountLevelRawDataForCurrentPeriod\r\n\t\t\tWHERE AccountEnergyUsage <> 0\r\n\t\t\tGROUP BY  AccountSeqid,CurrentAccountNumber\r\n\t\t\tHAVING COUNT(*) > 1) AS L\r\n\t\t\tINNER JOIN Published.AccountLevelRawDataForCurrentPeriod AS R ON R.AccountSeqid = L.AccountSeqid AND R.AccountEnergyUsage = L.maxAccountEnergyUsage\r\n\t\t) AS F)\r\n\tSELECT CTE.BillingPeriod AS MaxEnergyBillingPeriod\r\n\t\t,CTE.CurrentAccountNumber\r\n\t\t,AMIAccounts.AMILabel AS AMIAttribute\r\n\t\t,CTE.CountOfAccounts AS NumberOfBilling\r\n\t\t,CTE.MaxAccountEnergyUsage\r\n\t\t,CTE.AverageOftheRestOtherThanMaxEnergy\r\n\t\t,CTE.MaxEnergyUsageDividedbyAverageOfRest\r\n\t\t,CTE.AccountSeqId \r\n\tFROM EnrgyExprt AS CTE\r\n\t\tLEFT JOIN (SELECT DISTINCT A.AccountSeqid\r\n\t\t\t\t,'AMI' AS AMILabel\r\n\t\t\tFROM Billing.AccountProgramAttributeType AS APAT\r\n\t\t\t\tINNER JOIN Billing.Account AS A ON A.UniqueAccountSeqid = APAT.AccountUniqueSeqID \r\n\t\t\tWHERE APAT.ProgramAttributeTypeSeqid = 14 AND APAT.AttributeStatusOptionSeqid = 39 AND A.IsCurrentRecord = 'Y') AS AMIAccounts\r\n\t\t\tON AMIAccounts.AccountSeqid = CTE.AccountSeqid\r\n\tWHERE CTE.Rankk = 1\r\n\t\tAND CTE.AccountSeqid NOT IN (SELECT DISTINCT CTE.AccountSeqId FROM EnrgyExprt WHERE CTE.Rankk = 2)\r\n\t\tAND CTE.MaxEnergyUsageDividedbyAverageOfRest > 4\r\n\t\tAND CTE.BillingPeriod > '201611'\r\n\tORDER BY CTE.MaxEnergyUsageDividedbyAverageOfRest DESC;\r\nEND;"
        }
      ]
    }
  ]
}