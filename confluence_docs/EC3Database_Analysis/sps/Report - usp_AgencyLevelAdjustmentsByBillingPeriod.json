{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_AgencyLevelAdjustmentsByBillingPeriod",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "High",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_AgencyLevelAdjustmentsByBillingPeriod",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report of agency-level billing adjustments for a specified billing period. It retrieves and processes billing adjustment data from various tables related to electric, gas, and manual billing adjustments. The procedure logs its execution for auditing purposes and formats the billing period for display. It then constructs a comprehensive dataset of adjustments, including revised billed amounts, arrears, and other financial metrics, and outputs this data in a structured format."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: High"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure is complex due to the following reasons:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple joins and subqueries across several tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It uses Common Table Expressions (CTEs) to manage complex data transformations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It handles different types of billing adjustments (electric, gas, manual) with distinct logic for each."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes auditing and logging mechanisms."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@EmailAddress AS VARCHAR(75)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The email address of the user requesting the report. Used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which adjustments are being reported. It is expected in the format 'YYYYMM'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AgencyCodeOEC AS VARCHAR(MAX)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A list of agency codes for which the report is generated. This parameter is used to filter the data to specific agencies."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization and Logging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by setting the transaction isolation level to "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to avoid locking issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It logs the execution details using the "
                },
                {
                  "type": "text",
                  "text": "usp_AddReportUsageLog",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " procedure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Billing Period Formatting",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Converts the "
                },
                {
                  "type": "text",
                  "text": "@BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " into a human-readable format (e.g., \"January 2023\")."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Agency Accounts Preparation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Populates a temporary table "
                },
                {
                  "type": "text",
                  "text": "@AgencyAccounts",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with account identifiers by joining several tables to filter accounts related to the specified agency codes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Retrieval and Transformation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Uses a CTE ("
                },
                {
                  "type": "text",
                  "text": "CTE_ALLAdjustements",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") to gather and transform billing adjustment data from different sources:"
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Electric Adjustments",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Retrieves and calculates revised billed amounts and other metrics for electric accounts."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Gas Adjustments",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Similar logic is applied for gas accounts, with specific fields for gas billing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Manual Billing Adjustments",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Handles adjustments for manually billed accounts."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Each block within the CTE handles a specific type of adjustment and combines current period data with historical adjustments."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Data Selection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins the CTE results with additional tables to enrich the data with agency, facility, and utility information."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Outputs a structured dataset with detailed financial metrics for each account."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Isolation Level",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance by reducing locking but leads to dirty reads."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Complex Joins and CTEs",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The extensive use of joins and CTEs can be resource-intensive, especially with large datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a temporary table ("
                },
                {
                  "type": "text",
                  "text": "@AgencyAccounts",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") helps manage complex joins but impact memory usage."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Dirty Reads",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "READ UNCOMMITTED",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " isolation level may result in reading uncommitted data, which could lead to inconsistencies in the report."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The complexity and number of joins may affect performance as the dataset grows."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parameter Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": There is no validation for input parameters, which could lead to SQL errors or incorrect data processing if invalid values are provided."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure does not sanitize input parameters, which could pose a risk of SQL injection if inputs are not properly handled elsewhere in the application."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [Report].[usp_AgencyLevelAdjustmentsByBillingPeriod]\n(\r\n\t@EmailAddress AS VARCHAR(75)\r\n\t,@BillingPeriod AS VARCHAR(6)\r\n\t,@AgencyCodeOEC AS VARCHAR(MAX)\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\tDECLARE @spname VARCHAR(100) = OBJECT_NAME(@@PROCID);\r\n\tEXEC [Audit].usp_AddReportUsageLog\r\n\t\t@ReportName\t\t\t\t\t= @spname,\r\n\t\t@StoredProcName\t\t\t\t= @spname,\r\n\t\t@RequestedBy\t\t\t\t= @EmailAddress,\r\n\t\t@prmPublishedBillingPeriod\t= NULL,\r\n\t\t@prmBillingPeriod\t\t\t= NULL,\r\n\t\t@prmAgency_ies\t\t\t\t= @AgencyCodeOEC,\r\n\t\t@prmFacilityNumber_s\t\t= NULL,\r\n\t\t@prmStartingBillingPeriod\t= @BillingPeriod,\r\n\t\t@prmEndingBillingPeriod\t\t= NULL\r\n\r\n\t-- format the billing period \r\n\tDECLARE @BillingPeriodIssued AS VARCHAR(25);\r\n\tSELECT  @BillingPeriodIssued = DATENAME(MM, dbo.ConvertYYYYMMDDToDatetime(@BillingPeriod + '01')) + ' ' +  DATENAME(YY, dbo.ConvertYYYYMMDDToDatetime(@BillingPeriod + '01'));\r\n\t\r\n\tDECLARE @AgencyAccounts TABLE (UniqueSeqID INT NULL, AccountSeqid INT NULL);\r\n\r\n\t-- save list to a temp table to make the joins easy \r\n\tINSERT @AgencyAccounts (UniqueSeqID, AccountSeqid)\r\n\tSELECT PAM.UniqueAccountSeqid, PAM.AccountSeqid\r\n\tFROM (SELECT A.AccountSeqid FROM Billing.Account AS A\r\n\t\t\t INNER JOIN Billing.UniqueAccountMapping AS UAM ON UAM.AccountSeqid = A.AccountSeqid\r\n\t\t\t INNER JOIN  Billing.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@AgencyCodeOEC, @EmailAddress) AS Div ON Div.AgencyDivisionSeqID = A.AgencyAccount\r\n\t\tWHERE UAM.isCurrentAccount = 'Y') AS L\r\n\tINNER JOIN Billing.Account AS aMap ON  aMap.AccountSeqid = L.AccountSeqid\r\n\tINNER JOIN Billing.Account AS PAM ON PAM.UniqueAccountSeqid = aMap.UniqueAccountSeqid\r\n\r\n\t-- construct all the adjustements\r\n\t;WITH CTE_ALLAdjustements AS (\r\n\t\t--******************************** NYPA block ***************************************************************************************\r\n\t\t-- current period\r\n\t\tSELECT * FROM\r\n\t\t\t(SELECT AA.UniqueSeqID,\r\n\t\t\t\tABAE.TotalReBilledAmount + ABAE.CustomerLevelAdjustmentAmount + ABAE.RevisedReactivePowerDollars + ABAE.CommodityAllocationCharge + ABAE.DeliveryAllocationCharge AS RevisedBilledAmount,\r\n\t\t\t\tPaidAdjustmentAmount AS PaidAdjustmentAmount,\r\n\t\t\t\tManualPaymentOverrideAmount AS ManualPaymentOverrideAmount,\r\n\t\t\t\t0 AS Arrears,\r\n\t\t\t\t0 AS MiscCharges, -- TOBE REVISED\r\n\t\t\t\tAB.TotalAmountDue\r\n\t\t\tFROM @AgencyAccounts AA\r\n\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentElectric AS ABAE ON ABAE.AdjustedAccount = AA.AccountSeqid\r\n\t\t\t\tLEFT JOIN Billing.AccountBilling AS AB ON AB.AccountBillingSeqid = ABAE.AdjustedAccountBill\r\n\t\t\tWHERE ABAE.BillingPeriod = @BillingPeriod AND ABAE.BillingPeriodRevision = @BillingPeriod) AS CurrentRecords\r\n\t\t\tINNER JOIN (SELECT\r\n\t\t\t\t\tAA.UniqueSeqId AS AccountUniqueSeqid,\r\n\t\t\t\t\tMIN(ABAE.BillingPeriodRevision) AS FirstRevisedBillingPeriod,\r\n\t\t\t\t\tSUM(ABAE.TotalCanceledAmount) AS CancelledCharges,\r\n\t\t\t\t\tSUM(ABAE.TotalReBilledAmount + ABAE.CustomerLevelAdjustmentAmount + ABAE.RevisedReactivePowerDollars + ABAE.CommodityAllocationCharge + ABAE.DeliveryAllocationCharge) AS AdjustedPeriodsCharges\r\n\t\t\t\tFROM @AgencyAccounts AS AA\r\n\t\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentElectric ABAE ON ABAE.AdjustedAccount = AA.AccountSeqid\r\n\t\t\t\tWHERE ABAE.BillingPeriod = @BillingPeriod AND ABAE.BillingPeriodRevision <> ABAE.BillingPeriod\r\n\t\t\t\tGROUP BY AA.UniqueSeqId) AS Adjustments\r\n\t\t\tON Adjustments.AccountUniqueSeqid = CurrentRecords.UniqueSeqID\r\n\t\tUNION ALL\r\n\t\t--******************************** CONed Gas block ***************************************************************************************\r\n\t\t-- current period\r\n\t\tSELECT * FROM\r\n\t\t\t(SELECT AA.UniqueSeqID,\r\n\t\t\t\tABAG.RevisedBilledAmount + ISNULL(ABAG.DiscountedAmount, 0) as RevisedBilledAmount,\r\n\t\t\t\tAB.PaidAdjustmentAmount AS PaidAdjustmentAmount,\r\n\t\t\t\tManualPaymentOverrideAmount AS ManualPaymentOverrideAmount,\r\n\t\t\t\tABAG.BalanceDollars AS Arrears,\r\n\t\t\t\tABAG.CreditDollars + ABAG.DiscountedAmount AS MiscCharges,\r\n\t\t\t\tAB.TotalAmountDue\r\n\t\t\tFROM @AgencyAccounts AS AA\r\n\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentGas AS ABAG ON ABAG.AccountSeqid = AA.AccountSeqid\r\n\t\t\t\tLEFT JOIN Billing.AccountBilling AS AB ON AB.AccountBillingSeqid = ABAG.AccountBillingSeqid\r\n\t\t\tWHERE ABAG.BillingPeriod = @BillingPeriod AND ABAG.BillingPeriodRevision = @BillingPeriod) AS CurrentRecords\r\n\t\t\tINNER JOIN (SELECT AA.UniqueSeqId AS AccountUniqueSeqid,\r\n\t\t\t\t\tMIN(ABAG.BillingPeriodRevision) AS FirstRevisedBillingPeriod,\r\n\t\t\t\t\tSUM(ABAG.CanceledBilledAmount) AS CancelledCharges,\r\n\t\t\t\t\tSUM(ABAG.RevisedBilledAmount + ISNULL(ABAG.DiscountedAmount, 0)) AS AdjustedPeriodsCharges\t\t\r\n\t\t\t\tFROM @AgencyAccounts AS AA\r\n\t\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentGas AS ABAG ON ABAG.AccountSeqid = AA.AccountSeqid\r\n\t\t\t\tWHERE ABAG.BillingPeriod = @BillingPeriod AND ABAG.BillingPeriodRevision <> ABAG.BillingPeriod\r\n\t\t\t\tGROUP BY AA.UniqueSeqId) AS Adjustments\r\n\t\t\tON Adjustments.AccountUniqueSeqid = CurrentRecords.UniqueSeqID\r\n\t\tUNION ALL\r\n\t\t--******************************** National Grid Gas block ***************************************************************************************\r\n\t\t-- current period\r\n\t\tSELECT * FROM\r\n\t\t\t(SELECT AA.UniqueSeqID, \r\n\t\t\t\tABACG.RevisedBilledAmount as RevisedBilledAmount,\r\n\t\t\t\tAB.PaidAdjustmentAmount AS PaidAdjustmentAmount , \r\n\t\t\t\tManualPaymentOverrideAmount AS ManualPaymentOverrideAmount ,\r\n\t\t\t\tISNULL( ABACG.AccountArrears, 0) AS Arrears, \r\n\t\t\t\tISNULL(ABACG.MiscellaneousChargeAmount, 0) + ISNULL(ABACG.MiscellaneousCreditAmount, 0) AS MiscCharges,\r\n\t\t\t\tAB.TotalAmountDue\r\n\t\t\tFROM @AgencyAccounts AS AA\r\n\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentCrisGas ABACG ON ABACG.AccountSeqid = AA.AccountSeqid\r\n\t\t\t\tLEFT JOIN Billing.AccountBilling AS AB ON AB.AccountBillingSeqid = ABACG.AccountBillingSeqid\r\n\t\t\tWHERE ABACG.BillingPeriod = @BillingPeriod AND ABACG.BillingPeriodRevision = @BillingPeriod) AS CurrentRecords\r\n\t\t\tINNER JOIN (SELECT AA.UniqueSeqId AS AccountUniqueSeqid,\r\n\t\t\t\t\tMIN(ABACG.BillingPeriodRevision) FirstRevisedBillingPeriod,\r\n\t\t\t\t\tSUM(ABACG.CancelBilledAmount) CancelledCharges,\r\n\t\t\t\t\tSUM(ABACG.RevisedBilledAmount) AdjustedPeriodsCharges\t\t\t\r\n\t\t\t\tFROM @AgencyAccounts AS AA\r\n\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentCrisGas ABACG ON ABACG.AccountSeqid = AA.AccountSeqid\r\n\t\t\t\tWHERE ABACG.BillingPeriod = @BillingPeriod AND ABACG.BillingPeriodRevision <> ABACG.BillingPeriod\r\n\t\t\t\tGROUP BY AA.UniqueSeqId) AS Adjustments\r\n\t\t\tON Adjustments.AccountUniqueSeqid = CurrentRecords.UniqueSeqID\r\n\t\tUNION ALL\r\n\t\t--******************************** manual billing block ***************************************************************************************\r\n\t\t-- current period\r\n\t\tSELECT * FROM \r\n\t\t\t(SELECT \r\n\t\t\t\tAA.UniqueSeqID, \r\n\t\t\t\tABAPB.RevisedBilledAmount AS RevisedBilledAmount,\r\n\t\t\t\tAB.PaidAdjustmentAmount AS PaidAdjustmentAmount , \r\n\t\t\t\tAB.ManualPaymentOverrideAmount AS ManualPaymentOverrideAmount ,\r\n\t\t\t\tABAPB.PreviousAccountBalance AS Arrears, \r\n\t\t\t\tABAPB.LatePaymentAmount AS MiscCharges,\r\n\t\t\t\tAB.TotalAmountDue\r\n\t\t\tFROM @AgencyAccounts AS AA\r\n\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentPaperBill ABAPB ON ABAPB.AccountSeqid = AA.AccountSeqid\r\n\t\t\t\tLEFT JOIN Billing.AccountBilling AS AB ON AB.AccountBillingSeqid = ABAPB.AccountBillingSeqid\r\n\t\t\tWHERE ABAPB.BillingPeriod = @BillingPeriod AND ABAPB.BillingPeriodRevision = @BillingPeriod) AS CurrentRecords\r\n\t\t\tINNER JOIN (SELECT AA.UniqueSeqId AS AccountUniqueSeqid,\r\n\t\t\t\t\tMIN(ABAPB.BillingPeriodRevision) FirstRevisedBillingPeriod,\r\n\t\t\t\t\tSUM(ABAPB.CanceledBilledAmount) CancelledCharges,\r\n\t\t\t\t\tSUM(ABAPB.RevisedBilledAmount) AdjustedPeriodsCharges\t\t\t\r\n\t\t\t\tFROM @AgencyAccounts AS AA\r\n\t\t\t\tINNER JOIN Billing.AccountBillingAdjustmentPaperBill ABAPB ON ABAPB.AccountSeqid = AA.AccountSeqid\r\n\t\t\t\tWHERE ABAPB.BillingPeriod = @BillingPeriod AND ABAPB.BillingPeriodRevision <> ABAPB.BillingPeriod\r\n\t\t\t\tGROUP BY AA.UniqueSeqId) AS Adjustments\r\n\t\t\tON Adjustments.AccountUniqueSeqid = CurrentRecords.UniqueSeqID)\r\n\r\n\tSELECT UC.ShortDesc AS Utility,\r\n\t\tAD.AgencyName AS Agency,\r\n\t\tAD.AgencyCodeOEC AS AgencyCode,\r\n\t\tF.FacilityName AS Facility,\r\n\t\tF.OecFacilityNumber AS OECID,\r\n\t\tF.Address1 AS FacilityAddress,\r\n\t\tA.CurrentAccountNumber AS AccountNumber, \r\n\t\tEDT.EnergyType,\r\n\t\tCTE.FirstRevisedBillingPeriod AS EarliestPeriodAdjusted,\r\n\t\t@BillingPeriodIssued AS BillingPeriodIssued,\r\n\t\tCTE.Arrears AS OutstandingPreviousBalance,\r\n\t\tCTE.PaidAdjustmentAmount AS NetAdjustedCharges,\r\n\t\tCTE.RevisedBilledAmount AS CurrentPeriodCharges,\r\n\t\tCTE.AdjustedPeriodsCharges,\r\n\t\tCTE.CancelledCharges,\r\n\t\tCTE.ManualPaymentOverrideAmount AS TotalPayment,\r\n\t\tCTE.TotalAmountDue AS UtilityTotalAmountDue,\r\n\t\tCTE.MiscCharges AS CurrentPeriodMiscCharges,\r\n\t\tA.UtilityServiceAddress,\r\n\t\tA.UniqueAccountSeqid AS UniqueAccountSeqId\r\n\tFROM CTE_ALLAdjustements AS CTE\r\n\t\tINNER JOIN Billing.UniqueAccountMapping AS UAM ON CTE.UniqueSeqId = UAM.UniqueSeqId\r\n\t\tINNER JOIN billing.Account AS A ON A.AccountSeqid = UAM.AccountSeqid\r\n\t\tINNER JOIN Billing.AgencyDivision AS AD ON AD.AgencyDivisionSeqid = A.AgencyAccount\r\n\t\tINNER JOIN Billing.Facility AS F ON F.FacilitySeqid = A.FacilityAccount\r\n\t\tINNER JOIN Billing.UtilityCompany AS UC ON UC.UtilityCompanySeqid = A.UtilityAccountProvider\r\n\t\tINNER JOIN Billing.InvoiceAccountGroup AS IAG ON IAG.InvoiceAccountGroupSeqid = A.CurrentInvoiceAccountGroup\r\n\t\tINNER JOIN Billing.EnergyDeliveryType AS EDT ON EDT.EnergyDeliveryType = A.EnergyAccountDescription\r\n\tWHERE UAM.isCurrentAccount = 'Y'\r\n\tORDER BY AD.AgencyCodeOEC;\r\nEND;"
        }
      ]
    }
  ]
}