{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "SBMR",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_Export_SingleSBMRData",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_Export_SingleSBMRData",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to retrieve detailed information about a specific SBMR (Service Billing and Metering Request) entry from the database. It consolidates data from multiple related tables to provide a comprehensive view of the SBMR, including reference numbers, dates, addresses, agency details, contact information, service classification, action requested, energy type, and account/meter numbers. This procedure is useful for exporting or reporting purposes where a single SBMR's data needs to be extracted and reviewed."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple table joins, including a full outer join, which can be complex to understand and maintain."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The use of COALESCE and ISNULL functions adds a layer of complexity in handling potential null values."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure consolidates data from various domains (billing, contact, energy), requiring a good understanding of the database schema."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SBMRHeaderSeqId seqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This is the sole input parameter, representing the unique identifier for the SBMR header. It is used to filter and retrieve data specific to the SBMR entry of interest."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure begins by selecting various fields from the "
                },
                {
                  "type": "text",
                  "text": "SBMRHeader",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, which serves as the primary source of SBMR data."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs a series of left joins to incorporate additional information from related tables:"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "SBMRAccount",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "SBMRMeter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " tables are joined using a full outer join to ensure that both account and meter information are captured, even if one is missing."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Facility",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "AgencyDivision",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "ContactAddress",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "SbmrAction",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " tables are joined to enrich the SBMR data with facility, agency, contact, and action details."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "EnergyDeliveryType",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is joined to provide the energy type associated with the SBMR."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure filters the results to only include data where the "
                },
                {
                  "type": "text",
                  "text": "SBMRHeaderSeqId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " matches the input parameter, ensuring that only the relevant SBMR entry is returned."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The full outer join between "
                },
                {
                  "type": "text",
                  "text": "SBMRAccount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "SBMRMeter",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " could potentially lead to performance issues if these tables are large, as it combines all rows from both tables."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The use of multiple left joins can also impact performance, especially if the joined tables are large or lack proper indexing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Ensuring that "
                },
                {
                  "type": "text",
                  "text": "SBMRHeaderSeqId",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and other key columns used in joins are indexed can help improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure's performance may degrade if the underlying tables grow significantly, necessitating periodic review and optimization."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The full outer join may result in a larger dataset than expected if there are mismatches between account and meter data, which could lead to performance bottlenecks or unexpected results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "If any of the joined tables have missing or incorrect foreign key relationships, it could lead to incomplete or inaccurate data being returned."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The use of COALESCE and ISNULL functions, while handling nulls, may mask underlying data issues that should be addressed at the data integrity level."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Changes to the schema of any of the involved tables (e.g., renaming columns, changing data types) could break the procedure, requiring updates to the SQL code."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [SBMR].[usp_Export_SingleSBMRData]\n    @SBMRHeaderSeqId seqid\r\nAS \r\n    BEGIN\r\n\r\n\r\n        SELECT  SbmrReferenceNumber AS [SBMR #] ,\r\n\t\t\t\tsh.DateSBMRReceived [Date URIF Received] ,\r\n                sh.RequestedAccountEffectiveDate [Requested Action Effective Date] ,\r\n                sh.ELOAddress AS [Location] ,\r\n                sh.BillingAddress AS [Billing Address] ,\r\n                f.Address1 AS Building ,\r\n                ad.AgencyName AS [Agency Name] ,\r\n                ca.ContactName [Access Name] ,\r\n                ca.ContactTelephoneNumber [Access Tel #] ,\r\n                ad.AgencyCodeOEC [Agency #] ,\r\n                caC.ContactName AS [Contractor] ,\r\n                caC.ContactTelephoneNumber AS [Contractor Tel #] ,\r\n                ISNULL(sh.ServiceClassification, '') AS [Service Classification] ,\r\n                ac.Description AS [Action Requested] ,\r\n\t\t\t\tedt.EnergyType AS EnergyType,\r\n                AccountMeter.CurrentAccountNumber ,\r\n                AccountMeter.CurrentMeterNumber ,\r\n                sh.ExternalNote\r\n        FROM SBMR.SBMRHeader AS sh\r\n                LEFT JOIN ( SELECT    COALESCE(sa.SBMRHeaderSeqid,\r\n                                                     sm.SBMRHeaderSeqid) AS SBMRHeaderSeqId ,\r\n                                            sa.CurrentAccountNumber ,\r\n                                            sm.CurrentMeterNumber\r\n                                  FROM   ( SELECT    CurrentAccountNumber ,\r\n                                                        SBMRHeaderSeqid\r\n                                              FROM   SBMR.SBMRAccount\r\n                                              WHERE SBMRHeaderSeqid = @SBMRHeaderSeqId\r\n                                            ) AS sa\r\n                                            FULL OUTER JOIN ( SELECT\r\n                                                              CurrentAccountNumber ,\r\n                                                              CurrentMeterNumber ,\r\n                                                              SBMRHeaderSeqid\r\n                                                              FROM\r\n                                                              SBMR.SBMRMeter\r\n                                                              WHERE\r\n                                                              SBMRHeaderSeqid = @SBMRHeaderSeqId\r\n                                                            ) AS sm ON sa.CurrentAccountNumber = sm.CurrentAccountNumber\r\n                                ) AS AccountMeter ON sh.SbmrHeaderSeqId = AccountMeter.SbmrHeaderseqId\r\n                LEFT JOIN Billing.Facility AS f ON sh.FacilitySeqid = f.FacilitySeqid\r\n                LEFT JOIN Billing.AgencyDivision AS ad ON sh.AgencyDivisionSeqid = ad.AgencyDivisionSeqid\r\n                LEFT JOIN Contact.ContactAddress AS ca ON sh.ContactFacilityAccessSeqid = ca.ContactaddressSeqid\r\n                LEFT JOIN Contact.ContactAddress AS caC ON sh.contactContractorSeqid = caC.ContactaddressSeqid\r\n                LEFT JOIN sbmr.SbmrAction AS ac ON sh.SBMRAction = ac.SbmrActionSeqid\r\n\t\t\t\t\r\n\t\t\t\tLEFT JOIN Billing.EnergyDeliveryType AS edt\r\n\t\t\t\tON sh.EnergySource = edt.EnergyDeliveryType\r\n        WHERE   sh.SBMRHeaderSeqid = @SBMRHeaderSeqId\r\n    END"
        }
      ]
    }
  ]
}