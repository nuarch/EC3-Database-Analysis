{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ConEd",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Archive_usp_IdentifyRefundsForGasRate036",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "[ConEd].[Archive_usp_IdentifyRefundsForGasRate036]",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to identify and process refunds related to Con Edison Gas Rate \"036\" and \"040\". It performs operations to adjust billing records and remove cancellation records for specific billing periods where refunds are applicable. The procedure updates billing adjustments and deletes cancellation records once the refunds are correctly applied."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity level is considered medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure involves multiple conditional checks and operations based on the results of these checks."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It performs updates and deletions across multiple tables, requiring careful handling of data integrity."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The logic involves joining multiple tables and handling both single-period and spanned refunds."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": This parameter is intended to capture the ID of the user executing the procedure. However, it is not utilized within the procedure, suggesting it might be included for logging or auditing purposes outside the scope of this procedure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure begins by declaring a variable "
                },
                {
                  "type": "text",
                  "text": "@GasRate036RefundCount",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to store the count of refund records that meet specific criteria."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Single Period Refund Identification",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "It counts records in "
                        },
                        {
                          "type": "text",
                          "text": "ConEd.UploadConEdisonCancellationSummary",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " that meet the criteria for a refund (e.g., zero CCF and Therms, non-zero canceled amount, and specific gas rate codes)."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If refunds are identified ("
                        },
                        {
                          "type": "text",
                          "text": "@GasRate036RefundCount <> 0",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "), it updates the "
                        },
                        {
                          "type": "text",
                          "text": "ConEd.UploadConEdisonAccountBillingAdjustmentGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table to apply the refund adjustments."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "After applying the adjustments, it deletes the corresponding records from "
                        },
                        {
                          "type": "text",
                          "text": "ConEd.UploadConEdisonCancellationSummary",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Spanned Refund Identification",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Similar logic is applied to identify and process refunds that span multiple periods using the "
                        },
                        {
                          "type": "text",
                          "text": "ConEd.UploadConEdisonCancellationTempSummarySpanned",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If applicable refunds are found, the procedure updates the "
                        },
                        {
                          "type": "text",
                          "text": "ConEd.UploadConEdisonAccountBillingAdjustmentGas",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table and deletes the processed records from "
                        },
                        {
                          "type": "text",
                          "text": "ConEd.UploadConEdisonCancellationTempSummarySpanned",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure ensures that once refunds are applied, the cancellation records are removed to maintain data integrity and prevent duplicate processing."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the tables involved in joins and where clauses are properly indexed to optimize query performance, especially given the potential size of the datasets."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Consider the impact of concurrent executions of this procedure, as it involves updates and deletions that could lead to locking issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the dataset is large, consider processing records in batches to reduce transaction size and potential locking."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Unused Parameter",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " parameter is not used within the procedure, which could lead to confusion or missed opportunities for logging or auditing."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure deletes records from cancellation tables, which could lead to data loss if not handled correctly. Ensure that backups or logs are maintained."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete transactions. Consider adding try-catch blocks or transaction management."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the dataset grows, the performance of the procedure may degrade if not optimized for large-scale operations."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [ConEd].[Archive_usp_IdentifyRefundsForGasRate036] (@AuthenticatedUserID int)\nAS\r\n\r\n--**************************************************************************************\r\n--* Name:         \r\n--*\r\n--* Description:  \r\n--*               \r\n--*               \r\n--*               \r\n--* Exec:         usp_IdentifyAndCorrectMeterDataFromAndToDate\r\n--*\r\n--* Parameter(s):         \r\n--*                            UtilityCompanySeqid int   \t   - The sequence id of the Utility Companyto be processed\r\n--*                            StatusCode  int output       \t   -  Execution Return Status \r\n--*\r\n--* Database:     OEC\r\n--*\r\n--* Return:\t    0 Success\r\n--*                   9 Failure\r\n--*\r\n--* AUTHOR:       Peter Heller (PAH)\r\n--* Created On:   10/26/2005\r\n--**************************************************************************************\r\n--* Date         Tech Description of Change\r\n--* ---------- ----  -------------------------------------------------------------\r\n--* 05/16/2006 PAH  First Version  \r\n--***************************************************************************************\r\nBegin \r\n--************************************************************************************** \r\n--Declare Variables                                            \r\n--**************************************************************************************\r\n--\r\n--\tCon Edison Gas Rate \"036\" potentially can report a refund of minimum charges for a select group of period(s).  These refunds will be applied to the\r\n--\tcurrent billing period as a net billed adjustment by netting the original billed amount and the refund.  It will be noted in the notes.\r\n--\tThis characteristics of the refund are as follows:\r\n--\t\t\tCCF must equal zero\r\n--\t\t\tTherms  must equal zero\r\n--\t\t\tBilledAmount  must equal non-zero (Probably less than zero)\r\n--\t\t\tTariffCode must be '036'\r\n--\t\t\tBillingPeriod is the current billing period\r\n--\r\n--\t\r\n--\tCon Edison Gas Rate \"036\" refund is being reported incorrectly.  The way should be rebill the correct billing amount as a rebill and cancel \r\n--\tthe revised billed amount.\r\n--\r\ndeclare @GasRate036RefundCount int\r\n--\r\nSELECT @GasRate036RefundCount = isnull(count(*) ,0)\r\nFROM \r\n\t\tConEd.UploadConEdisonCancellationSummary INNER JOIN\r\n\t\tConEd.UploadConEdisonAccountSummary ON \r\n\t\tConEd.UploadConEdisonCancellationSummary.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod AND \r\n\t\tConEd.UploadConEdisonCancellationSummary.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision AND \r\n\t\tConEd.UploadConEdisonCancellationSummary.OriginalAccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\nWHERE \r\n\t\t(ConEd.UploadConEdisonCancellationSummary.CancelTotalCCF = 0) AND \r\n\t\t(ConEd.UploadConEdisonCancellationSummary.CancelTotalTherms = 0) AND \r\n\t\t(ConEd.UploadConEdisonCancellationSummary.TotalCanceledAmount <> 0) AND \r\n\t\t(ConEd.UploadConEdisonCancellationSummary.GasRateCode in ('036','040'))\r\n\r\n--\tOne Period Refund\r\n--\r\nif (@GasRate036RefundCount <> 0 )\r\nbegin\r\n\t--\r\n\t--\tNote:\tThe workflow has the UploadConEdisonAccountSummary (Rebilled data) loaded into the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tprior to working on the cancellation data.  The correction is being applied to the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tinstead of the ConEd.UploadConEdisonAccountSummary.\r\n\t--\t\r\nUPDATE    ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\nSET             \r\n\t\tNotes = \r\n\t\t\t\tCAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount\r\n\t\t\t\tAS varchar(18)) \r\n\t\t\t\t+ ' net Charge for rate '+ConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode+' for the Current period (' + ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod + ') net rebilled amount: ' + CAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount\r\n\t\t\t\tAS varchar(18)) + ' refunded amount: ' + CAST(ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount AS varchar(18))+\r\n\t\t\t\t' refunded Therms(CCF): '+ CAST(ConEd.UploadConEdisonRate036Refunds.RefundTherms AS varchar(18))+'('+\r\n\t\t\t\tCAST(ConEd.UploadConEdisonRate036Refunds.RefundCCF AS varchar(18))+')', \r\n\t\tTotalRebilledAmount = ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount,\r\n\t\tTotalCanceledAmount = 0, \r\n\t\tTotalCCF = TotalCCF + ConEd.UploadConEdisonRate036Refunds.RefundCCF, \r\n\t\tTotalTherms =TotalTherms + ConEd.UploadConEdisonRate036Refunds.RefundTherms, \r\n\t\tCancelTotalTherms =0,\r\n\t\tCancelTotalCCF=0\r\nFROM \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas INNER JOIN\r\n\t\tConEd.UploadConEdisonRate036Refunds ON \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod = ConEd.UploadConEdisonRate036Refunds.BillingPeriod AND \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriodRevision = ConEd.UploadConEdisonRate036Refunds.BillingPeriodRevision AND \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.OriginalAccountNumber = ConEd.UploadConEdisonRate036Refunds.AccountNumber AND \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode = ConEd.UploadConEdisonRate036Refunds.TariffCode\r\n    --\r\n\t--    Once the refund is applied correctly to the ConEd.UploadConEdisonAccountBillingAdjustmentGas.  The cancellation record will be removed.\r\n\t--\r\n\tdelete from ConEd.UploadConEdisonCancellationSummary\r\n\tFROM \r\n\t\t\tConEd.UploadConEdisonCancellationSummary INNER JOIN\r\n\t\t\tConEd.UploadConEdisonAccountSummary ON \r\n\t\t\tConEd.UploadConEdisonCancellationSummary.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod AND \r\n\t\t\tConEd.UploadConEdisonCancellationSummary.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision AND \r\n\t\t\tConEd.UploadConEdisonCancellationSummary.OriginalAccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\n\tWHERE \r\n\t\t\t(ConEd.UploadConEdisonCancellationSummary.CancelTotalCCF = 0) AND \r\n\t\t\t(ConEd.UploadConEdisonCancellationSummary.CancelTotalTherms = 0) AND \r\n\t\t\t(ConEd.UploadConEdisonCancellationSummary.TotalCanceledAmount <> 0) AND \r\n\t\t\t(ConEd.UploadConEdisonCancellationSummary.GasRateCode in ('036','040')) and\r\n            (ConEd.UploadConEdisonCancellationSummary.NumberOfBillingPeriods = 12)\r\n\t--\r\n\tset @GasRate036RefundCount = 0\r\n\r\nend\r\n--\r\nSELECT @GasRate036RefundCount = isnull(count(*) ,0)\r\nFROM \r\n\t\tConEd.UploadConEdisonCancellationTempSummarySpanned INNER JOIN\r\n\t\tConEd.UploadConEdisonAccountSummary ON \r\n\t\tConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod AND \r\n\t\tConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision AND\r\n\t\tConEd.UploadConEdisonCancellationTempSummarySpanned.AccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\nWHERE \r\n\t\t(ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelCCF = 0) AND \r\n\t\t(ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelTherms = 0) AND \r\n\t\t(ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelBilledAmount <> 0) AND \r\n\t\t( ConEd.UploadConEdisonAccountSummary.GasRateCode in ('036','040'))\r\n--\r\n--\tSpanned Refund\r\n--\r\nif (@GasRate036RefundCount <> 0 )\r\nBEGIN\r\n\t--\r\n\t--\tNote:\tThe workflow has the UploadConEdisonAccountSummary (Rebilled data) loaded into the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tprior to working on the cancellation data.  The correction is being applied to the ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\n\t--\t\t\tinstead of the ConEd.UploadConEdisonAccountSummary.\r\n\t--\t\t\t\r\nUPDATE    ConEd.UploadConEdisonAccountBillingAdjustmentGas\r\nSET             \r\n\t\tNotes = \r\n\t\t\t\tCAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount\r\n\t\t\t\tAS varchar(18)) \r\n\t\t\t\t+ ' net Charge for rate '+ConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode+' for the Current period (' + ConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod + ') net rebilled amount: ' + CAST(ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount\r\n\t\t\t\tAS varchar(18)) + ' refunded amount: ' + CAST(ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount AS varchar(18))+\r\n\t\t\t\t' refunded Therms(CCF): '+ CAST(ConEd.UploadConEdisonRate036Refunds.RefundTherms AS varchar(18))+'('+\r\n\t\t\t\tCAST(ConEd.UploadConEdisonRate036Refunds.RefundCCF AS varchar(18))+')', \r\n\t\tTotalRebilledAmount = ConEd.UploadConEdisonAccountBillingAdjustmentGas.TotalRebilledAmount + ConEd.UploadConEdisonRate036Refunds.RefundBilledAmount,\r\n\t\tTotalCanceledAmount = 0, \r\n\t\tTotalCCF = TotalCCF + ConEd.UploadConEdisonRate036Refunds.RefundCCF, \r\n\t\tTotalTherms =TotalTherms + ConEd.UploadConEdisonRate036Refunds.RefundTherms, \r\n\t\tCancelTotalTherms =0,\r\n\t\tCancelTotalCCF=0\r\nFROM \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas INNER JOIN\r\n\t\tConEd.UploadConEdisonRate036Refunds ON \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriod = ConEd.UploadConEdisonRate036Refunds.BillingPeriod AND \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.BillingPeriodRevision = ConEd.UploadConEdisonRate036Refunds.BillingPeriodRevision AND \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.OriginalAccountNumber = ConEd.UploadConEdisonRate036Refunds.AccountNumber AND \r\n\t\tConEd.UploadConEdisonAccountBillingAdjustmentGas.GasRateCode = ConEd.UploadConEdisonRate036Refunds.TariffCode\r\n\t--\r\n\t--\tOnce the refund is applied correctly to the ConEd.UploadConEdisonAccountBillingAdjustmentGas.  The cancellation record will be removed.\r\n\t--\r\n\tdelete from ConEd.UploadConEdisonCancellationTempSummarySpanned\r\n\tFROM \r\n\t\t\tConEd.UploadConEdisonCancellationTempSummarySpanned INNER JOIN\r\n\t\t\tConEd.UploadConEdisonAccountSummary ON \r\n\t\t\tConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriod = ConEd.UploadConEdisonAccountSummary.BillingPeriod AND \r\n\t\t\tConEd.UploadConEdisonCancellationTempSummarySpanned.BillingPeriodRevision = ConEd.UploadConEdisonAccountSummary.BillingPeriodRevision AND\r\n\t\t\tConEd.UploadConEdisonCancellationTempSummarySpanned.AccountNumber = ConEd.UploadConEdisonAccountSummary.OriginalAccountNumber\r\n\tWHERE \r\n\t\t\t(ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelCCF = 0) AND \r\n\t\t\t(ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelTherms = 0) AND \r\n\t\t\t(ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelBilledAmount <> 0) AND \r\n\t\t\t(ConEd.UploadConEdisonCancellationTempSummarySpanned.CancelTariffCode in ('036','040')) \r\n\t--\r\n\tset @GasRate036RefundCount = 0\r\n\r\nend\r\n\r\n\r\n--\r\n\r\nend"
        }
      ]
    }
  ]
}