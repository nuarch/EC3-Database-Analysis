{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Billing",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_TurnOffAccountandRelatedMeters",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_TurnOffAccountandRelatedMeters",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to deactivate a customer account and its associated meters within a billing system. It updates the account's status to indicate it is turned off and processes each related meter to ensure they are also deactivated. The procedure includes error handling and transaction management to maintain data integrity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including validation, transaction management, cursor operations, and error handling. While it is not overly complex, the use of cursors and nested procedure calls adds to its complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AccountSeqID AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for the account to be turned off."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AccountEffectiveTurnOff AS VARCHAR(8)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The effective date for the account turn-off."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@TurnOffDate AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The date when the account is turned off. Defaults to the current billing period if not provided."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Notes AS notes",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Additional notes regarding the account turn-off. Defaults to a standard message if not provided."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user performing the operation, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode AS INT OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter indicating the success (1) or failure (0) of the operation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Message AS VARCHAR(1000) OUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter providing a message about the operation's result or error details."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization and Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieve the current account number and billing period."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Set default values for "
                        },
                        {
                          "type": "text",
                          "text": "@TurnOffDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "@Notes",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " if they are not provided."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Validate that the account exists and is in an active status. If not, return an error message and status code."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Management",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Begin a transaction to ensure atomicity of the account and meter updates."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Account Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Update the account's status to '28' (turned off) and log the change with the current date, user ID, and notes."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Meter Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Use a cursor to iterate over each meter associated with the account that is not already turned off."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Call the "
                        },
                        {
                          "type": "text",
                          "text": "usp_TurnOffMeterByMeterSeqID",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " procedure for each meter."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If any meter fails to turn off, roll back the transaction and return an error message."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Completion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If all operations succeed, commit the transaction and set the status code to 1."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Use a "
                        },
                        {
                          "type": "text",
                          "text": "TRY...CATCH",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " block to handle errors, log them, and roll back the transaction if necessary."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cursor Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a cursor can be inefficient, especially if there are many meters associated with an account. Consider replacing it with a set-based operation if possible."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope includes both account and meter updates, which can lock resources for a longer duration. Ensure that the transaction is as short as possible to reduce locking contention."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The "
                },
                {
                  "type": "text",
                  "text": "RAISERROR",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " statement logs errors, which can be useful for debugging but may impact performance if errors are frequent."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure fails after updating the account but before processing all meters, it could leave the system in an inconsistent state. The transaction management mitigates this risk, but careful testing is required."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure may encounter locking issues if multiple users attempt to turn off the same account or related meters simultaneously."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Input Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes valid input formats for dates and other parameters. Additional validation may be necessary to prevent errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Messaging",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The error messages are generic and may not provide enough detail for troubleshooting without additional logging or context."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Description:\tAccountTurn Off\r\n--*\r\n--* AUTHOR:\t\t\tZafer Durmaz\t\r\n--* Created On:\t\t2016-02-29\r\n--**************************************************************************************\r\n--* Date       Tech Description of Change\r\n--* ---------- ---\t-------------------------------------------------------------\r\n--* 2016-02-29 zd  First Version \r\n--* 2016-03-23 MB  Added return message to allow to communicate to the app in case or error\r\n--* 2016-04-01 MB  Added AuthenticatedUsedID and some validation\r\n--***************************************************************************************\r\nCREATE PROCEDURE [Billing].[usp_TurnOffAccountandRelatedMeters]\r\n(\r\n\t@AccountSeqID AS INT,\r\n\t@AccountEffectiveTurnOff AS VARCHAR(8),\r\n\t@TurnOffDate AS VARCHAR(6),\r\n\t@Notes AS notes,\r\n\t@AuthenticatedUserID AS INT,\r\n\t@StatusCode AS INT OUTPUT,\r\n\t@Message AS VARCHAR(1000) OUT\r\n)\r\nAS \r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\r\n\tDECLARE @AccountNumber VARCHAR(15), @StatusCodePeriod VARCHAR(6);\r\n\r\n\tSELECT @AccountNumber = CurrentAccountNumber FROM Billing.Account WHERE AccountSeqid = @AccountSeqID;\r\n\tSELECT @StatusCodePeriod = BillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\r\n\tIF (@TurnOffDate IS NULL)\r\n\tBEGIN\r\n\t\tSELECT @TurnOffDate = BillingPeriod FROM Billing.ApplicationTimeFrame WHERE CurrentProcessingPeriod = 'Y';\r\n\tEND;\r\n\r\n\tIF (@Notes IS NULL)\r\n\tBEGIN\r\n\t\tSET @Notes = 'Account is turned off by DEM.';\r\n\tEND;\r\n\r\n\t-- some validation\r\n\t-- verify the account exists under an active status\r\n\tIF (NOT EXISTS(SELECT * FROM Billing.Account WHERE AccountSeqid = @AccountSeqID AND AccountStatus IN ('AC' , '47', '46', 'UA')))\r\n\tBEGIN\r\n\t\tSELECT @Message = 'The account number ' + @AccountNumber + ' does not exist in the system under an active status. Please verify.', @StatusCode = 0;\r\n\t\treturn\r\n\tEND;\r\n\r\n\tBEGIN TRY\r\n\t\tBEGIN TRANSACTION\r\n\r\n\t\t--\tUpdate Account turn Off 28\r\n\t\tUPDATE  Billing.Account\r\n\t\tSET AccountPreviousStatus\t= AccountStatus\r\n\t\t\t,AccountStatus\t\t\t= '28'\r\n\t\t\t,AccountStatusCodePeriod= @StatusCodePeriod\r\n\t\t\t,AccountEffectiveTurnOff= @AccountEffectiveTurnOff\r\n\t\t\t,TurnOffDate\t\t\t= @TurnOffDate\r\n\t\t\t,LastUpdate\t\t\t\t= GETDATE()\r\n\t\t\t,AuthenticatedUserID\t= @AuthenticatedUserID\r\n\t\t\t,Notes\t\t\t\t\t= @Notes\r\n\t\t\t,FireAuditTrigger\t\t= 'Y'\r\n\t\tWHERE AccountSeqid\t\t\t= @AccountSeqID;\r\n\r\n\t\tIF EXISTS(SELECT MeterSeqid FROM Billing.Meter WHERE OriginalAccountNumber = @AccountNumber AND MeterStatus NOT IN ('27','28','45','AX'))\r\n\t\tBEGIN\r\n\t\t\tDECLARE meterturnoff_cursor CURSOR LOCAL FOR SELECT MeterSeqid\r\n\t\t\t\tFROM Billing.Meter AS M\r\n\t\t\t\t\tINNER JOIN Billing.AccountExchangeMeterTrack AS AEMT ON AEMT.OriginalMeterSeqid = M.MeterSeqid\r\n\t\t\t\t\tINNER JOIN  Billing.Account AS A ON A.AccountSeqid = AEMT.OriginalAccountSeqid\r\n\t\t\t\tWHERE A.AccountSeqid = @AccountSeqID AND M.MeterStatus NOT IN ('27','28','45','AX');\r\n\r\n\t\t\tDECLARE @MeterSeqid INT, @MeterStatusCode INT, @MeterMessage VARCHAR(1000);\r\n\r\n\t\t\tOPEN meterturnoff_cursor\r\n\t\t\tFETCH NEXT FROM meterturnoff_cursor INTO @MeterSeqid\r\n\t\t\tWHILE @@FETCH_STATUS = 0\r\n\t\t\tBEGIN \r\n\t\t\t\tEXECUTE [Billing].[usp_TurnOffMeterByMeterSeqID] @MeterSeqID, @AccountEffectiveTurnOff, @TurnOffDate, @AuthenticatedUserID, @Notes, @MeterStatusCode, @MeterMessage \t\r\n\t\t\t\t\t\r\n\t\t\t\t-- if meter fails, then roll back\r\n\t\t\t\tIF (@MeterStatusCode = 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tROLLBACK TRANSACTION\r\n\t\t\t\t\tCLOSE meterturnoff_cursor    \r\n\t\t\t\t\tDEALLOCATE meterturnoff_cursor\r\n\r\n                    SELECT @StatusCode = 0, @Message = @MeterMessage;\r\n\t\t\t\tEND;\t \r\n\t\t\t\t\t\r\n\t\t\t\tFETCH NEXT FROM meterturnoff_cursor INTO @MeterSeqid\r\n\t\t\tEND;\r\n\r\n\t\t\tCLOSE meterturnoff_cursor    \r\n\t\t\tDEALLOCATE meterturnoff_cursor\r\n\t\tEND;\r\n\r\n\t\tSELECT @StatusCode = 1, @Message = '';\r\n\t\tCOMMIT TRANSACTION;\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n\t\tDECLARE @ErrorMessage NVARCHAR(4000), @ErrorSeverity INT, @ErrorState INT, @ErrorNumber INT, @ErrorLine INT, @ErrorProcedure NVARCHAR(126);\r\n\t\t\r\n\t\tSELECT\r\n\t\t\t@ErrorMessage ='Please contact IT with a screen shot of this error message! ' + ERROR_MESSAGE(),\r\n\t\t\t@ErrorSeverity = ERROR_SEVERITY(),\r\n\t\t\t@ErrorState = ERROR_STATE(),\r\n\t\t\t@ErrorNumber = ERROR_NUMBER(),\r\n\t\t\t@ErrorProcedure = ERROR_PROCEDURE(),\r\n\t\t\t@ErrorLine = ERROR_LINE();\r\n\t\t\r\n\t\tRAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState, @ErrorProcedure, @ErrorLine) WITH LOG;\r\n\t\t\t\t\t\t\r\n\t\tSELECT @StatusCode  = 0, @Message = @ErrorMessage;\r\n\t\t\t\t\t\t\t\t   \r\n\t\tROLLBACK TRAN;\r\n\tEND CATCH;\r\nEND;"
        }
      ]
    }
  ]
}