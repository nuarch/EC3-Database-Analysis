{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "CrisNationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ProcessExchangeCode_ReactivateAccount",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ProcessExchangeCode_ReactivateAccount",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to reactivate an account that has been previously turned off. This is particularly relevant for accounts managed by National Grid, where accounts may be temporarily deactivated and then reactivated after a few billing periods. The procedure ensures continuity of billing by updating the account and associated meter statuses back to active."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple database operations, including validation checks, updates across several tables, and error handling with transaction management. While the logic is straightforward, the involvement of multiple tables and the need for transaction handling elevate its complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AuthenticatedUserID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure, used for logging purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@AccountSeqid int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The unique identifier for the account to be reactivated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current billing period, used to update status code periods."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@UtilityCompanySeqid int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The identifier for the utility company, though not directly used in the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode int OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter indicating the success (0) or failure (1) of the procedure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Checks if the account exists using "
                        },
                        {
                          "type": "text",
                          "text": "@AccountSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Verifies that the account status is '28', indicating it is turned off."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Management",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Begins a transaction named "
                        },
                        {
                          "type": "text",
                          "text": "AccountReactivation",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Account Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates the account status to 'AC' (active) and sets various fields like "
                        },
                        {
                          "type": "text",
                          "text": "AccountPreviousStatus",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "AccountStatusCodePeriod",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "TurnOffDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", "
                        },
                        {
                          "type": "text",
                          "text": "AccountEffectiveTurnOff",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", and "
                        },
                        {
                          "type": "text",
                          "text": "Notes",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Meter Exchange Track Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountExchangeMeterTrack",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table for meters associated with the account, setting "
                        },
                        {
                          "type": "text",
                          "text": "AccountEffectiveBillingEndDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "MeterEffectiveBillingEndDate",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " to '99991231'."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Meter Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Updates the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Meter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table for meters with status '27' (turned off), setting them to 'AC' (active) and updating related fields."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Uses a "
                        },
                        {
                          "type": "text",
                          "text": "BEGIN TRY...END TRY",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " block to handle errors."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "If an error occurs, captures detailed error information and raises a custom error message."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Rolls back the transaction if any error is encountered."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Completion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Commits the transaction if all operations succeed."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "MeterSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " are indexed to optimize the SELECT and UPDATE operations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is appropriate, but ensure that the transaction does not lock resources for an extended period, which could impact performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Consider the impact of concurrent executions, especially if multiple accounts are being reactivated simultaneously."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": While errors are logged, the procedure raises errors with severity 12, which is informational. Consider using a higher severity for critical errors."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Dates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of '999912' and '99991231' as placeholder dates could lead to confusion or errors if not consistently managed across the system."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Unused Parameter",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": "
                },
                {
                  "type": "text",
                  "text": "@UtilityCompanySeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is not used within the procedure, which could lead to confusion or maintenance issues."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the system grows, the procedure may need optimization to handle larger volumes of data efficiently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Audit Trail",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure updates the "
                },
                {
                  "type": "text",
                  "text": "Notes",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " field with user information, but consider implementing a more robust audit trail mechanism for tracking changes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE PROCEDURE [CrisNationalGridWest].[usp_ProcessExchangeCode_ReactivateAccount] @AuthenticatedUserID int , @AccountSeqid int , @CurrentBillingPeriod varchar(6) , @UtilityCompanySeqid int , @StatusCode int  OUTPUT\n   \r\n AS \r\n \r\n--**************************************************************************************\r\n--* Name:         \r\n--*\r\n--* Description:\tstored procedure to reactivate account after it was turned off, \r\n--*\t\t\t\t\tthis happens occasionally with National Grid accounts where they lock certain accounts and \r\n--*\t\t\t\t\tturn them on few billing periods later. on our side, this provides continuity of billing on those accounts \r\n--*\t\t\t\t\t\r\n--*               \r\n--* Parameter(s):        \r\n--*\t\t\t\t\t@AuthenticatedUserID int\t\t- the seqid of the user that runs the stored procedure\t\r\n--*                 @AccountSeqid   int\t\t\t\t- The account id that needs to be reactivated\r\n--*\t\t\t\t\t@CurrentBillingPeriod\t\t\t\r\n--*                 @UtilityCompanySeqid int\t\t- The sequence id of the Utility Companyto be processed\r\n--*                 @StatusCode  int output\t\t\t- Execution Return Status \r\n--*\r\n--*\r\n--* Return:\t        0 Success\r\n--*                 1 Failure\r\n--*\r\n--* AUTHOR:       MOHAMMED BELARREM\r\n--* Created On:   11/09/2011\r\n--**************************************************************************************\r\n--* Date       Tech Description of Change\r\n--* ---------- ---\t-------------------------------------------------------------\r\n--* 11/09/2011 MOH  First Version \r\n--* 2016-12-13 zd  Updated 9999 99 date  to 999912\r\n--* 12/27/2018 VY   Modified to use Unique Seq IDs by removing joins with AccountExchangeMeterTrack table\r\n--***************************************************************************************\r\n\r\nBEGIN\r\n\t\r\n\t\t\t\r\n\t\tDECLARE @AccountNumber VARCHAR(15)\r\n\t\tDECLARE @AccountStatus VARCHAR(2)\r\n\t\r\n\t\t-- do some validation \r\n\r\n\t\t-- check if seqid exists\r\n\t\tIF ( NOT EXISTS (    \r\n\t\t\t\t\t\tSELECT * FROM Billing.Account \r\n\t\t\t\t\t\tWHERE (AccountSeqid = @AccountSeqid)\r\n\t\t   ) )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The account seqid %i does not exist. Please verfiy ', 12, 1, @AccountSeqid ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\r\n\r\n\t\tSELECT \r\n\t\t\t@AccountNumber\t\t\t= OriginalAccountNumber, \r\n\t\t\t@AccountStatus\t\t\t= AccountStatus\t\t\t\t\r\n\t\tFROM Billing.Account\r\n\t\tWHERE   (AccountSeqid = @AccountSeqid)\r\n\r\n\t\t\r\n\t\t-- check the obvious\r\n\t\tIF ( @AccountStatus <> '28' )\r\n\t\tBEGIN\r\n\t\t\tRAISERROR ('The account you are trying to reactivate is not turned off: account number %s ', 12, 1, @AccountNumber ) \r\n\t\t\tSET @StatusCode = 1\r\n\t\t\treturn\r\n\t\tEND\r\n\t\t\r\n\r\n\r\n\t\t\r\n\t\tbegin try\r\n\t\t--\r\n\t\t\r\n\t\t\t\tbegin transaction AccountReactivation\r\n\t\t\t\tset @StatusCode  = 0\r\n\t\t\r\n\r\n\t\t\t\t-- update the account\r\n\t\t\t\tUPDATE Billing.Account\r\n\t\t\t\tSET\t   AccountPreviousStatus\t= AccountStatus\r\n\t\t\t\t\t , AccountStatus\t\t\t= 'AC'\r\n\t\t\t\t\t , AccountStatusCodePeriod\t= @CurrentBillingPeriod\r\n\t\t\t\t\t , TurnOffDate\t\t\t\t= '999912'\r\n\t\t\t\t\t , AccountEffectiveTurnOff\t= '99991231'\r\n\t\t\t\t\t , FireAuditTrigger\t\t\t= 'Y'\r\n\t\t\t\t\t , Notes\t\t\t\t\t= 'Account was reactivated by AuthenticatedUserID: ' + CAST(@AuthenticatedUserID AS VARCHAR)\r\n\t\t\t\t\t , LastUpdate\t\t\t\t= GETDATE()\r\n\t\t\t\tFROM Billing.Account\r\n\t\t\t\tWHERE AccountSeqid = @AccountSeqid\r\n\t\t\t\t\r\n\r\n\t\t\t\t-- update the account meter exchange track\r\n\t\t\t\tUPDATE Billing.AccountExchangeMeterTrack\r\n\t\t\t\tSET\t\tAccountEffectiveBillingEndDate\t= '99991231'\r\n\t\t\t\t\t  , MeterEffectiveBillingEndDate\t= '99991231'\r\n\t\t\t\t\t  , FireAuditTrigger\t\t\t\t= 'Y'\r\n\t\t\t\t\t  , Notes\t\t\t\t\t\t\t= 'Account was reactivated by AuthenticatedUserID: ' + CAST(@AuthenticatedUserID AS VARCHAR)\r\n\t\t\t\t\t  , LastUpdate\t\t\t\t\t\t= GETDATE()\r\n\t\t\t\tFROM Billing.Account\r\n\t\t\t\tINNER JOIN Billing.AccountExchangeMeterTrack ON Billing.Account.AccountSeqid = Billing.AccountExchangeMeterTrack.OriginalAccountSeqid \r\n\t\t\t\tINNER JOIN Billing.Meter ON Billing.AccountExchangeMeterTrack.OriginalMeterSeqid = Billing.Meter.MeterSeqid \r\n\t\t\t\tWHERE Billing.Account.AccountSeqid = @AccountSeqid\r\n\t\t\t\t\t  AND MeterStatus = '27'  -- we only want to touch turned off meters\t\r\n\r\n\t\t\t\t\r\n\t\t\t\t-- update the meters\r\n\t\t\t\tUPDATE Billing.Meter\r\n\t\t\t\tSET\t\tMeterPreviousStatus\t\t= MeterStatus\r\n\t\t\t\t\t  , MeterStatus\t\t\t\t= 'AC'\r\n\t\t\t\t\t  , MeterStatusCodePeriod   = @CurrentBillingPeriod\r\n\t\t\t\t\t  , TurnOffDate\t\t\t\t= '999912'\r\n\t\t\t\t\t  , MeterEffectiveOffDate\t= '99991231'\r\n\t\t\t\t\t  , Notes\t\t\t\t\t= 'Meter turned back on as part of an account reactivation by AuthenticatedUserID: ' + CAST(@AuthenticatedUserID AS VARCHAR)\r\n\t\t\t\t\t  , LastUpdate\t\t\t\t= GETDATE()\r\n\t\t\t\t\t  , FireAuditTrigger\t\t= 'Y'\r\n\t\t\t\tFROM Billing.Account\r\n\t\t\t\tINNER JOIN Billing.AccountExchangeMeterTrack ON Billing.Account.AccountSeqid = Billing.AccountExchangeMeterTrack.OriginalAccountSeqid \r\n\t\t\t\tINNER JOIN Billing.Meter ON Billing.AccountExchangeMeterTrack.OriginalMeterSeqid = Billing.Meter.MeterSeqid \r\n\t\t\t\tWHERE Billing.Account.AccountSeqid = @AccountSeqid\r\n\t\t\t\t\t  AND MeterStatus = '27'  -- we only want to touch turned off meters\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t-- all went well commit\r\n\t\t\t\tcommit TRAN AccountReactivation;\r\n\t\t\t\t\t\t\r\n\t\tEND TRY\r\n\t\t\r\n\t\tBEGIN CATCH\r\n\t\t\t\tDECLARE @ExchangeErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorMessage NVARCHAR(4000);\r\n\t\t\t\tDECLARE @ErrorSeverity INT;\r\n\t\t\t\tDECLARE @ErrorState INT;\r\n\t\t\t\tDECLARE @ErrorNumber INT;\r\n\t\t\t\tDECLARE @ErrorLine INT;\r\n\t\t\t\tDECLARE @ErrorProcedure NVARCHAR(126);\r\n\t\t\t\tdeclare @crlf varchar(2)\r\n\t\t\t\t\r\n\t\t\t\tset @crlf = CHAR(13) + CHAR(10) \r\n\t\t\t\t--\r\n\t\t\t\tSELECT \r\n\t\t\t\t\t@ExchangeErrorMessage ='Error in StoredProcedure %s at line number %d'+@crlf+' Billing Period: %s'+@crlf+'Account: %s '+@crlf,\r\n\t\t\t\t\t@ErrorMessage = ERROR_MESSAGE(),\r\n\t\t\t\t\t@ErrorSeverity = ERROR_SEVERITY(),\r\n\t\t\t\t\t@ErrorState = ERROR_STATE(),\r\n\t\t\t\t\t@ErrorNumber = ERROR_NUMBER(),\r\n\t\t\t\t\t@ErrorProcedure = ERROR_PROCEDURE(),\r\n\t\t\t\t\t@ErrorLine = ERROR_LINE();\t\t\t\r\n\t\t\t\t--\r\n\t\t\t\t\tset\t@ErrorMessage = @ExchangeErrorMessage + @ErrorMessage+@crlf+'@ErrorNumber: '+cast(@ErrorNumber as varchar(10))+@crlf\r\n\t\t\t\t--\r\n\t\t\t\tRAISERROR (@ErrorMessage, -- Message text.\r\n\t\t\t\t\t\t   @ErrorSeverity, -- Severity.\r\n\t\t\t\t\t\t   @ErrorState, -- State.\r\n\t\t\t\t\t\t   @ErrorProcedure,\r\n\t\t\t\t\t\t   @ErrorLine,\r\n\t\t\t\t\t\t   @CurrentBillingPeriod,\r\n\t\t\t\t\t\t   @AccountNumber\r\n\t\t\t\t\t\t   ) with log;\r\n\t\t\t\t\r\n\t\t\t\tset @StatusCode  = 1\r\n\t\t\t\t\r\n\t\t\t\tROLLBACK tran AccountReactivation;\r\n\t\t\t\t\t   \r\n\t\tEND CATCH;\r\n\t\r\n\t\r\n\r\nEND"
        }
      ]
    }
  ]
}