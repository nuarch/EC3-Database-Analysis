{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "NationalGridWest",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_LegacyData_ProcessMeterCancellationSpanned",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_LegacyData_ProcessMeterCancellationSpanned",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to handle the processing of meter cancellation data that spans multiple billing periods. It performs several operations, including moving data into a temporary table, parsing spanned meter cancellation information, setting gas rate codes, merging summary data into an adjustment table, and updating or deleting records based on specific conditions. The procedure is part of the "
        },
        {
          "type": "text",
          "text": "NationalGridWest",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " schema and interacts with multiple tables within this schema to manage legacy data related to meter cancellations."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The complexity of this stored procedure is medium due to the following factors:"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It involves multiple steps and operations, including data insertion, updates, and deletions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It calls another stored procedure and uses several user-defined functions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It includes conditional logic and joins, which require careful handling of data relationships."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure manipulates data across several tables, which increases the complexity of understanding data flow and dependencies."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingPeriod varchar(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing period in the format "
                },
                {
                  "type": "text",
                  "text": "yyyymm",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@authenticatedID int",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An identifier for the authenticated user executing the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BillingCycle varchar(1)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Represents the billing cycle, which is used in determining billing periods."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A utility code is set to '2', which is used later in the procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Movement",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data from "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterCancellation",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is inserted into "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterCancellationTempSummarySpanned",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " if the "
                },
                {
                  "type": "text",
                  "text": "DeltaNumberOfPeriods",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is greater than 1. This step prepares the data for further processing."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Parsing Spanned Meter Cancellation Info",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The procedure calls "
                },
                {
                  "type": "text",
                  "text": "usp_LegacyData_ParseSpannedMeterCancellationInfo",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to parse and process the spanned meter cancellation data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Setting Gas Rate Code",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "The gas rate code is initially set to a default value of '020'."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "It is then updated to match the commodity tariff rate from the "
                },
                {
                  "type": "text",
                  "text": "Billing.Account",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table based on the original account number."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Merging Summary Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data from "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterCancellationSummary",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is merged into "
                },
                {
                  "type": "text",
                  "text": "UploadLegacyKeyspanWestMeterBillingAdjustmentGas",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Various calculations and aggregations are performed, such as determining the number of billing periods and calculating total billing days rebilled."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Handling Rebills and Cancels",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates are made to unite rebills with existing cancels."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cancels that had rebills are deleted."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Cancels without rebills are updated to set the "
                },
                {
                  "type": "text",
                  "text": "FromDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "ToDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " fields."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the tables involved, especially those with frequent joins and updates, are properly indexed to improve query performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Batch Processing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Consider processing data in batches if the volume is large to avoid locking and performance degradation."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of user-defined functions like "
                },
                {
                  "type": "text",
                  "text": "CalculateNumberOfBillingDays",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "DetermineBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can impact performance if not optimized."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple updates and deletions, which could lead to data integrity issues if not handled correctly, especially with concurrent executions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions and incomplete transactions."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of updates and deletes without transaction management could lead to race conditions or deadlocks in a high-concurrency environment."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The utility code and default gas rate code are hardcoded, which reduces flexibility and could lead to maintenance challenges if these values change."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- =============================================\n-- Author:\t\t<Author,,Name>\r\n-- Create date: <Create Date,,>\r\n-- Description:\t<Description,,>\r\n-- =============================================\r\nCREATE PROCEDURE [NationalGridWest].[usp_LegacyData_ProcessMeterCancellationSpanned]\r\n\t@BillingPeriod varchar(6),\r\n\t@authenticatedID int,\r\n\t@BillingCycle varchar(1)\r\nAS\r\nBEGIN\r\ndeclare @UtilityCode varchar(1)\r\nset @UtilityCode = '2'\r\n\r\n/**************************\r\n1. Move data into the upload spanned table\r\n***************************/\r\n\tINSERT INTO NationalGridWest.UploadLegacyKeyspanWestMeterCancellationTempSummarySpanned\r\n\t(\r\n\t\ttitle,\r\n\t\tAccountNumber,\r\n\t\tMeterNumber,\r\n\t\tBillingPeriod,\r\n\t\tBillingPeriodRevision,\r\n\t\tFirstPeriodCanceled,\r\n\t\tFromDate,\r\n\t\tToDate,\r\n\t\tThermFactor,\r\n\t\tCCF,\r\n\t\tDeltaNumberOfPeriods,\r\n\t\tReadingCode,\r\n\t\tFromReading,\r\n\t\tToReading,\r\n\t\tMeterConstant,\r\n\t\tTripNumber,\r\n\t\tDials,\r\n\r\n\t\tFacilityName,\r\n\t\tServiceAddress,\r\n\t\ttherms\r\n\t)\r\n\tSELECT \r\n\t\t'SpannedMeterbilling' AS title, \r\n\t\tAccountNumber,\r\n\t\tMeterNumber,\r\n\t\tBillingPeriod,\r\n\t\tBillingPeriodRevision,\r\n\t\tFirstPeriodCanceled,\r\n\t\tFromDate,\r\n\t\tToDate,\r\n\t\tThermFactor,\r\n\t\tCCF,\r\n\t\tDeltaNumberOfPeriods,\r\n\t\tReadingCode,\r\n\t\tFromReading,\r\n\t\tToReading,\r\n\t\tMeterConstant,\r\n\t\tsubstring(AccountNumber, 12, 2),\r\n\t\tDials,\r\n\r\n\t\tFacilityName,\r\n\t\tServiceAddress,\r\n\t\ttherms\r\n\tFROM NationalGridWest.UploadLegacyKeyspanWestMeterCancellation\r\n\tWHERE (DeltaNumberOfPeriods > 1)\r\n\t\r\n\t\r\n\t\r\n/*******************************\r\n2. Parse spanned billed upload meter cancellation info\r\n*********************************/\r\nexec NationalGridWest.usp_LegacyData_ParseSpannedMeterCancellationInfo @BillingPeriod, @authenticatedID, @BillingCycle\r\n\r\n/*******************************\r\n3. Set gas rate code\r\n*********************************/\r\n-- set default gas rate code\r\nUPDATE NationalGridWest.UploadLegacyKeyspanWestMeterCancellationSummary\r\nSET GasRateCode = '020'\r\n\r\n-- set gas rate code = commodity tariff rate in EC3\r\nUPDATE  s\r\nSET s.GasRateCode = a.CommodityTariffRate \r\nFROM NationalGridWest.UploadLegacyKeyspanWestMeterCancellationSummary AS s, Billing.Account AS a\r\nWHERE s.OriginalAccountNumber = a.OriginalAccountNumber\r\n\r\n\r\n/*******************************\r\n4. Merge summary data into adjustment\r\n*********************************/\r\nINSERT INTO [NationalGridWest].[UploadLegacyKeyspanWestMeterBillingAdjustmentGas]\r\n           ([AccountUtilityCompanySeqid]\r\n           ,[AccountBilled]\r\n           ,[MeterBilled]\r\n           ,[OriginalAccountNumber]\r\n           ,[OriginalMeterNumber]\r\n           ,[BillingPeriod]\r\n           ,[BillingPeriodRevision]\r\n           ,[FirstCancelPeriod]\r\n           ,[AccountExchangeMeterTrackSeqid]\r\n           ,[NumberOfTransactions]\r\n           ,[NumberOfRebillTransactions]\r\n           ,[NumberOfCancelTransactions]\r\n           ,[BillingAction]\r\n           ,[PriorRevisedBilledCCF]\r\n           ,[RevisedBilledCCF]\r\n           ,[CanceledBilledCCF]\r\n           ,[PriorRevisedBilledTherms]\r\n           ,[RevisedBilledTherms]\r\n           ,[CanceledBilledTherms]\r\n           ,[InitialCancelFromDate]\r\n           ,[CurrentBillingToDate]\r\n           ,[GasRateCode]\r\n           ,[FromDate]\r\n           ,[ToDate]\r\n           ,[MeterFromReading]\r\n           ,[MeterToReading]\r\n           ,[Ccf]\r\n           ,[Therms]\r\n           ,[ThermsFactor]\r\n           ,[MeterConstant]\r\n           ,[TotalBillingDaysRebilled]\r\n           ,[NumberOfBillingPeriods]\r\n           ,[BillingDays]\r\n           ,[BillingDate]\r\n           ,[ReadingCode]\r\n           ,[NumberOfDials]\r\n           ,[MeterType]\r\n           ,[ProcessEffectiveDate]\r\n           ,[CancelReadingCode]\r\n           ,[CancelFromDate]\r\n           ,[CancelToDate]\r\n           ,[CancelMeterFromReading]\r\n           ,[CancelMeterToReading]\r\n           ,[CancelCcf]\r\n           ,[CancelTherms]\r\n           ,[CancelThermsFactor]\r\n           ,[CancelMeterConstant]\r\n           ,[InitialPostingDate]\r\n           ,[DerivedFromSpannedBill]\r\n           ,[SpannedBillingPeriodRevision]\r\n           ,[SpannedFirstCanceledBillingPeriod]\r\n           ,[SpannedCCF]\r\n           ,[SpannedThermFactor]\r\n           ,[SpannedTherm]\r\n           ,[SpannedMonthlyPercentage]\r\n           ,[SpannedTotalPercentage]\r\n           ,[AuthenticatedUserID]\r\n           ,[Notes]\r\n           ,[DateAdded]\r\n           ,[LastUpdate]\r\n           ,[AdjustedMeterBilling]\r\n           ,[EstimatedOrActualBilling]\r\n           ,ServiceAddress,\r\n           FacilityName\r\n           )\r\n\t\tselect\r\n\t\t\t@UtilityCode -- <AccountUtilityCompanySeqid, seqid,>\r\n           ,max(AccountBilled) --<AccountBilled, seqid,>\r\n           ,max(MeterBilled) --<MeterBilled, seqid,>\r\n           ,max(OriginalAccountNumber) --<OriginalAccountNumber, acctnum,>\r\n           ,OriginalMeterNumber--<OriginalMeterNumber, meternumber,>\r\n           ,max(BillingPeriod) --<BillingPeriod, yyyymm,>\r\n           ,BillingPeriodRevision --<BillingPeriodRevision, yyyymm,>\r\n           ,NationalGridWest.DetermineBillingPeriod(@BillingCycle, Min(CancelFromDate), 'F', substring(max(OriginalAccountNumber),12,2)) as 'FirstCanceledBillingPeriod' --<FirstCancelPeriod, yyyymm,>\r\n           ,max(AccountExchangeMeterTrackSeqid) --<AccountExchangeMeterTrackSeqid, seqid,>\r\n           ,count(*) --<NumberOfTransactions, int,>\r\n           ,0 --<NumberOfRebillTransactions, int,>\r\n           ,count(*) --<NumberOfCancelTransactions, int,>\r\n           ,CASE WHEN MAX(BillingPeriod)=MIN(BillingPeriodRevision) THEN 'O' ELSE 'A' END --<BillingAction, BillingAction,>\r\n           ,max(PriorRevisedBilledCCF) --<PriorRevisedBilledCCF, EnergyUnit,>\r\n           ,sum(RevisedBilledCCF)--<RevisedBilledCCF, EnergyUnit,>\r\n           ,sum(CanceledBilledTherms) --<CanceledBilledCCF, EnergyUnit,>\r\n           ,sum(PriorRevisedBilledTherms) --<PriorRevisedBilledTherms, EnergyUnit,>\r\n           ,sum(RevisedBilledTherms)--<RevisedBilledTherms, EnergyUnit,>\r\n           ,sum(CanceledBilledTherms) --<CanceledBilledTherms, EnergyUnit,>\r\n           ,null --<InitialCancelFromDate, yyyymmdd,>\r\n           ,null --<CurrentBillingToDate, yyyymmdd,>\r\n           ,max(GasRateCode) --<GasRateCode, GasRateCode,>\r\n           ,null --<FromDate, yyyymmdd,>\r\n           ,null --<ToDate, yyyymmdd,>\r\n           ,null --<MeterFromReading, MeterReadingNumber,>\r\n           ,null --<MeterToReading, MeterReadingNumber,>\r\n           ,null --<Ccf, EnergyUnit,>\r\n           ,null --<Therms, EnergyUnit,>\r\n           ,null --<ThermsFactor, ThermsFactor,>\r\n           ,null --<MeterConstant, MeterConstantMultiplier,>\r\n           ,dbo.CalculateNumberOfBillingDays(MIN(CancelFromDate),MAX(CancelToDate)) as 'TotalBillingDaysRebilled'--<TotalBillingDaysRebilled, Accumulator,>\r\n           ,[dbo].[CalculateDeltaBillingPeriods]\r\n\t\t\t(\r\n\t\t\t\tNationalGridWest.DetermineBillingPeriod(@BillingCycle, Min(CancelFromDate), 'F', substring(max(OriginalAccountNumber),12,2)),\r\n\t\t\t\tNationalGridWest.DetermineBillingPeriod(@BillingCycle, Min(CancelToDate), 'T', substring(max(OriginalAccountNumber),12,2)),\r\n\t\t\t\t@BillingCycle                                                                                                                                                         \r\n\t\t\t) as 'NumberOfBillingPeriods'\r\n\t\t\t--<NumberOfBillingPeriods, Accumulator,>\r\n           ,dbo.CalculateNumberOfBillingDays(MIN(CancelFromDate),MAX(CancelToDate)) --<BillingDays, Accumulator,>\r\n           ,max(BillingDate) --<BillingDate, yyyymmdd,>\r\n           ,null --<ReadingCode, ReadingCode,>\r\n           ,max(NumberOfDials) --<NumberOfDials, MeterDials,>\r\n           ,max(MeterType) --<MeterType, MeterType,>\r\n           ,max(ProcessEffectiveDate) --<ProcessEffectiveDate, yyyymmdd,>\r\n           ,null --<CancelReadingCode, ReadingCode,>\r\n           ,min(CancelFromDate) --<CancelFromDate, yyyymmdd,>\r\n           ,max(CancelToDate) --null --<CancelToDate, yyyymmdd,>\r\n           ,min(CancelMeterFromReading) --<CancelMeterFromReading, MeterReadingNumber,>\r\n           ,max(CancelMeterToReading) --<CancelMeterToReading, MeterReadingNumber,>\r\n           ,sum(CancelCcf) --<CancelCcf, EnergyUnit,>\r\n           ,sum(CancelTherms) --<CancelTherms, EnergyUnit,>\r\n           ,CASe WHEN sum(CancelCcf)=0 or sum(CancelTherms)/sum(CancelCcf)>2 THEN 0 ELSE CONVERT(decimal(6, 4), (sum(CancelTherms)/sum(CancelCcf))) end --<CancelThermsFactor, ThermsFactor,>\r\n           ,null --<CancelMeterConstant, MeterConstantMultiplier,>\r\n           ,max(InitialPostingDate) --<InitialPostingDate, PostingDate,>\r\n           ,max(DerivedFromSpannedBill) --<DerivedFromSpannedBill, yesnoWithDefaultNo,>\r\n           ,max(SpannedBillingPeriodRevision) --<SpannedBillingPeriodRevision, yyyymm,>\r\n           ,max(SpannedFirstCanceledBillingPeriod) --<SpannedFirstCanceledBillingPeriod, yyyymm,>\r\n           ,max(SpannedCCF) --<SpannedCCF, EnergyUnit,>\r\n           ,max(SpannedThermFactor)--<SpannedThermFactor, ThermsFactor,>\r\n           ,max(SpannedTherm) --<SpannedTherm, EnergyUnit,>\r\n           ,max(SpannedMonthlyPercentage) --<SpannedMonthlyPercentage, SpannedPercentage,>\r\n           ,max(SpannedTotalPercentage) --<SpannedTotalPercentage, SpannedPercentage,>\r\n           ,max(AuthenticatedUserID) --<AuthenticatedUserID, AuthenticatedUserID,>\r\n           ,max(Notes) --<Notes, notes,>\r\n           ,max(DateAdded) --<DateAdded, DateAdded,>\r\n           ,max(LastUpdate) --<LastUpdate, LastUpdate,>\r\n           ,max(AdjustedMeterBilling) --<AdjustedMeterBilling, seqid,>\r\n           ,max(EstimatedOrActualBilling) --<EstimatedOrActualBilling, ActualOrEstimated,>\r\n\t\t\t,MAX(ServiceAddress),\r\n           MAX(FacilityName)\r\n\t\tfrom NationalGridWest.UploadLegacyKeyspanWestMeterCancellationSummary\r\n\t\tgroup by OriginalMeterNumber, BillingPeriodRevision\r\n\r\n\r\n\r\n\r\n\r\n------------ Now when Rebills and Cancels are in ajustment table------------------\r\n--- Uniting Rebills with existing Cancels (Temporarily here)\r\n\r\nupdate a1 -- NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas \r\n\tset \r\n\t[NumberOfTransactions]=a1.[NumberOfTransactions]+a2.[NumberOfTransactions],\r\n\t[NumberOfCancelTransactions]=a2.[NumberOfTransactions],\r\n\t[CancelFromDate]=a2.[CancelFromDate],\r\n\t[CancelToDate]=a2.[CancelToDate],\r\n\t[CancelCCF]=a2.[CancelCCF],\r\n\t[CancelTherms]=a2.[CancelTherms],\r\n\t[CancelThermsFactor]=a2.[CancelThermsFactor],\r\n\t[CancelMeterFromReading] = a2.[CancelMeterFromReading],\r\n\t[CancelMeterToReading] = a2.[CancelMeterToReading],\r\n\t[Notes]=CAST((CASE a2.[Notes] WHEN null THEN '' ELSE 'Rebill: '+a2.[Notes]+' ' END) +\t(CASE a2.[Notes] WHEN null THEN '' ELSE 'Cancel: '+a2.[Notes] END) AS varchar(300))\r\nfrom \r\n   NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas as a1\r\n\tINNER JOIN\r\n   NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas AS a2\r\n\tON \r\n\ta1.OriginalMeterNumber = a2.OriginalMeterNumber\r\n\tAND\r\n\ta1.BillingPeriodRevision = a2.BillingPeriodRevision\r\nWHERE (a1.NumberOfRebillTransactions > 0) AND \r\n      (a2.NumberOfCancelTransactions > 0)\r\n\r\n--\r\n--select column_name from INFORMATION_SCHEMA.COLUMNS\r\n--where table_name = 'UploadLegacyKeyspanWestMeterBillingAdjustmentGas'\r\n--order by column_name\r\n\r\n--select * from \r\n--NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas\r\n\r\n--- Deleting Cancels that had Rebills\r\nDELETE FROM \r\nNationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas\r\nFROM NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas INNER JOIN\r\nNationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas AS a1 \r\nON \r\nUploadLegacyKeyspanWestMeterBillingAdjustmentGas.OriginalMeterNumber = a1.OriginalMeterNumber AND\r\nUploadLegacyKeyspanWestMeterBillingAdjustmentGas.BillingPeriodRevision = a1.BillingPeriodRevision AND\r\nUploadLegacyKeyspanWestMeterBillingAdjustmentGas.UploadLegacyKeyspanWestMeterBillingAdjustmentGasSeqid <> a1.UploadLegacyKeyspanWestMeterBillingAdjustmentGasSeqid\r\nWHERE (UploadLegacyKeyspanWestMeterBillingAdjustmentGas.NumberOfCancelTransactions > 0) AND \r\n  (a1.NumberOfCancelTransactions > 0 AND a1.NumberOfRebillTransactions > 0)\r\n\r\n\r\n--- Update Cancels that had no Rebills\r\nUPDATE NationalGridWest.UploadLegacyKeyspanWestMeterBillingAdjustmentGas\r\nSET\r\n    [FromDate]=[CancelFromDate]\r\n   ,[ToDate]=[CancelToDate]\r\nWHERE  (NumberOfCancelTransactions > 0) AND (NumberOfRebillTransactions = 0)\r\n\r\n\r\n\r\nEND"
        }
      ]
    }
  ]
}