{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Report",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_EIAP",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_EIAP",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to generate a report on electricity usage, demand, and costs for specific agencies over a selected billing period. It calculates actual and budgeted electricity data, tenant charges, and adjustments between current and previous periods. The procedure processes data for a predefined set of agencies and outputs a detailed report excluding certain agency codes."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including data insertion, updates, and calculations across several datasets. It uses temporary tables, joins, and aggregations, which add to its complexity. However, it is well-structured and follows a logical sequence, making it manageable for those familiar with SQL and database operations."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@SelectedPeriod BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The billing period for which the report is generated."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@BeginningPeriod BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The starting billing period for the data range."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@Email emailaddr",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An email address used to retrieve agency data, for filtering or notification purposes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Initialization",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Declares variables and initializes a list of agency codes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Determines the previous published period using a helper function "
                },
                {
                  "type": "text",
                  "text": "dbo.CreatePreviousPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Preparation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Creates a temporary table "
                },
                {
                  "type": "text",
                  "text": "@EIPSReportData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " to store report data with default values."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Insert Placeholder Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Inserts agency and period data into "
                },
                {
                  "type": "text",
                  "text": "@EIPSReportData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " using a function to retrieve agency children and a join with published summary data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Insert Actual Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates "
                },
                {
                  "type": "text",
                  "text": "@EIPSReportData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with actual electricity usage, demand, and cost by joining with temporal account-level data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculate Adjustments",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Computes adjustments by comparing current actual data with data from the previous period."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Insert Budget Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates "
                },
                {
                  "type": "text",
                  "text": "@EIPSReportData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " with budgeted electricity data by joining with budget summary data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Calculate Tenant Charges",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Updates tenant-related fields in "
                },
                {
                  "type": "text",
                  "text": "@EIPSReportData",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " using tenant charge percentages from a synonym table."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregate Parent Agency Data",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Aggregates data for parent agencies by summing child agency data."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Output",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Selects and orders the final report data, excluding certain agency codes."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Aggregations",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple joins and aggregations, which can be resource-intensive. Indexing on key columns like "
                },
                {
                  "type": "text",
                  "text": "AgencyCodeOEC",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "BillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve performance."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a temporary table helps manage intermediate data efficiently, but its size should be monitored to avoid excessive memory usage."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Function Calls",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of "
                },
                {
                  "type": "text",
                  "text": "dbo.CreatePreviousPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and other functions should be optimized to minimize overhead."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that all joins will find matching records. Missing data could lead to incomplete or incorrect results."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the number of agencies or the range of billing periods increases, the procedure's performance may degrade."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure lacks explicit error handling, which could lead to unhandled exceptions or silent failures."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The list of agency codes and excluded agency codes are hardcoded, which reduces flexibility and requires manual updates for changes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If multiple instances of this procedure run simultaneously, there could be contention for resources, especially if the underlying tables are heavily accessed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "-- Stored Procedure\n\r\n--************************************************************************************************************\r\n--* Description:\t\t\r\n--*\r\n--* AUTHOR:\t\t\t\tPeter Heller\r\n--* Created On:   \r\n--************************************************************************************************************\r\n--* Date\t\tTech\tDescription of Change\r\n--* ----------\t---\t\t-------------------------------------------------------------\r\n--* 2016-01-13  MB-ZD\tChanged the synonym name from [Budget].[TenantCharges] also with dbo.Syn_BudgetDB_Scenarios_TenantCharges\r\n--* 02/22/2016\tMB ZD\tUpdate: Changed to use temporal tables\r\n--************************************************************************************************************\r\n\r\nCREATE PROCEDURE [Report].[usp_EIAP]\r\n\t@SelectedPeriod BillingPeriod,\r\n\t@BeginningPeriod BillingPeriod,\r\n\t@Email emailaddr\r\nAS\r\nBEGIN\r\n\r\nDECLARE @PreviousPublishedPeriod BillingPeriod\r\nDECLARE @EIAPAgencies VARCHAR(200) = '040000,856000,072000,056000,827000,846000,057000'\r\n\r\nSET @PreviousPublishedPeriod = dbo.CreatePreviousPeriod(@SelectedPeriod, 'M')\r\n\r\n/*\r\n1)Insert actual data\r\n2)Calculate Adjustment \r\n\tReviseAmount of selected published period \r\n3)Calculate Tenant Charge\r\n4)Insert budget data\r\n5)update parent agency information\r\n*/\r\n\r\nDECLARE @EIPSReportData TABLE\r\n(\r\n\tBillingPeriod BillingPeriod,\r\n\tAgencyDivisionSeqID INT,\r\n\tAgencyCodeOEC AgencyCodeOEC,\r\n\tAgencyName ldesc,\r\n\tparentAgencyDivisionSeqID INT,\r\n\r\n\t--budget data\r\n\tBudgetElecUsage INT NOT NULL DEFAULT('0'),\r\n\tBudgetElecDemand INT NOT NULL DEFAULT('0'),\r\n\tBudgetElecCost MONEY NOT NULL DEFAULT('0'),\r\n\r\n\r\n\t--actual data\r\n\tActualElecUsage INT NOT NULL DEFAULT('0'),\r\n\tActualElecDemand INT NOT NULL DEFAULT('0'),\r\n\tActualElecCost MONEY NOT NULL DEFAULT('0'),\r\n\r\n\t--tenant data\r\n\tTenantPercentage FLOAT NOT NULL DEFAULT('0'),\r\n\tTenantElecUsage INT NOT NULL DEFAULT('0'),\r\n\tTenantElecDemand INT NOT NULL DEFAULT('0'),\r\n\tTenantElecCost MONEY NOT NULL DEFAULT('0'),\r\n\r\n\tBudgetTenantElecUsage INT NOT NULL DEFAULT('0'),\r\n\tBudgetTenantElecDemand INT NOT NULL DEFAULT('0'),\r\n\tBudgetTenantElecCost MONEY NOT NULL DEFAULT('0'),\r\n\r\n\t--tenant adjustment\r\n\tTenantAdjustmentElecUsage INT NOT NULL DEFAULT('0'),\r\n\tTenantAdjustmentElecDemand INT NOT NULL DEFAULT('0'),\r\n\tTenantAdjustmentElecCost MONEY NOT NULL DEFAULT('0'),\r\n\r\n\t--adjustment (difference between current published period and previous published period\r\n\tAdjustmentElecUsage INT NOT NULL DEFAULT('0'),\r\n\tAdjustmentElecDemand INT NOT NULL DEFAULT('0'),\r\n\tAdjustmentElecCost MONEY NOT NULL DEFAULT('0')\r\n)\r\n\r\n\r\n/*\r\ncreate placeholder for agencies\r\n*/\r\nINSERT INTO @EIPSReportData\r\n        ( BillingPeriod ,\r\n          AgencyCodeOEC ,\r\n          AgencyName,\r\n          parentAgencyDivisionSeqID,\r\n          AgencyDivisionSeqID\r\n        )\r\nSELECT p.PublishedBillingPeriod, ad.AgencyCodeOEC, ad.AgencyName, ParentAgencyDivisionSeqid, AgencyDivisionSeqID from \r\nBilling.uftn_TableGetAgencyChildrenByAgencyCodeOEC(@EIAPAgencies, @Email) AS ad,\r\nPublished.MonthlyPublishedSummaryData AS p\r\nWHERE p.PublishedBillingPeriod BETWEEN @BeginningPeriod AND @SelectedPeriod\r\n\r\n\r\n/*\r\n1) Insert actual data\r\n*/\r\n\r\n-- insert actual data\r\nUPDATE EIAP\r\nSET ActualElecUsage =AccountEnergyUsage,\r\nActualElecDemand =AccountDemandUsage,\r\nActualElecCost = RevisedBilledAmount\r\nfrom\r\n@EIPSReportData AS eiap\r\nINNER join\r\n(\r\n  SELECT    SUM(rawData.RevisedBilledAmount) RevisedBilledAmount,\r\n\t\t\tSUM(rawData.AccountDemandUsage) AccountDemandUsage,  \r\n\t\t\tSUM(rawData.AccountEnergyUsage) AccountEnergyUsage,\r\n\t\t\trawData.BillingPeriod, rawData.AgencyCodeOEC\r\n  FROM   Published.TemporalAccountLevelRawDataForCurrentPeriod AS rawData\r\n\t\t\tINNER JOIN @EIPSReportData AS eiap\r\n\t\t\tON rawData.AgencyCodeOEC = eiap.AgencyCodeOEC\r\n\t\t\tAND rawData.BillingPeriod = eiap.BillingPeriod\r\n  WHERE rawData.Energytype ='ELE' \r\n--  AND rawData.PublishedBillingPeriod = @SelectedPeriod\r\n  AND (rawData.EffectiveStartPeriod <= @SelectedPeriod AND rawData.EffectiveEndPeriod > @SelectedPeriod)\r\n  GROUP BY  rawData.BillingPeriod, rawData.AgencyCodeOEC\r\n) AS eiapData\r\nON eiap.BillingPeriod = eiapData.BillingPeriod\r\nAND eiap.AgencyCodeOEC = eiapData.AgencyCodeOEC\r\n\r\n\r\n\r\n/*\r\n2. Calculate Adjustment\r\n*/\r\n\r\nUPDATE EIAP\r\nSET \r\nAdjustmentElecUsage = ActualElecUsage - isnull(eiapPreviousMonth.AccountEnergyUsage, 0),\r\nAdjustmentElecDemand = ActualElecDemand - ISNULL(eiapPreviousMonth.AccountDemandUsage, 0),\r\nAdjustmentElecCost = ActualElecCost - ISNULL(eiapPreviousMonth.RevisedBilledAmount, 0)\r\nfrom\r\n@EIPSReportData AS eiap\r\nLEFT JOIN -- \r\n(\r\n  SELECT    SUM(rawData.RevisedBilledAmount) RevisedBilledAmount,\r\n\t\t\tSUM(rawData.AccountDemandUsage) AccountDemandUsage,  \r\n\t\t\tSUM(rawData.AccountEnergyUsage) AccountEnergyUsage,\r\n\t\t\trawData.BillingPeriod, rawData.AgencyCodeOEC\r\n  FROM   Published.TemporalAccountLevelRawDataForCurrentPeriod AS rawData\r\n\t\t\tINNER JOIN @EIPSReportData AS eiap\r\n\t\t\tON rawData.AgencyCodeOEC = eiap.AgencyCodeOEC\r\n\t\t\tAND rawData.BillingPeriod = eiap.BillingPeriod\r\n  WHERE rawData.Energytype ='ELE' \r\n\t\t\tAND rawData.EffectiveStartPeriod <= @PreviousPublishedPeriod AND rawData.EffectiveEndPeriod > @PreviousPublishedPeriod\r\n  GROUP BY  rawData.BillingPeriod, rawData.AgencyCodeOEC\r\n) AS eiapPreviousMonth\r\nON \r\neiap.BillingPeriod = eiapPreviousMonth.BillingPeriod\r\nAND eiap.AgencyCodeOEC = eiapPreviousMonth.AgencyCodeOEC\r\nWHERE \r\neiap.BillingPeriod <> @SelectedPeriod -- adjustment for the current period should be 0\r\n\r\n\r\n\r\n/*\r\n3. Insert budget data\r\n*/\r\nUPDATE EIAP\r\nSET \r\n\tBudgetElecCost = BudgetDollar,\r\n\tBudgetElecUsage = BudgetConsumption,\r\n\tBudgetElecDemand =BudgetDemand\r\nfrom\r\n@EIPSReportData AS eiap\r\nINNER join\r\n(\r\n  SELECT    SUM(CASE WHEN GenericEnergyDeliveryTypeUnit = 'Cost' THEN rawData.EnergyUsage ELSE 0 end) BudgetDollar, -- energy usage is the dollar if generic energy delivery type unit is 'cost'\r\n\t\t\tSUM(CASE WHEN GenericEnergyDeliveryTypeUnit LIKE 'consumption%' THEN rawData.EnergyUsage ELSE 0 end) BudgetConsumption,\r\n\t\t\tSUM(CASE WHEN GenericEnergyDeliveryTypeUnit LIKE 'demand' THEN rawData.EnergyUsage ELSE 0 end) BudgetDemand,\r\n\t\t\trawData.BillingPeriod, \r\n\t\t\trawData.AgencyCodeOEC\r\n  FROM   Budget.uvw_BaseBudgetByAgencySummaryByAgencyEnergyType AS rawData\r\n\t\t\tINNER JOIN @EIPSReportData AS eiap\r\n\t\t\tON rawData.AgencyCodeOEC = eiap.AgencyCodeOEC\r\n\t\t\tAND rawData.BillingPeriod = eiap.BillingPeriod\r\n  WHERE  rawData.BillingPeriod BETWEEN @BeginningPeriod AND @SelectedPeriod\r\n\t\t\tAND EnergyDeliveryType = 'ELE'\r\n  GROUP BY  rawData.BillingPeriod, rawData.AgencyCodeOEC\r\n) AS eiapData\r\nON eiap.BillingPeriod = eiapData.BillingPeriod\r\nAND eiap.AgencyCodeOEC = eiapData.AgencyCodeOEC\r\n\r\n/*\r\n4. Calculate Tenant Charge\r\n*/\r\nUPDATE EIAP\r\nSET \r\n\tTenantPercentage = T.TenantChargePercentage,\r\n\tTenantElecUsage = DCASData.ActualElecUsage*T.TenantChargePercentage,\r\n\tTenantElecDemand = DCASData.ActualElecDemand*T.TenantChargePercentage,\r\n\tTenantElecCost =DCASData.ActualElecCost*T.TenantChargePercentage,\r\n\tTenantAdjustmentElecUsage = DCASData.AdjustmentElecUsage*T.TenantChargePercentage,\r\n\tTenantAdjustmentElecDemand = DCASData.AdjustmentElecDemand*T.TenantChargePercentage,\r\n\tTenantAdjustmentElecCost = DCASData.AdjustmentElecCost*T.TenantChargePercentage,\r\n\tBudgetTenantElecUsage = DCASData.BudgetElecUsage*T.TenantChargePercentage,\r\n\tBudgetTenantElecDemand = DCASData.BudgetElecDemand*T.TenantChargePercentage,\r\n\tBudgetTenantElecCost =DCASData.BudgetElecCost*T.TenantChargePercentage\r\nfrom\r\n@EIPSReportData AS eiap\r\nINNER JOIN dbo.Syn_BudgetDB_Scenarios_TenantCharges AS T\r\nON eiap.AgencyCodeOEC = T.OecAgencyCode\r\nINNER JOIN @EIPSReportData AS DCASData\r\nON eiap.BillingPeriod = DCASData.BillingPeriod\r\nWHERE DCASData.AgencyCodeOEC = '856001'\r\n\r\n\r\n\r\n--group for parent\r\nUPDATE parent\r\nSET\r\n    parent.BudgetElecUsage=parent.BudgetElecUsage+childSummary.BudgetElecUsage,\r\n\tparent.BudgetElecDemand=parent.BudgetElecDemand+childSummary.BudgetElecDemand,\r\n\tparent.BudgetElecCost=parent.BudgetElecCost+childSummary.BudgetElecCost,\r\n\t--actual data\r\n\tparent.ActualElecUsage=parent.ActualElecUsage+childSummary.ActualElecUsage,\r\n\tparent.ActualElecDemand=parent.ActualElecDemand+childSummary.ActualElecDemand,\r\n\tparent.ActualElecCost=parent.ActualElecCost+childSummary.ActualElecCost,\r\n\t--tenant data\r\n\tparent.TenantElecUsage=parent.TenantElecUsage+childSummary.TenantElecUsage,\r\n\tparent.TenantElecDemand=parent.TenantElecDemand+childSummary.TenantElecDemand,\r\n\tparent.TenantElecCost=parent.TenantElecCost+childSummary.TenantElecCost,\r\n\t-- adjustment\r\n\tparent.AdjustmentElecUsage=parent.AdjustmentElecUsage+childSummary.AdjustmentElecUsage,\r\n\tparent.AdjustmentElecDemand=parent.AdjustmentElecDemand+childSummary.AdjustmentElecDemand,\r\n\tparent.AdjustmentElecCost=parent.AdjustmentElecCost+childSummary.AdjustmentElecCost,\r\n\t-- tenant adjustment\r\n\tparent.tenantAdjustmentElecUsage=parent.tenantAdjustmentElecUsage+childSummary.tenantAdjustmentElecUsage,\r\n\tparent.tenantAdjustmentElecDemand=parent.tenantAdjustmentElecDemand+childSummary.tenantAdjustmentElecDemand,\r\n\tparent.tenantAdjustmentElecCost=parent.tenantAdjustmentElecCost+childSummary.tenantAdjustmentElecCost,\r\n\t--budget tenant\r\n\tparent.BudgetTenantElecUsage=parent.BudgetTenantElecUsage+childSummary.BudgetTenantElecUsage,\r\n\tparent.BudgetTenantElecDemand=parent.BudgetTenantElecDemand+childSummary.BudgetTenantElecDemand,\r\n\tparent.BudgetTenantElecCost=parent.BudgetTenantElecCost+childSummary.BudgetTenantElecCost\r\nFROM @EIPSReportData AS parent\r\nINNER JOIN \r\n(\r\n\tSELECT sum(BudgetElecUsage) BudgetElecUsage,\r\n\tsum(BudgetElecDemand) BudgetElecDemand,\r\n\tsum(BudgetElecCost) BudgetElecCost,\r\n\t--actual data\r\n\tsum(ActualElecUsage) ActualElecUsage,\r\n\tsum(ActualElecDemand) ActualElecDemand,\r\n\tsum(ActualElecCost) ActualElecCost,\r\n\t--tenant data\r\n\tsum(TenantElecUsage) TenantElecUsage,\r\n\tsum(TenantElecDemand) TenantElecDemand,\r\n\tsum(TenantElecCost) TenantElecCost,\r\n\t--adjustment\r\n\tsum(AdjustmentElecUsage) AdjustmentElecUsage,\r\n\tsum(AdjustmentElecDemand) AdjustmentElecDemand,\r\n\tsum(AdjustmentElecCost) AdjustmentElecCost,\r\n\t--tenant adjustment\r\n\tsum(tenantAdjustmentElecUsage) tenantAdjustmentElecUsage,\r\n\tsum(tenantAdjustmentElecDemand) tenantAdjustmentElecDemand,\r\n\tsum(tenantAdjustmentElecCost) tenantAdjustmentElecCost,\r\n\t--budget tenant\r\n\tsum(BudgetTenantElecUsage) BudgetTenantElecUsage,\r\n\tsum(BudgetTenantElecDemand) BudgetTenantElecDemand,\r\n\tsum(BudgetTenantElecCost) BudgetTenantElecCost,\r\n\tparentAgencyDivisionSeqID,\r\n\tbillingperiod\r\n\tFROM @EIPSReportData\r\n\tGROUP BY billingperiod,parentAgencyDivisionSeqID\r\n)\r\nAS childSummary\r\nON parent.agencyDivisionSeqId = childSummary.parentAgencyDivisionSeqID\r\nAND parent.billingperiod = childSummary.billingperiod\r\n\r\nSELECT \r\n\tBillingPeriod ,\r\n\tAgencyCodeOEC,\r\n\tAgencyName,\r\n\tBudgetElecUsage,\r\n\tBudgetElecDemand,\r\n\tBudgetElecCost,\r\n\tBudgetTenantElecUsage,\r\n\tBudgetTenantElecDemand,\r\n\tBudgetTenantElecCost,\r\n\tActualElecUsage,\r\n\tActualElecDemand,\r\n\tActualElecCost,\t\r\n\tTenantPercentage,\r\n\tTenantElecUsage,\r\n\tTenantElecDemand,\r\n\tTenantElecCost ,\r\n\tTenantAdjustmentElecUsage,\r\n\tTenantAdjustmentElecDemand,\r\n\tTenantAdjustmentElecCost,\r\n\tAdjustmentElecUsage,\r\n\tAdjustmentElecDemand,\r\n\tAdjustmentElecCost\r\n FROM @EIPSReportData \r\nWHERE AgencyCodeOEC NOT IN ('040005', '126037', '856060', '856090')\r\nORDER BY AgencyCodeOEC, billingPeriod\r\n\r\n\r\n\r\n\r\nEND"
        }
      ]
    }
  ]
}