{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Nypa",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_CrossCheckNypaMinimumBilling",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_CrossCheckNypaMinimumBilling",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to analyze and calculate billing demand data for accounts within a specific billing period. It primarily focuses on determining the maximum billed demand usage over the past 12 and 18 months and calculates additional demand charges based on these historical maximums. The procedure processes data from the "
        },
        {
          "type": "text",
          "text": "UploadNYPAAccountBilling",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table and updates a temporary table with calculated values, which are then used to generate a final result set."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple steps, including data insertion, complex calculations, and updates based on joins with other tables. The complexity arises from the need to handle historical data calculations and the use of temporary tables to manage intermediate results."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure does not take any input parameters. It operates on data from the "
        },
        {
          "type": "text",
          "text": "UploadNYPAAccountBilling",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " table and uses hardcoded conditions, such as filtering records with "
        },
        {
          "type": "text",
          "text": "RevisedBillingPeriod > '201112'",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": "."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Creation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": A table variable "
                },
                {
                  "type": "text",
                  "text": "@MinBilledDemand",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is created to store intermediate results. This table includes fields for billing periods, account numbers, demand and energy usage, and calculated maximum demand usages."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Insertion",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Data is inserted into "
                },
                {
                  "type": "text",
                  "text": "@MinBilledDemand",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " from the "
                },
                {
                  "type": "text",
                  "text": "UploadNYPAAccountBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table, with additional calculated fields for "
                },
                {
                  "type": "text",
                  "text": "BillingPeriodMinus12",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "BillingPeriodMinus18",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", which represent periods 12 and 18 months prior to the "
                },
                {
                  "type": "text",
                  "text": "RevisedBillingPeriod",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Maximum Demand Calculation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure calculates the maximum billed production and delivery demand usage over the past 12 and 18 months, respectively."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "These calculations are performed using a subquery that joins "
                        },
                        {
                          "type": "text",
                          "text": "@MinBilledDemand",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " with the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountBilling",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table, filtering based on historical billing periods."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Period Updates",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure updates the "
                        },
                        {
                          "type": "text",
                          "text": "@MinBilledDemand",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table with the billing periods corresponding to the calculated maximum demand usages."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Final Selection",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The procedure selects and returns a result set from "
                        },
                        {
                          "type": "text",
                          "text": "@MinBilledDemand",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ", including calculated fields for extra kilowatt usage ("
                        },
                        {
                          "type": "text",
                          "text": "NypaExtraKW",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " and "
                        },
                        {
                          "type": "text",
                          "text": "ConEdisonExtraKW",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": ") based on thresholds of 75% and 39% of the maximum demand usages."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Union Operation",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "The final result set is divided into two parts based on the "
                        },
                        {
                          "type": "text",
                          "text": "ProductionAndDeliveryTariff",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " value, using a "
                        },
                        {
                          "type": "text",
                          "text": "UNION ALL",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " operation to combine them."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Temporary Table Usage",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a table variable ("
                },
                {
                  "type": "text",
                  "text": "@MinBilledDemand",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ") can be efficient for small to medium-sized datasets but may lead to performance issues with larger datasets due to memory constraints."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Joins and Subqueries",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure involves multiple joins and subqueries, which can be resource-intensive, especially if the "
                },
                {
                  "type": "text",
                  "text": "Billing.AccountBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is large."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensuring that the "
                },
                {
                  "type": "text",
                  "text": "Billing.AccountBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " table is properly indexed on "
                },
                {
                  "type": "text",
                  "text": "OriginalAccountNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "BillingPeriodRevision",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " can improve join performance."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Date Filter",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The filter "
                },
                {
                  "type": "text",
                  "text": "RevisedBillingPeriod > '201112'",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is hardcoded, which may require regular updates to remain relevant."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of a table variable may not scale well with large datasets, potentially leading to memory pressure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The procedure assumes that the data in "
                },
                {
                  "type": "text",
                  "text": "UploadNYPAAccountBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "Billing.AccountBilling",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " is accurate and complete. Any discrepancies could affect the calculations."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure is executed concurrently by multiple sessions, it could lead to contention on shared resources, especially if the underlying tables are large and heavily accessed."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "CREATE procedure [Nypa].[usp_CrossCheckNypaMinimumBilling] as\n\r\nDECLARE @MinBilledDemand TABLE\r\n(\r\n       BillingPeriod VARCHAR(6), \r\n    CurrentAccountNumber acctnum,\r\n    RevisedBillingPeriod VARCHAR(6),\r\n    AccountSeqid int ,\r\n    AccountBillingSeqid int,\r\n    AccountDemandUsage DECIMAL(12,2) ,\r\n    AccountEnergyUsage DECIMAL(12,2),\r\n    MinimumBilledEnergyDollars MONEY ,\r\n    IsMinimumBilledCharged VARCHAR(1),\r\n    MinimumBilledDemandDollars MONEY,\r\n    MaxBilledDemandPeriod VARCHAR(6),\r\n    MaxBilledDemandUsage DECIMAL(12,2),\r\n    MinimumBilledDemandUsage DECIMAL(12,2) ,\r\n    IsDeliveryMinimumBilledFlag VARCHAR(1) ,\r\n    DeliveryMinimumBilledAmount MONEY,\r\n    DeliveryMinimumBilledDemand DECIMAL(12,2),\r\n    DeliveryMaximumBilledDemand DECIMAL(12,2),\r\n    DeliveryMaximumBilledDemandPeriod VARCHAR(6),\r\n    MinimumBilledEnergyUsage DECIMAL(12,2),\r\n    ProductionAndDeliveryTariff ProductionAndDeliveryTariff,\r\n       BillingPeriodMinus12 VARCHAR(20),\r\n       BillingPeriodMinus18 VARCHAR(6),\r\n       CalculatedMaxBilledProductionDemandUsage DECIMAL(12,2), -- max account demand usage of last 12 months\r\n       CalculatedMaxBilledDeliveryDemandUsage DECIMAL(12,2), -- max account demand usage of last 18 months\r\n       CalculatedMaxBilledProductionDemandUsageBillingPeriod VARCHAR(6),\r\n       CalculatedMaxBilledDeliveryDemandUsagBillingPeriod VARCHAR(6)\r\n)\r\n\r\nINSERT INTO @MinBilledDemand\r\n        ( \r\n               BillingPeriod ,\r\n          CurrentAccountNumber ,\r\n          RevisedBillingPeriod ,\r\n          AccountSeqid ,\r\n          AccountBillingSeqid ,\r\n          AccountDemandUsage ,\r\n          AccountEnergyUsage ,\r\n          MinimumBilledEnergyDollars ,\r\n          IsMinimumBilledCharged ,\r\n          MinimumBilledDemandDollars ,\r\n          MaxBilledDemandPeriod ,\r\n          MaxBilledDemandUsage ,\r\n          MinimumBilledDemandUsage ,\r\n          IsDeliveryMinimumBilledFlag ,\r\n          DeliveryMinimumBilledAmount ,\r\n          DeliveryMinimumBilledDemand ,\r\n          DeliveryMaximumBilledDemand ,\r\n          DeliveryMaximumBilledDemandPeriod ,\r\n          MinimumBilledEnergyUsage ,\r\n          ProductionAndDeliveryTariff,\r\n               BillingPeriodMinus12,\r\n               BillingPeriodMinus18\r\n        )\r\nselect  \r\n             BillingPeriod, \r\n        CurrentAccountNumber ,\r\n        RevisedBillingPeriod ,\r\n        AccountSeqid ,\r\n        AccountBillingSeqid ,\r\n        AccountDemandUsage ,\r\n        AccountEnergyUsage ,\r\n        MinimumBilledEnergyDollars ,\r\n        IsMinimumBilledCharged ,\r\n        MinimumBilledDemandDollars ,\r\n        MaxBilledDemandPeriod ,\r\n        MaxBilledDemandUsage ,\r\n        MinimumBilledDemandUsage ,\r\n        IsDeliveryMinimumBilledFlag ,\r\n        DeliveryMinimumBilledAmount ,\r\n        DeliveryMinimumBilledDemand ,\r\n        DeliveryMaximumBilledDemand ,\r\n        DeliveryMaximumBilledDemandPeriod ,\r\n        MinimumBilledEnergyUsage ,\r\n        ProductionAndDeliveryTariff,\r\n             LEFT(CONVERT(VARCHAR, DATEADD(month, -12, RIGHT(RevisedBillingPeriod, 2)+ '/1/' +LEFT(RevisedBillingPeriod, 4)), 112), 6),        \r\n             LEFT(CONVERT(VARCHAR, DATEADD(month, -18, RIGHT(RevisedBillingPeriod, 2)+ '/1/' +LEFT(RevisedBillingPeriod, 4)), 112), 6)\r\nFROM EC3Database.Nypa.UploadNYPAAccountBilling\r\nwhere   RevisedBillingPeriod > '201112'\r\n\r\n\r\n\r\n-- MaxBilledProductionDemandUsage & MaxBilledDeliveryDemandUsage\r\n\r\nUPDATE minDemand\r\nSET \r\nCalculatedMaxBilledProductionDemandUsage = calculatedInformation.MaxBilledProductionDemandUsage,\r\nCalculatedMaxBilledDeliveryDemandUsage = calculatedInformation.MaxBilledDeliveryDemandUsage\r\nfrom\r\n@MinBilledDemand AS minDemand\r\nINNER JOIN\r\n(\r\n       SELECT \r\n             MAX(CASE WHEN ab.BillingPeriodRevision >= mbd.BillingPeriodMinus12        \r\n                                                            THEN ab.AccountDemandUsage            \r\n                                                            ELSE 0      end) AS MaxBilledProductionDemandUsage,\r\n             MAX(ab.AccountDemandUsage) AS MaxBilledDeliveryDemandUsage,\r\n             mbd.CurrentAccountNumber,\r\n             mbd.RevisedBillingPeriod\r\n       FROM \r\n             @MinBilledDemand mbd\r\n             INNER JOIN Billing.AccountBilling AS ab\r\n       ON \r\n       mbd.CurrentAccountNumber = ab.OriginalAccountNumber\r\n       AND ab.BillingPeriodRevision < mbd.RevisedBillingPeriod\r\n       AND ab.BillingPeriodRevision >= mbd.BillingPeriodMinus18\r\n       GROUP BY mbd.CurrentAccountNumber, RevisedBillingPeriod\r\n) calculatedInformation\r\nON minDemand.CurrentAccountNumber = calculatedInformation.CurrentAccountNumber\r\nAND minDemand.RevisedBillingPeriod = calculatedInformation.RevisedBillingPeriod\r\n\r\n\r\n\r\nUPDATE summaryData         \r\nSET summaryData.CalculatedMaxBilledDeliveryDemandUsagBillingPeriod = accountBilling.BillingPeriodRevision           \r\nFROM @MinBilledDemand AS summaryData           \r\nINNER JOIN billing.AccountBilling AS accountBilling         \r\nON summaryData.CalculatedMaxBilledDeliveryDemandUsage = accountBilling.AccountDemandUsage       \r\nAND summaryData.CurrentAccountNumber = accountBilling.OriginalAccountNumber            \r\nAND accountBilling.BillingPeriod >= summaryData.BillingPeriodMinus18     \r\n             \r\n             \r\n\r\nUPDATE summaryData         \r\nSET summaryData.CalculatedMaxBilledProductionDemandUsageBillingPeriod = accountBilling.BillingPeriodRevision           \r\nFROM @MinBilledDemand AS summaryData           \r\nINNER JOIN billing.AccountBilling AS accountBilling         \r\nON summaryData.CalculatedMaxBilledProductionDemandUsage = accountBilling.AccountDemandUsage       \r\nAND summaryData.CurrentAccountNumber = accountBilling.OriginalAccountNumber            \r\nAND accountBilling.BillingPeriod >= summaryData.BillingPeriodMinus12\r\n\r\n\r\nselect  CurrentAccountNumber ,\r\n        RevisedBillingPeriod ,\r\n        substring(ProductionAndDeliveryTariff, 9, 3) as DeliveryTariff ,\r\n        AccountDemandUsage ,\r\n        IsMinimumBilledCharged ,\r\n        MaxBilledDemandPeriod ,\r\n        MaxBilledDemandUsage ,\r\n        MinimumBilledDemandUsage ,\r\n        MaxBilledDemandPeriod ,\r\n        case when (AccountDemandUsage - round(CalculatedMaxBilledProductionDemandUsage * .75, 2)) > 0 then (AccountDemandUsage - round(CalculatedMaxBilledProductionDemandUsage * .75, 2)) else 0 end as NypaExtraKW,\r\n        CalculatedMaxBilledProductionDemandUsageBillingPeriod ,\r\n        CalculatedMaxBilledProductionDemandUsage , -- max account demand usage of last 12 months\r\n        round(CalculatedMaxBilledProductionDemandUsage * .75, 2) as CalculatedMinimumBilledProductionDemandUsage , -- max account demand usage of last 12 months\r\n        IsDeliveryMinimumBilledFlag ,\r\n        DeliveryMinimumBilledDemand ,\r\n        DeliveryMaximumBilledDemandPeriod ,\r\n        DeliveryMaximumBilledDemand ,\r\n        DeliveryMaximumBilledDemandPeriod ,\r\n   case when (AccountDemandUsage - round(CalculatedMaxBilledDeliveryDemandUsage * .39, 2)) > 0 then (AccountDemandUsage - round(CalculatedMaxBilledDeliveryDemandUsage * .39, 2))  else 0 end as ConEdisonExtraKW,\r\nCalculatedMaxBilledDeliveryDemandUsage , -- max account demand usage of last 18 months\r\n        round(CalculatedMaxBilledDeliveryDemandUsage * .39, 2) as CalculatedDeliveryMinimumBilledDemand , -- max account demand usage of last 12 months\r\n        CalculatedMaxBilledDeliveryDemandUsagBillingPeriod ,\r\n        AccountEnergyUsage ,\r\n        MinimumBilledEnergyUsage\r\nFROM @MinBilledDemand\r\nwhere   substring(ProductionAndDeliveryTariff, 9, 3) <> '062'\r\nunion all \r\n\r\nselect  CurrentAccountNumber ,\r\n        RevisedBillingPeriod ,\r\n        substring(ProductionAndDeliveryTariff, 9, 3) as DeliveryTariff ,\r\n        AccountDemandUsage ,\r\n        IsMinimumBilledCharged ,\r\n        MaxBilledDemandPeriod ,\r\n        MaxBilledDemandUsage ,\r\n        MinimumBilledDemandUsage ,\r\n        MaxBilledDemandPeriod ,\r\n        case when (AccountDemandUsage - round(CalculatedMaxBilledProductionDemandUsage * .75, 2)) > 0 then (AccountDemandUsage - round(CalculatedMaxBilledProductionDemandUsage * .75, 2)) else 0 end as NypaExtraKW,\r\n        CalculatedMaxBilledProductionDemandUsageBillingPeriod ,\r\n        CalculatedMaxBilledProductionDemandUsage , -- max account demand usage of last 12 months\r\n        round(CalculatedMaxBilledProductionDemandUsage * .75, 2) as CalculatedMinimumBilledProductionDemandUsage , -- max account demand usage of last 12 months\r\n        IsDeliveryMinimumBilledFlag ,\r\n        DeliveryMinimumBilledDemand ,\r\n        DeliveryMaximumBilledDemandPeriod ,\r\n        DeliveryMaximumBilledDemand ,\r\n        DeliveryMaximumBilledDemandPeriod ,\r\n   case when (AccountDemandUsage - round(CalculatedMaxBilledDeliveryDemandUsage * .39, 2)) > 0 then (AccountDemandUsage - round(CalculatedMaxBilledDeliveryDemandUsage * .39, 2))  else 0 end as ConEdisonExtraKW,\r\nCalculatedMaxBilledDeliveryDemandUsage , -- max account demand usage of last 18 months\r\n        round(CalculatedMaxBilledDeliveryDemandUsage * .39, 2) as CalculatedDeliveryMinimumBilledDemand , -- max account demand usage of last 12 months\r\n        CalculatedMaxBilledDeliveryDemandUsagBillingPeriod ,\r\n        AccountEnergyUsage ,\r\n        MinimumBilledEnergyUsage\r\nFROM @MinBilledDemand\r\nwhere   substring(ProductionAndDeliveryTariff, 9, 3) = '062'"
        }
      ]
    }
  ]
}