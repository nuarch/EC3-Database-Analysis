{
  "version": 1,
  "type": "doc",
  "content": [
    {
      "type": "bodiedExtension",
      "attrs": {
        "extensionType": "com.atlassian.confluence.macro.core",
        "extensionKey": "details",
        "parameters": {
          "macroParams": {
            "hidden": {
              "value": "true"
            }
          },
          "macroMetadata": {
            "schemaVersion": {
              "value": "1"
            },
            "title": "Page Properties"
          }
        }
      },
      "content": [
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Schema Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "ManualBill",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Stored Procedure Name",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "usp_ManualBillingAddNewMeter",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "attrs": {
                    "colspan": 1,
                    "background": "#f4f5f7",
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Complexity Level",
                          "type": "text",
                          "marks": [
                            {
                              "type": "strong"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "tableCell",
                  "attrs": {
                    "colspan": 1,
                    "rowspan": 1
                  },
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "text": "Medium",
                          "type": "text"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "1. Overview"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The stored procedure "
        },
        {
          "type": "text",
          "text": "usp_ManualBillingAddNewMeter",
          "marks": [
            {
              "type": "code"
            }
          ]
        },
        {
          "type": "text",
          "text": " is designed to add a new meter to an existing account within a billing system. It processes an exchange record identified by a sequence ID and ensures that the exchange code is '46', which is a specific code for this operation. The procedure performs several validation checks, inserts a new meter into the system, and updates tracking tables to reflect the addition. It also handles transaction management and error logging."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "2. Complexity Level: Medium"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "text": "The procedure involves multiple validation checks, data retrieval, and insertion operations across different tables. It also includes transaction management and error handling, which adds to its complexity. However, the logic is straightforward and follows a linear flow, which keeps it from being classified as high complexity."
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "3. Input Parameters"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ReviewerAuthenticatedUserID AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The ID of the user executing the procedure, used for auditing purposes."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeSeqid AS INT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The sequence ID of the exchange record to be processed."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@ExchangeCode AS VARCHAR(2)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The exchange code, which must be '46' for this procedure."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@CurrentBillingPeriod AS VARCHAR(6)",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The current billing period in 'YYYYMM' format."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "@StatusCode AS INT OUTPUT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": An output parameter that indicates the success (0) or failure (1) of the procedure."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "4. Business Logic and Workflow"
        }
      ]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Validation Checks",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Verify if the exchange record exists using "
                        },
                        {
                          "type": "text",
                          "text": "@ExchangeSeqid",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Check if the exchange record has already been processed."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Ensure the "
                        },
                        {
                          "type": "text",
                          "text": "@ExchangeCode",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " is '46' and matches the record's exchange code."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Confirm the account exists and is active."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Ensure the meter number does not already exist in the system."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Management",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Begin a transaction named "
                        },
                        {
                          "type": "text",
                          "text": "NewMeterExchange",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieve account information related to the exchange."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Insert a new meter record into the "
                        },
                        {
                          "type": "text",
                          "text": "Billing.Meter",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " table."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Retrieve the new meter's sequence ID."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Insert a tracking record into "
                        },
                        {
                          "type": "text",
                          "text": "Billing.AccountExchangeMeterTrack",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": "."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Commit the transaction if all operations succeed."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Post-Transaction Update",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Mark the exchange record as processed and update the reviewer ID."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ":"
                }
              ]
            },
            {
              "type": "bulletList",
              "content": [
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Use a "
                        },
                        {
                          "type": "text",
                          "text": "TRY...CATCH",
                          "marks": [
                            {
                              "type": "code"
                            }
                          ]
                        },
                        {
                          "type": "text",
                          "text": " block to handle errors."
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "listItem",
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "Rollback the transaction if an error occurs and log the error details."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "5. Performance Considerations"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Indexing",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the "
                },
                {
                  "type": "text",
                  "text": "ExchangeDataSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", "
                },
                {
                  "type": "text",
                  "text": "AccountSeqid",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ", and "
                },
                {
                  "type": "text",
                  "text": "CurrentMeterNumber",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " columns are indexed to optimize the "
                },
                {
                  "type": "text",
                  "text": "EXISTS",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "SELECT",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " queries."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Transaction Scope",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The transaction scope is well-defined, but ensure that the operations within the transaction are as efficient as possible to minimize locking and blocking."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Concurrency",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Consider the impact of concurrent executions on the same exchange records or accounts, which could lead to deadlocks or contention."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "6. Potential Issues or Risks"
        }
      ]
    },
    {
      "type": "bulletList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Data Integrity",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": If the procedure is interrupted or fails after inserting a meter but before updating the exchange record, it could lead to inconsistent data states."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Error Handling",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The error message construction in the "
                },
                {
                  "type": "text",
                  "text": "CATCH",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " block could be improved for clarity and completeness."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Hardcoded Values",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": The use of hardcoded dates like '99991231' for "
                },
                {
                  "type": "text",
                  "text": "TurnOffDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " and "
                },
                {
                  "type": "text",
                  "text": "MeterEffectiveOffDate",
                  "marks": [
                    {
                      "type": "code"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": " could lead to issues if not consistently managed across the system."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Scalability",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": As the system grows, the procedure may need optimization to handle larger volumes of data efficiently."
                }
              ]
            }
          ]
        },
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "text": "Security",
                  "marks": [
                    {
                      "type": "strong"
                    }
                  ]
                },
                {
                  "type": "text",
                  "text": ": Ensure that the procedure is executed with appropriate permissions to prevent unauthorized data modifications."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "heading",
      "attrs": {
        "level": 1
      },
      "content": [
        {
          "type": "text",
          "text": "7. Stored Procedure Definition"
        }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": {
        "language": "sql"
      },
      "content": [
        {
          "type": "text",
          "text": "--**************************************************************************************\n--* Description:\t\"46\" Identify the existing account to which a new meter is to be added\r\n--*               \r\n--* Parameter(s):        \r\n--*\t\t@AuthenticatedUserID int\t\t- the seqid of the user that runs the stored procedure\t\r\n--*     @ExchangeSeqid   int\t\t\t- The sequence id of the exchange record to be processed\r\n--*     @ExchangeCode varchar(2)\t\t- The exchange code of the exchange record to be processed,\r\n--*\t\t\t\t\t\t\t\t\t\t\tit should be a \"46\" for this procedure.\r\n--*\t\t@CurrentBillingPeriod\t\t\t\r\n--*     @StatusCode  int output\t\t\t- Execution Return Status \r\n--*\r\n--*\r\n--* Return:\t0 Success\r\n--*         1 Failure\r\n--*\r\n--* AUTHOR:       MOHAMMED BELARREM\r\n--* Created On:   05/07/2012\r\n--**************************************************************************************\r\n--* Date       Tech Description of Change\r\n--* ---------- ---\t-------------------------------------------------------------\r\n--* 05/07/2012 MB   First Version  \r\n--* 11/29/2016\tzd\tturn off date 9999 99 99 to 99991231\r\n--* 01/28/2019  VY  Updated for UniqueAccountSeqID\r\n--***************************************************************************************\r\nCREATE PROCEDURE [ManualBill].[usp_ManualBillingAddNewMeter]\r\n(\r\n\t@ReviewerAuthenticatedUserID AS INT,\r\n\t@ExchangeSeqid AS INT,\r\n\t@ExchangeCode AS VARCHAR(2),\r\n\t@CurrentBillingPeriod AS VARCHAR(6),\r\n\t@StatusCode AS INT OUTPUT\r\n)\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\t\t\t\t\r\n\tDECLARE @AccountNumber AS VARCHAR(15), @MeterNumber AS VARCHAR(12), @AccountSeqid AS INT\r\n\t\t,@AgencySeqid AS INT,@FacilitySeqid AS INT, @AccountEffectiveTurnOn AS VARCHAR(8)\r\n\t\t,@AccountEffectiveTurnOff AS VARCHAR(8), @RecordExchangeCode AS VARCHAR(2);\r\n\t\t\r\n\t-- do some validation \r\n\t-- CHECK IF THE record exists\r\n\tIF (NOT EXISTS (SELECT ExchangeDataSeqid FROM ManualBill.ManualBillingExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid))\r\n\tBEGIN\r\n\t\tRAISERROR ('The ExchangeDataSeqid %i does not exist. Please verify. ', 12, 1, @ExchangeSeqid) \r\n\t\tSET @StatusCode = 1\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\t-- check if the record was processed\r\n\tIF ('Y' = (SELECT IsProcessed FROM ManualBill.ManualBillingExchangeData WHERE ExchangeDataSeqid = @ExchangeSeqid))\r\n\tBEGIN\r\n\t\tRAISERROR ('This exchange was already processed. exchangeseqid %i ', 12, 1, @ExchangeSeqid) \r\n\t\tSET @StatusCode = 1\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\tSELECT \r\n\t\t@AccountSeqid = AccountSeqid,\r\n\t\t@MeterNumber = CurrentMeterNumber,\r\n\t\t@RecordExchangeCode\t= ExchangeCode\t\t\t\r\n\tFROM ManualBill.ManualBillingExchangeData\r\n\tWHERE ExchangeDataSeqid = @ExchangeSeqid;\r\n\t\t\r\n\t-- check the obvious\r\n\tIF (@ExchangeCode <> '46' or @ExchangeCode <> @RecordExchangeCode)\r\n\tBEGIN\r\n\t\tRAISERROR ('The exchange code is not 46. Please verify: account seqid %d and meter number %s ', 12, 1, @AccountSeqid, @MeterNumber) \r\n\t\tSET @StatusCode = 1\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\t-- check if the current account number is already in the system\r\n\tIF (NOT EXISTS(SELECT * FROM Billing.Account WHERE AccountSeqid = @AccountSeqid AND AccountStatus IN ('AC', '46')))\r\n\tBEGIN\r\n\t\tRAISERROR ('The account does not exist in the system under an active status. Please verify: account Seqid %d ', 12, 1, @AccountSeqid) \r\n\t\tSET @StatusCode = 1\r\n\t\tRETURN;\r\n\tEND;\r\n\r\n\t-- Check if the new meter EXISTS\r\n\tIF (EXISTS(SELECT * FROM Billing.Meter WHERE OriginalMeterNumber = @MeterNumber AND CurrentMeterNumber = @MeterNumber))\r\n\tBEGIN\r\n\t\tRAISERROR ('The meter number in the exchange %s exists already in the system. Please verify', 12, 1, @MeterNumber) \r\n\t\tSET @StatusCode = 1\r\n\t\tRETURN;\r\n\tEND;\r\n\t\t\r\n\tBEGIN TRY\r\n\t\tBEGIN TRANSACTION NewMeterExchange;\r\n\t\tSET @StatusCode  = 0;\r\n\t\t\r\n\t\tDECLARE @NewMeterStatus VARCHAR(2), @PreviousMeterStatus VARCHAR(2), @EnergySource INT, @UtilitySeqid INT\r\n\t\t\t,@NewMeterSeqid INT, @UniqueAccountSeqID INT;\r\n\t\t\t\t\r\n\t\tSELECT @NewMeterStatus = '46', @PreviousMeterStatus\t= 'N6';\r\n\t\t\t\r\n\t\t-- Get some account information\r\n\t\tSELECT @FacilitySeqid = FacilityAccount\r\n\t\t\t,@AccountNumber = CurrentAccountNumber\r\n\t\t\t,@AgencySeqid = AgencyAccount\r\n\t\t\t,@UtilitySeqid = UtilityAccountProvider\r\n\t\t\t,@EnergySource = EnergyAccountDescription\r\n\t\t\t,@AccountEffectiveTurnOn = AccountEffectiveTurnOn\r\n\t\t\t,@AccountEffectiveTurnOff = AccountEffectiveTurnOff\r\n\t\t\t,@UniqueAccountSeqID = UniqueAccountSeqID\r\n\t\tFROM Billing.Account\r\n\t\tWHERE AccountSeqid = @AccountSeqid;\r\n\t\t\t\r\n\t\t-- insert the new meter number\r\n\t\tINSERT INTO Billing.Meter\r\n\t\t\t(UniqueAccountSeqID\r\n\t\t\t,UtilityServiceAddress\r\n\t\t\t,OriginalAccountNumber\r\n\t\t\t,CurrentMeterNumber\r\n\t\t\t,OriginalMeterNumber\r\n\t\t\t,Tension\r\n\t\t\t,IsOECDefinedMeter\r\n\t\t\t,IsUploadProcessed\r\n\t\t\t,IsMeterUsageTracked\r\n\t\t\t,EnergySource\r\n\t\t\t,EnergyAccountDescription\r\n\t\t\t,MeterStatus\r\n\t\t\t,MeterPreviousStatus\r\n\t\t\t,MeterStatusCodePeriod\r\n\t\t\t,AssociatedDemandMeter\r\n\t\t\t,AgencyELOMeterLocation\r\n\t\t\t,UtilityAddressMeterLocation\r\n\t\t\t,MeterSquareFootageCoverage\r\n\t\t\t,TurnOnDate\r\n\t\t\t,TurnOffDate\r\n\t\t\t,MeterEffectiveOnDate\r\n\t\t\t,MeterEffectiveOffDate\r\n\t\t\t,MeterType\r\n\t\t\t,MeterDials\r\n\t\t\t,MeterConstant\r\n\t\t\t,LastPeriodOriginalBilled\r\n\t\t\t,LastPeriodAdjustmentBilled\r\n\t\t\t,LastZeroUsageBillingPeriod\r\n\t\t\t,AdjustmentRecordSeqid\r\n\t\t\t,Notes\r\n\t\t\t,AuthenticatedUserID\r\n\t\t\t,DateAdded\r\n\t\t\t,LastUpdate)\r\n\t\tSELECT\r\n\t\t\t@UniqueAccountSeqID\t\t\t\t\t\t\t\t\t\t--- UniqueAccountSeqID, added on 1/18/2019\r\n\t\t\t,AccountAddress\t\t   \t\t\t\t\t\t\t\t\t--- UtilityServiceAddress                             \r\n\t\t\t,@AccountNumber  \t\t\t\t\t\t\t\t\t\t--- OriginalAccountNumber                                                                                \r\n\t\t\t,CurrentMeterNumber       \t\t\t\t\t\t\t\t--- CurrentMeterNumber         \r\n\t\t\t,CurrentMeterNumber\t\t\t\t\t\t\t\t\t\t--- OriginalMeterNumber         \r\n\t\t\t,null\t                   \t\t\t\t\t\t\t\t--- Tension \r\n\t\t\t,'N'\t                   \t\t\t\t\t\t\t\t--- IsOECDefinedMeter \r\n\t\t\t,'Y'\t                   \t\t\t\t\t\t\t\t--- IsUploadProcessed \r\n\t\t\t,'N'\t                   \t\t\t\t\t\t\t\t--- IsMeterUsageTracked \r\n\t\t\t,@EnergySource\t           \t\t\t\t\t\t\t\t--- EnergySource         \r\n\t\t\t,@EnergySource\t           \t\t\t\t\t\t\t\t--- EnergyAccountDescription         \r\n\t\t\t,@NewMeterStatus\t       \t\t\t\t\t\t\t\t--- MeterStatus             \r\n\t\t\t,@PreviousMeterStatus\t   \t\t\t\t\t\t\t\t--- MeterPreviousStatus                 \r\n\t\t\t,@CurrentBillingPeriod    \t\t\t\t\t\t\t\t--- MeterStatusCodePeriod                  \r\n\t\t\t,null\t                   \t\t\t\t\t\t\t\t--- AssociatedDemandMeter \r\n\t\t\t,NULL \t                   \t\t\t\t\t\t\t\t--- AgencyELOMeterLocation \r\n\t\t\t,NULL \t                   \t\t\t\t\t\t\t\t--- UtilityAddressMeterLocation \r\n\t\t\t,NULL \t                   \t\t\t\t\t\t\t\t--- MeterSquareFootageCoverage \r\n\t\t\t,@CurrentBillingPeriod\t   \t\t\t\t\t\t\t\t--- TurnOnDate                 \r\n\t\t\t,'999912'\t               \t\t\t\t\t\t\t\t--- TurnOffDate     \r\n\t\t\t,dbo.ConvertDatetimeToYYYYMMDD(MeterEffectiveTurnOnDate)--- MeterEffectiveOnDate                    \r\n\t\t\t,'99991231'\t           \t\t\t\t\t\t\t\t\t--- MeterEffectiveOffDate         \r\n\t\t\t,NULL\t\t               \t\t\t\t\t\t\t\t--- MeterType     \r\n\t\t\t,0\t\t\t\t          \t\t\t\t\t\t\t\t--- MeterDials         \r\n\t\t\t,0\t           \t\t\t\t\t\t\t\t\t\t\t--- MeterConstant         \r\n\t\t\t,NULL\t                   \t\t\t\t\t\t\t\t--- LastPeriodOriginalBilled \r\n\t\t\t,NULL\t                   \t\t\t\t\t\t\t\t--- LastPeriodAdjustmentBilled \r\n\t\t\t,NULL\t                   \t\t\t\t\t\t\t\t--- LastZeroUsageBillingPeriod \r\n\t\t\t,NULL\t   \t               \t\t\t\t\t\t\t\t--- AdjustmentRecordSeqid                                                              \r\n\t\t\t,NULL \t                   \t\t\t\t\t\t\t\t--- Notes \r\n\t\t\t,@ReviewerAuthenticatedUserID\t   \t\t\t\t\t\t--- AuthenticatedUserID                 \r\n\t\t\t,getDate()\t               \t\t\t\t\t\t\t\t--- DateAdded     \r\n\t\t\t,getDate()\t               \t\t\t\t\t\t\t\t--- LastUpdate     \r\n\t\tFROM ManualBill.ManualBillingExchangeData\r\n\t\tWHERE ExchangeDataSeqid = @ExchangeSeqid;\r\n\r\n\t\t--\tFind new sequence id and save it for insertion into the AccountExchangeMeterTrack and the new @CurrentMeterNumber\r\n\t\tSELECT @NewMeterSeqid  = ident_current('Billing.Meter');\r\n\t\t\t\t\r\n\t\t-- insert the accountExchangeTrackMeter\r\n\t\tINSERT INTO Billing.AccountExchangeMeterTrack\r\n\t\t\t(UniqueAccountSeqID\r\n\t\t\t,UtilityCompanySeqid\r\n\t\t\t,OriginalAgencyDivisionSeqid\r\n\t\t\t,OriginalFacilitySeqid\r\n\t\t\t,OriginalAccountSeqid\r\n\t\t\t,OriginalMeterSeqid\r\n\t\t\t,OriginalAccountNumber\r\n\t\t\t,OriginalMeterNumber\r\n\t\t\t,AccountEffectiveBillingStartDate\r\n\t\t\t,AccountEffectiveBillingEndDate\r\n\t\t\t,MeterEffectiveBillingStartDate\r\n\t\t\t,MeterEffectiveBillingEndDate\r\n\t\t\t,AuthenticatedUserID\r\n\t\t\t,DateAdded\r\n\t\t\t,LastUpdate)\r\n\t\tSELECT  \r\n\t\t\t@UniqueAccountSeqID\r\n\t\t\t,@UtilitySeqid\r\n\t\t\t,@AgencySeqid\r\n\t\t\t,@FacilitySeqid\r\n\t\t\t,@AccountSeqid\r\n\t\t\t,@NewMeterSeqid\r\n\t\t\t,@AccountNumber\r\n\t\t\t,CurrentMeterNumber \r\n\t\t\t,@AccountEffectiveTurnOn\r\n\t\t\t,@AccountEffectiveTurnOff\r\n\t\t\t,dbo.ConvertDatetimeToYYYYMMDD(MeterEffectiveTurnOnDate)\r\n\t\t\t,'99991231'\r\n\t\t\t,@ReviewerAuthenticatedUserID\r\n\t\t\t,getDate()\r\n\t\t\t,getDate()\r\n\t\tFROM ManualBill.ManualBillingExchangeData\r\n\t\tWHERE   ExchangeDataSeqid = @ExchangeSeqid;\r\n\t\r\n\t\t-- all went well commit\r\n\t\tcommit TRAN NewMeterExchange;\r\n\t\t\t\t\r\n\t\tUPDATE ManualBill.ManualBillingExchangeData\r\n\t\tSET IsProcessed = 'Y', ReviewerAuthenticatedUserID = @ReviewerAuthenticatedUserID\r\n\t\tWHERE ExchangeDataSeqid = @ExchangeSeqid;\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n\t\tDECLARE @ExchangeErrorMessage AS NVARCHAR(4000), @ErrorMessage AS NVARCHAR(4000), @ErrorSeverity AS INT\r\n\t\t\t,@ErrorState AS INT, @ErrorNumber AS INT, @ErrorLine AS INT, @ErrorProcedure AS NVARCHAR(126), @crlf AS VARCHAR(2);\r\n\r\n\t\tSET @crlf = CHAR(13) + CHAR(10);\r\n\t\tSET @ErrorMessage = @ExchangeErrorMessage + @ErrorMessage+@crlf + '@ErrorNumber: ' + CAST(@ErrorNumber AS VARCHAR(10)) + @crlf;\r\n\r\n\t\tSELECT \r\n\t\t\t@ExchangeErrorMessage ='Error in StoredProcedure %s at line number %d'+@crlf+'Billing Period: %s'+@crlf+'Exchange Sequence Id:%d'+@crlf+'Account:Meter (%s : %s)  '+@crlf,\r\n\t\t\t@ErrorMessage = ERROR_MESSAGE(),\r\n\t\t\t@ErrorSeverity = ERROR_SEVERITY(),\r\n\t\t\t@ErrorState = ERROR_STATE(),\r\n\t\t\t@ErrorNumber = ERROR_NUMBER(),\r\n\t\t\t@ErrorProcedure = ERROR_PROCEDURE(),\r\n\t\t\t@ErrorLine = ERROR_LINE();\t\t\t\r\n\t\t\r\n\t\tRAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState, @ErrorProcedure, @ErrorLine, @CurrentBillingPeriod\r\n\t\t\t,@ExchangeSeqid, @AccountNumber, @AccountNumber) WITH LOG;\t\t\t\t\r\n\t\t\r\n\t\tSET @StatusCode  = 1;\r\n\t\t\t\t\r\n\t\tROLLBACK tran NewMeterExchange;\r\n\tEND CATCH;\r\nEND;"
        }
      ]
    }
  ]
}